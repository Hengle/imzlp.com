<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":400},"path":"search.xml"};
  </script>

  <meta name="description" content="Unreal Engine is the best 3D Game Engine!">
<meta property="og:type" content="website">
<meta property="og:title" content="Unreal Engine">
<meta property="og:url" content="https://imzlp.com/notes/ue/index.html">
<meta property="og:site_name" content="循迹研究室">
<meta property="og:description" content="Unreal Engine is the best 3D Game Engine!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231163639.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211230102540.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211209143735.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211202202802.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211202202542.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108150332.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108151127.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108151746.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211104193304.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211105195949.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211105200205.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211101130227.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211101130343.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210918111112.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210914163104707.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210909203938.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210830001957.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210812173049.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210810194240.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210809170302.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210729192239.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210729192422.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210722210800.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210720154714.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210719155941.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210715172415.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210712190429.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210701201550.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210628160606.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210626221123.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210626220907.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210622110706.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210621131324.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210615204622.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610101221.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610101046.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610102528.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210605162848.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210528170712.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210604164808.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210604164934.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141828.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141722.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141944.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210521205127.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210521205026.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210517215352.png">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20210425191951.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413161531.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162440.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162441.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162442.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413163213.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164503.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164502.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210326121855.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210322211548.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319213357.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319214356.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210322164021.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnrealEngine_Shortcuts.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210311110606.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210226145229.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210226145538.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143321.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143807.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224100616.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210220105308.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210202194343.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210127152358.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210121220607.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210115214317.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112154624.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112171826.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201217202145.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/16082078824716.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125932.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125525.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211130200.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201208145952.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201204213024.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201204212642.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201203212055.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201116215421.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213023.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213249.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201117095535.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201026200135.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014165139.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014171310.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014141219.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009210924.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009202629.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009202816.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20200927204452.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20200925185142.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-project-settings-ios-gen-dSYM.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-dSYM.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-disabledebugfile-dSYM.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-uprarm-bitmask.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-description-use-boardless-window.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/import-ios-cer-in-windows-certmgr.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/ue4-import-cer-for-ios.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-viveport-ligthing-need-rebuilt.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-viveport-stat-fps.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-http-encode-url.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-project-settings-cooker-astc-compression.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ModuleLoadFaild/ue4-game-module-could-not-be-loaded.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-set-node-value-in-editor.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-uclass-register-all-compiled.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-call-ufunction-receive-ret-value.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-static-class-and-getclass-difference.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-call-FObjectInitializer-ctor.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-translation-bp-to-cpp.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/uobject-data-serialize-callstack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Shader/ue-launch-game-CompileGlobalShaderMap-callstack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-run-commandlet.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/ue4-notifyUObjectCreated-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-trybindlua-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-get-lua-func-and-get-ue-ufuncion.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-replace-ufunction-native-function-pointer.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-process-event-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-fpath-relative-engine-binary.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Package/ue4-package-bUsesSlate-diff.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-editor-copy-selected-actor-impl-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-editor-paste-selected-actor-impl-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/utf8-character-of-array-to-tchar.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Level/ue4-save-level-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Level/ue4-load-level-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/unreal-front-end-device-log.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-not-power-of-two.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-set-as-power-of-two-mode.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-set-compression-as-userinterface.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-download-proxy-plugin-ui.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/use-http-request-download-file-server-info.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-FPlatformMisc-typedef.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/search-ue-source-in-github.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/project-settings-add-non-asset-to-package.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/obb-file-hash-diff.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-scanf-asset-ref-redirector.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-fix-up-redirectors-in-folder.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/PreviewRenderingLevel.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/dispatcher-bind-error-not-match-signature.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Editor-SlowTask-progress.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/package-outside-file-to-pak.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/load-extern-file-form-pak-in-runtime.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-pak-not-asset-file-in-package-game.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-projectdir.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4_SaveFile_Notifications.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/git-diff-in-ue4-no-runtime.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp-print.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-android-screen-rotate.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/unreal-load-patch-asset.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/ue4-dynamic-load-asset.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-game-shadowtrackerextra-pak.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/Show_CustomK2Node.gif">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-premake-generate-vs-solution.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/20203/build-recastnavigation.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-navigation-RecastDemo.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-0.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-1.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/Recast-Demo-bin.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/protobuf-protoc-toolbar.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/use-different-return-type.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-default.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-never.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/posts/16643/vs-disable-optimization.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-bp-pure-node-binary-operator.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/optimize-dynamic-shadow-use-phy-asset.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/optimize-dynamic-shadow-use-capsule-direct-shadow.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-addtional-console-command.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-add-code-macro-in-build-cs.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/DLL-Compile-Error-Link1561-ConfigurationType.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/DLL-Compile-Error-Link1561-Linker-System.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4-Change-Project-Package-Icon.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/dotNetFrameWorkVersionNumberInRegister.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-spawn-emitter-isnt-visibility-in-camera.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/spawn-sound-at-location-call-stack.webp">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4-Engine-Garbage-Collection-GlobalSetting.webp">
<meta property="article:published_time" content="2017-01-08T05:50:33.000Z">
<meta property="article:modified_time" content="2022-01-18T16:15:21.002Z">
<meta property="article:author" content="查利鹏">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231163639.png">

<link rel="canonical" href="https://imzlp.com/notes/ue/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Unreal Engine | 循迹研究室
</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66450323-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-66450323-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="循迹研究室" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">循迹研究室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>笔记</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>随笔</a>

  </li>


      
        <li class="menu-item menu-item-feeds">

    <a href="/feeds/" rel="section"><i class="fas fa-rss fa-fw"></i>资讯</a>

  </li>
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>资源</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>


      
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fas fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>站点日志</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>开源项目</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>虚幻知识库</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>站内搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

  <div id="google_translate_element"></div>
  <script type="text/javascript">
    function googleTranslateElementInit()
    {
      var google_translate_element = document.getElementById('google_translate_element');
      var timer = setInterval(function() 
      {
        google_translate_element = document.getElementById('google_translate_element');
        if (google_translate_element) 
        {
          clearInterval(timer);
          new google.translate.TranslateElement(
          {
            pageLanguage: 'zh-CN',
            
              includedLanguages: 'en,zh-CN,ru,ja',
            
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: true
          },
          'google_translate_element');

          
            // 清除图片的请求
            img = [].slice.call(document.querySelectorAll('#goog-gt-tt img,#google_translate_element img'));
            img.forEach(function(v, i) {v.src = '';});
          
          var google_language_selector = document.getElementById(':0.targetLanguage');
          google_language_selector.style.backgroundColor = "#ffffffb5";
          google_language_selector.style.border = "0px solid #ffffffb5";
        }
      }, 300);
    }
  </script>
  <script type="text/javascript" src="//translate.google.cn/translate_a/element.js?cb=googleTranslateElementInit"></script>



</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  

      

        
        <ul id="sub-menu" class="sub-menu menu">
          
            
          
          
              
  <li class="menu-item menu-item-ue">

    <a href="/notes/ue/" rel="section"><i class="fa fa fa-cube fa-fw"></i>Unreal Engine</a>

  </li>


          
          
              
  <li class="menu-item menu-item-ue5">

    <a href="/notes/ue5/" rel="section"><i class="fas fa-cubes fa-fw"></i>UE5</a>

  </li>


          
          
              
  <li class="menu-item menu-item-gamedev">

    <a href="/notes/gamedev/" rel="section"><i class="fab fa-steam-square fa-fw"></i>Game Development</a>

  </li>


          
          
              
  <li class="menu-item menu-item-cpp">

    <a href="/notes/cpp/" rel="section"><i class="fas fa-keyboard fa-fw"></i>C++</a>

  </li>


          
          
              
  <li class="menu-item menu-item-rust">

    <a href="/notes/rust/" rel="section"><i class="fab fa-rust fa-fw"></i>Rust</a>

  </li>


          
          
              
  <li class="menu-item menu-item-computerscience">

    <a href="/notes/computerscience/" rel="section"><i class="fas fa-satellite fa-fw"></i>Computer Science</a>

  </li>


          
          
              
  <li class="menu-item menu-item-graphics">

    <a href="/notes/graphics/" rel="section"><i class="fas fa-magic fa-fw"></i>Graphics</a>

  </li>


          
          
              
  <li class="menu-item menu-item-vr">

    <a href="/notes/vr/" rel="section"><i class="fas fa-vr-cardboard fa-fw"></i>Virtual Reality</a>

  </li>


          
          
              
  <li class="menu-item menu-item-tips">

    <a href="/notes/tips/" rel="section"><i class="fa fa-rocket fa-fw"></i>Tips</a>

  </li>


          
        </ul>
        

        

                
                
        
      

      
      

      
      

      
      
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="zh-CN">
      <header class="post-header">
	<h1 class="post-title" itemprop="name headline">Unreal Engine<a href="https://github.com/imzlp/blog-source/edit/master/source/notes/ue/index.md" class="post-edit-link" title="编辑" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
	</h1>
	<div class="post-meta">
	    <div class="post-description">Unreal Engine is the best 3D Game Engine!</div>
	  
  <ul class="breadcrumb">
          
            <li><a href="/notes/">NOTES</a></li>
          <li>UE</li>
        
  </ul>

	</div>


</header>

      
      
      
      <div class="post-body">
          <ul>
<li><a href="https://imzlp.com/posts/25331/">UE开发的问题笔记和资料辑录</a></li>
<li><a href="https://imzlp.com/posts/3380/">UE和VR开发技术笔记</a></li>
<li><a href="https://imzlp.com/posts/12143/">UE工具链配置与开发技巧</a></li>
<li><a href="https://imzlp.com/categories/Unreal-Engine/">我的Unreal Engine技术文章归档</a></li>
</ul>
<hr>
<h2 id="GIST-NOTES"><a href="#GIST-NOTES" class="headerlink" title="GIST NOTES"></a>GIST NOTES</h2><p><strong>注意</strong>：使用GIST管理的笔记，在国内网络可能会无法显示。</p>
<script src="https://gist.github.com/imzlp/3f172a797c31c66453f733e15e687959.js"></script>

<hr>
<h2 id="Cook-World栈"><a href="#Cook-World栈" class="headerlink" title="Cook World栈"></a>Cook World栈</h2><p>在Cook World类型的资源时，会调用<code>UEditorEngine::InitializePhysicsSceneForSaveIfNecessary</code>，进而会调用World的<code>UpdateWorldComponents</code>，具体栈如下：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211231163639.png"></p>
<h2 id="LongPackageNameToFileName"><a href="#LongPackageNameToFileName" class="headerlink" title="LongPackageNameToFileName"></a>LongPackageNameToFileName</h2><p>将<code>/Game/XXX</code>转换为资源的磁盘路径：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211230102540.png"></p>
<h2 id="StaticMesh没有碰撞导致的Cook失败"><a href="#StaticMesh没有碰撞导致的Cook失败" class="headerlink" title="StaticMesh没有碰撞导致的Cook失败"></a>StaticMesh没有碰撞导致的Cook失败</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LogPhysics: Warning: Failed to cook convex: &#x2F;Game&#x2F;Assets&#x2F;Environment&#x2F;SM_XZCQYIS_Tree001_c.SM_XZCQYIS_Tree001_c 0 (FlipX:0). The remaining elements will not get cooked.</span><br><span class="line">LogPhysicsCore: Error: PHYSX: (D:\Build\++Fortnite\Sync\Engine\Source\ThirdParty\PhysX3\PhysX_3.4\Source\PhysXCooking\src\Cooking.cpp 198) eINVALID_PARAMETER : Cooking::cookConvexMesh: user-provided convex mesh descriptor is invalid!</span><br></pre></td></tr></table></figure>
<p>检查模型是否有简单和复杂碰撞，若没有添加一个即可。</p>
<h2 id="Android命令行启动UE-APP"><a href="#Android命令行启动UE-APP" class="headerlink" title="Android命令行启动UE APP"></a>Android命令行启动UE APP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start com.tencent.tmgp.fmgame/com.epicgames.ue4.GameActivity</span><br></pre></td></tr></table></figure>

<h2 id="android指定启动参数的方法"><a href="#android指定启动参数的方法" class="headerlink" title="android指定启动参数的方法"></a>android指定启动参数的方法</h2><figure class="highlight cpp"><figcaption><span>Source\Runtime\Launch\Private\Android\LaunchAndroid.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandLine</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li>指定<code>ue4commandline.txt</code>，<a target="_blank" rel="noopener" href="https://ue5wiki.com/wiki/26262/">移动端指定启动参数</a>。</li>
<li>通过AndroidConfigRuleSystem，<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/zh-CN/SharingAndReleasing/Mobile/Android/AndroidConfigRulesSystem/">安卓配置规则系统</a>，它在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/9e0f5f2a419a75b83392c44bf75462366ca8c1e2/Engine/Build/Android/Java/src/com/epicgames/ue4/GameActivity.java.template#L1579">GameActivity.java.template#L1579</a>中被读取，并通过JNI调用(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformMisc.cpp#L2490">Java_com_epicgames_ue4_GameActivity_nativeSetConfigRulesVariables</a>)传递给引擎C++侧，最终在<code>InitCommandLine</code>中获取，并追加到引擎的命令行参数。</li>
</ol>
<figure class="highlight cpp"><figcaption><span>Launch/Private/Android/LaunchAndroid.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (FString* ConfigRulesCmdLineAppend = FAndroidMisc::<span class="built_in">GetConfigRulesVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;cmdline&quot;</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(**ConfigRulesCmdLineAppend);</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ConfigRules appended: %s&quot;</span>), **ConfigRulesCmdLineAppend);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>setprop，通过adb设置一个名为<code>debug.ue4.commandline</code>的prop，将参数填入其中，会被追加到启动参数里（4.26+）。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Name of the UE4 commandline append setprop</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">char</span> UE4CommandLineSetprop[] = <span class="string">&quot;debug.ue4.commandline&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> CommandLineSetpropAppend[CMD_LINE_MAX];</span><br><span class="line"><span class="keyword">if</span> (__system_property_get(UE4CommandLineSetprop, CommandLineSetpropAppend) &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(<span class="string">&quot; &quot;</span>));</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLineSetpropAppend));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4 setprop appended: %s&quot;</span>), <span class="built_in">UTF8_TO_TCHAR</span>(CommandLineSetpropAppend));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell setprop debug.ue4.commandline <span class="string">&#x27;-test123&#x27;</span></span><br><span class="line">adb shell am start com.tencent.tmgp.fmgame/com.epicgames.ue4.GameActivity</span><br></pre></td></tr></table></figure>
<p>如果开启了启动时的LaunchImage：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> bShowLaunchImage = <span class="literal">false</span>;</span><br><span class="line">Ini.GetBool(<span class="string">&quot;/Script/AndroidRuntimeSettings.AndroidRuntimeSettings&quot;</span>, <span class="string">&quot;bShowLaunchImage&quot;</span>, <span class="keyword">out</span> bShowLaunchImage);</span><br></pre></td></tr></table></figure>
<p>则启动的Activity则就从<code>com.epicgames.ue4.GameActivity</code>变成了<code>com.epicgames.ue4.SplashActivity</code>。</p>
<p>给游戏传递参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -a android.intent.action.MAIN -n com.imzlp.gworld/com.epicgames.ue4.GameActivity --es cmdline xxxx</span><br></pre></td></tr></table></figure>

<h2 id="定义外部可用的全局符号"><a href="#定义外部可用的全局符号" class="headerlink" title="定义外部可用的全局符号"></a>定义外部可用的全局符号</h2><p>有时候，在插件或者其他的模块中，想要定义一个全局对象，供内部或者外部的模块访问，就像UE内置的<code>GEngine</code>/<code>GConfig</code>这些。</p>
<p>首先需要把C++中<strong>声明</strong>和<strong>定义</strong>的概念区分开，我之前有篇文章介绍：<a href="https://imzlp.com/posts/21831/">C++ 中 declaration 与 define 的区别</a>。</p>
<p>因为我们想要访问的<strong>全局对象</strong>，应该只有一个实例，而不是每个使用模块都包含了一个定义的实例，所以只应该在有一个定义，其他模块引用时只是一个声明，声明它在外部模块中定义，应该去其他模块中访问该实例。</p>
<p>以Windows为例，UE的模块，会编译成DLL，如果我们想要访问某个模块的符号，就是要访问它的DLL中的符号。在UE中，导出符号使用<code>XXXX_API</code>封装，同样在之前的笔记中有记录：</p>
<ul>
<li><a href="https://imzlp.com/notes/ue/#MODULE-NAME-API">MODULE_NAME_API</a></li>
<li><a href="https://imzlp.com/notes/ue/#%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89">模块的宏定义</a></li>
</ul>
<p>以A、B两个模块为例：<code>A_API</code>在A模块中被定义为<code>DLLEXPORT</code>，在B模块中被定义为<code>DLLIMPORT</code>，所以，A中使用<code>A_API</code>定义一个符号，会控制它编译出的A.dll中该符号导出，在外部模块B中使用该符号时，就是导入。</p>
<p>理解起来或许有点绕，以代码来理解：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line"><span class="keyword">extern</span> A_API int32* GTestPtr; <span class="comment">// declare a external pointer symbal</span></span><br><span class="line"><span class="comment">// extern DLLEXPORT int32* GTestPtr = nullptr;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A.cpp</span></span><br><span class="line">A_API int32* GTestPtr = <span class="literal">nullptr</span>; <span class="comment">// define the global symbal</span></span><br><span class="line"><span class="comment">// DLLEXPORT int32* GTestPtr = nullptr;</span></span><br></pre></td></tr></table></figure>
<p>在B中访问它：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// B.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;A.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(GTestPtr)&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在B中包含A.h，在B中，A.h中的<code>extern A_API int32* GTestPtr;</code>就变成了以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> DLLIMPORT int32* GTestPtr;</span><br></pre></td></tr></table></figure>
<p>在编译B模块时，<code>DLLIMPORT</code>会指导链接器(linker)去外部的模块查找该符号，从而实现在B中访问A中定义的全局对象。</p>
<p>错误用法1：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line">int32* GTestPtr;</span><br><span class="line"><span class="comment">// A.cpp</span></span><br><span class="line"><span class="keyword">int</span>* GTestPtr = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>如果在A中这么声明，在B中访问GTestPtr则会有符号未定义的链接错误。</p>
<p>错误用法2：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A.h</span></span><br><span class="line"><span class="keyword">static</span> int32* GTestPtr;</span><br></pre></td></tr></table></figure>
<p>则每个包含A.h的翻译单元都包含了一个<code>GTestPtr</code>的符号实例，并不是全局唯一的。</p>
<h2 id="修改StaticMesh的CollisionPreset"><a href="#修改StaticMesh的CollisionPreset" class="headerlink" title="修改StaticMesh的CollisionPreset"></a>修改StaticMesh的CollisionPreset</h2><p><code>UStaticMesh</code>-&gt;<code>UBodySetup</code>-&gt;<code>FBodyInstance</code>-&gt;<code>CollisionProfileName</code>。</p>
<p><code>CollisionProfileName</code>在<code>BodyInstanceCustomization.cpp</code>中创建了自定义的属性面板：</p>
<figure class="highlight cpp"><figcaption><span>Editor\DetailCustomizations\Private\BodyInstanceCustomization.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FBodyInstanceCustomization::AddCollisionCategory</span><span class="params">(TSharedRef&lt;class IPropertyHandle&gt; StructPropertyHandle, class IDetailChildrenBuilder&amp; StructBuilder, IPropertyTypeCustomizationUtils&amp; StructCustomizationUtils)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="Commandlet启动时不编译shader"><a href="#Commandlet启动时不编译shader" class="headerlink" title="Commandlet启动时不编译shader"></a>Commandlet启动时不编译shader</h2><p>启动时添加<code>NoShaderCompile</code>参数。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* To disable shader compiling during the run of the commandlet add &quot;-NoShaderCompile&quot; to the commandline.</span><br><span class="line">* This would be added as data member setting except that the shader compiler is initialized before a commandlet is created so it cannot be queried soon enough.</span><br></pre></td></tr></table></figure>

<h2 id="Android运行时修改Icon"><a href="#Android运行时修改Icon" class="headerlink" title="Android运行时修改Icon"></a>Android运行时修改Icon</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/how-to-change-app-icon-of-android-programmatically-in-android/">How to Change App Icon of Android Programmatically in Android?</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@simonmisles/dynamic-launcher-icon-and-name-for-android-e40bf0561715">Dynamic Launcher Icon and Name for Android</a></li>
<li><a target="_blank" rel="noopener" href="https://mobikul.com/change-launcher-icon-dynamically-in-android/">Change Launcher icon dynamically in Android</a></li>
</ul>
<h2 id="4-27-Xcode13编译错误"><a href="#4-27-Xcode13编译错误" class="headerlink" title="4.27- Xcode13编译错误"></a>4.27- Xcode13编译错误</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (iOS):     error: The Legacy Build System will be removed in a future release. You can configure the selected build system and this deprecation message in File &gt; Workspace Settings.</span><br><span class="line">UATHelper: Packaging (iOS):     Build Preparation</span><br><span class="line">UATHelper: Packaging (iOS):     The Legacy Build System will be removed in a future release. You can configure the selected build system and this deprecation message in File &gt; Workspace Settings.</span><br><span class="line">UATHelper: Packaging (iOS):   </span><br><span class="line">UATHelper: Packaging (iOS):     ** BUILD FAILED **</span><br><span class="line">UATHelper: Packaging (iOS):   </span><br><span class="line">UATHelper: Packaging (iOS):   </span><br><span class="line">UATHelper: Packaging (iOS):     The following build commands failed:</span><br><span class="line">UATHelper: Packaging (iOS):        Prepare build</span><br><span class="line">UATHelper: Packaging (iOS):     (1 failure)</span><br><span class="line">UATHelper: Packaging (iOS):     Executing /Users/lipengzha/UE4/Builds/LIPENGZHA-PC/D/UnrealProjects/Blank426/Intermediate/Build/IOS/Blank426/Development/CleanProject.sh</span><br><span class="line">PackagingResults: Error: The Legacy Build System will be removed in a future release. You can configure the selected build system and this deprecation message in File &gt; Workspace Settings.</span><br><span class="line">UATHelper: Packaging (iOS):     ERROR: Unhandled exception: System.Exception: ** BUILD FAILED **</span><br><span class="line">UATHelper: Packaging (iOS):              at UnrealBuildTool.IOSToolChain.PostBuildSync (UnrealBuildTool.IOSPostBuildSyncTarget Target) [0x00cad] in &lt;1849fe2d2cfe48d9910e4d9444acc602&gt;:0</span><br><span class="line">UATHelper: Packaging (iOS):              at UnrealBuildTool.IOSPostBuildSyncMode.Execute (Tools.DotNETCommon.CommandLineArguments Arguments) [0x00018] in &lt;1849fe2d2cfe48d9910e4d9444acc602&gt;:0</span><br><span class="line">UATHelper: Packaging (iOS):              at UnrealBuildTool.UnrealBuildTool.Main (System.String[] ArgumentsArray) [0x002bb] in &lt;1849fe2d2cfe48d9910e4d9444acc602&gt;:0</span><br><span class="line">PackagingResults: Error: Unhandled exception: System.Exception: ** BUILD FAILED **</span><br></pre></td></tr></table></figure>
<p>4.27中已修复这个问题：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/ed97f0f865b7dce3c43bb15c2d7f86974eaafd75#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d1cfb5c8b8a8d1cfb5c8f28000">Xcode 13 support</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/0872cfbd11a73fe44a0e268eb46cfef4d61cda92#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d157b8c82fb8a8d175c80c8e">Revert Xcode project/workspace settings to use legacy build system.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/dc7a584238fe265eac323fd8b74806f821fcd7f9#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d15b7fb8a8d15b5c8c8ec8e">Fix for legacy build systems on MacOS</a></li>
</ul>
<h2 id="打包Windows窗口化"><a href="#打包Windows窗口化" class="headerlink" title="打包Windows窗口化"></a>打包Windows窗口化</h2><figure class="highlight ini"><figcaption><span>Saved/Config/WindowsNoEditor/GameUserSettings.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.GameUserSettings]</span></span><br><span class="line"><span class="attr">bUseVSync</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">ResolutionSizeX</span>=<span class="number">960</span></span><br><span class="line"><span class="attr">ResolutionSizeY</span>=<span class="number">540</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeX</span>=<span class="number">960</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeY</span>=<span class="number">540</span></span><br></pre></td></tr></table></figure>
<p>也可以添加到<code>DefaultGameUserSettings.ini</code>里。</p>
<p>启动时加<code>-Windowed</code>参数。</p>
<h2 id="UE-Docker"><a href="#UE-Docker" class="headerlink" title="UE-Docker"></a>UE-Docker</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/orgs/EpicGames/packages/container/package/unreal-engine">EpicGames/packages/container/package/unreal-engine</a></li>
</ul>
<h2 id="Primary-Asset-Types标记的资产扫描"><a href="#Primary-Asset-Types标记的资产扫描" class="headerlink" title="Primary Asset Types标记的资产扫描"></a>Primary Asset Types标记的资产扫描</h2><p>在<code>UAssetManager::ScanPathsForPrimaryAssets</code>中，在AssetRegistry加载之后：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211209143735.png"></p>
<p>它会根据Primary Asset Types构造出一个<code>AssetRegistry.GetAssets(ARFilter, AssetDataList);</code>的调用，扫描标记的路径和资产类型。</p>
<p>将其添加到PrimaryAssetType对应的资源列表中。</p>
<p>通过ModifyCook调用时会检查PrimaryAsset的配置：</p>
<figure class="highlight cpp"><figcaption><span>Engine\Source\Runtime\Engine\Private\AssetManager.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UAssetManager::ModifyCook(TArray&lt;FName&gt;&amp; PackagesToCook, TArray&lt;FName&gt;&amp; PackagesToNeverCook)</span></span><br><span class="line"><span class="keyword">for</span> (FName PackageName : AssetPackages)</span><br><span class="line">&#123;</span><br><span class="line">    EPrimaryAssetCookRule CookRule = <span class="built_in">GetPackageCookRule</span>(PackageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Treat DevAlwaysCook as AlwaysCook, may get excluded in VerifyCanCookPackage</span></span><br><span class="line">    <span class="keyword">bool</span> bAlwaysCook = (CookRule == EPrimaryAssetCookRule::AlwaysCook || CookRule == EPrimaryAssetCookRule::DevelopmentAlwaysCook);</span><br><span class="line">    <span class="keyword">bool</span> bCanCook = <span class="built_in">VerifyCanCookPackage</span>(PackageName, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bAlwaysCook &amp;&amp; bCanCook &amp;&amp; !TypeInfo.bIsEditorOnly)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If this is always cook, not excluded, and not editor only, cook it</span></span><br><span class="line">        PackagesToCook.<span class="built_in">AddUnique</span>(PackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!bCanCook)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If this package cannot be cooked, add to exclusion list</span></span><br><span class="line">        PackagesToNeverCook.<span class="built_in">AddUnique</span>(PackageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有标记为<code>AlwayCook</code>或者<code>DevelopmentAlwayCook</code>，并且它管理的资源并不是<code>EditorOnly</code>的情况下，才会将其管理的资源添加到Cook列表中。</p>
<h2 id="Rider-配置"><a href="#Rider-配置" class="headerlink" title="Rider 配置"></a>Rider 配置</h2><h3 id="修改Rider的JVM配置"><a href="#修改Rider的JVM配置" class="headerlink" title="修改Rider的JVM配置"></a>修改Rider的JVM配置</h3><p>修改Rider的Rider64.vmoptions修改JVM虚拟机的配置：</p>
<figure class="highlight txt"><figcaption><span>Rider64.vmoptions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Xms1024m</span><br><span class="line">-Xmx50000m</span><br><span class="line">-XX:ReservedCodeCacheSize=1024m</span><br><span class="line">-XX:+UseStringDeduplication</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Xms</code>和<code>Xmx</code>是调整Java堆内存的最小值和最大值，调大了不容易gc</li>
<li><code>ReservedCodeCacheSize</code>是调整编译代码缓存大小</li>
<li><code>UseStringDeduplication</code>：开启后Java也支持像Lua那样全局共用相同的字符串，节省内存。</li>
</ul>
<h3 id="项目缓存路径"><a href="#项目缓存路径" class="headerlink" title="项目缓存路径"></a>项目缓存路径</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Local\JetBrains\Rider2021.2\resharper-host\local\Transient\Rider\v212\SolutionCaches</span><br></pre></td></tr></table></figure>

<h2 id="Editor-Preferences配置"><a href="#Editor-Preferences配置" class="headerlink" title="Editor Preferences配置"></a>Editor Preferences配置</h2><p>源码版引擎在<code>Engine\Engine\Saved\Config\Windows\EditorSettings.ini</code>文件中。</p>
<h2 id="UE游戏安全与逆向分析"><a href="#UE游戏安全与逆向分析" class="headerlink" title="UE游戏安全与逆向分析"></a>UE游戏安全与逆向分析</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.unknowncheats.me/forum/unreal-engine-4-a/">UnKnoWnCheaTs - Multiplayer Game Hacking and Cheats</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/guttir14/UnrealDumper-4.25">UnrealDumper-4.25</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/master131/ExtremeInjector">ExtremeInjector</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RiceCum1">crack 案例</a></li>
</ul>
<h2 id="GlobalShaderCache-bin"><a href="#GlobalShaderCache-bin" class="headerlink" title="GlobalShaderCache*.bin"></a>GlobalShaderCache*.bin</h2><p>默认打包时会在<code>Saved/Cooked/PLATFORM_NAME/Engine/</code>目录下创建<code>GlobalShaderCache*.bin</code>文件。</p>
<p>它是在<code>SaveGlobalShaderFile</code>中存储的：</p>
<figure class="highlight cpp"><figcaption><span>Engine\Private\ShaderCompiler\ShaderCompiler.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Saves the global shader map as a file for the target platform. */</span></span><br><span class="line"><span class="function">FString <span class="title">SaveGlobalShaderFile</span><span class="params">(EShaderPlatform Platform, FString SavePath, class ITargetPlatform* TargetPlatform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FGlobalShaderMap* GlobalShaderMap = <span class="built_in">GetGlobalShaderMap</span>(Platform);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait until all global shaders are compiled</span></span><br><span class="line">    <span class="keyword">if</span> (GShaderCompilingManager)</span><br><span class="line">    &#123;</span><br><span class="line">        GShaderCompilingManager-&gt;<span class="built_in">ProcessAsyncResults</span>(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TArray&lt;uint8&gt; GlobalShaderData;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">FMemoryWriter <span class="title">MemoryWriter</span><span class="params">(GlobalShaderData, <span class="literal">true</span>)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (TargetPlatform)</span><br><span class="line">        &#123;</span><br><span class="line">            MemoryWriter.<span class="built_in">SetCookingTarget</span>(TargetPlatform);</span><br><span class="line">        &#125;</span><br><span class="line">        GlobalShaderMap-&gt;<span class="built_in">SaveToGlobalArchive</span>(MemoryWriter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make the final name</span></span><br><span class="line">    FString FullPath = SavePath / <span class="built_in">GetGlobalShaderCacheFilename</span>(Platform);</span><br><span class="line">    <span class="keyword">if</span> (!FFileHelper::<span class="built_in">SaveArrayToFile</span>(GlobalShaderData, *FullPath))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogShaders, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not save global shader file to &#x27;%s&#x27;&quot;</span>), *FullPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    <span class="keyword">if</span> (FShaderCodeLibrary::<span class="built_in">NeedsShaderStableKeys</span>(Platform))</span><br><span class="line">    &#123;</span><br><span class="line">        GlobalShaderMap-&gt;<span class="built_in">SaveShaderStableKeys</span>(Platform);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_EDITOR</span></span></span><br><span class="line">    <span class="keyword">return</span> FullPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它由<code>RecompileShadersForRemote</code>调用，在<code>CookOnTheFlyServer</code>的<code>SaveGlobalShaderMapFiles</code>中被执行。</p>
<h2 id="Primary-Asset-Types-to-Scan"><a href="#Primary-Asset-Types-to-Scan" class="headerlink" title="Primary Asset Types to Scan"></a>Primary Asset Types to Scan</h2><p>打包时要扫描的主要资产类型。可以理解为，他们管理了一堆资源，在打包时会将他们添加到打包列表中。</p>
<p>以引擎默认添加的<code>Map</code>和<code>PrimaryAssetLabel</code>为例：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211202202802.png"></p>
<ul>
<li>Map：会扫描<code>/Game/Maps</code>下的所有地图，将它们添加到Cook列表中。</li>
<li>PrimaryAssetLabel：会扫描<code>/Game</code>下的所有<code>PrimaryAssetLabel</code>类型的资产，将其中指定的资源添加（或忽略）到Cook列表中。</li>
</ul>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211202202542.png"></p>
<p>如果两个<code>PrimaryAssetLabel</code>同时管理了某个资源，如A和B两个Primary管理了不同的地图，它们都依赖了一个资源C，而A和B的<code>CookRule</code>以及优先级不同，在ModiyCook中会产生获取Cook规则的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;EngineMaterials&#x2F;WeightMapPlaceholderTexture! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;EngineMaterials&#x2F;DefaultPhysicalMaterial! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;Texturing&#x2F;WorldPositionWithScale! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:Fb_ThePoolOfTribute_02_Main have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;SafeNormalize! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;Utility&#x2F;BreakOutFloat4Components! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:Fb_ThePoolOfTribute_02_Main have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;WorldPositionOffset&#x2F;ObjectScale! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;FixRotateAboutAxisNormals! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;Utility&#x2F;LinearSine! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;SmoothThreshold! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;PivotPainter&#x2F;TreeAnimationSines! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;WorldPositionOffset&#x2F;Wind! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;Math&#x2F;AddComponents! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br><span class="line">LogInit: Display: LogAssetManager: Error: GetPackageCookRule: Conflicting Cook Rule for package &#x2F;Engine&#x2F;Functions&#x2F;Engine_MaterialFunctions02&#x2F;PivotPainter&#x2F;PivotPainter_TreeData! PrimaryAssetLabel:OpenWorldMaps and PrimaryAssetLabel:HoudiniTest_hysl_eastern have the same priority and disagree.</span><br></pre></td></tr></table></figure>

<h2 id="Windows编译Metal-Shader的栈"><a href="#Windows编译Metal-Shader的栈" class="headerlink" title="Windows编译Metal Shader的栈"></a>Windows编译Metal Shader的栈</h2><p>在<code>ShaderCodeLibrary::PackageNativeShaderLibrary</code>中调用了<code>CreateShaderArchive</code>:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Private\ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PackageNativeShaderLibrary</span><span class="params">(<span class="keyword">const</span> FString&amp; ShaderCodeDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SerializedShaders.<span class="built_in">GetNumShaders</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FString IntermediateFormatPath = <span class="built_in">GetShaderDebugFolder</span>(FPaths::<span class="built_in">ProjectSavedDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;Shaders&quot;</span>) / FormatName.<span class="built_in">ToString</span>(), LibraryName, FormatName);</span><br><span class="line">    FString TempPath = IntermediateFormatPath / <span class="built_in">TEXT</span>(<span class="string">&quot;NativeLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">    IFileManager::<span class="built_in">Get</span>().<span class="built_in">MakeDirectory</span>(*TempPath, <span class="literal">true</span>);</span><br><span class="line">    IFileManager::<span class="built_in">Get</span>().<span class="built_in">MakeDirectory</span>(*ShaderCodeDir, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    EShaderPlatform Platform = <span class="built_in">ShaderFormatToLegacyShaderPlatform</span>(FormatName);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> bOK = Format-&gt;<span class="built_in">CreateShaderArchive</span>(LibraryName, FormatName, TempPath, ShaderCodeDir, IntermediateFormatPath, SerializedShaders, ShaderCode, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (bOK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Delete Shader code library / pipelines as we now have native versions</span></span><br><span class="line">        &#123;</span><br><span class="line">            FString OutputFilePath = <span class="built_in">GetCodeArchiveFilename</span>(ShaderCodeDir, LibraryName, FormatName);</span><br><span class="line">            IFileManager::<span class="built_in">Get</span>().<span class="built_in">Delete</span>(*OutputFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            FString OutputFilePath = <span class="built_in">GetPipelinesArchiveFilename</span>(ShaderCodeDir, LibraryName, FormatName);</span><br><span class="line">            IFileManager::<span class="built_in">Get</span>().<span class="built_in">Delete</span>(*OutputFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up the saved directory of temporary files</span></span><br><span class="line">    IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*IntermediateFormatPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*TempPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bOK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Metal的ShaderPlatform，会调用到<code>Source\Developer\Apple\MetalShaderFormat\Private\MetalShaderFormat.cpp</code>中的实现。其中有获取Metal工具链编译Shader的代码。</p>
<h2 id="Cook时进程的性能配置"><a href="#Cook时进程的性能配置" class="headerlink" title="Cook时进程的性能配置"></a>Cook时进程的性能配置</h2><p>在<code>CookOnTheFlyServer.cpp</code>的<code>UCookOnTheFlyServer::Initialize</code>中，读取Ini配置，设置编译Shader的任务数、最大并行shader任务数、内存分配等。</p>
<h2 id="Commandlet禁用渲染线程"><a href="#Commandlet禁用渲染线程" class="headerlink" title="Commandlet禁用渲染线程"></a>Commandlet禁用渲染线程</h2><p>添加<code>-norenderthread</code>参数：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/9e0f5f2a419a75b83392c44bf75462366ca8c1e2/Engine/Source/Runtime/Core/Private/GenericPlatform/GenericPlatformMisc.cpp#L1144">GenericPlatformMisc.cpp#L1144</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FGenericPlatformMisc::UseRenderThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// look for disabling commandline options (-onethread is old-school, here for compatibility with people&#x27;s brains)</span></span><br><span class="line">    <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;norenderthread&quot;</span>)) || FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;onethread&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Shader编译配置"><a href="#Shader编译配置" class="headerlink" title="Shader编译配置"></a>Shader编译配置</h2><p><code>DevOptions.Shaders</code>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Config/BaseEngine.ini#L1315">Engine/Config/BaseEngine.ini#L1315</a></li>
</ul>
<p>默认情况下会创建系统线程数-3个编译Shader的进程。</p>
<p>如4核八线程会创建出5个ShaderCompileWorker进程。</p>
<h2 id="UnrealPak的加密参数"><a href="#UnrealPak的加密参数" class="headerlink" title="UnrealPak的加密参数"></a>UnrealPak的加密参数</h2><p>UnrealPak支持的命令行参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">LogPakFile: Display: Using command line for crypto configuration</span><br><span class="line">LogPakFile: Error: No pak file name specified. Usage:</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Test</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -List [-ExcludeDeleted]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; &lt;GameUProjectName&gt; &lt;GameFolderName&gt; -ExportDependencies=&lt;OutputFileBase&gt; -NoAssetRegistryCache -ForceDependsGathering</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Extract &lt;ExtractDir&gt; [-Filter=&lt;filename&gt;]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Create=&lt;ResponseFile&gt; [Options]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Dest=&lt;MountPoint&gt;</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -Repack [-Output=Path] [-ExcludeDeleted] [Options]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename1&gt; &lt;PakFilename2&gt; -diff</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFolder&gt; -AuditFiles [-OnlyDeleted] [-CSV=&lt;filename&gt;] [-order=&lt;OrderingFile&gt;] [-SortByOrdering]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFilename&gt; -WhatsAtOffset [offset1] [offset2] [offset3] [...]</span><br><span class="line">LogPakFile: Error:   UnrealPak &lt;PakFolder&gt; -GeneratePIXMappingFile -OutputPath=&lt;Path&gt;</span><br><span class="line">LogPakFile: Error:   Options:</span><br><span class="line">LogPakFile: Error:     -blocksize=&lt;BlockSize&gt;</span><br><span class="line">LogPakFile: Error:     -bitwindow=&lt;BitWindow&gt;</span><br><span class="line">LogPakFile: Error:     -compress</span><br><span class="line">LogPakFile: Error:     -encrypt</span><br><span class="line">LogPakFile: Error:     -order=&lt;OrderingFile&gt;</span><br><span class="line">LogPakFile: Error:     -diff (requires 2 filenames first)</span><br><span class="line">LogPakFile: Error:     -enginedir (specify engine dir for when using ini encryption configs)</span><br><span class="line">LogPakFile: Error:     -projectdir (specify project dir for when using ini encryption configs)</span><br><span class="line">LogPakFile: Error:     -encryptionini (specify ini base name to gather encryption settings from)</span><br><span class="line">LogPakFile: Error:     -extracttomountpoint (Extract to mount point path of pak file)</span><br><span class="line">LogPakFile: Error:     -encryptindex (encrypt the pak file index, making it unusable in unrealpak without supplying the key)</span><br><span class="line">LogPakFile: Error:     -compressionformat[s]=&lt;Format[,format2,...]&gt; (set the format(s) to compress with, falling back on failures)</span><br><span class="line">LogPakFile: Error:     -encryptionkeyoverrideguid (override the encryption key guid used for encrypting data in this pak file)</span><br><span class="line">LogPakFile: Error:     -sign (generate a signature (.sig) file alongside the pak)</span><br><span class="line">LogPakFile: Error:     -fallbackOrderForNonUassetFiles (if order is not specified for ubulk/uexp files, figure out implicit order based on the uasset order. Generally applies only to the cooker order)</span><br><span class="line">LogPakFile: Display: Unreal pak executed in 0.006367 seconds</span><br></pre></td></tr></table></figure>
<p>关于包的加密，在<code>Project Settings</code>-<code>Crypto</code>中有四个选项：</p>
<ul>
<li><code>bEnablePakIndexEncryption</code>:加密Pakindex</li>
<li><code>bEnablePakIniEncryption</code>：加密pak中的ini</li>
<li><code>bEnablePakUAssetEncryption</code>：加密pak中的uasset</li>
<li><code>bEnablePakFullAssetEncryption</code>：加密Pak中所有的文件</li>
</ul>
<p>但是除了<code>bEnablePakIndexEncryption</code>之外，其他的参数并不是传递给UnrealPak的命令行参数，而是生成的Paklist中每个文件的参数：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/9e0f5f2a419a75b83392c44bf75462366ca8c1e2/Engine/Source/Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs#L154">CopyBuildToStagingDirectory.Automation.cs#L154</a></li>
</ul>
<p>对paklist中的对应格式文件添加<code>-encrypt</code>参数。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Cooked\WindowsNoEditor\Engine\Content\EngineResources\GradientTexture0.uasset&quot; &quot;../../../Engine/Content/EngineResources/GradientTexture0.uasset&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Cooked\WindowsNoEditor\Engine\Content\EngineResources\GradientTexture0.uexp&quot; &quot;../../../Engine/Content/EngineResources/GradientTexture0.uexp&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Temp\Win64\Engine\Config\Base.ini&quot; &quot;../../../Engine/Config/Base.ini&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Saved\Temp\Win64\Engine\Config\BaseCompat.ini&quot; &quot;../../../Engine/Config/BaseCompat.ini&quot; -encrypt</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\UnrealProjects\Blank425\Intermediate\Staging\Blank425.upluginmanifest&quot; &quot;../../../Blank425/Plugins/Blank425.upluginmanifest&quot; -encrypt</span><br></pre></td></tr></table></figure>
<p>当开启了<code>bEnablePakIniEncryption</code>，就会对当前Paklist中的ini文件添加<code>-encrypt</code>参数。</p>
<h2 id="获取私有UObject类属性的方法"><a href="#获取私有UObject类属性的方法" class="headerlink" title="获取私有UObject类属性的方法"></a>获取私有UObject类属性的方法</h2><p>以<code>UCryptoKeysSettings</code>为例，它在<code>Classes/CryptoKeysSettings.h</code>中定义，外部模块无法访问，但是可以用FindObject绕过：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">UClass* Class = FindObject&lt;UClass&gt;(ANY_PACKAGE, <span class="built_in">TEXT</span>(<span class="string">&quot;/Script/CryptoKeys.CryptoKeysSettings&quot;</span>), <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span>(Class)</span><br><span class="line">&#123;</span><br><span class="line">    FString AESKey;</span><br><span class="line">    <span class="keyword">for</span>(TFieldIterator&lt;FProperty&gt; <span class="built_in">PropertyIter</span>(Class);PropertyIter;++PropertyIter)</span><br><span class="line">    &#123;</span><br><span class="line">    FProperty* PropertyIns = *PropertyIter;</span><br><span class="line">    <span class="keyword">if</span>(PropertyIns-&gt;<span class="built_in">GetName</span>().<span class="built_in">Equals</span>(ENCRYPT_KEY_NAME))</span><br><span class="line">    &#123;</span><br><span class="line">        AESKey = *PropertyIns-&gt;ContainerPtrToValuePtr&lt;FString&gt;(Class-&gt;<span class="built_in">GetDefaultObject</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!AESKey.<span class="built_in">IsEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    Result += FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;-aes=\&quot;%s\&quot; &quot;</span>),*AESKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="引擎内的图片资源"><a href="#引擎内的图片资源" class="headerlink" title="引擎内的图片资源"></a>引擎内的图片资源</h2><p>定义在<code>Engine\Source\Editor\EditorStyle\Private\SlateEditorStyle.cpp</code>路径下。</p>
<p>使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SNew</span>(SImage)</span><br><span class="line">.<span class="built_in">Image</span>(FEditorStyle::<span class="built_in">GetBrush</span>(<span class="string">&quot;LauncherCommand.QuickLaunch&quot;</span>))</span><br></pre></td></tr></table></figure>

<h2 id="构建插件"><a href="#构建插件" class="headerlink" title="构建插件"></a>构建插件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Build\BatchFiles\RunUAT.bat BuildPlugin -Plugin=[Path to .uplugin file, must be outside engine directory] -Package=[Output directory] -Rocket</span><br></pre></td></tr></table></figure>

<h2 id="加载资源到磁盘文件读取栈"><a href="#加载资源到磁盘文件读取栈" class="headerlink" title="加载资源到磁盘文件读取栈"></a>加载资源到磁盘文件读取栈</h2><p>加载<code>/Engine/Functions/Engine_MaterialFunctions02/Utility/DebugScalarValues</code>资源，最终从磁盘读取的调用栈：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108150332.png"></p>
<p>把PackagePath转换为UFS路径的栈：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108151127.png"></p>
<p>通过<code>IFileManager::Get().CreateFileReader()</code>抽象接口调用到具体的平台相关的PlatformFile：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211108151746.png"></p>
<p><code>IFileManager::Get().CreateFileReader</code>实际上是通过调用<code>GetLowLevel()</code>获取到<code>IPlatformFile</code>的:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE IPlatformFile&amp; <span class="title">GetLowLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>FPlatformFileManager::Get().SetPlatformFile</code>即可切换不同的PlatformFile。</p>
<p>从而实现从磁盘或者从Pak中文件的IO.</p>
<h2 id="关闭Rider扫描uasset"><a href="#关闭Rider扫描uasset" class="headerlink" title="关闭Rider扫描uasset"></a>关闭Rider扫描uasset</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211104193304.png"></p>
<h2 id="默认打包UI目录"><a href="#默认打包UI目录" class="headerlink" title="默认打包UI目录"></a>默认打包UI目录</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211105195949.png"></p>
<h2 id="LongPackageNameToFilename"><a href="#LongPackageNameToFilename" class="headerlink" title="LongPackageNameToFilename"></a>LongPackageNameToFilename</h2><p><code>FPackageName::LongPackageNameToFilename</code>可以将<code>/Game/UI</code>等路径转换为物理相对路径。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211105200205.png"></p>
<h2 id="多进程Cook"><a href="#多进程Cook" class="headerlink" title="多进程Cook"></a>多进程Cook</h2><p>可以给CookCommand传递<code>-numcookerstospawn=</code>参数，指定想要启动的Cooker数量。</p>
<h2 id="Cook时的资源收集"><a href="#Cook时的资源收集" class="headerlink" title="Cook时的资源收集"></a>Cook时的资源收集</h2><figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UCookOnTheFlyServer::CollectFilesToCook</span><span class="params">(TArray&lt;FName&gt;&amp; FilesInPath, <span class="keyword">const</span> TArray&lt;FString&gt;&amp; CookMaps, <span class="keyword">const</span> TArray&lt;FString&gt;&amp; InCookDirectories,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TArray&lt;FString&gt; &amp;IniMapSections, ECookByTheBookOptions FilesToCookFlags, <span class="keyword">const</span> TArrayView&lt;<span class="keyword">const</span> ITargetPlatform* <span class="keyword">const</span>&gt;&amp; TargetPlatforms)</span></span></span><br></pre></td></tr></table></figure>
<p>在打包时也会收集已经被加载到内存中的包：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get any packages which are in memory, these were probably required to be loaded because of the current package we are cooking, so we should probably cook them also</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">TArray&lt;UPackage*&gt; <span class="title">GetUnsolicitedPackages</span><span class="params">(<span class="keyword">const</span> TArray&lt;<span class="keyword">const</span> ITargetPlatform*&gt;&amp; TargetPlatforms)</span> <span class="keyword">const</span></span>;</span><br></pre></td></tr></table></figure>
<p>在引擎的<code>PreInitPostStartupScreen</code>阶段启动，并会持续收集Cook过程中创建的资源并执行Cook。<br>可以添加一个在<code>PostEngineInit</code>阶段启动的Module获取，与Commandlet执行时相同。</p>
<h2 id="编译UBlueprint"><a href="#编译UBlueprint" class="headerlink" title="编译UBlueprint"></a>编译UBlueprint</h2><p>UBlueprint是所有蓝图（包含动画蓝图、Object/Actor/Component蓝图），动画蓝图是UAnimBlueprint。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Tries to compile a blueprint, updating any actors in the editor who are using the old class, etc... */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FKismetEditorUtilities::CompileBlueprint</span><span class="params">(UBlueprint* BlueprintObj, EBlueprintCompileOptions CompileFlags = EBlueprintCompileOptions::None, class FCompilerResultsLog* pResults = <span class="literal">nullptr</span> )</span></span>;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211101130227.png"></p>
<p>从编译的结果可以获取UBlueprint是否具有警告或错误。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20211101130343.png"></p>
<h2 id="IOS-Metal-Shader-or-HLSL-Shader"><a href="#IOS-Metal-Shader-or-HLSL-Shader" class="headerlink" title="IOS Metal Shader or HLSL Shader"></a>IOS Metal Shader or HLSL Shader</h2><p>对于IOS包，加载metal还是ushaderbytecode的逻辑：</p>
<ol>
<li>尝试加载metalib，若加载失败，则<code>FMetalDynamicRHI::RHICreateShaderLibrary</code>返回nullptr (<code>Apple\MetalRHI\Private\MetalShaders.cpp</code>)</li>
<li>加载metalib失败，则加载ushaderbytecode</li>
</ol>
<p>看原理上来说，也支持基础包是metalib+热更的ushaderbytecode，以及反之。</p>
<figure class="highlight cpp"><figcaption><span>Runtime\RenderCore\Private\ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FShaderLibraryInstance</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FShaderLibraryInstance* <span class="title">Create</span><span class="params">(EShaderPlatform InShaderPlatform, <span class="keyword">const</span> FString&amp; ShaderCodeDir, FString <span class="keyword">const</span>&amp; InLibraryName)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FRHIShaderLibraryRef Library;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">RHISupportsNativeShaderLibraries</span>(InShaderPlatform))</span><br><span class="line">		&#123;</span><br><span class="line">			Library = <span class="built_in">RHICreateShaderLibrary</span>(InShaderPlatform, ShaderCodeDir, InLibraryName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!Library)</span><br><span class="line">		&#123;</span><br><span class="line">          	<span class="keyword">const</span> FName PlatformName = <span class="built_in">LegacyShaderPlatformToShaderFormat</span>(InShaderPlatform);</span><br><span class="line">			<span class="keyword">const</span> FString DestFilePath = <span class="built_in">GetCodeArchiveFilename</span>(ShaderCodeDir, InLibraryName, PlatformName);</span><br><span class="line">			<span class="function">TUniquePtr&lt;FArchive&gt; <span class="title">Ar</span><span class="params">(IFileManager::Get().CreateFileReader(*DestFilePath))</span></span>;</span><br><span class="line">          	<span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="UE4-27官方支持Docker"><a href="#UE4-27官方支持Docker" class="headerlink" title="UE4.27官方支持Docker"></a>UE4.27官方支持Docker</h2><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/34FyezTeMom8uhtJAJMAZA">白皮书：基于云的虚幻引擎解决方案</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/zh-CN/SharingAndReleasing/Containers/">UE官方文档：容器</a></li>
</ul>
<h2 id="NVIDIA的UE仓库"><a href="#NVIDIA的UE仓库" class="headerlink" title="NVIDIA的UE仓库"></a>NVIDIA的UE仓库</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/NvPhysX/UnrealEngine">NVIDIA Unreal Engine 4 Fork</a><h2 id="UE-Xcode13支持"><a href="#UE-Xcode13支持" class="headerlink" title="UE Xcode13支持"></a>UE Xcode13支持</h2></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/ed97f0f865b7dce3c43bb15c2d7f86974eaafd75#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d1cfc8075b79e8bcf9802581b2f5b">Xcode 13 support</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/0872cfbd11a73fe44a0e268eb46cfef4d61cda92#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d1cfc8075b79e8bcf9802581b2f5b">Revert Xcode project/workspace settings to use legacy build system.</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/dc7a584238fe265eac323fd8b74806f821fcd7f9#diff-984b1fd9bd2159102721f49c0fd8fbfb8a8d1cfc8075b79e8bcf9802581b2f5b">Fix for legacy build systems on MacOS</a></li>
</ul>
<h2 id="Android不支持ApexDestruction"><a href="#Android不支持ApexDestruction" class="headerlink" title="Android不支持ApexDestruction"></a>Android不支持ApexDestruction</h2><p>在<code>Engine\Plugins\Runtime\ApexDestruction\Source\ThirdParty\PhysX\ApexDestructionLib.Build.cs</code>中，没有添加移动平台的链接库。</p>
<p>并且，<code>Programs\UnrealBuildTool\Platform\Android\UEBuildAndroid.cs</code>中，强制关掉了<code>bCompileApex</code>：</p>
<figure class="highlight csharp"><figcaption><span>Programs\UnrealBuildTool\Platform\Android\UEBuildAndroid.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ValidateTarget</span>(<span class="params">TargetRules Target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Target.bCompilePhysX = <span class="literal">true</span>;</span><br><span class="line">    Target.bCompileAPEX = <span class="literal">false</span>;</span><br><span class="line">    Target.bCompileNvCloth = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    Target.bCompileRecast = <span class="literal">true</span>;</span><br><span class="line">    Target.bCompileISPC = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UDataTable限定结构类型"><a href="#UDataTable限定结构类型" class="headerlink" title="UDataTable限定结构类型"></a>UDataTable限定结构类型</h2><p>通过<code>UPROPERTY</code>中加meta的<code>RequiredAssetDataTags</code>即可实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere, Category=Appearance, meta = (RequiredAssetDataTags = <span class="string">&quot;RowStructure=RichImageRow&quot;</span>))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UDataTable</span>* <span class="title">ImageSet</span>;</span></span><br></pre></td></tr></table></figure>

<h2 id="从DataTable中加载数据"><a href="#从DataTable中加载数据" class="headerlink" title="从DataTable中加载数据"></a>从DataTable中加载数据</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere,Category=<span class="string">&quot;RulesTable&quot;</span>, meta=(RequiredAssetDataTags = <span class="string">&quot;RowStructure=ScannerMatchRule&quot;</span>))</span><br><span class="line">TSoftObjectPtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">UDataTable</span>&gt;</span> ImportRulesTable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line">&#123;</span><br><span class="line">    UDataTable* RulesTable = ImportRulesTable.<span class="built_in">Get</span>();</span><br><span class="line">    TArray&lt;FName&gt; RowNames = RulesTable-&gt;<span class="built_in">GetRowNames</span>();</span><br><span class="line">    FString ContextString;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; name : RowNames)</span><br><span class="line">    &#123;</span><br><span class="line">        FScannerMatchRule* pRow = RulesTable-&gt;FindRow&lt;FScannerMatchRule&gt;(name, ContextString);</span><br><span class="line">        ScannerRules.<span class="built_in">Add</span>(*pRow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="从关卡的UObject获取AWorldsettings"><a href="#从关卡的UObject获取AWorldsettings" class="headerlink" title="从关卡的UObject获取AWorldsettings"></a>从关卡的UObject获取AWorldsettings</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ULevelMapRule::Match_Implementation</span><span class="params">(UObject* Object, <span class="keyword">const</span> FString&amp; AssetType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bIsMatch = <span class="literal">false</span>;</span><br><span class="line">    UWorld *World = Cast&lt;UWorld&gt;(Object);</span><br><span class="line">    <span class="keyword">if</span> (World)</span><br><span class="line">    &#123;</span><br><span class="line">        AWorldSettings*  Settings = World-&gt;<span class="built_in">GetWorldSettings</span>();</span><br><span class="line">        <span class="keyword">if</span> (Settings)</span><br><span class="line">        &#123;</span><br><span class="line">            TSubclassOf&lt;<span class="class"><span class="keyword">class</span> <span class="title">AGameModeBase</span>&gt;</span> GameMode = Settings-&gt;DefaultGameMode;</span><br><span class="line">            <span class="keyword">if</span> (!GameMode || (GameMode &amp;&amp; GameMode-&gt;<span class="built_in">GetName</span>().<span class="built_in">Equals</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;NetGameMode&quot;</span>))))</span><br><span class="line">                bIsMatch = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Map %s Game Mode is %s&quot;</span>), *World-&gt;<span class="built_in">GetMapName</span>(),*GameMode-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !bIsMatch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="adb执行console-command"><a href="#adb执行console-command" class="headerlink" title="adb执行console command"></a>adb执行console command</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell am broadcast -a android.intent.action.RUN -e cmd <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>如果是在shell中，只需要指定<code>am</code>及之后的命令即可。实际上这也是UE中Android平台实现的<code>ExecuteConsoleCommand</code>的方式：</p>
<figure class="highlight cpp"><figcaption><span>Engine\Source\Developer\Android\AndroidTargetPlatform\Private\AndroidTargetDevice.inl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FAndroidTargetDevice::ExecuteConsoleCommand</span><span class="params">(<span class="keyword">const</span> FString&amp; ExecCommand)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString AdbCommand = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;shell \&quot;am broadcast -a android.intent.action.RUN -e cmd &#x27;%s&#x27;\&quot;&quot;</span>), *ExecCommand);</span><br><span class="line">    <span class="built_in">ExecuteAdbCommand</span>(AdbCommand, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取当前运行的Ini平台名"><a href="#获取当前运行的Ini平台名" class="headerlink" title="获取当前运行的Ini平台名"></a>获取当前运行的Ini平台名</h2><p>如WindowsNoEditor/WindowsClient/WindowsServer使用的均是<code>Config/Windows/</code>下的配置文件，可以通过以下方法获取配置平台名字。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ANSI_TO_TCHAR</span>(FPlatformProperties::<span class="built_in">IniPlatformName</span>())</span><br></pre></td></tr></table></figure>

<h2 id="ImportText"><a href="#ImportText" class="headerlink" title="ImportText"></a>ImportText</h2><p><code>FProperty</code>具有<code>ImportText</code>函数，可以从字符串中导入数据，第一个参数是值字符串，第二个参数是接收值的对象，可以通过<code>ContainerPtrToValuePtr</code>获取。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> TCHAR* <span class="title">ImportText</span><span class="params">( <span class="keyword">const</span> TCHAR* Buffer, <span class="keyword">void</span>* Data, int32 PortFlags, UObject* OwnerObject, FOutputDevice* ErrorText = (FOutputDevice*)GWarn )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">ValidateImportFlags</span>(PortFlags,ErrorText) || Buffer == <span class="literal">NULL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PortFlags |= EPropertyPortFlags::PPF_UseDeprecatedProperties; <span class="comment">// Imports should always process deprecated properties</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ImportText_Internal</span>( Buffer, Data, PortFlags, OwnerObject, ErrorText );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Property-&gt;<span class="built_in">ImportText</span>(*Value, Property-&gt;ContainerPtrToValuePtr&lt;uint8&gt;(<span class="keyword">this</span>, i), PortFlags, <span class="keyword">this</span>) == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// this should be an error as the properties from the .ini / .int file are not correctly being read in and probably are affecting things in subtle ways</span></span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogObj, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;LoadConfig (%s): import failed for %s in: %s&quot;</span>), *<span class="built_in">GetPathName</span>(), *Property-&gt;<span class="built_in">GetName</span>(), *Value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要考虑Array和非Array的情况，使用以下方法遍历：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FArrayProperty* Array = CastField&lt;FArrayProperty&gt;( Property );</span><br><span class="line"><span class="keyword">if</span>( Array == <span class="literal">NULL</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>( int32 i=<span class="number">0</span>; i&lt;Property-&gt;ArrayDim; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( Property-&gt;ArrayDim!=<span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            Key = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s[%i]&quot;</span>), *Property-&gt;<span class="built_in">GetName</span>(), i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Property-&gt;<span class="built_in">ImportText</span>(*Value, Property-&gt;ContainerPtrToValuePtr&lt;uint8&gt;(<span class="keyword">this</span>, i), PortFlags, <span class="keyword">this</span>) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// this should be an error as the properties from the .ini / .int file are not correctly being read in and probably are affecting things in subtle ways</span></span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogObj, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;LoadConfig (%s): import failed for %s in: %s&quot;</span>), *<span class="built_in">GetPathName</span>(), *Property-&gt;<span class="built_in">GetName</span>(), *Value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UE截图Graph的方法"><a href="#UE截图Graph的方法" class="headerlink" title="UE截图Graph的方法"></a>UE截图Graph的方法</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Slate/WidgetRenderer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/TextureRenderTarget2D.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Misc/ScopedSlowTask.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ImageUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Misc/FileHelper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EdGraphNode_Comment.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GraphEditor/Private/SGraphEditorImpl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GraphEditor/Public/SGraphPanel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GraphEditor/Public/SNodePanel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;SNotificationList.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;NotificationManager.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRIVATEACCESS_MEMBER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIVATEACCESS_MEMBER(Class, Member, ...)                                                    \</span></span><br><span class="line">    <span class="keyword">namespace</span> PrivateAccess                                                                         \</span><br><span class="line">    &#123;                                                                                               \</span><br><span class="line">        <span class="keyword">using</span> MemberPtr##Class##Member##Type = __VA_ARGS__;                                         \</span><br><span class="line">        <span class="keyword">using</span> MemberPtr##Class##Member = MemberPtr##Class##Member##Type Class::*;                   \</span><br><span class="line">        <span class="keyword">template</span>&lt;MemberPtr##Class##Member MemPtr&gt;                                                   \</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Get</span>##<span class="title">Class</span>##<span class="title">Member</span>                                                                   \</span></span><br><span class="line"><span class="class">        &#123;</span>                                                                                           \</span><br><span class="line">            <span class="keyword">friend</span> MemberPtr##Class##Member Access##Class##<span class="built_in">Member</span>() &#123; <span class="keyword">return</span> MemPtr; &#125;              \</span><br><span class="line">        &#125;;                                                                                          \</span><br><span class="line">        MemberPtr##Class##Member Access##Class##<span class="built_in">Member</span>();                                           \</span><br><span class="line">        <span class="keyword">template</span> <span class="class"><span class="keyword">struct</span> <span class="title">Get</span>##<span class="title">Class</span>##<span class="title">Member</span>&lt;</span>&amp;##Class::##Member&gt;;                                     \</span><br><span class="line">        <span class="function"><span class="keyword">auto</span>&amp; <span class="title">Member</span><span class="params">(<span class="keyword">const</span> Class&amp; obj)</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">const_cast</span>&lt;Class&amp;&gt;(obj).*Access##Class##<span class="built_in">Member</span>(); &#125; \</span><br><span class="line">        <span class="function"><span class="keyword">auto</span>&amp; <span class="title">Member</span><span class="params">(<span class="keyword">const</span> Class* obj)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">Member</span>(*obj); &#125;                                     \</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PRIVATEACCESS_MEMBER</span>(SGraphEditorImpl, GraphPanel, TSharedPtr&lt;SGraphPanel&gt;)</span><br><span class="line"><span class="built_in">PRIVATEACCESS_MEMBER</span>(SNodePanel, NodeToWidgetLookup, TMap&lt;UObject*, TSharedRef&lt;SNodePanel::SNode&gt;&gt;)</span><br><span class="line"><span class="built_in">PRIVATEACCESS_MEMBER</span>(SNodePanel, ViewOffset, FVector2D)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Capture</span><span class="params">(TSharedPtr&lt;SGraphEditor&gt; GraphEditor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        SGraphEditorImpl* Impl = <span class="keyword">static_cast</span>&lt;SGraphEditorImpl*&gt;(GraphEditor.<span class="built_in">Get</span>());</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">ensure</span>(Impl))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        TSharedPtr&lt;SGraphPanel&gt; GraphPanel = PrivateAccess::<span class="built_in">GraphPanel</span>(Impl);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">ensure</span>(GraphPanel.<span class="built_in">IsValid</span>()))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        SNodePanel* NodePanel = <span class="keyword">static_cast</span>&lt;SNodePanel*&gt;(GraphPanel.<span class="built_in">Get</span>());</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">ensure</span>(NodePanel))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">1.0f</span>, LOCTEXT(<span class="string">&quot;Capture&quot;</span>, <span class="string">&quot;Capturing Graph&quot;</span>))</span></span>;</span><br><span class="line">        SlowTask.<span class="built_in">MakeDialog</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        TSharedPtr&lt;FWidgetRenderer&gt; Render = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FWidgetRenderer</span>(<span class="literal">true</span>));</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FName <span class="title">BpEditorModuleName</span><span class="params">(<span class="string">&quot;Kismet&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">auto</span>&amp; NodeToWidgetLookup = PrivateAccess::<span class="built_in">NodeToWidgetLookup</span>(NodePanel);</span><br><span class="line">        FVector2D MinCorner = <span class="built_in">FVector2D</span>(MAX_FLT, MAX_FLT);</span><br><span class="line">        FVector2D MaxCorner = <span class="built_in">FVector2D</span>(-MAX_FLT, -MAX_FLT);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> NodeIt = NodeToWidgetLookup.<span class="built_in">CreateConstIterator</span>(); NodeIt; ++NodeIt)</span><br><span class="line">        &#123;</span><br><span class="line">            SNodePanel::SNode&amp; Widget = NodeIt.<span class="built_in">Value</span>().<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> FVector2D Lower = Widget.<span class="built_in">GetPosition</span>();</span><br><span class="line">            <span class="keyword">const</span> FVector2D Upper = Lower + Widget.<span class="built_in">GetDesiredSize</span>();</span><br><span class="line"></span><br><span class="line">            MinCorner.X = FMath::<span class="built_in">Min</span>(MinCorner.X, Lower.X);</span><br><span class="line">            MinCorner.Y = FMath::<span class="built_in">Min</span>(MinCorner.Y, Lower.Y);</span><br><span class="line">            MaxCorner.X = FMath::<span class="built_in">Max</span>(MaxCorner.X, Upper.X);</span><br><span class="line">            MaxCorner.Y = FMath::<span class="built_in">Max</span>(MaxCorner.Y, Upper.Y);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">0.2f</span>, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;Capture_Step1&quot;</span>, <span class="string">&quot;Collecting Graph Info&quot;</span>));</span><br><span class="line">        FSlateRect rect;</span><br><span class="line">        <span class="keyword">const</span> int32 Offset = <span class="number">30</span>;</span><br><span class="line">        MinCorner += <span class="built_in">FVector2D</span>(<span class="number">-2</span> * Offset, <span class="number">-2</span> * Offset);</span><br><span class="line">        MaxCorner += <span class="built_in">FVector2D</span>(Offset, Offset);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// save offset</span></span><br><span class="line">        FVector2D&amp; ViewOffset = PrivateAccess::<span class="built_in">ViewOffset</span>(NodePanel);</span><br><span class="line">        FVector2D OldOffset = ViewOffset;</span><br><span class="line">        ViewOffset = <span class="built_in">FVector2D</span>(MinCorner.X, MinCorner.Y);</span><br><span class="line"></span><br><span class="line">        FVector2D Size = <span class="built_in">FVector2D</span>(MaxCorner.X - MinCorner.X, MaxCorner.Y - MinCorner.Y);</span><br><span class="line">        <span class="keyword">float</span> zoom = GraphPanel-&gt;<span class="built_in">GetZoomAmount</span>();</span><br><span class="line">        FIntPoint ActualSize = <span class="built_in">FIntPoint</span>(<span class="built_in">uint32</span>(Size.X * zoom), <span class="built_in">uint32</span>(Size.Y * zoom));</span><br><span class="line">        <span class="keyword">if</span> (ActualSize.X == <span class="number">0</span> || ActualSize.Y == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> FReply::<span class="built_in">Handled</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint32 MaxDimension = <span class="built_in">GetMax2DTextureDimension</span>();</span><br><span class="line">        &#123;</span><br><span class="line">            TArray&lt;FColor&gt; CombineBmp;</span><br><span class="line">            CombineBmp.<span class="built_in">AddUninitialized</span>(ActualSize.X * ActualSize.Y);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> combine_row_col = [](TArray&lt;FColor&gt;&amp; Bmp, int32 ActualX, uint32 row, uint32 col, FColor&amp; color) &#123;</span><br><span class="line">                color.A = <span class="number">255</span>;</span><br><span class="line">                FColor Current = color;</span><br><span class="line">                Bmp[row * ActualX + col] = Current;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            uint32 RemainSizeX = ActualSize.X;</span><br><span class="line">            uint32 RemainSizeY = ActualSize.Y;</span><br><span class="line">            FVector2D OffsetCache = <span class="built_in">FVector2D</span>(MinCorner.X, MinCorner.Y);</span><br><span class="line"></span><br><span class="line">            int32 SpliteNums = ((uint32)(RemainSizeX / MaxDimension) + <span class="number">1</span>) * ((uint32)(RemainSizeY / MaxDimension) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            int32 Counts = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (uint32 i = <span class="number">0</span>; i &lt; (uint32)(RemainSizeX / MaxDimension) + <span class="number">1</span>; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (uint32 j = <span class="number">0</span>; j &lt; (uint32)(RemainSizeY / MaxDimension) + <span class="number">1</span>; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    uint32 SizeX = (i == (uint32)(RemainSizeX / MaxDimension)) ? (RemainSizeX - MaxDimension * ((uint32)(RemainSizeX / MaxDimension))) : MaxDimension;</span><br><span class="line">                    uint32 SizeY = (j == (uint32)(RemainSizeY / MaxDimension)) ? (RemainSizeY - MaxDimension * ((uint32)(RemainSizeY / MaxDimension))) : MaxDimension;</span><br><span class="line"></span><br><span class="line">                    OffsetCache = <span class="built_in">FVector2D</span>(i * MaxDimension / zoom, j * MaxDimension / zoom) + <span class="built_in">FVector2D</span>(MinCorner.X, MinCorner.Y);</span><br><span class="line">                    ViewOffset = OffsetCache;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">                    UTextureRenderTarget2D* RenderTarget = FWidgetRenderer::<span class="built_in">CreateTargetFor</span>(<span class="built_in">FVector2D</span>(SizeX, SizeY), TF_Nearest, <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    UTextureRenderTarget2D* RenderTarget = NewObject&lt;UTextureRenderTarget2D&gt;();</span><br><span class="line">                    RenderTarget-&gt;ClearColor = FLinearColor::Black;</span><br><span class="line">                    RenderTarget-&gt;Filter = TF_Nearest;</span><br><span class="line">                    RenderTarget-&gt;SRGB = <span class="literal">true</span>;</span><br><span class="line">                    RenderTarget-&gt;TargetGamma = <span class="number">2.2</span>;</span><br><span class="line">                    RenderTarget-&gt;<span class="built_in">InitCustomFormat</span>(SizeX, SizeY, PF_B8G8R8A8, <span class="literal">true</span>);</span><br><span class="line">                    RenderTarget-&gt;<span class="built_in">UpdateResourceImmediate</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    Render-&gt;<span class="built_in">DrawWidget</span>(RenderTarget, GraphPanel.<span class="built_in">ToSharedRef</span>(), <span class="number">1.0f</span>, <span class="built_in">FVector2D</span>(SizeX, SizeY), <span class="number">0.03f</span>);</span><br><span class="line">                    <span class="comment">// to avoid missing</span></span><br><span class="line">                    Render-&gt;<span class="built_in">DrawWidget</span>(RenderTarget, GraphPanel.<span class="built_in">ToSharedRef</span>(), <span class="number">1.0f</span>, <span class="built_in">FVector2D</span>(SizeX, SizeY), <span class="number">0.03f</span>);</span><br><span class="line"></span><br><span class="line">                    FTextureRenderTargetResource* rtResource = RenderTarget-&gt;<span class="built_in">GameThread_GetRenderTargetResource</span>();</span><br><span class="line">                    <span class="function">FReadSurfaceDataFlags <span class="title">readPixelFlags</span><span class="params">(RCM_UNorm)</span></span>;</span><br><span class="line"></span><br><span class="line">                    TArray&lt;FColor&gt; outBMP;</span><br><span class="line">                    outBMP.<span class="built_in">AddUninitialized</span>(RenderTarget-&gt;<span class="built_in">GetSurfaceWidth</span>() * RenderTarget-&gt;<span class="built_in">GetSurfaceHeight</span>());</span><br><span class="line">                    rtResource-&gt;<span class="built_in">ReadPixels</span>(outBMP, readPixelFlags);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (uint32 col = <span class="number">0</span>; col &lt; SizeX; ++col)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">for</span> (uint32 row = <span class="number">0</span>; row &lt; SizeY; ++row)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">combine_row_col</span>(CombineBmp, ActualSize.X, j * MaxDimension + row, i * MaxDimension + col, outBMP[row * SizeX + col]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Counts++;</span><br><span class="line">                    SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">0.6f</span> * (<span class="built_in"><span class="keyword">float</span></span>(Counts) / SpliteNums), FText::<span class="built_in">Format</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Capture_Step2&quot;</span>, <span class="string">&quot;Spliting Graph &#123;0&#125;/&#123;1&#125;&quot;</span>), Counts, SpliteNums));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">0.1f</span>, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;Capture_Step3&quot;</span>, <span class="string">&quot;Merging Graph Image, Please Wait...&quot;</span>));</span><br><span class="line">            TArray&lt;uint8&gt; CompressedImage;</span><br><span class="line">            FImageUtils::<span class="built_in">CompressImageArray</span>(ActualSize.X, ActualSize.Y, CombineBmp, CompressedImage);</span><br><span class="line"></span><br><span class="line">            FString SaveFileName;</span><br><span class="line"></span><br><span class="line">            SaveFileName.<span class="built_in">Append</span>(FDateTime::<span class="built_in">Now</span>().<span class="built_in">ToString</span>());</span><br><span class="line">            SaveFileName.<span class="built_in">Append</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;.png&quot;</span>));</span><br><span class="line"></span><br><span class="line">            FFileHelper::<span class="built_in">SaveArrayToFile</span>(CompressedImage, *(FPaths::<span class="built_in">ProjectSavedDir</span>() / SaveFileName));</span><br><span class="line"></span><br><span class="line">            ViewOffset = OldOffset;</span><br><span class="line">            SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">0.1f</span>, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;Capture_Step4&quot;</span>, <span class="string">&quot;Finish Capture Graph&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SwarmAgent-alway-busy"><a href="#SwarmAgent-alway-busy" class="headerlink" title="SwarmAgent alway busy"></a>SwarmAgent alway busy</h2><p>只有本地工作，远程Agent不工作：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210918111112.png"></p>
<p>默认情况下SwarmAgent内设置了一个CPU阈值，当最近CPU占用率达到<code>20%</code>，就会从<code>Available</code>变为<code>Busy</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Agent</span> : <span class="title">MarshalByRefObject</span>, <span class="title">IAgentInternalInterface</span>, <span class="title">IAgentInterface</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="built_in">float</span> CPUBusyThreshold = <span class="number">20.0f</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MaintainAgent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> !__MonoCS__</span></span><br><span class="line">    <span class="comment">// We&#x27;ll only care about this if we&#x27;re running on a user&#x27;s machine and assume</span></span><br><span class="line">    <span class="comment">// that on the swarm farm machines, it&#x27;s the only thing running</span></span><br><span class="line">    <span class="keyword">if</span>( ApplicationDeployment.IsNetworkDeployed == <span class="literal">false</span> )</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// Update the local performance stats</span></span><br><span class="line">       <span class="keyword">if</span>( ( LocalPerformanceStats != <span class="literal">null</span> ) &amp;&amp;</span><br><span class="line">          ( LocalPerformanceStats.Update() ) )</span><br><span class="line">       &#123;</span><br><span class="line">          <span class="comment">// Note that we&#x27;re quick to become Busy, slow to return to Available</span></span><br><span class="line">          <span class="keyword">if</span>( LocalPerformanceStats.LastCPUBusy &gt; CPUBusyThreshold )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span>( CurrentState == AgentState.Available )</span><br><span class="line">            &#123;</span><br><span class="line">               CurrentState = AgentState.Busy;</span><br><span class="line">               PingCoordinator( <span class="literal">true</span> );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span>( LocalPerformanceStats.AverageCPUBusy &lt;= ( CPUBusyThreshold * <span class="number">0.5f</span> ) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span>( CurrentState == AgentState.Busy )</span><br><span class="line">            &#123;</span><br><span class="line">               CurrentState = AgentState.Available;</span><br><span class="line">               PingCoordinator( <span class="literal">true</span> );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="FAssetData数据预览"><a href="#FAssetData数据预览" class="headerlink" title="FAssetData数据预览"></a>FAssetData数据预览</h2><p>从AssetRegistry获取的AssetData数据，能得到什么信息。<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/image-20210914163104707.png" alt="image-20210914163104707"></p>
<h2 id="分析UMG的Widget-Tree"><a href="#分析UMG的Widget-Tree" class="headerlink" title="分析UMG的Widget Tree"></a>分析UMG的Widget Tree</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FSoftObjectPath <span class="title">AssetObjectPath</span><span class="params">(PackageName)</span></span>;</span><br><span class="line">UWidgetBlueprint* UserWidgetBlueprint  = Cast&lt;UWidgetBlueprint&gt;(AssetObjectPath.<span class="built_in">TryLoad</span>());</span><br><span class="line"><span class="keyword">if</span>(UserWidgetBlueprint)</span><br><span class="line">&#123;</span><br><span class="line">  UWidgetBlueprintGeneratedClass* WBGC = Cast&lt;UWidgetBlueprintGeneratedClass&gt;(UserWidgetBlueprint-&gt;GeneratedClass);</span><br><span class="line">  <span class="keyword">if</span>(WBGC)</span><br><span class="line">  &#123;</span><br><span class="line">   TArray&lt;UWidget*&gt; Widgets;</span><br><span class="line">   WBGC-&gt;WidgetTree-&gt;<span class="built_in">GetAllWidgets</span>(Widgets);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210909203938.png"></p>
<h2 id="Share-Shader-library"><a href="#Share-Shader-library" class="headerlink" title="Share Shader library"></a>Share Shader library</h2><p>UE对Shader的序列化，开启bShareShaderLibrary或使用Inline code的方式序列化。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L2812">FShaderLibraryCooker::IsShaderLibraryEnabled</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L2550">ShaderCodeLibrary.cpp#L2550</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Source/Runtime/RenderCore/Private/ShaderMap.cpp#L185">FShaderMapBase::Serialize</a></li>
</ul>
<p>在开启Share shader library之后也可以开启强制某些材质inline shader code：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ShaderCodeLibrary]</span></span><br><span class="line"><span class="attr">bEnableInliningWorkaround_Windows</span>=<span class="literal">True</span></span><br><span class="line">+MaterialToInline=/Game/StarterContent/Materials/M_Brick_Clay_Beveled</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210830001957.png"></p>
<h2 id="LOL-Binaries-Patch"><a href="#LOL-Binaries-Patch" class="headerlink" title="LOL Binaries Patch"></a>LOL Binaries Patch</h2><ul>
<li><a target="_blank" rel="noopener" href="https://technology.riotgames.com/news/supercharging-data-delivery-new-league-patcher">SUPERCHARGING DATA DELIVERY: THE NEW LEAGUE PATCHER</a></li>
<li><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/jojodiff/">Jojos Binary Diff</a></li>
<li><a target="_blank" rel="noopener" href="http://jojodiff.sourceforge.net/">JojoDiff - diff utility for binary files</a></li>
<li><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">FlatBuffers</a></li>
</ul>
<h2 id="Config的运行时更新"><a href="#Config的运行时更新" class="headerlink" title="Config的运行时更新"></a>Config的运行时更新</h2><p>参考<code>UOnlineHotfixManager</code>中的实现：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Plugins/Online/OnlineFramework/Source/Hotfix/Private/OnlineHotfixManager.cpp#L858">UOnlineHotfixManager::HotfixIniFile</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Plugins/Online/OnlineFramework/Source/Hotfix/Private/OnlineHotfixManager.cpp#L1100">UOnlineHotfixManager::HotfixPakFile</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/99b6e203a15d04fc7bbbf554c421a985c1ccb8f1/Engine/Plugins/Online/OnlineFramework/Source/Hotfix/Private/OnlineHotfixManager.cpp#L1312">UOnlineHotfixManager::RestoreBackupIniFiles</a></li>
</ul>
<h2 id="插件支持Program"><a href="#插件支持Program" class="headerlink" title="插件支持Program"></a>插件支持Program</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;SupportedPrograms&quot; : [ &quot;UnrealPak&quot; ],</span><br></pre></td></tr></table></figure>

<h2 id="PackageNativeShaderLibrary"><a href="#PackageNativeShaderLibrary" class="headerlink" title="PackageNativeShaderLibrary"></a>PackageNativeShaderLibrary</h2><p>IOS把shaderbytecode编译成metallib。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Editor/UnrealEd/Private/CookOnTheFlyServer.cpp#L5826">CookOnTheFlyServer.cpp#L5826</a></li>
</ul>
<h2 id="Pak的拆分生成实现"><a href="#Pak的拆分生成实现" class="headerlink" title="Pak的拆分生成实现"></a>Pak的拆分生成实现</h2><p>打包时（执行<code>-run=cook</code>时），会在<code>Saved/Packaging/WindowsNoEditor</code>下生成<code>pakchunklist.txt</code>文件，记录着当前生成的pakchunk的文件名列表：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pakchunk0.txt</span><br><span class="line">pakchunk1.txt</span><br><span class="line">pakchunk2.txt</span><br></pre></td></tr></table></figure>
<p>在当前目录下，会有同名文件，每个文件中记录了当前Pak中应该包含的文件的绝对路径（只包含uasset的资源文件，不包含其他的非UFS文件）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\CompressionLab\Content\Mannequin\Animations\ThirdPersonJump_End</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\CompressionLab\Plugins\HDiffPatchUE4\Content\BP_HDiff</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\CompressionLab\Plugins\HDiffPatchUE4\Content\NewMap</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\CompressionLab\Plugins\HDiffPatchUE4\Content\NewMap_BuiltData</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\Engine\Content\Animation\DefaultAnimBoneCompressionSettings</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\Engine\Content\Animation\DefaultAnimCurveCompressionSettings</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\Engine\Content\ArtTools\RenderToTexture\Meshes\S_1_Unit_Plane</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\Engine\Content\BasicShapes\BasicShapeMaterial</span><br><span class="line">D:\CompressionLab\Saved\Cooked\WindowsNoEditor\Engine\Content\BasicShapes\Cone</span><br></pre></td></tr></table></figure>
<p>该文件在<code>bool FAssetRegistryGenerator::GenerateStreamingInstallManifest</code>(AssetRegistryGenerator.cpp)中生成，在<code>CreatePaksUsingChunkManifests</code>(Scripts/CopyBuildToStagingDirectory.Automation.cs)中被使用，它是引擎与UAT打包进行资源信息交互的桥梁。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210812173049.png"></p>
<p>UE就是通过这种方式实现的Pak拆分，所有的non-UFS文件都默认被打包至0号Chunk，其他的Asset则根据<code>FAssetRegistryGenerator</code>生成的进行Chunk划分。</p>
<p>在执行<code>FAssetRegistryGenerator</code>的流程之后，就会把资源路径存储到对应的<code>pakchunk*.txt</code>中，如果想要手动调用的话需要修改引擎代码，因为<code>FAssetRegistryGenerator</code>没有导出符号，所以不能在外部模块中访问，需要修改引擎添加<code>UNREALED_API</code>导出符号。</p>
<p>然后在自己的模块中包含<code>UnrealEd</code>，使用以下代码即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibHotPatcherEditorHelper::GeneratorAssetRegistryData</span><span class="params">(ITargetPlatform* TargetPlatform, <span class="keyword">const</span> TSet&lt;FName&gt;&amp; CookedPackageNames, <span class="keyword">const</span> TSet&lt;FName&gt;&amp; IgnorePackageNames, <span class="keyword">bool</span></span></span></span><br><span class="line"><span class="function"><span class="params">                                                             bGenerateStreamingInstallManifest)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bresult = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> GENERATE_ASSET_REGISTRY_DATA</span></span><br><span class="line">  TUniquePtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">FSandboxPlatformFile</span>&gt;</span> TempSandboxFile = MakeUnique&lt;FSandboxPlatformFile&gt;(<span class="literal">false</span>);</span><br><span class="line">  TUniquePtr&lt;FAssetRegistryGenerator&gt; RegistryGenerator = MakeUnique&lt;FAssetRegistryGenerator&gt;(TargetPlatform);</span><br><span class="line">  RegistryGenerator-&gt;<span class="built_in">CleanManifestDirectories</span>();</span><br><span class="line">  RegistryGenerator-&gt;<span class="built_in">Initialize</span>(TArray&lt;FName&gt;());</span><br><span class="line">  RegistryGenerator-&gt;<span class="built_in">PreSave</span>(CookedPackageNames);</span><br><span class="line">  RegistryGenerator-&gt;<span class="built_in">BuildChunkManifest</span>(CookedPackageNames, IgnorePackageNames, TempSandboxFile.<span class="built_in">Get</span>(), bGenerateStreamingInstallManifest);</span><br><span class="line">  bresult = RegistryGenerator-&gt;<span class="built_in">SaveManifests</span>(TempSandboxFile.<span class="built_in">Get</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> bresult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意需要传入当前执行之前<code>CookedPackageNames</code>，在创建<code>pakchunk*.txt</code>时会根据这个列表里的资源进行分类，也就是说能够实现我们自定义控制的资源列表来根据工程中的PrimaryAssetLabel的Chunk划分来进行分类。</p>
<h2 id="AllChunksInfo-csv"><a href="#AllChunksInfo-csv" class="headerlink" title="AllChunksInfo.csv"></a>AllChunksInfo.csv</h2><p>AllChunksInfo.csv是打包时位于<code>Cooked/PLATFORM/PROJECTNAME/Metadata</code>目录下的文件，记录了当前包内资源的Chunk拆分情况。<br>它在<code>FAssetRegistryGenerator::GenerateAssetChunkInformationCSV</code>中被生成（<code>AssetRegistryGenerator.cpp</code>）。</p>
<h2 id="AES加密"><a href="#AES加密" class="headerlink" title="AES加密"></a>AES加密</h2><p>UE具有AES加密的库，加密前后的字节数相同。但需要注意AES加密的数据需要进行16字节对齐。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210810194240.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Result.Bytes.<span class="built_in">AddZeroed</span>(<span class="built_in">Align</span>(Result.Bytes.<span class="built_in">Num</span>(), FAES::AESBlockSize) - Result.Bytes.<span class="built_in">Num</span>());</span><br><span class="line">FSHA1::<span class="built_in">HashBuffer</span>(Result.Bytes.<span class="built_in">GetData</span>(), Result.Bytes.<span class="built_in">Num</span>(), Info.IndexHash.Hash);</span><br><span class="line">FAES::<span class="built_in">EncryptData</span>(Result.Bytes.<span class="built_in">GetData</span>(), Result.Bytes.<span class="built_in">Num</span>(), InKeyChain.MasterEncryptionKey-&gt;Key);</span><br></pre></td></tr></table></figure>
<p>也可以只加密与16字节对齐的大小（忽略余数）。</p>
<h2 id="PakFileRules打包时的文件过滤规则"><a href="#PakFileRules打包时的文件过滤规则" class="headerlink" title="PakFileRules打包时的文件过滤规则"></a>PakFileRules打包时的文件过滤规则</h2><p>可以控制某些文件不打包进PAK内。</p>
<figure class="highlight csharp"><figcaption><span>Scripts/CopyBuildToStagingDirectory.Automation.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Reads Default/BasePakFileRules.ini and returns all PakFileRules objects that apply for this deployment</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Params&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;PakFileRules&gt; <span class="title">GetPakFileRules</span>(<span class="params">ProjectParams Params, DeploymentContext SC</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> bWarnedAboutMultipleTargets = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">bool</span> bFoundConfig = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  List&lt;ConfigFile&gt; ConfigFiles = <span class="keyword">new</span> List&lt;ConfigFile&gt;();</span><br><span class="line">  FileReference BaseConfigFileReference = FileReference.Combine(SC.EngineRoot, <span class="string">&quot;Config&quot;</span>, <span class="string">&quot;BasePakFileRules.ini&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (FileReference.Exists(BaseConfigFileReference))</span><br><span class="line">  &#123;</span><br><span class="line">    ConfigFiles.Add(<span class="keyword">new</span> ConfigFile(BaseConfigFileReference));</span><br><span class="line">    bFoundConfig = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FileReference ProjectConfigFileReference = FileReference.Combine(SC.ProjectRoot, <span class="string">&quot;Config&quot;</span>, <span class="string">&quot;DefaultPakFileRules.ini&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (FileReference.Exists(ProjectConfigFileReference))</span><br><span class="line">  &#123;</span><br><span class="line">    ConfigFiles.Add(<span class="keyword">new</span> ConfigFile(ProjectConfigFileReference));</span><br><span class="line">    bFoundConfig = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bFoundConfig)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> bChunkedBuild = SC.PlatformUsesChunkManifests &amp;&amp; DoesChunkPakManifestExist(Params, SC);</span><br><span class="line"></span><br><span class="line">  ConfigHierarchy PakRulesConfig = <span class="keyword">new</span> ConfigHierarchy(ConfigFiles);</span><br><span class="line"></span><br><span class="line">  List&lt;PakFileRules&gt; RulesList = <span class="keyword">new</span> List&lt;PakFileRules&gt;();</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> SectionName <span class="keyword">in</span> PakRulesConfig.SectionNames)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//LogInformation(&quot;Building PakFileRules for Section &#123;0&#125;&quot;, SectionName);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> bOnlyChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOnlyChunkedBuilds&quot;</span>, <span class="keyword">out</span> bOnlyChunkedBuilds))</span><br><span class="line">    &#123;</span><br><span class="line">      bOnlyChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> bOnlyNonChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOnlyNonChunkedBuilds&quot;</span>, <span class="keyword">out</span> bOnlyNonChunkedBuilds))</span><br><span class="line">    &#123;</span><br><span class="line">      bOnlyNonChunkedBuilds = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bChunkedBuild &amp;&amp; bOnlyNonChunkedBuilds)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!bChunkedBuild &amp;&amp; bOnlyChunkedBuilds)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> PlatformString;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;Platforms&quot;</span>, <span class="keyword">out</span> PlatformString))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span>[] PlatformStrings = PlatformString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries);</span><br><span class="line">      <span class="built_in">bool</span> bMatches = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check platform string</span></span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> Platform <span class="keyword">in</span> PlatformStrings)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (SC.StageTargetPlatform.PlatformType.ToString().Equals(Platform, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">          bMatches = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (SC.StageTargetPlatform.IniPlatformType.ToString().Equals(Platform, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">          bMatches = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!bMatches)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//LogInformation(&quot;No matching platform for PakFileRules for Section &#123;0&#125; : &#123;1&#125;, &#123;2&#125;&quot;, SectionName, SC.StageTargetPlatform.PlatformType.ToString(), SC.StageTargetPlatform.IniPlatformType.ToString());</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> TargetString;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;Targets&quot;</span>, <span class="keyword">out</span> TargetString))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span>[] TargetStrings = TargetString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries);</span><br><span class="line">      <span class="built_in">bool</span> bMatches = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check target string</span></span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> Target <span class="keyword">in</span> TargetStrings)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (UnrealTargetConfiguration C <span class="keyword">in</span> SC.StageTargetConfigurations)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (C.ToString() == Target)</span><br><span class="line">          &#123;</span><br><span class="line">            bMatches = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!bMatches)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (SC.StageTargetConfigurations.Count &gt; <span class="number">0</span> &amp;&amp; !bWarnedAboutMultipleTargets)</span><br><span class="line">      &#123;</span><br><span class="line">        bWarnedAboutMultipleTargets = <span class="literal">true</span>;</span><br><span class="line">        LogInformation(<span class="string">&quot;Staging with more than one target, PakFileRules may apply too many rules!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PakFileRules PakRules = <span class="keyword">new</span> PakFileRules();</span><br><span class="line">    PakRules.Name = SectionName;</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bExcludeFromPaks&quot;</span>, <span class="keyword">out</span> PakRules.bExcludeFromPaks);</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bOverrideChunkManifest&quot;</span>, <span class="keyword">out</span> PakRules.bOverrideChunkManifest);</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;bDisabled&quot;</span>, <span class="keyword">out</span> PakRules.bDisabled);</span><br><span class="line">    <span class="built_in">string</span> PakString;</span><br><span class="line">    PakRulesConfig.TryGetValue(SectionName, <span class="string">&quot;OverridePaks&quot;</span>, <span class="keyword">out</span> PakString);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PakString != <span class="literal">null</span> &amp;&amp; PakString.Length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      PakRules.OverridePaks = PakString.Split(<span class="keyword">new</span> <span class="built_in">char</span>[] &#123; <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span> &#125;, StringSplitOptions.RemoveEmptyEntries).ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      PakRules.OverridePaks = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PakRules.bExcludeFromPaks &amp;&amp; PakRules.OverridePaks != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LogWarning(<span class="string">&quot;Error in PakFileRules &#123;0&#125;, set to exclude but also sets override!&quot;</span>, PakRules.Name);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!PakRules.bExcludeFromPaks &amp;&amp; PakRules.OverridePaks == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LogWarning(<span class="string">&quot;Error in PakFileRules &#123;0&#125;, set to include but did not specify paks!&quot;</span>, PakRules.Name);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IReadOnlyList&lt;<span class="built_in">string</span>&gt; FilesEnumberable;</span><br><span class="line">    <span class="keyword">if</span> (PakRulesConfig.TryGetValues(SectionName, <span class="string">&quot;Files&quot;</span>, <span class="keyword">out</span> FilesEnumberable))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Only add if we have actual files, we can end up with none due to config overriding</span></span><br><span class="line">      PakRules.Filter = <span class="keyword">new</span> FileFilter();</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> FileFilter <span class="keyword">in</span> FilesEnumberable)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//LogInformation(&quot;Adding to PakFileRules for Section &#123;0&#125; : &#123;1&#125;&quot;, SectionName, FileFilter);</span></span><br><span class="line">        PakRules.Filter.AddRule(FileFilter);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RulesList.Add(PakRules);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RulesList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pak的加密"><a href="#Pak的加密" class="headerlink" title="Pak的加密"></a>Pak的加密</h2><p>UE对PAK的加密默认为AES，但是也可以自定义加密规则。UE加密的代码为：</p>
<figure class="highlight cpp"><figcaption><span>Engine/Source/Runtime/PakFile/Private/IPlatformFilePak.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DecryptData</span><span class="params">(uint8* InData, uint32 InDataSize, FGuid InEncryptionKeyGuid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (FPakPlatformFile::<span class="built_in">GetPakCustomEncryptionDelegate</span>().<span class="built_in">IsBound</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FPakPlatformFile::<span class="built_in">GetPakCustomEncryptionDelegate</span>().<span class="built_in">Execute</span>(InData, InDataSize, InEncryptionKeyGuid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SCOPE_SECONDS_ACCUMULATOR</span>(STAT_PakCache_DecryptTime);</span><br><span class="line">    FAES::FAESKey Key;</span><br><span class="line">    FPakPlatformFile::<span class="built_in">GetPakEncryptionKey</span>(Key, InEncryptionKeyGuid);</span><br><span class="line">    <span class="built_in">check</span>(Key.<span class="built_in">IsValid</span>());</span><br><span class="line">    FAES::<span class="built_in">DecryptData</span>(InData, InDataSize, Key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UE的容器化支持"><a href="#UE的容器化支持" class="headerlink" title="UE的容器化支持"></a>UE的容器化支持</h2><ul>
<li><a target="_blank" rel="noopener" href="https://portal.productboard.com/epicgames/1-unreal-engine-public-roadmap/c/320-ue-container-build-beta">UE Container Build (Beta)</a></li>
<li><a target="_blank" rel="noopener" href="https://unrealcontainers.com/">The most powerful creation engine comes to the cloud.</a></li>
</ul>
<h2 id="引擎的编辑器设置存储路径"><a href="#引擎的编辑器设置存储路径" class="headerlink" title="引擎的编辑器设置存储路径"></a>引擎的编辑器设置存储路径</h2><p>二进制安装版引擎在系统数据目录：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25\Saved\Config\Windows</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210809170302.png"></p>
<p>源码版引擎在引擎目录：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Engine\Saved\Config\Windows</span><br></pre></td></tr></table></figure>

<h2 id="修改UDP的默认多播端口"><a href="#修改UDP的默认多播端口" class="headerlink" title="修改UDP的默认多播端口"></a>修改UDP的默认多播端口</h2><p>引擎默认是6666，可以在<code>Project Settings</code>-<code>Plugins</code>-<code>Networking</code>中修改：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210729192239.png"></p>
<p>启动UnrealMultiUserServer即可使用变动后的端口：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210729192422.png"></p>
<h2 id="Cook错误Ensure-condition-failed-GetSuperClass"><a href="#Cook错误Ensure-condition-failed-GetSuperClass" class="headerlink" title="Cook错误Ensure condition failed: GetSuperClass()"></a>Cook错误Ensure condition failed: GetSuperClass()</h2><p>这个错误可能是蓝图循环引用导致的，把循环引用的资源去掉即可。</p>
<p>相关链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/604591/view.html">Packaging Error (Ensure condition failed: GetSuperClass()</a></li>
</ul>
<h2 id="PakCache的加载"><a href="#PakCache的加载" class="headerlink" title="PakCache的加载"></a>PakCache的加载</h2><p>在<code>FPakPlatformFile</code>的<code>OpenAsyncRead</code>中，当启用了<code>GPakCache_Enable</code>，就会创建出一个<code>FPakAsyncReadFileHandle</code>的实例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IAsyncReadFileHandle* <span class="title">FPakPlatformFile::OpenAsyncRead</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">CSV_SCOPED_TIMING_STAT</span>(FileIO, PakOpenAsyncRead);</span><br><span class="line"><span class="comment">//  check(GConfig);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_PAK_PRECACHE</span></span><br><span class="line">  <span class="keyword">if</span> (FPlatformProcess::<span class="built_in">SupportsMultithreading</span>() &amp;&amp; GPakCache_Enable &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    FPakEntry FileEntry;</span><br><span class="line">    FPakFile* PakFile = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">bool</span> bFoundEntry = <span class="built_in">FindFileInPakFiles</span>(Filename, &amp;PakFile, &amp;FileEntry);</span><br><span class="line">    <span class="keyword">if</span> (bFoundEntry &amp;&amp; PakFile &amp;&amp; PakFile-&gt;<span class="built_in">GetFilenameName</span>() != NAME_None)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PAK_TRACKER</span></span><br><span class="line">      <span class="built_in">TrackPak</span>(Filename, &amp;FileEntry);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FPakAsyncReadFileHandle</span>(&amp;FileEntry, PakFile, Filename);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_BYPASS_PAK_PRECACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    FPakEntry FileEntry;</span><br><span class="line">    FPakFile* PakFile = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">bool</span> bFoundEntry = <span class="built_in">FindFileInPakFiles</span>(Filename, &amp;PakFile, &amp;FileEntry);</span><br><span class="line">    <span class="keyword">if</span> (bFoundEntry &amp;&amp; PakFile &amp;&amp; PakFile-&gt;<span class="built_in">GetFilenameName</span>() != NAME_None &amp;&amp; FileEntry.CompressionMethodIndex == <span class="number">0</span> &amp;&amp; !FileEntry.<span class="built_in">IsEncrypted</span>())</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PAK_TRACKER</span></span><br><span class="line">      <span class="built_in">TrackPak</span>(Filename, &amp;FileEntry);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FBypassPakAsyncReadFileHandle</span>(&amp;FileEntry, PakFile, Filename);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> IPlatformFile::<span class="built_in">OpenAsyncRead</span>(Filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏内包裹的就是PakCache处理的代码：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210722210800.png"></p>
<h2 id="UnreakPak解压指定文件"><a href="#UnreakPak解压指定文件" class="headerlink" title="UnreakPak解压指定文件"></a>UnreakPak解压指定文件</h2><blockquote>
<p>注意：<code>-Filter</code>的路径是相对于当前Pak的MountPoint的。</p>
</blockquote>
<p>如，一个Pak的MountPoint为<code>../../../CompressionLab/Content</code>，则<code>Filter</code>的路径就要相对于它，不能在相对于<code>../../../</code>这种顶级路径，不然会解压失败。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UnrealPak.exe -extract ComprtssionLab-WindowsNoEditor.pak D:\Paks -Filter=<span class="string">&quot;Engine/Content/EngineMaterials/WorldGridMaterial.*&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="替换PakFile的实现"><a href="#替换PakFile的实现" class="headerlink" title="替换PakFile的实现"></a>替换PakFile的实现</h2><p>为了实现基于二进制Diff的方案，需要替换掉引擎中默认的<code>PakFile</code>加载实现，需要修改引擎代码：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210720154714.png"></p>
<p>在工程/插件里实现一个同名的Module即可。</p>
<h2 id="从Pak加载uasset的调用栈"><a href="#从Pak加载uasset的调用栈" class="headerlink" title="从Pak加载uasset的调用栈"></a>从Pak加载uasset的调用栈</h2><p>uasset是异步加载的：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210719155941.png"></p>
<h2 id="HDiff-二进制Patch"><a href="#HDiff-二进制Patch" class="headerlink" title="HDiff 二进制Patch"></a>HDiff 二进制Patch</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/sisong/HDiffPatch">HDiffPatch</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Diff</span></span><br><span class="line">hdiffz.exe OldFile NewFile OutPatchFile</span><br><span class="line"><span class="comment"># patch</span></span><br><span class="line">hpatchz.exe OldFile PatchFile OutNewFile</span><br></pre></td></tr></table></figure>

<h2 id="给资源添加右键菜单处理选项"><a href="#给资源添加右键菜单处理选项" class="headerlink" title="给资源添加右键菜单处理选项"></a>给资源添加右键菜单处理选项</h2><p>有些需求，需要在UE的<code>Content Browser</code>里给某些资源添加一些处理功能，希望能直接选中右键进行处理。</p>
<p>UE中提供了这样的方式，用于扩展某种类型资源的右键菜单，需要继承自<code>FAssetTypeActions_Base</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/StaticMesh.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Toolkits/IToolkitHost.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AssetTypeActions_Base.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/PrimaryAssetLabel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FToolMenuSection</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FMenuBuilder</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FAssetTypeActions_PrimaryAssetLabel</span> :</span> <span class="keyword">public</span> FAssetTypeActions_Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// IAssetTypeActions Implementation</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FText <span class="title">GetName</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions&quot;</span>, <span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;Primary Asset Label&quot;</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FColor <span class="title">GetTypeColor</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">FColor</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> UClass* <span class="title">GetSupportedClass</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> UPrimaryAssetLabel::<span class="built_in">StaticClass</span>(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HasActions</span><span class="params">( <span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects )</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetActions</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects, FToolMenuSection&amp; Section)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="comment">// virtual void OpenAssetEditor( const TArray&lt;UObject*&gt;&amp; InObjects, TSharedPtr&lt;class IToolkitHost&gt; EditWithinLevelEditor = TSharedPtr&lt;IToolkitHost&gt;() ) override;</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetCategories</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> EAssetTypeCategories::Basic; &#125;</span><br><span class="line">  <span class="comment">// virtual class UThumbnailInfo* GetThumbnailInfo(UObject* Asset) const override;</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsImportedAsset</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="comment">// virtual void GetResolvedSourceFilePaths(const TArray&lt;UObject*&gt;&amp; TypeAssets, TArray&lt;FString&gt;&amp; OutSourceFilePaths) const override;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中最关键的是重写<code>GetSupportedClass</code>返回想要添加到哪种资源的右键菜单里。</p>
<figure class="highlight cpp"><figcaption><span>.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FAssetTypeActions_PrimaryAssetLabel::GetActions</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;&amp; InObjects,</span></span></span><br><span class="line"><span class="function"><span class="params">  FToolMenuSection&amp; Section)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> Labels = GetTypedWeakObjectPtrs&lt;UPrimaryAssetLabel&gt;(InObjects);</span><br><span class="line">  Section.<span class="built_in">AddMenuEntry</span>(</span><br><span class="line">  <span class="string">&quot;ObjectContext_AddToPatchIncludeFilters&quot;</span>,</span><br><span class="line">  <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToPatchIncludeFilters&quot;</span>, <span class="string">&quot;Add To Patch Include Filters&quot;</span>),</span><br><span class="line">  <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToPatchIncludeFiltersTooltip&quot;</span>, <span class="string">&quot;Add the label to HotPatcher Include Filters.&quot;</span>),</span><br><span class="line">  <span class="built_in">FSlateIcon</span>(),</span><br><span class="line">  <span class="built_in">FUIAction</span>(</span><br><span class="line">    FExecuteAction::<span class="built_in">CreateSP</span>(<span class="keyword">this</span>, &amp;FAssetTypeActions_PrimaryAssetLabel::ExecuteAddToPatchIncludeFilter, Labels)</span><br><span class="line">  ));</span><br><span class="line">  Section.<span class="built_in">AddMenuEntry</span>(</span><br><span class="line">      <span class="string">&quot;ObjectContext_AddToChunkConfig&quot;</span>,</span><br><span class="line">      <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToChunkConfig&quot;</span>, <span class="string">&quot;Add To Chunk Config&quot;</span>),</span><br><span class="line">      <span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;AssetTypeActions_PrimaryAssetLabel&quot;</span>, <span class="string">&quot;ObjectContext_AddToChunkConfigTooltip&quot;</span>, <span class="string">&quot;Add Label To Chunk Config&quot;</span>),</span><br><span class="line">      <span class="built_in">FSlateIcon</span>(),</span><br><span class="line">      <span class="built_in">FUIAction</span>(</span><br><span class="line">        FExecuteAction::<span class="built_in">CreateSP</span>(<span class="keyword">this</span>, &amp;FAssetTypeActions_PrimaryAssetLabel::ExecuteAddToChunkConfig, Labels)</span><br><span class="line">      ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在绑定的事件里可以处理对资源的操作流程。</p>
<p>最后，需要把所写的这个类注册到<code>AssetTools</code>里，可以写到Module的<code>StartupModule</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FAssetToolsModule::<span class="built_in">GetModule</span>().<span class="built_in">Get</span>().<span class="built_in">RegisterAssetTypeActions</span>(<span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FAssetTypeActions_PrimaryAssetLabel));</span><br></pre></td></tr></table></figure>
<p>效果：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210715172415.png"></p>
<h2 id="PSO-Cache"><a href="#PSO-Cache" class="headerlink" title="PSO Cache"></a>PSO Cache</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210712190429.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/OpenGLDrv/Private/OpenGLShaders.cpp#L2675">Runtime/OpenGLDrv/Private/OpenGLShaders.cpp#L2675</a></p>
<h2 id="C-获取引擎版本"><a href="#C-获取引擎版本" class="headerlink" title="C++获取引擎版本"></a>C++获取引擎版本</h2><p>有版本宏定义：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Resources/Version.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// newer than a 4.11.* version, regardless of the changelist that it was built with)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_MAJOR_VERSION  4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_MINOR_VERSION  26</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENGINE_PATCH_VERSION  2</span></span><br></pre></td></tr></table></figure>
<h2 id="diff-uasset"><a href="#diff-uasset" class="headerlink" title="diff uasset"></a>diff uasset</h2><p>很久之前我写过一篇在UE中开启版本控制，并Diff资源的操作文章：<a href="https://imzlp.com/posts/7647/">在UE中使用Git进行版本控制</a></p>
<p>简单分析一下实现的代码，版本控制右键调用的函数：</p>
<figure class="highlight cpp"><figcaption><span>Editor/SourceControlWindows/Private/SSourceControlSubmit.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SSourceControlSubmitWidget::OnDiffAgainstDepotSelected</span><span class="params">(TSharedPtr&lt;FSubmitItem&gt; InSelectedItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString PackageName;</span><br><span class="line">  <span class="keyword">if</span> (FPackageName::<span class="built_in">TryConvertFilenameToLongPackageName</span>(InSelectedItem-&gt;<span class="built_in">GetFileName</span>().<span class="built_in">ToString</span>(), PackageName))</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FAssetData&gt; Assets;</span><br><span class="line">    FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">    AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetAssetsByPackageName</span>(*PackageName, Assets);</span><br><span class="line">    <span class="keyword">if</span> (Assets.<span class="built_in">Num</span>() == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FAssetData&amp; AssetData = Assets[<span class="number">0</span>];</span><br><span class="line">      UObject* CurrentObject = AssetData.<span class="built_in">GetAsset</span>();</span><br><span class="line">      <span class="keyword">if</span> (CurrentObject)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> FString AssetName = AssetData.AssetName.<span class="built_in">ToString</span>();</span><br><span class="line">        FAssetToolsModule&amp; AssetToolsModule = FModuleManager::GetModuleChecked&lt;FAssetToolsModule&gt;(<span class="string">&quot;AssetTools&quot;</span>);</span><br><span class="line">        AssetToolsModule.<span class="built_in">Get</span>().<span class="built_in">DiffAgainstDepot</span>(CurrentObject, PackageName, AssetName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的是<code>AssetTools</code>中的<code>DiffAgainstDepot</code>：</p>
<figure class="highlight cpp"><figcaption><span>Developer\AssetTools\Private\AssetTools.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetToolsImpl::DiffAgainstDepot</span><span class="params">( UObject* InObject, <span class="keyword">const</span> FString&amp; InPackagePath, <span class="keyword">const</span> FString&amp; InPackageName )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>( InObject );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure our history is up to date</span></span><br><span class="line">  ISourceControlProvider&amp; SourceControlProvider = ISourceControlModule::<span class="built_in">Get</span>().<span class="built_in">GetProvider</span>();</span><br><span class="line">  TSharedRef&lt;FUpdateStatus, ESPMode::ThreadSafe&gt; UpdateStatusOperation = ISourceControlOperation::Create&lt;FUpdateStatus&gt;();</span><br><span class="line">  UpdateStatusOperation-&gt;<span class="built_in">SetUpdateHistory</span>(<span class="literal">true</span>);</span><br><span class="line">  SourceControlProvider.<span class="built_in">Execute</span>(UpdateStatusOperation, SourceControlHelpers::<span class="built_in">PackageFilename</span>(InPackagePath));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the SCC state</span></span><br><span class="line">  FSourceControlStatePtr SourceControlState = SourceControlProvider.<span class="built_in">GetState</span>(SourceControlHelpers::<span class="built_in">PackageFilename</span>(InPackagePath), EStateCacheUsage::Use);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have an asset and its in SCC..</span></span><br><span class="line">  <span class="keyword">if</span>( SourceControlState.<span class="built_in">IsValid</span>() &amp;&amp; InObject != <span class="literal">nullptr</span> &amp;&amp; SourceControlState-&gt;<span class="built_in">IsSourceControlled</span>() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Get the file name of package</span></span><br><span class="line">    FString RelativeFileName;</span><br><span class="line">    <span class="keyword">if</span>(FPackageName::<span class="built_in">DoesPackageExist</span>(InPackagePath, <span class="literal">nullptr</span>, &amp;RelativeFileName))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(SourceControlState-&gt;<span class="built_in">GetHistorySize</span>() &gt; <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        TSharedPtr&lt;ISourceControlRevision, ESPMode::ThreadSafe&gt; Revision = SourceControlState-&gt;<span class="built_in">GetHistoryItem</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">check</span>(Revision.<span class="built_in">IsValid</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the head revision of this package from source control</span></span><br><span class="line">        FString AbsoluteFileName = FPaths::<span class="built_in">ConvertRelativePathToFull</span>(RelativeFileName);</span><br><span class="line">        FString TempFileName;</span><br><span class="line">        <span class="keyword">if</span>(Revision-&gt;<span class="built_in">Get</span>(TempFileName))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// Try and load that package</span></span><br><span class="line">          UPackage* TempPackage = <span class="built_in">LoadPackage</span>(<span class="literal">nullptr</span>, *TempFileName, LOAD_ForDiff|LOAD_DisableCompileOnLoad);</span><br><span class="line">          <span class="keyword">if</span>(TempPackage != <span class="literal">nullptr</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// Grab the old asset from that old package</span></span><br><span class="line">            UObject* OldObject = FindObject&lt;UObject&gt;(TempPackage, *InPackageName);</span><br><span class="line">            <span class="keyword">if</span>(OldObject != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* Set the revision information*/</span></span><br><span class="line">              FRevisionInfo OldRevision;</span><br><span class="line">              OldRevision.Changelist = Revision-&gt;<span class="built_in">GetCheckInIdentifier</span>();</span><br><span class="line">              OldRevision.Date = Revision-&gt;<span class="built_in">GetDate</span>();</span><br><span class="line">              OldRevision.Revision = Revision-&gt;<span class="built_in">GetRevision</span>();</span><br><span class="line"></span><br><span class="line">              FRevisionInfo NewRevision; </span><br><span class="line">              NewRevision.Revision = <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">              <span class="built_in">DiffAssets</span>(OldObject, InObject, OldRevision, NewRevision);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑器中的资源作为新版本，就本本资源从版本库中加载并创建一个临时包，然后进行比对。</p>
<h2 id="Cook图集"><a href="#Cook图集" class="headerlink" title="Cook图集"></a>Cook图集</h2><p>Cook图集中项的资源：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\CoreUObject\Private\UObject\SavePackage.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Exports got filtered out already if they&#x27;re not for this platform</span></span><br><span class="line"><span class="keyword">if</span> (TagExpObjects.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">UE_CLOG</span>(!(SaveFlags &amp; SAVE_NoError), LogSavePackage, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;No exports found (or all exports are editor-only) for %s. Package will not be saved.&quot;</span>), *BaseFilename);</span><br><span class="line">  <span class="keyword">return</span> ESavePackageResult::ContainsEditorOnlyData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210701201550.png"></p>
<blockquote>
<p>No exports found (or all exports are editor-only) for %s. Package will not be saved</p>
</blockquote>
<h2 id="STAT-GROUP"><a href="#STAT-GROUP" class="headerlink" title="STAT GROUP"></a>STAT GROUP</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="built_in">DECLARE_STATS_GROUP</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;IMZLP&quot;</span>),STATGROUP_IMZLP,STATCAT_Advanced);</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;test func&quot;</span>), STAT_IMZLP_FUNC, STATGROUP_IMZLP);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果出现<code>command not recognised</code>的提示，是因为这个<code>STATGROUP</code>下的<code>CYCLE_COUNTER</code>从来没有被执行过。</p>
<h2 id="离线渲染Sequence命令"><a href="#离线渲染Sequence命令" class="headerlink" title="离线渲染Sequence命令"></a>离线渲染Sequence命令</h2><p>在渲染的时候，虚幻引擎提供了基于命令行的接口，用户在命令行中指定项目的路径、地图、Sequencer，以及渲染参数（例如分辨率、质量等）后，虚幻引擎即可离屏渲染出图像。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/AnimatingObjects/Sequencer/Workflow/RenderAndExport/RenderingCmdLine/">Command Line Arguments for Rendering Movies</a></li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe</span><br><span class="line">DummyProject.uproject</span><br><span class="line">/Game/NewMap</span><br><span class="line">-game</span><br><span class="line">-MovieSceneCaptureType=&quot;/Script/MovieSceneCapture.AutomatedLevelSequenceCapture&quot;</span><br><span class="line">-LevelSequence=&quot;/Game/NewLevelSequence&quot;</span><br><span class="line">-MovieFrameRate=30 -noloadingscreen</span><br><span class="line">-resx=1920 -resy=1080 -forceres</span><br><span class="line">-MovieFormat=PNG -MovieQuality=100</span><br><span class="line">-notexturestreaming -MovieCinematicMode=yes</span><br><span class="line">-MovieWarmUpFrames=60 -opengl</span><br></pre></td></tr></table></figure>
<p>输出图像之后，可以使用ffmpeg进行合成，之前有一篇采集的文章：<a href="https://imzlp.com/posts/64044/">使用 Unreal Engine 4 采集 360° 全景视频</a></p>
<h2 id="FDebugText"><a href="#FDebugText" class="headerlink" title="FDebugText"></a>FDebugText</h2><p>有些需求是在场景中打印不根据透视变化的调试信息，如RecastNavMesh的预览TileLabel：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210628160606.png"></p>
<figure class="highlight cpp"><figcaption><span>Runtime\NavigationSystem\Private\NavMesh\NavMeshRenderingComponent.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bGatherTileLabels)</span><br><span class="line">&#123;</span><br><span class="line">  DebugLabels.<span class="built_in">Add</span>(<span class="built_in">FDebugText</span>(NavLocation.Location + NavMeshDrawOffset, FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;(%d,%d:%d)&quot;</span>), X, Y, Layer)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在以下代码中使用：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\NavigationSystem\Private\NavMesh\NavMeshRenderingComponent.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_RECAST &amp;&amp; !UE_BUILD_SHIPPING &amp;&amp; !UE_BUILD_TEST</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNavMeshDebugDrawDelegateHelper::RegisterDebugDrawDelgate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">ensureMsgf</span>(State != RegisteredState, <span class="built_in">TEXT</span>(<span class="string">&quot;RegisterDebugDrawDelgate is already Registered!&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (State == InitializedState)</span><br><span class="line">  &#123;</span><br><span class="line">    DebugTextDrawingDelegate = FDebugDrawDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FNavMeshDebugDrawDelegateHelper::DrawDebugLabels);</span><br><span class="line">    DebugTextDrawingDelegateHandle = UDebugDrawService::<span class="built_in">Register</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Navigation&quot;</span>), DebugTextDrawingDelegate);</span><br><span class="line">    State = RegisteredState;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNavMeshDebugDrawDelegateHelper::UnregisterDebugDrawDelgate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">ensureMsgf</span>(State != InitializedState, <span class="built_in">TEXT</span>(<span class="string">&quot;UnegisterDebugDrawDelgate is in an invalid State: %i !&quot;</span>), State);</span><br><span class="line">  <span class="keyword">if</span> (State == RegisteredState)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">check</span>(DebugTextDrawingDelegate.<span class="built_in">IsBound</span>());</span><br><span class="line">    UDebugDrawService::<span class="built_in">Unregister</span>(DebugTextDrawingDelegateHandle);</span><br><span class="line">    State = InitializedState;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_RECAST &amp;&amp; !UE_BUILD_SHIPPING &amp;&amp; !UE_BUILD_TEST</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNavMeshDebugDrawDelegateHelper::DrawDebugLabels</span><span class="params">(UCanvas* Canvas, APlayerController*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!Canvas)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bVisible = (Canvas-&gt;SceneView &amp;&amp; !!Canvas-&gt;SceneView-&gt;Family-&gt;EngineShowFlags.Navigation) || bForceRendering;</span><br><span class="line">  <span class="keyword">if</span> (!bVisible || bNeedsNewData || DebugLabels.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> FColor OldDrawColor = Canvas-&gt;DrawColor;</span><br><span class="line">  Canvas-&gt;<span class="built_in">SetDrawColor</span>(FColor::White);</span><br><span class="line">  <span class="keyword">const</span> FSceneView* View = Canvas-&gt;SceneView;</span><br><span class="line">  UFont* Font = GEngine-&gt;<span class="built_in">GetSmallFont</span>();</span><br><span class="line">  <span class="keyword">const</span> FNavMeshSceneProxyData::FDebugText* DebugText = DebugLabels.<span class="built_in">GetData</span>();</span><br><span class="line">  <span class="keyword">for</span> (int32 Idx = <span class="number">0</span>; Idx &lt; DebugLabels.<span class="built_in">Num</span>(); ++Idx, ++DebugText)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (View-&gt;ViewFrustum.<span class="built_in">IntersectSphere</span>(DebugText-&gt;Location, <span class="number">1.0f</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FVector ScreenLoc = Canvas-&gt;<span class="built_in">Project</span>(DebugText-&gt;Location);</span><br><span class="line">      Canvas-&gt;<span class="built_in">DrawText</span>(Font, DebugText-&gt;Text, ScreenLoc.X, ScreenLoc.Y);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Canvas-&gt;<span class="built_in">SetDrawColor</span>(OldDrawColor);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Game-Map-Map-PersistentLevel-None"><a href="#Game-Map-Map-PersistentLevel-None" class="headerlink" title="/Game/Map.Map:PersistentLevel.None"></a>/Game/Map.Map:PersistentLevel.None</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2021.06.26-09.08.17:941][518]LogGarbage: Warning: Spent more than 30.00s on routing FinishDestroy to objects (objects in queue: 2)</span><br><span class="line">[2021.06.26-09.08.17:941][518]LogGarbage: Warning:   [0]: SphereComponent &#x2F;Game&#x2F;Map.Map:PersistentLevel.None.None, IsReadyForFinishDestroy: false</span><br><span class="line">[2021.06.26-09.08.17:941][518]LogGarbage: Warning:   [1]: SpectatorPawn &#x2F;Game&#x2F;Map.Map:PersistentLevel.None, IsReadyForFinishDestroy: false</span><br><span class="line">[2021.06.26-09.08.17:941][518]LogGarbage: Warning: Spent to much time waiting for FinishDestroy for 2 object(s) (last object: SpectatorPawn &#x2F;Game&#x2F;Map.Map:PersistentLevel.None), check log for details</span><br><span class="line">[2021.06.26-09.08.17:941][518]LogObj: Warning: UObject::AbortInsideMemberFunction called on object SpectatorPawn &#x2F;Game&#x2F;Map.Map:PersistentLevel.None.</span><br></pre></td></tr></table></figure>
<p>出现这个报错是因为场景里有选择一个无效的场景对象：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210626221123.png"></p>
<p>这种形式的路径引用是选择场景中的对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Game&#x2F;Maps&#x2F;VFXLight.VFXLight:PersistentLevel.DirectionalLight_1</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210626220907.png"></p>
<p>如果有引用，但是场景中的对象没了，<code>PersistentLevel.DirectionalLight_1</code>这就是一个引用错误，可能会导致Crash。</p>
<h2 id="监听Actor创建事件"><a href="#监听Actor创建事件" class="headerlink" title="监听Actor创建事件"></a>监听Actor创建事件</h2><p>可以通过监听<code>UWorld</code>的<code>OnActorSpawned</code>实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UWorld* MyWorld = <span class="built_in">GetWorld</span>();</span><br><span class="line">FOnActorSpawned::FDelegate ActorSpawnedDelegate = FOnActorSpawned::FDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FWaitForLoadingToFinish::OnActorSpawned);</span><br><span class="line">FDelegateHandle ActorSpawnedDelegateHandle = MyWorld-&gt;<span class="built_in">AddOnActorSpawnedHandler</span>(ActorSpawnedDelegate)</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/Engine/Classes/Engine/World.h#L2433">Runtime/Engine/Classes/Engine/World.h#L2433</a></li>
<li>Example：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Developer/FunctionalTesting/Private/AutomationBlueprintFunctionLibrary.cpp#L1030">Developer/FunctionalTesting/Private/AutomationBlueprintFunctionLibrary.cpp#L1030</a></li>
</ul>
<h2 id="UE4-25字符转换bug"><a href="#UE4-25字符转换bug" class="headerlink" title="UE4.25字符转换bug"></a>UE4.25字符转换bug</h2><blockquote>
<p>在4.26+中已修复。</p>
</blockquote>
<p>Mac用的是2字节的宽字符，但却按4字节的去转，当材质里参数有中文时，就会出现不一致的bug：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Serialization/MemoryImage.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">FHashedName::<span class="built_in">FHashedName</span>(<span class="keyword">const</span> FName&amp; InName)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!InName.<span class="built_in">IsNone</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> FNameEntry* Entry = InName.<span class="built_in">GetComparisonNameEntry</span>();</span><br><span class="line">    <span class="keyword">const</span> int32 InternalNumber = InName.<span class="built_in">GetNumber</span>();</span><br><span class="line">    <span class="keyword">if</span> (Entry-&gt;<span class="built_in">IsWide</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      WIDECHAR WideNameBuffer[NAME_SIZE];</span><br><span class="line">      Entry-&gt;<span class="built_in">GetWideName</span>(WideNameBuffer);</span><br><span class="line">      <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Entry-&gt;<span class="built_in">GetNameLength</span>(); ++i)</span><br><span class="line">      &#123;</span><br><span class="line">        WideNameBuffer[i] = FCharWide::<span class="built_in">ToUpper</span>(WideNameBuffer[i]);</span><br><span class="line">      &#125;</span><br><span class="line">            <span class="comment">// Bug</span></span><br><span class="line">            <span class="comment">// const FTCHARToUTF8 NameUTF8(WCHAR_TO_TCHAR(WideNameBuffer));</span></span><br><span class="line">      <span class="comment">// Hash = CityHash64WithSeed(NameUTF8.Get(), NameUTF8.Length(), InternalNumber);</span></span><br><span class="line">          </span><br><span class="line">      <span class="comment">// WChar conversion bug in Mac</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in"><span class="keyword">sizeof</span></span>(WIDECHAR) != <span class="built_in"><span class="keyword">sizeof</span></span>(TCHAR))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> FTCHARToUTF8 <span class="title">NameUTF8</span><span class="params">(WCHAR_TO_TCHAR(WideNameBuffer))</span></span>;</span><br><span class="line">        Hash = <span class="built_in">CityHash64WithSeed</span>(NameUTF8.<span class="built_in">Get</span>(), NameUTF8.<span class="built_in">Length</span>(), InternalNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> FTCHARToUTF8 <span class="built_in">NameUTF8</span>((TCHAR*)WideNameBuffer);</span><br><span class="line">        Hash = <span class="built_in">CityHash64WithSeed</span>(NameUTF8.<span class="built_in">Get</span>(), NameUTF8.<span class="built_in">Length</span>(), InternalNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ANSICHAR AnsiNameBuffer[NAME_SIZE];</span><br><span class="line">      Entry-&gt;<span class="built_in">GetAnsiName</span>(AnsiNameBuffer);</span><br><span class="line">      <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Entry-&gt;<span class="built_in">GetNameLength</span>(); ++i)</span><br><span class="line">      &#123;</span><br><span class="line">        AnsiNameBuffer[i] = FCharAnsi::<span class="built_in">ToUpper</span>(AnsiNameBuffer[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      Hash = <span class="built_in">CityHash64WithSeed</span>(AnsiNameBuffer, Entry-&gt;<span class="built_in">GetNameLength</span>(), InternalNumber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Hash = <span class="number">0u</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开启ADDRESS-SANITIZER"><a href="#开启ADDRESS-SANITIZER" class="headerlink" title="开启ADDRESS SANITIZER"></a>开启ADDRESS SANITIZER</h2><ul>
<li><a target="_blank" rel="noopener" href="https://ue4daily.com/blog/ios-address-sanitizer-UE4">iOS Address Sanitizer in UE4</a><br>在Target.cs中开启：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment.SetEnvironmentVariable(<span class="string">&quot;ENABLE_ADDRESS_SANITIZER&quot;</span>, <span class="string">&quot;YES&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="监听Cook完成事件"><a href="#监听Cook完成事件" class="headerlink" title="监听Cook完成事件"></a>监听Cook完成事件</h2><p>有些操作需要等待Cook的任务完成，可以通过监听<code>UPackage::PackageSavedEvent</code>实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPackage::PackageSavedEvent.<span class="built_in">AddRaw</span>(<span class="keyword">this</span>,&amp;FCookManager::OnPackageSavedEvent);</span><br></pre></td></tr></table></figure>
<p>使用<code>GEditor-&gt;Save</code>进行Cook时即可在回调中监听：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GIsCookerLoadingPackage = <span class="literal">true</span>;</span><br><span class="line">UPackage::PackageSavedEvent.<span class="built_in">AddLambda</span>([PackageSavedCallback](<span class="keyword">const</span> FString&amp; InFilePath,UObject* Object)&#123;<span class="built_in">PackageSavedCallback</span>(InFilePath);&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// UE_LOG(LogHotPatcherEditorHelper,Display,TEXT(&quot;Cook Assets:%s save to %s&quot;),*Package-&gt;GetName(),*CookedSavePath);</span></span><br><span class="line">FSavePackageResultStruct Result = GEditor-&gt;<span class="built_in">Save</span>(Package, <span class="literal">nullptr</span>, CookedFlags, *CookedSavePath, </span><br><span class="line">  GError, <span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, SaveFlags, Platform, </span><br><span class="line">  FDateTime::<span class="built_in">MinValue</span>(), <span class="literal">false</span>, <span class="comment">/*DiffMap*/</span> <span class="literal">nullptr</span>,CurrentPlatformPackageContext);</span><br><span class="line">GIsCookerLoadingPackage = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h2 id="地图的最大尺寸"><a href="#地图的最大尺寸" class="headerlink" title="地图的最大尺寸"></a>地图的最大尺寸</h2><p>UE中支持的最大World尺寸通过<code>WORLD_MAX</code>宏定义：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/Engine/Public/EngineDefines.h#L27">Runtime/Engine/Public/EngineDefines.h#L27</a></p>
<figure class="highlight cpp"><figcaption><span>Source/Runtime/Engine/Public/EngineDefines.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">  Size of the world.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORLD_MAX         2097152.0       <span class="comment">/* Maximum size of the world */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HALF_WORLD_MAX        (WORLD_MAX * 0.5)   <span class="comment">/* Half the maximum size of the world */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HALF_WORLD_MAX1       (HALF_WORLD_MAX - 1.0)  <span class="comment">/* Half the maximum size of the world minus one */</span></span></span><br></pre></td></tr></table></figure>
<p>超出范围Actor就被销毁了：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/Engine/Private/Components/InterpToMovementComponent.cpp#L394">Runtime/Engine/Private/Components/InterpToMovementComponent.cpp#L394</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UInterpToMovementComponent::CheckStillInWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">  <span class="comment">// Check if box has poked outside the world</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (UpdatedComponent &amp;&amp; UpdatedComponent-&gt;<span class="built_in">IsRegistered</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> FBox&amp; Box = UpdatedComponent-&gt;Bounds.<span class="built_in">GetBox</span>();</span><br><span class="line">    <span class="keyword">if</span> (Box.Min.X &lt; -HALF_WORLD_MAX || Box.Max.X &gt; HALF_WORLD_MAX ||</span><br><span class="line">      Box.Min.Y &lt; -HALF_WORLD_MAX || Box.Max.Y &gt; HALF_WORLD_MAX ||</span><br><span class="line">      Box.Min.Z &lt; -HALF_WORLD_MAX || Box.Max.Z &gt; HALF_WORLD_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogInterpToMovementComponent, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;%s is outside the world bounds!&quot;</span>), *ActorOwner-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">      ActorOwner-&gt;<span class="built_in">OutsideWorldBounds</span>();</span><br><span class="line">      <span class="comment">// not safe to use physics or collision at this point</span></span><br><span class="line">      ActorOwner-&gt;<span class="built_in">SetActorEnableCollision</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="function">FHitResult <span class="title">Hit</span><span class="params">(<span class="number">1.f</span>)</span></span>;</span><br><span class="line">      <span class="built_in">StopSimulating</span>(Hit);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UProperty到FProperty的优化"><a href="#UProperty到FProperty的优化" class="headerlink" title="UProperty到FProperty的优化"></a>UProperty到FProperty的优化</h2><p>从4.25开始UProperty正式修改为了FProperty，避免了额外的UProperty的消耗。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/WhatsNew/Builds/ReleaseNotes/4_25/"><br>Unreal Engine 4.25 Release Notes</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=tqzJSVrnqgY&ab_channel=UnrealEngineJP">なぜなにFProperty - 対応方法と改善点 -</a></li>
</ul>
<p>官方介绍：</p>
<ul>
<li>Loading performance, especially when loading a large number Blueprints</li>
<li>Garbage collection performance, especially when a project has a large number of Blueprints</li>
<li>Memory savings, tests in Fortnite show a memory savings of over 30 megabytes.</li>
<li>Performance improvements include:<ul>
<li>UObject iteration (there are fewer objects to check)</li>
<li>FProperty casts are three times as fast as UObject casts.</li>
<li>FProperty iteration is almost twice as fast as UProperty iteration.</li>
</ul>
</li>
</ul>
<h2 id="从Target获取编译器版本"><a href="#从Target获取编译器版本" class="headerlink" title="从Target获取编译器版本"></a>从Target获取编译器版本</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckCompilerVersion</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">string</span> Version, WindowsCompiler Compiler, <span class="built_in">string</span> LongVersionName, <span class="built_in">string</span> ShortVersionName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Compiler == (WindowsCompiler)Enum.Parse(<span class="keyword">typeof</span>(WindowsCompiler), LongVersionName))</span><br><span class="line">    Version = ShortVersionName;</span><br><span class="line">  &#125;</span><br><span class="line">  catch&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetVisualStudioVersion</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">string</span> VSVersion = <span class="string">&quot;vc150&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> Compiler = Target.WindowsPlatform.Compiler;</span><br><span class="line">  CheckCompilerVersion(<span class="keyword">ref</span> VSVersion, Compiler, <span class="string">&quot;VisualStudio2019&quot;</span>, <span class="string">&quot;vc160&quot;</span>);</span><br><span class="line">  CheckCompilerVersion(<span class="keyword">ref</span> VSVersion, Compiler, <span class="string">&quot;VisualStudio2017&quot;</span>, <span class="string">&quot;vc150&quot;</span>);</span><br><span class="line">  CheckCompilerVersion(<span class="keyword">ref</span> VSVersion, Compiler, <span class="string">&quot;VisualStudio2015&quot;</span>, <span class="string">&quot;vc140&quot;</span>);</span><br><span class="line">  CheckCompilerVersion(<span class="keyword">ref</span> VSVersion, Compiler, <span class="string">&quot;VisualStudio2013&quot;</span>, <span class="string">&quot;vc120&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> VSVersion;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Insight-Profile-Tag-in-UnLua"><a href="#Insight-Profile-Tag-in-UnLua" class="headerlink" title="Insight Profile Tag in UnLua"></a>Insight Profile Tag in UnLua</h2><p>可以把<code>SCOPED_NAMED_EVENT</code>封装到Lua端，但是因为Lua没有C++的RAII机制，无法实时地检测离开作用域时机，所以只能通过在起始和结尾位置添加标记：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TimerMgr:UpdateTimer</span><span class="params">(DeltaTime)</span></span></span><br><span class="line">    UE4.FScopedNamedEventWrapper.StaticBegin(<span class="string">&quot;TimerMgr_UpdateTimer&quot;</span>)</span><br><span class="line">    <span class="comment">-- dosomething...</span></span><br><span class="line">    UE4.FScopedNamedEventWrapper.StaticEnd()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在C++端的实现：</p>
<figure class="highlight cpp"><figcaption><span>ScopedNamedEventWrapper.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ScopedNamedEventWrapper.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FScopedNamedEventWrapper</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticBegin</span><span class="params">(<span class="keyword">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IMPLEMENTS_BeginNamedEventStatic</span></span><br><span class="line">        FPlatformMisc::<span class="built_in">BeginNamedEventStatic</span>(FColor::Yellow, *Name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FPlatformMisc::<span class="built_in">BeginNamedEvent</span>(FColor::Yellow, *Name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticEnd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        FPlatformMisc::<span class="built_in">EndNamedEvent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> bInit = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>暴露给Lua端：</p>
<figure class="highlight cpp"><figcaption><span>Lualib_ScopedNamedEventWrapper.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UnLuaEx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LuaCore.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ScopedNamedEventWrapper.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_REFLECTED_CLASS</span>(FScopedNamedEventWrapper)</span><br><span class="line">    <span class="built_in">ADD_STATIC_FUNCTION_EX</span>(<span class="string">&quot;StaticBegin&quot;</span>,<span class="keyword">void</span>,StaticBegin,<span class="keyword">const</span> FString&amp;)</span><br><span class="line">    <span class="built_in">ADD_STATIC_FUNCTION_EX</span>(<span class="string">&quot;StaticEnd&quot;</span>,<span class="keyword">void</span>,StaticEnd)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(FScopedNamedEventWrapper)</span><br></pre></td></tr></table></figure>
<p>然后即可在Lua中使用，并且能够在Unreal Insight中查看Lua端代码执行的消耗：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210622110706.png"></p>
<h2 id="Insight-Profiler-Tag"><a href="#Insight-Profiler-Tag" class="headerlink" title="Insight Profiler Tag"></a>Insight Profiler Tag</h2><p>用加标记的形式可以在Unreal Insight或者FrontEnd中对某个作用域进行profiling：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">SCOPED_NAMED_EVENT</span>(ULuaMgr_Tick, FColor::Yellow);  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210621131324.png"></p>
<p><code>SCOPED_NAMED_EVENT</code>宏其实是在栈上了一个对象。利用C++的RAII机制，当离开作用域时被销毁，从而统计出时间：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\HAL\PlatformMisc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_NAMED_EVENT(Name, Color) \</span></span><br><span class="line">  <span class="function">FScopedNamedEventStatic <span class="title">ANONYMOUS_VARIABLE</span><span class="params">(NamedEvent_##Name##_)</span><span class="params">(Color, NAMED_EVENT_STR(#Name))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_NAMED_EVENT_FSTRING(Text, Color)  FScopedNamedEvent       ANONYMOUS_VARIABLE(NamedEvent_)         (Color, *Text);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_NAMED_EVENT_TCHAR(Text, Color)    FScopedNamedEvent       ANONYMOUS_VARIABLE(NamedEvent_)         (Color, Text);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_NAMED_EVENT_TEXT(Text, Color) \</span></span><br><span class="line">  <span class="function">FScopedNamedEventStatic <span class="title">ANONYMOUS_VARIABLE</span><span class="params">(NamedEvent_)</span>         <span class="params">(Color, NAMED_EVENT_STR(Text))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_NAMED_EVENT_F(Format, Color, ...) FScopedNamedEvent       ANONYMOUS_VARIABLE(NamedEvent_)         (Color, *FString::Printf(Format, __VA_ARGS__));</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCOPED_PROFILER_COLOR(Color)       FScopedProfilerColor    ANONYMOUS_VARIABLE(ProfilerColor_##Name##_)(Color);</span></span><br></pre></td></tr></table></figure>
<p><code>FScopedNamedEventStatic</code>的定义：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\HAL\PlatformMisc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Scoped named event class for constant (compile-time) strings literals.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// BeginNamedEventStatic works the same as BeginNamedEvent, but should only be passed a compile-time string literal.</span></span><br><span class="line"><span class="comment">// Some platform profilers can optimize the case where strings for certain events are constant.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CORE_API</span> <span class="title">FScopedNamedEventStatic</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FScopedNamedEventStatic</span>(<span class="keyword">const</span> struct FColor&amp; Color, <span class="keyword">const</span> TCHAR* Text)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IMPLEMENTS_BeginNamedEventStatic</span></span><br><span class="line">    FPlatformMisc::<span class="built_in">BeginNamedEventStatic</span>(Color, Text);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    FPlatformMisc::<span class="built_in">BeginNamedEvent</span>(Color, Text);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">FScopedNamedEventStatic</span>(<span class="keyword">const</span> struct FColor&amp; Color, <span class="keyword">const</span> ANSICHAR* Text)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IMPLEMENTS_BeginNamedEventStatic</span></span><br><span class="line">    FPlatformMisc::<span class="built_in">BeginNamedEventStatic</span>(Color, Text);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    FPlatformMisc::<span class="built_in">BeginNamedEvent</span>(Color, Text);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">FScopedNamedEventStatic</span>()</span><br><span class="line">  &#123;</span><br><span class="line">    FPlatformMisc::<span class="built_in">EndNamedEvent</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Localization-Error"><a href="#Localization-Error" class="headerlink" title="Localization Error"></a>Localization Error</h2><p>IOS加载出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No paths for game localization data were specifed in the game configuration.</span><br></pre></td></tr></table></figure>
<p>产生错误的代码为：</p>
<figure class="highlight cpp"><figcaption><span>Paths.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> TArray&lt;FString&gt;&amp; <span class="title">FPaths::GetGameLocalizationPaths</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FStaticData&amp; StaticData = TLazySingleton&lt;FStaticData&gt;::<span class="built_in">Get</span>();</span><br><span class="line">  <span class="keyword">if</span>(!StaticData.bGameLocalizationPathsInitialized)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(GConfig &amp;&amp; GConfig-&gt;<span class="built_in">IsReadyForUse</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      GConfig-&gt;<span class="built_in">GetArray</span>( <span class="built_in">TEXT</span>(<span class="string">&quot;Internationalization&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;LocalizationPaths&quot;</span>), StaticData.GameLocalizationPaths, GGameIni );</span><br><span class="line">      <span class="keyword">if</span>(!StaticData.GameLocalizationPaths.<span class="built_in">Num</span>()) <span class="comment">// Failed to find localization path.</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPaths, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;No paths for game localization data were specifed in the game configuration.&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      StaticData.bGameLocalizationPathsInitialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> StaticData.GameLocalizationPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会从GGameIni中读取（<code>BaseGame.ini</code>中已配置）：</p>
<figure class="highlight"><figcaption><span>BaseGame.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Internationalization]</span></span><br><span class="line">+LocalizationPaths=%GAMEDIR%Content/Localization/Game</span><br></pre></td></tr></table></figure>

<h2 id="Install-IPA-0xE8008029-Error"><a href="#Install-IPA-0xE8008029-Error" class="headerlink" title="Install IPA 0xE8008029 Error"></a>Install IPA 0xE8008029 Error</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[DD] Mobile Device &#39;iPhone&#39; connected</span><br><span class="line">Trying to connect to mobile device running iOS ...</span><br><span class="line">Transferring IPA to device &#39;iPhone&#39; ...</span><br><span class="line"> ... Transfer is 10% complete at phase &#39;TransferringPackage&#39;</span><br><span class="line"> ... Transfer is 20% complete at phase &#39;CopyingFile&#39;</span><br><span class="line"> ... Transfer is 30% complete at phase &#39;CopyingFile&#39;</span><br><span class="line"> ... Transfer is 40% complete at phase &#39;CopyingFile&#39;</span><br><span class="line"> ... Transfer is 50% complete at phase &#39;CopyingFile&#39;</span><br><span class="line"> ... Transfer is 60% complete at phase &#39;CopyingFile&#39;</span><br><span class="line"> ... Transfer is 80% complete at phase &#39;CopyingFile&#39;</span><br><span class="line">Installing IPA on device &#39;iPhone&#39; ...</span><br><span class="line"> ... Install is 5% complete at phase &#39;CreatingStagingDirectory&#39;</span><br><span class="line"> ... Install is 20% complete at phase &#39;InspectingPackage&#39;</span><br><span class="line"> ... Install is 40% complete at phase &#39;VerifyingApplication&#39;</span><br><span class="line">Install \ Update of &quot;Blank425.ipa&quot; failed with Unknown error 0xE8008029 in 13.65 seconds</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.27/Engine/Source/Programs/IOS/iPhonePackager/MachObjects.cs#L2099">4.27/Engine/Source/Programs/IOS/iPhonePackager/MachObjects.cs#L2099</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/using-the-latest-code-signature-format">Using the Latest Code Signature Format</a></li>
<li><a target="_blank" rel="noopener" href="https://issues.unrealengine.com/issue/UE-114823">iOS 14.5 - Code Signing Version No Longer Supported</a></li>
</ul>
<p>在UE4.25中，<code>cVersion2</code>的值：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CodeDirectoryBlob</span> : <span class="title">AbstractBlob</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">const</span> UInt32 cVersion2 = <span class="number">0x20200</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取引用的对象"><a href="#获取引用的对象" class="headerlink" title="获取引用的对象"></a>获取引用的对象</h2><p>可以获取UObject引用的对象信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">URamaStaticFunctionLib::GetObjReferenceCount</span><span class="params">(UObject* Obj, TArray&lt;UObject*&gt;* OutReferredToObjects = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!Obj || !Obj-&gt;<span class="built_in">IsValidLowLevelFast</span>()) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  TArray&lt;UObject*&gt; ReferredToObjects;       <span class="comment">//req outer, ignore archetype, recursive, ignore transient</span></span><br><span class="line">  <span class="function">FReferenceFinder <span class="title">ObjectReferenceCollector</span><span class="params">( ReferredToObjects, Obj, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line">  ObjectReferenceCollector.<span class="built_in">FindReferences</span>( Obj );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(OutReferredToObjects)</span><br><span class="line">  &#123;</span><br><span class="line">    OutReferredToObjects-&gt;<span class="built_in">Append</span>(ReferredToObjects);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> OutReferredToObjects.<span class="built_in">Num</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AutomationTool-Project"><a href="#AutomationTool-Project" class="headerlink" title="AutomationTool Project"></a>AutomationTool Project</h2><p>可以在项目中创建一个Automotion的项目，类似UGCExample中的那样，在<code>Build/Script</code>下创建UAT项目：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UGCExample/tree/release/Build/Scripts">Build/Scripts</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/ProductionPipelines/BuildTools/AutomationTool/HowTo/AddingAutomationProjects/">Adding Automation Projects</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/ProductionPipelines/BuildTools/AutomationTool/Overview/">AutomationTool Overview</a></li>
</ul>
<h2 id="UPL修改gradle-properties"><a href="#UPL修改gradle-properties" class="headerlink" title="UPL修改gradle.properties"></a>UPL修改gradle.properties</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/SharingAndReleasing/Mobile/UnrealPluginLanguage/">Unreal Plugin Language</a></li>
</ul>
<p>修改Gradle的堆大小：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gradleProperties</span>&gt;</span></span><br><span class="line">  org.gradle.jvmargs=-Xmx9216M</span><br><span class="line"><span class="tag">&lt;/<span class="name">gradleProperties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>引擎中默认的为：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Programs/UnrealBuildTool/Platform/Android/UEDeployAndroid.cs#L3092">UEDeployAndroid.cs#L3092</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GradleProperties.AppendLine(<span class="string">&quot;org.gradle.daemon=false&quot;</span>);</span><br><span class="line">GradleProperties.AppendLine(<span class="string">&quot;org.gradle.jvmargs=-XX:MaxHeapSize=4096m -Xmx9216m&quot;</span>);</span><br><span class="line">GradleProperties.AppendLine(<span class="string">&quot;android.injected.testOnly=false&quot;</span>);</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;COMPILE_SDK_VERSION=&#123;0&#125;&quot;</span>, CompileSDKVersion));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;BUILD_TOOLS_VERSION=&#123;0&#125;&quot;</span>, BuildToolsVersion));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;PACKAGE_NAME=&#123;0&#125;&quot;</span>, PackageName));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;MIN_SDK_VERSION=&#123;0&#125;&quot;</span>, MinSDKVersion.ToString()));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;TARGET_SDK_VERSION=&#123;0&#125;&quot;</span>, TargetSDKVersion.ToString()));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;STORE_VERSION=&#123;0&#125;&quot;</span>, StoreVersion.ToString()));</span><br><span class="line">GradleProperties.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;VERSION_DISPLAY_NAME=&#123;0&#125;&quot;</span>, VersionDisplayName));</span><br></pre></td></tr></table></figure>

<h2 id="Timer的回调中不能析构handle"><a href="#Timer的回调中不能析构handle" class="headerlink" title="Timer的回调中不能析构handle"></a>Timer的回调中不能析构handle</h2><p>在Timer的回调里不能释放掉handle对象的内存，因为在回调之后，<code>FTimeManager::Tick</code>中在执行Delegate之后还有用到：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210615204622.png"></p>
<h2 id="C-检测命令行参数"><a href="#C-检测命令行参数" class="headerlink" title="C#检测命令行参数"></a>C#检测命令行参数</h2><p>在build.cs以及target.cs中可以获取命令行参数，对编译选项进行控制：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span>[] CmdArgs = Environment.GetCommandLineArgs();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="built_in">string</span> CmdLineArg <span class="keyword">in</span> CmdArgs)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;CmdLineArg: &quot;</span> + CmdLineArg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0&gt;E:\UnrealEngine\Launcher\UE_4.26\Engine\Build\BatchFiles\Build.bat GWorldEditor Win64 Development -Project&#x3D;&quot;E:\UnrealProjects\GWorld\GWorld.uproject&quot; -WaitMutex -FromMsBuild -test</span><br><span class="line">0&gt;CmdLineArg: ..\..\Engine\Binaries\DotNET\UnrealBuildTool.exe</span><br><span class="line">0&gt;CmdLineArg: GWorldEditor</span><br><span class="line">0&gt;CmdLineArg: Win64</span><br><span class="line">0&gt;CmdLineArg: Development</span><br><span class="line">0&gt;CmdLineArg: -Project&#x3D;E:\UnrealProjects\GWorld\GWorld.uproject</span><br><span class="line">0&gt;CmdLineArg: -WaitMutex</span><br><span class="line">0&gt;CmdLineArg: -FromMsBuild</span><br><span class="line">0&gt;CmdLineArg: -test</span><br></pre></td></tr></table></figure>
<p>基于传递的参数可以动态地修改编译行为，比如添加宏、依赖的模块等。</p>
<h2 id="IniPlatformName"><a href="#IniPlatformName" class="headerlink" title="IniPlatformName"></a>IniPlatformName</h2><p>因为如果只有打包的资源平台不同，App读取的ini存在共用，如下面这些，其实都对应基础的ini Platform：</p>
<ul>
<li><code>WindowsNoEditor</code> -&gt; <code>Windows</code></li>
<li><code>WindowsClient</code> -&gt; <code>Windows</code></li>
<li><code>WindowsServer</code> -&gt; <code>Windows</code></li>
<li><code>Android_ASTC</code> -&gt; <code>Android</code></li>
<li><code>Android_2TC2</code> -&gt; <code>Android</code></li>
</ul>
<p>可以通过以下方式转换：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">Conv2IniPlatform</span><span class="params">(<span class="keyword">const</span> FString&amp; Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString Result;</span><br><span class="line">  ITargetPlatformManagerModule&amp; TPM = <span class="built_in">GetTargetPlatformManagerRef</span>();</span><br><span class="line">  <span class="keyword">const</span> TArray&lt;ITargetPlatform*&gt;&amp; TargetPlatforms = TPM.<span class="built_in">GetTargetPlatforms</span>();</span><br><span class="line">  TArray&lt;ITargetPlatform*&gt; CookPlatforms; </span><br><span class="line">  <span class="keyword">for</span> (ITargetPlatform *TargetPlatform : TargetPlatforms)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (TargetPlatform-&gt;<span class="built_in">PlatformName</span>().<span class="built_in">Equals</span>(Platform))</span><br><span class="line">    &#123;</span><br><span class="line">      Result = TargetPlatform-&gt;<span class="built_in">IniPlatformName</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="IOS内存阈值"><a href="#IOS内存阈值" class="headerlink" title="IOS内存阈值"></a>IOS内存阈值</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5887248/ios-app-maximum-memory-budget/15200855#15200855">ios app maximum memory budget</a></li>
</ul>
<p>距离FootPrint有100M的范围是比较保险的。</p>
<p>Device: (crash amount/total amount/percentage of total)</p>
<ul>
<li>iPad1: 127MB/256MB/49%</li>
<li>iPad2: 275MB/512MB/53%</li>
<li>iPad3: 645MB/1024MB/62%</li>
<li>iPad4: 585MB/1024MB/57% (iOS 8.1)</li>
<li>iPad Mini 1st Generation: 297MB/512MB/58%</li>
<li>iPad Mini retina: 696MB/1024MB/68% (iOS 7.1)</li>
<li>iPad Air: 697MB/1024MB/68%</li>
<li>iPad Air 2: 1383MB/2048MB/68% (iOS 10.2.1)</li>
<li>iPad Pro 9.7”: 1395MB/1971MB/71% (iOS 10.0.2 (14A456))</li>
<li>iPad Pro 10.5”: 3057/4000/76% (iOS 11 beta4)</li>
<li>iPad Pro 12.9” (2015): 3058/3999/76% (iOS 11.2.1)</li>
<li>iPad Pro 12.9” (2017): 3057/3974/77% (iOS 11 beta4)</li>
<li>iPad Pro 11.0” (2018): 2858/3769/76% (iOS 12.1)</li>
<li>iPad Pro 12.9” (2018, 1TB): 4598/5650/81% (iOS 12.1)</li>
<li>iPad 10.2: 1844/2998/62% (iOS 13.2.3)</li>
<li>iPod touch 4th gen: 130MB/256MB/51% (iOS 6.1.1)</li>
<li>iPod touch 5th gen: 286MB/512MB/56% (iOS 7.0)</li>
<li>iPhone4: 325MB/512MB/63%</li>
<li>iPhone4s: 286MB/512MB/56%</li>
<li>iPhone5: 645MB/1024MB/62%</li>
<li>iPhone5s: 646MB/1024MB/63%</li>
<li>iPhone6: 645MB/1024MB/62% (iOS 8.x)</li>
<li>iPhone6+: 645MB/1024MB/62% (iOS 8.x)</li>
<li>iPhone6s: 1396MB/2048MB/68% (iOS 9.2)</li>
<li>iPhone6s+: 1392MB/2048MB/68% (iOS 10.2.1)</li>
<li>iPhoneSE: 1395MB/2048MB/69% (iOS 9.3)</li>
<li>iPhone7: 1395/2048MB/68% (iOS 10.2)</li>
<li>iPhone7+: 2040MB/3072MB/66% (iOS 10.2.1)</li>
<li>iPhone8: 1364/1990MB/70% (iOS 12.1)</li>
<li>iPhone X: 1392/2785/50% (iOS 11.2.1)</li>
<li>iPhone XS: 2040/3754/54% (iOS 12.1)</li>
<li>iPhone XS Max: 2039/3735/55% (iOS 12.1)</li>
<li>iPhone XR: 1792/2813/63% (iOS 12.1)</li>
<li>iPhone 11: 2068/3844/54% (iOS 13.1.3)</li>
<li>iPhone 11 Pro Max: 2067/3740/55% (iOS 13.2.3)</li>
</ul>
<h2 id="ensure"><a href="#ensure" class="headerlink" title="ensure"></a>ensure</h2><p>在shipping时不会Break。</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\Misc\AssertionMacros.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ensure() can be used to test for *non-fatal* errors at runtime</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Rather than crashing, an error report (with a full call stack) will be logged and submitted to the crash server. </span></span><br><span class="line"><span class="comment"> * This is useful when you want runtime code verification but you&#x27;re handling the error case anyway.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: ensure() can be nested within conditionals!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    if (ensure(InObject != nullptr))</span></span><br><span class="line"><span class="comment"> *    &#123;</span></span><br><span class="line"><span class="comment"> *      InObject-&gt;Modify();</span></span><br><span class="line"><span class="comment"> *    &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This code is safe to execute as the pointer dereference is wrapped in a non-nullptr conditional block, but</span></span><br><span class="line"><span class="comment"> * you still want to find out if this ever happens so you can avoid side effects.  Using ensure() here will</span></span><br><span class="line"><span class="comment"> * force a crash report to be generated without crashing the application (and potentially causing editor</span></span><br><span class="line"><span class="comment"> * users to lose unsaved work.)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ensure() resolves to just evaluate the expression when DO_CHECK is 0 (typically shipping or test builds).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default a given call site will only print the callstack and submit the &#x27;crash report&#x27; the first time an</span></span><br><span class="line"><span class="comment"> * ensure is hit in a session; ensureAlways can be used instead if you want to handle every failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DO_CHECK &amp;&amp; !USING_CODE_ANALYSIS <span class="comment">// The Visual Studio 2013 analyzer doesn&#x27;t understand these complex conditionals</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> UE_ENSURE_IMPL(Capture, Always, InExpression, ...) \</span></span><br><span class="line">    (<span class="built_in">LIKELY</span>(!!(InExpression)) || (DispatchCheckVerify&lt;<span class="keyword">bool</span>&gt;([Capture] () FORCENOINLINE UE_DEBUG_SECTION \</span><br><span class="line">    &#123; \</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">bool</span> bExecuted = <span class="literal">false</span>; \</span><br><span class="line">      <span class="keyword">if</span> ((!bExecuted || Always) &amp;&amp; FPlatformMisc::<span class="built_in">IsEnsureAllowed</span>()) \</span><br><span class="line">      &#123; \</span><br><span class="line">        bExecuted = <span class="literal">true</span>; \</span><br><span class="line">        FDebug::<span class="built_in">OptionallyLogFormattedEnsureMessageReturningFalse</span>(<span class="literal">true</span>, #InExpression, __FILE__, __LINE__, ##__VA_ARGS__); \</span><br><span class="line">        <span class="keyword">if</span> (!FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>()) \</span><br><span class="line">        &#123; \</span><br><span class="line">          FPlatformMisc::<span class="built_in">PromptForRemoteDebugging</span>(<span class="literal">true</span>); \</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>; \</span><br><span class="line">        &#125; \</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; \</span><br><span class="line">      &#125; \</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>; \</span><br><span class="line">    &#125;) &amp;&amp; ([] () &#123; <span class="built_in">PLATFORM_BREAK</span>(); &#125; (), <span class="literal">false</span>)))</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensure(           InExpression                ) UE_ENSURE_IMPL( , false, InExpression, TEXT(<span class="meta-string">&quot;&quot;</span>))</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureMsgf(       InExpression, InFormat, ... ) UE_ENSURE_IMPL(&amp;, false, InExpression, InFormat, ##__VA_ARGS__)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureAlways(     InExpression                ) UE_ENSURE_IMPL( , true,  InExpression, TEXT(<span class="meta-string">&quot;&quot;</span>))</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureAlwaysMsgf( InExpression, InFormat, ... ) UE_ENSURE_IMPL(&amp;, true,  InExpression, InFormat, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">// DO_CHECK</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensure(           InExpression                ) (!!(InExpression))</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureMsgf(       InExpression, InFormat, ... ) (!!(InExpression))</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureAlways(     InExpression                ) (!!(InExpression))</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ensureAlwaysMsgf( InExpression, InFormat, ... ) (!!(InExpression))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// DO_CHECK</span></span></span><br></pre></td></tr></table></figure>


<h2 id="堡垒之夜为多平台的内容优化"><a href="#堡垒之夜为多平台的内容优化" class="headerlink" title="堡垒之夜为多平台的内容优化"></a>堡垒之夜为多平台的内容优化</h2><ul>
<li><a target="_blank" rel="noopener" href="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/PPT/Unreal%20Engine_EGC_Resources_%E5%A0%A1%E5%9E%92%E4%B9%8B%E5%A4%9C%E4%B8%BA%E5%A4%9A%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%86%85%E5%AE%B9%E4%BC%98%E5%8C%96.pdf">堡垒之夜为多平台的内容优化 - 李文磊</a></li>
</ul>
<h2 id="自动化测试框架"><a href="#自动化测试框架" class="headerlink" title="自动化测试框架"></a>自动化测试框架</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/Automation/">Automation System Overview</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/Automation/Gauntlet/">Gauntlet Automation Framework</a></li>
</ul>
<h2 id="《堡垒之夜》跨平台开发迭代经验分享"><a href="#《堡垒之夜》跨平台开发迭代经验分享" class="headerlink" title="《堡垒之夜》跨平台开发迭代经验分享"></a>《堡垒之夜》跨平台开发迭代经验分享</h2><h3 id="Cooker优化"><a href="#Cooker优化" class="headerlink" title="Cooker优化"></a>Cooker优化</h3><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610101221.png"></p>
<ol>
<li>Shared DDC 必须要使用，对于常规的资源，DDC是一种非常有效的加速手段，例如纹理压缩需要在多个平台分别处理，而且压缩算法非常稳定，通过使用DDC，仅需要处理一次即可。</li>
<li>Shaders与Texture 不同， 经常会发生变化，编译 Shader 可以使用 XGE （IncrediBuild）加速。（注：Fastbuild 好像也可以并行编译Shader，网上有相关的教程）</li>
</ol>
<p>当DDC已经完全使用以后，Cook就成为了一个完全主线程绑定的任务了，它需要反复加载、保存资源，无法利用多线程进行并行化。所以建议最好使用核数较少，但是单核主频较高的主机进行Cook处理。</p>
<ol>
<li>在 DefaultEngine.ini 设置 MaxMemoryAllowance 增大 Cook 使用内存数量，默认是16G。（注：Cook 是 IO密集，所以增加内存使用量可以减少因为内存不足导致的 Purge 次数）</li>
<li>使用 FCookModificationDelegate 来控制需要 Cook 的 Asset 数量。</li>
</ol>
<h3 id="Device-Profile"><a href="#Device-Profile" class="headerlink" title="Device Profile"></a>Device Profile</h3><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610101046.png"></p>
<h3 id="在线迭代"><a href="#在线迭代" class="headerlink" title="在线迭代"></a>在线迭代</h3><p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210610102528.png"></p>
<h2 id="RootComponent警告"><a href="#RootComponent警告" class="headerlink" title="RootComponent警告"></a>RootComponent警告</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogActor: Warning: Bullet &#x2F;Game&#x2F;Map.Map:PersistentLevel.Bullet_0 has natively added scene component(s), but none of them were set as the actor&#39;s RootComponent - picking one arbitrarily</span><br></pre></td></tr></table></figure>
<p>这是因为直接在<strong>无参构造函数</strong>里写了赋值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ABullet::<span class="built_in">ABullet</span>()</span><br><span class="line">&#123;</span><br><span class="line">  PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line">  RootComponent = CreateDefaultSubobject&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;RootComponent&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加上<code>SetRootComponent</code>或者在<code>FObjectInitializer</code>构造函数里写（建议）即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USceneComponent* NewRootComponent = CreateDefaultSubobject&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;RootComponent&quot;</span>));</span><br><span class="line"><span class="built_in">SetRootComponent</span>(NewRootComponent);</span><br></pre></td></tr></table></figure>
<p>就像：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Engine/Private/Camera/CameraActor.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ACameraActor::<span class="built_in">ACameraActor</span>(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer)</span><br><span class="line">  : <span class="built_in">Super</span>(ObjectInitializer)</span><br><span class="line">&#123;</span><br><span class="line">  SceneComponent = CreateDefaultSubobject&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;SceneComponent&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make the scene component the root component</span></span><br><span class="line">  RootComponent = SceneComponent;</span><br><span class="line">  <span class="comment">// ...  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/468033/warning-none-of-them-were-set-as-the-actors-rootco.html">Warning: None of them were set as the actor’s RootComponent</a></li>
</ul>
<h2 id="ConfigLayer"><a href="#ConfigLayer" class="headerlink" title="ConfigLayer"></a>ConfigLayer</h2><p>引擎Config的文件路径规则：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Private\Misc\ConfigCacheIni.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Structure to define all the layers of the config system. Layers can be expanded by expansion files (NoRedist, etc), or by ini platform parents</span></span><br><span class="line"><span class="comment"> * (coming soon from another branch)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FConfigLayer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">// Used by the editor to display in the ini-editor</span></span><br><span class="line">  <span class="keyword">const</span> TCHAR* EditorName;</span><br><span class="line">  <span class="comment">// Path to the ini file (with variables)</span></span><br><span class="line">  <span class="keyword">const</span> TCHAR* Path;</span><br><span class="line">  <span class="comment">// Path to the platform extension version</span></span><br><span class="line">  <span class="keyword">const</span> TCHAR* PlatformExtensionPath;</span><br><span class="line">  <span class="comment">// Special flag</span></span><br><span class="line">  EConfigLayerFlags Flag;</span><br><span class="line"></span><br><span class="line">&#125; GConfigLayers[] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**************************************************</span></span><br><span class="line"><span class="comment">  **** CRITICAL NOTES</span></span><br><span class="line"><span class="comment">  **** If you change this array, you need to also change EnumerateConfigFileLocations() in ConfigHierarchy.cs!!!</span></span><br><span class="line"><span class="comment">  **** And maybe UObject::GetDefaultConfigFilename(), UObject::GetGlobalUserConfigFilename()</span></span><br><span class="line"><span class="comment">  **************************************************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Engine/Base.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;AbsoluteBase&quot;</span>),       <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;ENGINE&#125;Base.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>), EConfigLayerFlags::Required &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Engine/Base*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;Base&quot;</span>),           <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;ENGINE&#125;&#123;ED&#125;&#123;EF&#125;Base&#123;TYPE&#125;.ini&quot;</span>) &#125;,</span><br><span class="line">  <span class="comment">// Engine/Platform/BasePlatform*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;BasePlatform&quot;</span>),       <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;ENGINE&#125;&#123;ED&#125;&#123;PLATFORM&#125;/&#123;EF&#125;Base&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;EXTENGINE&#125;/&#123;ED&#125;&#123;EF&#125;Base&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>),  &#125;,</span><br><span class="line">  <span class="comment">// Project/Default*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;ProjectDefault&quot;</span>),     <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;PROJECT&#125;&#123;ED&#125;&#123;EF&#125;Default&#123;TYPE&#125;.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>), EConfigLayerFlags::AllowCommandLineOverride | EConfigLayerFlags::GenerateCacheKey &#125;,</span><br><span class="line">  <span class="comment">// Engine/Platform/Platform*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;EnginePlatform&quot;</span>),     <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;ENGINE&#125;&#123;ED&#125;&#123;PLATFORM&#125;/&#123;EF&#125;&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;EXTENGINE&#125;/&#123;ED&#125;&#123;EF&#125;&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>) &#125;,</span><br><span class="line">  <span class="comment">// Project/Platform/Platform*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;ProjectPlatform&quot;</span>),      <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;PROJECT&#125;&#123;ED&#125;&#123;PLATFORM&#125;/&#123;EF&#125;&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;EXTPROJECT&#125;/&#123;ED&#125;&#123;EF&#125;&#123;PLATFORM&#125;&#123;TYPE&#125;.ini&quot;</span>) &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// UserSettings/.../User*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;UserSettingsDir&quot;</span>),      <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;USERSETTINGS&#125;Unreal Engine/Engine/Config/User&#123;TYPE&#125;.ini&quot;</span>) &#125;,</span><br><span class="line">  <span class="comment">// UserDir/.../User*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;UserDir&quot;</span>),          <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;USER&#125;Unreal Engine/Engine/Config/User&#123;TYPE&#125;.ini&quot;</span>) &#125;,</span><br><span class="line">  <span class="comment">// Project/User*.ini</span></span><br><span class="line">  &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;GameDirUser&quot;</span>),        <span class="built_in">TEXT</span>(<span class="string">&quot;&#123;PROJECT&#125;User&#123;TYPE&#125;.ini&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>), EConfigLayerFlags::GenerateCacheKey &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Mac生成的xocde工程"><a href="#Mac生成的xocde工程" class="headerlink" title="Mac生成的xocde工程"></a>Mac生成的xocde工程</h2><p>在UE项目的<code>Intermediate/ProjectFilesIOS</code>目录下，会创建一个项目同名的<code>xcodeproj</code>并且具有<code>UE4.xcodeproj</code>文件。</p>
<h2 id="Unreal-Insight默认端口"><a href="#Unreal-Insight默认端口" class="headerlink" title="Unreal Insight默认端口"></a>Unreal Insight默认端口</h2><p>在Unreal Insight启动时默认监听本地的1980端口：</p>
<figure class="highlight cpp"><figcaption><span>Source/Developer/TraceInsights/Private/Insights/TraceInsightsModule.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTraceInsightsModule::CreateDefaultStore</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> FString StoreDir = FPaths::<span class="built_in">ProjectSavedDir</span>() / <span class="built_in">TEXT</span>(<span class="string">&quot;TraceSessions&quot;</span>);</span><br><span class="line"></span><br><span class="line">  FInsightsManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">SetStoreDir</span>(StoreDir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the Store Service.</span></span><br><span class="line">  Trace::FStoreService::FDesc StoreServiceDesc;</span><br><span class="line">  StoreServiceDesc.StoreDir = *StoreDir;</span><br><span class="line">  StoreServiceDesc.RecorderPort = <span class="number">1980</span>;</span><br><span class="line">  StoreServiceDesc.ThreadCount = <span class="number">2</span>;</span><br><span class="line">  StoreService = TUniquePtr&lt;Trace::FStoreService&gt;(Trace::FStoreService::<span class="built_in">Create</span>(StoreServiceDesc));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StoreService.<span class="built_in">IsValid</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ConnectToStore</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;127.0.0.1&quot;</span>), StoreService-&gt;<span class="built_in">GetPort</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Unreal Insight的启动：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Programs/UnrealInsights/Private/UserInterfaceCommand.cpp#L211">Programs/UnrealInsights/Private/UserInterfaceCommand.cpp#L211</a>。</p>
<p>可以传递给Unreal Insight的参数:</p>
<ul>
<li><code>-OpenTraceId=</code></li>
<li><code>-Store=</code>：<code>-Store=127.0.0.1:1980</code></li>
<li><code>-StoreHost=</code></li>
<li><code>-StorePort=</code></li>
<li><code>-ExecOnAnalysisCompleteCmd=</code></li>
<li><code>-AutoQuit</code></li>
<li><code>-InsightsTest</code></li>
<li><code>-DebugTools</code></li>
</ul>
<h2 id="Navmesh-bounds-are-too-large"><a href="#Navmesh-bounds-are-too-large" class="headerlink" title="Navmesh bounds are too large"></a>Navmesh bounds are too large</h2><p>当地图相当大，在生成导航时会有以下提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogNavigation: Error: Navmesh bounds are too large! Limiting requested tiles count (5472000) to: (1048576) for RecastNavMesh &#x2F;Game&#x2F;Level&#x2F;Map.Map:PersistentLevel.RecastNavMesh-Default</span><br></pre></td></tr></table></figure>
<p>这是因为地图太大，超出了Tile的数量限制。<br>引擎中默认Tile的最大数量为<code>1&lt;&lt;20</code>也就是1048576，这个值可以修改配置，但不能大于<code>1&lt;&lt;30</code>(因为它用int32存储)。</p>
<figure class="highlight cpp"><figcaption><span>Source/Runtime/NavigationSystem/Public/NavMesh/RecastNavMesh.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(config=Engine, defaultconfig, hidecategories=(Input,Rendering,Tags,<span class="string">&quot;Utilities|Transformation&quot;</span>,Actor,Layers,Replication), notplaceable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NAVIGATIONSYSTEM_API</span> <span class="title">ARecastNavMesh</span> :</span> <span class="keyword">public</span> ANavigationData</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">/** Absolute hard limit to number of navmesh tiles. Be very, very careful while modifying it while</span></span><br><span class="line"><span class="comment">   *  having big maps with navmesh. A single, empty tile takes 176 bytes and empty tiles are</span></span><br><span class="line"><span class="comment">   *  allocated up front (subject to change, but that&#x27;s where it&#x27;s at now)</span></span><br><span class="line"><span class="comment">   *  @note TileNumberHardLimit is always rounded up to the closest power of 2 */</span></span><br><span class="line">  <span class="built_in">UPROPERTY</span>(EditAnywhere, Category = Generation, config, meta = (ClampMin = <span class="string">&quot;1&quot;</span>, UIMin = <span class="string">&quot;1&quot;</span>), AdvancedDisplay)</span><br><span class="line">  int32 TileNumberHardLimit;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以及使用：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/NavigationSystem/Private/NavMesh/RecastNavMesh.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">FRecastNavMeshGenerationProperties::<span class="built_in">FRecastNavMeshGenerationProperties</span>()</span><br><span class="line">&#123;</span><br><span class="line">  TilePoolSize = <span class="number">1024</span>;</span><br><span class="line">  TileSizeUU = <span class="number">988.f</span>;</span><br><span class="line">  CellSize = <span class="number">19</span>;</span><br><span class="line">  CellHeight = <span class="number">10</span>;</span><br><span class="line">  AgentRadius = <span class="number">34.f</span>;</span><br><span class="line">  AgentHeight = <span class="number">144.f</span>;</span><br><span class="line">  AgentMaxSlope = <span class="number">44.f</span>;</span><br><span class="line">  AgentMaxStepHeight = <span class="number">35.f</span>;</span><br><span class="line">  MinRegionArea = <span class="number">0.f</span>;</span><br><span class="line">  MergeRegionSize = <span class="number">400.f</span>;</span><br><span class="line">  MaxSimplificationError = <span class="number">1.3f</span>;  <span class="comment">// from RecastDemo</span></span><br><span class="line">  TileNumberHardLimit = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">  RegionPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  LayerPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  RegionChunkSplits = <span class="number">2</span>;</span><br><span class="line">  LayerChunkSplits = <span class="number">2</span>;</span><br><span class="line">  bSortNavigationAreasByCost = <span class="literal">false</span>;</span><br><span class="line">  bPerformVoxelFiltering = <span class="literal">true</span>;</span><br><span class="line">  bMarkLowHeightAreas = <span class="literal">false</span>;</span><br><span class="line">  bUseExtraTopCellWhenMarkingAreas = <span class="literal">true</span>;</span><br><span class="line">  bFilterLowSpanSequences = <span class="literal">false</span>;</span><br><span class="line">  bFilterLowSpanFromTileCache = <span class="literal">false</span>;</span><br><span class="line">  bFixedTilePoolSize = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FRecastNavMeshGenerationProperties::<span class="built_in">FRecastNavMeshGenerationProperties</span>(<span class="keyword">const</span> ARecastNavMesh&amp; RecastNavMesh)</span><br><span class="line">&#123;</span><br><span class="line">  TilePoolSize = RecastNavMesh.TilePoolSize;</span><br><span class="line">  TileSizeUU = RecastNavMesh.TileSizeUU;</span><br><span class="line">  CellSize = RecastNavMesh.CellSize;</span><br><span class="line">  CellHeight = RecastNavMesh.CellHeight;</span><br><span class="line">  AgentRadius = RecastNavMesh.AgentRadius;</span><br><span class="line">  AgentHeight = RecastNavMesh.AgentHeight;</span><br><span class="line">  AgentMaxSlope = RecastNavMesh.AgentMaxSlope;</span><br><span class="line">  AgentMaxStepHeight = RecastNavMesh.AgentMaxStepHeight;</span><br><span class="line">  MinRegionArea = RecastNavMesh.MinRegionArea;</span><br><span class="line">  MergeRegionSize = RecastNavMesh.MergeRegionSize;</span><br><span class="line">  MaxSimplificationError = RecastNavMesh.MaxSimplificationError;</span><br><span class="line">  TileNumberHardLimit = RecastNavMesh.TileNumberHardLimit;</span><br><span class="line">  RegionPartitioning = RecastNavMesh.RegionPartitioning;</span><br><span class="line">  LayerPartitioning = RecastNavMesh.LayerPartitioning;</span><br><span class="line">  RegionChunkSplits = RecastNavMesh.RegionChunkSplits;</span><br><span class="line">  LayerChunkSplits = RecastNavMesh.LayerChunkSplits;</span><br><span class="line">  bSortNavigationAreasByCost = RecastNavMesh.bSortNavigationAreasByCost;</span><br><span class="line">  bPerformVoxelFiltering = RecastNavMesh.bPerformVoxelFiltering;</span><br><span class="line">  bMarkLowHeightAreas = RecastNavMesh.bMarkLowHeightAreas;</span><br><span class="line">  bUseExtraTopCellWhenMarkingAreas = RecastNavMesh.bUseExtraTopCellWhenMarkingAreas;</span><br><span class="line">  bFilterLowSpanSequences = RecastNavMesh.bFilterLowSpanSequences;</span><br><span class="line">  bFilterLowSpanFromTileCache = RecastNavMesh.bFilterLowSpanFromTileCache;</span><br><span class="line">  bFixedTilePoolSize = RecastNavMesh.bFixedTilePoolSize;</span><br><span class="line">&#125;</span><br><span class="line">ARecastNavMesh::<span class="built_in">ARecastNavMesh</span>(<span class="keyword">const</span> FObjectInitializer&amp; ObjectInitializer)</span><br><span class="line">  : <span class="built_in">Super</span>(ObjectInitializer)</span><br><span class="line">  , <span class="built_in">bDrawFilledPolys</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawNavMeshEdges</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawNavLinks</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawOctreeDetails</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bDrawMarkedForbiddenPolys</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bDistinctlyDrawTilesBeingBuilt</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">DrawOffset</span>(<span class="number">10.f</span>)</span><br><span class="line">  , <span class="built_in">TilePoolSize</span>(<span class="number">1024</span>)</span><br><span class="line">  , <span class="built_in">MaxSimplificationError</span>(<span class="number">1.3f</span>)  <span class="comment">// from RecastDemo</span></span><br><span class="line">  , <span class="built_in">DefaultMaxSearchNodes</span>(RECAST_MAX_SEARCH_NODES)</span><br><span class="line">  , <span class="built_in">DefaultMaxHierarchicalSearchNodes</span>(RECAST_MAX_SEARCH_NODES)</span><br><span class="line">  , <span class="built_in">bPerformVoxelFiltering</span>(<span class="literal">true</span>)  </span><br><span class="line">  , <span class="built_in">bMarkLowHeightAreas</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bUseExtraTopCellWhenMarkingAreas</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bFilterLowSpanSequences</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bFilterLowSpanFromTileCache</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bStoreEmptyTileLayers</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">bUseVirtualFilters</span>(<span class="literal">true</span>)</span><br><span class="line">  , <span class="built_in">bAllowNavLinkAsPathEnd</span>(<span class="literal">false</span>)</span><br><span class="line">  , <span class="built_in">TileSetUpdateInterval</span>(<span class="number">1.0f</span>)</span><br><span class="line">  , <span class="built_in">NavMeshVersion</span>(NAVMESHVER_LATEST) </span><br><span class="line">  , <span class="built_in">RecastNavMeshImpl</span>(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  HeuristicScale = <span class="number">0.999f</span>;</span><br><span class="line">  RegionPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  LayerPartitioning = ERecastPartitioning::Watershed;</span><br><span class="line">  RegionChunkSplits = <span class="number">2</span>;</span><br><span class="line">  LayerChunkSplits = <span class="number">2</span>;</span><br><span class="line">  MaxSimultaneousTileGenerationJobsCount = <span class="number">1024</span>;</span><br><span class="line">  bDoFullyAsyncNavDataGathering = <span class="literal">false</span>;</span><br><span class="line">  TileNumberHardLimit = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RECAST_ASYNC_REBUILDING</span></span><br><span class="line">  BatchQueryCounter = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// RECAST_ASYNC_REBUILDING</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">HasAnyFlags</span>(RF_ClassDefaultObject) == <span class="literal">false</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">INC_DWORD_STAT_BY</span>( STAT_NavigationMemory, <span class="built_in"><span class="keyword">sizeof</span></span>(*<span class="keyword">this</span>) );</span><br><span class="line"></span><br><span class="line">    FindPathImplementation = FindPath;</span><br><span class="line">    FindHierarchicalPathImplementation = FindPath;</span><br><span class="line"></span><br><span class="line">    TestPathImplementation = TestPath;</span><br><span class="line">    TestHierarchicalPathImplementation = TestHierarchicalPath;</span><br><span class="line"></span><br><span class="line">    RaycastImplementation = NavMeshRaycast;</span><br><span class="line"></span><br><span class="line">    RecastNavMeshImpl = <span class="keyword">new</span> <span class="built_in">FPImplRecastNavMesh</span>(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// add predefined areas up front</span></span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_Null::<span class="built_in">StaticClass</span>(), RECAST_NULL_AREA));</span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_LowHeight::<span class="built_in">StaticClass</span>(), RECAST_LOW_AREA));</span><br><span class="line">    SupportedAreas.<span class="built_in">Add</span>(<span class="built_in">FSupportedAreaData</span>(UNavArea_Default::<span class="built_in">StaticClass</span>(), RECAST_DEFAULT_AREA));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TileNumberHardLimit</code>的值可以通过配置文件进行设置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/NavigationSystem.RecastNavMesh]</span></span><br><span class="line"><span class="attr">bDrawPolyEdges</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bDistinctlyDrawTilesBeingBuilt</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">DrawOffset</span>=<span class="number">10.000000</span></span><br><span class="line"><span class="attr">bFixedTilePoolSize</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">TilePoolSize</span>=<span class="number">1024</span></span><br><span class="line"><span class="attr">TileSizeUU</span>=<span class="number">1000.000000</span></span><br><span class="line"><span class="attr">CellSize</span>=<span class="number">19.000000</span></span><br><span class="line"><span class="attr">CellHeight</span>=<span class="number">10.000000</span></span><br><span class="line"><span class="attr">AgentRadius</span>=<span class="number">34.000000</span></span><br><span class="line"><span class="attr">AgentHeight</span>=<span class="number">144.000000</span></span><br><span class="line"><span class="attr">AgentMaxHeight</span>=<span class="number">160.000000</span></span><br><span class="line"><span class="attr">AgentMaxSlope</span>=<span class="number">44.000000</span></span><br><span class="line"><span class="attr">AgentMaxStepHeight</span>=<span class="number">35.000000</span></span><br><span class="line"><span class="attr">MinRegionArea</span>=<span class="number">0.000000</span></span><br><span class="line"><span class="attr">MergeRegionSize</span>=<span class="number">400.000000</span></span><br><span class="line"><span class="attr">MaxSimplificationError</span>=<span class="number">1.300000</span></span><br><span class="line"><span class="attr">MaxSimultaneousTileGenerationJobsCount</span>=<span class="number">1024</span></span><br><span class="line"><span class="attr">TileNumberHardLimit</span>=<span class="number">1048576</span></span><br><span class="line"><span class="attr">DefaultDrawDistance</span>=<span class="number">5000.000000</span></span><br><span class="line"><span class="attr">DefaultMaxSearchNodes</span>=<span class="number">2048.000000</span></span><br><span class="line"><span class="attr">DefaultMaxHierarchicalSearchNodes</span>=<span class="number">2048.000000</span></span><br><span class="line"><span class="attr">RegionPartitioning</span>=Watershed</span><br><span class="line"><span class="attr">LayerPartitioning</span>=Watershed</span><br><span class="line"><span class="attr">RegionChunkSplits</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">LayerChunkSplits</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">bSortNavigationAreasByCost</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bPerformVoxelFiltering</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bMarkLowHeightAreas</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bDoFullyAsyncNavDataGathering</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">bUseBetterOffsetsFromCorners</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bUseVirtualFilters</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">bUseVoxelCache</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">TileSetUpdateInterval</span>=<span class="number">1.000000</span></span><br><span class="line"><span class="attr">HeuristicScale</span>=<span class="number">0.999000</span></span><br><span class="line"><span class="attr">VerticalDeviationFromGroundCompensation</span>=<span class="number">0.000000</span></span><br><span class="line"><span class="attr">bForceRebuildOnLoad</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h2 id="加密PakIndex造成的无法挂载shaderbytecode"><a href="#加密PakIndex造成的无法挂载shaderbytecode" class="headerlink" title="加密PakIndex造成的无法挂载shaderbytecode"></a>加密PakIndex造成的无法挂载shaderbytecode</h2><p>在UE5中<code>Project Settings</code>-<code>Crypto</code>中开启<code>EncryptPakIndex</code>，发现在自动挂载中无法加载最新的Shaderbytecode，造成材质丢失（不确定UE4中是否存在）。<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210605162848.png"></p>
<h2 id="运行时给Enum添加值"><a href="#运行时给Enum添加值" class="headerlink" title="运行时给Enum添加值"></a>运行时给Enum添加值</h2><p>通过UEnum的<code>SetEnums</code>可以实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">UEnum* TargetPlatform = UFlibPatchParserHelper::GetUEnum&lt;ETargetPlatform&gt;();</span><br><span class="line">uint64 MaxEnumValue = TargetPlatform-&gt;<span class="built_in">GetMaxEnumValue</span>();</span><br><span class="line">FString EnumName = TargetPlatform-&gt;<span class="built_in">GetName</span>();</span><br><span class="line">TArray&lt;TPair&lt;FName, int64&gt;&gt; EnumNames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ETargetPlatform Platform:TEnumRange&lt;ETargetPlatform&gt;())</span><br><span class="line">&#123;</span><br><span class="line">  EnumNames.<span class="built_in">Emplace</span>(TargetPlatform-&gt;<span class="built_in">GetNameByValue</span>((int64)Platform),(int64)Platform);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span>&amp; AppendEnumItem:AppendPlatformEnums)</span><br><span class="line">&#123;</span><br><span class="line">  ++MaxEnumValue;</span><br><span class="line">  EnumNames.<span class="built_in">Emplace</span>(</span><br><span class="line">    <span class="built_in">FName</span>(*FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s::%s&quot;</span>),*EnumName,*AppendEnumItem)),</span><br><span class="line">    MaxEnumValue</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MAJOR_VERSION &gt; 4 || ENGINE_MINOR_VERSION &gt; 25</span></span><br><span class="line">TargetPlatform-&gt;<span class="built_in">SetEnums</span>(EnumNames,UEnum::ECppForm::EnumClass,EEnumFlags::None,<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">TargetPlatform-&gt;<span class="built_in">SetEnums</span>(EnumNames,UEnum::ECppForm::EnumClass,<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="遍历Enum的所有值"><a href="#遍历Enum的所有值" class="headerlink" title="遍历Enum的所有值"></a>遍历Enum的所有值</h2><p>需要用<code>ENUM_RANGE_BY_COUNT</code>标记，然后可以用<code>TEnumRange</code>遍历。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>()</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">  None,</span><br><span class="line">  AllPlatforms,</span><br><span class="line">  <span class="function">Count <span class="title">UMETA</span><span class="params">(Hidden)</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">ENUM_RANGE_BY_COUNT</span>(ETargetPlatform, ETargetPlatform::Count);</span><br><span class="line"></span><br><span class="line"><span class="comment">// for each</span></span><br><span class="line"><span class="keyword">for</span> (ETargetPlatform Platform:TEnumRange&lt;ETargetPlatform&gt;())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IoStore的生成分析"><a href="#IoStore的生成分析" class="headerlink" title="IoStore的生成分析"></a>IoStore的生成分析</h2><p>UE4.25添加了一个新的打包选项<code>IO Store</code>（在UE5中默认开启）：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210528170712.png"></p>
<p>Youtube上Epic JP有一个介绍视频：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=i31wSiqt-7w">【UE4.25 新機能】ロードの高速化機能「IOStore」について</a></p>
<p>在UE5中默认是开启的，打包时除了pak之外多了两种类型的文件：<code>ucas</code>与<code>utoc</code>，在运行时Mount pak时也会mount它们，看了下代码在UE4.25/26就中存在，有时间详细地分析下它们的作用和加载流程。</p>
<p>它们也在<code>CopyBuildToStagingDirectory.Automation.cs</code>文件中的<code>CreatePaks</code>函数中和Pak一同创建：</p>
<figure class="highlight csharp"><figcaption><span>Programs\AutomationTool\Scripts\CopyBuildToStagingDirectory.Automation.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">ShouldCreateIoStoreContainerFiles</span>(<span class="params">ProjectParams Params, Platform StageTargetPlatform</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Params.CookOnTheFly)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Params.SkipIoStore)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Params.IoStore)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Params.Stage &amp;&amp; !Params.SkipStage)</span><br><span class="line">  &#123;</span><br><span class="line">    ConfigHierarchy PlatformGameConfig = ConfigCache.ReadHierarchy(ConfigHierarchyType.Game, DirectoryReference.FromFile(Params.RawProjectPath), StageTargetPlatform.IniPlatformType);</span><br><span class="line">    <span class="built_in">bool</span> bUseIoStore = <span class="literal">false</span>;</span><br><span class="line">    PlatformGameConfig.GetBool(<span class="string">&quot;/Script/UnrealEd.ProjectPackagingSettings&quot;</span>, <span class="string">&quot;bUseIoStore&quot;</span>, <span class="keyword">out</span> bUseIoStore);</span><br><span class="line">    <span class="keyword">return</span> bUseIoStore;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreatePaks</span>(<span class="params">ProjectParams Params, DeploymentContext SC, List&lt;CreatePakParams&gt; PakParamsList, EncryptionAndSigning.CryptoSettings CryptoSettings, FileReference CryptoKeysCacheFilename</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (ShouldCreateIoStoreContainerFiles(Params, SC.StageTargetPlatform))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">bool</span> bAllowBulkDataInIoStore = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(!PlatformEngineConfig.GetBool(<span class="string">&quot;Core.System&quot;</span>, <span class="string">&quot;AllowBulkDataInIoStore&quot;</span>, <span class="keyword">out</span> bAllowBulkDataInIoStore))</span><br><span class="line">    &#123;</span><br><span class="line">      bAllowBulkDataInIoStore = <span class="literal">true</span>; <span class="comment">// Default is to allow it in the IoStore</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UnrealPakResponseFile = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">    Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; IoStoreResponseFile = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> Entry <span class="keyword">in</span> PakParams.UnrealPakResponseFile)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Temporary solution to filter non cooked packages from I/O store container file(s)</span></span><br><span class="line">      <span class="keyword">if</span> (SC.OnlyAllowPackagesFromStdCookPathInIoStore &amp;&amp; !Entry.Key.ToLower().Contains(<span class="string">&quot;\\saved\\cooked\\&quot;</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        UnrealPakResponseFile.Add(Entry.Key, Entry.Value);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Path.GetExtension(Entry.Key).Contains(<span class="string">&quot;.uasset&quot;</span>) ||</span><br><span class="line">        Path.GetExtension(Entry.Key).Contains(<span class="string">&quot;.umap&quot;</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        IoStoreResponseFile.Add(Entry.Key, Entry.Value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(Path.GetExtension(Entry.Key).Contains(<span class="string">&quot;.ubulk&quot;</span>) ||</span><br><span class="line">          Path.GetExtension(Entry.Key).Contains(<span class="string">&quot;.uptnl&quot;</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span>(bAllowBulkDataInIoStore)</span><br><span class="line">        &#123;</span><br><span class="line">          IoStoreResponseFile.Add(Entry.Key, Entry.Value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          UnrealPakResponseFile.Add(Entry.Key, Entry.Value);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!Path.GetExtension(Entry.Key).Contains(<span class="string">&quot;.uexp&quot;</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        UnrealPakResponseFile.Add(Entry.Key, Entry.Value);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> ContainerPatchSourcePath = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (Params.HasBasedOnReleaseVersion)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span> ContainerWildcard = PakParams.PakName + <span class="string">&quot;-&quot;</span> + SC.FinalCookPlatform + <span class="string">&quot;*.utoc&quot;</span>;</span><br><span class="line">      ContainerPatchSourcePath = CombinePaths(Params.GetBasedOnReleaseVersionPath(SC, Params.Client), ContainerWildcard);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">bool</span> bGenerateDiffPatch = bShouldGeneratePatch &amp;&amp; !ShouldSkipGeneratingPatch(PlatformGameConfig, PakParams.PakName);</span><br><span class="line">    <span class="built_in">bool</span> bCompressContainers = PakParams.bCompressed || Params.AdditionalIoStoreOptions.Contains(<span class="string">&quot;-compressed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    IoStoreCommands.Add(GetIoStoreCommandArguments(</span><br><span class="line">      IoStoreResponseFile,</span><br><span class="line">      PakParams.PakName,</span><br><span class="line">      OutputLocation,</span><br><span class="line">      bCompressContainers,</span><br><span class="line">      CryptoSettings,</span><br><span class="line">      PakParams.EncryptionKeyGuid,</span><br><span class="line">      ContainerPatchSourcePath,</span><br><span class="line">      bGenerateDiffPatch,</span><br><span class="line">      Params.HasDLCName));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与生成Pak类似，也会生成一个<code>PakListIoStore_*.txt</code>的文件，格式与<code>Paklist*.txt</code>相同。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\ThirdPerson_UE5\Content\BP_GF_Actor.uasset&quot; &quot;../../../ThirdPerson_UE5/Content/BP_GF_Actor.uasset&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\Animation\DefaultAnimBoneCompressionSettings.uasset&quot; &quot;../../../Engine/Content/Animation/DefaultAnimBoneCompressionSettings.uasset&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\Animation\DefaultAnimCurveCompressionSettings.uasset&quot; &quot;../../../Engine/Content/Animation/DefaultAnimCurveCompressionSettings.uasset&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\BasicShapes\Cone.uasset&quot; &quot;../../../Engine/Content/BasicShapes/Cone.uasset&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\BasicShapes\Cone.ubulk&quot; &quot;../../../Engine/Content/BasicShapes/Cone.ubulk&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\BasicShapes\Cube.uasset&quot; &quot;../../../Engine/Content/BasicShapes/Cube.uasset&quot;</span><br><span class="line">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\Engine\Content\BasicShapes\Cube.ubulk&quot; &quot;../../../Engine/Content/BasicShapes/Cube.ubulk&quot;</span><br></pre></td></tr></table></figure>
<p>但里面只包含<code>.uasset</code>/<code>.umap</code>的资源，其余的文件存储在<code>pak</code>中，相当于把原本的pak文件拆分成<code>utoc</code>和pak两个文件，加速IO。</p>
<p>UE提供了一个Commandlet，方便调用：</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/Commandlets/IoStoreCommandlet.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">UIoStoreCommandlet::Main</span><span class="params">(<span class="keyword">const</span> FString&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">CreateIoStoreContainerFiles</span>(*Params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心实现是在<code>IoStoreUtilities.cpp</code>中定义的<code>CreateIoStoreContainerFiles</code>函数。</p>
<p>IoStoreCommandlet的调用方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;C:\Program Files\Epic Games\UE_5.0ea\Engine\Binaries\Win64\UnrealEditor-Cmd.exe&quot;</span></span><br><span class="line"><span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\ThirdPerson_UE5.uproject&quot;</span></span><br><span class="line">-run=IoStore</span><br><span class="line">-CreateGlobalContainer=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\StagedBuilds\Windows\ThirdPerson_UE5\Content\Paks\global.utoc&quot;</span></span><br><span class="line">-CookedDirectory=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows&quot;</span></span><br><span class="line">-Commands=<span class="string">&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_5.0ea\IoStoreCommands.txt&quot;</span></span><br><span class="line">-CookerOrder=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Build\Windows\FileOpenOrder\CookerOpenOrder.log&quot;</span></span><br><span class="line">-patchpaddingalign=2048</span><br><span class="line">-cryptokeys=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\ThirdPerson_UE5\Metadata\Crypto.json&quot;</span></span><br><span class="line">-TargetPlatform=Windows</span><br></pre></td></tr></table></figure>
<p>最小执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor-Cmd.exe</span><br><span class="line">E:\UnrealProjects\StarterContent\StarterContent.uproject</span><br><span class="line">-run=IoStore</span><br><span class="line">-CreateGlobalContainer=E:\UnrealProjects\StarterContent\Saved\StagedBuilds\WindowsNoEditor\StarterContent\Content\Paks\global.utoc</span><br><span class="line">-CookedDirectory=E:\UnrealProjects\StarterContent\Saved\Cooked\WindowsNoEditor</span><br><span class="line">-Commands=<span class="string">&quot;C:\Users\visionsmile\AppData\Roaming\Unreal Engine\AutomationTool\Logs\E+UnrealEngine+Launcher+UE_4.26\IoStoreCommands.txt&quot;</span></span><br><span class="line">-CookerOrder=<span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Build\Windows\FileOpenOrder\CookerOpenOrder.log&quot;</span></span><br><span class="line">-TargetPlatform=WindowsNoEditor</span><br></pre></td></tr></table></figure>
<p>IoStoreCommands.txt的内容为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Output=&quot;D:\ThirdPerson_UE5\Saved\StagedBuilds\Windows\ThirdPerson_UE5\Content\Paks\ThirdPerson_UE5-Windows.utoc&quot; -ContainerName=ThirdPerson_UE5 -ResponseFile=&quot;D:\PakListIoStore_ThirdPerson_UE5.txt&quot;</span><br></pre></td></tr></table></figure>

<p>创建IO Store的Log：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">LogIoStore: Display: ==================== IoStore Utils ====================</span><br><span class="line">LogIoStore: Display: Parsing crypto keys from a crypto key cache file &#x27;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows\ThirdPerson_UE5\Metadata\Crypto.json&#x27;</span><br><span class="line">LogIoStore: Display: Container signing - DISABLED</span><br><span class="line">LogIoStore: Display: Directory index - ENABLED</span><br><span class="line">LogIoStore: Display: Using memory mapping alignment &#x27;16384&#x27;</span><br><span class="line">LogIoStore: Display: Using compression block size &#x27;65536&#x27;</span><br><span class="line">LogIoStore: Display: Using compression block alignment &#x27;2048&#x27;</span><br><span class="line">LogIoStore: Display: Using max partition size &#x27;0&#x27;</span><br><span class="line">LogIoStore: Display: Using command list file: &#x27;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_5.0ea\IoStoreCommands.txt&#x27;</span><br><span class="line">LogIoStore: Display: Using target platform &#x27;Windows&#x27;</span><br><span class="line">LogIoStore: Display: Searching for cooked assets in folder &#x27;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows&#x27;</span><br><span class="line">LogIoStore: Display: Found &#x27;1342&#x27; files</span><br><span class="line">LogIoStore: Display: Loaded Bulk Data manifest &#x27;C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson_UE5\Saved\Cooked\Windows/ThirdPerson_UE5/Metadata/BulkDataInfo.ubulkmanifest&#x27;</span><br><span class="line">LogIoStore: Display: Creating container targets...</span><br><span class="line">LogIoStore: Display: Parsing packages...</span><br><span class="line">LogIoStore: Display: Reading package assets...</span><br><span class="line">LogIoStore: Display: Parsing package assets...</span><br><span class="line">LogIoStore: Display: Parsing 0/556: &#x27;C:/Users/lipengzha/Documents/Unreal Projects/ThirdPerson_UE5/Saved/Cooked/Windows/ThirdPerson_UE5/Content/ThirdPersonCPP/Chunks/BP_LightInstance.uasset&#x27;</span><br><span class="line">LogIoStore: Display: Creating global script objects...</span><br><span class="line">LogIoStore: Display: Creating global imports and exports...</span><br><span class="line">LogIoStore: Display: Converting export map import indices...</span><br><span class="line">LogIoStore: Display: Conforming localized packages...</span><br><span class="line">LogIoStore: Display: Adding localized import packages...</span><br><span class="line">LogIoStore: Display: Conforming localized imports...</span><br><span class="line">LogIoStore: Display: Adding preload dependencies...</span><br><span class="line">LogIoStore: Display: Building bundles...</span><br><span class="line">LogIoStore: Display: Finalizing name maps...</span><br><span class="line">LogIoStore: Display: Finalizing package headers...</span><br><span class="line">LogIoStore: Display: Creating disk layout...</span><br><span class="line">LogIoStore: Display: Ordered 0/556 packages using game open order</span><br><span class="line">LogIoStore: Display: Ordered 551/556 packages using cooker open order</span><br><span class="line">LogIoStore: Display: Ordered 5 packages using fallback bundle order</span><br><span class="line">LogIoStore: Display: Finalizing initial load...</span><br><span class="line">LogIoStore: Display: Serializing global meta data</span><br><span class="line">LogIoStore: Display: Saving global name map to container file</span><br><span class="line">LogIoStore: Display: Serializing container(s)...</span><br><span class="line">LogIoStore: Display: Hashed, Compressed, Serialized: 790, 790, 790 / 790</span><br><span class="line">LogIoStore: Display: Calculating stats...</span><br><span class="line">LogIoStore: Display: --------------------------------------------------- IoDispatcher --------------------------------------------------------</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Container                           Flags   TOC Size (KB)     TOC Entries       Size (MB)           Compressed (MB)</span><br><span class="line">LogIoStore: Display: -------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">LogIoStore: Display: global                            -/-/-/-            0.52               3            1.10                         -</span><br><span class="line">LogIoStore: Display: ThirdPerson_UE5-Windows           -/-/-/I          189.89             787          571.22                         -</span><br><span class="line">LogIoStore: Display: TOTAL                                              190.41             790          572.32                         -</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: ** Flags: (C)ompressed / (E)ncrypted / (S)igned) / (I)ndexed) **</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Compression block padding:     0.55 MB</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: -------------------------------------------- Container Directory Index --------------------------------------------------</span><br><span class="line">LogIoStore: Display: Container                            Size (KB)</span><br><span class="line">LogIoStore: Display: global                                    0.00</span><br><span class="line">LogIoStore: Display: ThirdPerson_UE5-Windows                  33.53</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: ---------------------------------------------- Container Patch Report ---------------------------------------------------</span><br><span class="line">LogIoStore: Display: Container                         Total (count) Modified (count)    Added (count)    Modified (MB)       Added (MB)</span><br><span class="line">LogIoStore: Display: global                                        3                0                0             0.00             0.00</span><br><span class="line">LogIoStore: Display: ThirdPerson_UE5-Windows                     787                0              787             0.00           570.67</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: --------------------------------------------------- PackageStore (KB) ---------------------------------------------------</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Container                                Store Size             Packages            Localized</span><br><span class="line">LogIoStore: Display: -------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">LogIoStore: Display: ThirdPerson_UE5                                  22                  556                    0</span><br><span class="line">LogIoStore: Display: TOTAL                                            22                  556                    0</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: --------------------------------------------------- PackageHeader (KB) --------------------------------------------------</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Container                             Header       Summary         Graph     ImportMap     ExportMap       NameMap</span><br><span class="line">LogIoStore: Display: -------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">LogIoStore: Display: ThirdPerson_UE5                          911            35            15            35           165           662</span><br><span class="line">LogIoStore: Display: TOTAL                                    911            35            15            35           165           662</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Input:    132.91 MB UExp</span><br><span class="line">LogIoStore: Display: Input:      1.12 MB UAsset</span><br><span class="line">LogIoStore: Display: Input:      0.10 MB FPackageFileSummary</span><br><span class="line">LogIoStore: Display: Input:       556 Packages</span><br><span class="line">LogIoStore: Display: Input:       641 Imported package entries</span><br><span class="line">LogIoStore: Display: Input:       327 Packages without imports</span><br><span class="line">LogIoStore: Display: Input:     26088 Name map entries</span><br><span class="line">LogIoStore: Display: Input:     10631 PreloadDependencies entries</span><br><span class="line">LogIoStore: Display: Input:      4480 ImportMap entries</span><br><span class="line">LogIoStore: Display: Input:      2342 ExportMap entries</span><br><span class="line">LogIoStore: Display: Input:       712 Public exports</span><br><span class="line">LogIoStore: Display:</span><br><span class="line">LogIoStore: Display: Output:      558 Export bundles</span><br><span class="line">LogIoStore: Display: Output:     4684 Export bundle entries</span><br><span class="line">LogIoStore: Display: Output:      641 Export bundle arcs</span><br><span class="line">LogIoStore: Display: Output:    18041 Public runtime script objects</span><br><span class="line">LogIoStore: Display: Output:     1.10 MB InitialLoadData</span><br><span class="line">LogInit: Display:</span><br><span class="line">LogInit: Display: Warning/Error Summary (Unique only)</span><br><span class="line">LogInit: Display: -----------------------------------</span><br></pre></td></tr></table></figure>

<p>引擎中mount ucas/utoc的Initialize代码在：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/PakFile/Private/IPlatformFilePak.cpp#L7136">IPlatformFilePak.cpp#L7136</a></p>
<p>FIoDispatcher也在<code>IPlatformFilePak.cpp</code>的<code>Initialize</code>中初始化：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/PakFile/Private/IPlatformFilePak.cpp#L6862">IPlatformFilePak.cpp#L6862</a></p>
<p>运行时Log：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LogIoDispatcher: Display: Reading toc: ../../../ThirdPerson_UE5/Content/Paks/global.utoc</span><br><span class="line">LogIoDispatcher: Display: Mounting container &#x27;../../../ThirdPerson_UE5/Content/Paks/global&#x27; in location slot 0</span><br><span class="line">LogPakFile: Display: Initialized I/O dispatcher</span><br><span class="line">LogPakFile: Display: Found Pak file ../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows.pak attempting to mount.</span><br><span class="line">LogPakFile: Display: Mounting pak file ../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows.pak.</span><br><span class="line">LogPakFile: PakFile PrimaryIndexSize=14754</span><br><span class="line">LogPakFile: PakFile PathHashIndexSize=37787</span><br><span class="line">LogPakFile: PakFile FullDirectoryIndexSize=36832</span><br><span class="line">LogIoDispatcher: Display: Reading toc: ../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows.utoc</span><br><span class="line">LogIoDispatcher: Display: Mounting container &#x27;../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows&#x27; in location slot 0</span><br><span class="line">LogPakFile: Display: Mounted IoStore container &quot;../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows&quot;</span><br><span class="line">LogShaderLibrary: Display: ShaderCodeLibraryPakFileMountedCallback: PakFile &#x27;../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows.pak&#x27; (chunk index -1, root &#x27;../../../&#x27;) mounted</span><br><span class="line">LogShaderLibrary: Display: ShaderCodeLibraryPakFileMountedCallback: pending pak file info (ChunkID:-1 Root:../../../ File:../../../ThirdPerson_UE5/Content/Paks/ThirdPerson_UE5-Windows.pak)</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：UE5默认开启了<code>Async Loading Thread Enabled</code>，在加载时可能会遇到Shader失败的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[2021.06.04-07.56.38:156][144]LogNet: Browse: &#x2F;Game&#x2F;StarterContent&#x2F;Maps&#x2F;StarterMap</span><br><span class="line">[2021.06.04-07.56.38:156][144]LogLoad: LoadMap: &#x2F;Game&#x2F;StarterContent&#x2F;Maps&#x2F;StarterMap</span><br><span class="line">[2021.06.04-07.56.38:156][144]LogWorld: BeginTearingDown for &#x2F;Game&#x2F;NewMap</span><br><span class="line">[2021.06.04-07.56.38:157][144]LogWorld: UWorld::CleanupWorld for NewMap, bSessionEnded&#x3D;true, bCleanupResources&#x3D;true</span><br><span class="line">[2021.06.04-07.56.38:157][144]LogSlate: InvalidateAllWidgets triggered.  All widgets were invalidated</span><br><span class="line">[2021.06.04-07.56.38:187][144]LogStreaming: Display: 0.035 ms (0.013+0.022) ms for processing 33&#x2F;149 objects in NotifyUnreachableObjects( Queued&#x3D;0, Async&#x3D;0). Removed 12&#x2F;12 (103-&gt;91 tracked) packages and 21&#x2F;21 (139-&gt;118 tracked) public exports.</span><br><span class="line">[2021.06.04-07.56.38:188][144]LogAudio: Display: Audio Device unregistered from world &#39;None&#39;.</span><br><span class="line">[2021.06.04-07.56.38:189][144]LogUObjectHash: Compacting FUObjectHashTables data took   0.54ms</span><br><span class="line">[2021.06.04-07.56.38:192][144]LogStreaming: Display: FlushAsyncLoading: 1 QueuedPackages, 0 AsyncPackages</span><br><span class="line">[2021.06.04-07.56.38:206][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0xC0782D3BC7B113E7) - Skipping non mounted imported package with id &#39;0xA6A13DDB269EBB86&#39;</span><br><span class="line">[2021.06.04-07.56.38:206][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0x18C447EA162E9CF0) - Skipping non mounted imported package with id &#39;0x592F17301901E4D4&#39;</span><br><span class="line">[2021.06.04-07.56.38:206][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0xAF2D3B82DFED12AB) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">[2021.06.04-07.56.38:206][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0x89DE226562FF0557) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">[2021.06.04-07.56.38:206][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0xFA20E9343783C7DC) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">&#x2F;&#x2F; .....</span><br><span class="line">[2021.06.04-07.56.38:207][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0xB64F7A6CD99A047) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">[2021.06.04-07.56.38:207][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0xFEFAEB73A2846157) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">[2021.06.04-07.56.38:209][144]LogStreaming: Warning: ImportPackages: SkipPackage: None (0x997474132A59335D) - Skipping non mounted imported package with id &#39;0x90DE907FA36D8947&#39;</span><br><span class="line">[2021.06.04-07.56.38:209][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Starter_Wind05 (0x5E446250F73B1FA8) - The package to load does not exist on disk or in the loader</span><br><span class="line">[2021.06.04-07.56.38:209][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Starter_Birds01 (0x724FF2357C734AD2) - The package to load does not exist on disk or in the loader</span><br><span class="line">[2021.06.04-07.56.38:209][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Starter_Wind06 (0x982833CC14F6C1E7) - The package to load does not exist on disk or in the loader</span><br><span class="line">[2021.06.04-07.56.38:209][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Collapse01 (0x938C37337F3982BF) - The package to load does not exist on disk or in the loader</span><br><span class="line">[2021.06.04-07.56.38:210][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Collapse02 (0x3820625B5DBE09A3) - The package to load does not exist on disk or in the loader</span><br><span class="line">[2021.06.04-07.56.38:213][144]LogStreaming: Warning: LoadPackage: SkipPackage: &#x2F;Game&#x2F;StarterContent&#x2F;Audio&#x2F;Starter_Music01 (0x1D0AA270D31EFC87) - The package to load does not exist on disk or in the loader</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210604164808.png"></p>
<p>在<code>Project Settings</code>-<code>Engine</code>-<code>Streaming</code>中关闭<code>Async Loading Thread Enabled</code>即可成功加载：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210604164934.png"></p>
<h2 id="4-25-2-Mac打包的metal-ar错误"><a href="#4-25-2-Mac打包的metal-ar错误" class="headerlink" title="4.25.2- Mac打包的metal-ar错误"></a>4.25.2- Mac打包的metal-ar错误</h2><p>有执行metal-ar的报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogShaders: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">UATHelper: Packaging (iOS):   LogZipArchiveWriter: Display: Closing zip file with 25491 entries.</span><br><span class="line">UATHelper: Packaging (iOS):   CookResults: Error: Package Native Shader Library failed for IOS.</span><br><span class="line">UATHelper: Packaging (iOS):   LogCook: Display: Saved scl.csv &#x2F;Users&#x2F;buildmachine&#x2F;Documents&#x2F;BuildWorkspace&#x2F;workspace&#x2F;PackageClient&#x2F;Client&#x2F;Saved&#x2F;Cooked&#x2F;IOS&#x2F;FGame&#x2F;Metadata&#x2F;PipelineCaches&#x2F;ShaderStableInfo-Global-SF_METAL.scl.csv for platform IOS</span><br><span class="line">UATHelper: Packaging (iOS):   LogCook: Display: Saved scl.csv &#x2F;Users&#x2F;buildmachine&#x2F;Documents&#x2F;BuildWorkspace&#x2F;workspace&#x2F;PackageClient&#x2F;Client&#x2F;Saved&#x2F;Cooked&#x2F;IOS&#x2F;FGame&#x2F;Metadata&#x2F;PipelineCaches&#x2F;ShaderStableInfo-FGame-SF_METAL.scl.csv for platform IOS</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: metal-ar failed with code 2: Couldn&#39;t posix_spawn: error 7</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Archiving failed: no valid input for metallib.</span><br><span class="line">PackagingResults: Error: Package Native Shader Library failed for IOS.</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141828.png"></p>
<p>引擎中调用metal-ar的代码如下：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141722.png"></p>
<p>感觉错误的问题像是传递给metal-ar的参数太长了导致的，把metal-ar参数打出来发现确实非常长：<br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210603141944.png"></p>
<p>解决办法，把在Mac上<code>GetMaxArgLength</code>的返回值改成一个较小的值或者从环境变量中获取即可：</p>
<figure class="highlight cpp"><figcaption><span>Developer\Apple\MetalShaderFormat\Private\MetalShaderCompiler.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">GetMaxArgLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">  <span class="comment">// 引擎中原始代码为返回ARG_MAX</span></span><br><span class="line">  <span class="comment">// return ARG_MAX;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">4096</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// Ask the remote machine via &quot;getconf ARG_MAX&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在官方版本的4.25.2中已经修复：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/6c47cef5a9349fe8c9ac7d3445c74fd948a507ad">Use runtime evaluation of ARG_MAX instead of the compile-time constant (which in Xcode 12 is now 1m)</a></p>
<figure class="highlight cpp"><figcaption><span>Developer\Apple\MetalShaderFormat\Private\MetalShaderCompiler.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint32 <span class="title">GetMaxArgLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">    <span class="keyword">static</span> uint32 MaxLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!MaxLength)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s dangerous to use &quot;ARG_MAX&quot; directly because it&#x27;s a compile time constant and may not be compatible with the running OS.</span></span><br><span class="line">        <span class="comment">// It&#x27;s safer to get the number from &quot;getconf ARG_MAX&quot; and only use the constant as the fallback</span></span><br><span class="line">        FString StdOut, StdError;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ExecRemoteProcess</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/usr/bin/getconf&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ARG_MAX&quot;</span>), <span class="literal">nullptr</span>, &amp;StdOut, &amp;StdError))</span><br><span class="line">        &#123;</span><br><span class="line">            MaxLength = FCString::<span class="built_in">Atoi</span>(*StdOut);</span><br><span class="line">            <span class="built_in">check</span>(MaxLength &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogMetalShaderCompiler, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Set MaxArgLength to %d via getconf&quot;</span>), MaxLength);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            MaxLength = FMath::<span class="built_in">Min</span>(ARG_MAX, <span class="number">256</span> * <span class="number">1024</span>);</span><br><span class="line">            <span class="built_in">UE_LOG</span>(LogMetalShaderCompiler, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to determine MaxArgLength via getconf: %s\nSet it to %d which is the lesser of MAX_ARG and the value from the 10.15 SDK&quot;</span>), *StdError, MaxLength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MaxLength;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">// Ask the remote machine via &quot;getconf ARG_MAX&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关闭UnityBuild"><a href="#关闭UnityBuild" class="headerlink" title="关闭UnityBuild"></a>关闭UnityBuild</h2><p>默认情况下，UE默认开启了<code>bUseUnityBuild</code>，会把多个cpp合并成一个翻译单元进行编译，加快项目的编译速度，编译时有<code>*_1_of_8.cpp.obj</code>等log。所以如果项目的头文件包含不规范，编译时头文件检测可能会出现问题：修改了A文件导致B文件出现错误。</p>
<p>所以，想在检测出中这种错误，可以关闭<code>UnityBuild</code>，使每个cpp都作为单独的翻译单元编译，有两种方法：</p>
<ol>
<li>对整个工程（包含插件）关闭<code>bUseUnityBuild</code>，在项目的Target.cs中添加</li>
</ol>
<figure class="highlight cpp"><figcaption><span>target.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bForceUnityBuild = <span class="literal">false</span>;</span><br><span class="line">bUseUnityBuild = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>不修改代码，也可以在BuildCongiguration.xml中配置关闭：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to unify C++ code into larger files for faster compilation.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-DisableUnity&quot;</span>, Value = <span class="meta-string">&quot;false&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bUseUnityBuild = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to force C++ source files to be combined into larger files for faster compilation.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ForceUnity&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bForceUnityBuild = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>对单个模块关闭<code>UnityBuild</code>，在Build.cs中关闭</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bUseUnity = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>可以在<code>Target.cs</code>中指定关闭UnityBuild的模块，也可以配置在<code>BuildConfiguration.xml</code>中：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> List of modules to disable unity builds for</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;ModuleConfiguration&quot;</span>, Name = <span class="meta-string">&quot;DisableUnityBuild&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>[] DisableUnityBuildForModules = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>可以在<code>Intermediate\Build\Win64\UE4Editor\Development\Client</code>等路径下看到生成的大量<code>.response</code>文件。</p>
<h2 id="TextureStreaming"><a href="#TextureStreaming" class="headerlink" title="TextureStreaming"></a>TextureStreaming</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/RenderingAndGraphics/Textures/Streaming/Config/">Texture Streaming Configuration</a></li>
</ul>
<figure class="highlight cpp"><figcaption><span>Runtime\Engine\Private\Streaming\TextureStreamingHelpers.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_SUPPORTS_TEXTURE_STREAMING</span></span><br><span class="line"><span class="function">TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarSetTextureStreaming</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;r.TextureStreaming&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Allows to define if texture streaming is enabled, can be changed at run time.\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;0: off\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;1: on (default)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_Default | ECVF_RenderThreadSafe)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>引擎中的默认配置：</p>
<figure class="highlight ini"><figcaption><span>Engine/Config/BaseScalability.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[TextureQuality@0]</span></span><br><span class="line"><span class="comment">; Must be used with r.streaming.usepertexturebias set to 1. Otherwise, all textures will have a constant 16 mip bias</span></span><br><span class="line"><span class="attr">r.Streaming.MipBias</span>=<span class="number">16</span></span><br><span class="line"><span class="attr">r.Streaming.AmortizeCPUToGPUCopy</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.MaxNumTexturesToStreamPerFrame</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.Boost</span>=<span class="number">0.3</span></span><br><span class="line"><span class="attr">r.MaxAnisotropy</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.VT.MaxAnisotropy</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">r.Streaming.LimitPoolSizeToVRAM</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.PoolSize</span>=<span class="number">400</span></span><br><span class="line"><span class="attr">r.Streaming.MaxEffectiveScreenSize</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TextureQuality@1]</span></span><br><span class="line"><span class="attr">r.Streaming.MipBias</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.AmortizeCPUToGPUCopy</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.MaxNumTexturesToStreamPerFrame</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.Boost</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.MaxAnisotropy</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">r.VT.MaxAnisotropy</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">r.Streaming.LimitPoolSizeToVRAM</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.PoolSize</span>=<span class="number">600</span></span><br><span class="line"><span class="attr">r.Streaming.MaxEffectiveScreenSize</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TextureQuality@2]</span></span><br><span class="line"><span class="attr">r.Streaming.MipBias</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.AmortizeCPUToGPUCopy</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.MaxNumTexturesToStreamPerFrame</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.Boost</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.MaxAnisotropy</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">r.VT.MaxAnisotropy</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">r.Streaming.LimitPoolSizeToVRAM</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.Streaming.PoolSize</span>=<span class="number">800</span></span><br><span class="line"><span class="attr">r.Streaming.MaxEffectiveScreenSize</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TextureQuality@3]</span></span><br><span class="line"><span class="attr">r.Streaming.MipBias</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.AmortizeCPUToGPUCopy</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.MaxNumTexturesToStreamPerFrame</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.Boost</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.MaxAnisotropy</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">r.VT.MaxAnisotropy</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">r.Streaming.LimitPoolSizeToVRAM</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.PoolSize</span>=<span class="number">1000</span></span><br><span class="line"><span class="attr">r.Streaming.MaxEffectiveScreenSize</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TextureQuality@Cine]</span></span><br><span class="line"><span class="attr">r.Streaming.MipBias</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.AmortizeCPUToGPUCopy</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.MaxNumTexturesToStreamPerFrame</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.Boost</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">r.MaxAnisotropy</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">r.VT.MaxAnisotropy</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">r.Streaming.LimitPoolSizeToVRAM</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">r.Streaming.PoolSize</span>=<span class="number">3000</span></span><br><span class="line"><span class="attr">r.Streaming.MaxEffectiveScreenSize</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="PackagePath获取资源磁盘路径"><a href="#PackagePath获取资源磁盘路径" class="headerlink" title="PackagePath获取资源磁盘路径"></a>PackagePath获取资源磁盘路径</h2><p>从<code>/Game/Texture/TextureBG</code>获取uasset在本地磁盘的路径。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FString LongPackageName = <span class="built_in">TEXT</span>(<span class="string">&quot;/Game/Texture/TextureBG&quot;</span>)</span><br><span class="line">TArray&lt;FAssetData&gt; AssetsData;</span><br><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetAssetsByPackageName</span>(*LongPackageName, AssetsData, <span class="literal">true</span>);</span><br><span class="line">UPackage* Package = AssetsData[index].<span class="built_in">GetPackage</span>();</span><br><span class="line">FString AssetDiskPath;</span><br><span class="line"><span class="keyword">const</span> FString* PackageExtension = Package-&gt;<span class="built_in">ContainsMap</span>() ? &amp;FPackageName::<span class="built_in">GetMapPackageExtension</span>() : &amp;FPackageName::<span class="built_in">GetAssetPackageExtension</span>();</span><br><span class="line">FPackageName::<span class="built_in">TryConvertLongPackageNameToFilename</span>(AssetsData[<span class="number">0</span>].PackageName.<span class="built_in">ToString</span>(), AssetDiskPath, *PackageExtension);</span><br></pre></td></tr></table></figure>

<h2 id="关闭PCH"><a href="#关闭PCH" class="headerlink" title="关闭PCH"></a>关闭PCH</h2><p>在TargetRules.cs中有<code>bUsePCHFiles</code>和<code>bUseSharedPCHs</code>两个选项，可以控制项目是否开启PCH：</p>
<figure class="highlight cpp"><figcaption><span>UnrealBuildTool\Configuration\TargetRules.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Whether PCH files should be used.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-NoPCH&quot;</span>, Value = <span class="string">&quot;false&quot;</span>)]</span><br><span class="line">[<span class="built_in">XmlConfigFile</span>(Category = <span class="string">&quot;BuildConfiguration&quot;</span>)]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bUsePCHFiles = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Enables &quot;Shared PCHs&quot;, a feature which significantly speeds up compile times by attempting to</span></span><br><span class="line"><span class="comment">/// share certain PCH files between modules that UBT detects is including those PCH&#x27;s header files.</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">[<span class="built_in">CommandLine</span>(<span class="string">&quot;-NoSharedPCH&quot;</span>, Value = <span class="string">&quot;false&quot;</span>)]</span><br><span class="line">[<span class="built_in">XmlConfigFile</span>(Category = <span class="string">&quot;BuildConfiguration&quot;</span>)]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bUseSharedPCHs = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>但是为了不改动代码，也可以通过<code>BuildConfiguration.xml</code>中的设置：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\UnrealBuildTool\BuildConfiguration.xml</span><br><span class="line">F:\EngineSource\UE_4.26\Engine\Saved\UnrealBuildTool\BuildConfiguration.xml</span><br></pre></td></tr></table></figure>
<p>这两个路径下的均可，在<code>Configuration</code>下的<code>BuildConfiguration</code>中添加以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://docs.unrealengine.com/4.26/en-US/ProductionPipelines/BuildTools/UnrealBuildTool/BuildConfiguration/&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bUsePCHFiles</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bUsePCHFiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bUseSharedPCHs</span>&gt;</span>false<span class="tag">&lt;/<span class="name">bUseSharedPCHs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多的参数可以在<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/ProductionPipelines/BuildTools/UnrealBuildTool/BuildConfiguration/">Build Configuration</a>查看。</p>
<h2 id="源码版与安装版IOS数据路径差异"><a href="#源码版与安装版IOS数据路径差异" class="headerlink" title="源码版与安装版IOS数据路径差异"></a>源码版与安装版IOS数据路径差异</h2><p>使用安装版引擎打包IOS时，开启FileSharing能够在通过工具访问程序的<code>Document</code>目录，里面类似Android的UE4Game目录结构。<br>但是当使用源码版引擎打包时，开启FileSharing的包，UE的数据目录并不在<code>Document</code>目录下，因为项目配置没有任何更改，怀疑是引擎中有些地方对源码版或安装版做了检测。<br>搜索代码发现，引擎中通过<code>FILESHARING_ENABLED</code>宏进行检测，当开启时，数据目录位于<code>Library</code>目录下，没有开启时则位于<code>Document</code>目录下。</p>
<figure class="highlight cpp"><figcaption><span>Core/Private/IOS/IOSPlatformMisc.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FIOSPlatformMisc::PlatformInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FILESHARING_ENABLED</span></span><br><span class="line">  FString DownloadPath = <span class="built_in">FString</span>([<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(NSLibraryDirectory, NSUserDomainMask, YES) objectAtIndex:<span class="number">0</span>]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  FString DownloadPath = <span class="built_in">FString</span>([<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(NSDocumentDirectory, NSUserDomainMask, YES) objectAtIndex:<span class="number">0</span>]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏由UBT生成，通过读取<code>DefaultEngine.ini</code>中<code>[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</code>下的<code>bSupportsITunesFileSharing</code>来确定宏的值。</p>
<figure class="highlight csharp"><figcaption><span>Source/Programs/UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Stores project-specific IOS settings. Instances of this object are cached by IOSPlatform.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOSProjectSettings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> true if iTunes file sharing support is enabled</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  [<span class="meta">ConfigFile(ConfigHierarchyType.Engine, <span class="meta-string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="meta-string">&quot;bSupportsITunesFileSharing&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">bool</span> bFileSharingEnabled = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加宏的代码如下：</p>
<figure class="highlight csharp"><figcaption><span>Source/Programs/UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Setup the target environment for building</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>Settings for the target being compiled<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CompileEnvironment&quot;&gt;</span>The compile environment for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;LinkEnvironment&quot;&gt;</span>The link environment for this target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetUpEnvironment</span>(<span class="params">ReadOnlyTargetRules Target, CppCompileEnvironment CompileEnvironment, LinkEnvironment LinkEnvironment</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (ProjectSettings.bFileSharingEnabled)</span><br><span class="line">  &#123;</span><br><span class="line">    CompileEnvironment.Definitions.Add(<span class="string">&quot;FILESHARING_ENABLED=1&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CompileEnvironment.Definitions.Add(<span class="string">&quot;FILESHARING_ENABLED=0&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因分析：</p>
<ol>
<li>因为编译安装版引擎时，没有项目，引擎中<code>BaseEngine.ini</code>中<code>bSupportsITunesFileSharing=False</code>，所以通过BuildGraph编译安装版引擎时，<code>bFileSharingEnabled</code>默认值是false，通过安装版引擎打包项目引擎也不会编译了，所以<code>bFileSharingEnabled</code>的值一直是false，使用的是NSDocumentDirectory目录</li>
<li>相同的道理，使用源码版引擎打包项目时，因为需要通过打包项目才编译引擎，如果项目中指定了<code>bSupportsITunesFileSharing=True</code>，则编译引擎时<code>bFileSharingEnabled</code>就为true，导致<code>FILESHARING_ENABLED=1</code>，则使用了<code>NSLibraryDirectory</code>目录。</li>
</ol>
<p>需要注意的是：<code>bSupportsITunesFileSharing</code>不仅仅只是控制数据存储路径，还控制打包时plist的生成：</p>
<figure class="highlight csharp"><figcaption><span>Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GenerateIOSPList</span>(<span class="params">FileReference ProjectFile, UnrealTargetConfiguration Config, <span class="built_in">string</span> ProjectDirectory, <span class="built_in">bool</span> bIsUE4Game, <span class="built_in">string</span> GameName, <span class="built_in">bool</span> bIsClient, <span class="built_in">string</span> ProjectName, <span class="built_in">string</span> InEngineDir, <span class="built_in">string</span> AppDirectory, VersionNumber SdkVersion, UnrealPluginLanguage UPL, <span class="built_in">string</span> BundleID, <span class="built_in">bool</span> bBuildAsFramework, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsPortrait, <span class="keyword">out</span> <span class="built_in">bool</span> bSupportsLandscape, <span class="keyword">out</span> <span class="built_in">bool</span> bSkipIcons</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ITunes file sharing</span></span><br><span class="line">  <span class="built_in">bool</span> bSupportsITunesFileSharing = <span class="literal">false</span>;</span><br><span class="line">  Ini.GetBool(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="string">&quot;bSupportsITunesFileSharing&quot;</span>, <span class="keyword">out</span> bSupportsITunesFileSharing);</span><br><span class="line">  <span class="built_in">bool</span> bSupportsFilesApp = <span class="literal">false</span>;</span><br><span class="line">  Ini.GetBool(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>, <span class="string">&quot;bSupportsFilesApp&quot;</span>, <span class="keyword">out</span> bSupportsFilesApp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  Text.AppendLine(<span class="string">&quot;\t&lt;key&gt;UIFileSharingEnabled&lt;/key&gt;&quot;</span>);</span><br><span class="line">  Text.AppendLine(<span class="built_in">string</span>.Format(<span class="string">&quot;\t&lt;&#123;0&#125;/&gt;&quot;</span>, bSupportsITunesFileSharing ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (bSupportsFilesApp)</span><br><span class="line">  &#123;</span><br><span class="line">    Text.AppendLine(<span class="string">&quot;\t&lt;key&gt;LSSupportsOpeningDocumentsInPlace&lt;/key&gt;&quot;</span>);</span><br><span class="line">    Text.AppendLine(<span class="string">&quot;\t&lt;true/&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，为了同时支持数据存储在<code>Document</code>下和开启plist中的<code>UIFileSharingEnabled</code>，对于FileSharing功能的支持需要进行以下操作：</p>
<ol>
<li><code>DefaultEngine.ini</code>中的<code>bSupportsITunesFileSharing=False</code></li>
<li>修改引擎中生成<code>FILESHARING_ENABLED</code>宏的代码，保持为false即可</li>
</ol>
<h2 id="Viveport选中Actor按F调用函数"><a href="#Viveport选中Actor按F调用函数" class="headerlink" title="Viveport选中Actor按F调用函数"></a>Viveport选中Actor按F调用函数</h2><p>在编辑器中选中一个Actor，按F键，当前的编辑器视口会移动到Actor，调用的是这些函数：</p>
<figure class="highlight cpp"><figcaption><span>Editor\UnrealEd\Classes\Editor\EditorEngine.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Moves all viewport cameras to the target actor.</span></span><br><span class="line"><span class="comment">* @param  Actor         Target actor.</span></span><br><span class="line"><span class="comment">* @param  bActiveViewportOnly   If true, move/reorient only the active viewport.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveViewportCamerasToActor</span><span class="params">(AActor&amp; Actor,  <span class="keyword">bool</span> bActiveViewportOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Moves all viewport cameras to focus on the provided array of actors.</span></span><br><span class="line"><span class="comment">* @param  Actors          Target actors.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* @param  bActiveViewportOnly   If true, move/reorient only the active viewport.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveViewportCamerasToActor</span><span class="params">(<span class="keyword">const</span> TArray&lt;AActor*&gt; &amp;Actors, <span class="keyword">bool</span> bActiveViewportOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Moves all viewport cameras to focus on the provided array of actors.</span></span><br><span class="line"><span class="comment">* @param  Actors          Target actors.</span></span><br><span class="line"><span class="comment">* @param  Components        Target components (used of actors array is empty)</span></span><br><span class="line"><span class="comment">* @param  bActiveViewportOnly   If true, move/reorient only the active viewport.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveViewportCamerasToActor</span><span class="params">(<span class="keyword">const</span> TArray&lt;AActor*&gt; &amp;Actors, <span class="keyword">const</span> TArray&lt;UPrimitiveComponent*&gt;&amp; Components, <span class="keyword">bool</span> bActiveViewportOnly)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="Searchable-Names"><a href="#Searchable-Names" class="headerlink" title="Searchable Names"></a>Searchable Names</h2><p>在UE的资源依赖关系中，除了<code>Hard</code>/<code>Soft</code>之外，还有一种<code>Searchable Name</code>，排查之后发现GamePlayTag标记的是SearchableName的类型：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210521205127.png"><br><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210521205026.png"></p>
<p>因为在C++中加载资源是直接指定路径的，所以在想有没有一种办法，通过C++加载，也可以分析出代码中加载资源的依赖关系，作为一种思路，先记录一下。</p>
<h2 id="基础包过滤config中的ini文件"><a href="#基础包过滤config中的ini文件" class="headerlink" title="基础包过滤config中的ini文件"></a>基础包过滤config中的ini文件</h2><p>打包时会有以下Log：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Windows (64-bit)): Creating Staging Manifest...</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BaseEditor.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BaseEditorKeyBindings.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BaseEditorPerProjectUserSettings.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BaseEditorSettings.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BaseLightmass.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\BasePakFileRules.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\Category.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\Editor.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\EditorTutorials.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\Engine.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\Keywords.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\PortableObjectExport.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\PortableObjectImport.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\PropertyNames.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\RepairData.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\ToolTips.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\build_agent\workspace\FGameEngine\Engine\Engine\Config\Localization\WordCount.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): WARNING: The config file &#x27;FGame/Config/DefaultAssetTags.ini&#x27; will be staged, but is not whitelisted or blacklisted. Add +WhitelistConfigFiles=FGame/Config/DefaultAssetTags.ini or +BlacklistConfigFiles=FGame/Config/DefaultAssetTags.ini to the [Staging] section of DefaultGame.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Excluding config file C:\Users\lipengzha\Documents\UnrealProjects\Client\Config\DefaultEditor.ini</span><br><span class="line">UATHelper: Packaging (Windows (64-bit)): Cleaning Stage Directory: C:\Users\lipengzha\Documents\UnrealProjects\Client\Saved\StagedBuilds\WindowsNoEditor</span><br></pre></td></tr></table></figure>
<p>根据上面的提示，可以在<code>DefaultGame.ini</code>中通过设置<code>[Staging]</code>中的值来控制白名单与黑名单：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Staging]</span></span><br><span class="line">+WhitelistConfigFiles=FGame/Config/DefaultAssetTags.ini</span><br><span class="line">+BlacklistConfigFiles=FGame/Config/DefaultAssetTags.ini</span><br></pre></td></tr></table></figure>
<p>引擎中打包时有一个默认的规则，代码如下：</p>
<figure class="highlight csharp"><figcaption><span>Source\Programs\AutomationTool\Scripts\CopyBuildToStagingDirectory.Automation.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines if an individual config file should be staged</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span>The staging context<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigDir&quot;&gt;</span>Directory containing the config files<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigFile&quot;&gt;</span>The config file to check<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if the file should be staged, false otherwise<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> Nullable &lt; <span class="built_in">bool</span> &gt; ShouldStageConfigFile(DeploymentContext SC, DirectoryReference ConfigDir, FileReference ConfigFile, <span class="built_in">string</span> PlatformExtensionName) &#123;</span><br><span class="line">  StagedFileReference StagedConfigFile = SC.GetStagedFileLocation(ConfigFile);</span><br><span class="line">  <span class="keyword">if</span> (SC.WhitelistConfigFiles.Contains(StagedConfigFile)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (SC.BlacklistConfigFiles.Contains(StagedConfigFile)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">string</span> NormalizedPath = ConfigFile.MakeRelativeTo(ConfigDir).ToLowerInvariant().Replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> DirectoryIdx = NormalizedPath.IndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (DirectoryIdx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> BasePrefix = <span class="string">&quot;base&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(BasePrefix)) &#123;</span><br><span class="line">      <span class="built_in">string</span> ShortName = NormalizedPath.Substring(BasePrefix.Length);</span><br><span class="line">      <span class="keyword">if</span> (PlatformExtensionName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ShortName.StartsWith(PlatformExtensionName, StringComparison.InvariantCultureIgnoreCase)) &#123;</span><br><span class="line">          <span class="comment">// Ignore config files in the platform directory that don&#x27;t start with the platform name.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ShortName = ShortName.Substring(PlatformExtensionName.Length);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> ShouldStageConfigSuffix(SC, ConfigFile, ShortName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> DefaultPrefix = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(DefaultPrefix)) &#123;</span><br><span class="line">      <span class="built_in">string</span> ShortName = NormalizedPath.Substring(DefaultPrefix.Length);</span><br><span class="line">      <span class="keyword">if</span> (PlatformExtensionName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ShortName.StartsWith(PlatformExtensionName, StringComparison.InvariantCultureIgnoreCase)) &#123;</span><br><span class="line">          <span class="comment">// Ignore config files in the platform directory that don&#x27;t start with the platform name.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ShortName = ShortName.Substring(PlatformExtensionName.Length);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> ShouldStageConfigSuffix(SC, ConfigFile, ShortName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> DedicatedServerPrefix = <span class="string">&quot;dedicatedserver&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(DedicatedServerPrefix)) &#123;</span><br><span class="line">      <span class="keyword">return</span> SC.DedicatedServer ? ShouldStageConfigSuffix(SC, ConfigFile, NormalizedPath.Substring(DedicatedServerPrefix.Length)) : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath == <span class="string">&quot;consolevariables.ini&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> SC.StageTargetConfigurations.Any(x = &gt;x != UnrealTargetConfiguration.Test &amp;&amp; x != UnrealTargetConfiguration.Shipping);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath == <span class="string">&quot;locgatherconfig.ini&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath == <span class="string">&quot;designertoolsconfig.ini&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PlatformExtensionName != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (NormalizedPath.StartsWith(PlatformExtensionName, StringComparison.InvariantCultureIgnoreCase)) &#123;</span><br><span class="line">        <span class="built_in">string</span> ShortName = NormalizedPath.Substring(PlatformExtensionName.Length);</span><br><span class="line">        <span class="keyword">return</span> ShouldStageConfigSuffix(SC, ConfigFile, ShortName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (NormalizedPath == <span class="string">&quot;datadrivenplatforminfo.ini&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(<span class="string">&quot;layouts/&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(<span class="string">&quot;localization/&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> PlatformPrefix = String.Format(<span class="string">&quot;&#123;0&#125;/&#123;0&#125;&quot;</span>, NormalizedPath.Substring(<span class="number">0</span>, DirectoryIdx));</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(PlatformPrefix)) &#123;</span><br><span class="line">      <span class="keyword">return</span> ShouldStageConfigSuffix(SC, ConfigFile, NormalizedPath.Substring(PlatformPrefix.Length));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> PlatformBasePrefix = String.Format(<span class="string">&quot;&#123;0&#125;/base&#123;0&#125;&quot;</span>, NormalizedPath.Substring(<span class="number">0</span>, DirectoryIdx));</span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.StartsWith(PlatformBasePrefix)) &#123;</span><br><span class="line">      <span class="keyword">return</span> ShouldStageConfigSuffix(SC, ConfigFile, NormalizedPath.Substring(PlatformBasePrefix.Length));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NormalizedPath.EndsWith(<span class="string">&quot;/datadrivenplatforminfo.ini&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines if the given config file suffix (&quot;engine&quot;, &quot;game&quot;, etc...) should be staged for the given context.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span>The staging context<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigFile&quot;&gt;</span>Full path to the config file<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;InvariantSuffix&quot;&gt;</span>Suffix for the config file, as a lowercase invariant string<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if the suffix should be staged, false if not, null if unknown<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> Nullable &lt; <span class="built_in">bool</span> &gt; ShouldStageConfigSuffix(DeploymentContext SC, FileReference ConfigFile, <span class="built_in">string</span> InvariantSuffix) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (InvariantSuffix) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;compat.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;deviceprofiles.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;engine.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;enginechunkoverrides.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;game.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;gameplaytags.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;gameusersettings.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;hardware.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;input.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;scalability.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;runtimeoptions.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;installbundle.ini&quot;</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;crypto.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editor.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorgameagnostic.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorkeybindings.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorlayout.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorperprojectusersettings.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorsettings.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;editorusersettings.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;lightmass.ini&quot;</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;pakfilerules.ini&quot;</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="literal">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="t-MaxFPS启动时无效"><a href="#t-MaxFPS启动时无效" class="headerlink" title="t.MaxFPS启动时无效"></a>t.MaxFPS启动时无效</h2><p>之前在游戏启动时设置锁帧：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">t.MaxFPS</span>=<span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>但是发现在目前的引擎版本无效了，从Log里看出来确实从配置中读取了这个值，但是游戏中帧率无变化，所以猜测是哪里又把帧率给改了。</p>
<p>调试后发现，引擎启动时从GameUserSetting读取并执行了SetMaxFPS：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210517215352.png"></p>
<p>所以，正确的办法是设置<code>DefaultGameUserSettings.ini</code>里的<code>FrameRateLimit</code>值：</p>
<figure class="highlight ini"><figcaption><span>DefaultGameUserSettings.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.GameUserSettings]</span></span><br><span class="line"><span class="attr">FrameRateLimit</span>=<span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>如果写在<code>DefaultGameUserSetting.ini</code>中，无论是编辑器或者任何打包的平台，默认都是锁帧，如果想要针对某个平台锁帧，可以将其写到特定平台的<code>*GameUserSettings.ini</code>中：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Config/Android/AndroidGameUserSettings.ini</span><br><span class="line">Config/IOS/IOSGameUserSettings.ini</span><br><span class="line">Config/Windows/WindowsGameUserSettings.ini</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/790307/frameratelock-configuration-for-android.html">‘FrameRateLock’ configuration for Android</a></li>
</ul>
<h2 id="UE执行py的Commandlet"><a href="#UE执行py的Commandlet" class="headerlink" title="UE执行py的Commandlet"></a>UE执行py的Commandlet</h2><p>把Py脚本放入<code>Content/Python</code>下，使用Commandlet的形式执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT.uproject -run=pythonscript -script=NavMeshExporter.py</span><br></pre></td></tr></table></figure>

<p>一个脚本例子：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unreal</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  do_something()</span><br></pre></td></tr></table></figure>

<h2 id="设置ConsoleVariables值的几种方式"><a href="#设置ConsoleVariables值的几种方式" class="headerlink" title="设置ConsoleVariables值的几种方式"></a>设置ConsoleVariables值的几种方式</h2><ol>
<li>修改引擎Config/ConsoleVariables.ini</li>
<li>修改引擎(<code>BaseEngine.ini</code>)/项目(<code>DefaultEngine.ini</code>)中的<code>[SystemSettings]</code></li>
<li>运行时console输入</li>
<li>编辑Device Profiles</li>
</ol>
<p>运行时通过<code>FConsoleManager</code>获取/修改：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IConsoleVariable* CVar = IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">FindConsoleVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;r.Shadow.MinResolution&quot;</span>));</span><br><span class="line">CVar-&gt;<span class="built_in">Set</span>(<span class="number">16</span>, SetBy);</span><br></pre></td></tr></table></figure>
<p><code>Set</code>有几个重载:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Set the internal value from the specified bool. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Set</span><span class="params">(<span class="keyword">bool</span> InValue, EConsoleVariableFlags SetBy = ECVF_SetByCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> Bool needs to use 1 and 0 here rather than true/false, as this may be a int32 or something</span></span><br><span class="line">  <span class="comment">// and eventually this code calls, TTypeFromString&lt;T&gt;::FromString which won&#x27;t handle the true/false,</span></span><br><span class="line">  <span class="comment">// but 1 and 0 will work for whatever.</span></span><br><span class="line">  <span class="comment">// inefficient but no common code path</span></span><br><span class="line">  <span class="built_in">Set</span>(InValue ? <span class="built_in">TEXT</span>(<span class="string">&quot;1&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;0&quot;</span>), SetBy);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** Set the internal value from the specified int. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Set</span><span class="params">(int32 InValue, EConsoleVariableFlags SetBy = ECVF_SetByCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// inefficient but no common code path</span></span><br><span class="line">  <span class="built_in">Set</span>(*FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%d&quot;</span>), InValue), SetBy);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** Set the internal value from the specified float. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Set</span><span class="params">(<span class="keyword">float</span> InValue, EConsoleVariableFlags SetBy = ECVF_SetByCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// inefficient but no common code path</span></span><br><span class="line">  <span class="built_in">Set</span>(*FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%g&quot;</span>), InValue), SetBy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个参数为<code>EConsoleVariableFlags</code>：</p>
<figure class="highlight cpp"><figcaption><span>HAL/IConsoleManager.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EConsoleVariableFlags</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ECVF_FlagMask                    = <span class="number">0x0000ffff</span>,</span><br><span class="line">    ECVF_Default                     = <span class="number">0x0</span>,</span><br><span class="line">    ECVF_Cheat                       = <span class="number">0x1</span>,</span><br><span class="line">    ECVF_ReadOnly                    = <span class="number">0x4</span>,</span><br><span class="line">    ECVF_Unregistered                = <span class="number">0x8</span>,</span><br><span class="line">    ECVF_CreatedFromIni              = <span class="number">0x10</span>,</span><br><span class="line">    ECVF_RenderThreadSafe            = <span class="number">0x20</span>,</span><br><span class="line">    ECVF_Scalability                 = <span class="number">0x40</span>,</span><br><span class="line">    ECVF_ScalabilityGroup            = <span class="number">0x80</span>,</span><br><span class="line">    ECVF_SetFlagMask                 = <span class="number">0x00ff0000</span>,</span><br><span class="line">    ECVF_Set_NoSinkCall_Unsafe       = <span class="number">0x00010000</span>,</span><br><span class="line">    ECVF_SetByMask                   = <span class="number">0xff000000</span>,</span><br><span class="line">    ECVF_SetByConstructor            = <span class="number">0x00000000</span>,</span><br><span class="line">    ECVF_SetByScalability            = <span class="number">0x01000000</span>,</span><br><span class="line">    ECVF_SetByGameSetting            = <span class="number">0x02000000</span>,</span><br><span class="line">    ECVF_SetByProjectSetting         = <span class="number">0x03000000</span>,</span><br><span class="line">    ECVF_SetBySystemSettingsIni      = <span class="number">0x04000000</span>,</span><br><span class="line">    ECVF_SetByDeviceProfile          = <span class="number">0x05000000</span>,</span><br><span class="line">    ECVF_SetByConsoleVariablesIni    = <span class="number">0x06000000</span>,</span><br><span class="line">    ECVF_SetByCommandline            = <span class="number">0x07000000</span>,</span><br><span class="line">    ECVF_SetByCode                   = <span class="number">0x08000000</span>,</span><br><span class="line">    ECVF_SetByConsole                = <span class="number">0x09000000</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="debug-shader-compile"><a href="#debug-shader-compile" class="headerlink" title="debug shader compile"></a>debug shader compile</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/tech-blog/debugging-the-shader-compiling-process?sessionInvalidated=true">Debugging the Shader Compiling Process</a></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Startup]</span></span><br><span class="line"><span class="comment">; Uncomment to get detailed logs on shader compiles and the opportunity to retry on errors</span></span><br><span class="line"><span class="attr">r.ShaderDevelopmentMode</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">; Uncomment to dump shaders in the Saved folder (1 dump all, 2 dump on compilation failure only, 3 dump on compilation failure or warnings)</span></span><br><span class="line"><span class="comment">; Warning: leaving this on for a while will fill your hard drive with many small files and folders</span></span><br><span class="line"><span class="attr">r.DumpShaderDebugInfo</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">; When this is enabled, dumped shader paths will get collapsed (in the cases where paths are longer than the OS&#x27;s max)</span></span><br><span class="line"><span class="attr">r.DumpShaderDebugShortNames</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">; When this is enabled, when dumping shaders an additional file to use with ShaderCompilerWorker -direct mode will be generated</span></span><br><span class="line"><span class="attr">r.DumpShaderDebugWorkerCommandLine</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="移动平台纹理压缩格式"><a href="#移动平台纹理压缩格式" class="headerlink" title="移动平台纹理压缩格式"></a>移动平台纹理压缩格式</h2><p>Android有ETC1/ETC2/ASTC。<br>IOS有ASTC/PVRTC，ASTC从A8开始支持。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/96468920">移动平台纹理压缩格式选择</a></li>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/100055">移动设备的纹理压缩方案</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/65223528">IOS游戏的资源方案</a></li>
</ul>
<h2 id="控制打包的log-level"><a href="#控制打包的log-level" class="headerlink" title="控制打包的log level"></a>控制打包的log level</h2><p>在非shipping模式下可以通过<code>-LogCmds</code>指定:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-LogCmds=&quot;global Verbose, LogPython Verbose, LogAnimMontage off, LogDeepDriveAgent VeryVerbose&quot;</span><br></pre></td></tr></table></figure>
<p>也可以在<code>DefaultEngine.ini</code>中进行控制：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Core.Log]</span></span><br><span class="line"><span class="attr">global</span>=[default verbosity for things not listed later]</span><br><span class="line">[cat]=[level]</span><br><span class="line"><span class="attr">foo</span>=verbose break</span><br></pre></td></tr></table></figure>
<p>配置参数的使用:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">------- Log conventions</span><br><span class="line">[cat]   = a category for the command to operate on, or &#x27;global&#x27; for all categories.</span><br><span class="line">[level] = verbosity level, one of: none, error, warning, display, log, verbose, all, default</span><br><span class="line">At boot time, compiled in default is overridden by ini files setting, which is overridden by command line</span><br><span class="line">------- Log console command usage</span><br><span class="line">Log list            - list all log categories</span><br><span class="line">Log list [string]   - list all log categories containing a substring</span><br><span class="line">Log reset           - reset all log categories to their boot-time default</span><br><span class="line">Log [cat]           - toggle the display of the category [cat]</span><br><span class="line">Log [cat] off       - disable display of the category [cat]</span><br><span class="line">Log [cat] on        - resume display of the category [cat]</span><br><span class="line">Log [cat] only      - enables [cat] and disables all other categories&quot;));</span><br><span class="line">Log [cat] [level]   - set the verbosity level of the category [cat]</span><br><span class="line">Log [cat] break     - toggle the debug break on display of the category [cat]</span><br><span class="line">------- Log command line</span><br><span class="line">-LogCmds=\&quot;[arguments],[arguments]...\&quot;           - applies a list of console commands at boot time</span><br><span class="line">-LogCmds=\&quot;foo verbose, bar off\&quot;         - turns on the foo category and turns off the bar category          </span><br><span class="line">------- Environment variables</span><br><span class="line">Any command line option can be set via the environment variable UE-CmdLineArgs</span><br><span class="line">set UE-CmdLineArgs=\&quot;-LogCmds=foo verbose breakon, bar off\&quot;</span><br><span class="line">------- Config file</span><br><span class="line">[Core.Log]</span><br><span class="line">global=[default verbosity for things not listed later]          </span><br><span class="line">[cat]=[level]         </span><br><span class="line">foo=verbose break</span><br></pre></td></tr></table></figure>
<p>以下为参考配置，使用<code>LogCategory=LogLevel</code>这种方式进行设置，在游戏运行时会自动读取：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Core.Log]</span></span><br><span class="line"><span class="attr">LogInit</span>=warning</span><br><span class="line"><span class="attr">LogTaskGraph</span>=warning</span><br><span class="line"><span class="attr">LogDevObjectVersion</span>=warning</span><br><span class="line"><span class="attr">LogMemory</span>=warning</span><br><span class="line"><span class="attr">LogTextLocalizationManager</span>=warning</span><br><span class="line"><span class="attr">LogObj</span>=warning</span><br><span class="line"><span class="attr">LogExit</span>=warning</span><br><span class="line"><span class="attr">LogPlatformFile</span>=warning</span><br></pre></td></tr></table></figure>
<p>使用<code>[Core.Log]</code>与<code>-LogCmds</code>在非shipping模式下在相同的执行流程了，在Shipping打包时<code>-LogCmds</code>的支持就被剔除了。</p>
<p>具体代码在<code>FLogSuppressionImplementation::ProcessConfigAndCommandLine</code>函数里：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/Core/Private/Logging/LogSuppressionInterface.cpp#L479">Logging/LogSuppressionInterface.cpp#L479</a></p>
<h2 id="修改PCH-Buffer-size"><a href="#修改PCH-Buffer-size" class="headerlink" title="修改PCH Buffer size"></a>修改PCH Buffer size</h2><p>默认是<code>/Zm1000</code>，就是750M，如果编译时产生页面文件太小的错误：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c1xx: error C3859: Failed to create <span class="keyword">virtual</span> memory <span class="keyword">for</span> PCH</span><br><span class="line">c1xx: note: the system returned code <span class="number">1455</span>: 页面文件太小，无法完成操作。</span><br><span class="line">c1xx: note: please visit https:<span class="comment">//aka.ms/pch-help for more details</span></span><br><span class="line">c1xx: fatal error C1076: compiler limit: internal heap limit reached</span><br></pre></td></tr></table></figure>

<p>可以在项目的target.cs里添加以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.Win64)</span><br><span class="line">&#123;</span><br><span class="line">  bOverrideBuildEnvironment = <span class="literal">true</span>;</span><br><span class="line">  AdditionalCompilerArguments = <span class="string">&quot;/Zm2000&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/build/reference/zm-specify-precompiled-header-memory-allocation-limit?view=msvc-160">/Zm (Specify Precompiled Header Memory Allocation Limit)</a></li>
</ul>
<h2 id="PSO-Caching配置"><a href="#PSO-Caching配置" class="headerlink" title="PSO Caching配置"></a>PSO Caching配置</h2><p>在<code>Runtime\RenderCore\Private\ShaderPipelineCache.cpp</code>中，定义了一批与PSO相关的ConsoleVariable对象，可以使用以下配置或者Console指定来使用：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="comment">;Sets the startup mode for the PSO cache, determining what the cache does after initialisation:</span></span><br><span class="line"><span class="comment">;0: Precompilation is paused and nothing will compile until a call to ResumeBatching().</span></span><br><span class="line"><span class="comment">;1: Precompilation is enabled in the &#x27;Fast&#x27; mode.</span></span><br><span class="line"><span class="comment">;2: Precompilation is enabled in the &#x27;Background&#x27; mode.</span></span><br><span class="line"><span class="comment">;Default is 1.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.StartupMode</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when compiling takes priority. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchSize</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to compile in a single batch operation when pre-optimizing the cache. Defaults to a maximum of 50 per frame, due to async. file IO it is less in practice.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchSize</span>=<span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when in the background or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 0.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BackgroundBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when compiling takes priority or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 16.0 (max. ms per-frame of precompilation).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.BatchTime</span>=<span class="number">16.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The target time (in ms) to spend precompiling each frame when cpre-optimizing or 0.0 to disable. When precompiling is faster the batch size will grow and when slower will shrink to attempt to occupy the full amount. Defaults to 10.0 (off).</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PrecompileBatchTime</span>=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the number of PipelineStateObjects to log before automatically saving. 0 will disable automatic saving. Shipping defaults to 0, otherwise default is 100.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveAfterPSOsLogged</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved if the number is &lt; r.ShaderPipelineCache.SaveAfterPSOsLogged. Disabled when r.ShaderPipelineCache.SaveAfterPSOsLogged is 0</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTime</span>=<span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Mask used to precompile the cache. Defaults to all PSOs (-1)</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreCompileMask</span>=-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set the time where any logged PSO&#x27;s will be saved when -logpso is on the command line.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.AutoSaveTimeBoundPSO</span>=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;If &gt; 0 then a log of all bound PSOs for this run of the program will be saved to a writable user cache file. Defaults to 0 but is forced on with -logpso.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to use GameFileMask during PSO precompile - recording should always save out the usage masks to make that data availble when needed.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.GameFileMaskEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;Set non zero to PreOptimize PSOs - this allows some PSOs to be compiled in the foreground before going in to game</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.PreOptimizeEnabled</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The minimum bind count to allow a PSO to be precompiled.  Changes to this value will not affect PSOs that have already been removed from consideration.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MinBindCount</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;The maximum time to allow a PSO to be precompiled.  if greather than 0, the amount of wall time we will allow pre-compile of PSOs and then switch to background processing.</span></span><br><span class="line"><span class="attr">r.ShaderPipelineCache.MaxPrecompileTime</span>=<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<p>DefaultGameUserSettings.ini:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ShaderPipelineCache.CacheFile]</span></span><br><span class="line"><span class="comment">;default is 0</span></span><br><span class="line"><span class="comment">;Default = 0, // Whatever order they are already in.</span></span><br><span class="line"><span class="comment">;FirstToLatestUsed = 1, // Start with the PSOs with the lowest first-frame used and work toward those with the highest.</span></span><br><span class="line"><span class="comment">;MostToLeastUsed = 2 // Start with the most often used PSOs working toward the least.</span></span><br><span class="line"><span class="attr">SortOrder</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="MacSDK下载"><a href="#MacSDK下载" class="headerlink" title="MacSDK下载"></a>MacSDK下载</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/phracker/MacOSX-SDKs">MacOSX-SDKs</a></li>
</ul>
<h2 id="清理Mac-DDC"><a href="#清理Mac-DDC" class="headerlink" title="清理Mac DDC"></a>清理Mac DDC</h2><p>删除以下三个目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf Engine/DerivedDataCache</span><br><span class="line">rm -rf /Users/buildmachine/Library/Application\ Support/Epic/UnrealEngine</span><br><span class="line">rm -rf Client/DerivedDataCache</span><br></pre></td></tr></table></figure>

<h2 id="修改平台使用的RHI"><a href="#修改平台使用的RHI" class="headerlink" title="修改平台使用的RHI"></a>修改平台使用的RHI</h2><p>前面的笔记中提到了再Win上可以通过<code>-FeatureLevelES31</code>来指定Standalone模式使用ES3.1的RHI，但是打包时不能简单地这么指定，因为打包之后shaderbytecode都编译完了，SM5和ES3.1不通用，会提示Shader加载错误。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/picgo/2021/20210425191951.webp"></p>
<p>可以通过以下方式设置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/WindowsTargetPlatform.WindowsTargetSettings]</span></span><br><span class="line"><span class="attr">Compiler</span>=Default</span><br><span class="line"><span class="attr">-TargetedRHIs</span>=PCD3D_SM5</span><br><span class="line">+TargetedRHIs=PCD3D_ES31</span><br><span class="line">+TargetedRHIs=PCD3D_SM5</span><br><span class="line"><span class="attr">DefaultGraphicsRHI</span>=DefaultGraphicsRHI_Default</span><br></pre></td></tr></table></figure>
<p>该配置在以下代码中使用，代码篇幅太长，可从github上查看：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/c3caf7b6bf12ae4c8e09b606f10a09776b4d1f38/Engine/Source/Runtime/RHI/Private/Windows/WindowsDynamicRHI.cpp#L49">Runtime/RHI/Private/Windows/WindowsDynamicRHI.cpp#L49</a>。</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Private/Windows/WindowsDynamicRHI.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IDynamicRHIModule* <span class="title">LoadDynamicRHIModule</span><span class="params">(ERHIFeatureLevel::Type&amp; DesiredFeatureLevel, <span class="keyword">const</span> TCHAR*&amp; LoadedRHIModuleName)</span></span>;</span><br></pre></td></tr></table></figure>

<p>修改了之后重新打包，再通过<code>-FeatureLevelES31</code>指定即可启动ES3.1，不加默认则是<code>SM5</code>。</p>
<p>拆开pak可以看到，同时支持了<code>SM5</code>和<code>ES31</code>的Windows包内的<code>ShaderCache</code>和<code>ushaderbytecode</code>都包含了两份：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\Engine\GlobalShaderCache-PCD3D_ES31.bin&quot; &quot;../../../Engine/GlobalShaderCache-PCD3D_ES31.bin&quot;</span><br><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\Engine\GlobalShaderCache-PCD3D_SM5.bin&quot; &quot;../../../Engine/GlobalShaderCache-PCD3D_SM5.bin&quot;</span><br><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\ES31ForWin\Content\ShaderArchive-Global-PCD3D_ES31.ushaderbytecode&quot; &quot;../../../ES31ForWin/Content/ShaderArchive-Global-PCD3D_ES31.ushaderbytecode&quot;</span><br><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\ES31ForWin\Content\ShaderArchive-Global-PCD3D_SM5.ushaderbytecode&quot; &quot;../../../ES31ForWin/Content/ShaderArchive-Global-PCD3D_SM5.ushaderbytecode&quot;</span><br><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\ES31ForWin\Content\ShaderArchive-ES31ForWin-PCD3D_ES31.ushaderbytecode&quot; &quot;../../../ES31ForWin/Content/ShaderArchive-ES31ForWin-PCD3D_ES31.ushaderbytecode&quot;</span><br><span class="line">&quot;D:\ES31ForWin\Saved\Cooked\WindowsNoEditor\ES31ForWin\Content\ShaderArchive-ES31ForWin-PCD3D_SM5.ushaderbytecode&quot; &quot;../../../ES31ForWin/Content/ShaderArchive-ES31ForWin-PCD3D_SM5.ushaderbytecode&quot;</span><br></pre></td></tr></table></figure>

<p>相关资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/t/windows-targeted-rhis-how-to-make-a-game-for-low-end-pcs/80765">Windows Targeted RHIs - How To Make A Game For Low End PCs</a></li>
<li><a target="_blank" rel="noopener" href="http://aicdg.com/ue4-rhi/">unreal engine 4 图形API选择逻辑</a></li>
</ul>
<h2 id="修改DDC的路径"><a href="#修改DDC的路径" class="headerlink" title="修改DDC的路径"></a>修改DDC的路径</h2><p>源码版与安装版引擎的路径有区别：</p>
<figure class="highlight ini"><figcaption><span>BaseEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DerivedDataBackendGraph_Fill_Seattle]</span></span><br><span class="line"><span class="attr">MinimumDaysToKeepFile</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">Root</span>=(Type=KeyLength, Length=<span class="number">120</span>, Inner=AsyncPut)</span><br><span class="line"><span class="attr">AsyncPut</span>=(Type=AsyncPut, Inner=Hierarchy)</span><br><span class="line"><span class="attr">Hierarchy</span>=(Type=Hierarchical, Inner=Boot, Inner=Pak, Inner=EnginePak, Inner=Local, Inner=Seattle)</span><br><span class="line"><span class="attr">Boot</span>=(Type=Boot, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/Boot.ddc&quot;</span>, MaxCacheSize=<span class="number">512</span>)</span><br><span class="line"><span class="attr">Local</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, PurgeTransient=<span class="literal">true</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">34</span>, FoldersToClean=-<span class="number">1</span>, Path=%ENGINEDIR%DerivedDataCache)</span><br><span class="line"><span class="attr">Seattle</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">23</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, Path=?EpicSeaDDC, EnvPathOverride=UE-SharedDataCachePath_Seattle)</span><br><span class="line"><span class="attr">Pak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/DDC.ddp&quot;</span>)</span><br><span class="line"><span class="attr">EnginePak</span>=(Type=ReadPak, Filename=%ENGINEDIR%DerivedDataCache/DDC.ddp)</span><br><span class="line"></span><br><span class="line"><span class="section">[InstalledDerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">MinimumDaysToKeepFile</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">Root</span>=(Type=KeyLength, Length=<span class="number">120</span>, Inner=AsyncPut)</span><br><span class="line"><span class="attr">AsyncPut</span>=(Type=AsyncPut, Inner=Hierarchy)</span><br><span class="line"><span class="attr">Hierarchy</span>=(Type=Hierarchical, Inner=Boot, Inner=Pak, Inner=CompressedPak, Inner=EnginePak, Inner=EnterprisePak, Inner=Local, Inner=Shared)</span><br><span class="line"><span class="attr">Boot</span>=(Type=Boot, Filename=<span class="string">&quot;%ENGINEUSERDIR%DerivedDataCache/Boot.ddc&quot;</span>, MaxCacheSize=<span class="number">512</span>)</span><br><span class="line"><span class="attr">Local</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, PurgeTransient=<span class="literal">true</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">34</span>, FoldersToClean=-<span class="number">1</span>, Path=<span class="string">&quot;%ENGINEVERSIONAGNOSTICUSERDIR%DerivedDataCache&quot;</span>, EditorOverrideSetting=LocalDerivedDataCache)</span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, Path=?EpicDDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br><span class="line"><span class="attr">Pak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/DDC.ddp&quot;</span>)</span><br><span class="line"><span class="attr">CompressedPak</span>=(Type=ReadPak, Filename=<span class="string">&quot;%GAMEDIR%DerivedDataCache/Compressed.ddp&quot;</span>, Compressed=<span class="literal">true</span>)</span><br><span class="line"><span class="attr">EnginePak</span>=(Type=ReadPak, Filename=../../../Engine/DerivedDataCache/Compressed.ddp, Compressed=<span class="literal">true</span>)</span><br><span class="line"><span class="attr">EnterprisePak</span>=(Type=ReadPak, Filename=../../../Enterprise/DerivedDataCache/Compressed.ddp, Compressed=<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>源码版的引擎存在于<code>Engine/DerivedDataCache</code>与项目的<code>DerivedDataCache</code>目录下。<br>安装版引擎的则位于以下几个路径中：</p>
<ul>
<li>%ENGINEUSERDIR%DerivedDataCache/Boot.ddc</li>
<li>%ENGINEVERSIONAGNOSTICUSERDIR%DerivedDataCache</li>
<li>%GAMEDIR%DerivedDataCache/DDC.ddp</li>
<li>../../../Engine/DerivedDataCache/Compressed.ddp</li>
<li>../../../Enterprise/DerivedDataCache/Compressed.ddp</li>
</ul>
<p>这几个路径规则的真实路径：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Misc/ConfigCacheIni.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FConfigExpansion* <span class="title">MatchExpansions</span><span class="params">(<span class="keyword">const</span> TCHAR* PotentialVariable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Allocate replacement value strings once</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> FConfigExpansion Expansions[] =</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%GAME%&quot;</span>), <span class="built_in">FString</span>(FApp::<span class="built_in">GetProjectName</span>())),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%GAMEDIR%&quot;</span>), FPaths::<span class="built_in">ProjectDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEDIR%&quot;</span>), FPaths::<span class="built_in">EngineDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEUSERDIR%&quot;</span>), FPaths::<span class="built_in">EngineUserDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%ENGINEVERSIONAGNOSTICUSERDIR%&quot;</span>), FPaths::<span class="built_in">EngineVersionAgnosticUserDir</span>()),</span><br><span class="line">    <span class="built_in">FConfigExpansion</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%APPSETTINGSDIR%&quot;</span>), <span class="built_in">GetApplicationSettingsDirNormalized</span>()),</span><br><span class="line">  &#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在BaseEngine.ini中修改DDC的路径占位符，替换为上面的可选路径。</p>
<p>注意：<code>EngineUserDir</code>与<code>EngineVersionAgnosticUserDir</code>在安装版与源码版上也有区分：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Private/Misc/Paths.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">FPaths::EngineUserDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldSaveToUserDir</span>() || FApp::<span class="built_in">IsEngineInstalled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">Combine</span>(FPlatformProcess::<span class="built_in">UserSettingsDir</span>(), *FApp::<span class="built_in">GetEpicProductIdentifier</span>(), *FEngineVersion::<span class="built_in">Current</span>().<span class="built_in">ToString</span>(EVersionComponent::Minor)) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">EngineDir</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">FPaths::EngineVersionAgnosticUserDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ShouldSaveToUserDir</span>() || FApp::<span class="built_in">IsEngineInstalled</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">Combine</span>(FPlatformProcess::<span class="built_in">UserSettingsDir</span>(), *FApp::<span class="built_in">GetEpicProductIdentifier</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Common&quot;</span>)) + <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> FPaths::<span class="built_in">EngineDir</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，如果要完全清理系统中的DDC缓存，需要清理以下路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Engine\Engine\DerivedDataCache\*</span><br><span class="line">ProjectName\DerivedDataCache\*</span><br><span class="line">C:\Users\username\AppData\Local\UnrealEngine\*</span><br></pre></td></tr></table></figure>
<p>可以使用以下cmd命令：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> Engine\DerivedDataCache</span><br><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> ProjectName\DerivedDataCache</span><br><span class="line"><span class="built_in">echo</span> y|<span class="built_in">del</span> C:\Users\username\AppData\Local\UnrealEngine</span><br></pre></td></tr></table></figure>

<p>类似问题：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/t/how-to-change-local-data-cache-location/32354">[HOW TO] Change local data cache location</a></li>
</ul>
<h2 id="App版本号"><a href="#App版本号" class="headerlink" title="App版本号"></a>App版本号</h2><h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><p>在IOS包的plist中可以通过控制以下两个值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleShortVersionString<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/bundleresources/information_property_list/cfbundleshortversionstring">CFBundleShortVersionString</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/bundleresources/information_property_list/cfbundleversion">CFBundleVersion</a></li>
<li><a target="_blank" rel="noopener" href="https://beginor.github.io/2014/07/22/ios-cfbundleshortversionstring-vs-cfbundleversion.html">iOS 中的 CFBundleShortVersionString 与 CFBundleVersion</a></li>
</ul>
<p>一般使用CFBundleVersion来作为游戏版本号，在UE中可以通过UPL来控制plist。</p>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>Android通过控制以下值：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line"><span class="attr">VersionDisplayName</span>=<span class="number">1.0</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">StoreVersion</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="Standalone模式的ES3预览"><a href="#Standalone模式的ES3预览" class="headerlink" title="Standalone模式的ES3预览"></a>Standalone模式的ES3预览</h2><p>在启动时加入参数<code>-FeatureLevelES31</code>，在启动时就会由PCD3D_SM5变为<code>PCD3D_ES31</code>了。</p>
<h2 id="修改引擎的编译器参数"><a href="#修改引擎的编译器参数" class="headerlink" title="修改引擎的编译器参数"></a>修改引擎的编译器参数</h2><p>如果想要在编译引擎时自定义加一些编译器参数可以修改<code>Programs\UnrealBuildTool\Platform</code>下各个平台的<code>*Toolchain.cs</code>中的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">GetCompileArguments_Global</span>(<span class="params">CppCompileEnvironment CompileEnvironment</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ++[RSTUDIO][lipengzha] support xcode12</span></span><br><span class="line">  Result += <span class="string">&quot; -Wno-range-loop-analysis&quot;</span>;</span><br><span class="line">  <span class="comment">// --[RSTUDIO]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是全局配置，如果想要给某个Target添加编译器参数可以在target.cs里通过<code>AdditionalCompilerArguments</code>设置：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bOverrideBuildEnvironment = <span class="literal">true</span>;</span><br><span class="line">AdditionalCompilerArguments = <span class="string">&quot;-Wno-range-loop-analysis&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="独立半透明"><a href="#独立半透明" class="headerlink" title="独立半透明"></a>独立半透明</h2><p>有些半透明效果不希望受到景深的影响，可以开启独立半透明。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.RendererSettings]</span></span><br><span class="line"><span class="attr">r.SeparateTranslucency</span>=<span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>但是项目中遇到在IOS上开启时有些特效层级会显示在人物和场景前面。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/252650056">UE4 Separate translucency 在IOS上的一些坑</a></li>
</ul>
<h2 id="Slate图片"><a href="#Slate图片" class="headerlink" title="Slate图片"></a>Slate图片</h2><p>在Slate中可以使用FSlateIcon同通过指定名字(<code>ContentBrowser.AssetActions</code>)来指定使用UE中的图片资源，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asset Actions sub-menu</span></span><br><span class="line">Section.<span class="built_in">AddSubMenu</span>(</span><br><span class="line">    <span class="string">&quot;CookActionsSubMenu&quot;</span>,</span><br><span class="line">    <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CookActionsSubMenuLabel&quot;</span>, <span class="string">&quot;Cook Actions&quot;</span>),</span><br><span class="line">    <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CookActionsSubMenuToolTip&quot;</span>, <span class="string">&quot;Cook actions&quot;</span>),</span><br><span class="line">    FNewToolMenuDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FHotPatcherEditorModule::MakeCookActionsSubMenu),</span><br><span class="line">    <span class="built_in">FUIAction</span>(</span><br><span class="line">        <span class="built_in">FExecuteAction</span>()</span><br><span class="line">        ),</span><br><span class="line">    EUserInterfaceActionType::Button,</span><br><span class="line">    <span class="literal">false</span>, </span><br><span class="line">    <span class="built_in">FSlateIcon</span>(FEditorStyle::<span class="built_in">GetStyleSetName</span>(), <span class="string">&quot;ContentBrowser.AssetActions&quot;</span>)</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<p>那么名字(<code>ContentBrowser.AssetActions</code>)与真实的图片是如何对应起来的呢？</p>
<p>在<code>Editor\EditorStyle\Private\SlateEditorStyle.cpp</code>文件中定义了这些名字与图片的映射：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_tab_Tools_16x&quot;</span>, Icon16x16 ) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.Edit&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/Edit/icon_Edit_16x&quot;</span>, Icon16x16 ) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.Delete&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_delete_16px&quot;</span>, Icon16x16, <span class="built_in">FLinearColor</span>( <span class="number">0.4f</span>, <span class="number">0.5f</span>, <span class="number">0.7f</span>, <span class="number">1.0f</span> ) ) );</span><br><span class="line"><span class="comment">//Set( &quot;ContentBrowser.AssetActions.Delete&quot;, new IMAGE_BRUSH( &quot;Icons/Edit/icon_Edit_Delete_16x&quot;, Icon16x16) );</span></span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.Rename&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/Icon_Asset_Rename_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.Duplicate&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/Edit/icon_Edit_Duplicate_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.OpenSourceLocation&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_Asset_Open_Source_Location_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.OpenInExternalEditor&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_Asset_Open_In_External_Editor_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.ReimportAsset&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_TextureEd_Reimport_40x&quot;</span>, Icon16x16 ) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.GoToCodeForAsset&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;GameProjectDialog/feature_code_32x&quot;</span>, Icon16x16 ) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.FindAssetInWorld&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;/Icons/icon_Genericfinder_16x&quot;</span>, Icon16x16 ) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.CreateThumbnail&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_Asset_Create_Thumbnail_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.DeleteThumbnail&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_Asset_Delete_Thumbnail_16x&quot;</span>, Icon16x16) );</span><br><span class="line"><span class="built_in">Set</span>( <span class="string">&quot;ContentBrowser.AssetActions.GenericFind&quot;</span>, <span class="keyword">new</span> <span class="built_in">IMAGE_BRUSH</span>( <span class="string">&quot;Icons/icon_Genericfinder_16x&quot;</span>, Icon16x16) );</span><br></pre></td></tr></table></figure>
<p>这样引擎就能通过一个名字找到对应的图片了，这些图片位于<code>Engine\Content\Editor\Slate</code>目录下。</p>
<h2 id="创建项目设置中的选项"><a href="#创建项目设置中的选项" class="headerlink" title="创建项目设置中的选项"></a>创建项目设置中的选项</h2><p>在Editor的模块中添加<code>Settings</code>的模块依赖，在模块启动时加入以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ISettingsModule* SettingsModule = FModuleManager::GetModulePtr&lt;ISettingsModule&gt;(<span class="string">&quot;Settings&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">  SettingsModule-&gt;<span class="built_in">RegisterSettings</span>(<span class="string">&quot;Project&quot;</span>, <span class="string">&quot;Plugins&quot;</span>, <span class="string">&quot;Hot Patcher&quot;</span>,</span><br><span class="line">            <span class="built_in">LOCTEXT</span>(<span class="string">&quot;HotPatcherSettingsName&quot;</span>, <span class="string">&quot;Hot Patcher&quot;</span>),</span><br><span class="line">            <span class="built_in">LOCTEXT</span>(<span class="string">&quot;HotPatcherSettingsDescroption&quot;</span>, <span class="string">&quot;Configure the HotPatcher plugin&quot;</span>),</span><br><span class="line">            GetMutableDefault&lt;UHotPatcherSettings&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UPL读取ini"><a href="#UPL读取ini" class="headerlink" title="UPL读取ini"></a>UPL读取ini</h2><p>如有以下ini配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+PackageForOculusMobile=Quest</span><br><span class="line"><span class="attr">bSupportQuestHandsTracking</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>可以使用以下方式在UPL中使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolFromPropertyContains</span> <span class="attr">result</span>=<span class="string">&quot;bPackageForOculusQuest&quot;</span> <span class="attr">ini</span>=<span class="string">&quot;Engine&quot;</span> <span class="attr">section</span>=<span class="string">&quot;/Script/AndroidRuntimeSettings.AndroidRuntimeSettings&quot;</span> <span class="attr">property</span>=<span class="string">&quot;PackageForOculusMobile&quot;</span> <span class="attr">contains</span>=<span class="string">&quot;Quest&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolFromProperty</span> <span class="attr">result</span>=<span class="string">&quot;bSupportsHandsTracking&quot;</span> <span class="attr">ini</span>=<span class="string">&quot;Engine&quot;</span> <span class="attr">section</span>=<span class="string">&quot;/Script/AndroidRuntimeSettings.AndroidRuntimeSettings&quot;</span> <span class="attr">property</span>=<span class="string">&quot;bSupportQuestHandsTracking&quot;</span> <span class="attr">default</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- optional updates applied to AndroidManifest.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bPackageForOculusQuest&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bSupportsHandsTracking&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- Oculus Hands Support --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">log</span> <span class="attr">text</span>=<span class="string">&quot;Oculus Quest Hands Tracking Permissions Added!&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">addPermission</span> <span class="attr">android:name</span>=<span class="string">&quot;oculus.permission.handtracking&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">addPermission</span> <span class="attr">android:name</span>=<span class="string">&quot;oculus.permission.HAND_TRACKING&quot;</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">addFeature</span> <span class="attr">android:name</span>=<span class="string">&quot;oculus.software.handtracking&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="访问系统环境变量"><a href="#访问系统环境变量" class="headerlink" title="访问系统环境变量"></a>访问系统环境变量</h2><p>获取环境变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">std::string <span class="title">StdString</span><span class="params">(FString UEString)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">string</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*UEString));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">FString <span class="title">FStringFromStd</span><span class="params">(std::string StdString)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">FString</span>(<span class="built_in">UTF8_TO_TCHAR</span>(StdString.<span class="built_in">c_str</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">GetEnvironmentVariable</span><span class="params">(<span class="keyword">const</span> FString&amp; Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString Value = <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line">  <span class="keyword">char</span>* Buffer;</span><br><span class="line">  <span class="keyword">size_t</span> Size;</span><br><span class="line">  <span class="keyword">if</span> (_dupenv_s(&amp;Buffer, &amp;Size, <span class="built_in">StdString</span>(Name).<span class="built_in">c_str</span>()) == <span class="number">0</span> &amp;&amp; Buffer != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    Value = Buffer;</span><br><span class="line">    <span class="built_in">free</span>(Buffer);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">char</span>* ValueChars = <span class="built_in">getenv</span>(<span class="built_in">StdString</span>(Name).<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ValueChars != <span class="literal">NULL</span>) </span><br><span class="line">  &#123;</span><br><span class="line">    Value = ValueChars;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置环境变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">SetEnvironmentVariable</span><span class="params">(<span class="keyword">const</span> FString&amp; Name, <span class="keyword">const</span> FString&amp; Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString Combined = Name + <span class="built_in">TEXT</span>(<span class="string">&quot;=&quot;</span>) + Value;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line">  <span class="keyword">return</span> _putenv(<span class="built_in">StdString</span>(Combined).<span class="built_in">c_str</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">putenv</span>(<span class="built_in">StdString</span>(Combined).<span class="built_in">c_str</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Xcode-stdc-错误"><a href="#Xcode-stdc-错误" class="headerlink" title="Xcode stdc++错误"></a>Xcode stdc++错误</h2><p>在Xcode10中移除了libstdc++的支持，如果在代码中使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PublicAdditionalLibraries.<span class="built_in">AddRange</span>(<span class="keyword">new</span> string[] &#123;</span><br><span class="line">  <span class="string">&quot;stdc++.6.0.9&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>会有以下错误：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld: library <span class="keyword">not</span> found <span class="keyword">for</span> -lstdc++<span class="number">.6</span><span class="number">.0</span><span class="number">.9</span></span><br></pre></td></tr></table></figure>

<h2 id="息屏控制"><a href="#息屏控制" class="headerlink" title="息屏控制"></a>息屏控制</h2><p>UE中封装了通用的接口来控制，可以使用以下函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UKismetSystemLibrary::<span class="built_in">ControlScreensaver</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>它会调用到对应平台的<code>F*ApplicationMisc</code>中的同名函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for Android</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAndroidApplicationMisc::ControlScreensaver</span><span class="params">(EScreenSaverAction Action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_ANDROID_JNI</span></span><br><span class="line">  <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">AndroidThunkCpp_KeepScreenOn</span><span class="params">(<span class="keyword">bool</span> Enable)</span></span>;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span> (Action)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> EScreenSaverAction::Disable:</span><br><span class="line">      <span class="comment">// Prevent display sleep.</span></span><br><span class="line">      <span class="built_in">AndroidThunkCpp_KeepScreenOn</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> EScreenSaverAction::Enable:</span><br><span class="line">      <span class="comment">// Stop preventing display sleep now that we are done.</span></span><br><span class="line">      <span class="built_in">AndroidThunkCpp_KeepScreenOn</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for IOS</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FIOSPlatformApplicationMisc::ControlScreensaver</span><span class="params">(EScreenSaverAction Action)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  IOSAppDelegate* AppDelegate = [IOSAppDelegate GetDelegate];</span><br><span class="line">  [AppDelegate EnableIdleTimer : (Action == FGenericPlatformApplicationMisc::Enable)];</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Android-1"><a href="#Android-1" class="headerlink" title="Android"></a>Android</h3><p>在UE的<code>GameActivity.java.template</code>文件中有以下函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_KeepScreenOn</span><span class="params">(<span class="keyword">boolean</span> Enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bKeepScreenOn = Enable;</span><br><span class="line">  <span class="keyword">if</span> (Enable)</span><br><span class="line">  &#123;</span><br><span class="line">    _activity.runOnUiThread(<span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                Log.debug(<span class="string">&quot;==============&gt; [JAVA] AndroidThunkJava_KeepScreenOn(true) - Disabled screen saver&quot;</span>);</span><br><span class="line">                _activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _activity.runOnUiThread(<span class="keyword">new</span> Runnable()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                Log.debug(<span class="string">&quot;==============&gt; [JAVA] AndroidThunkJava_KeepScreenOn(false) - Enabled screen saver&quot;</span>);</span><br><span class="line">                _activity.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在GameActivity的<code>OnResume</code>函数中会调用，是否开启的值为<code>bKeepScreenOn</code>。</p>
<p>可以通过UPL、或者运行时的JNI调用来控制Android是否息屏。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gameActivityOnCreateFinalAdditions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span>&gt;</span></span><br><span class="line">      AndroidThunkJava_KeepScreenOn(true);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gameActivityOnCreateFinalAdditions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="IOS-1"><a href="#IOS-1" class="headerlink" title="IOS"></a>IOS</h3><p>在引擎中有由下代码控制：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/ApplicationCore/Private/IOS/IOSAppDelegate.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)InitIdleTimerSettings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">float</span> TimerDuration = <span class="number">0.0F</span>;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetFloat</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;IdleTimerEnablePeriod&quot;</span>), TimerDuration, GEngineIni);</span><br><span class="line">    IdleTimerEnablePeriod = TimerDuration;</span><br><span class="line">  self.IdleTimerEnableTimer = nil;</span><br><span class="line">  <span class="keyword">bool</span> bEnableTimer = YES;</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;bEnableIdleTimer&quot;</span>), bEnableTimer, GEngineIni);</span><br><span class="line">  [self EnableIdleTimer : bEnableTimer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以从<code>GEngineIni</code>中读取两个配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IdleTimerEnablePeriod</span>=<span class="number">0.0</span></span><br><span class="line"><span class="attr">bEnableIdleTimer</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>当<code>bEnableIdleTimer=false</code>，在游戏运行时就不会息屏。</p>
<p>运行时设置需要调用OC的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\ApplicationCore\Private\IOS\IOSAppDelegate.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)EnableIdleTimer:(<span class="keyword">bool</span>)bEnabled</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">dispatch_async</span>(<span class="built_in">dispatch_get_main_queue</span>(),^</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (bEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Nothing needs to be done, if the enable timer is already running.</span></span><br><span class="line">      <span class="keyword">if</span> (self.IdleTimerEnableTimer == nil)</span><br><span class="line">      &#123;</span><br><span class="line">        self.IdleTimerEnableTimer = [NSTimer scheduledTimerWithTimeInterval:IdleTimerEnablePeriod target:self selector:@<span class="built_in">selector</span>(DeferredEnableIdleTimer) userInfo:nil repeats:NO];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Ensure pending attempts to enable the idle timer are cancelled.</span></span><br><span class="line">      <span class="keyword">if</span> (self.IdleTimerEnableTimer != nil)</span><br><span class="line">      &#123;</span><br><span class="line">        [self.IdleTimerEnableTimer invalidate];</span><br><span class="line">        self.IdleTimerEnableTimer = nil;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      [UIApplication sharedApplication].idleTimerDisabled = NO;</span><br><span class="line">      [UIApplication sharedApplication].idleTimerDisabled = YES;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>EnableIdleTimer</code>传入false会关闭游戏运行时息屏。</p>
<h2 id="Unreal-Swarm"><a href="#Unreal-Swarm" class="headerlink" title="Unreal Swarm"></a>Unreal Swarm</h2><p>在UE编辑器中构建光照时，会拉起一个SwarmAgent进程在后台执行光照构建任务。<br>UE提供了多台机器联机构建光照的支持，通过配置<code>SwarmCoordinator</code>与<code>SwarmAgent</code>作为C/S的方式来下发构建任务，实现联机烘培的效果。官方文档：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Lightmass/UnrealSwarmOverview/index.html">Unreal Swarm</a>。</p>
<p>要求：</p>
<ol>
<li>在局域网内需要一台设备当作调度器（Coordinator），该机器上需要具有完整的引擎，并且该机器需要开放TCP的8008/8009端口的in/out，不然无法连接。</li>
<li>其余的机器上不要求安装引擎，但是需要运行SwarmAgent。</li>
</ol>
<p><code>SwarmAgent</code>可以从引擎的<code>Engine\Binaries\DotNET</code>目录下提取以下文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\build_agent\workspace\SwarmAgent&gt;tree /a /f</span><br><span class="line">C:.</span><br><span class="line">    AgentInterface.dll</span><br><span class="line">    SwarmAgent.DeveloperOptions.xml</span><br><span class="line">    SwarmAgent.exe</span><br><span class="line">    SwarmAgent.exe.config</span><br><span class="line">    SwarmAgent.Options.xml</span><br><span class="line">    SwarmCommonUtils.dll</span><br><span class="line">    SwarmCoordinator.exe</span><br><span class="line">    SwarmCoordinator.exe.config</span><br><span class="line">    SwarmCoordinatorInterface.dll</span><br><span class="line">    SwarmInterface.dll</span><br><span class="line">    UnrealControls.dll</span><br></pre></td></tr></table></figure>
<p>其中<code>SwarmAgent.Options.xml</code>与<code>SwarmAgent.DeveloperOptions.xml</code>是配置文件。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413161531.webp"></p>
<p>需要关注的参数：</p>
<ul>
<li><code>CacheFolder</code>：注意该目录需要有读写权限，因为<code>SwarmAgent</code>可以脱离引擎单独运行，默认的引擎目录不适合，建议设置为<code>C:\tmp\SwarmCache</code>。</li>
<li><code>AllowedRemoteAgentNames</code>：允许远程Agent分配任务到本地的名字，如果不做分组的情况，可以用通配符<code>*</code>允许所有的Agent</li>
<li><code>CoordinatorRemotingHost</code>：局域网中运行SwarmCoordinator机器的IP地址（注意该机器需要开放TCP 8008/8009端口）</li>
<li><code>AvoidLocalExecution</code>：只允许从本地分发任务，但本地不执行任务。</li>
<li><code>EnableStandaloneMode</code>：SwarmAgent的独立模式，不允许传入任务，也不向其他机器分发任务。</li>
<li><code>ShowDeveloperMenu</code>：显示DeveloperSettings菜单。</li>
</ul>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162440.webp"></p>
<p>在DevelopSettings中可以控制超时时间、核心数等。<br>当配置完之后把SwarmAgent运行在其余设备上，在Coordinator的机器上就可以看到以下连接：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162441.webp"></p>
<p>展示了连接的机器数，工作状态（如果SwarmCoordinator进程关闭，重启后会自动连接Agent）。<br>在任意启动了Agent的机器上可以开启UE启动光照构建任务（注意一定要先单独启动被配置完成的SwarmAgent，如果使用引擎自动拉起SwarmAgent则会使用一份额外的配置文件），就能在本地SwarmAgent进程中看到以下任务分配：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413162442.webp"></p>
<p>在SwarmCoordinator中可以看到任务分配情况：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413163213.webp"></p>
<p><strong>注意</strong>：不一定所有的任务都会被分配至其他的Agent执行，取决于任务数量、Agent的负载情况等。</p>
<p>当Agent处于Busy状态时，Coordinator不会给其分配任务：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164503.webp"><br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210413164502.webp"></p>
<p>其他资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.vg/Unreal:Swarm_Agent_Troubleshooting#General_Tips_for_using_Lightmass_in_Unreal_Engine_4">Unreal:Swarm Agent Troubleshooting</a></li>
<li><a target="_blank" rel="noopener" href="https://iamsparky.wordpress.com/2010/08/24/tutorial-setting-up-swarm-for-multiple-machines/">Tutorial: Setting Up Swarm for Multiple Machines</a></li>
</ul>
<h2 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h2><p>有时候会开其他的线程执行任务，但是在任务中有些逻辑必须要在GameThread执行，这就需要用AsyncTask这种方式：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Private\Async\Async.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Async/Async.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AsyncTask</span><span class="params">(ENamedThreads::Type Thread, TUniqueFunction&lt;<span class="keyword">void</span>()&gt; Function)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TGraphTask&lt;FAsyncGraphTask&gt;::<span class="built_in">CreateTask</span>().<span class="built_in">ConstructAndDispatchWhenReady</span>(Thread, <span class="built_in">MoveTemp</span>(Function));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>AsyncTask</code>函数可以指定在某个线程执行任务：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AsyncTask</span>(ENamedThreads::GameThread, []()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// do something in GameThread</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ENamedThread的枚举定义：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\Async\TaskGraphInterfaces.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> ENamedThreads</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> :</span> int32</span><br><span class="line">  &#123;</span><br><span class="line">    UnusedAnchor = <span class="number">-1</span>,</span><br><span class="line">    <span class="comment">/** The always-present, named threads are listed next **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> STATS</span></span><br><span class="line">    StatsThread, </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    RHIThread,</span><br><span class="line">    AudioThread,</span><br><span class="line">    GameThread,</span><br><span class="line">    <span class="comment">// The render thread is sometimes the game thread and is sometimes the actual rendering thread</span></span><br><span class="line">    ActualRenderingThread = GameThread + <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// CAUTION ThreadedRenderingThread must be the last named thread, insert new named threads before it</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** not actually a thread index. Means &quot;Unknown Thread&quot; or &quot;Any Unnamed Thread&quot; **/</span></span><br><span class="line">    AnyThread = <span class="number">0xff</span>, </span><br><span class="line"></span><br><span class="line">    <span class="comment">/** High bits are used for a queue index and priority**/</span></span><br><span class="line"></span><br><span class="line">    MainQueue =     <span class="number">0x000</span>,</span><br><span class="line">    LocalQueue =    <span class="number">0x100</span>,</span><br><span class="line"></span><br><span class="line">    NumQueues =     <span class="number">2</span>,</span><br><span class="line">    ThreadIndexMask = <span class="number">0xff</span>,</span><br><span class="line">    QueueIndexMask =  <span class="number">0x100</span>,</span><br><span class="line">    QueueIndexShift = <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** High bits are used for a queue index task priority and thread priority**/</span></span><br><span class="line"></span><br><span class="line">    NormalTaskPriority =  <span class="number">0x000</span>,</span><br><span class="line">    HighTaskPriority =    <span class="number">0x200</span>,</span><br><span class="line"></span><br><span class="line">    NumTaskPriorities =   <span class="number">2</span>,</span><br><span class="line">    TaskPriorityMask =    <span class="number">0x200</span>,</span><br><span class="line">    TaskPriorityShift =   <span class="number">9</span>,</span><br><span class="line"></span><br><span class="line">    NormalThreadPriority = <span class="number">0x000</span>,</span><br><span class="line">    HighThreadPriority = <span class="number">0x400</span>,</span><br><span class="line">    BackgroundThreadPriority = <span class="number">0x800</span>,</span><br><span class="line"></span><br><span class="line">    NumThreadPriorities = <span class="number">3</span>,</span><br><span class="line">    ThreadPriorityMask = <span class="number">0xC00</span>,</span><br><span class="line">    ThreadPriorityShift = <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Combinations **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> STATS</span></span><br><span class="line">    StatsThread_Local = StatsThread | LocalQueue,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    GameThread_Local = GameThread | LocalQueue,</span><br><span class="line">    ActualRenderingThread_Local = ActualRenderingThread | LocalQueue,</span><br><span class="line"></span><br><span class="line">    AnyHiPriThreadNormalTask = AnyThread | HighThreadPriority | NormalTaskPriority,</span><br><span class="line">    AnyHiPriThreadHiPriTask = AnyThread | HighThreadPriority | HighTaskPriority,</span><br><span class="line"></span><br><span class="line">    AnyNormalThreadNormalTask = AnyThread | NormalThreadPriority | NormalTaskPriority,</span><br><span class="line">    AnyNormalThreadHiPriTask = AnyThread | NormalThreadPriority | HighTaskPriority,</span><br><span class="line"></span><br><span class="line">    AnyBackgroundThreadNormalTask = AnyThread | BackgroundThreadPriority | NormalTaskPriority,</span><br><span class="line">    AnyBackgroundHiPriTask = AnyThread | BackgroundThreadPriority | HighTaskPriority,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MSVC的警告-错误编号"><a href="#MSVC的警告-错误编号" class="headerlink" title="MSVC的警告/错误编号"></a>MSVC的警告/错误编号</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/error-messages/compiler-warnings/compiler-warnings-c4000-c5999?view=msvc-160">Compiler warnings C4000 - C5999</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/error-messages/compiler-errors-1/compiler-errors-c2000-c3999?view=msvc-160">Compiler errors C2000 - C3999</a></li>
</ul>
<h2 id="MSVC成员初始化顺序不一致警告"><a href="#MSVC成员初始化顺序不一致警告" class="headerlink" title="MSVC成员初始化顺序不一致警告"></a>MSVC成员初始化顺序不一致警告</h2><p>在编译MAC/IOS时开启了<code>Wreorder</code>，在以下情况中会产生错误：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">A</span>(<span class="keyword">int</span> a) : <span class="built_in">y</span>(a), <span class="built_in">x</span>(y) &#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>但是MSVC默认没有这个检测，会导致在MSVC编译的过，在Mac上编译不过的情况。</p>
<p>从VS2017开始，提供了一个编译器参数<code>/w15038</code>，可以用在Win上开启相似的警告。</p>
<p>在UE中使用<code>AdditionalCompilerArguments</code>添加即可（非Editor的TargetRules）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StarterContent425.h(9): [C5038] data member &#39;A::y&#39; will be initialized after data member &#39;A::x&#39;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/cpp/error-messages/compiler-warnings/c5038?view=msvc-160">Compiler Warning C5038</a></li>
</ul>
<h2 id="按照名字规则加载模块"><a href="#按照名字规则加载模块" class="headerlink" title="按照名字规则加载模块"></a>按照名字规则加载模块</h2><p>如Shader编译、Texture的压缩等功能，支持很多的类型，UE里也分别实现了很多个模块，每个模块支持某种规则，这也是UE功能组织的一种方法，类似的方法UE中还有Modular Feature：<a href="https://imzlp.com/posts/8470/">ModularFeature：为UE4集成ZSTD压缩算法</a>。</p>
<figure class="highlight cpp"><figcaption><span>Source/Developer/TargetPlatform/Private/TargetPlatformManagerModule.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> TArray&lt;<span class="keyword">const</span> IShaderFormat*&gt;&amp; <span class="title">GetShaderFormats</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> bInitialized = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">static</span> TArray&lt;<span class="keyword">const</span> IShaderFormat*&gt; Results;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!bInitialized || bForceCacheUpdate)</span><br><span class="line">  &#123;</span><br><span class="line">    bInitialized = <span class="literal">true</span>;</span><br><span class="line">    Results.<span class="built_in">Empty</span>(Results.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">    TArray&lt;FName&gt; Modules;</span><br><span class="line"></span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">FindModules</span>(SHADERFORMAT_MODULE_WILDCARD, Modules);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Modules.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogTargetPlatformManager, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;No target shader formats found!&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; Modules.<span class="built_in">Num</span>(); Index++)</span><br><span class="line">    &#123;</span><br><span class="line">      IShaderFormatModule* Module = FModuleManager::LoadModulePtr&lt;IShaderFormatModule&gt;(Modules[Index]);</span><br><span class="line">      <span class="keyword">if</span> (Module)</span><br><span class="line">      &#123;</span><br><span class="line">        IShaderFormat* Format = Module-&gt;<span class="built_in">GetShaderFormat</span>();</span><br><span class="line">        <span class="keyword">if</span> (Format != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          Results.<span class="built_in">Add</span>(Format);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是<code>FMouduleManager::Get().FindModules</code>这个，第一个参数支持规则：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHADERFORMAT_MODULE_WILDCARD TEXT(<span class="meta-string">&quot;*ShaderFormat*&quot;</span>)</span></span><br><span class="line">FModuleManager::<span class="built_in">Get</span>().<span class="built_in">FindModules</span>(SHADERFORMAT_MODULE_WILDCARD, Modules);</span><br></pre></td></tr></table></figure>
<p>这样就会把所有匹配这个名字规则的Module得到，然后再按照统一的接口来维护</p>
<h2 id="性能优化：设备分级"><a href="#性能优化：设备分级" class="headerlink" title="性能优化：设备分级"></a>性能优化：设备分级</h2><p>为高性能和较低性能的设备进行差异化的配置策略。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/zh-CN/SharingAndReleasing/Mobile/Performance/index.html">移动设备性能指南</a></li>
<li><a target="_blank" rel="noopener" href="http://www.resetoter.cn/2020/10/21/unreal%e8%ae%be%e5%a4%87%e5%88%86%e7%ba%a7%e6%80%bb%e7%bb%93/">Unreal设备分级总结</a></li>
</ul>
<h2 id="打印调用栈"><a href="#打印调用栈" class="headerlink" title="打印调用栈"></a>打印调用栈</h2><p>使用<code>FDebug</code>中的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FDebug::<span class="built_in">DumpStackTraceToLog</span>();</span><br></pre></td></tr></table></figure>
<p>会有以下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LogStats: FPlatformStackWalk::StackWalkAndDump -  0.012 s</span><br><span class="line">LogOutputDevice: Error: begin: stack for UAT</span><br><span class="line">LogOutputDevice: Error: &#x3D;&#x3D;&#x3D; FDebug::DumpStackTrace(): &#x3D;&#x3D;&#x3D;</span><br><span class="line">LogOutputDevice: Error: </span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffce24a94f6 UE4Editor-DerivedDataCache.dll!FDerivedDataCache::GetSynchronous() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Developer\DerivedDataCache\Private\DerivedDataCache.cpp:328]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcdec9218b UE4Editor-NavigationSystem.dll!UNavCollision::GetCookedData() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\NavigationSystem\Private\NavCollision.cpp:553]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcdecc5662 UE4Editor-NavigationSystem.dll!UNavCollision::Setup() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\NavigationSystem\Private\NavCollision.cpp:219]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffce9e21b56 UE4Editor-Engine.dll!UStaticMesh::PostLoad() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Engine\Private\StaticMesh.cpp:5100]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef299ae2 UE4Editor-CoreUObject.dll!UObject::ConditionalPostLoad() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\Obj.cpp:1067]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffce8de7432 UE4Editor-Engine.dll!UBodySetup::PostLoad() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Engine\Private\PhysicsEngine\BodySetup.cpp:1079]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef299ae2 UE4Editor-CoreUObject.dll!UObject::ConditionalPostLoad() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\Obj.cpp:1067]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef36147c UE4Editor-CoreUObject.dll!EndLoad() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:1592]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef34b8b7 UE4Editor-CoreUObject.dll!&lt;lambda_84bbae4d81099727504625d58dce15aa&gt;::operator()() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:1231]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef370b4b UE4Editor-CoreUObject.dll!LoadPackageInternal() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:1332]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef36fad0 UE4Editor-CoreUObject.dll!LoadPackage() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:1427]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef384aff UE4Editor-CoreUObject.dll!ResolveName() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:767]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef3975d5 UE4Editor-CoreUObject.dll!StaticLoadObjectInternal() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:829]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef396ca3 UE4Editor-CoreUObject.dll!StaticLoadObject() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectGlobals.cpp:904]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffd02b83b11 UE4Editor-CinematicCamera.dll!ConstructorHelpersInternal::FindOrLoadObject&lt;UStaticMesh&gt;() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Public\UObject\ConstructorHelpers.h:36]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffd02b861ac UE4Editor-CinematicCamera.dll!ACameraRig_Crane::ACameraRig_Crane() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CinematicCamera\Private\CameraRig_Crane.cpp:45]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef0f6cc3 UE4Editor-CoreUObject.dll!UClass::CreateDefaultObject() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\Class.cpp:3672]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef39baf1 UE4Editor-CoreUObject.dll!UObjectLoadAllCompiledInDefaultProperties() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectBase.cpp:861]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffcef37920f UE4Editor-CoreUObject.dll!ProcessNewlyLoadedUObjects() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\CoreUObject\Private\UObject\UObjectBase.cpp:950]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ff6fc231ce1 UE4Editor-Cmd.exe!FEngineLoop::PreInitPostStartupScreen() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Launch\Private\LaunchEngineLoop.cpp:3039]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ff6fc22b7ad UE4Editor-Cmd.exe!GuardedMain() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Launch\Private\Launch.cpp:127]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ff6fc22bb0a UE4Editor-Cmd.exe!GuardedMainWrapper() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Launch\Private\Windows\LaunchWindows.cpp:137]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ff6fc23e2dd UE4Editor-Cmd.exe!WinMain() [C:\build_agent\workspace\FGameEngine\Engine\Engine\Source\Runtime\Launch\Private\Windows\LaunchWindows.cpp:268]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ff6fc2403be UE4Editor-Cmd.exe!__scrt_common_main_seh() [d:\A01\_work\6\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288]</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffd5c217c24 KERNEL32.DLL!UnknownFunction []</span><br><span class="line">LogOutputDevice: Error: [Callstack] 0x00007ffd5ce4d4d1 ntdll.dll!UnknownFunction []</span><br><span class="line">LogOutputDevice: Error: </span><br><span class="line">LogOutputDevice: Error: end: stack for UAT</span><br></pre></td></tr></table></figure>

<h2 id="Windows-Metal-Shader-Compiler-for-IOS"><a href="#Windows-Metal-Shader-Compiler-for-IOS" class="headerlink" title="Windows Metal Shader Compiler for IOS"></a>Windows Metal Shader Compiler for IOS</h2><p>在4.26及更高的引擎版本中，支持在Windows上直接安装Metal Sahder Compiler来支持在Windows上编译Metal的Shader，只需要在<a target="_blank" rel="noopener" href="https://developer.apple.com/download/more/">Apple开发者网站</a>上安装<code>Metal Developer Tools for Windows</code>工具安装即可。OneDrive分流：<a target="_blank" rel="noopener" href="https://1drv.ms/u/s!AjFMYHAQUensgo8H5NJO-65cIEo25A?e=1pm70Y">Metal_Developer_Tools1.2Windows.exe</a>。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dq8iqaixvew1d.cloudfront.net/en-US/SharingAndReleasing/Mobile/iOS/WindowsMetalShader/index.html">Using the Windows Metal Shader Compiler for iOS</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/download/more/">More Downloads for Apple Developers</a></li>
</ul>
<p>4.26引擎执行Cook时的Log，可以看到创建了Metallib：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Running: C:\Program Files\Epic Games\UE_4.26\Engine\Binaries\Win64\UE4Editor-Cmd.exe &quot;C:\Users\lipengzha\Documents\Unreal Projects\StarterContent426\StarterContent426.uproject&quot; -run&#x3D;Cook  -TargetPlatform&#x3D;IOS -fileopenlog -ddc&#x3D;InstalledDerivedDataBackendGraph -unversioned -abslog&#x3D;&quot;C:\Program Files\Epic Games\UE_4.26\Engine\Programs</span><br><span class="line">\AutomationTool\Saved\Cook-2021.04.08-10.06.40.txt&quot; -stdout -CrashForUAT -unattended -NoLogTimes  -UTF8Output</span><br><span class="line">  LogInit: Display: Running engine for game: StarterContent426</span><br><span class="line">  LogHAL: Display: Platform has ~ 32 GB [34123063296 &#x2F; 34359738368 &#x2F; 32], which maps to Largest [LargestMinGB&#x3D;32, LargerMinGB&#x3D;12, DefaultMinGB&#x3D;8, SmallerMinGB&#x3D;6, SmallestMinGB&#x3D;0)</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;AllDesktop&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_ASTC&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_DXT&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_ETC2&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;AndroidClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_ASTCClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_DXTClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_ETC2Client&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_Multi&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Android_MultiClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;IOSClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;IOS&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Linux&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxNoEditor&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxServer&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxAArch64NoEditor&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxAArch64Client&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LinuxAArch64Server&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Lumin&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;LuminClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;MacNoEditor&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Mac&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;MacClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;MacServer&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;TVOSClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;TVOS&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;WindowsNoEditor&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;Windows&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;WindowsClient&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Loaded TargetPlatform &#39;WindowsServer&#39;</span><br><span class="line">  LogTargetPlatformManager: Display: Building Assets For IOS</span><br><span class="line">  LogAudioDebug: Display: Lib vorbis DLL was dynamically loaded.</span><br><span class="line">  LogShaderCompilers: Display: Using Local Shader Compiler.</span><br><span class="line">  LogDerivedDataCache: Display: Max Cache Size: 512 MB</span><br><span class="line">  LogDerivedDataCache: Display: Loaded Boot cache: C:&#x2F;Users&#x2F;lipengzha&#x2F;AppData&#x2F;Local&#x2F;UnrealEngine&#x2F;4.26&#x2F;DerivedDataCache&#x2F;Boot.ddc</span><br><span class="line">  LogDerivedDataCache: Display: Pak cache opened for reading ..&#x2F;..&#x2F;..&#x2F;Engine&#x2F;DerivedDataCache&#x2F;Compressed.ddp.</span><br><span class="line">  LogDerivedDataCache: Display: Performance to C:&#x2F;Users&#x2F;lipengzha&#x2F;AppData&#x2F;Local&#x2F;UnrealEngine&#x2F;Common&#x2F;DerivedDataCache: Latency&#x3D;0.06ms. RandomReadSpeed&#x3D;291.68MBs, RandomWriteSpeed&#x3D;137.99MBs. Assigned SpeedClass &#39;Local&#39;</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material Widget3DPassThrough, compiling.</span><br><span class="line">  LogMaterial: Display: Missing cached shader map for material DefaultSpriteMaterial, compiling.</span><br><span class="line">  LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">  LogAudioCaptureCore: Display: No Audio Capture implementations found. Audio input will be silent.</span><br><span class="line">  LogCook: Display: CookSettings for Memory: MemoryMaxUsedVirtual 0MiB, MemoryMaxUsedPhysical 16384MiB, MemoryMinFreeVirtual 0MiB, MemoryMinFreePhysical 1024MiB</span><br><span class="line">  LogCook: Display: Mobile HDR setting 1</span><br><span class="line">  LogCook: Display: Creating asset registry</span><br><span class="line">  LogCook: Display: Discovering localized assets for cultures: en</span><br><span class="line">  LogCook: Display: Unable to read previous cook inisettings for platform IOS invalidating cook</span><br><span class="line">  LogCook: Display: Clearing all cooked content for platform IOS</span><br><span class="line">  LogCook: Display: Sandbox cleanup took 0.025 seconds for platforms IOS</span><br><span class="line">  LogMetalShaderCompiler: Display: Creating Native Library C:&#x2F;Users&#x2F;lipengzha&#x2F;Documents&#x2F;Unreal Projects&#x2F;StarterContent426&#x2F;Saved&#x2F;Cooked&#x2F;IOS&#x2F;StarterContent426&#x2F;Content&#x2F;Global_SF_METAL.0.metallib</span><br><span class="line">  LogMetalShaderCompiler: Display: Archiving 685 shaders for shader platform: SF_METAL</span><br><span class="line">  LogZipArchiveWriter: Display: Closing zip file with 0 entries.</span><br><span class="line">  LogMetalShaderCompiler: Display: Post-processing archive for shader platform: SF_METAL</span><br><span class="line">  LogCook: Display: Cooked packages 0 Packages Remain 314 Total 314</span><br></pre></td></tr></table></figure>
<p>打包出来的Shadercode不是<code>ushaderbytecode</code>文件，而是和Mac上打包一致的<code>metallib</code>。</p>
<h2 id="Loaded-a-text-shader-will-be-slower-to-load"><a href="#Loaded-a-text-shader-will-be-slower-to-load" class="headerlink" title="Loaded a text shader (will be slower to load)"></a>Loaded a text shader (will be slower to load)</h2><p>当使用远程构建的方式打包了IOS包，在运行时会有以下log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogMetal: Display: Loaded a text shader (will be slower to load)</span><br></pre></td></tr></table></figure>
<p>该日志在以下代码中输出：</p>
<figure class="highlight cpp"><figcaption><span>Source\Runtime\Apple\MetalRHI\Private\MetalShaders.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Initialization constructor. */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> BaseResourceType, int32 ShaderType&gt;</span><br><span class="line"><span class="keyword">void</span> TMetalBaseShader&lt;BaseResourceType, ShaderType&gt;::<span class="built_in">Init</span>(TArrayView&lt;<span class="keyword">const</span> uint8&gt; InShaderCode, FMetalCodeHeader&amp; Header, mtlpp::Library InLibrary)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是因为加载的Shader需要实时编译，会比较慢，可以在项目设置中为IOS开启<code>remote shader compile</code>，在UE4.26之后，也可以通过本地安装metal的工具链在本地编译metal的shader。</p>
<h2 id="rust-in-unreal"><a href="#rust-in-unreal" class="headerlink" title="rust in unreal"></a>rust in unreal</h2><ul>
<li><a target="_blank" rel="noopener" href="https://ejmahler.github.io/rust_in_unreal/">Rust code in Unreal Engine</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ejmahler/UnrealEngine/blob/rust-modules/RustPost/RustInUnreal.md">ejmahler/UnrealEngine/RustPost/RustInUnreal.md</a></li>
</ul>
<h2 id="uhtmanifest"><a href="#uhtmanifest" class="headerlink" title="uhtmanifest"></a>uhtmanifest</h2><p>在以下路径里有个xxxx.uhtmanifest文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intermediate&#x2F;Build&#x2F;PLATFORM&#x2F;TARGETNAME&#x2F;CONFIGURATION&#x2F;*.uhtmanifest</span><br><span class="line">Intermediate&#x2F;Build&#x2F;Win64&#x2F;UE4Game&#x2F;Development&#x2F;UE4Game.uhtmanifest</span><br></pre></td></tr></table></figure>
<p>里面记录了编译的Module和类型等信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;IsGameTarget&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;RootLocalPath&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;TargetName&quot;</span>:<span class="string">&quot;UE4Game&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;ExternalDependenciesFile&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Intermediate\\Build\\Win64\\UE4Game\\Development\\UE4Game.deps&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;Modules&quot;</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;Name&quot;</span>:<span class="string">&quot;CoreUObject&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;ModuleType&quot;</span>:<span class="string">&quot;EngineRuntime&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;BaseDirectory&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Source\\Runtime\\CoreUObject&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;IncludeBase&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Source\\Runtime&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;OutputDirectory&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Intermediate\\Build\\Win64\\UE4\\Inc\\CoreUObject&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;ClassesHeaders&quot;</span>:[</span><br><span class="line">            </span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">&quot;PublicHeaders&quot;</span>:[</span><br><span class="line">            <span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Source\\Runtime\\CoreUObject\\Public\\UObject\\CoreNetTypes.h&quot;</span>,</span><br><span class="line">            <span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Source\\Runtime\\CoreUObject\\Public\\UObject\\CoreOnline.h&quot;</span>,</span><br><span class="line">            <span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Source\\Runtime\\CoreUObject\\Public\\UObject\\NoExportTypes.h&quot;</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">&quot;PrivateHeaders&quot;</span>:[</span><br><span class="line">            </span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">&quot;GeneratedCPPFilenameBase&quot;</span>:<span class="string">&quot;C:\\build_agent\\workspace\\FGameEngine\\Engine\\Engine\\Intermediate\\Build\\Win64\\UE4\\Inc\\CoreUObject\\CoreUObject.gen&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;SaveExportedHeaders&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">         <span class="attr">&quot;UHTGeneratedCodeVersion&quot;</span>:<span class="string">&quot;None&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>附录一份引擎中编译UE4Game的uhtmanifest：<a href="https://imzlp.com/notes/ue/index/2021/UE4Game.uhtmanifest">UE4Game.uhtmanifest</a>，可以对引擎中的Module进行分析，如果有些模块不需要，可以进行裁剪。</p>
<h2 id="震动反馈"><a href="#震动反馈" class="headerlink" title="震动反馈"></a>震动反馈</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/InteractiveExperiences/ForceFeedback/index.html">Force Feedback</a></li>
</ul>
<h2 id="Incredibuild对FASTBuild的影响"><a href="#Incredibuild对FASTBuild的影响" class="headerlink" title="Incredibuild对FASTBuild的影响"></a>Incredibuild对FASTBuild的影响</h2><p>在安装Visual Studio时勾选了安装Incredibuild，如果系统中同时安装了FASTBuild等工具（如NEXTBuild），在使用<code>BuildGraph</code>执行编译时会优先使用Incredibuild，起不到加速的效果。<br>解决办法就是在Visual Studio Installer中卸载掉Incredibuild。</p>
<h2 id="交叉编译工具链"><a href="#交叉编译工具链" class="headerlink" title="交叉编译工具链"></a>交叉编译工具链</h2><p>在编译Linux用的DS时需要用到交叉编译工具链：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Linux/GettingStarted/index.html">Cross-Compiling for Linux</a></li>
</ul>
<p>安装之后把安装目录添加至<code>LINUX_MULTIARCH_ROOT</code>环境变量，可以通过以下命令检测是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%LINUX_MULTIARCH_ROOT%x86_64-unknown-linux-gnu\bin\clang++ -v </span><br></pre></td></tr></table></figure>

<p>安装工具链之后重新生成工程，可以通过RunUAT来进行交叉编译DS：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># REM 【ProjectName】, 【ProjectNameServer】需要修改为项目对应的名称，【ArchiveDirectory】修改为输出目录：</span></span><br><span class="line">Engine\Build\BatchFiles\RunUAT.bat BuildCookRun -nocompileeditor -nop4</span><br><span class="line"> -project=【ProjectName】.uproject</span><br><span class="line"> -cook -stage -archive -archivedirectory=【ArchiveDirectory】</span><br><span class="line"> -package -ue4exe=<span class="string">&quot;Engine\Binaries\Win64\UE4Editor-Cmd.exe&quot;</span>  -ddc=DerivedDataBackendGraph -pak -prereqs</span><br><span class="line"> -nodebuginfo -server -noclient -targetplatform=Linux -serverplatform=Linux -build -skipbuildclient</span><br><span class="line"> -target=【ProjectNameServer】</span><br><span class="line"> -clientconfig=Development -serverconfig=Development -utf8output -compile</span><br></pre></td></tr></table></figure>

<h2 id="IOS签名错误排查"><a href="#IOS签名错误排查" class="headerlink" title="IOS签名错误排查"></a>IOS签名错误排查</h2><h3 id="No-certificate-for-team-xxxx-matching"><a href="#No-certificate-for-team-xxxx-matching" class="headerlink" title="No certificate for team xxxx matching"></a>No certificate for team xxxx matching</h3><p>如果有以下错误提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Code Signing Error: No certificate for team &#39;9TV4ZYSS4J&#39; matching &#39;iPhone Developer: Created via API (JDPXHYVWYZ)&#39; found: Select a different signing certificate for CODE_SIGN_IDENTITY, a team that matches your selected certificate, or switch to autom atic provisioning.</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<ol>
<li>在Mac上的<code>~/Library/MobileDevice/Provisioning\ Profiles</code>清理掉多余的mobileprovision文件。</li>
<li>在Mac钥匙串中清理掉过期的开发者证书</li>
<li>重新导入mobileprovision与证书</li>
</ol>
<p>注意：导入的mobileprovision的文件命名要与在<code>BaseEngine.ini</code>中指定的<code>MobileProvision</code>相同。</p>
<h3 id="errSecInternalComponent错误"><a href="#errSecInternalComponent错误" class="headerlink" title="errSecInternalComponent错误"></a>errSecInternalComponent错误</h3><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b03e59560d31">iOS远程自动打包问题</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@ceyhunkeklik/how-to-fix-ios-application-code-signing-error-4818bd331327">How to Fix iOS Application Code Signing Error?</a></li>
</ul>
<p>是因为通过ssh去调用<code>/usr/bin/codesign</code>访问钥匙串没有权限，可以使用以下命令在ssh中执行解锁：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security unlock-keychain -p password login.keychain</span><br></pre></td></tr></table></figure>
<p>在UE远程构建时，可以先执行这条命令在当前的ssh环境下解锁keychain，使后面的签名可以正常执行。<br>修改UE中的<code>Engine\Build\BatchFiles\Mac\Build.sh</code>文件，在调用UBT编译之前，写入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;`dirname &quot;</span><span class="variable">$0</span><span class="string">&quot;`/../../../..&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup Mono</span></span><br><span class="line"><span class="built_in">source</span> Engine/Build/BatchFiles/Mac/SetupMono.sh Engine/Build/BatchFiles/Mac</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$4</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ] || [ <span class="string">&quot;<span class="variable">$5</span>&quot;</span> == <span class="string">&quot;-buildscw&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> Building ShaderCompileWorker...</span><br><span class="line">  mono Engine/Binaries/DotNET/UnrealBuildTool.exe ShaderCompileWorker Mac Development</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> unlock mac keychain...</span><br><span class="line">security unlock-keychain -p password login.keychain</span><br><span class="line"><span class="built_in">echo</span> Running <span class="built_in">command</span> : Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">mono Engine/Binaries/DotNET/UnrealBuildTool.exe <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line">ExitCode=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ExitCode</span> -eq 254 ] || [ <span class="variable">$ExitCode</span> -eq 255 ] || [ <span class="variable">$ExitCode</span> -eq 2 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> <span class="variable">$ExitCode</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为编译时会把Build.sh通过RSync传递到Mac上，所以可以看到以下log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Remote] Executing build</span><br><span class="line">  Running bundled mono, version: Mono JIT compiler version 5.16.0.220 (2018-06&#x2F;bb3ae37d71a Fri Nov 16 17:12:11 EST 2018)</span><br><span class="line">  unlock mac keychain...</span><br><span class="line">  Running command : Engine&#x2F;Binaries&#x2F;DotNET&#x2F;UnrealBuildTool.exe UnrealHeaderTool Mac Development -SkipRulesCompile -XmlConfigCache&#x3D;&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC2&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;FGameEngine&#x2F;Engine&#x2F;Engine&#x2F;Intermediate&#x2F;Build&#x2F;XmlConfigCache.bin -precompile -allmodules -Log&#x3D;&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC2&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;FGameEngine&#x2F;Engine&#x2F;Engine&#x2F;Programs&#x2F;AutomationTool&#x2F;Saved&#x2F;Logs&#x2F;UBT-UnrealHeaderTool-Mac-Development_Remote.txt -Manifest&#x3D;&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC2&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;FGameEngine&#x2F;Engine&#x2F;Engine&#x2F;Intermediate&#x2F;Remote&#x2F;UnrealHeaderTool&#x2F;Mac&#x2F;Development&#x2F;Manifest.xml</span><br><span class="line">  Target is up to date</span><br><span class="line">  Deploying UnrealHeaderTool Mac Development...</span><br><span class="line">  Deploying now!</span><br><span class="line">  Total execution time: 1.01 seconds</span><br><span class="line">[Remote] Downloading C:\BuildAgent\workspace\FGameEngine\Engine\Engine\Intermediate\Remote\UnrealHeaderTool\Mac\Development\Manifest.xml</span><br><span class="line">[Remote] Downloading build products</span><br><span class="line">  receiving file list ... done</span><br></pre></td></tr></table></figure>
<p>这样每次编译都会解锁keychain，从而避免ssh连接时没有访问codesign导致的签名错误。</p>
<blockquote>
<p>注意：也需要排查BaseEngine.ini中<code>SigningCertificate</code>的值是否被指定。</p>
</blockquote>
<h3 id="Invalid-trust-settings"><a href="#Invalid-trust-settings" class="headerlink" title="Invalid trust settings."></a>Invalid trust settings.</h3><p>如果Log中出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Code Signing Error: Invalid trust settings. Restore system default trust settings for certificate &quot;iPhone Developer: Created via API (JDPXHYVWYZ)&quot; in order to sign code with it.</span><br><span class="line">Code Signing Error: Code signing is required for product type &#39;Application&#39; in SDK &#39;iOS 13.6&#39;</span><br></pre></td></tr></table></figure>
<p>这是因为在Mac上的钥匙串中对证书的设置被修改为了<code>始终信任</code>，修改回<code>使用系统默认</code>即可。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210326121855.webp"></p>
<h2 id="IOS-MobileProvision路径"><a href="#IOS-MobileProvision路径" class="headerlink" title="IOS MobileProvision路径"></a>IOS MobileProvision路径</h2><p>位于以下路径，可以清理掉过期或者多余的mobileprovision：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/MobileDevice/Provisioning\ Profiles</span><br></pre></td></tr></table></figure>

<h2 id="漏掉PRAGMA-ENABLE-OPTIMIZATION导致的编译错误"><a href="#漏掉PRAGMA-ENABLE-OPTIMIZATION导致的编译错误" class="headerlink" title="漏掉PRAGMA_ENABLE_OPTIMIZATION导致的编译错误"></a>漏掉PRAGMA_ENABLE_OPTIMIZATION导致的编译错误</h2><p>有时候希望关闭代码优化，在UE中可以使用封装的宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA_DISABLE_OPTIMIZATION</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">PRAGMA_ENABLE_OPTIMIZATION</span><br></pre></td></tr></table></figure>
<p>但是如果漏掉了<code>PRAGMA_ENABLE_OPTIMIZATION</code>，有时会产生以下编译错误（尤其是包含了Slate等模块的代码）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2&gt;D:\Client\Plugins\UMGExtention\Intermediate\Build\Win64\UE4Editor\Development\UMGExtention\Module.UMGExtention.cpp(16): Error C4426 : optimization flags changed after including header, may be due to #pragma optimize()</span><br><span class="line">2&gt;D:\Client\Plugins\UMGExtention\Intermediate\Build\Win64\UE4Editor\Development\UMGExtention\Module.UMGExtention.cpp(24): Error C4426 : optimization flags changed after including header, may be due to #pragma optimize()</span><br><span class="line">2&gt;EXEC: Error  : 2 (0x02) Target: &#x27;D:\Client\Plugins\UMGExtention\Intermediate\Build\Win64\UE4Editor\Development\UMGExtention\Module.UMGExtention.cpp.obj&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="读取文件的一部分"><a href="#读取文件的一部分" class="headerlink" title="读取文件的一部分"></a>读取文件的一部分</h2><p>可以使用<code>IFileHandle</code>来实现，它有seek函数可以随意偏移。</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\GenericPlatform\GenericPlatformFile.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * File handle interface. </span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CORE_API</span> <span class="title">IFileHandle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/** Destructor, also the only way to close the file handle **/</span></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">IFileHandle</span>()</span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Return the current write or read position. **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int64   <span class="title">Tell</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Change the current write or read position. </span></span><br><span class="line"><span class="comment">   * @param NewPosition new write or read position</span></span><br><span class="line"><span class="comment">   * @return        true if the operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">Seek</span><span class="params">(int64 NewPosition)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Change the current write or read position, relative to the end of the file.</span></span><br><span class="line"><span class="comment">   * @param NewPositionRelativeToEnd  new write or read position, relative to the end of the file should be &lt;=0!</span></span><br><span class="line"><span class="comment">   * @return              true if the operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">SeekFromEnd</span><span class="params">(int64 NewPositionRelativeToEnd = <span class="number">0</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Read bytes from the file.</span></span><br><span class="line"><span class="comment">   * @param Destination Buffer to holds the results, should be at least BytesToRead in size.</span></span><br><span class="line"><span class="comment">   * @param BytesToRead Number of bytes to read into the destination.</span></span><br><span class="line"><span class="comment">   * @return        true if the operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">Read</span><span class="params">(uint8* Destination, int64 BytesToRead)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Write bytes to the file.</span></span><br><span class="line"><span class="comment">   * @param Source    Buffer to write, should be at least BytesToWrite in size.</span></span><br><span class="line"><span class="comment">   * @param BytesToWrite  Number of bytes to write.</span></span><br><span class="line"><span class="comment">   * @return        true if the operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">Write</span><span class="params">(<span class="keyword">const</span> uint8* Source, int64 BytesToWrite)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Flushes file handle to disk.</span></span><br><span class="line"><span class="comment">   * @param bFullFlush  true to flush everything about the file (including its meta-data) with a strong guarantee that it will be on disk by the time this function returns, </span></span><br><span class="line"><span class="comment">   *            or false to let the operating/file system have more leeway about when the data actually gets written to disk</span></span><br><span class="line"><span class="comment">   * @return        true if operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">Flush</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> bFullFlush = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Truncate the file to the given size (in bytes).</span></span><br><span class="line"><span class="comment">   * @param NewSize   Truncated file size (in bytes).</span></span><br><span class="line"><span class="comment">   * @return        true if the operation completed successfully.</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>    <span class="title">Truncate</span><span class="params">(int64 NewSize)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/////////// Utility Functions. These have a default implementation that uses the pure virtual operations.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Return the total size of the file **/</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> int64   <span class="title">Size</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>创建它的方法首先需要拿到PlatformFile:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br></pre></td></tr></table></figure>
<p>然后通过它的<code>OpenRead</code>/<code>OpenWrite</code>方法来创建一个IFileHandle：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Core\Public\GenericPlatform\GenericPlatformFile.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Attempt to open a file for reading.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Filename file to be opened</span></span><br><span class="line"><span class="comment"> * @param bAllowWrite (applies to certain platforms only) whether this file is allowed to be written to by other processes. This flag is needed to open files that are currently being written to as well.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return If successful will return a non-nullptr pointer. Close the file by delete&#x27;ing the handle.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> IFileHandle* <span class="title">OpenRead</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, <span class="keyword">bool</span> bAllowWrite = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Attempt to open a file for writing. If successful will return a non-nullptr pointer. Close the file by delete&#x27;ing the handle. **/</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> IFileHandle* <span class="title">OpenWrite</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, <span class="keyword">bool</span> bAppend = <span class="literal">false</span>, <span class="keyword">bool</span> bAllowRead = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><code>PlatformFile</code>具有跨平台实现，在不同的平台拿到的类型是不一样的，如<code>FIOSPlatformFile</code>/<code>FAndroidPlatformFile</code>等等，具有相同接口的实现。</p>
<p>UE从Pak中加载文件就是通过这样的方式来实现的。</p>
<h2 id="PakBlackList"><a href="#PakBlackList" class="headerlink" title="PakBlackList"></a>PakBlackList</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/SharingAndReleasing/Mobile/Android/ReducingAPKSize/index.html#packageblacklist">Reducing APK Package Size</a></li>
</ul>
<p>可以在<code>&#123;PROJECT_DIR&#125;/Build/&#123;PLATFORM&#125;</code>下创建<code>PakBlackList-&#123;CONFIGURATION&#125;.txt</code>文件来限制打包项目时生成的<code>PakList*.txt</code>中的内容：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;PROJECTDIR&#125;/Build/Android/PakBlacklist-Shipping.txt</span><br><span class="line">&#123;PROJECTDIR&#125;/Build/Android/PakBlacklist-Debug.txt</span><br><span class="line">&#123;PROJECTDIR&#125;/Build/Android/PakBlacklist-Development.txt</span><br><span class="line">&#123;PROJECTDIR&#125;/Build/Android/PakBlacklist-Test.txt</span><br></pre></td></tr></table></figure>
<p>等文件，按照<code>PakBlackList-&#123;CONFIGURATION&#125;.txt</code>的规则命名，打不同Configuration的包就会去读取对应的文件。</p>
<p>文件中需要填写<code>MountPoint</code>的路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../Client/BlackDir</span><br></pre></td></tr></table></figure>
<p>当打包时生成Paklist时会判断是否匹配这里的规则（<code>StartWith</code>），从而控制是否包含。</p>
<p>相关的代码在<code>Programs/AutomationTool/Script/CopyBuildToStagingDirectory.Automation.cs</code>：</p>
<figure class="highlight csharp"><figcaption><span>Programs/AutomationTool/Script/CopyBuildToStagingDirectory.Automation.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates a pak response file using stage context</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; <span class="title">CreatePakResponseFileFromStagingManifest</span>(<span class="params">DeploymentContext SC, Dictionary&lt;StagedFileReference, FileReference&gt; FilesToStage</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// look for optional packaging blacklist if only one config active</span></span><br><span class="line">  List&lt;<span class="built_in">string</span>&gt; Blacklist = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (SC.StageTargetConfigurations.Count == <span class="number">1</span>) </span><br><span class="line">  &#123;</span><br><span class="line">    FileReference PakBlacklistFilename = FileReference.Combine(SC.ProjectRoot, <span class="string">&quot;Build&quot;</span>, SC.PlatformDir, <span class="built_in">string</span>.Format(<span class="string">&quot;PakBlacklist-&#123;0&#125;.txt&quot;</span>, SC.StageTargetConfigurations[<span class="number">0</span>].ToString()));</span><br><span class="line">    <span class="keyword">if</span> (FileReference.Exists(PakBlacklistFilename)) </span><br><span class="line">    &#123;</span><br><span class="line">      LogInformation(<span class="string">&quot;Applying PAK blacklist file &#123;0&#125;. This is deprecated in favor of DefaultPakFileRules.ini&quot;</span>, PakBlacklistFilename);</span><br><span class="line">      <span class="built_in">string</span>[] BlacklistContents = FileReference.ReadAllLines(PakBlacklistFilename);</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> Candidate <span class="keyword">in</span> BlacklistContents) </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (Candidate.Trim().Length &gt; <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (Blacklist == <span class="literal">null</span>) </span><br><span class="line">          &#123;</span><br><span class="line">            Blacklist = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">          &#125;</span><br><span class="line">          Blacklist.Add(Candidate);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> UnrealPakResponseFile = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(StringComparer.InvariantCultureIgnoreCase);</span><br><span class="line">  <span class="keyword">foreach</span> (KeyValuePair&lt;StagedFileReference, FileReference&gt; Pair <span class="keyword">in</span> FilesToStage) </span><br><span class="line">  &#123;</span><br><span class="line">    FileReference Src = Pair.Value;</span><br><span class="line">    <span class="built_in">string</span> Dest = Pair.Key.Name;</span><br><span class="line"></span><br><span class="line">    Dest = CombinePaths(PathSeparator.Slash, SC.PakFileInternalRoot, Dest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Blacklist != <span class="literal">null</span>) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">bool</span> bExcludeFile = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="built_in">string</span> ExcludePath <span class="keyword">in</span> Blacklist) </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (Dest.StartsWith(ExcludePath)) </span><br><span class="line">        &#123;</span><br><span class="line">          bExcludeFile = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bExcludeFile) &#123;</span><br><span class="line">        LogInformation(<span class="string">&quot;Excluding &#123;0&#125;&quot;</span>, Src);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Filter I/O store container files</span></span><br><span class="line">    <span class="keyword">if</span> (Src.HasExtension(<span class="string">&quot;.ucas&quot;</span>) || Src.HasExtension(<span class="string">&quot;.utoc&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      LogInformation(<span class="string">&quot;Excluding &#123;0&#125;&quot;</span>, Src);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do a filtered copy of all ini files to allow stripping of values that we don&#x27;t want to distribute</span></span><br><span class="line">    <span class="keyword">if</span> (Src.HasExtension(<span class="string">&quot;.ini&quot;</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">string</span> SubFolder = Pair.Key.Name.Replace(<span class="string">&#x27;/&#x27;</span>, Path.DirectorySeparatorChar);</span><br><span class="line">      FileReference NewIniFilename = FileReference.Combine(SC.ProjectRoot, <span class="string">&quot;Saved&quot;</span>, <span class="string">&quot;Temp&quot;</span>, SC.PlatformDir, SubFolder);</span><br><span class="line">      InternalUtils.SafeCreateDirectory(NewIniFilename.Directory.FullName, <span class="literal">true</span>);</span><br><span class="line">      InternalUtils.SafeCopyFile(Src.FullName, NewIniFilename.FullName, IniKeyBlacklist</span><br><span class="line">                     : SC.IniKeyBlacklist, IniSectionBlacklist</span><br><span class="line">                     : SC.IniSectionBlacklist);</span><br><span class="line">      Src = NewIniFilename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// there can be files that only differ in case only, we don&#x27;t support that in paks as paks are case-insensitive</span></span><br><span class="line">    <span class="keyword">if</span> (UnrealPakResponseFile.ContainsKey(Src.FullName)) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (UnrealPakResponseFile[Src.FullName] != Dest) </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AutomationException(<span class="string">&quot;Staging manifest already contains &#123;0&#125; (or a file that differs in case only)&quot;</span>, Src);</span><br><span class="line">      &#125;</span><br><span class="line">      LogWarning(<span class="string">&quot;Tried to add duplicate file to stage &quot;</span> + Src + <span class="string">&quot; ignoring second attempt pls fix&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UnrealPakResponseFile.Add(Src.FullName, Dest);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> UnrealPakResponseFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Script-BuildSettings-BuildSettings"><a href="#Script-BuildSettings-BuildSettings" class="headerlink" title="[/Script/BuildSettings.BuildSettings]"></a>[/Script/BuildSettings.BuildSettings]</h2><p>可以在Engine.ini中控制以下参数，选择性的编译某些功能，这些参数在TargetRules中定义：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/2bf1a5b83a7076a0fd275887b373f8ec9e99d431/Engine/Source/Programs/UnrealBuildTool/Configuration/TargetRules.cs">Programs/UnrealBuildTool/Configuration/TargetRules.cs</a></p>
<p>它们都是TargetRules的成员，可以直接在<code>Target.cs</code>中设置值，部分参数也可以在ini中配置，可配置的ini如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/BuildSettings.BuildSettings]</span></span><br><span class="line"><span class="comment">;Whether to include PhysX APEX support.</span></span><br><span class="line"><span class="attr">bCompileAPEX</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to include ICU unicode/i18n support in Core.</span></span><br><span class="line"><span class="attr">bCompileICU</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to compile CEF3 support.</span></span><br><span class="line"><span class="attr">bCompileCEF3</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether we should compile SQLite using the custom &quot;Unreal&quot; platform (true), or using the native platform (false).</span></span><br><span class="line"><span class="attr">bCompileCustomSQLitePlatform</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to utilize cache freed OS allocs with MallocBinned</span></span><br><span class="line"><span class="attr">bUseCacheFreedOSAllocs</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to compile Recast navmesh generation.</span></span><br><span class="line"><span class="attr">bCompileRecast</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to compile SpeedTree support.</span></span><br><span class="line"><span class="attr">bOverrideCompileSpeedTree</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;Whether to include plugin support.</span></span><br><span class="line"><span class="attr">bCompileWithPluginSupport</span>=<span class="literal">false</span></span><br><span class="line"><span class="comment">;Whether to include PerfCounters support.</span></span><br><span class="line"><span class="attr">bWithPerfCountersOverride</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;True if we need FreeType support.</span></span><br><span class="line"><span class="attr">bCompileFreeType</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">;True if we want to favor optimizing size over speed.</span></span><br><span class="line"><span class="attr">bCompileForSize</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>选择性地去关闭这些可以减少so的大小5-10M。</p>
<h2 id="Unreal-Insights的初始化"><a href="#Unreal-Insights的初始化" class="headerlink" title="Unreal Insights的初始化"></a>Unreal Insights的初始化</h2><p>开启Unreal Insights的采集可以使用命令行参数：<code>-trace=counters,cpu,frame,bookmark,gpu</code>，在引擎启动时会解析要采集的模块：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Launch\Private\LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FDelayedAutoRegisterHelper::<span class="built_in">RunAndClearDelayedAutoRegisterDelegates</span>(EDelayedRegisterRunPhase::StartOfEnginePreInit);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_TRACE_ENABLED</span></span><br><span class="line">  &#123;</span><br><span class="line">    Trace::<span class="built_in">Initialize</span>();</span><br><span class="line"></span><br><span class="line">    FString EnabledChannels;</span><br><span class="line">    FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-trace=&quot;</span>), EnabledChannels, <span class="literal">false</span>);</span><br><span class="line">    UE::String::<span class="built_in">ParseTokens</span>(EnabledChannels, <span class="built_in">TEXT</span>(<span class="string">&quot;,&quot;</span>), [](FStringView Token) &#123;</span><br><span class="line">      TCHAR ChannelName[<span class="number">64</span>];</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">size_t</span> ChannelNameSize = Token.<span class="built_in">CopyString</span>(ChannelName, <span class="number">64</span>);</span><br><span class="line">      ChannelName[ChannelNameSize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      Trace::<span class="built_in">ToggleChannel</span>(ChannelName, <span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">TRACE_REGISTER_GAME_THREAD</span>(FPlatformTLS::<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line">    <span class="built_in">TRACE_CPUPROFILER_INIT</span>(CmdLine);</span><br><span class="line">    <span class="built_in">TRACE_PLATFORMFILE_INIT</span>(CmdLine);</span><br><span class="line">    <span class="built_in">TRACE_COUNTERS_INIT</span>(CmdLine);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FEngineLoop::PreInitPreStartupScreen&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UPackage-Save"><a href="#UPackage-Save" class="headerlink" title="UPackage::Save"></a>UPackage::Save</h2><p>Package的存储过程是放到一个单独的线程去执行的:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\CoreUObject\Private\UObject\SavePackage.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AsyncWriteFileWithSplitExports</span><span class="params">(TAsyncWorkSequence&lt;FMD5&gt;&amp; AsyncWriteAndHashSequence, FLargeMemoryPtr Data, <span class="keyword">const</span> int64 DataSize, <span class="keyword">const</span> int64 HeaderSize, <span class="keyword">const</span> TCHAR* Filename, EAsyncWriteOptions Options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  OutstandingAsyncWrites.<span class="built_in">Increment</span>();</span><br><span class="line">  <span class="function">FString <span class="title">OutputFilename</span><span class="params">(Filename)</span></span>;</span><br><span class="line">  AsyncWriteAndHashSequence.<span class="built_in">AddWork</span>([Data = <span class="built_in">MoveTemp</span>(Data), DataSize, HeaderSize, OutputFilename = <span class="built_in">MoveTemp</span>(OutputFilename), Options](FMD5&amp; State) <span class="keyword">mutable</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">EnumHasAnyFlags</span>(Options, EAsyncWriteOptions::ComputeHash))</span><br><span class="line">    &#123;</span><br><span class="line">      State.<span class="built_in">Update</span>(Data.<span class="built_in">Get</span>(), DataSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">EnumHasAnyFlags</span>(Options, EAsyncWriteOptions::WriteFileToDisk))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Write .uasset file</span></span><br><span class="line">      <span class="built_in">WriteToFile</span>(OutputFilename, Data.<span class="built_in">Get</span>(), HeaderSize);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Write .uexp file</span></span><br><span class="line">      <span class="keyword">const</span> FString FilenameExports = FPaths::<span class="built_in">ChangeExtension</span>(OutputFilename, <span class="built_in">TEXT</span>(<span class="string">&quot;.uexp&quot;</span>));</span><br><span class="line">      <span class="built_in">WriteToFile</span>(FilenameExports, Data.<span class="built_in">Get</span>() + HeaderSize, DataSize - HeaderSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OutstandingAsyncWrites.<span class="built_in">Decrement</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用栈为：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210322211548.webp"></p>
<p>在通过UPackage::Save来执行Cook资源的存储并立即打包的操作可能会导致在该Task线程中还没有存储完毕，其他线程就已经开始打包了，导致打包包含文件失败。</p>
<h2 id="UE内置的Release-Patch"><a href="#UE内置的Release-Patch" class="headerlink" title="UE内置的Release Patch"></a>UE内置的Release Patch</h2><p>UE的Patch有一些缺点：</p>
<ul>
<li>无法精确地控制Patch包含的内容且不方便拆分。</li>
<li>无法进行迭代Patch，不能直观预览资源信息。</li>
<li>无法方便地管理工程和Patch版本。</li>
<li>开发阶段无法方便地进行测试补丁打包。</li>
</ul>
<p>具体操作是在Project Launcher中进行Release打包：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319213357.webp"></p>
<p>Cook时的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-Cmd.exe &quot;D:\ThirdPerson425\ThirdPerson425.uproject&quot; -run&#x3D;Cook  -TargetPlatform&#x3D;WindowsNoEditor -fileopenlog -unversioned -createreleaseversion&#x3D;1.0.0.0 -compressed -abslog&#x3D;&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Programs\AutomationTool\Saved\Cook-2021.03.19-19.00.30.txt&quot; -stdout -CrashForUAT -unattended -NoLogTimes  -UTF8Output</span><br></pre></td></tr></table></figure>
<p>当打包成功后会在项目的根目录中创建出一个Releases目录，存储以下文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">D:\ThirdPerson425\Releases&gt;tree /a /f</span><br><span class="line">D:.</span><br><span class="line">\---1.0.0.0</span><br><span class="line">    \---WindowsNoEditor</span><br><span class="line">        |   AssetRegistry.bin</span><br><span class="line">        |   ThirdPerson425-WindowsNoEditor.pak</span><br><span class="line">        |</span><br><span class="line">        \---Metadata</span><br><span class="line">                DevelopmentAssetRegistry.bin</span><br></pre></td></tr></table></figure>
<p>可以看到它的实现实际上是备份了当前打包版本的AssetRegistry文件，但经过分析发现，它并不会用来和后续的版本做比对，使用的是另一种方式。</p>
<p>在基于某个Release进行Patch时会自动把AssetRegistry.bin和ushaderbytecode包含到pak中（并且shaderbytecode并没有进行patch）：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210319214356.webp"></p>
<p>当基于某个基础版本进行Patch的时候，在Project Launher的设置如下：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2021/20210322164021.webp"></p>
<p>执行流程中首先需要对项目进行Cook，但是Cook时不需要指定任何版本信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-Cmd.exe</span><br><span class="line"> <span class="string">&quot;D:\Project\ThirdPerson425.uproject&quot;</span></span><br><span class="line"> -run=Cook</span><br><span class="line"> -TargetPlatform=WindowsNoEditor</span><br><span class="line"> -fileopenlog</span><br><span class="line"> -unversioned</span><br><span class="line"> -abslog=<span class="string">&quot;C:\Program Files\Epic Games\UE_4.25\Engine\Programs\AutomationTool\Saved\Cook-2021.03.22-15.29.04.txt&quot;</span></span><br><span class="line"> -stdout</span><br><span class="line"> -CrashForUAT</span><br><span class="line"> -unattended</span><br><span class="line"> -NoLogTimes</span><br><span class="line"> -UTF8Output</span><br></pre></td></tr></table></figure>
<p>当Cook完毕，执行Pak打包的时候，需要传入版本信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UnrealPak.exe</span><br><span class="line"> <span class="string">&quot;D:\Projects\ThirdPerson425.uproject&quot;</span></span><br><span class="line"> <span class="string">&quot;D:\Projects\Package\1.0.0.0_patch1\WindowsNoEditor\ThirdPerson425\Content\Paks\ThirdPerson425-WindowsNoEditor_0_P.pak&quot;</span></span><br><span class="line"> -create=<span class="string">&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\PakList_ThirdPerson425-WindowsNoEditor_0_P.txt&quot;</span></span><br><span class="line"> -cryptokeys=<span class="string">&quot;D:\Projects\Saved\Cooked\WindowsNoEditor\ThirdPerson425\Metadata\Crypto.json&quot;</span></span><br><span class="line"> -order=<span class="string">&quot;D:\Projects\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log&quot;</span></span><br><span class="line"> -generatepatch=<span class="string">&quot;D:\Projects\Releases\1.0.0.0\WindowsNoEditor\ThirdPerson425-WindowsNoEditor*.pak&quot;</span></span><br><span class="line"> -tempfiles=<span class="string">&quot;C:\Program Files\Epic Games\UE_4.25\TempFilesThirdPerson425-WindowsNoEditor_0_P&quot;</span></span><br><span class="line"> -patchpaddingalign=2048</span><br><span class="line"> -platform=Windows</span><br><span class="line"> -multiprocess</span><br><span class="line"> -abslog=<span class="string">&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\UnrealPak-ThirdPerson425-WindowsNoEditor_0_P-2021.03.22-15.29.17.txt&quot;</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li><code>-create=</code>传递进去的Response的<code>txt</code>中是包含整个项目的资源列表的，并非是差异的文件列表。(-create=也可以传递pak文件，用来生成差异)</li>
<li>需要通过<code>-generatepatch=</code>传递基础包中的pak文件</li>
<li>读取基础版本包pak中所有文件，计算出每个文件的hash值</li>
<li>与Response中的资源进行比对，得到新加或者与基础包pak中Hash文件不同的文件列表</li>
<li>把差异部分打包至新的pak中。</li>
</ol>
<p>执行时会加载基础包中pak的文件，计算pak中资源的hash值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LogPakFile: Display: Parsing crypto keys from a crypto key cache file</span><br><span class="line">LogPakFile: Display: Loading response file C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.25\PakList_ThirdPerson425-WindowsNoEditor_0_P.txt</span><br><span class="line">LogPakFile: Display: Added 1559 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Loading pak order file C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log...</span><br><span class="line">LogPakFile: Display: Finished loading pak order file C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Build\WindowsNoEditor\FileOpenOrder\CookerOpenOrder.log.</span><br><span class="line">LogPakFile: Display: Generating patch from C:\Users\lipengzha\Documents\Unreal Projects\ThirdPerson425\Releases\1.0.0.0\WindowsNoEditor\ThirdPerson425-WindowsNoEditor*.pak.</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Animation&#x2F;DefaultAnimBoneCompressionSettings.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Animation&#x2F;DefaultAnimCurveCompressionSettings.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Animation&#x2F;DefaultAnimBoneCompressionSettings.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Animation&#x2F;DefaultAnimCurveCompressionSettings.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;GlobalShaderCache-PCD3D_SM5.bin&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Functions&#x2F;Engine_MaterialFunctions01&#x2F;Opacity&#x2F;CameraDepthFade.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;Functions&#x2F;Engine_MaterialFunctions01&#x2F;Opacity&#x2F;CameraDepthFade.uexp&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;EngineMaterials&#x2F;T_Default_Material_Grid_M.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;EngineMaterials&#x2F;T_Default_Material_Grid_N.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;EngineMaterials&#x2F;WorldGridMaterial.uasset&quot;</span><br><span class="line">LogPakFile: Display: Generated hash for &quot;Engine&#x2F;Content&#x2F;EngineMaterials&#x2F;DefaultMaterial.uasset&quot;</span><br></pre></td></tr></table></figure>
<p>生成hash的函数在<code>GenerateHashesFromPak</code>中，位于<code>PakFileUtilities/Private/PakFileUtilities.cpp</code>中。<br>其作用是：读取基础包中的文件，计算hash值，用作与新Cook之后的文件进行比对。</p>
<p>核心的代码在以下部分：</p>
<figure class="highlight cpp"><figcaption><span>PakFileUtilities/Private/PakFileUtilities.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecuteUnrealPak</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// List of all items to add to pak file</span></span><br><span class="line">  TArray&lt;FPakInputPair&gt; Entries;</span><br><span class="line">  FPakCommandLineParameters CmdLineParameters;</span><br><span class="line">  <span class="built_in">ProcessCommandLine</span>(CmdLine, NonOptionArguments, Entries, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(NonOptionArguments.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CheckAndReallocThreadPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// since this is for creation, we pass true to make it not look in LaunchDir</span></span><br><span class="line">    FString PakFilename = <span class="built_in">GetPakPath</span>(*NonOptionArguments[<span class="number">0</span>], <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List of all items to add to pak file</span></span><br><span class="line">    TArray&lt;FPakInputPair&gt; Entries;</span><br><span class="line">    FPakCommandLineParameters CmdLineParameters;</span><br><span class="line">    <span class="built_in">ProcessCommandLine</span>(CmdLine, NonOptionArguments, Entries, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">    FPakOrderMap OrderMap;</span><br><span class="line">    FString ResponseFile;</span><br><span class="line">    <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-order=&quot;</span>), ResponseFile) &amp;&amp; !OrderMap.<span class="built_in">ProcessOrderFile</span>(*ResponseFile))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FString SecondaryResponseFile;</span><br><span class="line">    <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-secondaryOrder=&quot;</span>), SecondaryResponseFile) &amp;&amp; !OrderMap.<span class="built_in">ProcessOrderFile</span>(*SecondaryResponseFile, <span class="literal">true</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32 LowestSourcePakVersion = <span class="number">0</span>;</span><br><span class="line">    TMap&lt;FString, FFileInfo&gt; SourceFileHashes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( CmdLineParameters.GeneratePatch )</span><br><span class="line">    &#123;</span><br><span class="line">      FString OutputPath;</span><br><span class="line">      <span class="keyword">if</span> (!FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles=&quot;</span>), OutputPath))</span><br><span class="line">      &#123;</span><br><span class="line">        OutputPath = FPaths::<span class="built_in">GetPath</span>(PakFilename) / <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*OutputPath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check command line for the &quot;patchcryptokeys&quot; param, which will tell us where to look for the encryption keys that</span></span><br><span class="line">      <span class="comment">// we need to access the patch reference data</span></span><br><span class="line">      FString PatchReferenceCryptoKeysFilename;</span><br><span class="line">      FKeyChain PatchKeyChain;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;PatchCryptoKeys=&quot;</span>), PatchReferenceCryptoKeysFilename))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">LoadKeyChainFromFile</span>(PatchReferenceCryptoKeysFilename, PatchKeyChain);</span><br><span class="line">        <span class="built_in">ApplyEncryptionKeys</span>(PatchKeyChain);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogPakFile, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Generating patch from %s.&quot;</span>), *CmdLineParameters.SourcePatchPakFilename, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">GenerateHashesFromPak</span>(*CmdLineParameters.SourcePatchPakFilename, *PakFilename, SourceFileHashes, <span class="literal">true</span>, PatchKeyChain, <span class="comment">/*Out*/</span>LowestSourcePakVersion))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ExtractFilesFromPak</span>(*CmdLineParameters.SourcePatchPakFilename, SourceFileHashes, *OutputPath, <span class="literal">true</span>, PatchKeyChain, <span class="literal">nullptr</span>) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to extract files from source pak file for patch&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          CmdLineParameters.SourcePatchDiffDirectory = OutputPath;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ApplyEncryptionKeys</span>(KeyChain);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start collecting files</span></span><br><span class="line">    TArray&lt;FPakInputPair&gt; FilesToAdd;</span><br><span class="line">    <span class="built_in">CollectFilesToAdd</span>(FilesToAdd, Entries, OrderMap, CmdLineParameters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( CmdLineParameters.GeneratePatch )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// We need to get a list of files that were in the previous patch(&#x27;s) Pak, but NOT in FilesToAdd</span></span><br><span class="line">      TArray&lt;FPakInputPair&gt; DeleteRecords = <span class="built_in">GetNewDeleteRecords</span>(FilesToAdd, SourceFileHashes);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//if the patch is built using old source pak files, we need to handle the special case where a file has been moved between chunks but no delete record was created (this would cause a rogue delete record to be created in the latest pak), and also a case where the file was moved between chunks and back again without being changed (this would cause the file to not be included in this chunk because the file would be considered unchanged)</span></span><br><span class="line">      <span class="keyword">if</span> (LowestSourcePakVersion &lt; FPakInfo::PakFile_Version_DeleteRecords)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 CurrentPatchChunkIndex = <span class="built_in">GetPakChunkIndexFromFilename</span>(PakFilename);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Some patch source paks were generated with an earlier version of UnrealPak that didn&#x27;t support delete records. checking for historic assets that have moved between chunks to avoid creating invalid delete records&quot;</span>));</span><br><span class="line">        FString SourcePakFolder = FPaths::<span class="built_in">GetPath</span>(CmdLineParameters.SourcePatchPakFilename);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//remove invalid items from DeleteRecords and set &#x27;bForceInclude&#x27; on some SourceFileHashes</span></span><br><span class="line">        <span class="built_in">ProcessLegacyFileMoves</span>(DeleteRecords, SourceFileHashes, SourcePakFolder, FilesToAdd, CurrentPatchChunkIndex);</span><br><span class="line">      &#125;</span><br><span class="line">      FilesToAdd.<span class="built_in">Append</span>(DeleteRecords);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if we are generating a patch here we remove files which are already shipped...</span></span><br><span class="line">      <span class="built_in">RemoveIdenticalFiles</span>(FilesToAdd, CmdLineParameters.SourcePatchDiffDirectory, SourceFileHashes, CmdLineParameters.SeekOptParams, CmdLineParameters.ChangedFilesOutputFilename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bResult = <span class="built_in">CreatePakFile</span>(*PakFilename, FilesToAdd, CmdLineParameters, KeyChain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CmdLineParameters.GeneratePatch)</span><br><span class="line">    &#123;</span><br><span class="line">      FString OutputPath = FPaths::<span class="built_in">GetPath</span>(PakFilename) / <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TempFiles&quot;</span>));</span><br><span class="line">      <span class="comment">// delete the temporary directory</span></span><br><span class="line">      IFileManager::<span class="built_in">Get</span>().<span class="built_in">DeleteDirectory</span>(*OutputPath, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">GetDerivedDataCacheRef</span>().<span class="built_in">WaitForQuiescence</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析UE的Patch机制可以知道，它的版本比对比较粗暴，是直接得到Pak中文件的二进制信息计算Hash值与当前工程中Cook之后的HASH值来进行比对的，本质上就是基于二进制的比对，这就需要管理好DDC等COOK之后生成的文件，我觉得这样是不合理的，所以HotPatcher是基于原始资源的GUID的比对。</p>
<h2 id="配置ConsoleVariable默认值"><a href="#配置ConsoleVariable默认值" class="headerlink" title="配置ConsoleVariable默认值"></a>配置ConsoleVariable默认值</h2><p>有时候需要在打包时设定某些控制台变量的默认值，可以通过以下方式来设置：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ConsoleVariables]</span></span><br><span class="line"><span class="attr">pakcache.Enable</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>引擎中的相关代码为：</p>
<figure class="highlight cpp"><figcaption><span>Engine\Source\Runtime\Core\Private\Misc\ConfigCacheIni.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FConfigCacheIni::LoadConsoleVariablesFromINI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FString ConsoleVariablesPath = FPaths::<span class="built_in">EngineDir</span>() + <span class="built_in">TEXT</span>(<span class="string">&quot;Config/ConsoleVariables.ini&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !DISABLE_CHEAT_CVARS</span></span><br><span class="line">  <span class="comment">// First we read from &quot;../../../Engine/Config/ConsoleVariables.ini&quot; [Startup] section if it exists</span></span><br><span class="line">  <span class="comment">// This is the only ini file where we allow cheat commands (this is why it&#x27;s not there for UE_BUILD_SHIPPING || UE_BUILD_TEST)</span></span><br><span class="line">  <span class="built_in">ApplyCVarSettingsFromIni</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Startup&quot;</span>), *ConsoleVariablesPath, ECVF_SetByConsoleVariablesIni, <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !DISABLE_CHEAT_CVARS</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We also apply from Engine.ini [ConsoleVariables] section</span></span><br><span class="line">  <span class="built_in">ApplyCVarSettingsFromIni</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ConsoleVariables&quot;</span>), *GEngineIni, ECVF_SetBySystemSettingsIni);</span><br><span class="line"></span><br><span class="line">  IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">CallAllConsoleVariableSinks</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认会读取<code>Engine/Config/ConsoleVariables.ini</code>的<code>[Startup]</code>和<code>GEngineIni</code>（<code>Engine/Config/BaseEngine.ini</code>/<code>&#123;PROJECT&#125;/Config/DefaultEngine.ini</code>/<code>&#123;PROJECT&#125;/Config/&#123;PLATFORM&#125;/&#123;PLATFORM&#125;Engine.ini</code>）中的<code>[ConsoleVariables]</code>中的配置。</p>
<h2 id="UPROPERTY的ConsoleVariable"><a href="#UPROPERTY的ConsoleVariable" class="headerlink" title="UPROPERTY的ConsoleVariable"></a>UPROPERTY的ConsoleVariable</h2><p>成员属性可以绑定到某个控制台变量：</p>
<figure class="highlight cpp"><figcaption><span>RendererSettings.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  &quot;Skin cache allows a compute shader to skin once each vertex, save those results into a new buffer and reuse those calculations when later running the depth, base and velocity passes. This also allows opting into the &#x27;recompute tangents&#x27; for skinned mesh instance feature. Disabling will reduce the number of shader permutations required per material. Changing this setting requires restarting the editor.&quot;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(config, EditAnywhere, Category = Optimizations, meta = (</span><br><span class="line">  ConsoleVariable = <span class="string">&quot;r.SkinCache.CompileShaders&quot;</span>, DisplayName = <span class="string">&quot;Support Compute Skin Cache&quot;</span>,</span><br><span class="line">  ToolTip = <span class="string">&quot;Cannot be disabled while Ray Tracing is enabled as it is then required.&quot;</span>,</span><br><span class="line">  ConfigRestartRequired = <span class="literal">true</span>))</span><br><span class="line">uint32 bSupportSkinCacheShaders : <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>定义在其他文件中的FAutoConsoleVariableRef：</p>
<figure class="highlight cpp"><figcaption><span>GPUSkinCache.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int32 GEnableGPUSkinCacheShaders = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FAutoConsoleVariableRef <span class="title">CVarEnableGPUSkinCacheShaders</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;r.SkinCache.CompileShaders&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  GEnableGPUSkinCacheShaders,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Whether or not to compile the GPU compute skinning cache shaders.\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;This will compile the shaders for skinning on a compute job and not skin on the vertex shader.\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;GPUSkinVertexFactory.usf needs to be touched to cause a recompile if this changes.\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;0 is off(default), 1 is on&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_RenderThreadSafe | ECVF_ReadOnly</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>


<h2 id="代码编译时执行脚本"><a href="#代码编译时执行脚本" class="headerlink" title="代码编译时执行脚本"></a>代码编译时执行脚本</h2><p>在插件的<code>uplugin</code>文件中可以写入<code>PreBuildSteps/PostBuildSteps</code>以下两个元素：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;PostBuildSteps&quot;</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;Win64&quot;</span>:</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;\&quot;$(PluginDir)\\Source\\AkAudio\\WwisePostBuildSteps.bat\&quot; \&quot;$(EngineDir)\\Binaries\\Win64\\UE4Editor-cmd.exe\&quot; \&quot;$(ProjectFile)\&quot; $(TargetType) -run=AkPluginActivator -platform=$(TargetPlatform) -configuration=Profile -targetconfig=$(TargetConfiguration)&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;PS4&quot;</span>:</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;\&quot;$(PluginDir)\\Source\\AkAudio\\WwisePostBuildSteps.bat\&quot; \&quot;$(EngineDir)\\Binaries\\Win64\\UE4Editor-cmd.exe\&quot; \&quot;$(ProjectFile)\&quot; -run=AkPluginActivator -platform=$(TargetPlatform) -configuration=Profile -targetconfig=$(TargetConfiguration)&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在构建时指定自动执行一个脚本，用来处理一些特殊的功能。</p>
<p><code>ProjectDescriptor</code>的声明：Source\Programs\UnrealBuildTool\System\ProjectDescriptor.cs</p>
<p>在UBT的<code>Source\Programs\UnrealBuildTool\Configuration\UEBuildTarget.cs</code>中被解析:</p>
<figure class="highlight csharp"><figcaption><span>Source\Programs\UnrealBuildTool\Configuration\UEBuildTarget.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates scripts for executing the pre-build scripts</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FileReference[] <span class="title">CreatePreBuildScripts</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// Find all the pre-build steps</span></span><br><span class="line">  List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; PreBuildCommandBatches = <span class="keyword">new</span> List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; ();</span><br><span class="line">  <span class="keyword">if</span> (ProjectDescriptor != <span class="literal">null</span> &amp;&amp; ProjectDescriptor.PreBuildSteps != <span class="literal">null</span>) &#123;</span><br><span class="line">    AddCustomBuildSteps(ProjectDescriptor.PreBuildSteps, <span class="literal">null</span>, PreBuildCommandBatches);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Rules.PreBuildSteps.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    PreBuildCommandBatches.Add(<span class="keyword">new</span> Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; (Rules.PreBuildSteps.ToArray(), <span class="literal">null</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">foreach</span>(UEBuildPlugin BuildPlugin <span class="keyword">in</span> BuildPlugins.Where(x =&gt;x.Descriptor.PreBuildSteps != <span class="literal">null</span>)) &#123;</span><br><span class="line">    AddCustomBuildSteps(BuildPlugin.Descriptor.PreBuildSteps, BuildPlugin, PreBuildCommandBatches);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> WriteCustomBuildStepScripts(BuildHostPlatform.Current.Platform, ProjectIntermediateDirectory, <span class="string">&quot;PreBuild&quot;</span>, PreBuildCommandBatches);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Creates scripts for executing post-build steps</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Array of post-build scripts<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FileReference[] <span class="title">CreatePostBuildScripts</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// Find all the post-build steps</span></span><br><span class="line">  List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; PostBuildCommandBatches = <span class="keyword">new</span> List &lt; Tuple &lt; <span class="built_in">string</span>[],</span><br><span class="line">  UEBuildPlugin &gt;&gt; ();</span><br><span class="line">  <span class="keyword">if</span> (!Rules.bDisableLinking) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ProjectDescriptor != <span class="literal">null</span> &amp;&amp; ProjectDescriptor.PostBuildSteps != <span class="literal">null</span>) &#123;</span><br><span class="line">      AddCustomBuildSteps(ProjectDescriptor.PostBuildSteps, <span class="literal">null</span>, PostBuildCommandBatches);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Rules.PostBuildSteps.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      PostBuildCommandBatches.Add(<span class="keyword">new</span> Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; (Rules.PostBuildSteps.ToArray(), <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(UEBuildPlugin BuildPlugin <span class="keyword">in</span> BuildPlugins.Where(x =&gt;x.Descriptor.PostBuildSteps != <span class="literal">null</span>)) &#123;</span><br><span class="line">      AddCustomBuildSteps(BuildPlugin.Descriptor.PostBuildSteps, BuildPlugin, PostBuildCommandBatches);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> WriteCustomBuildStepScripts(BuildHostPlatform.Current.Platform, ProjectIntermediateDirectory, <span class="string">&quot;PostBuild&quot;</span>, PostBuildCommandBatches);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Adds custom build steps from the given JSON object to the list of command batches</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BuildSteps&quot;&gt;</span>The custom build steps<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Plugin&quot;&gt;</span>The plugin to associate with these commands<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CommandBatches&quot;&gt;</span>List to receive the command batches<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddCustomBuildSteps</span>(<span class="params">CustomBuildSteps BuildSteps, UEBuildPlugin Plugin, List &lt; Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt;&gt; CommandBatches</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">string</span>[] Commands;</span><br><span class="line">  <span class="keyword">if</span> (BuildSteps.TryGetCommands(BuildHostPlatform.Current.Platform, <span class="keyword">out</span> Commands)) &#123;</span><br><span class="line">    CommandBatches.Add(Tuple.Create(Commands, Plugin));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Write scripts containing the custom build steps for the given host platform</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;HostPlatform&quot;&gt;</span>The current host platform<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Directory&quot;&gt;</span>The output directory for the scripts<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;FilePrefix&quot;&gt;</span>Bare prefix for all the created script files<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;CommandBatches&quot;&gt;</span>List of custom build steps, and their matching PluginInfo (if appropriate)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List of created script files<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FileReference[] <span class="title">WriteCustomBuildStepScripts</span>(<span class="params">UnrealTargetPlatform HostPlatform, DirectoryReference Directory, <span class="built_in">string</span> FilePrefix, List &lt; Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt;&gt; CommandBatches</span>)</span> &#123;</span><br><span class="line">  List &lt; FileReference &gt; ScriptFiles = <span class="keyword">new</span> List &lt; FileReference &gt; ();</span><br><span class="line">  <span class="keyword">foreach</span>(Tuple &lt; <span class="built_in">string</span>[], UEBuildPlugin &gt; CommandBatch <span class="keyword">in</span> CommandBatches) &#123;</span><br><span class="line">    <span class="comment">// Find all the standard variables</span></span><br><span class="line">    Dictionary &lt; <span class="built_in">string</span>,</span><br><span class="line">    <span class="built_in">string</span> &gt; Variables = GetTargetVariables(CommandBatch.Item2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the output path to the script</span></span><br><span class="line">    <span class="built_in">string</span> ScriptExtension = (HostPlatform == UnrealTargetPlatform.Win64) ? <span class="string">&quot;.bat&quot;</span>: <span class="string">&quot;.sh&quot;</span>;</span><br><span class="line">    FileReference ScriptFile = FileReference.Combine(Directory, String.Format(<span class="string">&quot;&#123;0&#125;-&#123;1&#125;&#123;2&#125;&quot;</span>, FilePrefix, ScriptFiles.Count + <span class="number">1</span>, ScriptExtension));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write it to disk</span></span><br><span class="line">    List &lt; <span class="built_in">string</span> &gt; Contents = <span class="keyword">new</span> List &lt; <span class="built_in">string</span> &gt; ();</span><br><span class="line">    <span class="keyword">if</span> (HostPlatform == UnrealTargetPlatform.Win64) &#123;</span><br><span class="line">      Contents.Insert(<span class="number">0</span>, <span class="string">&quot;@echo off&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="built_in">string</span> Command <span class="keyword">in</span> CommandBatch.Item1) &#123;</span><br><span class="line">      Contents.Add(Utils.ExpandVariables(Command, Variables));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!DirectoryReference.Exists(ScriptFile.Directory)) &#123;</span><br><span class="line">      DirectoryReference.CreateDirectory(ScriptFile.Directory);</span><br><span class="line">    &#125;</span><br><span class="line">    File.WriteAllLines(ScriptFile.FullName, Contents);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the output file to the list of generated scripts</span></span><br><span class="line">    ScriptFiles.Add(ScriptFile);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ScriptFiles.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在编译代码之后会执行指定的脚本，会有以下Log：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2&gt;8&gt; Exec: PostBuild-1.bat.ran</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：测试中发现如果插件的代码没有变动，它不会执行。</p>
</blockquote>
<h2 id="CopyDirectory"><a href="#CopyDirectory" class="headerlink" title="CopyDirectory"></a>CopyDirectory</h2><p>可以使用UE中的<code>IPlatformFile::CopyDirectoryTree</code>，但是注意调用之前要保证两个目标路径都存在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line">PlatformFile.<span class="built_in">CreateDirectoryTree</span>(*OutMetadir);</span><br><span class="line">PlatformFile.<span class="built_in">CopyDirectoryTree</span>(*OutMetadir,*MetadataDir,<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<h2 id="UE4快捷键"><a href="#UE4快捷键" class="headerlink" title="UE4快捷键"></a>UE4快捷键</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnrealEngine_Shortcuts.webp"></p>
<h2 id="Windows-h造成的名字冲突"><a href="#Windows-h造成的名字冲突" class="headerlink" title="Windows.h造成的名字冲突"></a>Windows.h造成的名字冲突</h2><p>有时候需要包含一些平台相关的代码，如<code>windows.h</code>里面包含了很多头文件，其中一些定义了很多宏，如：</p>
<figure class="highlight cpp"><figcaption><span>fileapi.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UNICODE</span></span></span><br></pre></td></tr></table></figure>
<p>如果我们同时在代码中包含了<code>windows.h</code>和使用了<code>IPlatformFile</code>的接口来调用它的<code>DeleteFile</code>函数，因为<code>DeleteFile</code>被定义成了宏，所以在预处理阶段就会被替换，导致编译时访问<code>IPlatformFile</code>的<code>DeleteFileW</code>成员，但实际上它是不存在的，就产生了以下编译错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C2039: &#x27;DeleteFileW&#x27;: is not a member of &#x27;IPlatformFile&#x27;</span><br></pre></td></tr></table></figure>
<p>解决办法就是不直接包含<code>windows.h</code>而是使用以下封装：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/AllowWindowsPlatformTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/HideWindowsPlatformTypes.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>这样可以避免污染UE的符号名字。</p>
<p>UE的文档中也有介绍：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/zh-CN/ProductionPipelines/BuildTools/UnrealBuildTool/ThirdPartyLibraries/index.html">第三方库#故障排除</a></p>
<h2 id="Core-Redirects"><a href="#Core-Redirects" class="headerlink" title="Core Redirects"></a>Core Redirects</h2><p>有时候Class/Enums/functions/packages/property/struct被改了名字，导致所有引用到它们的资源都要手动修改一遍，非常麻烦。</p>
<p>为了解决这个问题，UE提供了重定向功能，可以在不变动大量资源的情况下进行重定向到新的资源。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/Assets/CoreRedirects/index.html">Core Redirects</a></li>
</ul>
<h2 id="打包时Shader的编译"><a href="#打包时Shader的编译" class="headerlink" title="打包时Shader的编译"></a>打包时Shader的编译</h2><p>UE打包项目时并不是所有的shader都会被编译到ushaderbytecode中的，只有打包进去的才会编译进去。<br>进行了一个测试：</p>
<ol>
<li>把<code>/Game</code>添加到了<code>Directories to Never Cook</code></li>
<li>打包工程到Android</li>
</ol>
<p>最终编译出来的ushaderbytecode的大小为：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210311110606.webp"></p>
<p>在UE打包时会拉起Cook进行执行资源的Cook和Shader的编译，应该是在当前的Cook进程中编译的Shader最终会写入到ushaderbytecode文件中，没有被执行Cook的资源不会被编译Shader，从而实现了不会把没有用到的Shader打包的行为。</p>
<p>不过以上只是猜测，有时间具体分析下Cook和Shader编译相关的代码。</p>
<h2 id="DDC共享"><a href="#DDC共享" class="headerlink" title="DDC共享"></a>DDC共享</h2><p>共享DDC的作用是：当同一网络内共享DDC的人只要有一个人编译了DDC，其他人就无需重新编译，节省Shader的编译时间，提高效率。</p>
<p>所以，一般情况下只需要在局域网内部署一个高IO吞吐的机器，每个人都把该机器的共享目录挂载到本地，就可以实现DDC的共享，因为DDC的目录是相对于网络路径的，所以每个人的修改都会影响到其他人，从而实现一个编译多人共享的效果。</p>
<p>UE的文档里介绍了三种设置的方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/ProductionPipelines/DerivedDataCache/index.html">Derived Data Cache</a></li>
</ul>
<ol>
<li>修改<code>DefaultEngine.ini</code>添加<code>DerivedDataBackendGraph</code>项；</li>
<li>系统中添加<code>UE-SharedDataCachePath</code>环境变量；</li>
<li>在UE的<code>Editor Preferences</code>-<code>Global</code>-<code>Shared Derived Data Cache</code>设置共享的DDC目录；</li>
</ol>
<p>UE推荐的是使用第一种方法，但是具体实践和文档中介绍的略有不同。</p>
<p>对于源码版引擎，使用DDC文档中介绍的第一种方法，在项目的<code>DefaultEngine.ini</code>中添加以下项：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>但是对于安装版引擎（Installed），要把<code>DerivedDataBackendGraph</code>改成<code>InstalledDerivedDataBackendGraph</code>：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[InstalledDerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\FMGame\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>这是因为引擎在<code>Developer/DerivedDataCache/Private/DerivedDataBackends.cpp</code>中对安装版和源码版做了区分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FDerivedDataBackendGraph</span>()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span>( !RootCache )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Use default graph</span></span><br><span class="line">    GraphName = FApp::<span class="built_in">IsEngineInstalled</span>() ? <span class="built_in">TEXT</span>(<span class="string">&quot;InstalledDerivedDataBackendGraph&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;DerivedDataBackendGraph&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在设置完之后就可以通过Commandlet来执行DDC的生成了：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor.exe Client\Client.uproject -run=DerivedDataCache -fill</span><br></pre></td></tr></table></figure>
<p>该Commandlet定义在<code>Editor/UnrealEd/Classes/Commandlets/DerivedDataCacheCommandlet.h</code>。</p>
<p>如果想要在配置文件添加之后关闭掉DDC，可以在Editor启动时添加参数<code>-ddc=noshared</code>。</p>
<h2 id="target文件"><a href="#target文件" class="headerlink" title=".target文件"></a>.target文件</h2><p>UE编译项目（Game/Program等）的时候会生成该项目的target文件，记录了该项目的文件依赖，以UHT为例</p>
<figure class="highlight json"><figcaption><span>UnrealHeaderTool.target</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;TargetName&quot;</span>: <span class="string">&quot;UnrealHeaderTool&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Platform&quot;</span>: <span class="string">&quot;Win64&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Configuration&quot;</span>: <span class="string">&quot;Development&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;TargetType&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Architecture&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Launch&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.exe&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Version&quot;</span>: </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;MajorVersion&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">&quot;MinorVersion&quot;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">&quot;PatchVersion&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;Changelist&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;CompatibleChangelist&quot;</span>: <span class="number">13144385</span>,</span><br><span class="line">    <span class="attr">&quot;IsLicenseeVersion&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;IsPromotedBuild&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;BranchName&quot;</span>: <span class="string">&quot;++UE4+Release-4.25&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;BuildId&quot;</span>: <span class="string">&quot;b5ff8f70-3501-456c-bde4-438215a9b5c5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;BuildVersion&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;BuildProducts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.exe&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;Executable&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-BuildSettings.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-BuildSettings.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-TraceLog.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-TraceLog.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Core.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Core.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Json.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Json.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Projects.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Projects.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-CoreUObject.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-CoreUObject.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.version&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RequiredResource&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.modules&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RequiredResource&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;RuntimeDependencies&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/ThirdParty/DbgHelp/dbghelp.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;NonUFS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;AdditionalProperties&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;SDK&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Value&quot;</span>: <span class="string">&quot;Not Applicable&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于这个文件列表，可以实现自动提取程序依赖的功能，在想要提取UE的Program类型的程序时很有用。</p>
<h2 id="IOS-Crash分析文档"><a href="#IOS-Crash分析文档" class="headerlink" title="IOS Crash分析文档"></a>IOS Crash分析文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs">Diagnosing Issues Using Crash Reports and Device Logs</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/examining_the_fields_in_a_crash_report">Examining the Fields in a Crash Report</a></li>
</ul>
<h2 id="材质Sampler超限制Crash"><a href="#材质Sampler超限制Crash" class="headerlink" title="材质Sampler超限制Crash"></a>材质Sampler超限制Crash</h2><p>打包Android运行时发现一个Crash问题：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210226145229.webp"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2021.02.26-06.24.25:291][593]LogRHI: Error: Failed to link program. Current total programs: 112 program binary bytes: 1786425</span><br><span class="line">  log:</span><br><span class="line">Error: Sampler Sampler location or component exceeds max allowed.</span><br><span class="line">Error: Linking failed.</span><br></pre></td></tr></table></figure>
<p>该错误执行在<code>Runtime/OpenGLDrv/Private/OpenGLShaders.cpp</code>中。</p>
<p>原因是某些材质的Sampler超了限制，导致错误。</p>
<p>排查方法为：打开材质，查看在平台中的Sampler的数量：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210226145538.webp"></p>
<h2 id="DoesPackageExists分析"><a href="#DoesPackageExists分析" class="headerlink" title="DoesPackageExists分析"></a>DoesPackageExists分析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COREUOBJECT_API</span> <span class="title">FPackageName</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Checks if the package exists on disk.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * @param LongPackageName Package name.</span></span><br><span class="line"><span class="comment">   * @param OutFilename Package filename on disk.</span></span><br><span class="line"><span class="comment">   * @param InAllowTextFormats Detect text format packages as well as binary (priority to text)</span></span><br><span class="line"><span class="comment">   * @return true if the specified package name points to an existing package, false otherwise.</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">DoesPackageExist</span><span class="params">(<span class="keyword">const</span> FString&amp; LongPackageName, <span class="keyword">const</span> FGuid* Guid = <span class="literal">NULL</span>, FString* OutFilename = <span class="literal">NULL</span>, <span class="keyword">bool</span> InAllowTextFormats = <span class="literal">true</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该函数用来检测Package是否<strong>在磁盘上存在</strong>。</p>
<p><strong>注意</strong>：在磁盘上存在在UE里有两个情况：</p>
<ol>
<li>Editor下存在uasset文件</li>
<li>打包模式下uasset是否在Mounted的Pak中存在</li>
</ol>
<p>事实上，UE也是这么做检测的：</p>
<ol>
<li>首先把要检测的LongPackageName根据规则转换为文件路径</li>
<li>通过FileManager来检测文件路径是否存在</li>
</ol>
<p>在Editor和打包模式下，FileManager通过<code>GetLowLevel()</code>拿到<code>IPlatformFile</code>，之后再进行FileExist的检测，UE针对各个平台封装了<code>IPlatformFile</code>，而且也具有PakPlatformFile的实现，可以实现从Pak中读取文件与在普通文件系统中访问一样的接口。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143321.webp"><br>UE的跨平台写法，声明在通用接口里，定义在各个平台的单独文件中：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224143807.webp"></p>
<p>在引擎启动时会把这些<code>IPlatformFile</code>的对象创建：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look for any file overrides on the command line (i.e. network connection file handler)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">LaunchCheckForFileOverride</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, <span class="keyword">bool</span>&amp; OutFileOverrideFound)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  OutFileOverrideFound = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the physical platform file.</span></span><br><span class="line">  IPlatformFile* CurrentPlatformFile = &amp;FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create pak file wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;PakFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">    PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CachedReadFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create sandbox wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SandboxFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING <span class="comment">// UFS clients are not available in shipping builds.</span></span></span><br><span class="line">  <span class="comment">// Streaming network wrapper (it has a priority over normal network wrapper)</span></span><br><span class="line">  <span class="keyword">bool</span> bNetworkFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> bShouldUseStreamingFile = <span class="literal">false</span>;</span><br><span class="line">    IPlatformFile* NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;StreamingFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseStreamingFile);</span><br><span class="line">    <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bShouldUseCookedIterativeFile = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !bShouldUseStreamingFile &amp;&amp; !NetworkPlatformFile )</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CookedIterativeFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseCookedIterativeFile);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if streaming network platform file was tried this loop don&#x27;t try this one</span></span><br><span class="line">    <span class="comment">// Network file wrapper (only create if the streaming wrapper hasn&#x27;t been created)</span></span><br><span class="line">    <span class="keyword">if</span> ( !bShouldUseStreamingFile &amp;&amp; !bShouldUseCookedIterativeFile &amp;&amp; !NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;NetworkFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bNetworkFailedToInitialize)</span><br><span class="line">    &#123;</span><br><span class="line">      FString HostIpString;</span><br><span class="line">      FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-FileHostIP=&quot;</span>), HostIpString);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_REQUIRES_FILESERVER</span></span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to connect to file server at %s. RETRYING in 5s.\n&quot;</span>), *HostIpString);</span><br><span class="line">      FPlatformProcess::<span class="built_in">Sleep</span>(<span class="number">5.0f</span>);</span><br><span class="line">      uint32 Result = <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line">      <span class="comment">// note that this can&#x27;t be localized because it happens before we connect to a filserver - localizing would cause ICU to try to load.... from over the file server connection!</span></span><br><span class="line">      FString Error = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to connect to any of the following file servers:\n\n    %s\n\nWould you like to try again? No will fallback to local disk files, Cancel will quit.&quot;</span>), *HostIpString.<span class="built_in">Replace</span>( <span class="built_in">TEXT</span>(<span class="string">&quot;+&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;\n    &quot;</span>)));</span><br><span class="line">      uint32 Result = FMessageDialog::<span class="built_in">Open</span>( EAppMsgType::YesNoCancel, FText::<span class="built_in">FromString</span>( Error ) );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Result == EAppReturnType::No)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (Result == EAppReturnType::Cancel)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Cancel - return a failure, and quit</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (bNetworkFailedToInitialize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Try to create file profiling wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SimpleProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file timings stats wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FileReadStats&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file open log wrapper (lists the order files are first opened)</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FileOpenLog&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//#if !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap the above in a file logging singleton if requested</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = <span class="built_in">ConditionallyCreateFileWrapper</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;LogFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">SetPlatformFile</span>(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If our platform file is different than it was when we started, then an override was used</span></span><br><span class="line">  OutFileOverrideFound = (CurrentPlatformFile != &amp;FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LoadObject加载磁盘文件栈"><a href="#LoadObject加载磁盘文件栈" class="headerlink" title="LoadObject加载磁盘文件栈"></a>LoadObject加载磁盘文件栈</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210224100616.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FFileManagerGeneric::CreateFileReaderInternal(const wchar_t *,unsigned int,unsigned int) FileManagerGeneric.cpp:47</span><br><span class="line">FLinkerLoad::CreateLoader(TFunction&lt;void __cdecl(void)&gt; &amp;&amp;) LinkerLoad.cpp:1037</span><br><span class="line">FLinkerLoad::Tick(float,bool,bool,TMap&lt;TTuple&lt;FName,FPackageIndex&gt;,FPackageIndex,FDefaultSetAllocator,TDefaultMapHashableKeyFuncs&lt;TTuple&lt;FName,FPackageIndex&gt;,FPackageIndex,0&gt; &gt; *) LinkerLoad.cpp:696</span><br><span class="line">FLinkerLoad::CreateLinker(FUObjectSerializeContext *,UPackage *,const wchar_t *,unsigned int,FArchive *) LinkerLoad.cpp:459</span><br><span class="line">GetPackageLinker(UPackage *,const wchar_t *,unsigned int,UPackageMap *,FGuid *,FArchive *,FUObjectSerializeContext **) Linker.cpp:745</span><br><span class="line">LoadPackageInternal(UPackage *,const wchar_t *,unsigned int,FLinkerLoad *,FArchive *,FUObjectSerializeContext *) UObjectGlobals.cpp:1208</span><br><span class="line">LoadPackage(UPackage *,const wchar_t *,unsigned int,FArchive *,FUObjectSerializeContext *) UObjectGlobals.cpp:1427</span><br><span class="line">ResolveName(UObject *&amp;,FString &amp;,bool,bool,unsigned int,FUObjectSerializeContext *) UObjectGlobals.cpp:767</span><br><span class="line">StaticLoadObjectInternal(UClass *,UObject *,const wchar_t *,const wchar_t *,unsigned int,UPackageMap *,bool,FUObjectSerializeContext *) UObjectGlobals.cpp:828</span><br><span class="line">StaticLoadObject(UClass *,UObject *,const wchar_t *,const wchar_t *,unsigned int,UPackageMap *,bool,FUObjectSerializeContext *) UObjectGlobals.cpp:904</span><br><span class="line">FSoftObjectPath::TryLoad(FUObjectSerializeContext *) SoftObjectPath.cpp:431</span><br><span class="line">FSoftObjectPtr::LoadSynchronous() SoftObjectPtr.h:54</span><br><span class="line">UPaperSprite::GetSourceTexture() PaperSprite.cpp:1474</span><br><span class="line">UPaperSprite::PostLoad() PaperSprite.cpp:1842</span><br><span class="line">UObject::ConditionalPostLoad() Obj.cpp:1067</span><br><span class="line">FAsyncPackage::PostLoadObjects() AsyncLoading.cpp:6356</span><br><span class="line">FAsyncPackage::TickAsyncPackage(bool,bool,float &amp;,FFlushTree *) AsyncLoading.cpp:5533</span><br><span class="line">FAsyncLoadingThread::ProcessAsyncLoading(int &amp;,bool,bool,float,FFlushTree *) AsyncLoading.cpp:4178</span><br><span class="line">FAsyncLoadingThread::TickAsyncThread(bool,bool,float,bool &amp;,FFlushTree *) AsyncLoading.cpp:4819</span><br><span class="line">FAsyncLoadingThread::TickAsyncLoading(bool,bool,float,FFlushTree *) AsyncLoading.cpp:4519</span><br><span class="line">FAsyncLoadingThread::ProcessLoading(bool,bool,float) AsyncLoading.cpp:7057</span><br><span class="line">StaticTick(float,bool,float) UObjectGlobals.cpp:464</span><br><span class="line">UEditorEngine::Tick(float,bool) EditorEngine.cpp:1355</span><br><span class="line">UUnrealEdEngine::Tick(float,bool) UnrealEdEngine.cpp:411</span><br><span class="line">FEngineLoop::Tick() LaunchEngineLoop.cpp:4844</span><br><span class="line">GuardedMain(const wchar_t *) Launch.cpp:171</span><br><span class="line">WinMain(HINSTANCE__ *,HINSTANCE__ *,char *,int) LaunchWindows.cpp:257</span><br><span class="line">__scrt_common_main_seh() 0x00007ff6ab4e140a</span><br><span class="line">BaseThreadInitThunk 0x00007ffabeff7c24</span><br><span class="line">RtlUserThreadStart 0x00007ffabfcad4d1</span><br></pre></td></tr></table></figure>

<h2 id="rebuild-metadata"><a href="#rebuild-metadata" class="headerlink" title="rebuild metadata"></a>rebuild metadata</h2><p>可以通过执行cook的Commandlet来重新生成AssetRegistry以及ushaderbytecode：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT_NAME.uproject -run=cook -targetplatform=WindowsNoEditor -Iterate -UnVersioned -Compressed</span><br></pre></td></tr></table></figure>
<p>执行完毕之后<code>Saved/Cooked</code>下的<code>AssetRegistry.bin</code>/<code>Metadate目录</code>/<code>Content/ShaderArchive-*.ushaderbytecode</code>以及<code>Ending/GlobalShaderCache*.bin</code>等文件都是生成之后最新的了，可以在之后通过HotPatcher来打包他们了。</p>
<h2 id="IPA包最大为4GB"><a href="#IPA包最大为4GB" class="headerlink" title="IPA包最大为4GB"></a>IPA包最大为4GB</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4753100/max-size-of-an-ios-application">Max size of an iOS application</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/support/app-store-connect/">App Store Connect</a></li>
</ul>
<h2 id="自动化Editor的Crash上报"><a href="#自动化Editor的Crash上报" class="headerlink" title="自动化Editor的Crash上报"></a>自动化Editor的Crash上报</h2><p>因为UE的Crash是拉起一个CrashReportClient程序来执行的，所以如果我们需要在程序出现Crash时上报log信息，可以在<code>CrashReportClientMainWindows</code>中做这部分逻辑。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210220105308.webp"></p>
<h2 id="监听资源创建"><a href="#监听资源创建" class="headerlink" title="监听资源创建"></a>监听资源创建</h2><p>在Editor中创建资源，并没有直接保存到磁盘上，所以要监听<code>OnInMemoryAssetCreated</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(</span><br><span class="line">    <span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">  AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">OnInMemoryAssetCreated</span>().<span class="built_in">AddRaw</span>(<span class="keyword">this</span>, &amp;FTestEditorModule::OnInMemoryAssetCreated);</span><br></pre></td></tr></table></figure>
<p>回调过来的就是一个<code>UObject*</code>，实际上是一个<code>UBlueprint*</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTestEditorModule::OnInMemoryAssetCreated</span><span class="params">(UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Object) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  UBlueprint* Blueprint = Cast&lt;UBlueprint&gt;(Object);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以实现监听uasset创建事件，对该uasset执行一些操作（如默认添加接口等）。</p>
<p>拿到<code>UBlueprint</code>后就可以通过<code>FBlueprintEditorUtils</code>等辅助类来实现对蓝图资源的操作了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FTestEditor::AddInterface</span><span class="params">(UBlueprint* Blueprint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  UClass* Class = Blueprint ? *Blueprint-&gt;GeneratedClass : Blueprint ? Blueprint-&gt;<span class="built_in">GetClass</span>() : <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Class) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Class-&gt;IsChildOf&lt;UUserWidget&gt;()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> UClass* InterfaceClass = UUnLuaInterface::<span class="built_in">StaticClass</span>();</span><br><span class="line"></span><br><span class="line">  UFunction* Func = FBlueprintEditorUtils::<span class="built_in">GetInterfaceFunction</span>(Blueprint, <span class="built_in">FName</span>(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func)</span><br><span class="line">  &#123;</span><br><span class="line">    FBlueprintEditorUtils::<span class="built_in">ImplementNewInterface</span>(Blueprint, InterfaceClass-&gt;<span class="built_in">GetFName</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Func = FBlueprintEditorUtils::<span class="built_in">GetInterfaceFunction</span>(Blueprint, <span class="built_in">FName</span>(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> ImplementedInterfaces = Blueprint-&gt;ImplementedInterfaces;</span><br><span class="line">  <span class="keyword">if</span> (ImplementedInterfaces.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> InterfacesDesc = ImplementedInterfaces[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graphs = InterfacesDesc.Graphs;</span><br><span class="line">  <span class="keyword">if</span> (Graphs.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graph = Graphs[<span class="number">0</span>]; <span class="comment">//UEdGraph</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Graph) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Nodes = Graph-&gt;Nodes;</span><br><span class="line">  <span class="keyword">if</span> (Nodes.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Node = Nodes[<span class="number">1</span>]; <span class="comment">//UEdGraphNode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Node) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pins = Node-&gt;Pins;</span><br><span class="line">  <span class="keyword">if</span> (Pins.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pin = Pins[<span class="number">1</span>]; <span class="comment">//UEdGraphPin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Pin) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  FString moduleName;</span><br><span class="line">  UnLuaExtensionUtils::<span class="built_in">GetLuaModuleName</span>(Class-&gt;<span class="built_in">GetName</span>(), Class-&gt;<span class="built_in">GetPathName</span>(), moduleName);</span><br><span class="line"></span><br><span class="line">  Pin-&gt;DefaultValue = moduleName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Build-lighting-from-commandlet"><a href="#Build-lighting-from-commandlet" class="headerlink" title="Build lighting from commandlet"></a>Build lighting from commandlet</h2><p>在命令行构建光照，可以使用<code>ResavePackages</code>这个commandlet：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe <span class="string">&quot;E:\UE4Project.uproject&quot;</span> -run=resavepackages -buildlighting -quality=Preview -allowcommandletrendering -map=MapName</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/f89256dd0efb7d0b1427729a8f8a6007">Rebuild Lightmaps Commandlet</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/124936/build-lighting-from-command-line.html">Build lighting from command line</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/feedback-for-epic/44406-build-static-lighting-from-command-line">Build static lighting from command line</a></li>
</ul>
<h2 id="AutomationTool的ErrorCode"><a href="#AutomationTool的ErrorCode" class="headerlink" title="AutomationTool的ErrorCode"></a>AutomationTool的ErrorCode</h2><p>打包时的错误，可以通过这些错误码的描述来排查原因，该enum定义在<code>Programs/AutomationTool/AutomationUtils/AutomationException.cs</code>。</p>
<figure class="highlight csharp"><figcaption><span>Programs/AutomationTool/AutomationUtils/AutomationException.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">AutomationTool</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> this needs to be kept in sync with EditorAnalytics.h and iPhonePackager.cs</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">enum</span> ExitCode</span><br><span class="line">    &#123;</span><br><span class="line">        Error_UATNotFound = <span class="number">-1</span>,</span><br><span class="line">        Success = <span class="number">0</span>,</span><br><span class="line">        Error_Unknown = <span class="number">1</span>,</span><br><span class="line">        Error_Arguments = <span class="number">2</span>,</span><br><span class="line">        Error_UnknownCommand = <span class="number">3</span>,</span><br><span class="line">        Error_SDKNotFound = <span class="number">10</span>,</span><br><span class="line">        Error_ProvisionNotFound = <span class="number">11</span>,</span><br><span class="line">        Error_CertificateNotFound = <span class="number">12</span>,</span><br><span class="line">        Error_ProvisionAndCertificateNotFound = <span class="number">13</span>,</span><br><span class="line">        Error_InfoPListNotFound = <span class="number">14</span>,</span><br><span class="line">        Error_KeyNotFoundInPList = <span class="number">15</span>,</span><br><span class="line">        Error_ProvisionExpired = <span class="number">16</span>,</span><br><span class="line">        Error_CertificateExpired = <span class="number">17</span>,</span><br><span class="line">        Error_CertificateProvisionMismatch = <span class="number">18</span>,</span><br><span class="line">        Error_CodeUnsupported = <span class="number">19</span>,</span><br><span class="line">        Error_PluginsUnsupported = <span class="number">20</span>,</span><br><span class="line">        Error_UnknownCookFailure = <span class="number">25</span>,</span><br><span class="line">        Error_UnknownDeployFailure = <span class="number">26</span>,</span><br><span class="line">        Error_UnknownBuildFailure = <span class="number">27</span>,</span><br><span class="line">        Error_UnknownPackageFailure = <span class="number">28</span>,</span><br><span class="line">        Error_UnknownLaunchFailure = <span class="number">29</span>,</span><br><span class="line">        Error_StageMissingFile = <span class="number">30</span>,</span><br><span class="line">        Error_FailedToCreateIPA = <span class="number">31</span>,</span><br><span class="line">        Error_FailedToCodeSign = <span class="number">32</span>,</span><br><span class="line">        Error_DeviceBackupFailed = <span class="number">33</span>,</span><br><span class="line">        Error_AppUninstallFailed = <span class="number">34</span>,</span><br><span class="line">        Error_AppInstallFailed = <span class="number">35</span>,</span><br><span class="line">        Error_AppNotFound = <span class="number">36</span>,</span><br><span class="line">        Error_StubNotSignedCorrectly = <span class="number">37</span>,</span><br><span class="line">        Error_IPAMissingInfoPList = <span class="number">38</span>,</span><br><span class="line">        Error_DeleteFile = <span class="number">39</span>,</span><br><span class="line">        Error_DeleteDirectory = <span class="number">40</span>,</span><br><span class="line">        Error_CreateDirectory = <span class="number">41</span>,</span><br><span class="line">        Error_CopyFile = <span class="number">42</span>,</span><br><span class="line">        Error_OnlyOneObbFileSupported = <span class="number">50</span>,</span><br><span class="line">        Error_FailureGettingPackageInfo = <span class="number">51</span>,</span><br><span class="line">        Error_OnlyOneTargetConfigurationSupported = <span class="number">52</span>,</span><br><span class="line">        Error_ObbNotFound = <span class="number">53</span>,</span><br><span class="line">        Error_AndroidBuildToolsPathNotFound = <span class="number">54</span>,</span><br><span class="line">        Error_NoApkSuitableForArchitecture = <span class="number">55</span>,</span><br><span class="line">        Error_FilesInstallFailed = <span class="number">56</span>,</span><br><span class="line">        Error_RemoteCertificatesNotFound = <span class="number">57</span>,</span><br><span class="line">        Error_LauncherFailed = <span class="number">100</span>,</span><br><span class="line">        Error_UATLaunchFailure = <span class="number">101</span>,</span><br><span class="line">        Error_FailedToDeleteStagingDirectory = <span class="number">102</span>,</span><br><span class="line">        Error_MissingExecutable = <span class="number">103</span>,</span><br><span class="line">        Error_DeviceNotSetupForDevelopment = <span class="number">150</span>,</span><br><span class="line">        Error_DeviceOSNewerThanSDK = <span class="number">151</span>,</span><br><span class="line">    Error_TestFailure = <span class="number">152</span>,</span><br><span class="line">    Error_SymbolizedSONotFound = <span class="number">153</span>,</span><br><span class="line">    Error_LicenseNotAccepted = <span class="number">154</span>,</span><br><span class="line">    Error_AndroidOBBError = <span class="number">155</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用AssetRegistry检测资源是否存在"><a href="#使用AssetRegistry检测资源是否存在" class="headerlink" title="使用AssetRegistry检测资源是否存在"></a>使用AssetRegistry检测资源是否存在</h2><p>在<code>Editor/UnrealEd/Private/FileHelpers.cpp</code>中提供了一个实现，优先通过<code>AssetRegistry</code>来查找，查找不到则退回到从磁盘查找：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FileHelperPackageUtil</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DoesPackageExist helper that rely on the AssetRegistry to validate if a package exists instead of hitting the FS</span></span><br><span class="line"><span class="comment">   * Fallback to the FS if the asset registry initial scan isn&#x27;t done or we aren&#x27;t in Editor</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">DoesPackageExist</span><span class="params">(UPackage* Package, FString* OutFilename = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Test using asset registry to figure out existence</span></span><br><span class="line">    IAssetRegistry&amp; AssetRegistry = FAssetRegistryModule::<span class="built_in">GetRegistry</span>();</span><br><span class="line">    <span class="keyword">if</span> (!AssetRegistry.<span class="built_in">IsLoadingAssets</span>() || !GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      TArray&lt;FAssetData&gt; Data;</span><br><span class="line">      FAssetRegistryModule::<span class="built_in">GetRegistry</span>().<span class="built_in">GetAssetsByPackageName</span>(Package-&gt;<span class="built_in">GetFName</span>(), Data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Data.<span class="built_in">Num</span>() &gt; <span class="number">0</span> &amp;&amp; OutFilename)</span><br><span class="line">      &#123;</span><br><span class="line">        *OutFilename = FPackageName::<span class="built_in">LongPackageNameToFilename</span>(Package-&gt;<span class="built_in">GetName</span>(), Package-&gt;<span class="built_in">ContainsMap</span>() ? FPackageName::<span class="built_in">GetMapPackageExtension</span>() : FPackageName::<span class="built_in">GetAssetPackageExtension</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Data.<span class="built_in">Num</span>() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FPackageName::<span class="built_in">DoesPackageExist</span>(Package-&gt;<span class="built_in">GetName</span>(), <span class="literal">nullptr</span>, OutFilename);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分析打包的资源"><a href="#分析打包的资源" class="headerlink" title="分析打包的资源"></a>分析打包的资源</h2><p>工程中有很多的资源其实并没有打到包中去，当需要分析包体中资源大小时，可以通过<code>Asset Audit</code>工具来实现，通过<code>Window</code>-<code>Developer Tools</code>-<code>AssetAudit</code>打开。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210202194343.webp"></p>
<p>可以看到资源路径、大小、位于哪些Chunk中等一系列的信息，便于排查资源大小和Chunk中的资源冗余。</p>
<p>首先，需要说明<code>Editor</code>里的资源大小和最终打到包内的大小是不一样的，在右上角会列出已经打包的平台（Saved/Cooked）下的平台。</p>
<p><code>Asset Audit</code>需要读取<code>DevelopmentAssetRegistry.bin</code>文件来得到某个平台的资源信息的，它在以下路径中：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client\Saved\Cooked\WindowsNoEditor\FGame\Metadata\DevelopmentAssetRegistry.bin</span><br></pre></td></tr></table></figure>
<p>这个文件记录着某个平台执行完Cook之后资源的大小信息，注意Cook之后的资源如Texture2D等设置的压缩均以执行，但是打包成pak也会执行压缩，这里列出来的大小是没有经过打包pak压缩的Cook资源之后的原始大小。</p>
<p>可以在打包时自动提取Cooked目录下的Metadata目录，在AssetAudit窗口的右上角选择Custom，选择DevelopmentAssetRegistry.bin文件即可。</p>
<h2 id="UE4中ES3-1的75根骨骼限制"><a href="#UE4中ES3-1的75根骨骼限制" class="headerlink" title="UE4中ES3.1的75根骨骼限制"></a>UE4中ES3.1的75根骨骼限制</h2><p>之前提到过在ES2.0上使用单个材质蒙皮的骨骼不能超过75根，在ES3之后就没有这个限制了，但是UE里目前还有这个限制。</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Public/RHIDefinitions.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> int32 <span class="title">GetFeatureLevelMaxNumberOfBones</span><span class="params">(<span class="keyword">const</span> FStaticFeatureLevel FeatureLevel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span> (FeatureLevel)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::ES3_1:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">75</span>;  </span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::SM5:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">65536</span>; <span class="comment">// supports uint16</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">checkf</span>(<span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown FeatureLevel %d&quot;</span>), (int32)FeatureLevel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看了下相关的代码，UE在下面这次提交中修改了ES3.1原本256到75，commit里提到的是修复了Mobile Preview的Crash:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/c33160755b4c28b4277f4323c7e4c9c7bdfdb995">Fixed: Skeletal Mesh with more than 75 bones crashes Mobile Preview</a></li>
</ul>
<blockquote>
<p>Limit ES3.1 to 75 bones like ES2. All ES3.1 feature level platforms use UB for Bones. Project has to set Compat.MAX_GPUSKIN_BONES=75 to support SkelMeshes with more than 75 bones for ES3.1 and ES2.</p>
</blockquote>
<p>该代码在4.21 Preview 4中提交：<a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1537691-unreal-engine-4-21-preview">Unreal Engine 4.21 Preview</a></p>
<p>在answers上也有一些相关的问题：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/919176/change-es3-1-bone-number-limit-to-256.html">Change ES3_1 bone number limit to 256</a></li>
</ul>
<h2 id="upluginmanifest"><a href="#upluginmanifest" class="headerlink" title="upluginmanifest"></a>upluginmanifest</h2><p>项目打包时会根据项目启用的插件生成一个<code>PROJECT_NAME.upluginmanifest</code>文件，其中记录了每个启用的插件的<code>uplugin</code>的路径和内容信息，该文件也会打包到pak中。</p>
<p>Mount Point为：<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></p>
<p>在Editor下运行时不会读取这个文件，通过扫描引擎和项目以及<code>Mods</code>目录下的Plugin目录来查找插件的，相关的逻辑在<code>Runtime/Projects/Private/PluginManager.cpp</code>的<code>ReadAllPlugins</code>函数中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">  <span class="keyword">if</span> (Project != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FindPluginManifestsInDirectory</span>(*FPaths::<span class="built_in">ProjectPluginsDir</span>(), ManifestFileNames);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !WITH_EDITOR</span></span></span><br></pre></td></tr></table></figure>
<p>在非Editor下通过加载upluginmanifest文件来确定当前工程中有哪些插件的（upluginmanifest文件可以有多个，只要放在<code>../../../PROJECT_NAME/Plugins</code>目录下即可），如果一个插件在基础包中不存在，但是热更时新建了一个Content Only插件打包资源，需要把该插件添加至upluginmanifest中并且也需要把该插件的uplugin打包至pak中。</p>
<h2 id="添加非Content路径的Non-Asset目录到基础包"><a href="#添加非Content路径的Non-Asset目录到基础包" class="headerlink" title="添加非Content路径的Non-Asset目录到基础包"></a>添加非Content路径的Non-Asset目录到基础包</h2><p>在<code>Project Settings</code>-<code>Packaging</code>-<code>Additional Non-Asset Directories to Package</code>可以添加相对路Content下的目录，但是不能够直接选Content之外的目录。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210127152358.webp"></p>
<p>但是，其实这里是可以填相对路径的，如添加<code>[PROJECT_DIR]/Source/Script</code>目录：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/UnrealEd.ProjectPackagingSettings]</span></span><br><span class="line">+DirectoriesToAlwaysStageAsUFS=(Path=&quot;../Source/Script&quot;)</span><br></pre></td></tr></table></figure>
<p>在打包时能够正确地处理这个相对路径的，Mount Point也正常：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\UnrealProjects\Client\Source\Script\UnLua.lua&quot; &quot;../../../FGame/Source/Script/UnLua.lua&quot;</span><br></pre></td></tr></table></figure>
<p>使用这种相对路径可以实现把位于项目Content之外的Non-Asset目录添加到基础包中。</p>
<p>实现分析：<br><code>[/Script/UnrealEd.ProjectPackagingSettings]</code>的<code>DirectoriesToAlwaysStageAsUFS</code>值是在<code>Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs</code>中被读取的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StageAdditionalDirectoriesFromConfig</span>(<span class="params">DeploymentContext SC, DirectoryReference ProjectContentRoot, StagedDirectoryReference StageContentRoot, ConfigHierarchy PlatformGameConfig, <span class="built_in">bool</span> bUFS, <span class="built_in">string</span> ConfigKeyName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    List&lt;<span class="built_in">string</span>&gt; ExtraDirs;</span><br><span class="line">    <span class="keyword">if</span> (PlatformGameConfig.GetArray(<span class="string">&quot;/Script/UnrealEd.ProjectPackagingSettings&quot;</span>, ConfigKeyName, <span class="keyword">out</span> ExtraDirs))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Each string has the format &#x27;(Path=&quot;TheDirToStage&quot;)&#x27;</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> PathStr <span class="keyword">in</span> ExtraDirs)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> RelativePath = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> PathParts = PathStr.Split(<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (PathParts.Length == <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                RelativePath = PathParts[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PathParts.Length == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                RelativePath = PathParts[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (RelativePath != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                DirectoryReference InputDir = DirectoryReference.Combine(ProjectContentRoot, RelativePath);</span><br><span class="line">                StagedDirectoryReference OutputDir = StagedDirectoryReference.Combine(StageContentRoot, RelativePath);</span><br><span class="line">                <span class="keyword">if</span> (bUFS)</span><br><span class="line">                &#123;</span><br><span class="line">                    List&lt;FileReference&gt; Files = SC.FindFilesToStage(InputDir, StageFilesSearch.AllDirectories);</span><br><span class="line">                    Files.RemoveAll(x =&gt; x.HasExtension(<span class="string">&quot;.uasset&quot;</span>) || x.HasExtension(<span class="string">&quot;.umap&quot;</span>) || (SC.DedicatedServer &amp;&amp; x.HasExtension(<span class="string">&quot;.mp4&quot;</span>)));</span><br><span class="line">                    SC.StageFiles(StagedFileType.UFS, InputDir, Files, OutputDir);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    SC.StageFiles(StagedFileType.NonUFS, InputDir, StageFilesSearch.AllDirectories, OutputDir);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateStagingManifest</span>(<span class="params">ProjectParams Params, DeploymentContext SC</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Stage any additional UFS and NonUFS paths specified in the project ini files; these dirs are relative to the game content directory</span></span><br><span class="line">    <span class="keyword">if</span> (PlatformGameConfig != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">true</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsUFS&quot;</span>);</span><br><span class="line">        <span class="comment">// NonUFS files are never in pak files and should always be remapped</span></span><br><span class="line">        StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">false</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsNonUFS&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SC.DedicatedServer)</span><br><span class="line">        &#123;</span><br><span class="line">            StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">true</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsUFSServer&quot;</span>);</span><br><span class="line">            <span class="comment">// NonUFS files are never in pak files and should always be remapped</span></span><br><span class="line">            StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">false</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsNonUFSServer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Directory.Combine</code>里正确地处理了我们所指定的相对于Content的<code>../Source/Script</code>路径。</p>
<h2 id="FDataTime-UtcNow"><a href="#FDataTime-UtcNow" class="headerlink" title="FDataTime::UtcNow"></a>FDataTime::UtcNow</h2><p>注意FDataTime::UtcNow在同一帧的不同时机获取的到是不一样的，因为它底层调用的是<code>GetSystemTime</code>(Windows)。</p>
<h2 id="uexp和ubulk的作用"><a href="#uexp和ubulk的作用" class="headerlink" title="uexp和ubulk的作用"></a>uexp和ubulk的作用</h2><blockquote>
<p>Rather than one large asset, these allow us to write an asset’s bulk data (.ubulk) and exports (uexp) out into separate files. This system improves perf in certain circumstances where file read contiguity is lost due to the large size of assets. This feature avoids this by enabling the reader to skip over an asset’s bulk data when seeking to the next file in a series without having to actually have serialized and seeked past that data (since it’s in separate file).</p>
</blockquote>
<p>为了优化性能把资源的信息和数据进行拆分，在进行资源信息的索引时不用访问真正的数据，提高了查找性能和内存消耗。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/587400/what-are-uexp-and-ubulk-files.html">what are uexp and ubulk files?</a></li>
</ul>
<h2 id="资源调试命令"><a href="#资源调试命令" class="headerlink" title="资源调试命令"></a>资源调试命令</h2><p>可以在Console中使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj list</span><br></pre></td></tr></table></figure>
<p>会列出当前的资源加载信息：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">                          Class    Count      NumKB      MaxKB   ResExcKB  ResExcDedSysKB  ResExcShrSysKB  ResExcDedVidKB  ResExcShrVidKB     ResExcUnkKB</span><br><span class="line">                          Class     4331   10240.85   12969.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       FontFace        9    9498.02    9498.02    9495.54         9495.54            0.00            0.00            0.00            0.00</span><br><span class="line">                       MetaData      732    8441.93    8441.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   ScriptStruct     2165    3923.20    5156.56       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   SkeletalMesh        1    3988.86    3989.04    1974.06           30.55            0.00            0.00            0.00         1943.52</span><br><span class="line">                       Function     7928    2012.63    2457.73       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                        Package      732    1316.65    1453.87       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                           Enum     1275     312.38     760.76       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                  DeviceProfile       85     409.36     661.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       Material      103     418.41     467.83    4722.42         4722.42            0.00            0.00            0.00            0.00</span><br><span class="line">                       ToolMenu       36     193.83     466.16       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">               DelegateFunction      652     165.51     185.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      Texture2D      146     111.05     111.05   56192.00            0.00            0.00        56192.00            0.00            0.00</span><br><span class="line">     MaterialExpressionMultiply      194      66.84      98.67       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                     StaticMesh       29      77.02      98.41    2055.31           23.56            0.00            0.00            0.00         2031.75</span><br><span class="line">MaterialExpressionTextureSample       61      44.87      79.66       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">       MaterialExpressionCustom       68      59.53      70.68       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">        MaterialInstanceDynamic       32      53.74      65.76      16.45           16.45            0.00            0.00            0.00            0.00</span><br><span class="line">                 GameNetworkMgr        1      64.43      64.43       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      BodySetup       41      42.91      62.30    1158.44         1158.44            0.00            0.00            0.00            0.00</span><br><span class="line">     MaterialExpressionConstant      153      36.16      61.26       0.00            0.00            0.00            0.00            0.00            0.00</span><br></pre></td></tr></table></figure>

<p>还有下列相关的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Mem FromReport</span><br><span class="line">obj list -alphasort</span><br><span class="line">rhi.DumpMemory</span><br><span class="line">LogOutStatLevels</span><br><span class="line">ListSpawnedActors</span><br><span class="line">DumpParticleMem</span><br><span class="line">ConfigMem</span><br><span class="line">r.DumpRenderTargetPoolMemory</span><br><span class="line">ListTextures -alphasort</span><br><span class="line">ListSounds -alphasort</span><br><span class="line">ListParticleSystems -alphasort</span><br><span class="line">obj list class=SoundWave -alphasort</span><br><span class="line">obj list class=SkeletalMesh -alphasort</span><br><span class="line">obj list class=StaticMesh -alphasort</span><br><span class="line">obj list class=Level -alphasort</span><br></pre></td></tr></table></figure>
<p>也可以使用<code>memreport</code>来进行详细的分析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memreport -full</span><br></pre></td></tr></table></figure>
<p>会在<code>Saved/Profiling/MemReports</code>下创建<code>.memreport</code>文件。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/blog/debugging-and-optimizing-memory">Debugging and Optimizing Memory</a></li>
<li><a target="_blank" rel="noopener" href="https://pzurita.wordpress.com/2015/02/10/limitations-of-memory-tracking-features-in-unreal-engine-4/">Limitations of memory tracking features in Unreal Engine 4</a></li>
</ul>
<h2 id="IOS基础包拆分"><a href="#IOS基础包拆分" class="headerlink" title="IOS基础包拆分"></a>IOS基础包拆分</h2><p>在前面提到了UE为Android提供了打包到obb中的文件过滤规则：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+ObbFilters=-pakchunk1-*</span><br></pre></td></tr></table></figure>
<p>但是UE并没有为IOS提供相应的操作，默认情况下会把IOS的所有的pak文件都打包至IPA中。</p>
<p>为了统一Android和IOS的基础包规则，我自己实现了IOS上类似Android那种指定过滤规则的功能，做个简单的介绍。</p>
<p>我使用的是Mac远程打包，流程是在Mac上编译代码生成IPA，拉回Win，在Win上进行Cook，生成Pak文件，最后把原始IPA解包，再添加Pak等文件组合成最终IPA。</p>
<p>我的需求是，自定义指定过滤规则，可以把某些文件忽略，不打包到IPA中。那么这一步的操作其实就位于把IPA解包再打包的流程里，经过翻阅UE的代码，发现这个操作是通过<code>iPhonePackager</code>这个独立程序来实现的，那么就需要对这个程序的代码进行改造了。</p>
<p>经过调试分析，发现真正实现重新打包IPA的操作是在以下函数中执行的：</p>
<figure class="highlight plain"><figcaption><span>Programs/IOS/iPhonePackager/CookTime.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** </span><br><span class="line">* Using the stub IPA previously compiled on the Mac, create a new IPA with assets</span><br><span class="line">*&#x2F;</span><br><span class="line">static public void RepackageIPAFromStub();</span><br></pre></td></tr></table></figure>
<p>该函数位于<code>iPhonePackager</code>-<code>CookTime</code>类中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// read file to memory,add to ZipFileSystem</span></span><br><span class="line">       <span class="comment">// generate stub and ipa</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要做的操作就是介入这个过程，把<code>PayloadFiles</code>中的文件列表通过我们自定义的规则来执行过滤。</p>
<p>从流程上分为以下几个步骤：</p>
<ol>
<li>从项目中读取Filter的配置</li>
<li>创建出真正的过滤器</li>
<li>在<code>RepackageIPAFromStub</code>遍历文件的流程里使用过滤器进行检测是否需要被打入ipa</li>
</ol>
<p>只需要几十行代码就可以实现，首先需要添加一个IniReader的类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Tools.DotNETCommon;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> Ini;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Ini</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IniReader</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> path;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">GetPrivateProfileString</span>(<span class="params"><span class="built_in">string</span> section, <span class="built_in">string</span> key, <span class="built_in">string</span> def,</span></span></span><br><span class="line"><span class="function"><span class="params">      StringBuilder retVal, <span class="built_in">int</span> size, <span class="built_in">string</span> filePath</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IniReader</span>(<span class="params"><span class="built_in">string</span> INIPath</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      path = INIPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ReadValue</span>(<span class="params"><span class="built_in">string</span> Section, <span class="built_in">string</span> Key</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      StringBuilder ReaderBuffer = <span class="keyword">new</span> StringBuilder(<span class="number">255</span>);</span><br><span class="line">      <span class="built_in">int</span> ret = GetPrivateProfileString(Section, Key, <span class="string">&quot;&quot;</span>, ReaderBuffer, <span class="number">255</span>, <span class="keyword">this</span>.path);</span><br><span class="line">      <span class="keyword">return</span> ReaderBuffer.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>RepackageIPAFromStub</code>函数中创建过滤器：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FileFilter IpaPakFileFilter = <span class="keyword">new</span> FileFilter(FileFilterType.Include);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">string</span> ProjectDir = Directory.GetParent(Path.GetFullPath(Config.ProjectFile)).FullName;</span><br><span class="line">  <span class="comment">// Program.Log(&quot;ProjectDir path &#123;0&#125;&quot;, ProjectDir);</span></span><br><span class="line">  <span class="built_in">string</span> EngineIni = Path.Combine(ProjectDir,<span class="string">&quot;Config&quot;</span>,<span class="string">&quot;DefaultEngine.ini&quot;</span>);</span><br><span class="line">  <span class="comment">// Program.Log(&quot;EngineIni path &#123;0&#125;&quot;, EngineIni);</span></span><br><span class="line">  IniReader EngineIniReader = <span class="keyword">new</span> IniReader(EngineIni);</span><br><span class="line">  <span class="comment">// string RawPakFilterRules = EngineIniReader.ReadValue(&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;, &quot;IPAFilters&quot;);</span></span><br><span class="line">  Program.Log(<span class="string">&quot;RawPakFilterRules &#123;0&#125;&quot;</span>, RawPakFilterRules);</span><br><span class="line">  <span class="built_in">string</span>[] PakRules = RawPakFilterRules.Split(<span class="string">&#x27;,&#x27;</span>);   </span><br><span class="line">  <span class="comment">// foreach(string Rule in PakRules) &#123;Program.Log(&quot;PakRules &#123;0&#125;&quot;, Rule);&#125;</span></span><br><span class="line">  </span><br><span class="line">  List&lt;<span class="built_in">string</span>&gt; PakFilters = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(PakRules);</span><br><span class="line">  <span class="keyword">if</span> (PakFilters != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    IpaPakFileFilter.AddRules(PakFilters);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里从项目的<code>Config/DefaultEngine.ini</code>的[/Script/IOSRuntimeSettings.IOSRuntimeSettings]项读取<code>IPAFilters</code>的值，规则与Android相同，但是要把规则都写在一行，多个规则以逗号分隔。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IPAFilters</span>=-*.pak,pakchunk0-*</span><br></pre></td></tr></table></figure>

<p>最终，还需要在<code>RepackageIPAFromStub</code>遍历<code>Payload</code>文件的循环中进行检测是否匹配我们指定的过滤规则：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!IpaPakFileFilter.Matches(Filename))</span><br><span class="line">    &#123;</span><br><span class="line">      Program.Log(<span class="string">&quot;IpaPakFileFilter not match file &#123;0&#125;&quot;</span>, Filename);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Program.Log(&quot;IpaPakFileFilter  match file &#123;0&#125;&quot;, Filename);</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样再执行打包IOS，就会按照指定的过滤规则来添加文件了，实现了与Android上一致的行为。</p>
<p>打包过程中的Log如下（上文代码已注释）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Saving IPA ...</span><br><span class="line">ProjectDir path C:\BuildAgent\workspace\PackageWindows\Client</span><br><span class="line">EngineIni path C:\BuildAgent\workspace\PackageWindows\Client\Config\DefaultEngine.ini</span><br><span class="line">RawPakFilterRules -*.pak,pakchunk0-*</span><br><span class="line">PakRules -*.pak</span><br><span class="line">PakRules pakchunk0-*</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Assets.car</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Info.plist</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\LaunchScreenIOS.webp</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_DebugFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_NonUFSFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\mute.caf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\ue4commandline.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\logo.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\sparkmore.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk0-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk1-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk2-ios.pak</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Engine\Content\SlateDebug\Fonts\LastResort.ttf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\config.json</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\libwxvoiceembed.bin</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\mute_detection.aiff</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GRobotResource.bundle\config.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，过滤规则已经生效了。</p>
<h2 id="Android基础包拆分"><a href="#Android基础包拆分" class="headerlink" title="Android基础包拆分"></a>Android基础包拆分</h2><p>在打包时，不想要把所有的资源都打包到apk中，所以可以在打包时进行拆分，只把必要资源打包到apk中，首先需要把基础包中的资源进行pak拆分，可以把通过<code>Project Settings</code>-<code>Asset Manager</code>中进行设置或者通过创建<code>PrimaryAssetLable</code>资源进行标记。</p>
<p>目标是：</p>
<ol>
<li>把基础包的打包资源拆分到多个Pak中</li>
<li>只把必要的pak文件打包到apk里</li>
<li>其余的pak在运行时进行下载</li>
</ol>
<p>第一步都可以通过项目设置进行控制，第二部的条件就是要实现一个过滤规则，不过UE已经提供了这个机制，可以指定过滤掉哪些文件，只需要添加配置即可。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+ObbFilters=-pakchunk1-*</span><br><span class="line">+ObbFilters=-pakchunk2-*</span><br><span class="line">+ObbFilters=-pakchunk3-*</span><br></pre></td></tr></table></figure>
<p>ObbFilters的规则以<code>-</code>开头就是排除规则，会把基础包中的<code>chunk1-3</code>的pak给过滤掉，可以用于后续的下载流程。</p>
<p>也可以指定<code>Exclute</code>和<code>Include</code>规则组合来用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ObbFilters=-*.pak</span><br><span class="line">+ObbFilters=pakchunk0-*</span><br></pre></td></tr></table></figure>
<p>第一步忽略掉所有的pak文件，然后把<code>pakchunk0-*.pak</code>显式添加至obb中。</p>
<h2 id="UMG-OnTouchStarted不触发"><a href="#UMG-OnTouchStarted不触发" class="headerlink" title="UMG OnTouchStarted不触发"></a>UMG OnTouchStarted不触发</h2><p>注意不要使用UButton来作为触发控件来接收OnTouchStarted的事件，使用Board或者Image都可以，但是UButton不行，估计是UButton拦截了事件。</p>
<h2 id="监听资源操作事件"><a href="#监听资源操作事件" class="headerlink" title="监听资源操作事件"></a>监听资源操作事件</h2><p>可以通过<code>IAssetRegistry</code>获取到下列事件的delegate并监听：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FAssetAddedEvent, FAssetAddedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetAddedEvent&amp; <span class="title">OnAssetAdded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetAddedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FAssetRemovedEvent, FAssetRemovedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRemovedEvent&amp; <span class="title">OnAssetRemoved</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRemovedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FAssetRenamedEvent, FAssetRenamedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRenamedEvent&amp; <span class="title">OnAssetRenamed</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRenamedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FAssetUpdatedEvent, FAssetUpdatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetUpdatedEvent&amp; <span class="title">OnAssetUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetUpdatedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetCreatedEvent, FInMemoryAssetCreatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetCreatedEvent&amp; <span class="title">OnInMemoryAssetCreated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetCreatedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetDeletedEvent, FInMemoryAssetDeletedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetDeletedEvent&amp; <span class="title">OnInMemoryAssetDeleted</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetDeletedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FFilesLoadedEvent, FFilesLoadedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFilesLoadedEvent&amp; <span class="title">OnFilesLoaded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadedEvent; &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DERIVED_EVENT</span>( UAssetRegistryImpl, IAssetRegistry::FFileLoadProgressUpdatedEvent, FFileLoadProgressUpdatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFileLoadProgressUpdatedEvent&amp; <span class="title">OnFileLoadProgressUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadProgressUpdatedEvent; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Android-not-found-uproject"><a href="#Android-not-found-uproject" class="headerlink" title="Android not found uproject"></a>Android not found uproject</h2><p>UE中有一个BUG，在4.25.1引擎版本中可以复现，步骤如下：</p>
<ol>
<li>安装apk，第一次启动游戏</li>
<li>打开UE的沙盒数据目录<code>UE4Game/PROJECTNAME</code>，在这个目录下创建<code>Content/Paks</code>目录</li>
<li>重新启动游戏</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210121220607.webp"></p>
<p>Log中也有<code>Project file not found: ../../../FGame/FGame.uproject</code>提示。</p>
<p>在Android上自动挂载的Pak文件可以放到<code>Saved/Paks</code>下，有时间具体分析一下这个问题。</p>
<h2 id="提取chunk的paklist文件"><a href="#提取chunk的paklist文件" class="headerlink" title="提取chunk的paklist文件"></a>提取chunk的paklist文件</h2><p>在开启<code>Generate Chunks</code>之后，如果项目中有添加<code>PrimaryAssetLable</code>资源，会生成对应的Chunk文件。<br>生成的paklist文件所在目录为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 源码版</span><br><span class="line">Engine\Programs\AutomationTool\Saved\Logs</span><br><span class="line"># 安装版</span><br><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.26</span><br><span class="line"># 安装版 BuildCookRun</span><br><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.26\BuildCookRun</span><br></pre></td></tr></table></figure>
<p>paklist相关的文件列表如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PakList_pakchunk0-WindowsNoEditor.txt</span><br><span class="line">PakList_pakchunk1-WindowsNoEditor.txt</span><br><span class="line">PakList_pakchunk2-WindowsNoEditor.txt</span><br><span class="line">PrePak_WindowsNoEditor_NonUFSFiles.txt</span><br><span class="line">PrePak_WindowsNoEditor_NonUFSFilesDebug.txt</span><br><span class="line">PrePak_WindowsNoEditor_UFSFiles.txt</span><br></pre></td></tr></table></figure>
<p>需要重点关注的是<code>PakList_pakchunk*.txt</code>和<code>PrePak*_UFSFiles.txt</code>这几个文件，<code>NonUFSFiles.txt</code>中的文件不会被打包到Pak中。<br><code>PakList_pakchunk*.txt</code>中是每一个chunk中包含的文件，并且是以<code>绝对路径 Mount路径</code>的方式来组织的，<code>PrePak*_UFSFiles.txt</code>是当前打包的版本中所有包含的文件，但其中的路径不是<code>绝对路径 Mount路径</code>。</p>
<p>在项目设置中添加的<code>NoUFS</code>文件夹都会默认打包到<code>chunk0</code>的pak中。</p>
<p>在Windows上可以使用以下命令来自动拷贝：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> f|xcopy /y/i/s/e <span class="string">&quot;%AppData%\Unreal Engine\AutomationTool\Logs\E+UnrealEngine+Launcher+UE_4.25\PakList_*.txt&quot;</span> <span class="string">&quot;E:\ClientVersion\0.0.1.0&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="IOS远程构建最大文件不能超过2G"><a href="#IOS远程构建最大文件不能超过2G" class="headerlink" title="IOS远程构建最大文件不能超过2G"></a>IOS远程构建最大文件不能超过2G</h2><p>Win上远程构建出IOS包的流程是代码和bundle都上传到Mac上编译，生成不包含资源的IPA，拉回本地执行资源Cook生成Pak后，把代码的IPA和资源的Pak合并成真正的IPA文件。<br>但是这样有个问题，UE里的实现是把所有要合并的文件读到内存中再合并打包的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Add all of the payload files, replacing existing files in the stub IPA if necessary (should only occur for icons)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">    <span class="built_in">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Get the relative path to the file (this implementation only works because we know the files are all</span></span><br><span class="line">      <span class="comment">// deeper than the base dir, since they were generated from a search)</span></span><br><span class="line">      <span class="built_in">string</span> AbsoluteFilename = Path.GetFullPath(Filename);</span><br><span class="line">      <span class="built_in">string</span> RelativeFilename = AbsoluteFilename.Substring(SourceDir.Length + <span class="number">1</span>).Replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">string</span> ZipAbsolutePath = String.Format(<span class="string">&quot;Payload/&#123;0&#125;&#123;1&#125;.app/&#123;2&#125;&quot;</span>,</span><br><span class="line">        Config.GetTargetName(),</span><br><span class="line">        Program.Architecture,</span><br><span class="line">        RelativeFilename);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">byte</span>[] FileContents = File.ReadAllBytes(AbsoluteFilename);</span><br><span class="line">      <span class="keyword">if</span> (FileContents.Length == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Zero-length files added by Ionic cause installation/upgrade to fail on device with error 0xE8000050</span></span><br><span class="line">        <span class="comment">// We store a single byte in the files as a workaround for now</span></span><br><span class="line">        FileContents = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1</span>];</span><br><span class="line">        FileContents[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FileSystem.WriteAllBytes(RelativeFilename, FileContents);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((FileContents.Length &gt;= <span class="number">1024</span> * <span class="number">1024</span>) || (Config.bVerbose))</span><br><span class="line">      &#123;</span><br><span class="line">        FilesBeingModifiedToPrintOut.Add(ZipAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到是把Payload的每个文件读到<code>byte[]</code>里的，这就有了一个限制，在C#中，数组的长度最大是<code>int32.MaxValue</code>，意味着<code>byte[]</code>不能存储超过2G的文件，不然就会触发异常。<br>查询了MSDN的文档，发现设置<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/configure-apps/file-schema/runtime/gcallowverylargeobjects-element?redirectedfrom=MSDN">gcAllowVeryLargeObjects</a>也不会改变单个维度的数组的大小。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3944320/maximum-length-of-byte">Maximum length of byte[]?</a></li>
</ul>
<p>所以这个问题只能从其他方面入手了，让UE进行资源打包的时候把Pak的文件拆分，让每个文件都小于2GB即可，可以通过UE里的Chunk机制进行拆分。</p>
<h2 id="DS产生corefile"><a href="#DS产生corefile" class="headerlink" title="DS产生corefile"></a>DS产生corefile</h2><p>在Shipping的时候DS Crash可以通过启动参数<code>-core</code>来指定可以生成core文件。 </p>
<h2 id="指定SkeletalMesh的LOD级别"><a href="#指定SkeletalMesh的LOD级别" class="headerlink" title="指定SkeletalMesh的LOD级别"></a>指定SkeletalMesh的LOD级别</h2><p>可以直接对设置ForcedLodModel的值（LOD0需要设置1，实际的LOD级别就是N-1，值为0则是自动）： </p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210115214317.webp">  </p>
<p>也可以对<code>USkinnedMeshComponent</code>实例调用<code>SetForcedLOD</code>函数：  </p>
<figure class="highlight cpp"><figcaption><span>Runtime/Engine/Classes/Components/SkinnedMeshComponent.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get ForcedLodModel of the mesh component. Note that the actual forced LOD level is the return value minus one and zero means no forced LOD </span></span><br><span class="line"><span class="function">int32 <span class="title">USkinnedMeshComponent::GetForcedLOD</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function"><span class="comment">// Set new ForcedLODModel that forces to set the incoming LOD. Range from [1, Max Number of LOD]. This will affect in the next tick update. </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USkinnedMeshComponent::SetForcedLOD</span><span class="params">(int32 InNewForcedLOD)</span>  </span></span><br></pre></td></tr></table></figure>

<p>可以用在背包中显示3D模型的场景，避免使用比较低的LOD级别。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://qiita.com/7ukey/items/f0c4ef7c93ea28171174">SkeletalMeshのLODバイアスを強制する</a> </li>
</ul>
<h2 id="HotPatcher的自动化导出Release脚本"><a href="#HotPatcher的自动化导出Release脚本" class="headerlink" title="HotPatcher的自动化导出Release脚本"></a>HotPatcher的自动化导出Release脚本</h2><p>组合命令使用HotPatcher的Commandlet，实现Release信息的自动化导出：  </p>
<figure class="highlight python"><figcaption><span>HotRelease.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line"><span class="keyword">import</span> argparse </span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;used for build engine or project&quot;</span>)  </span><br><span class="line">hot_release = parser.add_argument_group(<span class="string">&#x27;HotRelease&#x27;</span>) </span><br><span class="line"><span class="comment"># project </span></span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--enginebin&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;UE4Editor-cmd.exe binary path&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--projectdir&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;project root directory&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--projectname&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;project name,match projectname.uproject&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--versiondir&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;client version file dir&#x27;</span>) </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--versionid&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;current release version id&#x27;</span>) </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--outdir&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;export release result save dir&#x27;</span>)  </span><br><span class="line">platform_list=[ </span><br><span class="line">    <span class="string">&quot;WindowsNoEditor&quot;</span>,  </span><br><span class="line">    <span class="string">&quot;Android_ASTC&quot;</span>, </span><br><span class="line">    <span class="string">&quot;IOS&quot;</span>,  </span><br><span class="line">] </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPlatformPakListName</span>(<span class="params">PlatformName,ProjectName</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PakList_%s-%s.txt&quot;</span> % (ProjectName,PlatformName) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getProjectFullPath</span>(<span class="params">ProjectDir,ProjectName</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;%s\\%s.uproject&quot;</span> % (ProjectDir,ProjectName) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_platform_paklist</span>(<span class="params">clientversion_path,versionid,project_name</span>):</span>  </span><br><span class="line">    result_dict = &#123;&#125;  </span><br><span class="line">    <span class="keyword">if</span> os.path.exists(clientversion_path):  </span><br><span class="line">        version_paklist_path = os.path.normpath(os.path.abspath(os.path.join(clientversion_path, versionid))) </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;versionid: %s&quot;</span> % versionid)  </span><br><span class="line">        <span class="keyword">for</span> platform <span class="keyword">in</span> platform_list:  </span><br><span class="line">            platform_paklist_path = os.path.join(version_paklist_path, getPlatformPakListName(platform,project_name)) </span><br><span class="line">            <span class="keyword">if</span> os.path.exists(platform_paklist_path): </span><br><span class="line">                result_dict[platform] = platform_paklist_path </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;platform:%s paklist:%s&quot;</span> % (platform,result_dict[platform]))  </span><br><span class="line">    <span class="keyword">return</span> result_dict  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ExportRelease</span>(<span class="params">versionid,engine_bin_path,project_dir,project_name,platform_paklist_dict,savepath</span>):</span> </span><br><span class="line">    AddPlatformPakListCmd = <span class="string">&quot;-AddPlatformPakList=&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> platform_paklist_dict.items(): </span><br><span class="line">        AddPlatformPakListCmd = <span class="string">&quot;%s%s+%s,&quot;</span> % (AddPlatformPakListCmd,key,value)  </span><br><span class="line">    <span class="built_in">print</span>(AddPlatformPakListCmd)  </span><br><span class="line">    commands_tuple = [  </span><br><span class="line">        engine_bin_path,  </span><br><span class="line">        getProjectFullPath(project_dir,project_name), </span><br><span class="line">        <span class="string">&quot;-run=HotRelease&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;-versionid=%s&quot;</span> % (versionid),  </span><br><span class="line">        <span class="string">&quot;-byPakList=true&quot;</span>,  </span><br><span class="line">        AddPlatformPakListCmd,  </span><br><span class="line">        <span class="string">&quot;-savepath.path=%s&quot;</span> % (savepath), </span><br><span class="line">        <span class="comment"># &quot;-wait&quot; </span></span><br><span class="line">    ] </span><br><span class="line">    final_cmd = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> commands_tuple:  </span><br><span class="line">        final_cmd = <span class="string">&quot;%s %s&quot;</span> % (final_cmd,param) </span><br><span class="line">    <span class="built_in">print</span>(final_cmd)  </span><br><span class="line">    os.system(final_cmd)  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetArgByName</span>(<span class="params">ParserArgs,ArgName</span>):</span> </span><br><span class="line">    ArgsPairs = ParserArgs.__dict__ </span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> ArgsPairs.items(): </span><br><span class="line">        <span class="keyword">if</span> key == ArgName:  </span><br><span class="line">            <span class="keyword">return</span> value  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printSelectorHelp</span>():</span>  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Args is invalid!&quot;</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span> </span><br><span class="line">    ParserArgs = parser.parse_args()  </span><br><span class="line">    engine_bin_path = GetArgByName(ParserArgs,<span class="string">&quot;enginebin&quot;</span>)  </span><br><span class="line">    project_dir = GetArgByName(ParserArgs,<span class="string">&quot;projectdir&quot;</span>) </span><br><span class="line">    project_name = GetArgByName(ParserArgs,<span class="string">&quot;projectname&quot;</span>) </span><br><span class="line">    version_id = GetArgByName(ParserArgs,<span class="string">&quot;versionid&quot;</span>) </span><br><span class="line">    clientversion_path = GetArgByName(ParserArgs,<span class="string">&quot;versiondir&quot;</span>)  </span><br><span class="line">    outdir = GetArgByName(ParserArgs,<span class="string">&quot;outdir&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> engine_bin_path <span class="keyword">and</span> project_dir <span class="keyword">and</span> project_name <span class="keyword">and</span> version_id <span class="keyword">and</span> clientversion_path <span class="keyword">and</span> outdir: </span><br><span class="line">        ExportRelease(  </span><br><span class="line">            version_id, </span><br><span class="line">            engine_bin_path,  </span><br><span class="line">            project_dir,  </span><br><span class="line">            project_name, </span><br><span class="line">            get_platform_paklist(clientversion_path,version_id,project_name), </span><br><span class="line">            outdir  </span><br><span class="line">            ) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        printSelectorHelp() </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">   main() </span><br></pre></td></tr></table></figure>

<h2 id="Texture的压缩"><a href="#Texture的压缩" class="headerlink" title="Texture的压缩"></a>Texture的压缩</h2><p>之前的笔记中，提到过可以在<code>Project Settings</code>-<code>Cooker</code>-<code>Texture</code>-<code>ASTC Compression vs Size</code>可以设置默认的资源质量和大小的级别： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>
<p>在Texture的资源编辑中也可以针对某个Texture单独设置： </p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112154624.webp">  </p>
<p>Lowest-&gt;Hightest对应着<code>0-4</code>的值，使用Default则使用项目设置中的配置。  </p>
<p>并且，设置<code>Compression Settings</code>的类型也会对资源压缩的类型有差别，Default则是项目设置中的参数，如果设置成NormalMap的类型会是<code>ASTC_4x4</code>的。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.nvidia.com/astc-texture-compression-for-game-assets#_Toc398571904">Using ASTC Texture Compression for Game Assets</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a> </li>
</ul>
<h2 id="listtextures"><a href="#listtextures" class="headerlink" title="listtextures"></a>listtextures</h2><p>控制台命令<code>listtextures</code>可以列出已被加载过的Texture的信息。  </p>
<h2 id="Unreal-Insights实时分析Android"><a href="#Unreal-Insights实时分析Android" class="headerlink" title="Unreal Insights实时分析Android"></a>Unreal Insights实时分析Android</h2><p>上一节提到了使用<code>SessionFrontEnd</code>实时分析Android的方法，在实际的测试当中发现不太稳定，会造成游戏的Crash，UE在新的引擎版本中也提供了新的性能分析工具Unreal Insights，可以更方便和直观地进行Profile。<br>文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/index.html">Unreal Insights</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/index.html">Unreal Insights Reference</a></li>
</ul>
<p>同样也需要端口映射，需要把PC的1980端口映射到设备上： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb reverse tcp:1980 tcp:1980 </span><br></pre></td></tr></table></figure>
<p>然后需要给Android设备添加启动命令： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=&quot;lipengzha&quot; -SessionName=&quot;Launch On Android Device&quot; -iterative -tracehost=127.0.0.1 -Trace=CPU </span><br></pre></td></tr></table></figure>

<p>在PC上开启Unreal Insights，在手机上启动游戏，即可实时捕获：  </p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20210112171826.webp">  </p>
<p>Unreal Insights也可以实时捕获PIE的数据，需要在Editor启动时添加<code>-trace</code>参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe PROJECT_NAME.uproject -trace=counters,cpu,frame,bookmark,gpu</span><br></pre></td></tr></table></figure>
<p>在启动游戏后在Unreal Insights里通过<code>New Connection</code>监听127.0.0.1即可。</p>
<h2 id="SessionFrontEnd实时Profile-Android"><a href="#SessionFrontEnd实时Profile-Android" class="headerlink" title="SessionFrontEnd实时Profile Android"></a>SessionFrontEnd实时Profile Android</h2><p>有几个条件：  </p>
<ol>
<li>需要USB连接PC和手机 </li>
<li>需要安装adb  </li>
</ol>
<p>首先需要映射端口，因为<code>SessionFrontEnd</code>是通过监听端口的方式来与游戏内通信的，手机和PC并不在同一个网段，所以需要以adb的形式把PC的监听端口转发给手机的端口。 </p>
<p>SessionFrontEnd的监听端口可以通过对<code>UE4Editor.exe</code>的端口分析获取：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha&gt;netstat -ano | findstr <span class="string">&quot;231096&quot;</span>  </span><br><span class="line">  TCP    0.0.0.0:1985           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3961           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3963           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    127.0.0.1:4014         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  TCP    127.0.0.1:4199         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  UDP    0.0.0.0:6666           *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:24024          *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:58101          *:*                                    231096 </span><br></pre></td></tr></table></figure>
<p>需要把PC的1985端口映射到Android的1985端口，这样手机上APP启动时，连接<code>0.0.0.0</code>的<code>1985</code>端口就可以连接到PC上的端口。 </p>
<p>通过adb命令来执行： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb reverse tcp:1985 tcp:1985 </span><br></pre></td></tr></table></figure>
<p>然后需要给手机上App指定启动参数：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=<span class="string">&quot;lipengzha&quot;</span> -SessionName=<span class="string">&quot;Launch On Android Device&quot;</span>  </span><br></pre></td></tr></table></figure>
<p>把这些文本保存为<code>UE4Commandline.txt</code>文件，放到项目的数据目录下即可，具体路径为：  </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/UE4Game/PROJECT_NAME/ </span><br></pre></td></tr></table></figure>
<p>之后直接启动App，在PC上的<code>SessionFrontEnd</code>中就可以看到设备的数据了。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/realities-io/oculus-quest-performance-tools-in-unreal-engine-2210f2581c8f">Oculus Quest Performance Tools in Unreal Engine</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Overview/index.html">Unreal Insights Overview</a> </li>
</ul>
<h2 id="C-中获取引擎的版本信息"><a href="#C-中获取引擎的版本信息" class="headerlink" title="C++中获取引擎的版本信息"></a>C++中获取引擎的版本信息</h2><p>可以通过<code>FEngineVersion</code>来获取：  </p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Misc/EngineVersion.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Gets the current engine version */</span>  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FEngineVersion&amp; <span class="title">Current</span><span class="params">()</span></span>; </span><br></pre></td></tr></table></figure>

<h2 id="判断对象是否有效的方式与区别"><a href="#判断对象是否有效的方式与区别" class="headerlink" title="判断对象是否有效的方式与区别"></a>判断对象是否有效的方式与区别</h2><p>在UE中的UObject对象实例传递和存储都是以<code>UObject*</code>的指针来存储的，因为指针只是一块内存的地址，而这块内存是否是有效的对象是不清楚的。所以需要有不同检测方式来检测，一般情况下有以下几种状态： </p>
<ol>
<li>指针为NULL/nullptr  </li>
<li>指针非NULL，对象被GC标记为PaddingKill  </li>
<li>一块无效的内存地址  </li>
</ol>
<p>如果指针地址是一个无效的内存地址，那么不能通过它来调用任何获取/修改到任何数据成员的函数的。如果对无效的内存地址调用IsPaddingKill的，会Crash，所以要从更底层的角度来检测。  </p>
<p>这三种状态可以通过以下几种检测方式来判断： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测指针是否为Null，对象是否被注册(UClass是否存在)  </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Checks to see if the object appears to be valid </span></span><br><span class="line"><span class="comment">* @return true if this appears to be a valid object </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsValidLowLevel</span><span class="params">()</span> <span class="keyword">const</span></span>; </span><br><span class="line"><span class="comment">// 从内存布局上检测对象是否有效，并会检测对象的CDO/UClass是否存在 </span></span><br><span class="line"><span class="comment">// 可以用于加载资源的检测  </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Faster version of IsValidLowLevel.  </span></span><br><span class="line"><span class="comment">* Checks to see if the object appears to be valid by checking pointers and their alignment. </span></span><br><span class="line"><span class="comment">* Name and InternalIndex checks are less accurate than IsValidLowLevel. </span></span><br><span class="line"><span class="comment">* @param bRecursive true if the Class pointer should be checked with IsValidLowLevelFast  </span></span><br><span class="line"><span class="comment">* @return true if this appears to be a valid object </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsValidLowLevelFast</span><span class="params">(<span class="keyword">bool</span> bRecursive = <span class="literal">true</span>)</span> <span class="keyword">const</span></span>; </span><br><span class="line"><span class="comment">// 检测指针是否为null，以及是否被GC清理，如果指针是无效的内存地址会Crash </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Test validity of object </span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* @param  Test      The object to test  </span></span><br><span class="line"><span class="comment">* @return Return true if the object is usable: non-null and not pending kill  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">IsValid</span><span class="params">(<span class="keyword">const</span> UObject *Test)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="keyword">return</span> Test &amp;&amp; !Test-&gt;<span class="built_in">IsPendingKill</span>();  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>


<h2 id="M1-Mac的UE4-26兼容性报告"><a href="#M1-Mac的UE4-26兼容性报告" class="headerlink" title="M1 Mac的UE4.26兼容性报告"></a>M1 Mac的UE4.26兼容性报告</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/ios-development/1844977-m1-mac-4-26-compatibility-report">M1 Mac 4.26 Compatibility Report</a> </li>
</ul>
<h2 id="UMG-CanvasPanel合批"><a href="#UMG-CanvasPanel合批" class="headerlink" title="UMG CanvasPanel合批"></a>UMG CanvasPanel合批</h2><p>在<code>Project Settings</code>-<code>Engine</code>-<code>Slate Settings</code>中开启<code>Explicit Canvas Child ZOrder</code>可以开启Canvas的合并。  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wangjie.rocks/2018/08/19/ue4-canvas-batch/">UE4 CanvasPanel 渲染批次合并分析优化</a>  </li>
</ul>
<h2 id="蓝图节点右上角标识的含义"><a href="#蓝图节点右上角标识的含义" class="headerlink" title="蓝图节点右上角标识的含义"></a>蓝图节点右上角标识的含义</h2><ul>
<li><a target="_blank" rel="noopener" href="https://microsoft.tistory.com/991">The Legend of the Blueprint Icons</a>  </li>
</ul>
<h2 id="OptimizeCode代码优化"><a href="#OptimizeCode代码优化" class="headerlink" title="OptimizeCode代码优化"></a>OptimizeCode代码优化</h2><blockquote>
<p>注意：如果<strong>关闭代码优化</strong>导致构造对象Crash（或者new走不到对象的构造函数），需要检查项目和插件的代码中是否有重名的类，会导致一些奇怪的问题。<br>在build.cs中可以通过<code>OptimizeCode</code>来控制是否执行代码优化：  </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OptimizeCode = CodeOptimization.InShippingBuildsOnly; </span><br></pre></td></tr></table></figure>
<p>有以下几个可选值： </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> CodeOptimization  </span><br><span class="line">&#123; </span><br><span class="line">  Never,  </span><br><span class="line">  InNonDebugBuilds, </span><br><span class="line">  InShippingBuildsOnly, </span><br><span class="line">  Always, </span><br><span class="line">  Default,  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>当开启优化时，对翻译单元的编译指令参数：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Ox </span><br><span class="line">/Ot </span><br><span class="line">/GF </span><br><span class="line">/Zo </span><br></pre></td></tr></table></figure>
<p>并且会使用优化版本的<code>Engine/SharedPCH.Engine.h</code>。  </p>
<p>当关闭优化时的编译指令为： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Od </span><br></pre></td></tr></table></figure>
<p>会使用非优化版本的<code>Engine/SharedPCH.Engine.NonOptimized.h</code>.  </p>
<h2 id="ASTC-Compression-Quality-By-Size"><a href="#ASTC-Compression-Quality-By-Size" class="headerlink" title="ASTC Compression Quality By Size"></a>ASTC Compression Quality By Size</h2><p>在项目的DefaultEngine.ini中的<code>[/Script/UnrealEd.CookerSettings]</code>中通过<code>DefaultASTCQualityBySize</code>设置（0-4）： </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/UnrealEd.CookerSettings]</span> </span><br><span class="line"><span class="attr">DefaultASTCQualityBySize</span>=<span class="number">2</span>  </span><br><span class="line"><span class="attr">DefaultASTCQualityBySpeed</span>=<span class="number">3</span> </span><br></pre></td></tr></table></figure>
<p>0-4分别对应以下压缩级别：  </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/vr-ar-development/91476-custom-astc-compression-format">Custom ASTC compression format</a> </li>
<li><a target="_blank" rel="noopener" href="https://developer.nvidia.com/astc-texture-compression-for-game-assets">Using ASTC Texture Compression for Game Assets</a> </li>
</ul>
<h2 id="引擎修改语言的配置存储"><a href="#引擎修改语言的配置存储" class="headerlink" title="引擎修改语言的配置存储"></a>引擎修改语言的配置存储</h2><p>在UE引擎中的的<strong>编辑器偏好设置</strong>中修改<strong>区域和语言</strong>，会被存储在以下文件中： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25\Saved\Config\Windows\EditorSettings.ini  </span><br></pre></td></tr></table></figure>
<p>其值如下： </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Internationalization]</span>  </span><br><span class="line"><span class="attr">Language</span>=zh-Hans  </span><br><span class="line">Culture=  </span><br><span class="line"><span class="attr">Locale</span>=zh-Hans  </span><br></pre></td></tr></table></figure>
<p>如果是英文的，则是<code>en</code>.  </p>
<h2 id="中文赋值给FString"><a href="#中文赋值给FString" class="headerlink" title="中文赋值给FString"></a>中文赋值给FString</h2><p>首先，把文件编码修改为UTF8，然后使用以下方式： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString str = <span class="built_in">UTF8_TO_TCHAR</span>(<span class="string">&quot;中文&quot;</span>);  </span><br></pre></td></tr></table></figure>
<p>注意对UTF8编码的中文不要使用TEXT，因为文件编码UTF8已经是把中文字符串编码成了UTF8的方式，所以可以直接使用<code>&quot;&quot;</code>来包裹中文字符，如果此时使用<code>TEXT</code>作为宽字符存储UTF8的编码，在<code>UTF8_TO_TCHAR</code>中会出现错误。  </p>
<h2 id="IOS相对到绝对路径转换"><a href="#IOS相对到绝对路径转换" class="headerlink" title="IOS相对到绝对路径转换"></a>IOS相对到绝对路径转换</h2><p>在接入的一些库中，需要传递文件的绝对路径，可以通过下面的方式进行转换： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IFileManager::<span class="built_in">Get</span>().<span class="built_in">ConvertToAbsolutePathForExternalAppForRead</span>(*InRelatePath);; </span><br></pre></td></tr></table></figure>
<p>它是定义在<code>IFileManager</code>接口中的一个虚函数，应该在各个平台的PlatformFile中均有自己的实现，但是在Android中依然是相对路径的，不知道UE是不是忘了实现了。  </p>
<p>IOS：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/df84cb430f38ad08ad831f31267d8702b2fefc3e/Engine/Source/Runtime/Core/Public/IOS/IOSPlatformFile.h#L38">Runtime/Core/Public/IOS/IOSPlatformFile.h</a>  </p>
<p>Android上相对路径转换成绝对路径的方式在之前的笔记中有写。</p>
<h2 id="Android相对路径转绝对路径"><a href="#Android相对路径转绝对路径" class="headerlink" title="Android相对路径转绝对路径"></a>Android相对路径转绝对路径</h2><p>有些需求需要把<code>FPaths::ProjectDir()</code>等路径转换为移动设备上的绝对路径，可以参考<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/2bf1a5b83a7076a0fd275887b373f8ec9e99d431/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformFile.cpp#L126">Core/Private/Android/AndroidPlatformFile.cpp#L126</a>中的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs the base path for any files which are not in OBB/pak data</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> FString &amp;<span class="title">GetFileBasePath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> FString BasePath = GFilePathBase + <span class="built_in">FString</span>(FILEBASE_DIRECTORY) + FApp::<span class="built_in">GetProjectName</span>() + <span class="built_in">FString</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> BasePath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">AndroidRelativeToAbsolutePath</span><span class="params">(<span class="keyword">bool</span> bUseInternalBasePath, FString RelPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RelPath.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive))</span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      RelPath.<span class="built_in">RightChopInline</span>(<span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (RelPath.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (bUseInternalBasePath ? GInternalFilePath : <span class="built_in">GetFileBasePath</span>()) / RelPath;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> RelPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="强引用UClass"><a href="#强引用UClass" class="headerlink" title="强引用UClass"></a>强引用UClass</h2><p>如果在UPROPERTY中通过<code>TSubclassOf</code>引用了一个UClass，会导致该UClass的BP的CDO无法被释放：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">URPOPERTY</span>()</span><br><span class="line">TSubclassOf&lt;<span class="class"><span class="keyword">class</span> <span class="title">UClassName</span>&gt;</span> StrongClassRef;</span><br></pre></td></tr></table></figure>
<p>可以使用软引用的方式来解决：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">URPOPERTY</span>()</span><br><span class="line">TSoftClassPtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">UClassName</span>&gt;</span> StrongClassRef;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>TSoftClassPtr is a templatized wrapper around FSoftObjectPtr that works like a TSubclassOf, it can be used in UProperties for blueprint subclasses</p>
</blockquote>
<h2 id="UE4编译代码的真正命令参数"><a href="#UE4编译代码的真正命令参数" class="headerlink" title="UE4编译代码的真正命令参数"></a>UE4编译代码的真正命令参数</h2><p>在之前的文章<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a>中有提到，UE编译模块的时候会执行到<code>ExecuteActions</code>中。<br>那么UE真正编译每个翻译单元的编译器参数是什么呢？<br>在UBT调用ExecuteAction之前，会完成所有编译参数的拼接和预处理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteAction</span><span class="params">(ManagedProcessGroup ProcessGroup, BuildAction Action, List CompletedActions, AutoResetEvent CompletedEvent)</span></span></span><br></pre></td></tr></table></figure>
<p>在Win上是通过调用<code>cl-filter.exe</code>来执行的，而如何把代码和编译参数喂给编译器呢？<br>UE是通过生成了一个<code>.cpp.obj.response</code>来记录当前编译单元的信息的，包含编译器参数和包含目录/输出等等。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201217202145.webp"></p>
<p>该文件在生成位置在模块的Intermediate目录下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\HotPatcherRuntime\FlibPakReader.cpp.obj.response</span><br></pre></td></tr></table></figure>
<p>文件内容太长，可以下载该文件查看：<a href="https://imzlp.com/notes/UE4/ubt/FlibPakReader.cpp.obj.response">FlibPakReader.cpp.obj.response</a></p>
<p>可以使用手动调用<code>cl.exe</code>的方式来执行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cl.exe @CPP_OBJ_RESPONSE_PATH //showIncludes</span><br><span class="line">// <span class="string">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Tools\MSVC\14.27.29110\bin\HostX64\x64\cl.exe&quot;</span>  @<span class="string">&quot;C:\BuildAgent\workspace\PackageWindows\Client\Plugins\UnLua\Intermediate\Build\Win64\UE4\Development\LuaProtobuf\Module.LuaProtobuf.cpp.obj.response&quot;</span> /showIncludes</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/16082078824716.webp"></p>
<h2 id="build-cs添加宏定义的值"><a href="#build-cs添加宏定义的值" class="headerlink" title="build.cs添加宏定义的值"></a>build.cs添加宏定义的值</h2><p>在UE中使用<code>build.cs</code>添加宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PrivateDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;TEST_MACRO_HAS_VALUE=1&quot;</span>);</span><br><span class="line">PublicDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;TEST_MACRO_NOT_VALUE&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>可以指定值，也可以不指定宏的值，但是UE生成时会给没有值的宏为<code>1</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_MACRO_NOT_VALUE 1</span></span><br></pre></td></tr></table></figure>
<p>可以在UE生成的<code>Deginitions.MODULENAME.h</code>中查看，位于以下位置：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\PLATFIRM_NAME\UE4\Development\MODULE_NAME\Definitions.MODULE_NAME.h</span><br></pre></td></tr></table></figure>

<h2 id="编译引擎的命令"><a href="#编译引擎的命令" class="headerlink" title="编译引擎的命令"></a>编译引擎的命令</h2><p>与BuildGraph的方式不同，直接在VS中点UE4编译所使用的命令行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/Build.bat -Target=<span class="string">&quot;UE4Editor Win64 Development&quot;</span> -Target=<span class="string">&quot;ShaderCompileWorker Win64 Development -Quiet&quot;</span> -WaitMutex -FromMsBuild</span><br></pre></td></tr></table></figure>

<h2 id="编辑器检测Actor移动"><a href="#编辑器检测Actor移动" class="headerlink" title="编辑器检测Actor移动"></a>编辑器检测Actor移动</h2><p>可以通过重写<code>Editor</code>中的<code>PostEditMove</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostEditMove</span><span class="params">(<span class="keyword">bool</span> bFinished)</span> <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/API/Runtime/Engine/GameFramework/AActor/PostEditMove/index.html">AActor::PostEditMove</a></li>
</ul>
<h2 id="Actor-Tick-in-Editor"><a href="#Actor-Tick-in-Editor" class="headerlink" title="Actor Tick in Editor"></a>Actor Tick in Editor</h2><p>在Actor的构造函数中开启Tick：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>但是这个只能设置Runtime的Actor的Tick，当想要让Editor下的Actor也能执行Tick，则需要重写Actor的<code>ShouldTickIfViewportsOnly</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">ShouldTickIfViewportsOnly</span><span class="params">()</span><span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ARecastDetourTestingActor::ShouldTickIfViewportsOnly</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>AActor</code>的类中，默认返回false.</p>
<h2 id="UE4-ERROR-Missing-object-file"><a href="#UE4-ERROR-Missing-object-file" class="headerlink" title="UE4 ERROR: Missing object file"></a>UE4 ERROR: Missing object file</h2><p>在编译时遇到以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Missing object file C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Plugins\Runtime\Database\SQLiteCore\Intermediate\Build\Android\UE4\Developmen</span><br><span class="line">t\SQLiteCore\codec.ca7.o listed in C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Plugins\Runtime\Database\SQLiteCore\Intermediate\Build\Android\UE4\Develo</span><br><span class="line">pment\SQLiteCore\SQLiteCore.precompiled</span><br></pre></td></tr></table></figure>
<p>在引擎中添加了代码，并且编译了Android的的平台支持（通过<code>Make Installed Win64</code>），但是在编译IOS时出现这样的报错。<br>经过排查发现，这个错误时找不到<code>codec.ca7.o</code>文件导致的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> List&lt;FileItem&gt; <span class="title">Compile</span>(<span class="params">ReadOnlyTargetRules Target, UEToolChain ToolChain, CppCompileEnvironment BinaryCompileEnvironment, FileReference SingleFileToCompile, ISourceFileWorkingSet WorkingSet, IActionGraphBuilder Graph</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//UEBuildPlatform BuildPlatform = UEBuildPlatform.GetBuildPlatform(BinaryCompileEnvironment.Platform);</span></span><br><span class="line"></span><br><span class="line">  List&lt;FileItem&gt; LinkInputFiles = <span class="keyword">base</span>.Compile(Target, ToolChain, BinaryCompileEnvironment, SingleFileToCompile, WorkingSet, Graph);</span><br><span class="line"></span><br><span class="line">  CppCompileEnvironment ModuleCompileEnvironment = CreateModuleCompileEnvironment(Target, BinaryCompileEnvironment);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the module is precompiled, read the object files from the manifest</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.bUsePrecompiled &amp;&amp; Target.LinkType == TargetLinkType.Monolithic)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(!FileReference.Exists(PrecompiledManifestLocation))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Missing precompiled manifest for &#x27;&#123;0&#125;&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in &#123;0&#125;.build.cs to override.&quot;</span>, Name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PrecompiledManifest Manifest = PrecompiledManifest.Read(PrecompiledManifestLocation);</span><br><span class="line">    <span class="keyword">foreach</span>(FileReference OutputFile <span class="keyword">in</span> Manifest.OutputFiles)</span><br><span class="line">    &#123;</span><br><span class="line">      FileItem ObjectFile = FileItem.GetItemByFileReference(OutputFile);</span><br><span class="line">      <span class="keyword">if</span>(!ObjectFile.Exists)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Missing object file &#123;0&#125; listed in &#123;1&#125;&quot;</span>, OutputFile, PrecompiledManifestLocation);</span><br><span class="line">      &#125;</span><br><span class="line">      LinkInputFiles.Add(ObjectFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> LinkInputFiles;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去插件的<code>Intermediate</code>中查看了一下，确实没有这个文件，估计是拷贝造成的问题。</p>
<h2 id="分隔String为数组"><a href="#分隔String为数组" class="headerlink" title="分隔String为数组"></a>分隔String为数组</h2><p>可以使用FString的<code>ParserIntoArray</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;FString&gt; BreakedPoints;</span><br><span class="line">UFlibAppHelper::<span class="built_in">GetSourceVersion</span>().<span class="built_in">ParseIntoArray</span>(BreakedPoints,<span class="built_in">TEXT</span>(<span class="string">&quot;.&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="UE4-25中ShaderPatch问题"><a href="#UE4-25中ShaderPatch问题" class="headerlink" title="UE4.25中ShaderPatch问题"></a>UE4.25中ShaderPatch问题</h2><p>在4.25引擎版本中调用<code>FShaderCodeLibrary::CreatePatchLibrary</code>来创建ShaderCode Patch会触发check抛异常：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125932.webp"></p>
<p>这是因为<code>FEditorShaderCodeArchive</code>的构造函数中调用了ShaderHashTable的Initialize，并给了默认值<code>0x1000</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FEditorShaderCodeArchive</span>(FName InFormat)</span><br><span class="line">    : <span class="built_in">FormatName</span>(InFormat)</span><br><span class="line">    , <span class="built_in">Format</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Format = <span class="built_in">GetTargetPlatformManagerRef</span>().<span class="built_in">FindShaderFormat</span>(InFormat);</span><br><span class="line">  <span class="built_in">check</span>(Format);</span><br><span class="line"></span><br><span class="line">  SerializedShaders.ShaderHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">  SerializedShaders.ShaderMapHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125525.webp"></p>
<p>导致在后续的流程中(<code>FSerializedShaderArchive::Serialize</code>)调用<code>Initialize</code>的时候check失败了(因为HaseSize已经有值了，并不是0，对其再调用Initialize就触发了check)：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211130200.webp"></p>
<p>查了下<code>FEditorShaderCodeArchive</code>构造函数中调用<code>Initialize</code>的代码是在4.25之后的引擎版本才有的，所以影响到的之后4.25+的版本。<br>代码对比：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922">4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801">4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801</a></li>
</ul>
<p>解决方案：把<code>FSerializedShaderArchive::Serialize</code>中<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>在Editor下注释掉，因为<code>FEditorShaderCodeArchive</code>的代码只在Editor下有效，并且是只在生成ShaderPatch时有用。</p>
<p>这就造成了以下几个问题：</p>
<ol>
<li><code>FEditorShaderCodeArchive</code>的构造只有Eidotor并且ShaderPatch是才有用，也就意味着这里写的<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只有在创建ShaderPatch时才会执行</li>
<li>在打基础包时执行Cook会编译shader，但是不会执行FEditorShaderCodeArchive的构造，<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>也就不会执行，就需要在使用的地方来调用它们的初始化</li>
</ol>
<p>这也是UE中没有管理好这两个状态的地方：在<code>FEditorShaderCodeArchive</code>和<code>FSerializedShaderArchive::Serialize</code>中都做了Initialize的操作，在打基础包时造成了<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>已经被<code>FEditorShaderCodeArchive</code>初始化的情况下又被<code>FSerializedShaderArchive::Serialize</code>执行了一遍，导致Crash，但是我们又不能粗暴地把任何一处的初始化操作去掉，只能通过检测<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>是否已经被执行，来选择性的跳过。</p>
<p>阅读代码可以知道<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只应该执行一次，并且初始化之后HashSize和IndexSize应该具有非0值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Containers/HashTable.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">FHashTable::Initialize</span><span class="params">(uint32 InHashSize, uint32 InIndexSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(HashSize == <span class="number">0u</span>);</span><br><span class="line">  <span class="built_in">check</span>(IndexSize == <span class="number">0u</span>);</span><br><span class="line"></span><br><span class="line">  HashSize = InHashSize;</span><br><span class="line">  IndexSize = InIndexSize;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(HashSize &lt;= <span class="number">0x10000</span>);</span><br><span class="line">  <span class="built_in">check</span>(FMath::<span class="built_in">IsPowerOfTwo</span>(HashSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (IndexSize)</span><br><span class="line">  &#123;</span><br><span class="line">    HashMask = (uint16)(HashSize - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Hash = <span class="keyword">new</span> uint32[HashSize];</span><br><span class="line">    NextIndex = <span class="keyword">new</span> uint32[IndexSize];</span><br><span class="line"></span><br><span class="line">    FMemory::<span class="built_in">Memset</span>(Hash, <span class="number">0xff</span>, HashSize * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Initialize</code>时会检测当前的<code>HashSize</code>和<code>IndexSize</code>是否为0，并在之后进行赋值。所以，我们只要获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>检测它们是否为0即可判断当前的<code>HashTable</code>对象是否已经被<code>Initialize</code>过，但是，UE里的<code>FHashTable</code>里这两个成员都是<code>protected</code>的，只能修改引擎来实现了：</p>
<p>添加获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>属性的成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FHashTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetHashSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> HashSize;&#125;;</span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetIndexSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> IndexSize;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在<code>FSerializedShaderArchive::Serialize</code>进行检测，如果已被初始化则跳过<code>Initialize</code>逻辑：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeArchive.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSerializedShaderArchive::Serialize</span><span class="params">(FArchive&amp; Ar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Ar &lt;&lt; ShaderMapHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderMapEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderEntries;</span><br><span class="line">  Ar &lt;&lt; PreloadEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderIndices;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(ShaderHashes.<span class="built_in">Num</span>() == ShaderEntries.<span class="built_in">Num</span>());</span><br><span class="line">  <span class="built_in">check</span>(ShaderMapHashes.<span class="built_in">Num</span>() == ShaderMapEntries.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Ar.<span class="built_in">IsLoading</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    <span class="keyword">auto</span> ShaderHashInitialized = [](<span class="keyword">const</span> FHashTable&amp; HashTable)-&gt;<span class="keyword">bool</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> HashTable.<span class="built_in">GetHashSize</span>() || HashTable.<span class="built_in">GetIndexSize</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderMapHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderMapHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderMapHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderMapHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderMapHashes[Index]);</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderHashes[Index]);</span><br><span class="line">        ShaderHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以统一ShaderPatch和Runtime的HashTable的Initialize流程。</p>
<p>而且，需要注意的是：生成出来的ShaderPatch的<code>ushaderbytecode</code>文件是与基础包内的文件名一致的，所以不能使用引擎启动时的默认挂载（会导致基础包内的ushaderbytecode文件无法被加载，从而crash）。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp"></p>
<p>应该在挂载之后自己处理ShaderPatch的ushaderbytecode文件的加载，使用以下函数加载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="keyword">const</span> FString&amp; LibraryName, <span class="keyword">const</span> FString&amp; LibraryDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(LibraryName, LibraryDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：ShaderPatch的更新不直接支持Patch的迭代，如：1.0 Metadata + 1.1的ShaderPatch，并不能生成1.2的ShaderPatch，必须要基于1.1的完整Metadata才可以，即每次Patch必须要基于上一次完整的Metadate数据（Project和Global的ushaderbytecode文件），在工程管理上每次打包都需要把完整的Metadata收集起来。</p>
<h2 id="Win和Mac出IOS包的区别"><a href="#Win和Mac出IOS包的区别" class="headerlink" title="Win和Mac出IOS包的区别"></a>Win和Mac出IOS包的区别</h2><p>UE支持以远程构建的方式来出IOS包，Mac上只编译代码，Cook和编译shader等操作在Win上执行，生成的ios包使用ushaderbytecode，而在Mac上打包IOS则会使用Matellib。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201208145952.webp"></p>
<p>Metallib是IOS上的原生shader格式，远程构建出包的ushaderbytecode是Text Shader，在运行时加载实时编译，效率上是有比较大差距的。<br>在UE4.26提供了在Win上编译Metal原生Shader的方法，在4.25及之前的引擎只能使用<code>Enable Shader Compile</code>了。</p>
<h2 id="UE4新地图的Package问题"><a href="#UE4新地图的Package问题" class="headerlink" title="UE4新地图的Package问题"></a>UE4新地图的Package问题</h2><p>发现UE中的一个问题：</p>
<ol>
<li>创建一个新的地图<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201204213024.webp"></li>
<li>获取这个新地图的<code>UPackage</code>，得到的是<code>Engine/Maps/Templates/Template_Default</code><br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201204212642.webp"></li>
</ol>
<p>但是在第二次启动的时候就正常了，怀疑是新建资源的时候没有更新AssetRegistry，有时间具体分析一下原因。</p>
<h2 id="C-加载BP的Enum"><a href="#C-加载BP的Enum" class="headerlink" title="C++加载BP的Enum"></a>C++加载BP的Enum</h2><p>在蓝图中新建的枚举资源，在C++中访问：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">UFlibAppHelper::GetEnumNameByValue</span><span class="params">(TSoftObjectPtr&lt;UUserDefinedEnum&gt; EnumPath, int32 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    UUserDefinedEnum* Enumer = LoadObject&lt;UUserDefinedEnum&gt;(<span class="literal">nullptr</span>, *EnumPath.<span class="built_in">ToString</span>());</span><br><span class="line">    <span class="keyword">if</span> (Enumer)</span><br><span class="line">    &#123;</span><br><span class="line">        result = Enumer-&gt;<span class="built_in">GetDisplayNameTextByValue</span>(value).<span class="built_in">ToString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201203212055.webp"></p>
<h2 id="DS设置超时时间"><a href="#DS设置超时时间" class="headerlink" title="DS设置超时时间"></a>DS设置超时时间</h2><p>修改DefaultEngine.ini：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/OnlineSubsystemUtils.IpNetDriver]</span></span><br><span class="line"><span class="attr">ConnectionTimeout</span>=<span class="number">10.0</span></span><br></pre></td></tr></table></figure>

<h2 id="DDC的资料"><a href="#DDC的资料" class="headerlink" title="DDC的资料"></a>DDC的资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/community/general-discussion/1749914-work-from-home-cloud-ddc-experimental">Work From Home: Cloud DDC (experimental)</a></li>
</ul>
<h2 id="路径过长导致远程构建失败"><a href="#路径过长导致远程构建失败" class="headerlink" title="路径过长导致远程构建失败"></a>路径过长导致远程构建失败</h2><p>当引擎的路径过长时，远程构建会出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  ********** BUILD COMMAND STARTED **********</span><br><span class="line">  Running: C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Binaries\DotNET\UnrealBuildTool.exe FGame IOS Development -Project&#x3D;C:\BuildAgent\workspace\PackageW</span><br><span class="line">indows\Client\FGame.uproject  C:\BuildAgent\workspace\PackageWindows\Client\FGame.uproject -NoUBTMakefiles  -remoteini&#x3D;&quot;C:\BuildAgent\workspace\PackageWindows\Client&quot; -skipdeploy </span><br><span class="line">-Manifest&#x3D;C:\BuildAgent\workspace\PackageWindows\Client\Intermediate\Build\Manifest.xml -NoHotReload -log&#x3D;&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+B</span><br><span class="line">uildAgent+workspace+PackageWindows+InstalledEngine+Engine\BuildCookRun\UBT-FGame-IOS-Development.txt&quot;</span><br><span class="line">    WARNING: Running from a path with a long directory name (&quot;C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine&quot; &#x3D; 61 characters). Root paths shorter than 50 character</span><br><span class="line">s are recommended to avoid exceeding maximum path lengths on Windows.</span><br><span class="line">    [Remote] Using remote server &#39;xx.xx.xx.xx&#39; on port 2222 (user &#39;buildmachine&#39;)</span><br><span class="line">    [Remote] Using private key at C:\BuildAgent\workspace\PackageWindows\Client\Build\NotForLicensees\SSHKeys\xx.xx.xx.xx\buildmachine\RemoteToolChainPrivate.key</span><br><span class="line">    ERROR: Unable to determine home directory for remote user. SSH output:</span><br><span class="line">             Host key verification failed.</span><br><span class="line">  Took 0.8051806s to run UnrealBuildTool.exe, ExitCode&#x3D;6</span><br><span class="line">  UnrealBuildTool failed. See log for more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+BuildAgent+workspace+PackageWindows+InstalledEngine+Eng</span><br><span class="line">ine\BuildCookRun\UBT-FGame-IOS-Development.txt)</span><br><span class="line">  AutomationTool exiting with ExitCode&#x3D;6 (6)</span><br><span class="line">Took 1.6488741s to run AutomationTool.exe, ExitCode&#x3D;6</span><br><span class="line">AutomationTool exiting with ExitCode&#x3D;1 (Error_Unknown)</span><br><span class="line">BUILD FAILED</span><br></pre></td></tr></table></figure>
<p>这里有一个<em>Running from a path with a long directory name</em>的警告，然后跟着一个SSH Key的验证错误。<br>造成这个错误的原因就是因为警告中的内容，而非SSHKey的问题，因为Win默认的路径长度不能长于260，所以当引擎根目录位于较深的目录中时，可能会导致引擎的路径超过限制，导致后续的失败。</p>
<p>解决方案自然就是两个办法：</p>
<ol>
<li>减少引擎的路径深度</li>
<li>修改系统的最长路径支持</li>
</ol>
<p>Win10现在支持了长路径支持，开启即可：<a href="https://imzlp.com/notes/tips#Win10_%E5%BC%80%E5%90%AF%E9%95%BF%E8%B7%AF%E5%BE%84%E6%94%AF%E6%8C%81">Win10 开启长路径支持</a></p>
<h2 id="Mount-Point的作用"><a href="#Mount-Point的作用" class="headerlink" title="Mount Point的作用"></a>Mount Point的作用</h2><p>在Mount Pak的时候，有一个参数可以指定MountPoint:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Mounts a pak file at the specified path.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param InPakFilename Pak filename.</span></span><br><span class="line"><span class="comment">* @param InPath Path to mount the pak at.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath = <span class="literal">NULL</span>, <span class="keyword">bool</span> bLoadIndex = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么它是干什么的呢？<br>首先从Mount函数开始：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Pak-&gt;<span class="built_in">SetMountPoint</span>(InPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在调用Mount时传递了<code>InPath</code>，则通过加载Pak的FPakFile实例调用<code>SetMountPoint</code>，把InPath设置给它。<br>其实在FPakFile中，MountPath是有默认值的（从Pak文件中读取），在FPakFile的构造函数中调用了<code>Initialize(Reader, bLoadIndex);</code>，Initialize中又调用了<code>LoadIndex</code>，在<code>LoadIndex</code>中从Pak中读取Pak的Mount Point的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakFile::LoadIndex</span><span class="params">(FArchive* Reader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (CachedTotalSize &lt; (Info.IndexOffset + Info.IndexSize))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Corrupted index offset in pak file.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Info.Version &gt;= FPakInfo::PakFile_Version_FrozenIndex &amp;&amp; Info.bIndexIsFrozen)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PakFile_LoadFrozen&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read frozen data</span></span><br><span class="line">      Reader-&gt;<span class="built_in">Seek</span>(Info.IndexOffset);</span><br><span class="line">      int32 FrozenSize = Info.IndexSize;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read in the index, etc data in one lump</span></span><br><span class="line">      <span class="keyword">void</span>* DataMemory = FMemory::<span class="built_in">Malloc</span>(FrozenSize);</span><br><span class="line">      Reader-&gt;<span class="built_in">Serialize</span>(DataMemory, FrozenSize);</span><br><span class="line">      Data = TUniquePtr&lt;FPakFileData&gt;((FPakFileData*)DataMemory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cache the number of entries</span></span><br><span class="line">      NumEntries = Data-&gt;Files.<span class="built_in">Num</span>();</span><br><span class="line">      <span class="comment">// @todo loadtime: it is nice to serialize the mountpoint right into the Data so that IndexSize is right here</span></span><br><span class="line">      <span class="comment">// but it takes this to copy it out, because it&#x27;s too painful for the string manipulation when dealing with</span></span><br><span class="line">      <span class="comment">// MemoryImageString everywhere MountPoint is used</span></span><br><span class="line">      MountPoint = Data-&gt;MountPoint;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的可以理解为：如果Mount时不传递Mount Point就会从Pak文件中读取，如果有传入就设置为传入的值（Pak文件中的MountPoint是Pak中所有文件的公共路径）。</p>
<p>那么，给Pak设置MountPoint的作用是什么呢？<br>真实目的是，检测要加载的文件是否存在于当前Pak中！因为Pak的Mount Point的默认含义是当前Pak中所有文件的公共路径，所以只需要检测要读取的文件是否以这个路径开头，就可以首先排除掉基础路径不对的文件（基础路径都不对，意味着这个文件在Pak中也不存在）。</p>
<p>具体逻辑可以看这个函数的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformFilePak.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Finds a file in the specified pak files.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param Paks Pak files to find the file in.</span></span><br><span class="line"><span class="comment">* @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment">* @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment">* @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks,<span class="keyword">const</span> TCHAR* Filename,FPakFile** OutPakFile,FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FString <span class="title">StandardFilename</span><span class="params">(Filename)</span></span>;</span><br><span class="line">    FPaths::<span class="built_in">MakeStandardFilename</span>(StandardFilename);</span><br><span class="line"></span><br><span class="line">    int32 DeletedReadOrder = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 PakIndex = <span class="number">0</span>; PakIndex &lt; Paks.<span class="built_in">Num</span>(); PakIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        int32 PakReadOrder = Paks[PakIndex].ReadOrder;</span><br><span class="line">        <span class="keyword">if</span> (DeletedReadOrder != <span class="number">-1</span> &amp;&amp; DeletedReadOrder &gt; PakReadOrder)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//found a delete record in a higher priority patch level, but now we&#x27;re at a lower priority set - don&#x27;t search further back or we&#x27;ll find the original, old file.</span></span><br><span class="line">            <span class="built_in">UE_LOG</span>( LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Accepted a delete record for %s&quot;</span>), Filename );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FPakFile::EFindResult FindResult = Paks[PakIndex].PakFile-&gt;<span class="built_in">Find</span>(*StandardFilename, OutEntry);</span><br><span class="line">        <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::Found )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (OutPakFile != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *OutPakFile = Paks[PakIndex].PakFile;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">UE_CLOG</span>( DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Ignored delete record for %s - found it in %s instead (asset was moved between chunks)&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>() );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::FoundDeleted )</span><br><span class="line">        &#123;</span><br><span class="line">            DeletedReadOrder = PakReadOrder;</span><br><span class="line">            <span class="built_in">UE_LOG</span>( LogPakFile, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: Found a delete record for %s in %s&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;<span class="built_in">GetFilename</span>() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UE_CLOG</span>( DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Delete Record: No lower priority pak files looking for %s. (maybe not downloaded?)&quot;</span>), Filename );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们从Pak中读取文件时，通过对游戏中所有Mount的Pak调用<code>Find</code>函数，而<code>FPakFile::Find</code>的函数就实现了上述我说的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">FPakFile::EFindResult <span class="title">FPakFile::Find</span><span class="params">(<span class="keyword">const</span> FString&amp; Filename, FPakEntry* OutEntry)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(PakFileFind);</span><br><span class="line">  <span class="keyword">if</span> (Filename.<span class="built_in">StartsWith</span>(MountPoint))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FString <span class="title">Path</span><span class="params">(FPaths::GetPath(Filename))</span></span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，MountPoint的作用就是在从Pak中查找文件时，首先判断文件的路径是否与Pak中所有文件的<strong>基础路径</strong>相匹配（StartWith），如果不存在也就不会进入后续的流程了。</p>
<h2 id="引擎的Splash过程"><a href="#引擎的Splash过程" class="headerlink" title="引擎的Splash过程"></a>引擎的Splash过程</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201116215421.webp"></p>
<p>通过在这里断点可以比较直观地分析，引擎初始化到什么阶段做了什么事情。</p>
<h2 id="UE4-25-1的Assembly路径错误"><a href="#UE4-25-1的Assembly路径错误" class="headerlink" title="UE4.25.1的Assembly路径错误"></a>UE4.25.1的Assembly路径错误</h2><p>在UE4.25.1中，引擎生成的<code>Engine/Intermediate/Build/BuildRules/UE4Rules.dll</code>等文件具有路径错误。</p>
<p>具体的原因是在<code>UnrealBuildTool/System/RulesCompiler.cs</code>的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.1</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="built_in">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Get the path to store any generated assemblies</span></span><br><span class="line">  DirectoryReference AssemblyDir = RootDirectories[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (UnrealBuildTool.IsFileInstalled(FileReference.Combine(AssemblyDir, AssemblyPrefix)))</span><br><span class="line">  &#123;</span><br><span class="line">  DirectoryReference UserDir = Utils.GetUserSettingDirectory();</span><br><span class="line">      <span class="keyword">if</span> (UserDir != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">      ReadOnlyBuildVersion Version = ReadOnlyBuildVersion.Current;</span><br><span class="line">      AssemblyDir = DirectoryReference.Combine(UserDir, <span class="string">&quot;UnrealEngine&quot;</span>, String.Format(<span class="string">&quot;&#123;0&#125;.&#123;1&#125;&quot;</span>, Version.MajorVersion, Version.MinorVersion));</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(AssemblyDir, <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories, Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中<code>AssemblyDir</code>是引擎目录，<code>AssemblyPrefix</code>是<code>UE4</code>，拼接起来能够通过<code>UnrealBuildTool.IsFileInstalled</code>的检测。<br>但是，在if的代码块中，获取了用户目录，在IOS中就是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win</span></span><br><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25</span><br><span class="line"><span class="comment"># Mac</span></span><br><span class="line">/Users/buildmachine/Library/Application Support/Epic</span><br></pre></td></tr></table></figure>
<p>拼接起来就是上面这两个<code>USER_DIR</code>的<code>UnrealEngine/4.25/</code>，在下面读取<code>Assembly</code>的流程中就会使用这个路径。</p>
<p>在使用Win的时候，其实没有问题，因为就算把<code>UE4Rules.dll</code>写入到用户目录下，在Win上同样是可以访问到的。<strong>但是</strong>，在使用Win远程构建IOS的时候就会出现问题。<br>在远程构建时，会使用Rsync把引擎的文件同步到Mac上再执行编译，其中就包括<code>Engine/Intermediate/Build/BuildRuls/</code>下的所有文件，因为4.25.1中的代码会把<code>Build/BuildRuls/UE4Rules.dll</code>等生成到Win的用户目录下，所以远程构建，RSync就不能正确地把<code>BuildRuls</code>下的文件上传到Mac上，故而引起打包错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Precompiled rules assembly <span class="string">&#x27;/Users/buildmachine/Library/Application Support/Epic/UnrealEngine/4.25/Intermediate/Build/BuildRules/UE4Rules.dl</span></span><br><span class="line"><span class="string">l&#x27;</span> does not exist.</span><br></pre></td></tr></table></figure>
<p>可以看到，在Mac上也是从Mac的用户目录查找的，因为压根Mac上就没有这俩文件，所以就会产生这个错误。<br>解决这个问题的办法，就是修改<code>UnrealBuildTool/System/RulesCompiler.cs</code>的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数，把<code>BuildRules</code>相关的文件写入到<code>Engine/Intermediate/Build/BuildRules</code>中，在UE4.25.2中已经修复了这个错误。<br>在<a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1791750-4-25-2-hotfix-released">4.25.2 Hotfix released</a>中列出了<strong>Fixed! UE-94140 Fix assembly location for remote toolchain</strong>，其实就是直接修改了<code>CreateEngineOrEnterpriseRulesAssembly</code>函数:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.2</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="built_in">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="built_in">bool</span> bReadOnly, <span class="built_in">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(RootDirectories[<span class="number">0</span>], <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories[<span class="number">0</span>], Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接在github中查看:<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.2-release/Engine/Source/Programs/UnrealBuildTool/System/RulesCompiler.cs#L442">UnrealBuildTool/System/RulesCompiler.cs#L442</a></p>
<h2 id="跨Level选择Actor"><a href="#跨Level选择Actor" class="headerlink" title="跨Level选择Actor"></a>跨Level选择Actor</h2><p>在场景中，美术和游戏逻辑是区分开的，所以有时候需要程序关卡去操控美术关卡的对象，但是UE的不同关卡其实是不同的资源，属于不同的Pacakge，是不能直接跨关卡来选择对象实例的。<br>选择时会有以下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogProperty: Warning: Illegal TEXT reference to a private object in external package (StaticMeshActor /Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2) from referencer (BP_AActor_C /Game/Test/Map/Level_Sub1.Level_Sub1:PersistentLevel.BP_AActor_2).  Import failed...</span><br></pre></td></tr></table></figure>
<p>这是因为在<code>PropertyBaseObject.cpp</code>的<code>FObjectPropertyBase::ImportText_Internal</code>中对Object属性是否可以跨关卡做了检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UObject* <span class="title">FObjectPropertyBase::FindImportedObject</span><span class="params">( <span class="keyword">const</span> FProperty* Property, UObject* OwnerObject, UClass* ObjectClass, UClass* RequiredMetaClass, <span class="keyword">const</span> TCHAR* Text, uint32 PortFlags<span class="comment">/*=0*/</span>, FUObjectSerializeContext* InSerializeContext <span class="comment">/*= nullptr*/</span>, <span class="keyword">bool</span> bAllowAnyPackage <span class="comment">/*= true*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// if we found an object, and we have a parent, make sure we are in the same package if the found object is private, unless it&#x27;s a cross level property</span></span><br><span class="line">	<span class="keyword">if</span> (Result &amp;&amp; !Result-&gt;<span class="built_in">HasAnyFlags</span>(RF_Public) &amp;&amp; OwnerObject &amp;&amp; Result-&gt;<span class="built_in">GetOutermost</span>() != OwnerObject-&gt;<span class="built_in">GetOutermost</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> FObjectPropertyBase* ObjectProperty = CastField&lt;<span class="keyword">const</span> FObjectPropertyBase&gt;(Property);</span><br><span class="line">		<span class="keyword">if</span> ( !ObjectProperty || !ObjectProperty-&gt;<span class="built_in">AllowCrossLevel</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogProperty, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Illegal TEXT reference to a private object in external package (%s) from referencer (%s).  Import failed...&quot;</span>), *Result-&gt;<span class="built_in">GetFullName</span>(), *OwnerObject-&gt;<span class="built_in">GetFullName</span>());</span><br><span class="line">			Result = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>AllowCrossLevel</code>有两个继承类有覆写：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyBaseObject.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FObjectPropertyBase::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyLazyObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLazyObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertySoftObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FSoftObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，不能够直接通过创建<code>FObjectPropertyBase</code>这种硬引用方式的属性从SubLevel1选择SubLevel2中的Actor。<br>那么如何解决这么问题呢？，上面已经列出了两个可以跨平台选择的属性，分别是<code>FLazyObjectProperty</code>和<code>FSoftObjectProperty</code>，那么以<code>FSoftObjectProperty</code>为例，可以通过<code>TSoftObjectPtr</code>来实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSoftObjectPtr&lt;AActor&gt; Actor;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213023.webp"></p>
<p><code>TSoftObjectPtr</code>获取到的其实是SubLevel2中的资源的路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2</span><br></pre></td></tr></table></figure>
<p>在运行时访问需要使用以下操作来获取：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201110213249.webp"></p>
<p>上面蓝图中节点<code>Load Asset Blocking</code>是<code>UKismetSystemLibrary</code>中的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Engine/Private/KismetSystemLibrary.cpp</span></span><br><span class="line"><span class="function">UObject* <span class="title">UKismetSystemLibrary::LoadAsset_Blocking</span><span class="params">(TSoftObjectPtr&lt;UObject&gt; Asset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Asset.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看来UE加载资源时，并没有区分真正的物理资源和场景中的实例，统一使用资源的路径来加载，这一点做的非常爽，可以把另一个关卡中的Actor当作资源来读取，并且获取的还就是运行时的那个实例，非常Nice。</p>
</blockquote>
<h2 id="添加外部库的注意事项"><a href="#添加外部库的注意事项" class="headerlink" title="添加外部库的注意事项"></a>添加外部库的注意事项</h2><p>在添加外部的代码库时，需要关注以下几个问题：</p>
<ol>
<li>纯代码的库，要测试是否具有平台相关的写法，需要同时支持Win/Android/IOS/Mac四个平台</li>
<li>对于Android的so要同时支持arm64/armv7，打包时so文件的拷贝需要使用UPL执行</li>
<li>ios的<code>.a</code>要同时具有<code>bitcode</code>和非<code>bitcode</code>版本，不然在shipping时如果开启了bitcode，链接不支持bitcode的库会有链接错误的问题。</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201117095535.webp"></p>
<p>检测当前构建是否支持bitcode的流程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Target.IOSPlatform.bShipForBitcode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add support bitcode lib</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add not-support bitcode lib</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Target.cs</code>中可以直接通过<code>IOSPlatform</code>获取当前构建是否支持bitcode，在其他的Module中，可以通过<code>target.cs</code>中的<code>Target.IOSPlatform</code>获取。</p>
<h2 id="Outer"><a href="#Outer" class="headerlink" title="Outer"></a>Outer</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/c-gameplay-programming/54894-what-is-meant-by-outer-object">What is meant by “Outer Object”?</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/292594/how-can-i-understand-the-data-member-outer-in-the.html">How can I understand the data member ‘Outer’ in the UObjectBase class</a></li>
</ul>
<h2 id="获取ContentBrowser中选择的资源"><a href="#获取ContentBrowser中选择的资源" class="headerlink" title="获取ContentBrowser中选择的资源"></a>获取ContentBrowser中选择的资源</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IContentBrowserSingleton.h&quot;</span></span></span><br><span class="line"><span class="function">TArray&lt;FAssetData&gt; <span class="title">FHotPatcherEditorModule::GetSelectedAssetsInBrowserContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FContentBrowserModule&amp; ContentBrowserModule = FModuleManager::<span class="built_in">Get</span>().LoadModuleChecked&lt;FContentBrowserModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;ContentBrowser&quot;</span>));</span><br><span class="line">	TArray&lt;FAssetData&gt; AssetsData;</span><br><span class="line">	ContentBrowserModule.<span class="built_in">Get</span>().<span class="built_in">GetSelectedAssets</span>(AssetsData);</span><br><span class="line">	<span class="keyword">return</span> AssetsData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="命令行太长无法适应调试记录"><a href="#命令行太长无法适应调试记录" class="headerlink" title="命令行太长无法适应调试记录"></a>命令行太长无法适应调试记录</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无法执行“C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Tools\MSVC\14.16.27023\bin\HostX64\x64\c1xx.dll”: 命令行太长，无法适应调试记录</span><br></pre></td></tr></table></figure>
<p>在报错的模块的build.cs中添加下列属性即可：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bLegacyPublicIncludePaths = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h2 id="添加资源右键菜单按钮"><a href="#添加资源右键菜单按钮" class="headerlink" title="添加资源右键菜单按钮"></a>添加资源右键菜单按钮</h2><p>在ContentBrowser选择资源时的右键菜单按钮。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHotPatcherEditorModule::AddAssetContentMenu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!UToolMenus::<span class="built_in">IsToolMenuUIEnabled</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="function">FToolMenuOwnerScoped <span class="title">MenuOwner</span><span class="params">(<span class="string">&quot;CookUtilities&quot;</span>)</span></span>;</span><br><span class="line">	UToolMenu* Menu = UToolMenus::<span class="built_in">Get</span>()-&gt;<span class="built_in">ExtendMenu</span>(<span class="string">&quot;ContentBrowser.AssetContextMenu&quot;</span>);</span><br><span class="line">	FToolMenuSection&amp; Section = Menu-&gt;<span class="built_in">AddSection</span>(<span class="string">&quot;AssetContextCookUtilities&quot;</span>, <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CookUtilitiesMenuHeading&quot;</span>, <span class="string">&quot;CookUtilities&quot;</span>));;</span><br><span class="line">	</span><br><span class="line">	Section.<span class="built_in">AddDynamicEntry</span>(<span class="string">&quot;SoundWaveAsset&quot;</span>, FNewToolMenuSectionDelegate::<span class="built_in">CreateLambda</span>([<span class="keyword">this</span>](FToolMenuSection&amp; InSection)</span><br><span class="line">	   &#123;</span><br><span class="line">	       <span class="keyword">const</span> TAttribute&lt;FText&gt; Label = <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CookUtilities_CookAsset&quot;</span>, <span class="string">&quot;Cook Assets&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> TAttribute&lt;FText&gt; ToolTip = <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CookUtilities_CookAssetsTooltip&quot;</span>, <span class="string">&quot;Cook Assets&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> FSlateIcon Icon = <span class="built_in">FSlateIcon</span>(FEditorStyle::<span class="built_in">GetStyleSetName</span>(), <span class="string">&quot;ClassIcon.SoundSimple&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> FToolMenuExecuteAction UIAction = FToolMenuExecuteAction::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>,&amp;FHotPatcherEditorModule::OnCookAssets);</span><br><span class="line">	</span><br><span class="line">	       InSection.<span class="built_in">AddMenuEntry</span>(<span class="string">&quot;CookUtilities_CookAssets&quot;</span>, Label, ToolTip, Icon, UIAction);</span><br><span class="line">	   &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在绑定的函数中对资源进行操作。</p>
<h2 id="GenerateProjectFiles指定VS版本"><a href="#GenerateProjectFiles指定VS版本" class="headerlink" title="GenerateProjectFiles指定VS版本"></a>GenerateProjectFiles指定VS版本</h2><p><code>GenerateProjectFiles.bat</code>最终也是调用到<code>UnrealBuildTool.exe</code>，可以通过<code>-2015</code>/<code>-2017</code>来指定VS2015和VS2017引擎版本。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealBuildSystem/ProjectFileGenerator/index.html">Automatic Project File Generation</a></li>
<li><a target="_blank" rel="noopener" href="https://dawnarc.com/2017/05/ue4generate-visual-studio%E5%B7%A5%E7%A8%8B%E6%97%B6%E5%A6%82%E4%BD%95%E6%8C%87%E5%AE%9Avs%E7%89%88%E6%9C%AC/">VS版本</a></li>
</ul>
<h2 id="Module的WhitelistPlatforms"><a href="#Module的WhitelistPlatforms" class="headerlink" title="Module的WhitelistPlatforms"></a>Module的WhitelistPlatforms</h2><p>有一些Module用到了平台相关的内容，在另一个平台会编译不过，所以需要在<code>uplugin</code>中给Module添加模块白名单，只有在其中的平台上才会进行编译。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;Modules&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;OculusHMD&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;PostConfigInit&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;WhitelistPlatforms&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;Win64&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Win32&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android&quot;</span></span><br><span class="line">	]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>也可以设置平台的黑名单，使用<code>BlacklistPlatforms</code>。</p>
<h2 id="IDetailCustomization"><a href="#IDetailCustomization" class="headerlink" title="IDetailCustomization"></a>IDetailCustomization</h2><p>使用<code>IDetailCustomization</code>的方式可以给UE的属性面板添加特殊的东西，比如按钮。</p>
<p>以给F的结构的Detail添加按钮的方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReleaseSettingsDetails.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IDetailCustomization.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FReleaseSettingsDetails</span> :</span> <span class="keyword">public</span> IDetailCustomization</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/** Makes a new instance of this detail layout class for a specific detail view requesting it */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> TSharedRef&lt;IDetailCustomization&gt; <span class="title">MakeInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** IDetailCustomization interface */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>.cpp:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReleaseSettingsDetails.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/ReleaseSettingsDetails.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/FExportReleaseSettings.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// engine header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailLayoutBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailCategoryBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailWidgetRow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Widgets/Input/SButton.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCTEXT_NAMESPACE <span class="meta-string">&quot;ReleaseSettingsDetails&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">TSharedRef&lt;IDetailCustomization&gt; <span class="title">FReleaseSettingsDetails::MakeInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FReleaseSettingsDetails</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FReleaseSettingsDetails::CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray&lt; TSharedPtr&lt;FStructOnScope&gt; &gt; StructBeingCustomized;</span><br><span class="line">    DetailBuilder.<span class="built_in">GetStructsBeingCustomized</span>(StructBeingCustomized);</span><br><span class="line">    <span class="built_in">check</span>(StructBeingCustomized.<span class="built_in">Num</span>() == <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    FExportReleaseSettings* ReleaseSettingsIns = (FExportReleaseSettings*)StructBeingCustomized[<span class="number">0</span>].<span class="built_in">Get</span>()-&gt;<span class="built_in">GetStructMemory</span>();</span><br><span class="line">    </span><br><span class="line">    IDetailCategoryBuilder&amp; VersionCategory = DetailBuilder.<span class="built_in">EditCategory</span>(<span class="string">&quot;Version&quot;</span>,FText::<span class="built_in">GetEmpty</span>(),ECategoryPriority::Default);</span><br><span class="line">    VersionCategory.<span class="built_in">SetShowAdvanced</span>(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    VersionCategory.<span class="built_in">AddCustomRow</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ImportPakLists&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>),<span class="literal">true</span>)</span><br><span class="line">        .<span class="built_in">ValueContent</span>()</span><br><span class="line">        [</span><br><span class="line">            <span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">            + SHorizontalBox::<span class="built_in">Slot</span>()</span><br><span class="line">            .<span class="built_in">Padding</span>(<span class="number">0</span>)</span><br><span class="line">            .<span class="built_in">AutoWidth</span>()</span><br><span class="line">            [</span><br><span class="line">                <span class="built_in">SNew</span>(SButton)</span><br><span class="line">                .<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Import&quot;</span>, <span class="string">&quot;Import&quot;</span>))</span><br><span class="line">                .<span class="built_in">ToolTipText</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ImportPakLists_Tooltip&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>))</span><br><span class="line">                .<span class="built_in">IsEnabled_Lambda</span>([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;<span class="built_in">IsByPakList</span>();</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;<span class="built_in">ImportPakLists</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in"><span class="keyword">return</span></span>(FReply::<span class="built_in">Handled</span>());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">            + SHorizontalBox::<span class="built_in">Slot</span>()</span><br><span class="line">            .<span class="built_in">Padding</span>(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">            .<span class="built_in">AutoWidth</span>()</span><br><span class="line">            [</span><br><span class="line">                <span class="built_in">SNew</span>(SButton)</span><br><span class="line">                .<span class="built_in">Text</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;Clear&quot;</span>, <span class="string">&quot;Clear&quot;</span>))</span><br><span class="line">                .<span class="built_in">ToolTipText</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;ClearPakLists_Tooltip&quot;</span>, <span class="string">&quot;Clear Pak Lists&quot;</span>))</span><br><span class="line">                .<span class="built_in">IsEnabled_Lambda</span>([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;<span class="built_in">IsByPakList</span>();</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="built_in">OnClicked_Lambda</span>([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;<span class="built_in">ClearImportedPakList</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in"><span class="keyword">return</span></span>(FReply::<span class="built_in">Handled</span>());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br></pre></td></tr></table></figure>
<p>这里我们只是定义了一个<code>IDetailCustomization</code>的类，其中的<code>CustomizeDetails</code>是对<code>FExportReleaseSettings</code>添加的细节。</p>
<p>该类在创建<code>DetailView</code>时使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SHotPatcherExportRelease::CreateExportFilterListView</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Create a property view</span></span><br><span class="line">	FPropertyEditorModule&amp; EditModule = FModuleManager::<span class="built_in">Get</span>().GetModuleChecked&lt;FPropertyEditorModule&gt;(<span class="string">&quot;PropertyEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">	FDetailsViewArgs DetailsViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		DetailsViewArgs.bAllowSearch = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bHideSelectionTip = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bLockable = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bSearchInitialKeyFocus = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.NotifyHook = <span class="literal">nullptr</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bShowModifiedPropertiesOption = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowScrollBar = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection= <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FStructureDetailsViewArgs StructureViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		StructureViewArgs.bShowObjects = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowAssets = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowClasses = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowInterfaces = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SettingsView = EditModule.<span class="built_in">CreateStructureDetailView</span>(DetailsViewArgs, StructureViewArgs, <span class="literal">nullptr</span>);</span><br><span class="line">	FStructOnScope* Struct = <span class="keyword">new</span> <span class="built_in">FStructOnScope</span>(FExportReleaseSettings::<span class="built_in">StaticStruct</span>(), (uint8*)ExportReleaseSettings.<span class="built_in">Get</span>());</span><br><span class="line">	SettingsView-&gt;<span class="built_in">GetOnFinishedChangingPropertiesDelegate</span>().<span class="built_in">AddRaw</span>(ExportReleaseSettings.<span class="built_in">Get</span>(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br><span class="line">	SettingsView-&gt;<span class="built_in">GetDetailsView</span>()-&gt;<span class="built_in">RegisterInstancedCustomPropertyLayout</span>(FExportReleaseSettings::<span class="built_in">StaticStruct</span>(),FOnGetDetailCustomizationInstance::<span class="built_in">CreateStatic</span>(&amp;FReleaseSettingsDetails::MakeInstance));</span><br><span class="line">	SettingsView-&gt;<span class="built_in">SetStructureData</span>(<span class="built_in">MakeShareable</span>(Struct));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>RegisterInstancedCustomPropertyLayout</code>把所写的<code>FReleaseSettingsDetails</code>实例注册到<code>DetailView</code>中。注意调用时机要在<code>SetStructureData</code>之前。<br>然后就可以看到添加的两个按钮了：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201026200135.webp"></p>
<h2 id="提取PakList文件"><a href="#提取PakList文件" class="headerlink" title="提取PakList文件"></a>提取PakList文件</h2><p>打包时生成的PakList*.txt文件存放位置为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Programs\AutomationTool\Saved\Logs</span><br></pre></td></tr></table></figure>
<p>PakList的命名规则为<code>PakList_PROJECTNAME_PLATFORM.txt</code>，如：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PakList_Blank425-WindowsNoEditor.txt</span><br><span class="line">PakList_Blank425-Android_ASTC.txt</span><br><span class="line">PakList_blank425-ios.txt</span><br></pre></td></tr></table></figure>
<p>但是UE在打包下一次时会把上一次生成的<code>PakList*.txt</code>文件给清理掉。所以如果要提取某个平台的PakList需要在打包完当前平台之后立即提取，不然打包下个平台就把之前的删掉了。</p>
<h2 id="绑定DetailsView的属性变化事件"><a href="#绑定DetailsView的属性变化事件" class="headerlink" title="绑定DetailsView的属性变化事件"></a>绑定DetailsView的属性变化事件</h2><p>在编辑器中创建<code>DetailsView</code>时，如果使用继承自UObject的对象，可以重载<code>PostEditChangeProperty</code>来实现属性变化的监听，但是如果使用<code>F</code>的结构，则不能直接在类的函数中监听，需要通过绑定<code>IStructureDetailsView</code>的属性变动代理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">TSharedPtr&lt;IStructureDetailsView&gt; SettingsView;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a property view</span></span><br><span class="line">FPropertyEditorModule&amp; EditModule = FModuleManager::<span class="built_in">Get</span>().GetModuleChecked&lt;FPropertyEditorModule&gt;(<span class="string">&quot;PropertyEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">FDetailsViewArgs DetailsViewArgs;</span><br><span class="line">&#123;</span><br><span class="line">	DetailsViewArgs.bAllowSearch = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bHideSelectionTip = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bLockable = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bSearchInitialKeyFocus = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bUpdatesFromSelection = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.NotifyHook = <span class="literal">nullptr</span>;</span><br><span class="line">	DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bShowModifiedPropertiesOption = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bShowScrollBar = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bUpdatesFromSelection= <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FStructureDetailsViewArgs StructureViewArgs;</span><br><span class="line">&#123;</span><br><span class="line">	StructureViewArgs.bShowObjects = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowAssets = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowClasses = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowInterfaces = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SettingsView = EditModule.<span class="built_in">CreateStructureDetailView</span>(DetailsViewArgs, StructureViewArgs, <span class="literal">nullptr</span>);</span><br><span class="line">FStructOnScope* Struct = <span class="keyword">new</span> <span class="built_in">FStructOnScope</span>(FExportReleaseSettings::<span class="built_in">StaticStruct</span>(), (uint8*)ExportReleaseSettings.<span class="built_in">Get</span>());</span><br><span class="line">SettingsView-&gt;<span class="built_in">GetOnFinishedChangingPropertiesDelegate</span>().<span class="built_in">AddRaw</span>(ExportReleaseSettings.<span class="built_in">Get</span>(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br><span class="line">SettingsView-&gt;<span class="built_in">SetStructureData</span>(<span class="built_in">MakeShareable</span>(Struct));</span><br></pre></td></tr></table></figure>
<p>关键是这行代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SettingsView-&gt;<span class="built_in">GetOnFinishedChangingPropertiesDelegate</span>().<span class="built_in">AddRaw</span>(ExportReleaseSettings.<span class="built_in">Get</span>(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br></pre></td></tr></table></figure>
<p>把当前DetailsView的属性变动事件绑定到<code>OnFinishedChangingProperties</code>上。</p>
<h2 id="从指定Pak加载文件"><a href="#从指定Pak加载文件" class="headerlink" title="从指定Pak加载文件"></a>从指定Pak加载文件</h2><p>具体可以看<code>FPakPlatformFile::OpenRead</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IFileHandle* <span class="title">FPakPlatformFile::OpenRead</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, <span class="keyword">bool</span> bAllowWrite)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IFileHandle* Result = <span class="literal">NULL</span>;</span><br><span class="line">	FPakFile* PakFile = <span class="literal">NULL</span>;</span><br><span class="line">	FPakEntry FileEntry;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FindFileInPakFiles</span>(Filename, &amp;PakFile, &amp;FileEntry))</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PAK_TRACKER</span></span><br><span class="line">		<span class="built_in">TrackPak</span>(Filename, &amp;FileEntry);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		Result = <span class="built_in">CreatePakFileHandle</span>(Filename, PakFile, &amp;FileEntry);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Result)</span><br><span class="line">		&#123;</span><br><span class="line">			FCoreDelegates::OnFileOpenedForReadFromPakFile.<span class="built_in">Broadcast</span>(*PakFile-&gt;<span class="built_in">GetFilename</span>(), Filename);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsNonPakFilenameAllowed</span>(Filename))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Default to wrapped file</span></span><br><span class="line">			Result = LowerLevel-&gt;<span class="built_in">OpenRead</span>(Filename, bAllowWrite);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过文件名拿到传入文件在所有Mounted的pak中最大Order的Pak文件，然后使用<code>CreatePakFileHandle</code>从Pak文件中读取文件。<br><code>FPakFile</code>描述的是Pak文件，<code>FPakEntry</code>描述的是Pak中文件的信息，比如大小、偏移等。通过<code>FPakFile</code>和<code>FPakEntry</code>可以从指定的Pak中读取指定的文件。</p>
<h2 id="WITH-EDITOR包裹反射属性的问题"><a href="#WITH-EDITOR包裹反射属性的问题" class="headerlink" title="WITH_EDITOR包裹反射属性的问题"></a>WITH_EDITOR包裹反射属性的问题</h2><p>有时只想要一些属性在编辑器下存在，打包时不需要，按照常规的思路，需要对这些属性使用<code>WITH_EDITOR</code>包裹：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">      int32 ival;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这个代码在Editor的Configuration下没有问题，但是一旦编译非Editor就会产生如下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Build/Win64/FGame/Inc/FGame/NetActor.gen.cpp(97): error C2039: &#x27;ival&#x27;: is not a member of &#x27;ANetActor&#x27;</span><br></pre></td></tr></table></figure>
<p>那么，既然我们明明已经用<code>WITH_EDITOR</code>包裹了<code>ival</code>的属性，为什么在编译非Editor的时候UHT还会为这个属性生成反射代码呢？<br>这个问题涉及到了以下几个概念：</p>
<ol>
<li>gen.cpp中是UHT为反射标记的类和属性生成的反射信息</li>
<li>UHT的生成流程在调用编译器之前</li>
</ol>
<p>UE构建系统的流程我之前做过分析：<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a></p>
<p>因为C++的宏是在调用编译器后预处理阶段做的事情，在执行UHT时，压根不会检测宏条件，所以上面的代码，UHT依然会为<code>ival</code>生成反射信息到<code>gen.cpp</code>中，而UHT执行完毕之后进入编译阶段<code>WITH_EDITOR</code>会参与预处理，<code>ival</code>因此在类定义中不存在，但是UHT已经为它生成了反射代码，会通过获取成员函数指针的方式访问到它，进而产生了上述的编译错误。</p>
<p>所以这是UE反射代码生成先于预处理造成的问题，在写代码时是比较反直觉的。但是这个问题也并非不能解决，UE提供了<code>WITH_EDITORONLY_DATA</code>宏来专门处理这个问题，一个宏解决不了，就引入一个新的。</p>
<p>但是为什么<code>WITH_EDITOR</code>不可以，而<code>WITH_EDITORONLY_DATA</code>就可以呢？因为UHT在生成反射代码时为<code>WITH_EDITORONLY_DATA</code>做了特殊检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeClassHeaderGenerator::ExportProperties</span><span class="params">(FOutputDevice&amp; Out, UStruct* Struct, int32 TextIndent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FProperty*	Previous			= <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	PreviousNonEditorOnly = <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	LastInSuper			= <span class="literal">NULL</span>;</span><br><span class="line">	UStruct*	InheritanceSuper	= Struct-&gt;<span class="built_in">GetInheritanceSuper</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find last property in the lowest base class that has any properties</span></span><br><span class="line">	UStruct* CurrentSuper = InheritanceSuper;</span><br><span class="line">	<span class="keyword">while</span> (LastInSuper == <span class="literal">NULL</span> &amp;&amp; CurrentSuper)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>( TFieldIterator&lt;FProperty&gt; <span class="built_in">It</span>(CurrentSuper,EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">		&#123;</span><br><span class="line">			FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">			<span class="keyword">if</span>( It.<span class="built_in">GetStruct</span>() == CurrentSuper &amp;&amp; Current-&gt;ElementSize )</span><br><span class="line">			&#123;</span><br><span class="line">				LastInSuper = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// go up a layer in the hierarchy</span></span><br><span class="line">		CurrentSuper = CurrentSuper-&gt;<span class="built_in">GetSuperStruct</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">FMacroBlockEmitter <span class="title">WithEditorOnlyData</span><span class="params">(Out, TEXT(<span class="string">&quot;WITH_EDITORONLY_DATA&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Iterate over all properties in this struct.</span></span><br><span class="line">	<span class="keyword">for</span>( TFieldIterator&lt;FProperty&gt; <span class="built_in">It</span>(Struct, EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">	&#123;</span><br><span class="line">		FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">		<span class="keyword">if</span> (It.<span class="built_in">GetStruct</span>() == Struct)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">WithEditorOnlyData</span>(Current-&gt;<span class="built_in">IsEditorOnlyProperty</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Export property specifiers</span></span><br><span class="line">			<span class="comment">// Indent code and export CPP text.</span></span><br><span class="line">			&#123;</span><br><span class="line">				FUHTStringBuilder JustPropertyDecl;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">const</span> FString* Dim = GArrayDimensions.<span class="built_in">Find</span>(Current);</span><br><span class="line">				Current-&gt;<span class="built_in">ExportCppDeclaration</span>( JustPropertyDecl, EExportedDeclaration::Member, Dim ? **Dim : <span class="literal">NULL</span>);</span><br><span class="line">				<span class="built_in">ApplyAlternatePropertyExportText</span>(*It, JustPropertyDecl, EExportingState::TypeEraseDelegates);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Finish up line.</span></span><br><span class="line">				Out.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s%s;\r\n&quot;</span>), FCString::<span class="built_in">Tab</span>(TextIndent + <span class="number">1</span>), *JustPropertyDecl);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			LastInSuper	= <span class="literal">NULL</span>;</span><br><span class="line">			Previous = Current;</span><br><span class="line">			<span class="keyword">if</span> (!Current-&gt;<span class="built_in">IsEditorOnlyProperty</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				PreviousNonEditorOnly = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下<code>FMacroBlockEmitter</code>的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FMacroBlockEmitter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FMacroBlockEmitter</span><span class="params">(FOutputDevice&amp; InOutput, <span class="keyword">const</span> TCHAR* InMacro)</span></span></span><br><span class="line"><span class="function">        : Output(InOutput)</span></span><br><span class="line"><span class="function">        , bEmittedIf(false)</span></span><br><span class="line"><span class="function">        , Macro(InMacro)</span></span><br><span class="line"><span class="function">	&#123;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">FMacroBlockEmitter</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bEmittedIf)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">bool</span> bInBlock)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!bEmittedIf &amp;&amp; bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#if %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bEmittedIf &amp;&amp; !bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.<span class="built_in">Logf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FMacroBlockEmitter</span>(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	FMacroBlockEmitter&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FOutputDevice&amp; Output;</span><br><span class="line">	<span class="keyword">bool</span> bEmittedIf;</span><br><span class="line">	<span class="keyword">const</span> TCHAR* Macro;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当生成代码时会为使用<code>WITH_EDITORONLY_DATA</code>包裹的属性在<code>gen.cpp</code>中添加<code>WITH_EDITORONLY_DATA</code>宏（有点套娃的感觉），使<code>gen.cpp</code>在非EDITOR下编译时也不会把这部分反射代码参与真正的编译，从而解决了上面的问题。</p>
<h2 id="Cook资源"><a href="#Cook资源" class="headerlink" title="Cook资源"></a>Cook资源</h2><p>可以看CookOnTheFlyServer.cpp中的代码：</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">UCookOnTheFlyServer::FullLoadAndSave</span><span class="params">(uint32&amp; CookedPackageCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (bCookPackage)</span><br><span class="line">    &#123;</span><br><span class="line">        FString PlatFilename = Filename.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[Platform]&quot;</span>), *Target-&gt;<span class="built_in">PlatformName</span>());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UE_CLOG</span>(GCookProgressDisplay &amp; (int32)ECookProgressDisplayMode::PackageNames, LogCook, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Cooking %s -&gt; %s&quot;</span>), *Package-&gt;<span class="built_in">GetName</span>(), *PlatFilename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> bSwap = (!Target-&gt;<span class="built_in">IsLittleEndian</span>()) ^ (!PLATFORM_LITTLE_ENDIAN);</span><br><span class="line">        <span class="keyword">if</span> (!Target-&gt;<span class="built_in">HasEditorOnlyData</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            Package-&gt;<span class="built_in">SetPackageFlags</span>(PKG_FilterEditorOnly);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Package-&gt;<span class="built_in">ClearPackageFlags</span>(PKG_FilterEditorOnly);</span><br><span class="line">        &#125;</span><br><span class="line">								</span><br><span class="line">        GIsCookerLoadingPackage = <span class="literal">true</span>;</span><br><span class="line">        FSavePackageResultStruct SaveResult = GEditor-&gt;<span class="built_in">Save</span>(Package, World, FlagsToCook, *PlatFilename, GError, <span class="literal">NULL</span>, bSwap, <span class="literal">false</span>, SaveFlags, Target, FDateTime::<span class="built_in">MinValue</span>(), <span class="literal">false</span>);</span><br><span class="line">        GIsCookerLoadingPackage = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SaveResult == ESavePackageResult::Success &amp;&amp; UAssetManager::<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!UAssetManager::<span class="built_in">Get</span>().<span class="built_in">VerifyCanCookPackage</span>(Package-&gt;<span class="built_in">GetFName</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">                SaveResult = ESavePackageResult::Error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> bSucceededSavePackage = (SaveResult == ESavePackageResult::Success || SaveResult == ESavePackageResult::GenerateStub || SaveResult == ESavePackageResult::ReplaceCompletely);</span><br><span class="line">        <span class="keyword">if</span> (bSucceededSavePackage)</span><br><span class="line">        &#123;</span><br><span class="line">            FAssetRegistryGenerator* Generator = PlatformManager-&gt;<span class="built_in">GetPlatformData</span>(Target)-&gt;RegistryGenerator.<span class="built_in">Get</span>();</span><br><span class="line">            <span class="built_in">UpdateAssetRegistryPackageData</span>(Generator, Package-&gt;<span class="built_in">GetFName</span>(), SaveResult);</span><br><span class="line"></span><br><span class="line">            FPlatformAtomics::<span class="built_in">InterlockedIncrement</span>(&amp;ParallelSavedPackages);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SaveResult != ESavePackageResult::ReferencedOnlyByEditorOnlyData)</span><br><span class="line">        &#123;</span><br><span class="line">            SavePackageSuccessPerPlatform[PlatformIndex] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            SavePackageSuccessPerPlatform[PlatformIndex] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Compile对Instanced的替换调用栈"><a href="#Compile对Instanced的替换调用栈" class="headerlink" title="Compile对Instanced的替换调用栈"></a>Compile对Instanced的替换调用栈</h2><p>在这个函数中会收集到当前资源被修改后，依赖它的资源，存储在<code>Dependencies</code>数组中。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014165139.webp"></p>
<p>得到<code>Dependencies</code>之后，会在<code>FBlueprintCompileReinstancer::UpdateBytecodeReferences</code>中使用：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014171310.webp"></p>
<h2 id="对资源点击Compile的调用栈"><a href="#对资源点击Compile的调用栈" class="headerlink" title="对资源点击Compile的调用栈"></a>对资源点击Compile的调用栈</h2><p>会执行到<code>FKismetEditorUtilities::CompileBlueprint</code>：</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/Kismet2/Kismet2.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FKismetEditorUtilities::CompileBlueprint</span><span class="params">(UBlueprint* BlueprintObj, EBlueprintCompileOptions CompileFlags, FCompilerResultsLog* pResults)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_HIERARCHICAL_COUNTER_FUNC</span>()</span><br><span class="line"></span><br><span class="line">	FBlueprintCompilationManager::<span class="built_in">CompileSynchronously</span>(<span class="built_in">FBPCompileRequest</span>(BlueprintObj, CompileFlags, pResults));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201014141219.webp"></p>
<h2 id="UMG的子控件引用热更问题"><a href="#UMG的子控件引用热更问题" class="headerlink" title="UMG的子控件引用热更问题"></a>UMG的子控件引用热更问题</h2><p>UMG的UserWidget如果UI_A添加了另一个UserWidget UI_B，它们并不是先创建了UI_A，再去创建加载UI_B的资源并创建，UMG的子控件是以Instanced的方式创建的，相当于UI_A中存储的只是当时UI_B的一份示例，并不涉及资源的直接引用。这样会导致在热更时，如果我们只修改了UI_B，此时并没有造成UI_A资源变动，Cook和打包时如果只把UI_B打包，其实对UI_A是没有效果的，并不会有相应的变动。<br>这是UE Asset和Instanced没有区分的问题，资源并没有修改，但是实际上却对它造成了变化。解决的办法只能在修改了子控件后把使用Instanced方式引用的父控件一起Cook打包，才能有正确的效果。</p>
<h2 id="注意环形引用导致的宏未定义错误"><a href="#注意环形引用导致的宏未定义错误" class="headerlink" title="注意环形引用导致的宏未定义错误"></a>注意环形引用导致的宏未定义错误</h2><p>在UE中发现编译报错宏的未定义错误，但是发现头文件已经被包含了，照常是不会出现问题的，如果出现这个问题，检查下代码中是否有头文件的环形引用，解决之后即可。<br>猜测的原因是环形引用导致预处理爆栈没有包含到真正的宏定义头文件，从而产生了编译错误。</p>
<h2 id="监听Slate的输入事件"><a href="#监听Slate的输入事件" class="headerlink" title="监听Slate的输入事件"></a>监听Slate的输入事件</h2><p>UE提供了注册Listener的方法，通过<code>FSlateApplication::Get()</code>进行注册：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InputProcessor = MakeShared&lt;FTranslationPickerInputProcessor&gt;(<span class="keyword">this</span>);</span><br><span class="line">FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">RegisterInputPreProcessor</span>(InputProcessor, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><code>RegisterInputPreProcessor</code>接收的第一个参数是<code>TSharedPtr&lt;class IInputProcessor&gt;</code>，它是一个接口类型，第二个参数是插入Listener的位置，默认是插入到尾部。</p>
<p><code>IInputProcessor</code>提供的接口：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Slate/Public/Framework/Application/IInputProcessor.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface for a Slate Input Handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SLATE_API</span> <span class="title">IInputProcessor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">IInputProcessor</span>()&#123;&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">IInputProcessor</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Tick</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> DeltaTime, FSlateApplication&amp; SlateApp, TSharedRef&lt;ICursor&gt; Cursor)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Key down input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleKeyDownEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FKeyEvent&amp; InKeyEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Key up input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleKeyUpEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FKeyEvent&amp; InKeyEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Analog axis input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleAnalogInputEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FAnalogInputEvent&amp; InAnalogInputEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse movement input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseMoveEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button press */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonDownEvent</span><span class="params">( FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button release */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonUpEvent</span><span class="params">( FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button double clicked. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonDoubleClickEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse wheel input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseWheelOrGestureEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; InWheelEvent, <span class="keyword">const</span> FPointerEvent* InGestureEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Called when a motion-driven device has new input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMotionDetectedEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FMotionEvent&amp; MotionEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以通过继承它来实现自己的监听需求。</p>
<h2 id="修改LaunchScreen视频比例"><a href="#修改LaunchScreen视频比例" class="headerlink" title="修改LaunchScreen视频比例"></a>修改LaunchScreen视频比例</h2><p>当使用<code>Project Settings</code>-<code>Project</code>-<code>Movies</code>中来为游戏启动时播放视频时，默认情况下是锁定视频的长宽比的，在全面屏流行的现在，长宽比为2.x的比比皆是，锁定视频比例会导致两侧有黑边，所以希望视频能够拉伸来适应屏幕的大小。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009210924.webp"><br>需要修改引擎的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/MoviePlayer/Private/DefaultGameMoviePlayer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FVector2D <span class="title">FDefaultGameMoviePlayer::GetMovieSize</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> FVector2D ScreenSize = MainWindow.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetClientSizeInScreen</span>();</span><br><span class="line">	<span class="comment">// if (MovieStreamingIsPrepared() &amp;&amp; ActiveMovieStreamer.IsValid())</span></span><br><span class="line">	<span class="comment">// &#123;</span></span><br><span class="line">	<span class="comment">// 	const float MovieAspectRatio = ActiveMovieStreamer-&gt;GetAspectRatio();</span></span><br><span class="line">	<span class="comment">// 	const float ScreenAspectRatio = ScreenSize.X / ScreenSize.Y;</span></span><br><span class="line">	<span class="comment">// 	if (MovieAspectRatio &lt; ScreenAspectRatio)</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.Y * MovieAspectRatio, ScreenSize.Y);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// 	else</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.X, ScreenSize.X / MovieAspectRatio);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// No movie, so simply return the size of the window</span></span><br><span class="line">	<span class="keyword">return</span> ScreenSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把<code>FDefaultGameMoviePlayer::GetMovieSize()</code>修改为上面的代码，其实就是把从视频获取长宽的代码去掉，强制使用窗口的大小。</p>
<h2 id="Rider传递命令行参数"><a href="#Rider传递命令行参数" class="headerlink" title="Rider传递命令行参数"></a>Rider传递命令行参数</h2><p>在VS中有<code>UnrealVS</code>可以方便地给工程传递命令行参数，但是Rider中要复杂一点。<br>要选择<code>Run</code>-<code>Edit Configurations</code>，在弹出窗口的左侧选择要修改的工程，右侧的<code>Program Arguments</code>则是传递给程序的参数：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009202629.webp"></p>
<p>为了方便编辑，可以把<code>Edit Configurations</code>添加到Toolbar中，在Toolbar上点击右键，点击<code>Customize Menus and Toolbars</code>，在弹出的<code>Menus and Toolbars</code>窗口中，把<code>Edit Configurations</code>添加至<code>Toolbar Run Actions</code>中即可。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201009202816.webp"></p>
<h2 id="IOS自动化导入Certificate和Provision"><a href="#IOS自动化导入Certificate和Provision" class="headerlink" title="IOS自动化导入Certificate和Provision"></a>IOS自动化导入Certificate和Provision</h2><p>传统的打包ios时，需要手动在<code>Project Settings</code>-<code>Platforms</code>-<code>IOS</code>中选择打包要使用的<code>Certificate</code>和<code>Provision</code>，当需要切换打包Configuration的时候就需要打开编辑器重新选择一遍（因为Development和Shipping用到的证书不同），很麻烦，我是一个非常讨厌做重复操作的人，所以研究了一下解决了这个问题。<br>也是得益于UE本身提供了代码中导入<code>Certificate</code>和<code>Provision</code>的方式（之前我还写了自动化把证书导入到系统中，其实不用了）。<br>在前面的笔记中提到过UE的Target也提供了平台相关的Target对象：<a href="https://imzlp.com/notes/ue/#%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3Target">平台相关Target</a>，要实现本文提到的需求就要通过控制<code>IOSPlatform</code>来实现。</p>
<p><code>IOSPlatform</code>提供了以下几个属性：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Manual override for the provision to use. Should be a full path.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportProvision=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportProvision = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Imports the given certificate (inc private key) into a temporary keychain before signing.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificate=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportCertificate = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Password for the imported certificate</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificatePassword=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ImportCertificatePassword = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>通过操作它们的值来实现自动化导入证书和Provision，我写了一段使用代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FGameTarget</span> : <span class="title">TargetRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FGameTarget</span>(<span class="params"> TargetInfo Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Type = TargetType.Game;</span><br><span class="line">    DefaultBuildSettings = BuildSettingsVersion.V1;</span><br><span class="line">    ExtraModuleNames.AddRange( <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;FGame&quot;</span> &#125; );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for package dSYM</span></span><br><span class="line">    bDisableDebugInfo = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">    &#123;</span><br><span class="line">      DirectoryReference ProjectDir = ProjectFile.Directory;</span><br><span class="line">      IOSPlatform.bGeneratedSYM = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">string</span> PackageConfiguration = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// import cer/provision</span></span><br><span class="line">      <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Development&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Distibution&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">string</span> cerPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;XXXXXX_IOS.p12&quot;</span>);</span><br><span class="line">      <span class="built_in">string</span> proversionPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;com.tencent.xxxx.xx_SignProvision.mobileprovision&quot;</span>);</span><br><span class="line">      <span class="built_in">string</span> cerPassword = <span class="string">&quot;password&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Certificate:&quot;</span>+cerPath);</span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Provision:&quot;</span>+proversionPath);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (File.Exists(cerPath) &amp;&amp; File.Exists(proversionPath))</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Import Certificate &amp; Provision set to IOSPlatform&quot;</span>);</span><br><span class="line">        IOSPlatform.ImportCertificate = cerPath;</span><br><span class="line">        IOSPlatform.ImportProvision = proversionPath;</span><br><span class="line">        IOSPlatform.ImportCertificatePassword = cerPassword;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在打包IOS时就会自动使用所指定的证书了，并且会在Shipping时自动化启用<code>Distribution</code>，这样就可以避免要事先把证书和<code>provision</code>导入到系统中。</p>
<h2 id="Mac打包iOS的codesign错误"><a href="#Mac打包iOS的codesign错误" class="headerlink" title="Mac打包iOS的codesign错误"></a>Mac打包iOS的codesign错误</h2><p>在Mac上直接打包iOS时遇到以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2020-09-27 19:23:48:778 :         /usr/bin/codesign --force --sign 2C74981D1576F95021XXXXXXXXXXA7ECBD8A81A0 --entitlements /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Intermediate/ProjectFilesIOS/build/FGame.build/Development-iphoneos/FGame.build/FGame.app.xcent --timestamp=none /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:896 :     /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app: errSecInternalComponent</span><br><span class="line">2020-09-27 19:23:59:896 :     Command /usr/bin/codesign failed with <span class="built_in">exit</span> code 1</span><br><span class="line">2020-09-27 19:23:59:896 :   </span><br><span class="line">2020-09-27 19:23:59:899 :     ** BUILD FAILED **</span><br><span class="line">2020-09-27 19:23:59:899 : </span><br><span class="line">2020-09-27 19:23:59:899 :     The following build commands failed:</span><br><span class="line">2020-09-27 19:23:59:899 :     	CodeSign /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:900 :     (1 failure)</span><br><span class="line">2020-09-27 19:23:59:915 :   Took 15.181822s to run env, ExitCode=65</span><br><span class="line">2020-09-27 19:23:59:920 :   ERROR: CodeSign Failed</span><br><span class="line">2020-09-27 19:23:59:920 :          (see /Users/buildmachine/Library/Logs/Unreal Engine/LocalBuildLogs/BuildCookRun/Log.txt <span class="keyword">for</span> full exception trace)</span><br><span class="line">2020-09-27 19:23:59:922 :   AutomationTool exiting with ExitCode=32 (Error_FailedToCodeSign)</span><br><span class="line">2020-09-27 19:23:59:962 : Took 568.832115s to run mono, ExitCode=32</span><br><span class="line">2020-09-27 19:23:59:974 : AutomationTool exiting with ExitCode=1 (Error_Unknown)</span><br><span class="line">2020-09-27 19:24:00:010 : RunUAT ERROR: AutomationTool was unable to run successfully.</span><br></pre></td></tr></table></figure>
<p>可以看到是执行codesign的时候遇到了错误导致打包失败的。</p>
<p>这是因为打包时会访问钥匙串，需要输入密码授权，如果弹窗之后没有授权就会导致codesign执行失败。Stack overflow上有相同的问题：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20200927204452.webp"></p>
<p>解决方案有三种：</p>
<ol>
<li>在打包时的弹窗中输入密码解锁钥匙串</li>
<li>在打包之前的解锁钥匙串</li>
<li>在弹窗中输入密码后选择始终允许codesign访问钥匙串</li>
</ol>
<p>解锁钥匙串使用以下终端命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ security unlock-keychain login.keychain</span><br></pre></td></tr></table></figure>

<h2 id="VirtualCamera"><a href="#VirtualCamera" class="headerlink" title="VirtualCamera"></a>VirtualCamera</h2><p>可以使用UE4+支持ARKit的设备来实现通过获取iOS设备的设备位置信息来控制游戏中的相机，从而实现类似虚拟制片的相机追踪效果。官方文档：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Plugins/VirtualCameraPlugin/index.html">VirtualCameraPlugin</a></p>
<p>首先，支持ARKit的设备在Apple的网站上有列出：<a target="_blank" rel="noopener" href="https://www.apple.com/augmented-reality/">Augmented Reality - Apple</a>，以下设备支持：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20200925185142.webp"></p>
<blockquote>
<p>ARKit 3.0 is only supported on devices with iOS 13, A12/A12X Bionic chips (or later), the Apple Neural Engine (ANE), and a TrueDepth Camera, such as the iPhone XS, iPhone XS Max, iPhone XR, and the 11-inch and 12.9-inch 2018 iPad Pros.</p>
</blockquote>
<p>刚好我的iPad Air3在支持之列。而且目前预览版的UE4.26，支持了ARKit3.5</p>
<p>需要在UE项目中启用三个插件：</p>
<ul>
<li>VirtualCamera</li>
<li>Apple ARKit</li>
<li>RemoteSession</li>
<li>iOS设备安装<a target="_blank" rel="noopener" href="https://itunes.apple.com/us/app/unreal-remote-2/id1374517532">Unreal Remote 2</a></li>
</ul>
<p>操作方法为：打开地图，编辑地图所使用的GameMode为<code>VirtualCameraGameMode</code>，在iPad上打开<a target="_blank" rel="noopener" href="https://itunes.apple.com/us/app/unreal-remote-2/id1374517532">Unreal Remote 2</a>输入PC的IP地址，连接成功后在UE编辑器内Play，游戏画面就会传递到iPad，iPad的设备位置和旋转就会回传到UE里控制编辑器内的相机。</p>
<p>这是UE默认提供的方案，但是我后面想要iPad可以与Oculus Quest结合起来，其实问题的关键点在于需要获取到ARKit的设备数据，然后通过网络与Oculus Quest通信。<br>目前的思路是：</p>
<ol>
<li>使用UE访问ARKit的设备位置数据在局域网内同步</li>
<li>获取Oculus的设备位置数据</li>
<li>想办法统一坐标系</li>
</ol>
<p>两边都拿到基于地面高度为基准的高度信息是没问题的，但是如何把ARKit设备的XY和Oculus的结合结合起来是个要思考的问题。</p>
<h2 id="远程构建在4-26的问题"><a href="#远程构建在4-26的问题" class="headerlink" title="远程构建在4.26的问题"></a>远程构建在4.26的问题</h2><p>之前的不少笔记中都写到了使用远程构建的方式出iOS的ipa（详见<a href="https://imzlp.com/posts/1948/#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA">UE4开发笔记：Mac/iOS篇#配置远程构建</a>），但是在4.26发现了一个问题，会导致代码的编译和Cook的不一致。<br>再来复习一遍远程构建的流程：</p>
<ol>
<li>把本机的引擎和工程代码上传至Mac</li>
<li>在Mac上执行编译</li>
<li>编译完毕之后在Mac上生成ipa包（但不包含Cook资源）</li>
<li>把生成的ipa包拉回本地，解包，Cook美术资源，再合并为ipa</li>
</ol>
<p>这其中有个关键的点是：代码的编译和Cook是分别在Mac和Win上执行的，这意味着执行这两个操作的引擎分别是Mac版引擎和Win版引擎。</p>
<p>这个问题就在于，目前4.26的一些代码中加入了<code>PLATFORM_IOS || PLATFORM_MAC</code>的宏判断，如果完整的打包过程都是在Mac上执行的，就不会出现问题，因为代码编译和Cook都是调用Mac版引擎的，但是在远程构建时就会出现问题了。会导致在Mac上编译工程代码时<code>PLATFORM_IOS || PLATFORM_MAC</code>这个检查会通过，而在Win上Cook去编译Shader时，因为使用的是Win版引擎，会导致这个宏检查是false，就会导致Cook和代码之间的版本差异，会有Crash。<br>具体错误如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] [2020.09.19-08.48.01:821][  0]LogPakFile: New pak file ..&#x2F;..&#x2F;..&#x2F;FGame&#x2F;Content&#x2F;Paks&#x2F;fgame-ios.pak added to pak precacher.</span><br><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] Assertion failed: Shader-&gt;Bindings.StructureLayoutHash &#x3D;&#x3D; ParameterStructMetadata-&gt;GetLayoutHash() [File:&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC1&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;BuildEngine&#x2F;Engine&#x2F;Engine&#x2F;Source&#x2F;Runtime&#x2F;Engine&#x2F;Private&#x2F;ShaderCompiler&#x2F;ShaderCompiler.cpp] [Line: 4308] </span><br><span class="line">Seams shader FPixelProjectedReflectionMobile_ReflectionPassPS&#39;s parameter structure has changed without recompilation of the shader</span><br><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] [2020.09.19-08.48.01:834][  0]Assertion failed: Shader-&gt;Bindings.StructureLayoutHash &#x3D;&#x3D; ParameterStructMetadata-&gt;GetLayoutHash() [File:&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC1&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;BuildEngine&#x2F;Engine&#x2F;Engine&#x2F;Source&#x2F;Runtime&#x2F;Engine&#x2F;Private&#x2F;ShaderCompiler&#x2F;ShaderCompiler.cpp] [Line: 4308] </span><br><span class="line">Seams shader FPixelProjectedReflectionMobile_ReflectionPassPS&#39;s parameter structure has changed without recompilation of the shader</span><br></pre></td></tr></table></figure>
<p>导致这个问题的代码：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.26/Engine/Source/Runtime/Renderer/Private/PostProcess/PostProcessPixelProjectedReflectionMobile.h#L15">Renderer/Private/PostProcess/PostProcessPixelProjectedReflectionMobile.h#L15</a>，这个宏在Win和Mac两个引擎是不同的值。<br>不过目前4.26还没有出正式版本，观望正式版会不会修正。</p>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>在UE中，经常需要在C++代码中打印日志，UE也提供了方法来创建出可以通过UE_LOG打印日志的宏。<br>首先，先来看一下UE_LOG是什么，它是个宏，使用的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>它被定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Public/Logging/LogMacros.h#L192">Core/Public/Logging/LogMacros.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A  macro that outputs a formatted message to log if a given logging category is active at a given verbosity level</span></span><br><span class="line"><span class="comment"> * @param CategoryName name of the logging category</span></span><br><span class="line"><span class="comment"> * @param Verbosity, verbosity level to test against</span></span><br><span class="line"><span class="comment"> * @param Format, format text</span></span><br><span class="line"><span class="comment"> ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UE_LOG(CategoryName, Verbosity, Format, ...) \</span></span><br><span class="line">&#123; \</span><br><span class="line">  <span class="built_in"><span class="keyword">static_assert</span></span>(TIsArrayOrRefOfType&lt;<span class="keyword">decltype</span>(Format), TCHAR&gt;::Value, <span class="string">&quot;Formatting string must be a TCHAR array.&quot;</span>); \</span><br><span class="line">  <span class="built_in"><span class="keyword">static_assert</span></span>((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) &lt; ELogVerbosity::NumVerbosity &amp;&amp; ELogVerbosity::Verbosity &gt; <span class="number">0</span>, <span class="string">&quot;Verbosity must be constant and in range.&quot;</span>); \</span><br><span class="line">  <span class="built_in">CA_CONSTANT_IF</span>((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) &lt;= ELogVerbosity::COMPILED_IN_MINIMUM_VERBOSITY &amp;&amp; (ELogVerbosity::Warning &amp; ELogVerbosity::VerbosityMask) &lt;= FLogCategory##CategoryName::CompileTimeVerbosity) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="built_in">UE_LOG_EXPAND_IS_FATAL</span>(Verbosity, PREPROCESSOR_NOTHING, <span class="keyword">if</span> (!CategoryName.<span class="built_in">IsSuppressed</span>(ELogVerbosity::Verbosity))) \</span><br><span class="line">    &#123; \</span><br><span class="line">      <span class="keyword">auto</span> UE_LOG_noinline_lambda = [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; LCategoryName, <span class="keyword">const</span> <span class="keyword">auto</span>&amp; LFormat, <span class="keyword">const</span> <span class="keyword">auto</span>&amp;... UE_LOG_Args) FORCENOINLINE \</span><br><span class="line">      &#123; \</span><br><span class="line">        <span class="built_in">TRACE_LOG_MESSAGE</span>(LCategoryName, Verbosity, LFormat, UE_LOG_Args...) \</span><br><span class="line">        <span class="built_in">UE_LOG_EXPAND_IS_FATAL</span>(Verbosity, \</span><br><span class="line">          &#123; \</span><br><span class="line">            FMsg::<span class="built_in">Logf_Internal</span>(<span class="built_in">UE_LOG_SOURCE_FILE</span>(__FILE__), __LINE__, LCategoryName.<span class="built_in">GetCategoryName</span>(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span><br><span class="line">            _DebugBreakAndPromptForRemote(); \</span><br><span class="line">            FDebug::<span class="built_in">ProcessFatalError</span>(); \</span><br><span class="line">          &#125;, \</span><br><span class="line">          &#123; \</span><br><span class="line">            FMsg::<span class="built_in">Logf_Internal</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, LCategoryName.<span class="built_in">GetCategoryName</span>(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span><br><span class="line">          &#125; \</span><br><span class="line">        ) \</span><br><span class="line">      &#125;; \</span><br><span class="line">      <span class="built_in">UE_LOG_noinline_lambda</span>(CategoryName, Format, ##__VA_ARGS__); \</span><br><span class="line">      <span class="built_in">UE_LOG_EXPAND_IS_FATAL</span>(Verbosity, <span class="built_in">CA_ASSUME</span>(<span class="literal">false</span>);, PREPROCESSOR_NOTHING) \</span><br><span class="line">    &#125; \</span><br><span class="line">  &#125; \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，使用UE_LOG时传入的第一个参数，是一个对象，后面的参数则是一个枚举值以及输出的Formater，以及更多的参数（用于匹配Formater中的占位符）。</p>
<p>UE提供了几种方法来创建Log的Category：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogCategoryName,All,All);</span><br><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_CLASS</span>(LogCategoryName2,All,All);</span><br><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN_HELPER</span>(LogCategoryName3,All,All);</span><br></pre></td></tr></table></figure>

<p>挨个来看一下它们的定义，其实他们都是定义了一个类，并需要创建出一个对象，可以用来传递给<code>UE_LOG</code>的第一个参数，而后两个参数则都是<code>ELogVerbosity</code>的枚举值，用于给当前的LogCategory指定运行时和编译时的日志等级。<br>看一下这个枚举的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Enum that defines the verbosity levels of the logging system.</span></span><br><span class="line"><span class="comment"> * Also defines some non-verbosity levels that are hacks that allow</span></span><br><span class="line"><span class="comment"> * breaking on a given log line or setting the color.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">namespace</span> ELogVerbosity</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> :</span> uint8</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/** Not used */</span></span><br><span class="line">    NoLogging  = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Always prints a fatal error to console (and log file) and crashes (even if logging is disabled) */</span></span><br><span class="line">    Fatal,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints an error to console (and log file). </span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report errors. Error messages result in commandlet failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Error,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a warning to console (and log file).</span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report warnings. Warnings can be treated as an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Warning,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to console (and log file) */</span></span><br><span class="line">    Display,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to a log file (does not print to console) */</span></span><br><span class="line">    Log,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if Verbose logging is enabled for the given category, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Verbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if VeryVerbose logging is enabled, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging that would otherwise spam output) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VeryVerbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log masks and special Enum values</span></span><br><span class="line"></span><br><span class="line">    All    = VeryVerbose,</span><br><span class="line">    NumVerbosity,</span><br><span class="line">    VerbosityMask  = <span class="number">0xf</span>,</span><br><span class="line">    SetColor  = <span class="number">0x40</span>, <span class="comment">// not actually a verbosity, used to set the color of an output device </span></span><br><span class="line">    BreakOnLog  = <span class="number">0x80</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以根据自己的需求来指定不同的日志等级。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN"><a href="#DECLARE-LOG-CATEGORY-EXTERN" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN"></a>DECLARE_LOG_CATEGORY_EXTERN</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;extern&quot;, usually declared in the header and paired with DEFINE_LOG_CATEGORY in the source. Accessible by all files that include the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategory</span>##<span class="title">CategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt; \</span><br><span class="line">&#123; \</span><br><span class="line">  FORCEINLINE FLogCategory##<span class="built_in">CategoryName</span>() : <span class="built_in">FLogCategory</span>(<span class="built_in">TEXT</span>(#CategoryName)) &#123;&#125; \</span><br><span class="line">&#125; CategoryName;</span><br></pre></td></tr></table></figure>
<p>如果有以下声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogCategoryName,All,All);</span><br></pre></td></tr></table></figure>
<p>宏展开之后就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : FLogCategory(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>)) &#123;</span>&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>其实就是继承自<code>FLogCategory</code>的一个类定义，并且<strong>声明</strong>了一个<code>LogCategoryName</code>的对象。<br>注意，这里只是声明，还需要定义，不然在编译时会有未定义错误，所以就需要在cpp里写代码进行定义，UE也提供了一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DEFINE_LOG_CATEGORY</span>(LogCategoryName);</span><br></pre></td></tr></table></figure>
<p>它的定义就很简单了，只是定义一个对象而已：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category, usually paired with DECLARE_LOG_CATEGORY_EXTERN from the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to define</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY(CategoryName) FLogCategory##CategoryName CategoryName;</span></span><br></pre></td></tr></table></figure>
<p>对象经过定义之后就可以在<code>UE_LOG</code>使用了。<br>这种分离声明和定义的方式可以用在暴露给外部使用的情况，别的文件或者模块只需要包含具有声明的头文件即可。</p>
<h3 id="DECLARE-LOG-CATEGORY-CLASS"><a href="#DECLARE-LOG-CATEGORY-CLASS" class="headerlink" title="DECLARE_LOG_CATEGORY_CLASS"></a>DECLARE_LOG_CATEGORY_CLASS</h3><p><code>DECLARE_LOG_CATEGORY_CLASS</code>宏的实现就比<code>DECLARE_LOG_CATEGORY_EXTERN</code>多做了一些操作，它定义了一个结构并<strong>创建出一个static对象</strong>，不需要自己再使用<code>DEFINE_LOG_CATEGRORY</code>进行定义。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category as a C++ &quot;static&quot;. This should ONLY be declared in a source file. Only accessible in that single file.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY_STATIC(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategory</span>##<span class="title">CategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt; \</span><br><span class="line">&#123; \</span><br><span class="line">  FORCEINLINE FLogCategory##<span class="built_in">CategoryName</span>() : <span class="built_in">FLogCategory</span>(<span class="built_in">TEXT</span>(#CategoryName)) &#123;&#125; \</span><br><span class="line">&#125; CategoryName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;class static&quot; </span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_CLASS(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line">  <span class="built_in">DEFINE_LOG_CATEGORY_STATIC</span>(CategoryName, DefaultVerbosity, CompileTimeVerbosity)</span><br></pre></td></tr></table></figure>
<p>它的声明会展开为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : FLogCategory(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>)) &#123;</span>&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>可以看到，和<code>DECLARE_LOG_CATEGORY_EXTERN</code>的区别在于：</p>
<ol>
<li>去掉了<code>extern</code>修饰符</li>
<li>增加了static修饰符，定义对象</li>
</ol>
<p>使用这个宏的用途一般直接写在.cpp文件中，只供当前的翻译单元使用。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN-HELPER"><a href="#DECLARE-LOG-CATEGORY-EXTERN-HELPER" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN_HELPER"></a>DECLARE_LOG_CATEGORY_EXTERN_HELPER</h3><p><code>DECLARE_LOG_CATEGORY_EXTERN_HELPER</code>这个宏只是<code>DECLARE_LOG_CATEGORY_EXTERN</code>的封装，并没有自己做什么特别的事情，和<code>DECLARE_LOG_CATEGORY_EXTERN</code>的用法完全一致。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Platform specific logs, set here to make it easier to use them from anywhere</span></span><br><span class="line"><span class="comment">// need another layer of macro to help using a define in a define</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN_HELPER(A,B,C) DECLARE_LOG_CATEGORY_EXTERN(A,B,C)</span></span><br></pre></td></tr></table></figure>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p><code>DECLARE_LOG_CATEGORY_EXTERN</code>也可以通过<code>XXXX_API</code>的方式修饰并导出符号，使其可以在外部模块中使用。</p>
<h2 id="平台相关Target"><a href="#平台相关Target" class="headerlink" title="平台相关Target"></a>平台相关Target</h2><p>在项目的Target.cs中定义着项目的TargetRules，但是也不是所有的平台都可以通用全部的参数，每个平台都有自己特定的属性，所以UE的TargetRules定义中中还包含各个平台的Target：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Android-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> AndroidTargetRules AndroidPlatform = <span class="keyword">new</span> AndroidTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IOS-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> IOSTargetRules IOSPlatform = <span class="keyword">new</span> IOSTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lumin-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> LuminTargetRules LuminPlatform = <span class="keyword">new</span> LuminTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Linux-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> LinuxTargetRules LinuxPlatform = <span class="keyword">new</span> LinuxTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mac-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> MacTargetRules MacPlatform = <span class="keyword">new</span> MacTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PS4-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> PS4TargetRules PS4Platform = <span class="keyword">new</span> PS4TargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Switch-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> SwitchTargetRules SwitchPlatform = <span class="keyword">new</span> SwitchTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Windows-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> WindowsTargetRules WindowsPlatform; <span class="comment">// Requires &#x27;this&#x27; parameter; initialized in constructor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Xbox One-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> XboxOneTargetRules XboxOnePlatform = <span class="keyword">new</span> XboxOneTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> HoloLens-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> HoloLensTargetRules HoloLensPlatform;</span><br></pre></td></tr></table></figure>
<p>当需要对某个平台进行特殊控制时，可以在TargetRules中访问特定平台的对象。</p>
<p>如在IOS平台生成dSYM:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">&#123;</span><br><span class="line">	IOSPlatform.bGeneratedSYM = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="TargetRule获取项目路径"><a href="#TargetRule获取项目路径" class="headerlink" title="TargetRule获取项目路径"></a>TargetRule获取项目路径</h2><p>使用<code>ProjectFile</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Console.WriteLine(&quot;ProjectDir:&quot; + ProjectFile.Directory);</span><br></pre></td></tr></table></figure>

<h2 id="UObject获取资源路径"><a href="#UObject获取资源路径" class="headerlink" title="UObject获取资源路径"></a>UObject获取资源路径</h2><p>可以使用<code>FStringAssetReference</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FStringAssetReference <span class="title">ObjectPath</span><span class="params">(Object)</span></span>;</span><br><span class="line">FString AssetPackagePath = ObjectPath.<span class="built_in">ToString</span>();</span><br></pre></td></tr></table></figure>

<p>获取的路径格式为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Game/StarterContent/Materials/M_Basic_Floor.M_Basic_Floor</span><br></pre></td></tr></table></figure>

<p>如果想要获得类似编辑器<code>Copy Reference</code>的信息，则可以使用<code>FAssetData</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FAssetData <span class="title">AssetData</span><span class="params">(Object)</span></span>;</span><br><span class="line">FString ReferenceInfo = AssetData.<span class="built_in">GetExportTextName</span>();</span><br></pre></td></tr></table></figure>

<p>获取的格式为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Material&#x27;/Game/StarterContent/Materials/M_Basic_Floor.M_Basic_Floor&#x27;</span><br></pre></td></tr></table></figure>

<p>也能够根据UObject获取到它的资源类型。</p>
<p>如果用<code>FAssetData</code>获取C++类会得到下面的这样的信息（在运行时动态创建的对象）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Actor&#x27;/Game/StarterContent/Maps/UEDPIE_0_Minimal_Default.Minimal_Default:PersistentLevel.Actor_0&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="打包iOS导出dSYM"><a href="#打包iOS导出dSYM" class="headerlink" title="打包iOS导出dSYM"></a>打包iOS导出dSYM</h2><p>像Bugly之类的crash上报平台都需要上传符号表才能看到具体的堆栈信息，而iOS上的符号和调试信息都是在<code>dSYM</code>文件中的。<br>UE提供了dSYM的生成选项，在<code>Project Settings</code>-<code>Platforms</code>-<code>iOS</code>-<code>Build</code>：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-project-settings-ios-gen-dSYM.webp"></p>
<ul>
<li>Generate dSYM file for code debugging and profiling：只开启这个会在<code>Binaries/IOS</code>下生成<code>PROJECT_NAME.dSYM</code>文件</li>
<li>Generate dSYM bundle for third party crash tools：依赖上面的选项，如果开启会在<code>Binaries/IOS</code>下生成<code>PROJECT_NAME.dSYM.zip</code>，并且不会再生成<code>PROJECT_NAME.dSYM</code>文件。</li>
</ul>
<p>但是，在使用源码版打包iOS项目的时候生成的<code>dSYM</code>特别大，超过2G，而同样的工程用Luncher引擎打包就只有100+M，而且bugly之类的上传还有大小限制。</p>
<p>经过对比之后发现，大小的差距主要是在<code>_DWARF_debug_*</code>这些上（左侧为Launcher版，右侧为DebugGame源码版）：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-dSYM.webp"></p>
<p>本来以为是源码版会把所有参与编译的代码都导出到dSYM文件中，但是经过翻阅引擎代码发现，其实TargetRules中有控制调试信息的选项，就是来控制产生这些<code>_DWARF_debug_*</code>的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TargetRules.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to globally disable debug info generation; see DebugInfoHeuristics.cs for per-config and per-platform options.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-NoDebugInfo&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bDisableDebugInfo = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info generation for generated files. This improves link times for modules that have a lot of generated glue code.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bDisableDebugInfoForGeneratedCode = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info on PC in development builds (for faster developer iteration, as link times are extremely fast with debug info disabled).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> bOmitPCDebugInfoInDevelopment = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>在项目的<code>Target.cs</code>中控制这些变量即可，如<code>bDisableDebugInfo=true</code>，在源码版引擎中也不会生很大的<code>_DWARF_debug</code>文件了（左侧为Lunch版引擎，右侧为DebugGame源码版控制<code>bDisableDebugInfo=true</code>）：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-disabledebugfile-dSYM.webp"></p>
<p>而且，还发现UE在打包IOS平台的时候处理有问题，本来以为打Shipping生成的dSYM会没有调试信息了，但是测试发现还是非常大。</p>
<p>经过分析后发现，在UE的构建系统中是通过两个值来控制是否创建调试信息的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEBuildPlatforms.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create debug info based on the heuristics specified by the user.</span></span><br><span class="line">GlobalCompileEnvironment.bCreateDebugInfo =</span><br><span class="line">				!Target.bDisableDebugInfo &amp;&amp; ShouldCreateDebugInfo(Target);</span><br><span class="line">GlobalLinkEnvironment.bCreateDebugInfo = GlobalCompileEnvironment.bCreateDebugInfo;</span><br></pre></td></tr></table></figure>
<p>可以看到是通过<code>Target.bDisableDebugInfo</code>和<code>ShouldCreateDebugInfo(Target)</code>两个值来控制的，而<code>ShouldCreateDebugInfo</code>函数则是每个平台的有自己的重写实现。</p>
<p>如在Windows上：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/Windows/UEBuildWindows.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether this platform should create debug information or not</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>The target being built<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>bool    true if debug info should be generated, false if not<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        <span class="keyword">return</span> !Target.bOmitPCDebugInfoInDevelopment;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.DebugGame:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，在IOS和Mac上完全没有判断！</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这导致只能自己用<code>bDisableDebugInfo=true</code>来控制，太坑爹了。翻了代码才发现<code>bOmitPCDebugInfoInDevelopment</code>这个选项只在PC上有效：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn#L85">BuildConfigProperties.INT.udn#L85</a>。</p>
<h3 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h3><p>根据上面的介绍，可以通过控制<code>bDisableDebugInfo=true</code>来生成体积较小的<code>dSYM</code>，但这样有牵扯出来一个坑的问题：使用远程构建时<code>dSYM</code>无法通过UE的构建系统传回本地。<br>查了下代码，没有什么比较方便的办法来控制从远程拷贝的文件，目前我使用<code>pscp</code>从远程拉取dSYM文件回本地。</p>
<h2 id="编译引擎支持Android和iOS"><a href="#编译引擎支持Android和iOS" class="headerlink" title="编译引擎支持Android和iOS"></a>编译引擎支持Android和iOS</h2><p>把源码版引擎导出为安装版引擎时可以使用BuildGraph（Win+Android+iOS）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/RunUAT.bat BuildGraph -Script=InstalledEngineBuild.xml -Target=<span class="string">&quot;Make Installed Build Win64&quot;</span> -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -std:HostPlatformEditorOnly=<span class="literal">true</span> -std:HostPlatformOnly=<span class="literal">true</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">true</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">true</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithLuminMac=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinuxAArch64=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span> -<span class="built_in">set</span>:EmbedSrcSrvInfo=<span class="literal">false</span> -<span class="built_in">set</span>:WithFullDebugInfo=<span class="literal">false</span> -<span class="built_in">set</span>:GameConfigurations=Development -<span class="built_in">set</span>:VS2019=<span class="literal">true</span> -<span class="built_in">set</span>:InstalledDir=D:\EngineBin -compile</span><br></pre></td></tr></table></figure>
<p>但是编译iOS需要一台Mac，类似项目的远程构建，引擎构建iOS支持时也需要。<br>在之前的笔记中写到，项目的远程构建iOS时可以在<code>DefaultEngine.ini</code>中加上远程机器的地址和SSHKey：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">RemoteServerName</span>=xxx.xx.xx.xxx</span><br><span class="line"><span class="attr">RSyncUsername</span>=machinename</span><br><span class="line"><span class="attr">SSHPrivateKeyOverridePath</span>=D:\XXXX\RemoteToolChainPrivate.key</span><br></pre></td></tr></table></figure>
<p>在构建引擎时需要把它们写到<code>Engine\Config\BaseEngine.ini</code>中，然后再使用上面的命令构建即可。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/ToolChain/RemoteMac.cs#L155">UnrealBuildTool/ToolChain/RemoteMac.cs#L155</a></li>
</ul>
<h2 id="UPARAM"><a href="#UPARAM" class="headerlink" title="UPARAM"></a>UPARAM</h2><p>可以在UFUNCTION的函数中给指定的参数来指定它的UPARAM，可以用来控制函数的参数属性。之前是用来指定Ref(<code>UPARAM(Ref)</code>)，其实也可以使用<code>UPARAM(meta=())</code>来指定<code>meta</code>属性。</p>
<p>如在蓝图实现使用枚举bitmask：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, BlueprintCosmetic, Category=<span class="string">&quot;Audiokinetic|Actor&quot;</span>, meta=(AdvancedDisplay=<span class="string">&quot;2&quot;</span>, AutoCreateRefTerm = <span class="string">&quot;PostEventCallback,ExternalSources&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">PostEvent</span><span class="params">(	class UAkAudioEvent* AkEvent, </span></span></span><br><span class="line"><span class="function"><span class="params">						class AActor* Actor, </span></span></span><br><span class="line"><span class="function"><span class="params">						UPARAM(meta = (Bitmask, BitmaskEnum = EAkCallbackType)) int32 CallbackMask,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">const</span> FOnAkPostEventCallback&amp; PostEventCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">const</span> TArray&lt;FAkExternalSourceInfo&gt;&amp; ExternalSources,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">bool</span> bStopWhenAttachedToDestroyed = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">						FString EventName = FString(<span class="string">&quot;&quot;</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-uprarm-bitmask.webp"></p>
<p>指定返回值的名字什么的都不在话下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">UPARAM</span><span class="params">(DisplayName = <span class="string">&quot;Bundle&quot;</span>)</span> FOSCBundle&amp; <span class="title">AddMessageToBundle</span><span class="params">(<span class="keyword">const</span> FOSCMessage&amp; Message, UPARAM(ref) FOSCBundle&amp; Bundle)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/search?p=1&q=UPARAM&unscoped_q=UPARAM">UPARAM</a>看到引擎代码中的各种用法。</p>
<h2 id="无边框模式"><a href="#无边框模式" class="headerlink" title="无边框模式"></a>无边框模式</h2><p>可以开启<code>Project Settings</code>-<code>Description</code>-<code>Settings</code>-<code>Use Boardless Window</code>:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-description-use-boardless-window.webp"></p>
<p>这个变量在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/1eb5d965b994b4bd59f31ec4158d42f13137ab1f/Engine/Source/Runtime/Engine/Private/GameEngine.cpp#L430">UGameEngine::CreateGameWindow</a>中用到，用来控制引擎启动创建窗口时，窗口的Style.</p>
<p>在不重新打包的情况下可以将下面配置写到<code>Saved/Config/WindowsNoEditor/Game.ini</code>中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/EngineSettings.GeneralProjectSettings]</span></span><br><span class="line"><span class="attr">bUseBorderlessWindow</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>重启游戏就是无边框模式了。</p>
<h2 id="命令行导入iOS证书和Provision"><a href="#命令行导入iOS证书和Provision" class="headerlink" title="命令行导入iOS证书和Provision"></a>命令行导入iOS证书和Provision</h2><p>在部署构建机的时候，需要给每台构建机都导入iOS的<code>provision</code>和<code>p12</code>证书，如果每个都要打开一遍编辑器，纯粹是重复劳动，翻了下代码，UE编辑器中导入证书是通过调用<code>IPhonePackager.exe</code>来实现的，而且是以命令行的方式执行，这样就好办了，按照它的参数自己实现脚本即可。<br>具体看引擎中的相关代码：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Developer/IOS/IOSPlatformEditor/Private/IOSTargetSettingsCustomization.cpp#L1312">IOSTargetSettingsCustomization.cpp#L1312</a></p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>导入证书的命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -certificate <span class="string">&quot;D:\IOS_DEVELOPMENT.p12&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>证书是导入到系统中的，可以在<code>certmgr.msc</code>中查看导入的证书：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/import-ios-cer-in-windows-certmgr.webp"></p>
<p><strong>注意</strong>：因为iPhonePackager.exe在导入证书时会让弹框输入证书的密码：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/ue4-import-cer-for-ios.webp"></p>
<p>这导致不能用在自动化流程里，但是我怎么可能会老老实实每台电脑都输一次密码呢，看了一下iPhonePackager的代码，找到了弹窗让输入密码的地方<a target="_blank" rel="noopener" href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a>，我给它加了个从命令行参数读取密码的选项，如果有该参数就不会弹框：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load the certificate</span></span><br><span class="line"><span class="built_in">string</span> CertificatePassword = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="built_in">string</span>[] arguments = Environment.GetCommandLineArgs();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>;index&lt;arguments.Length;++index)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (arguments[index] == <span class="string">&quot;-cerpassword&quot;</span> &amp;&amp; index != (arguments.Length<span class="number">-1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		CertificatePassword = arguments[index + <span class="number">1</span>];</span><br><span class="line">		Console.WriteLine(<span class="string">&quot;Usage -cerpasseord argument&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">X509Certificate2 Cert = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">	Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">&#125;</span><br><span class="line">catch (System.Security.Cryptography.CryptographicException ex)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Try once with a password</span></span><br><span class="line">	<span class="keyword">if</span> (CertificatePassword.Length &gt; <span class="number">0</span> || PasswordDialog.RequestPassword(<span class="keyword">out</span> CertificatePassword))</span><br><span class="line">	&#123;</span><br><span class="line">		Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// User cancelled dialog, rethrow</span></span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把上面的代码替换掉<a target="_blank" rel="noopener" href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a>这里的部分，重新编译iPhonePackager即可。</p>
<h3 id="Provision"><a href="#Provision" class="headerlink" title="Provision"></a>Provision</h3><p>导入<code>Provision</code>的命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -provision <span class="string">&quot;D:\com.tencent.xxxx.xx_Development_SignProvision.mobileprovision&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>Provision文件导入后会放在用户目录下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The shared provision library directory (on PC)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProvisionDirectory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Environment.OSVersion.Platform == PlatformID.MacOSX || Environment.OSVersion.Platform == PlatformID.Unix) &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetEnvironmentVariable(<span class="string">&quot;HOME&quot;</span>) + <span class="string">&quot;/Library/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetFolderPath (Environment.SpecialFolder.LocalApplicationData) + <span class="string">&quot;/Apple Computer/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Win上就为：<code>C:\Users\USER_NAME\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles</code>.</p>
<h2 id="C-获取命令行参数"><a href="#C-获取命令行参数" class="headerlink" title="C#获取命令行参数"></a>C#获取命令行参数</h2><p>需要<code>using system;</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">string[] arguments = Environment.<span class="built_in">GetCommandLineArgs</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>;index&lt;arguments.Length;++index)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="打包时给不同的平台添加资源"><a href="#打包时给不同的平台添加资源" class="headerlink" title="打包时给不同的平台添加资源"></a>打包时给不同的平台添加资源</h2><p>有时我们需要在打包时给不同的平台添加不同目录下的外部资源（如WWise），UE提供了<code>Project Settings</code>-<code>Packaging</code>-<code>Additional Non-Asset Directories to Package</code>，找了一下，并没有发现单独给某个平台指定添加路径的地方。<br><strong>但是</strong>，<code>Additional Non-Asset Directories to Package</code>本身是支持给不同平台添加不同目录的，只要在<code>Additional Non-Asset Directories to Package</code>添加的目录下根据不同的平台创建不同的目录。<br>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D:\EmptyProject\Content\WwiseAudio&gt;tree &#x2F;a</span><br><span class="line">+---Android</span><br><span class="line">|   \---English(US)</span><br><span class="line">+---iOS</span><br><span class="line">|   \---English(US)</span><br><span class="line">\---Windows</span><br><span class="line">    \---English(US)</span><br></pre></td></tr></table></figure>
<p>在项目的<code>Content\WwiseAudio</code>下，有<code>Android</code>/<code>iOS</code>/<code>Windows</code>等目录，在<code>Additional Non-Asset Directories to Package</code>中添加的是<code>WwiseAudio</code>目录,打包时只会把对应平台的目录给打包进去，但是没有看到UE的文档里哪有写。</p>
<h2 id="监听资源保存的事件"><a href="#监听资源保存的事件" class="headerlink" title="监听资源保存的事件"></a>监听资源保存的事件</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PackageSaved</span><span class="params">(<span class="keyword">const</span> FString&amp; PacStr,UObject* PackageSaved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Package %s Saved.&quot;</span>),*PacStr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FEmptyProjectModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UPackage::PackageSavedEvent.<span class="built_in">AddStatic</span>(&amp;PackageSaved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UStruct的json序列化"><a href="#UStruct的json序列化" class="headerlink" title="UStruct的json序列化"></a>UStruct的json序列化</h2><p>因为UStruct在UE内是具有反射的，所以不用自己去解析编码就可以实现序列化和反序列化，UE中提供了一个辅助模块：<code>JsonUtilities</code>，里面具有<code>FJsonObjectConverter</code>类，定义了一系列的操作。<br>我简单封装了一下，对Ustrut的序列化和反序列化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TSerializeStructAsJsonObject</span><span class="params">(<span class="keyword">const</span> TStructType&amp; InStruct,TSharedPtr&lt;FJsonObject&gt;&amp; OutJsonObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!OutJsonObject.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        OutJsonObject = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FJsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = FJsonObjectConverter::<span class="built_in">UStructToJsonObject</span>(TStructType::<span class="built_in">StaticStruct</span>(),&amp;InStruct,OutJsonObject.<span class="built_in">ToSharedRef</span>(),<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TDeserializeJsonObjectAsStruct</span><span class="params">(<span class="keyword">const</span> TSharedPtr&lt;FJsonObject&gt;&amp; OutJsonObject,TStructType&amp; InStruct)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(OutJsonObject.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        bStatus = FJsonObjectConverter::<span class="built_in">JsonObjectToUStruct</span>(OutJsonObject.<span class="built_in">ToSharedRef</span>(),TStructType::<span class="built_in">StaticStruct</span>(),&amp;InStruct,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TSerializeStructAsJsonString</span><span class="params">(<span class="keyword">const</span> TStructType&amp; InStruct,FString&amp; OutJsonString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bRunStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        TSharedPtr&lt;FJsonObject&gt; JsonObject;</span><br><span class="line">        <span class="keyword">if</span> (TSerializeStructAsJsonObject&lt;TStructType&gt;(InStruct,JsonObject) &amp;&amp; JsonObject.<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> JsonWriter = TJsonWriterFactory&lt;&gt;::<span class="built_in">Create</span>(&amp;OutJsonString);</span><br><span class="line">            FJsonSerializer::<span class="built_in">Serialize</span>(JsonObject.<span class="built_in">ToSharedRef</span>(), JsonWriter);</span><br><span class="line">            bRunStatus = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRunStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TDeserializeJsonStringAsStruct</span><span class="params">(<span class="keyword">const</span> FString&amp; InJsonString,TStructType&amp; OutStruct)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bRunStatus = <span class="literal">false</span>;</span><br><span class="line">    TSharedRef&lt;TJsonReader&lt;TCHAR&gt;&gt; JsonReader = TJsonReaderFactory&lt;TCHAR&gt;::<span class="built_in">Create</span>(InJsonString);</span><br><span class="line">    TSharedPtr&lt;FJsonObject&gt; DeserializeJsonObject;</span><br><span class="line">    <span class="keyword">if</span> (FJsonSerializer::<span class="built_in">Deserialize</span>(JsonReader, DeserializeJsonObject))</span><br><span class="line">    &#123;</span><br><span class="line">        bRunStatus = TDeserializeJsonObjectAsStruct&lt;TStructType&gt;(DeserializeJsonObject,OutStruct);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRunStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redirector"><a href="#Redirector" class="headerlink" title="Redirector"></a>Redirector</h2><p><code>Redirector</code>是标记被移动资源的引用关系的，在移动具有引用的资源时会产生。<br>如<code>/Game/GameMap</code>引用到了一个UI资源<code>/Game/UMG_Main</code>，当移动<code>/Game/UMG_Main</code>到<code>/Game/TEST/UMG_Main</code>时，会在<code>/Game/UMG_Main</code>的磁盘路径下创建出一个Redirector，用与告诉引用到该UI的资源，它的真实路径已经发生变化了，所以叫Redirector。<br>在项目中需要尽量避免Redirector的存在。</p>
<h2 id="检查引擎是否运行在Commandlet"><a href="#检查引擎是否运行在Commandlet" class="headerlink" title="检查引擎是否运行在Commandlet"></a>检查引擎是否运行在Commandlet</h2><p>UE中有检测的方法，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Public/CoreGlobals.h#L201">CoreGlobals.h</a>的<code>IsRunningCommandlet</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check to see if this executable is running a commandlet (custom command-line processing code in an editor-like environment)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">IsRunningCommandlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">	<span class="keyword">return</span> PRIVATE_GIsRunningCommandlet;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FSoftObjectPath限定类型"><a href="#FSoftObjectPath限定类型" class="headerlink" title="FSoftObjectPath限定类型"></a>FSoftObjectPath限定类型</h2><p>默认<code>FSoftObjectPath</code>可以指定任何继承自UObject的资源类型，但有时候只想要指定某些类型，UE提供了限定类型的功能，要使用UPROPERTY：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(config, EditAnywhere, Category=DefaultMaps, meta=(AllowedClasses=<span class="string">&quot;World&quot;</span>))</span><br><span class="line">FSoftObjectPath EditorStartupMap;</span><br></pre></td></tr></table></figure>

<p>在<code>meta</code>中使用<code>AllowedClasses</code>即可，<code>AllowedClassess</code>的值是实际类型去掉前缀<code>U</code>，如<code>USoundClass</code>要使用<code>SoundClass</code>。</p>
<p><code>AllowedClasses</code>可以指定多个，使用逗号分隔，使当前FSoftObjectPath可以指定多个限定类型的资源。而且还可以使用<code>ExactClass</code>来控制是否严格限定类型（是否允许继承层次中类型中的资源，如<code>UDataTable</code>和<code>UCompositeDataTable</code>），如果不指定，默认是严格限定类型的，如果<code>ExactClass=true</code>则可以使用继承层次中类型的资源。</p>
<h2 id="编辑器viewport显示文字"><a href="#编辑器viewport显示文字" class="headerlink" title="编辑器viewport显示文字"></a>编辑器viewport显示文字</h2><p><code>UKismetSystemLibrary::PrintString</code>是运行时可以输出到viewport，在编辑器下无效果，想要实现编辑器下的文本输出可以通过<code>FCanvas</code>的<code>DrawItem</code>来实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FCanvasTextItem <span class="title">TextItem</span><span class="params">(FVector2D(<span class="number">100</span>, <span class="number">200</span>), LOCTEXT(<span class="string">&quot;OutOfTextureMemory&quot;</span>, <span class="string">&quot;RAN OUT OF TEXTURE MEMORY, EXPECT CORRUPTION AND GPU HANGS!&quot;</span>), GEngine-&gt;GetMediumFont(), FLinearColor::Red)</span></span>;</span><br><span class="line">TextItem.<span class="built_in">EnableShadow</span>(FLinearColor::Black);</span><br><span class="line">Canvas-&gt;<span class="built_in">DrawItem</span>(TextItem);</span><br></pre></td></tr></table></figure>

<p>如<code>stat fps</code>等，都是通过<code>FCanvas</code>来实现的，如<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Private/UnrealEngine.cpp#L9824">DrawMapWarnings</a>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-viveport-ligthing-need-rebuilt.webp"></p>
<p>以及<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Private/UnrealEngine.cpp#L14677">RenderStatFPS</a>:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-viveport-stat-fps.webp"></p>
<p><code>FCanvas</code>可以通过<code>FViewport::GetDebugCanvas()</code>来获得。</p>
<h2 id="开启多核心编译"><a href="#开启多核心编译" class="headerlink" title="开启多核心编译"></a>开启多核心编译</h2><p>UBT会从下面三个文件中读取配置：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* Engine/Saved/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *User Folder/AppData*/Roaming/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *My Documents*/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br></pre></td></tr></table></figure>

<p>我们只需要修改其中的任意一个就可以。</p>
<p>默认具有以下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>更多的BuildConfigutation的参数可以看引擎文档<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealBuildSystem/Configuration/index.html">Configuring Unreal Build System</a>。在文档中<code>ProcessorCountMultiplier</code>元素的数字就是允许使用的处理器数，<strong>但是</strong>，UE的文档和实际的代码有出入，按照上面的文档，设置<code>ProcessorCountMultiplier</code>是在<code>BuildConfigutation</code>下的，但是这么写会与错误：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BuildConfiguration.xml(4): [] 元素 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“BuildConfiguration”。 的子元素 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“ProcessorCountMultiplier”。 无效。应为可能元素的列表: 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“bPGOProfile, bAllowHybridExecutor, DMUCSDistProp, bAllowXGE, bGeneratedSYMFile, bAllowSNDBS, bIgnoreOutdatedImportLibraries, bUseFastSemanticsRenderContexts, bDisableDebugInfo, bParseTimingInfoForTracing, CppStandard, bPrintDebugInfo, bUseSharedPCHs, bDisableDebugInfoForGeneratedCode, bForcePrecompiledHeaderForGameModules, bUseShippingPhysXLibraries, bUseAdaptiveUnityBuild, bXGENoWatchdogThread, MinGameModuleSourceFilesForUnityBuild, bAdaptiveUnityDisablesOptimizations, bCheckLicenseViolations, bAllowParallelExecutor, bOmitFramePointers, bUseCheckedPhysXLibraries, bSupportEditAndContinue, bAllowASLRInShipping, bStripSymbols, bAllowDistcc, bVerboseDistccOutput, bUseInlining, bAllowDistccLocalFallback, bAdaptiveUnityEnablesEditAndContinue, bEnableMemorySanitizer, bCheckSystemHeadersForModification, bUseFastPDBLinking, bAdaptiveUnityDisablesProjectPCHForProjectPrivate, BaseLogFileName, bUsePerFileIntellisense, bCreateMapFile, bUsePCHFiles, DMUCSCoordinat...。</span><br></pre></td></tr></table></figure>

<p>查阅代码之后发现，这些配置选项要去看<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn">BuildConfigProperties.INT.udn</a>里的参数，<code>ProcessorCountMultiplier </code>是在<code>ParallelExecutor</code>下的，所以改成以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>目前我使用的完整配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxParallelActions</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxParallelActions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bAllowParallelExecutor</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bAllowParallelExecutor</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>4<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关连接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/747044/view.html">How to use multiple processors for compiling?</a></li>
</ul>
<h2 id="URL-Encode-Decode"><a href="#URL-Encode-Decode" class="headerlink" title="URL Encode/Decode"></a>URL Encode/Decode</h2><p>UE提供了相关的API：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">FGenericPlatformHttp::UrlDecode</span><span class="params">(<span class="keyword">const</span> FString &amp; EncodedString)</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">FGenericPlatformHttp::UrlEncode</span><span class="params">(<span class="keyword">const</span> FString &amp; UnencodedString)</span></span></span><br></pre></td></tr></table></figure>
<p>执行结果：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-http-encode-url.webp"></p>
<h2 id="查看APK的签名信息"><a href="#查看APK的签名信息" class="headerlink" title="查看APK的签名信息"></a>查看APK的签名信息</h2><p>可以使用<code>keytool.exe</code>（在JDK的bin中），使用以下参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool.exe<span class="string">&quot; -list -printcert -jarfile FGame-armv7.apk</span></span><br></pre></td></tr></table></figure>
<p>会打印出apk的签名色所有者和发布者，以及证书的有效时间、证书指纹等等。</p>
<h2 id="ASTC设置压缩率"><a href="#ASTC设置压缩率" class="headerlink" title="ASTC设置压缩率"></a>ASTC设置压缩率</h2><p>在<code>Project Settings</code>-<code>Engine</code>-<code>Cooker</code>中有选项：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-project-settings-cooker-astc-compression.webp"></p>
<h2 id="打包Windows以窗口模式启动"><a href="#打包Windows以窗口模式启动" class="headerlink" title="打包Windows以窗口模式启动"></a>打包Windows以窗口模式启动</h2><p>在项目的<code>Config</code>下新建<code>DefaultGameUserSettings.ini</code>文件，填入以下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.GameUserSettings]</span></span><br><span class="line"><span class="attr">bUseVSync</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">ResolutionSizeX</span>=<span class="number">1920</span></span><br><span class="line"><span class="attr">ResolutionSizeY</span>=<span class="number">1080</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeX</span>=<span class="number">1920</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeY</span>=<span class="number">1080</span></span><br><span class="line"><span class="attr">WindowPosX</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">WindowPosY</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">FullscreenMode</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">LastConfirmedFullscreenMode</span>=<span class="number">2</span>  </span><br><span class="line"><span class="attr">Version</span>=<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>打包之后就会以窗口模式启动了，分辨率可以自己修改。</p>
<h2 id="指定地图Cook及打包"><a href="#指定地图Cook及打包" class="headerlink" title="指定地图Cook及打包"></a>指定地图Cook及打包</h2><p>在<code>DefaultEditor.ini</code>中添加以下项：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[AllMaps]</span></span><br><span class="line">+Map=/Game/Assets/Scene/Map/Fb/v3/8r/xzzn/Fb_ThePoolOfTribute</span><br><span class="line">+Map=/Game/Assets/Scene/Map/LightSpeed/LightSpeed</span><br><span class="line"></span><br><span class="line"><span class="section">[AlwaysCookMaps]</span></span><br><span class="line">+Map=/Game/Assets/Scene/Map/Fb/v3/8r/xzzn/Fb_ThePoolOfTribute</span><br><span class="line">+Map=/Game/Assets/Scene/Map/LightSpeed/LightSpeed</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/11790/packaging-specific-maps-within-a-project.html">Packaging specific maps within a project</a></li>
</ul>
<h2 id="C-访问Collision-Chanel"><a href="#C-访问Collision-Chanel" class="headerlink" title="C++访问Collision Chanel"></a>C++访问Collision Chanel</h2><p><code>ECollisionChanel</code>是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Engine/EngineTypes.h">EngineTypes.h</a>中的枚举类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ECollisionChannel</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">	ECC_WorldStatic UMETA(DisplayName=&quot;WorldStatic&quot;),</span><br><span class="line">	ECC_WorldDynamic UMETA(DisplayName=&quot;WorldDynamic&quot;),</span><br><span class="line">	ECC_Pawn UMETA(DisplayName=&quot;Pawn&quot;),</span><br><span class="line">	ECC_Visibility UMETA(DisplayName=&quot;Visibility&quot; , TraceQuery=&quot;1&quot;),</span><br><span class="line">	ECC_Camera UMETA(DisplayName=&quot;Camera&quot; , TraceQuery=&quot;1&quot;),</span><br><span class="line">	ECC_PhysicsBody UMETA(DisplayName=&quot;PhysicsBody&quot;),</span><br><span class="line">	ECC_Vehicle UMETA(DisplayName=&quot;Vehicle&quot;),</span><br><span class="line">	ECC_Destructible UMETA(DisplayName=&quot;Destructible&quot;),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Reserved for gizmo collision */</span></span><br><span class="line">	ECC_EngineTraceChannel1 UMETA(Hidden),</span><br><span class="line"></span><br><span class="line">	ECC_EngineTraceChannel2 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel3 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel4 UMETA(Hidden), </span><br><span class="line">	ECC_EngineTraceChannel5 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel6 UMETA(Hidden),</span><br><span class="line"></span><br><span class="line">	ECC_GameTraceChannel1 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel2 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel3 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel4 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel5 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel6 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel7 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel8 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel9 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel10 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel11 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel12 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel13 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel14 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel15 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel16 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel17 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel18 UMETA(Hidden),</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Add new serializeable channels above here (i.e. entries that exist in FCollisionResponseContainer) */</span></span><br><span class="line">	<span class="comment">/** Add only nonserialized/transient flags below */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// NOTE!!!! THESE ARE BEING DEPRECATED BUT STILL THERE FOR BLUEPRINT. PLEASE DO NOT USE THEM IN CODE</span></span><br><span class="line"></span><br><span class="line">	ECC_OverlapAll_Deprecated UMETA(Hidden),</span><br><span class="line">	ECC_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是我们在项目设置中添加是可以取任意的名字的，而且创建的Chanel的数量有上限（18个），这是因为<code>ECollisionChanel</code>是预先定义了18个供游戏创建的枚举值，假如我们创建了一个名字为<code>AAA</code>的Chanel，会在当前项目的<code>Config/DefaultEngine.ini</code>的<code>[/Script/Engine.CollisionProfile]</code>中创建以下项：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+DefaultChannelResponses=(Channel=ECC_GameTraceChannel1,DefaultResponse=ECR_Overlap,bTraceType=False,bStaticObject=False,Name=&quot;AAA&quot;)</span><br></pre></td></tr></table></figure>
<p>在这里跟枚举值做了绑定，在C++代码中进行设置的时候就需要指定<code>ECC_GameTraceChannel1</code>的枚举值。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59507553">UE4C++自定义Object/Trace Channel</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/583529/how-to-get-collisiontrace-channel-by-name-in-c.html">How to get collision/trace channel by name in c++?</a></li>
</ul>
<p>Todo：可以写一个方便从名字获取ECollisionChanel枚举值的库。</p>
<h2 id="Actor的延迟Spawn"><a href="#Actor的延迟Spawn" class="headerlink" title="Actor的延迟Spawn"></a>Actor的延迟Spawn</h2><ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/284744/spawning-an-actor-with-parameters.html">Spawning an actor with parameters</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FTransform <span class="title">SpawnTransform</span><span class="params">(Rotation, Origin)</span></span>;</span><br><span class="line"><span class="keyword">auto</span> MyDeferredActor = Cast&lt;ADeferredActor&gt;(UGameplayStatics::<span class="built_in">BeginDeferredActorSpawnFromClass</span>(<span class="keyword">this</span>, DeferredActorClass, SpawnTransform));</span><br><span class="line"><span class="keyword">if</span> (MyDeferredActor != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    MyDeferredActor-&gt;<span class="built_in">Init</span>(ShootDir);</span><br><span class="line"></span><br><span class="line">    UGameplayStatics::<span class="built_in">FinishSpawningActor</span>(MyDeferredActor, SpawnTransform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译引擎的WindowsDebugTools错误"><a href="#编译引擎的WindowsDebugTools错误" class="headerlink" title="编译引擎的WindowsDebugTools错误"></a>编译引擎的WindowsDebugTools错误</h2><p>编译引擎出现以下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Unable to find installation of PDBCOPY.EXE, which is required to strip symbols. This tool is included as part of the &#x27;Windows Debugging Tools&#x27; component of the Windows 10 SDK (https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk).</span><br><span class="line">       while executing task &lt;Strip Platform=&quot;Win64&quot; BaseDir=&quot;C:\BuildAgent\workspace\FGameEngine\FEngine&quot; Files=&quot;#UE4Editor Win64 Unstripped&quot; OutputDir=&quot;C:\BuildAgent\workspace\FGameEngine\FEngine\Engine\Saved&quot; Tag=&quot;#UE4Editor Win64 Stripped&quot; /&gt;</span><br><span class="line">       at Engine\Build\InstalledEngineBuild.xml(183)</span><br><span class="line">       (see C:\BuildAgent\workspace\FGameEngine\FEngine\Engine\Programs\AutomationTool\Saved\Logs\Log.txt for full exception trace)</span><br></pre></td></tr></table></figure>
<p>这是因为没有安装Windows Debugging Tools，在<a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk">这里</a>下载Win10SDK安装程序，在其中选择安装Windows Debug Tools安装即可。</p>
<h2 id="BuildGraph构建引擎"><a href="#BuildGraph构建引擎" class="headerlink" title="BuildGraph构建引擎"></a>BuildGraph构建引擎</h2><p>可以使用下列命令：<br>构建引擎的工具集：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Build\BatchFiles\RunUAT.bat BuildGraph -Script=Engine\Build\InstalledEngineBuild.xml -Target=<span class="string">&quot;Build Tools Win64&quot;</span> -<span class="built_in">set</span>:HostPlatformOnly=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin64=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -clean</span><br></pre></td></tr></table></figure>
<p>构建引擎：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/RunUAT.bat BuildGraph -Script=Engine\Build\InstalledEngineBuild.xml -target=\&quot;Make Installed Build Win64\&quot; -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin64=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">false</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinuxAArch64=<span class="literal">false</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Game-module-could-not-be-loaded"><a href="#Game-module-could-not-be-loaded" class="headerlink" title="Game module could not be loaded"></a>Game module could not be loaded</h2><p>在引入其他模块的代码时，有时候会具有下面这样的情况：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ModuleLoadFaild/ue4-game-module-could-not-be-loaded.webp"></p>
<p>Log中的提示：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2020.07.18-01.58.50:729][  0]LogWindows: Failed to load &#x27;E:/UnrealProjects/Examples/HotPatcherExample/Binaries/Win64/UE4Editor-HotPatcherExample.dll&#x27; (GetLastError=1114)</span><br><span class="line">[2020.07.18-01.58.50:729][  0]LogModuleManager: Warning: ModuleManager: Unable to load module &#x27;E:/UnrealProjects/Examples/HotPatcherExample/Binaries/Win64/UE4Editor-HotPatcherExample.dll&#x27; because the file couldn&#x27;t be loaded by the OS.</span><br><span class="line">[2020.07.18-02.01.38:988][  0]LogWindowsTextInputMethodSystem: Display: IME system now activated using TSF (微软拼音).</span><br><span class="line">[2020.07.18-02.01.38:991][  0]Message dialog closed, result: Ok, title: Message, text: The game module &#x27;HotPatcherExample&#x27; could not be loaded. There may be an operating system error or the module may not be properly set up.</span><br><span class="line">[2020.07.18-02.01.38:991][  0]LogCore: Engine exit requested (reason: EngineExit() was called)</span><br></pre></td></tr></table></figure>

<p>这个问题应该是项目中（或者插件中）加载DLL失败的问题，一般情况下是DLL文件存在问题或者DLL中逻辑的错误造成。</p>
<p>经过排查后发现我触发这个问题的方式为在使用UnLua注册<code>lua_Reg</code>函数时漏掉了置空最后一个元素：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> luaL_Reg AMyActorLib[]=</span><br><span class="line">&#123;</span><br><span class="line">	&#123;<span class="string">&quot;ReceiveBytes&quot;</span>,ReceiveBytes&#125;,</span><br><span class="line">	<span class="comment">// &#123;nullptr,nullptr&#125;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_REFLECTED_CLASS</span>(AMyActor)</span><br><span class="line">	<span class="built_in">ADD_LIB</span>(AMyActorLib)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>(AMyActor)</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(AMyActor)</span><br></pre></td></tr></table></figure>

<p>因为<code>AMyActorLib</code>这个数组最后一个元素没有置空，在<code>UnLuaEx.inl</code>中的AddLib函数中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> bIsReflected&gt;</span><br><span class="line"><span class="keyword">void</span> TExportedClassBase&lt;bIsReflected&gt;::<span class="built_in">AddLib</span>(<span class="keyword">const</span> luaL_Reg *InLib)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (InLib)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (InLib-&gt;name &amp;&amp; InLib-&gt;func)</span><br><span class="line">        &#123;</span><br><span class="line">        	GlueFunctions.<span class="built_in">Add</span>(<span class="keyword">new</span> <span class="built_in">FGlueFunction</span>(<span class="built_in">ANSI_TO_TCHAR</span>(InLib-&gt;name), InLib-&gt;func));</span><br><span class="line">        	++InLib;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>lua_Reg</code>数组的最后一个元素不为空就会导致这里出发UB行为（死循环），导致当前模块加载失败，也就触发了前面模块加载失败的问题。</p>
<h2 id="蓝图编辑器中节点属性的修改"><a href="#蓝图编辑器中节点属性的修改" class="headerlink" title="蓝图编辑器中节点属性的修改"></a>蓝图编辑器中节点属性的修改</h2><p>在编辑器模式下修改节点的值：</p>
<p>执行的函数是<code>UEdGraphSchema_K2::TrySetDefaultValue</code>(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Editor/BlueprintGraph/Private/EdGraphSchema_K2.cpp#L4747">Editor/BlueprintGraph/Private/EdGraphSchema_K2.cpp</a>)，是通过<code>Schema</code>来调用的。简单来说就是通过当前的节点，去修改节点上的Pin的值，不管原始类型是什么，FString/int/float还是枚举，都可以通过这个方法设置。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-set-node-value-in-editor.webp"></p>
<h3 id="UMG资料文档"><a href="#UMG资料文档" class="headerlink" title="UMG资料文档"></a>UMG资料文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/index.html">UMG UI Disigner</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/WidgetBlueprints/index.html">Widget Blueprints</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/WidgetTypeReference/index.html">Widget Type Reference</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/QuickStart/index.html">UMG UI Designer Quick Start Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/UMGRichTextBlock/index.html">UMG Rich Text Block</a></li>
</ul>
<p>文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/tech-blog/advanced-text-styling-with-rich-text-block">Advanced Text Styling with Rich Text Block</a></li>
</ul>
<h2 id="Enum反射"><a href="#Enum反射" class="headerlink" title="Enum反射"></a>Enum反射</h2><h3 id="UHT为Enum生成的代码"><a href="#UHT为Enum生成的代码" class="headerlink" title="UHT为Enum生成的代码"></a>UHT为Enum生成的代码</h3><p>在UE中，当我们声明一个枚举类型时可以像UClass一样地形式为其添加<code>UENUM</code>标记，指导UHT为其生成反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETypeName</span> :</span>uint8</span><br><span class="line">&#123;</span><br><span class="line">	None,</span><br><span class="line">	Int,</span><br><span class="line">	Float</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过UHT之后就变成了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETYPENAME(op) \</span></span><br><span class="line">	<span class="built_in">op</span>(ETypeName::None) \</span><br><span class="line">	<span class="built_in">op</span>(ETypeName::Int) \</span><br><span class="line">	<span class="built_in">op</span>(ETypeName::Float) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETypeName</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;();</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .gen.cpp</span></span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETypeName_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = <span class="built_in">GetStaticEnum</span>(Z_Construct_UEnum_TopdownExample_ETypeName, <span class="built_in">Z_Construct_UPackage__Script_TopdownExample</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;ETypeName&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ETypeName_StaticEnum</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETypeName</span><span class="params">(ETypeName_StaticEnum, TEXT(<span class="string">&quot;/Script/TopdownExample&quot;</span>), TEXT(<span class="string">&quot;ETypeName&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2221805252U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_TopdownExample_ETypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_TopdownExample</span>();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="built_in">FindExistingEnumIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;ETypeName&quot;</span>), <span class="number">0</span>, <span class="built_in">Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::None&quot;</span>, (int64)ETypeName::None &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Int&quot;</span>, (int64)ETypeName::Int &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Float&quot;</span>, (int64)ETypeName::Float &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;MyK2Node.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_TopdownExample,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				<span class="built_in">ARRAY_COUNT</span>(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				<span class="built_in">METADATA_PARAMS</span>(Enum_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::<span class="built_in">ConstructUEnum</span>(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>UEnum的构造思路和UClass差不多，通过UHT生成Enum的反射代码，记录枚举类型的名字、枚举值的名字、元数据等等，通过<code>UE4CodeGen_Private::ConstructUEnum</code>把这些反射数据构造出UEnum。</p>
<p>同样也是通过<strong>延迟注册</strong>的方式把UEnum构造出来。</p>
<h3 id="运行时访问UEnum"><a href="#运行时访问UEnum" class="headerlink" title="运行时访问UEnum"></a>运行时访问UEnum</h3><p>如果要获取一个<code>UENMU</code>的UEnum*可以通过<code>StaticEnum&lt;ETypeName&gt;()</code>或者通过<code>UEnum* const MethodEnum = FindObjectChecked&lt;UEnum&gt;(ANY_PACKAGE, TEXT(&quot;ETypeName&quot;), true);</code>来拿。</p>
<p>在UE4.22+的版本中可以使用下列方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = StaticEnum&lt;EnumType&gt;();</span><br></pre></td></tr></table></figure>
<p>在4.21及之前的版本就要麻烦一点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, <span class="built_in">TEXT</span>(<span class="string">&quot;EnumType&quot;</span>), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>注意上面的<code>TEXT(&quot;EnumType&quot;)</code>其中要填想要获取的枚举类型名字。</p>
<h3 id="根据枚举名字获取枚举值"><a href="#根据枚举名字获取枚举值" class="headerlink" title="根据枚举名字获取枚举值"></a>根据枚举名字获取枚举值</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get enum value by name</span></span><br><span class="line">&#123;</span><br><span class="line">	FString EnumTypeName = <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>);</span><br><span class="line">    FString EnumName = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s::%s&quot;</span>),*EnumTypeName,<span class="built_in">TEXT</span>(<span class="string">&quot;Int&quot;</span>))</span><br><span class="line"></span><br><span class="line">    UEnum* ETargetPlatformEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    int32 EnumIndex = ETargetPlatformEnum-&gt;<span class="built_in">GetIndexByName</span>(<span class="built_in">FName</span>(*EnumName));</span><br><span class="line">    <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;FOUND ENUM INDEX SUCCESS&quot;</span>));</span><br><span class="line">      int32 EnumValue = ETargetPlatformEnum-&gt;<span class="built_in">GetValueByIndex</span>(EnumIndex);</span><br><span class="line">      ETargetPlatform CurrentEnum = (ETargetPlatform)EnumValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果也想再封装一层模板类，让枚举名字也可以自动获取，则需要用得到C++的RTTI特性：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> std::string <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string result;</span><br><span class="line">    std::string type_name = <span class="built_in"><span class="keyword">typeid</span></span>(T).<span class="built_in">name</span>();</span><br><span class="line"></span><br><span class="line">    std::for_each(type_name.<span class="built_in">begin</span>(),type_name.<span class="built_in">end</span>(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!std::<span class="built_in">isdigit</span>(character)) result.<span class="built_in">push_back</span>(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="枚举值与字符串的互相转换"><a href="#枚举值与字符串的互相转换" class="headerlink" title="枚举值与字符串的互相转换"></a>枚举值与字符串的互相转换</h3><p>有些需要序列化枚举值的需要，虽然我们可以通过<code>FindObject&lt;UEnum&gt;</code>传入枚举名字拿到<code>UEnum*</code>，再通过<code>GetNameByValue</code>拿到名字，但是这样需要针对每个枚举都要单独写，我写了模板函数来做这个事情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时支持4.21- 和4.21+版本引擎</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> std::string <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string result;</span><br><span class="line">    std::string type_name = <span class="built_in"><span class="keyword">typeid</span></span>(T).<span class="built_in">name</span>();</span><br><span class="line"></span><br><span class="line">    std::for_each(type_name.<span class="built_in">begin</span>(),type_name.<span class="built_in">end</span>(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!std::<span class="built_in">isdigit</span>(character)) result.<span class="built_in">push_back</span>(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetEnumNameByValue</span><span class="params">(ENUM_TYPE InEnumValue, <span class="keyword">bool</span> bFullName = <span class="literal">false</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    &#123;</span><br><span class="line">      FString TypeName;</span><br><span class="line">      FString ValueName;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt; 21</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = <span class="built_in">ANSI_TO_TCHAR</span>(GetCPPTypeName&lt;ENUM_TYPE&gt;().<span class="built_in">c_str</span>());</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">      &#123;</span><br><span class="line">        result = FoundEnum-&gt;<span class="built_in">GetNameByValue</span>((int64)InEnumValue).<span class="built_in">ToString</span>();</span><br><span class="line">        result.<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>), &amp;TypeName, &amp;ValueName, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (!bFullName)</span><br><span class="line">        &#123;</span><br><span class="line">          result = ValueName;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及从字符串获取枚举值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">GetEnumValueByName</span><span class="params">(<span class="keyword">const</span> FString&amp; InEnumValueName, ENUM_TYPE&amp; OutEnumValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt;22</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line">        FString EnumTypeName = FoundEnum-&gt;CppType;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = *GetCPPTypeName&lt;ENUM_TYPE&gt;();</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">    &#123;</span><br><span class="line">      FString EnumValueFullName = EnumTypeName + <span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>) + InEnumValueName;</span><br><span class="line">      int32 EnumIndex = FoundEnum-&gt;<span class="built_in">GetIndexByName</span>(<span class="built_in">FName</span>(*EnumValueFullName));</span><br><span class="line">      <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 EnumValue = FoundEnum-&gt;<span class="built_in">GetValueByIndex</span>(EnumIndex);</span><br><span class="line">        ENUM_TYPE ResultEnumValue = (ENUM_TYPE)EnumValue;</span><br><span class="line">        OutEnumValue = ResultEnumValue;</span><br><span class="line">        bStatus = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Struct反射"><a href="#Struct反射" class="headerlink" title="Struct反射"></a>Struct反射</h2><p>前面讲到了Class/function/property的反射，UE还支持结构体的反射，其实从C++的标准语义来说并没有区分“结构”和“类”，关键字<code>struct</code>和<code>class</code>的区别只在于默认的访问权限。</p>
<p>在UE里面，支持反射的结构提只能使用<code>struct</code>，并且不能包含任何UFUNCTION的函数，命名必须以F开头。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	int32 ival;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UE的标记语法和Class的类似，不过UHT为Struct生成的代码要简单许多，因为没有UFUNCTION也没有继承UObject。</p>
<p><code>GENERATED_USTRUCT_BODY</code>这个标记UHT会展开生成一个真正的C++宏(在genreated.h中)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HotPatcherExample_Source_HotPatcherExample_TestStruct_h_11_GENERATED_BODY \</span></span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics</span>;</span> \</span><br><span class="line">	<span class="function">HOTPATCHEREXAMPLE_API <span class="keyword">static</span> class UScriptStruct* <span class="title">StaticStruct</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;<span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span>&gt;</span>();</span><br></pre></td></tr></table></figure>

<p>把UHT生成的用于记录当前struct反射数据的结构<code>Z_Construct_UScriptStruct_FTestStruct_Statis</code>声明为当前struct类的友元，可以让它访问到自己的私有成员。而且还声明了当前Struct的static成员函数<code>StaticStruct</code>和全局模板函数<code>StaticStruct&lt;FTestStruct&gt;</code>。</p>
<p>对Struct生成的反射数；</p>
<p>据的结构与class的类似，只有Property的反射信息。</p>
<p><code>gen.cpp</code>中有以下内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class UScriptStruct* <span class="title">FTestStruct::StaticStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UScriptStruct</span>* <span class="title">Singleton</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (!Singleton)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="keyword">extern</span> HOTPATCHEREXAMPLE_API uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">		Singleton = <span class="built_in">GetStaticStruct</span>(Z_Construct_UScriptStruct_FTestStruct, <span class="built_in">Z_Construct_UPackage__Script_HotPatcherExample</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct), <span class="built_in">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Singleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;FTestStruct&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> FTestStruct::<span class="built_in">StaticStruct</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDeferStruct <span class="title">Z_CompiledInDeferStruct_UScriptStruct_FTestStruct</span><span class="params">(FTestStruct::StaticStruct, TEXT(<span class="string">&quot;/Script/HotPatcherExample&quot;</span>), TEXT(<span class="string">&quot;TestStruct&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		UScriptStruct::<span class="built_in">DeferCppStructOps</span>(<span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>)),<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; ScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct;</span><br><span class="line"></span><br><span class="line"><span class="function">UScriptStruct* <span class="title">Z_Construct_UScriptStruct_FTestStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="function"><span class="keyword">extern</span> uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">	UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_HotPatcherExample</span>();</span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = <span class="built_in">FindExistingStructIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;TestStruct&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct), <span class="built_in">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (!ReturnStruct)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUScriptStruct</span>(ReturnStruct, Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnStruct;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">4266809061U</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码包含了从UHT生成的反射信息中构造出<code>UStructSctruct</code>以及延迟注册的方法，和Class的方式类似。</p>
<p>还包含生成的结构<code>Z_Construct_UScriptStruct_STRUCTNAME_Statics</code>如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Struct_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">NewStructOps</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_Texture_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_Texture;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FStructParams ReturnStructParams;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics::NewStructOps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (UScriptStruct::ICppStructOps*)<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture = &#123; </span><br><span class="line">	<span class="string">&quot;Texture&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Object, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	<span class="built_in">STRUCT_OFFSET</span>(FTestStruct, Texture), </span><br><span class="line">	Z_Construct_UClass_UTexture2D_NoRegister, </span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData, </span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Int, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	<span class="built_in">STRUCT_OFFSET</span>(FTestStruct, ival), </span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData, </span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FStructParams Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_HotPatcherExample,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;NewStructOps,</span><br><span class="line">	<span class="string">&quot;TestStruct&quot;</span>,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(FTestStruct),</span><br><span class="line">	<span class="built_in"><span class="keyword">alignof</span></span>(FTestStruct),</span><br><span class="line">	Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	<span class="built_in">EStructFlags</span>(<span class="number">0x00000001</span>),</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams, <span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到Struct的每个属性也是通过<code>FPropertyParamsBase</code>来存储的，与Class一致。</p>
<p>区别在于，Struct使用<code>UE4CodeGen_Private::FStructParams</code>来存储当前结构的反射信息，其声明如下(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2603">CoreUObject/Public/UObject/UObjectGlobals.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FStructParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();	</span><br><span class="line">	UScriptStruct*                    (*SuperFunc)();</span><br><span class="line">	<span class="keyword">void</span>*                             (*StructOpsFunc)(); <span class="comment">// really returns UScriptStruct::ICppStructOps*</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	SIZE_T                              SizeOf;</span><br><span class="line">	SIZE_T                              AlignOf;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	uint32                              StructFlags; <span class="comment">// EStructFlags</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个结构中比较特殊的一点是<code>StructOpsFunc</code>是一个函数指针，用来管理C++结构的构造和析构，使用的也是placement-new的方式，<code>TCppStructOps&lt;&gt;</code>模板定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h#L1122">CoreUObject/Public/UObject/Class.h</a>。</p>
<h2 id="类反射"><a href="#类反射" class="headerlink" title="类反射"></a>类反射</h2><h3 id="UHT为类产生的反射信息"><a href="#UHT为类产生的反射信息" class="headerlink" title="UHT为类产生的反射信息"></a>UHT为类产生的反射信息</h3><p>当在UE中新建一个类并继承自<code>UObject</code>时，可以在类声明的上一行添加<code>UCLASS</code>标记，当执行编译的时候UBT会调用UHT来根据标记来生成C++代码（不过非UCLASS的类也可以用宏来生成反射信息）。</p>
<p>UHT为类生成的代码为：</p>
<ol>
<li>为所有的UFUNCTION的函数创建FName，命名规则为<code>NAME_CLASSNAME_FUNCTIONNAME</code>，如<code>NAME_AMyActor_TestFunc</code></li>
<li>BlueprintNativeEvent和BlueprintImplementEvent创建同名函数实现，并通过<code>ProcessEvent</code>转发调用</li>
<li>为所有加了UFUNCTION的函数生成Thunk函数，为当前类的static函数，原型为<code>static void execFUNCNAME( UObject* Context, FFrame&amp; Stack, RESULT_DECL)</code>；</li>
<li>创建当前类的<code>StaticRegisterNatives*</code>函数，并把上一步提到的<code>exec</code>这样的thunk函数通过<code>Name-execFunc指针</code>的形式通过<code>FNativeFunctionRegistrar::RegisterFunctions</code>注册到UClass；</li>
<li>创建出<code>Z_Construct_UClass_CLASSNAME_NoRegister</code>函数，返回值是<code>CLASSNAME::StaticClass()</code></li>
<li>创建出<code>Z_Construct_UClass_CLASSNAME_Statics</code>类（GENERATED_BODY等宏会把该类添加为我们创建类的友元，使其可以访问私有成员，用于获取成员指针）</li>
</ol>
<p><code>Z_Construct_UClass_CLASSNAME_Statics</code>类的结构为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AMyActor.h</span></span><br><span class="line"><span class="built_in">UCLASS</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXX_API</span> <span class="title">AMyActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		int32 ival;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function">int32 <span class="title">GetIval</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generated code in AMyActor.gen.cpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UClass_AMyActor_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">static</span> UObject* (*<span class="keyword">const</span> DependentSingletons[])();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FClassFunctionLinkInfo FuncInfo[];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FCppClassTypeInfoStatic StaticCppClassTypeInfo;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FClassParams ClassParams;</span><br><span class="line">	&#125;;</span><br><span class="line">	UObject* (*<span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::DependentSingletons[])() = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UClass_AActor,</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_MicroEnd_423,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> FClassFunctionLinkInfo Z_Construct_UClass_AMyActor_Statics::FuncInfo[] = &#123;</span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_GetIval, <span class="string">&quot;GetIval&quot;</span> &#125;, <span class="comment">// 3480851337</span></span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_TESTFUNC, <span class="string">&quot;TESTFUNC&quot;</span> &#125;, <span class="comment">// 2984899165</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该类中的成员为：</p>
<ul>
<li><code>static UObject* (*const DependentSingletons[])();</code>记录当前类基类的<code>Z_Construct_UClass_BASECLASSNAME</code>函数指针，用它可以构造出基类的UClass，还记录了当前类属于哪个Package的函数指针<code>Z_Construct_UPackage__Script_MODULENAME</code>。</li>
</ul>
<blockquote>
<p><code>Z_Construct_UPackage__Script_MODULENAME</code>函数是定义在<code>MODULE_NAME.init.gen.cpp</code>里。</p>
</blockquote>
<ul>
<li><code>static const UE4CodeGen_Private::FMetaDataPairParam Class_MetaDataParams[];</code>用于记录UCLASS的元数据，如BlueprintType标记</li>
<li>反射属性的<code>F*PropertyParams</code>以及其Metadata，均为static成员</li>
<li><code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于存储当前类所有的反射属性的信息（是个指针数组，用于存储5.3中的static成员的地址）</li>
<li><code>static const UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</code>，数组，用于存储当前类所有的接口信息</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams Z_Construct_UClass_AMyActor_Statics::InterfaceParams[] = &#123;</span><br><span class="line">	&#123; Z_Construct_UClass_UUnLuaInterface_NoRegister, (int32)<span class="built_in">VTABLE_OFFSET</span>(AMyActor, IUnLuaInterface), <span class="literal">false</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const FCppClassTypeInfoStatic StaticCppClassTypeInfo;</code>用于类型萃取，记录当前类是否是抽象类。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FCppClassTypeInfoStatic Z_Construct_UClass_AMyActor_Statics::StaticCppClassTypeInfo = &#123;</span><br><span class="line">		TCppClassTypeTraits&lt;AMyActor&gt;::IsAbstract,</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const UE4CodeGen_Private::FClassParams ClassParams;</code>构造出UClass需要的所有反射数据，统一记录上面所有生成的反射信息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FClassParams Z_Construct_UClass_AMyActor_Statics::ClassParams = &#123;</span><br><span class="line">	&amp;AMyActor::StaticClass,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;StaticCppClassTypeInfo,</span><br><span class="line">	DependentSingletons,</span><br><span class="line">	FuncInfo,</span><br><span class="line">	Z_Construct_UClass_AMyActor_Statics::PropPointers,</span><br><span class="line">	InterfaceParams,</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(DependentSingletons),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(FuncInfo),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::PropPointers),</span><br><span class="line">	<span class="built_in">ARRAY_COUNT</span>(InterfaceParams),</span><br><span class="line">	<span class="number">0x009000A0</span>u,</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>全局函数<code>Z_Construct_UClass_AMyActor</code>通过<code>ClassParams</code>构造出真正的UClass对象。</li>
<li>使用<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a>注册当前类到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，如果在<code>WITH_HOT_RELOAD</code>为true的情况下也会注册到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L616">GetDeferRegisterClassMap()</a>中。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line">	<span class="keyword">static</span> TClassCompiledInDefer&lt;TClass&gt; AutoInitialize##<span class="built_in">TClass</span>(<span class="built_in">TEXT</span>(#TClass), <span class="built_in"><span class="keyword">sizeof</span></span>(TClass), TClassCrc); \</span><br><span class="line">	UClass* TClass::GetPrivateStaticClass() \</span><br><span class="line">	&#123; \</span><br><span class="line">		<span class="keyword">static</span> UClass* PrivateStaticClass = <span class="literal">NULL</span>; \</span><br><span class="line">		<span class="keyword">if</span> (!PrivateStaticClass) \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span><br><span class="line">			<span class="built_in">GetPrivateStaticClassBody</span>( \</span><br><span class="line">				<span class="built_in">StaticPackage</span>(), \</span><br><span class="line">				(TCHAR*)<span class="built_in">TEXT</span>(#TClass) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), \</span><br><span class="line">				PrivateStaticClass, \</span><br><span class="line">				StaticRegisterNatives##TClass, \</span><br><span class="line">				<span class="built_in"><span class="keyword">sizeof</span></span>(TClass), \</span><br><span class="line">				<span class="built_in"><span class="keyword">alignof</span></span>(TClass), \</span><br><span class="line">				(EClassFlags)TClass::StaticClassFlags, \</span><br><span class="line">				TClass::<span class="built_in">StaticClassCastFlags</span>(), \</span><br><span class="line">				TClass::<span class="built_in">StaticConfigName</span>(), \</span><br><span class="line">				(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br><span class="line">				&amp;TClass::AddReferencedObjects, \</span><br><span class="line">				&amp;TClass::Super::StaticClass, \</span><br><span class="line">				&amp;TClass::WithinClass::StaticClass \</span><br><span class="line">			); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="keyword">return</span> PrivateStaticClass; \</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>如<code>AMyActor</code>的<code>IMPLEMENT_CLASS(AMyActor,3240835608)</code>经过预处理之后为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">GetPrivateStaticClassBody</span>(</span><br><span class="line">    	<span class="built_in">StaticPackage</span>(), </span><br><span class="line">    	(TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), </span><br><span class="line">    	<span class="built_in"><span class="keyword">alignof</span></span>(AMyActor), </span><br><span class="line">    	(EClassFlags)AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::<span class="built_in">StaticClassCastFlags</span>(), </span><br><span class="line">    	AMyActor::<span class="built_in">StaticConfigName</span>(), </span><br><span class="line">    	(UClass::ClassConstructorType)InternalConstructor&lt;AMyActor&gt;, </span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;, </span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects, </span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>TClassCompiledInDefer&lt;TClass&gt;</code>这个模板类的构造函数中通过调用<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L643">UClassCompiledInDefer</a>将当前反射类的注册到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，它得到的是一个类型为<code>FFieldCompiledInInfo*</code>的数组，用于记录引擎中所有反射类的信息，用于在CoreUObjectModule启动时将UHT生成的这些反射信息在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a>函数中通过<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L745">UClassRegisterAllCompiledInClasses</a>将所有反射类的UClass构造出来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;UClassRegisterAllCompiledInClasses&quot;</span>);</span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = <span class="built_in">GetDeferredClassRegistration</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;<span class="built_in">Register</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.<span class="built_in">Add</span>(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.<span class="built_in">Empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.<span class="built_in">Broadcast</span>(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>TClassCompiledInDefer&lt;AMyActor&gt;</code>的<code>Register</code>函数就是调用<code>AMyActor::StaticClass</code>的，然后StaticClass中调用<code>GetPrivateStaticClass</code>，其中有一个static对象，就是当前类的UClass，所以它只会构造依次，使用<code>UXXXX::StaticClass</code>都是直接获得。</p>
<blockquote>
<p>注意：UClass的构造是跟着模块的启动创建的，所以之后当引擎启动到一个模块的时候它的UClass才被创建出来）。</p>
</blockquote>
<h3 id="非UCLASS的反射"><a href="#非UCLASS的反射" class="headerlink" title="非UCLASS的反射"></a>非UCLASS的反射</h3><p>有些继承自UObject的类是没有加UCLASS标记的，所以也不会包含<code>gen.cpp</code>和<code>generated.h</code>文件，但是UE也提供了非UCLASS的反射方法，类似于<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/Misc/TextBuffer.h#L14">UTextureBuffer</a>这个类。</p>
<p>在类内时添加<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a>宏用于手动添加，实现类似UHT生成<code>GENERATED_BODY</code>宏的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTextBuffer</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> UObject</span><br><span class="line">	, <span class="keyword">public</span> FOutputDevice</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</span>(UTextBuffer, UObject, <span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;/Script/CoreUObject&quot;</span>), CASTCLASS_None, COREUOBJECT_API)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a>可以处理类似<code>generated.h</code>的行为，但是<code>gen.cpp</code>里创建出<code>static TClassCompiledInDefer&lt;CLASS_NAME&gt;</code>的代码还没有，UE提供了另一个宏:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CORE_INTRINSIC_CLASS</span>(UTextBuffer, UObject, &#123; &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1731">IMPLEMENT_CORE_INTRINSIC_CLASS</a>，用来生成类似gen.cpp中的代码， 还可以通过宏的第三个参数来传入代码。</li>
</ul>
<p>虽然和<code>gen.cpp</code>里通过UHT生成的代码不同，但是统一使用<code>TClassCompiledInDefer&lt;TClass&gt;</code>和<code>FCompiledInDefer</code>来注册到引擎中。<br>这样就实现了可以不使用UCLASS标记也可以为继承自UObject的类生成反射信息。</p>
<h3 id="UClass的构造思路"><a href="#UClass的构造思路" class="headerlink" title="UClass的构造思路"></a>UClass的构造思路</h3><p>前面讲了这么多都是在分析UE创建UClass的代码，我想从UE的实现思路上分析一下设计过程。</p>
<ol>
<li>首先UHT通过分析代码创建出gen.cpp和generated.h中间记录着当前类的反射信息、类本身的反射信息、类中函数的反射信息、类数据成员的反射信息。</li>
<li>当前类的反射信息（类、成员函数、数据成员）等被统一存储在一个名为<code>Z_Construct_UClass_CLASSNAME_Statics</code>的结构中；</li>
<li>该结构通过<code>IMPLEMENT_CLASS</code>生成的代码将当前类添加到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>中。因为<strong>全局作用域static对象的构造时机</strong>是先于主函数的第一条语句的，所以当进入引擎逻辑的时候，引擎内置的模块中类的<code>TClassCompiledInDefer&lt;&gt;</code>都已经被创建完毕，在编辑器模式下， 因为不同的模块都是编译为DLL的，所以在加载模块的时候它们的static对象才会被创建。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>与上一步同样的手法，把类生成的反射信息通过<code>FCompiledInDefer</code>收集到<code>GetDeferredCompiledInRegistration()</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDefer <span class="title">Z_CompiledInDefer_UClass_AMyActor</span><span class="params">(Z_Construct_UClass_AMyActor, &amp;AMyActor::StaticClass, TEXT(<span class="string">&quot;/Script/MicroEnd_423&quot;</span>), TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>



<h4 id="引擎如何使用生成的反射信息"><a href="#引擎如何使用生成的反射信息" class="headerlink" title="引擎如何使用生成的反射信息"></a>引擎如何使用生成的反射信息</h4><p>在UHT生成反射的代码之后，引擎会根据这些代码生成UClass、UStruct、UEnum、UFunction和UProperty等。</p>
<p>它们都是在<code>ProcessNewlyLoadedUObjects</code>中被执行的，<strong>注意</strong>该函数会进来很多次，当每一个模块被加载的时候都会走一遍，因为在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">Obj.cpp</a>的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">InitUObject</a>函数中，把函数<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a>添加到了<code>FModuleManager::Get().OnProcessLoadedObjectsCallback()</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !USE_PER_MODULE_UOBJECT_BOOTSTRAP <span class="comment">// otherwise this is already done</span></span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">OnProcessLoadedObjectsCallback</span>().<span class="built_in">AddStatic</span>(ProcessNewlyLoadedUObjects);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>之所以</strong>要这么做，是因为UE的Module中都会有很多的反射类，但引擎一启动并不是所有的类在同一时刻都被加载了，因为模块有不同的加载时机，所以引擎中对于UClass的构造也不是一个一次性过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessNewlyLoadedUObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::UObject);</span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProcessNewlyLoadedUObjects&quot;</span>), STAT_ProcessNewlyLoadedUObjects, STATGROUP_ObjectVerbose);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UClassRegisterAllCompiledInClasses</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> TArray&lt;UClass* (*)()&gt;&amp; DeferredCompiledInRegistration = <span class="built_in">GetDeferredCompiledInRegistration</span>();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingStructRegistrant&gt;&amp; DeferredCompiledInStructRegistration = <span class="built_in">GetDeferredCompiledInStructRegistration</span>();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingEnumRegistrant&gt;&amp; DeferredCompiledInEnumRegistration = <span class="built_in">GetDeferredCompiledInEnumRegistration</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bNewUObjects = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">while</span>( GFirstPendingRegistrant || DeferredCompiledInRegistration.<span class="built_in">Num</span>() || DeferredCompiledInStructRegistration.<span class="built_in">Num</span>() || DeferredCompiledInEnumRegistration.<span class="built_in">Num</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		bNewUObjects = <span class="literal">true</span>;</span><br><span class="line">		<span class="built_in">UObjectProcessRegistrants</span>();</span><br><span class="line">		<span class="built_in">UObjectLoadAllCompiledInStructs</span>();</span><br><span class="line">		<span class="built_in">UObjectLoadAllCompiledInDefaultProperties</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="built_in">UClassReplaceHotReloadClasses</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bNewUObjects &amp;&amp; !GIsInitialLoad)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass::<span class="built_in">AssembleReferenceTokenStreams</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UClass构造的调用栈：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-uclass-register-all-compiled.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = <span class="built_in">GetDeferredClassRegistration</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;<span class="built_in">Register</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.<span class="built_in">Add</span>(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.<span class="built_in">Empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.<span class="built_in">Broadcast</span>(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在<code>UClassRegisterAllCompiledInClasses</code>只是去调用了每个反射类的StaticClass函数（<code>Class-&gt;Register()</code>内部是对类型的<code>StaticClass</code>的转发调用），在开启<code>WITH_HOT_RELOAD</code>的情况下也会把新的UClass给代理调用传递出去，然后把当前的数组置空。</p>
<p>之所以要置空，就是因为前面说的，UE的UClass构造是一个模块一个模块来执行的，当一个模块执行完毕之后就把当前模块注册到<code>GetDeferredClassRegistration()</code>里的元素置空，等着下个模块启动的时候（加载DLL时它们的static成员会构造然后注册到里面），再执行<code>LoadModuleWithFailureReason</code>就是又一遍循环。</p>
<p>在模块启动的时候会执行<code>LoadModuleWithFailureReason</code>里面调用了这个Delegate，所以每一个模块启动的时候都会执行<code>ProcessNewlyLoadedUObjects</code>，把自己当前模块中的UClass/UStruct/UEnum都构造出来。</p>
<h2 id="函数反射"><a href="#函数反射" class="headerlink" title="函数反射"></a>函数反射</h2><h3 id="UHT生成的反射信息"><a href="#UHT生成的反射信息" class="headerlink" title="UHT生成的反射信息"></a>UHT生成的反射信息</h3><p>在UE的代码中加了<code>UFUNCTION()</code>修饰后UHT就会为该函数生成反射代码。</p>
<p>每一个支持反射的函数UHT都会给它生成一个类和一个函数：<br>如在<code>AMyActor</code>这个类下有一个<code>ReflexFunc</code>的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UHT会生成这样命名规则的一个类和函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UHT为ReflexFunc生成的反射代码</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventReflexFunc_Parms</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		int32 InIval;</span><br><span class="line">		UObject* InObj;</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams NewProp_ReturnValue;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_InObj;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_InIval;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams FuncParams;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((MyActor_eventReflexFunc_Parms*)Obj)-&gt;ReturnValue = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue = &#123;</span><br><span class="line">	 <span class="string">&quot;ReturnValue&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000580</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">bool</span>),</span><br><span class="line">	 <span class="built_in"><span class="keyword">sizeof</span></span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	 &amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit,</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj = &#123;</span><br><span class="line">	 <span class="string">&quot;InObj&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Object,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in">STRUCT_OFFSET</span>(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InObj),</span><br><span class="line">	 Z_Construct_UClass_UObject_NoRegister,</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval = &#123;</span><br><span class="line">	 <span class="string">&quot;InIval&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="built_in">STRUCT_OFFSET</span>(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InIval),</span><br><span class="line">	 <span class="built_in">METADATA_PARAMS</span>(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;MyActor.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams = &#123; (UObject*(*)())Z_Construct_UClass_AMyActor,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="string">&quot;ReflexFunc&quot;</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	(EFunctionFlags)<span class="number">0x00020401</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="built_in">METADATA_PARAMS</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams,</span><br><span class="line">	<span class="built_in">UE_ARRAY_COUNT</span>(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams))</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过UHT生成的反射信息来构造出UFunction</span></span><br><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUFunction</span>(ReturnFunction, Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义的<code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code>类中包含了以下信息：</p>
<ol>
<li>存储函数的参数、返回值的结构体(POD)，注意该结构的声明顺序是按照函数参数的顺序+最后一个成员是函数返回值的方式排列。</li>
<li>函数参数、返回值的<code>F*PropertyParams</code>，用来给函数的每个参数以及返回值生成反射信息，用于构造出UProperty，static成员；</li>
<li>成员<code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于记录该函数的参数和返回值的类型为<code>FPropertyParamsBase</code>的static数据成员的地址。</li>
<li>成员<code>static const UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</code>，用于记录函数的元数据。如所属文件、Category、注释等等。</li>
<li>成员<code>static const UE4CodeGen_Private::FFunctionParams FuncParams;</code>用于记录当前函数的名字、Flag、参数的<code>F*PropertyParams</code>、参数数量，参数的结构大小等等，用于通过它来创建出<code>UFunction*</code>。</li>
<li>至于生成的<code>SetBit</code>d的函数的作用，在上面属性反射的部分已经讲到了。</li>
</ol>
<p><code>UE4CodeGen_Private::FFunctionParams</code>结构声明为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FFunctionParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();</span><br><span class="line">	UFunction*                        (*SuperFunc)();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         OwningClassName;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         DelegateName;</span><br><span class="line">	SIZE_T                              StructureSize;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	EFunctionFlags                      FunctionFlags;</span><br><span class="line">	uint16                              RPCId;</span><br><span class="line">	uint16                              RPCResponseId;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UHT生成的<code>Z_Construct_UFunction_AMyActor_ReflexFunc</code>函数做了以下事情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::<span class="built_in">ConstructUFunction</span>(ReturnFunction, Z_Construct_UFunction_AMyActor_Add_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据定义的<code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code>结构中的<code>FuncParams</code>成员来创建出真正的<code>UFunction</code>对象。</p>
<p>最后，<code>Z_Construct_UFunction_AMyActor_ReflexFunc</code>这个函数会被注册到当前类反射数据的<code>FuncInfo</code>中。</p>
<h3 id="Thunk函数"><a href="#Thunk函数" class="headerlink" title="Thunk函数"></a>Thunk函数</h3><p>UE会为标记为<code>UFUNCTION</code>的Native函数生成对应的Thunk函数(<code>BlueprintImplementableEvent</code>的函数不会)。如下列函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的Thunk函数形式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="built_in">DECLARE_FUNCTION</span>(execReflexFunc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="built_in">DEFINE_FUNCTION</span>(AMyActor::execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">	<span class="built_in">P_GET_OBJECT</span>(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">ReflexFunc</span>(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_FUNCTION</code>/<code>DEFINE_FUNCTION</code>这两个宏是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L632">CoreUObject/Public/UObject/ObjectMacros.h</a>中的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This macro is used to declare a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_FUNCTION(func) static void func( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This macro is used to define a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span><br></pre></td></tr></table></figure>

<p>展开这两个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span>;</span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">P_GET_PROPERTY</span>(FIntProperty,Z_Param_InIval);</span><br><span class="line">	<span class="built_in">P_GET_OBJECT</span>(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;<span class="built_in">ReflexFunc</span>(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT为每个反射函数生成的都是一个参数一致的static成员函数，接收通用的参数，就可以用来处理所有的函数调用。</p>
<p>Thunk函数中用到的这些宏：</p>
<p>RESULT_DECL(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Script.h#L68">CoreUObject/Public/UObject/Script.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Blueprint VM intrinsic return value declaration.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_PARAM Z_Param__Result</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_DECL void*const RESULT_PARAM</span></span><br></pre></td></tr></table></figure>

<p>其他的形如<code>P_GET_PROPERTY</code>之类的宏，都是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/ScriptMacros.h">CoreUObject/Public/UObject/ScriptMacros.h</a>文件中的，作用就是从栈上操作参数（因为Thunk函数是通用的参数，所以要从通用的参数中获取到每个函数具体的参数，UE提供这些宏来做这些事情）。</p>
<p>这些Thunk函数通过UHT生成的<code>StaticRegisterNatives*</code>函数注册到UClass中（在<code>GetPrivateStaticClass</code>把该函数指针传递了进去）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;BPNativeEvent&quot;</span>, &amp;AMyActor::execBPNativeEvent &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ReflexFunc&quot;</span>, &amp;AMyActor::execReflexFunc &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">UE_ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE不会为<code>BlueprintImplementableEvent</code>生成Thunk函数，但是会为它生成函数的反射信息，所以也可以通过反射的信息来调用<code>BlueprintImplementableEvent</code>的函数。</p>
<p>因为`BlueprintImplementatableEventd的函数是C++提供原型不提供实现，让蓝图来进行覆写的，所以它不使用Thunk的形式调用（应该执行字节码的方式，这个暂时还没看到，有时间再来分析）。</p>
<h3 id="Custom-Thunk"><a href="#Custom-Thunk" class="headerlink" title="Custom Thunk"></a>Custom Thunk</h3><p>前面讲到当给函数加了<code>UFUNCTION</code>标记时UHT会给我们生成对应的Thunk函数，但是有些情况下需要我们自己来写Thunk的函数，如<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/KismetArrayLibrary.h">UKismetArrayLibrary</a>中的对Array进行操作的函数，或者<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/DataTableFunctionLibrary.h#L51">UDataTableFunctionLibrary</a>中的<code>GetDataTableRowFromName</code>函数。</p>
<p>UE提供了让我们自己实现Thunk函数的方法，在<code>UFUNCTION</code>中添加<code>CustomThunk</code>标记：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(CustomThunk)</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br></pre></td></tr></table></figure>

<p>这样UHT就不会为这个函数生成出它的Thunk函数，这种情况下就需要自己提供了。自己写的方式和UHT生成的代码一样，可以使用<code>DECLARE_FUNCTION</code>或者<code>DEFINE_FUNCTION</code>（手动写按照Thunk函数的签名规则也是没问题的）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_FUNCTION</span>(execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行时访问反射函数"><a href="#运行时访问反射函数" class="headerlink" title="运行时访问反射函数"></a>运行时访问反射函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UFunction* FuncProperty = *It;</span><br><span class="line">	<span class="keyword">if</span> (FuncProperty-&gt;<span class="built_in">GetName</span>() == <span class="built_in">TEXT</span>(<span class="string">&quot;GetIval&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">CallParam</span></span></span><br><span class="line"><span class="class">		&#123;</span></span><br><span class="line">			int32 ival;</span><br><span class="line">		&#125;CallParamIns;</span><br><span class="line">		InActor-&gt;<span class="built_in">ProcessEvent</span>(FuncProperty, &amp;CallParamIns);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过ProcessEvent来调用，第二个参数传递进去参数和返回值的结构。</p>
<p>每个被反射的函数UHT都会给它生成一个<strong>参数的结构体</strong>，其排列的顺序为：函数参数依次排列，最后一个成员为返回值。如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32 <span class="title">Add</span><span class="params">(int32 R, int32 L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UHT为其生成的参数结构为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventAdd_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	int32 R;</span><br><span class="line">	int32 L;</span><br><span class="line">	int32 ReturnValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在通过UFunction*来调用函数时，需要把这个布局的结构传递作为传递给函数的参数以及接收返回值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">  UFunction* Property = *It;</span><br><span class="line">  <span class="keyword">if</span> (Property-&gt;<span class="built_in">GetName</span>() == <span class="built_in">TEXT</span>(<span class="string">&quot;Add&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AddFuncCallParam</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      int32 R;</span><br><span class="line">      int32 L;</span><br><span class="line">      int32 RetValue;</span><br><span class="line">    &#125;CallParamIns;</span><br><span class="line">    CallParamIns.R = <span class="number">123</span>;</span><br><span class="line">    CallParamIns.L = <span class="number">456</span>;</span><br><span class="line">    InActor-&gt;<span class="built_in">ProcessEvent</span>(Property, &amp;CallParamIns);</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;UFunction:%s value:%d&quot;</span>), *Property-&gt;<span class="built_in">GetName</span>(), CallParamIns.RetValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-reflex/ue4-call-ufunction-receive-ret-value.webp"></p>
<p>可以通过<code>UFunction</code>拿到当前函数的参数的结构的大小<code>UFunction::ParmsSize</code>，在运行时动态访问的话可以通过这个结构大小分配出一块内存，然后用UProperty对这块内存进行访问，因为通过UProperty访问成员其实本质上也是通过该成员在类内的偏移来做的（对数据成员获取成员指针得到的是一个相对于对象基址的偏移值）。</p>
<h3 id="坑点-1"><a href="#坑点-1" class="headerlink" title="坑点"></a>坑点</h3><p>注意：通过UE的UFunction调用并不能正确地处理引用类型，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">int32&amp; <span class="title">Add</span><span class="params">(int32 R, int32&amp; L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个函数生成的反射代码和非引用的一摸一样（对L参数生成的UProperty的Flag会多一个<code>CPF_OutParm</code>，返回值的UProperty还具有<code>CPF_ReturnParm</code>）。<br>这会造成通过<code>UFunction*</code>调用传递的参数和想要获取的返回值都只是一份拷贝（因为本来调用时的参数传递到ProcessEvent之前都会被赋值到UHT创建出来的参数结构），不能再后续的流程中对得到的结果进行赋值。</p>
<p><strong>而且</strong>，通过遍历UFunction得到的参数和返回值<code>UProperty</code>，其中的Offset值是相对于UHT生成的参数结构。</p>
<p>在获取蓝图或者C++中具有多个返回值UFunction的时候，因为UE的具有多个返回值的机制是通过传递进来引用实现的，所以不能够只是通过检测UProperty是否具有<code>CPF_ReturnValue</code>来检测，因为包含该flag的UProperty只有一个，还需要检测<code>CPF_OutParam</code>来判断是都是通过引用方式传递的“返回值”。</p>
<h2 id="属性反射"><a href="#属性反射" class="headerlink" title="属性反射"></a>属性反射</h2><p>当在UCLASS类中给一个属性添加<code>UPROPERTY</code>标记时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MICROEND_423_API</span> <span class="title">AMyActor</span> :</span> <span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginPlay</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">// Called every frame</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Tick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">			int32 ival;</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<p>会生成反射代码，生成反射代码的代码是在UHT中的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123;</span><br><span class="line">  <span class="string">&quot;ival&quot;</span>,</span><br><span class="line">  <span class="literal">nullptr</span>,</span><br><span class="line">  (EPropertyFlags) <span class="number">0x0010000000000001</span>,</span><br><span class="line">  UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">  RF_Public | RF_Transient | RF_MarkAsNative,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  <span class="built_in">STRUCT_OFFSET</span>(AMyActor, ival),</span><br><span class="line">  <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先<code>const UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival</code>是创建出一个结构，用于记录当前属性的信息，比如变量名、相对于对象起始地址的偏移。</p>
<blockquote>
<p>注意<code>UE4CodeGen_Private::FIntPropertyParams</code>这样的类型都是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a>中的，对于基础类型的属性（如int8/int32/float/array/map）等使用的都是<code>FGenericPropertyParams</code>。</p>
</blockquote>
<h3 id="F-PropertyParams"><a href="#F-PropertyParams" class="headerlink" title="F*PropertyParams"></a>F*PropertyParams</h3><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a>文件中，引擎里定义了很多的<code>F*PropertyParams</code>，但是他们的数据结构基本相同（但是他们并没有继承关系），都是POD的类型，每个数据依次排列，而且不同类型的Params尽量都保持了一致的顺序。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPropertyParams</span> // :</span> FPropertyParamsBaseWithOffset</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags    PropertyFlags;</span><br><span class="line">	EPropertyGenFlags Flags;</span><br><span class="line">	EObjectFlags      ObjectFlags;</span><br><span class="line">	int32             ArrayDim;</span><br><span class="line">	int32             Offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam* Z_Construct_UClass_;</span><br><span class="line">	int32                     NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个一个来分析它的参数。</p>
<h4 id="NameUTF8"><a href="#NameUTF8" class="headerlink" title="NameUTF8"></a>NameUTF8</h4><p>NameUTF8是属性的UTF8的名字，在运行时可以通过<code>UProperty</code>的<code>GetNameCPP</code>来获取。</p>
<h4 id="RepNotifyFuncUTF8"><a href="#RepNotifyFuncUTF8" class="headerlink" title="RepNotifyFuncUTF8"></a>RepNotifyFuncUTF8</h4><p>RepNotifyFuncUTF8是在当前属性绑定的修改之后的函数名字。</p>
<p>如果属性是这样声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere,ReplicatedUsing=OnRep_Replicatedival)</span><br><span class="line">	int32 ival;</span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRep_Replicatedival</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这样生成的反射代码就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="string">&quot;OnRep_Replicatedival&quot;</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000100000021</span>,</span><br><span class="line">    UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="built_in">STRUCT_OFFSET</span>(AMyActor, ival),</span><br><span class="line">  <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData,<span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为<code>OnRep_Replicatedival</code>也是UFUNCTION的函数，所以可以通过反射来访问。</p>
<h4 id="PropertyFlags"><a href="#PropertyFlags" class="headerlink" title="PropertyFlags"></a>PropertyFlags</h4><p><code>PropertyFlags</code>是一个类型为<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L361">EPropertyFlags</a>的枚举，枚举值按照位排列，根据在UPROPERTY中的标记来按照位或来记录当前属性包含的标记信息。<br>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">UnrealHeaderTool/Private/CodeGenerator.cpp</a>中生成代码时会根据当前属性的flag和<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L442">CPF_ComputedFlags</a>做位运算：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// All the properties that should never be loaded or saved</span></span><br><span class="line"><span class="comment">#define CPF_ComputedFlags			(CPF_IsPlainOldData | CPF_NoDestructor | CPF_ZeroConstructor | CPF_HasGetValueTypeHash)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0x0000000040000000 CPF_IsPlainOldData </span></span><br><span class="line"><span class="comment">0x0000001000000000 CPF_NoDestructor </span></span><br><span class="line"><span class="comment">0x0000000000000200 CPF_ZeroConstructor </span></span><br><span class="line"><span class="comment">0x0008000000000000 CPF_HasGetValueTypeHash</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EPropertyFlags PropFlags = Prop-&gt;PropertyFlags &amp; ~CPF_ComputedFlags;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过<code>UProperty</code>的<code>HasAnyPropertyFlags</code>函数来检测是否具有特定的flag。</p>
<p>一般情况下，可以通过<code>UProperty</code>来获取到该参数的标记属性，比如当通过<code>UFunction</code>获取函数的参数时，可以区分哪个UProperty是输入参数、哪个是返回值。</p>
<h4 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h4><p>第四个参数<code>Flags</code>是类型为<code>UE4CodeGen_Private::EPropertyGenFlags</code>是一个枚举，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2231">UObject/UObjectGlobals.h</a>中，标记了当前Property的类型。</p>
<h4 id="ObjectFlags"><a href="#ObjectFlags" class="headerlink" title="ObjectFlags"></a>ObjectFlags</h4><p>ObjectFlags是<code>EObjectFlags</code>类型的枚举，其枚举值也是按照位来划分的。定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L474">CoreUObject/Public/UObject/ObjectMacros.h</a></p>
<p>UHT生成这部分代码在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TCHAR*   FPropertyObjectFlags = FClass::<span class="built_in">IsOwnedByDynamicType</span>(Prop) ? <span class="built_in">TEXT</span>(<span class="string">&quot;RF_Public|RF_Transient&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;RF_Public|RF_Transient|RF_MarkAsNative&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>通过<code>FClass::IsOwnedByDynamicType</code>函数来检测是否为PROPERTY添加<code>RF_MarkAsNative</code>的flag。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Public/ParserClass.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Helper function that checks if the field is a dynamic type (can be constructed post-startup) */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsDynamic</span><span class="params">(<span class="keyword">const</span> T* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Field-&gt;<span class="built_in">HasMetaData</span>(NAME_ReplaceConverted);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Private/ParserClass.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> UField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> UField* OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(Field-&gt;<span class="built_in">GetOuter</span>()); OuterField; OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(OuterField-&gt;<span class="built_in">GetOuter</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsDynamic</span>(OuterField))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> FField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (FFieldVariant Owner = Field-&gt;<span class="built_in">GetOwnerVariant</span>(); Owner.<span class="built_in">IsValid</span>(); Owner = Owner.<span class="built_in">GetOwnerVariant</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Owner.<span class="built_in">IsUObject</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">IsOwnedByDynamicType</span>(Cast&lt;<span class="keyword">const</span> UField&gt;(Owner.<span class="built_in">ToUObject</span>()));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsDynamic</span>(Owner.<span class="built_in">ToField</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用<code>UField</code>的<code>HasMetaData</code>检测是否具有<code>TEXT(&quot;ReplaceConverted&quot;)</code>的元数据（该元数据就是后面要讲到的Metadata）。</p>
<h4 id="ArrayDim"><a href="#ArrayDim" class="headerlink" title="ArrayDim"></a>ArrayDim</h4><p>ArrayDim用于记录当前属性的元素数量，当只是声明一个单个对象时，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">float</span> fval;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	FString StrVal = <span class="built_in">TEXT</span>(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	TSubclassOf&lt;UObject&gt; ClassVal;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture2D;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	FResultDyDlg ResultDlg;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	UMySceneComponent* SceneComp;</span><br></pre></td></tr></table></figure>
<p>这些属性所有的<code>ArrayDim</code>均为1.</p>
<p>但是当使用C++原生数组时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	int32 iArray[<span class="number">12</span>];</span><br></pre></td></tr></table></figure>
<p>它的ArrayDim就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CPP_ARRAY_DIM</span>(iArray, AMyActor)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CPP_ARRAY_DIM</a>这个宏定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CoreUObject/Public/UObject/UnrealType.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** helper to calculate an array&#x27;s dimensions **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPP_ARRAY_DIM(ArrayName, ClassName) \</span></span><br><span class="line">	(<span class="built_in"><span class="keyword">sizeof</span></span>(((ClassName*)<span class="number">0</span>)-&gt;ArrayName) / <span class="built_in"><span class="keyword">sizeof</span></span>(((ClassName*)<span class="number">0</span>)-&gt;ArrayName[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<p>就是用来计算数组内的元素数量的，普通的非数组属性其值为1，可以当作是元素数量为1的数组。</p>
<h4 id="Offset"><a href="#Offset" class="headerlink" title="Offset"></a>Offset</h4><p><code>STRUCT_OFFSET</code>宏的作用为得到数据成员相对于类起始地址的偏移，通过获取<strong>数据成员指针</strong>得到，类型为<code>size_t</code>。</p>
<p>然后当前类中的反射属性都会被添加到<code>PropPointers</code>中，也是UHT生成的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::PropPointers[] = &#123;</span><br><span class="line">		(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UClass_AMyActor_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过<code>UProperty</code>得到指定的对象值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		UProperty* Property = *It;</span><br><span class="line">		<span class="keyword">if</span> (Property-&gt;<span class="built_in">GetNameCPP</span>() == <span class="built_in">FString</span>(<span class="string">&quot;ival&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor);</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Property:%s value:%d&quot;</span>), *Property-&gt;<span class="built_in">GetNameCPP</span>(),i32);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>UProperty</code>中的<code>ContainerPtrToValuePtr</code>系列函数都会转发到<code>ContainerVoidPtrToValuePtrInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span>* <span class="title">ContainerVoidPtrToValuePtrInternal</span><span class="params">(<span class="keyword">void</span>* ContainerPtr, int32 ArrayIndex)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(ArrayIndex &lt; ArrayDim);</span><br><span class="line">	<span class="built_in">check</span>(ContainerPtr);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// in the future, these checks will be tested if the property is NOT relative to a UClass</span></span><br><span class="line">		<span class="built_in">check</span>(!Cast&lt;UClass&gt;(<span class="built_in">GetOuter</span>())); <span class="comment">// Check we are _not_ calling this on a direct child property of a UClass, you should pass in a UObject* in that case</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (uint8*)ContainerPtr + Offset_Internal + ElementSize * ArrayIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是拿到UObject的指针，然后偏移到指定位置（第二个参数用在对象是数组的情况，用来访问指定下标的元素，默认情况下访问下标为0）。</p>
<h4 id="Z-Construct-UClass-和NumMetaData"><a href="#Z-Construct-UClass-和NumMetaData" class="headerlink" title="Z_Construct_UClass_和NumMetaData"></a>Z_Construct_UClass_和NumMetaData</h4><p>它们的类型分别为<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2285">FMetaDataPairParam</a>和<code>int32</code>，用来记录当前反射属性的元数据：比如属性的<code>Category</code>、注释、所属的文件、<code>ToolTip</code>信息等等，比如在C++函数上添加的注释能够在编辑器蓝图中看到注释的信息，都是靠解析这些元数据来实现的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FMetaDataPairParam</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* NameUTF8;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* ValueUTF8;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这两个参数通过<code>METADATA_PARAMS</code>包裹，用于处理<code>WITH_MATEDATA</code>的不同情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// METADATA_PARAMS(x, y) expands to x, y, if WITH_METADATA is set, otherwise expands to nothing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y) x, y,</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>把UHT生成的代码宏展开为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br></pre></td></tr></table></figure>
<p>就是把<code>UE4CodeGen_Private::FMetaDataPairParam</code>这个类型的数组和数组元素个数传递给<code>F*PropertyParams</code>，实现在<code>WITH_METADATA</code>的情况下处理是否具有Metadata的情况。</p>
<h3 id="运行时的Property"><a href="#运行时的Property" class="headerlink" title="运行时的Property"></a>运行时的Property</h3><p>引擎中通过<code>UE4CodeGen_Private::ConstructFProperty</code>来创建出真正Runtime使用的<code>UProperty</code>(4.25之后是<code>FProperty</code>)，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectGlobals.cpp#L3900">UObject/UObjectGlobals.cpp</a>。</p>
<h3 id="FBoolPropertyParams特例"><a href="#FBoolPropertyParams特例" class="headerlink" title="FBoolPropertyParams特例"></a>FBoolPropertyParams特例</h3><p>当一个反射的数据是bool类型时，引擎产生的反射信息中有一个比较有意思的特例，<code>FBoolPropertyParams</code>，可以看一下它的结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FBoolPropertyParams</span> // :</span> FPropertyParamsBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*      NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*         RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags      PropertyFlags;</span><br><span class="line">	EPropertyGenFlags   Flags;</span><br><span class="line">	EObjectFlags     ObjectFlags;</span><br><span class="line">	int32            ArrayDim;</span><br><span class="line">	uint32           ElementSize;</span><br><span class="line">	SIZE_T           SizeOfOuter;</span><br><span class="line">	<span class="built_in"><span class="keyword">void</span></span>           (*SetBitFunc)(<span class="keyword">void</span>* Obj);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它具有一个<code>SetBitFunc</code>的函数指针。看一下生成的反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// source code </span></span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((AMyActor*)Obj)-&gt;bEnabled = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled = &#123; <span class="string">&quot;bEnabled&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000000</span>, UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool, RF_Public|RF_Transient|RF_MarkAsNative, <span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">bool</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), &amp;Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit, <span class="built_in">METADATA_PARAMS</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData, <span class="built_in">ARRAY_COUNT</span>(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData)) &#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：其中的关键是，UHT给该属性生成了一个<code>SetBit</code>的函数，why？其他类型的属性都可以通过<code>STRUCT_OFFSET</code>来获取该成员的类内偏移，为什么bool就不行了呢？</p>
<p>这是因为C++有位域(<code>bit-field</code>)这个概念，一个bool可能只占1bit，而不是1byte，但这不是真正的原因。</p>
<p>真正的原因是，C++标准规定了不能对位域进行取地址操作！前面已经提到了<code>STRUCT_OFFSET</code>实际上是获取到数据成员的指针，得到的是类内偏移，但是因为C++的不能对位域取地址的规定，<code>STRUCT_OFFSET</code>无法用在位域的成员上的。</p>
<blockquote>
<p>[IOS/IEC 14882:2014 §9.6]The address-of operator &amp; shall not be applied to a bit-ﬁeld, so there are no pointers to bit-ﬁelds.</p>
</blockquote>
<p>那么这又是因为什么呢？因为系统编址的最小单位是字节而不是位，所以没办法取到1字节零几位的地址。也就决定了不能对位域的数据成员取地址。</p>
<p>UE内其实大量用到了bool使用位域的方式来声明（如果不使用位域，bool类型的空间浪费率达到87.5% :)），所以UE就生成了一个函数来为以位域方式声明的成员设置值。</p>
<p><strong>但是！</strong>UE不支持直接对加了UPROPERTY的bool使用位域：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>编译时会有下列错误：</p>
<blockquote>
<p>LogCompile: Error: bool bitfields are not supported.</p>
</blockquote>
<p>要写成下列方式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">	uint8 bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>使用这种方式和使用<code>bool bEnabled;</code>方式生成的反射代码一模一样，所以，UE之所以会生成一个函数来设置bool的值，是因为既要支持原生bool，也要支持位域。</p>
<h3 id="通过UProperty获取值"><a href="#通过UProperty获取值" class="headerlink" title="通过UProperty获取值"></a>通过UProperty获取值</h3><p>如果我知道某个类的对象内有一个属性名字，那么怎么能够得到它的值呢？这个可以基于UE的属性反射来实现：</p>
<p>首先通过<code>TFieldIterator</code>可以遍历该对象的UProperty：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; <span class="built_in">It</span>(InActor-&gt;<span class="built_in">GetClass</span>()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UProperty* Property = *It;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以根据得到的Property来判读名字：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Property-&gt;<span class="built_in">GetNameCPP</span>() == <span class="built_in">FString</span>(<span class="string">&quot;ival&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>检测是指定名字的Property后可以通过<code>UProperty</code>上的<code>ContainerPtrToValuePtr</code>函数来获取对象内该属性的指针：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor)</span><br></pre></td></tr></table></figure>
<p>前面讲到过，UPropery里存储Offdet值就是当前属性相对于对象起始地址的偏移。而ContainerPtrToValuePtr函数所做的就是得到当前对象偏移Offset的地址然后做了类型转换。</p>
<h3 id="Property的Flag"><a href="#Property的Flag" class="headerlink" title="Property的Flag"></a>Property的Flag</h3><p>通过上面的分析，可以看到<code>UPROPERTY</code>添加的标记，如<code>EditAnywhere</code>等，会给指定的Property生成FLAG存储在<code>F*PropertyParams</code>结构的第三个参数中，是位描述的。</p>
<p>可选值为<code>EPropertyFlags</code>枚举值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flags associated with each property in a class, overriding the</span></span><br><span class="line"><span class="comment"> * property&#x27;s default behavior.</span></span><br><span class="line"><span class="comment"> * @warning When adding one here, please update ParsePropertyFlags()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EPropertyFlags</span> :</span> uint64</span><br><span class="line">&#123;</span><br><span class="line">	CPF_None = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">	CPF_Edit							= <span class="number">0x0000000000000001</span>,	<span class="comment">///&lt; Property is user-settable in the editor.</span></span><br><span class="line">	CPF_ConstParm						= <span class="number">0x0000000000000002</span>,	<span class="comment">///&lt; This is a constant function parameter</span></span><br><span class="line">	CPF_BlueprintVisible				= <span class="number">0x0000000000000004</span>,	<span class="comment">///&lt; This property can be read by blueprint code</span></span><br><span class="line">	CPF_ExportObject					= <span class="number">0x0000000000000008</span>,	<span class="comment">///&lt; Object can be exported with actor.</span></span><br><span class="line">	CPF_BlueprintReadOnly				= <span class="number">0x0000000000000010</span>,	<span class="comment">///&lt; This property cannot be modified by blueprint code</span></span><br><span class="line">	CPF_Net								= <span class="number">0x0000000000000020</span>,	<span class="comment">///&lt; Property is relevant to network replication.</span></span><br><span class="line">	CPF_EditFixedSize					= <span class="number">0x0000000000000040</span>,	<span class="comment">///&lt; Indicates that elements of an array can be modified, but its size cannot be changed.</span></span><br><span class="line">	CPF_Parm							= <span class="number">0x0000000000000080</span>,	<span class="comment">///&lt; Function/When call parameter.</span></span><br><span class="line">	CPF_OutParm							= <span class="number">0x0000000000000100</span>,	<span class="comment">///&lt; Value is copied out after function call.</span></span><br><span class="line">	CPF_ZeroConstructor					= <span class="number">0x0000000000000200</span>,	<span class="comment">///&lt; memset is fine for construction</span></span><br><span class="line">	CPF_ReturnParm						= <span class="number">0x0000000000000400</span>,	<span class="comment">///&lt; Return value.</span></span><br><span class="line">	CPF_DisableEditOnTemplate			= <span class="number">0x0000000000000800</span>,	<span class="comment">///&lt; Disable editing of this property on an archetype/sub-blueprint</span></span><br><span class="line">	<span class="comment">//CPF_      						= 0x0000000000001000,	///&lt; </span></span><br><span class="line">	CPF_Transient   					= <span class="number">0x0000000000002000</span>,	<span class="comment">///&lt; Property is transient: shouldn&#x27;t be saved or loaded, except for Blueprint CDOs.</span></span><br><span class="line">	CPF_Config      					= <span class="number">0x0000000000004000</span>,	<span class="comment">///&lt; Property should be loaded/saved as permanent profile.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000008000,	///&lt; </span></span><br><span class="line">	CPF_DisableEditOnInstance			= <span class="number">0x0000000000010000</span>,	<span class="comment">///&lt; Disable editing on an instance of this class</span></span><br><span class="line">	CPF_EditConst   					= <span class="number">0x0000000000020000</span>,	<span class="comment">///&lt; Property is uneditable in the editor.</span></span><br><span class="line">	CPF_GlobalConfig					= <span class="number">0x0000000000040000</span>,	<span class="comment">///&lt; Load config from base class, not subclass.</span></span><br><span class="line">	CPF_InstancedReference				= <span class="number">0x0000000000080000</span>,	<span class="comment">///&lt; Property is a component references.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000100000,	///&lt;</span></span><br><span class="line">	CPF_DuplicateTransient				= <span class="number">0x0000000000200000</span>,	<span class="comment">///&lt; Property should always be reset to the default value during any type of duplication (copy/paste, binary duplication, etc.)</span></span><br><span class="line">	CPF_SubobjectReference				= <span class="number">0x0000000000400000</span>,	<span class="comment">///&lt; Property contains subobject references (TSubobjectPtr)</span></span><br><span class="line">	<span class="comment">//CPF_    							= 0x0000000000800000,	///&lt; </span></span><br><span class="line">	CPF_SaveGame						= <span class="number">0x0000000001000000</span>,	<span class="comment">///&lt; Property should be serialized for save games, this is only checked for game-specific archives with ArIsSaveGame</span></span><br><span class="line">	CPF_NoClear							= <span class="number">0x0000000002000000</span>,	<span class="comment">///&lt; Hide clear (and browse) button.</span></span><br><span class="line">	<span class="comment">//CPF_  							= 0x0000000004000000,	///&lt;</span></span><br><span class="line">	CPF_ReferenceParm					= <span class="number">0x0000000008000000</span>,	<span class="comment">///&lt; Value is passed by reference; CPF_OutParam and CPF_Param should also be set.</span></span><br><span class="line">	CPF_BlueprintAssignable				= <span class="number">0x0000000010000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for assigning in blueprint code</span></span><br><span class="line">	CPF_Deprecated  					= <span class="number">0x0000000020000000</span>,	<span class="comment">///&lt; Property is deprecated.  Read it from an archive, but don&#x27;t save it.</span></span><br><span class="line">	CPF_IsPlainOldData					= <span class="number">0x0000000040000000</span>,	<span class="comment">///&lt; If this is set, then the property can be memcopied instead of CopyCompleteValue / CopySingleValue</span></span><br><span class="line">	CPF_RepSkip							= <span class="number">0x0000000080000000</span>,	<span class="comment">///&lt; Not replicated. For non replicated properties in replicated structs </span></span><br><span class="line">	CPF_RepNotify						= <span class="number">0x0000000100000000</span>,	<span class="comment">///&lt; Notify actors when a property is replicated</span></span><br><span class="line">	CPF_Interp							= <span class="number">0x0000000200000000</span>,	<span class="comment">///&lt; interpolatable property for use with matinee</span></span><br><span class="line">	CPF_NonTransactional				= <span class="number">0x0000000400000000</span>,	<span class="comment">///&lt; Property isn&#x27;t transacted</span></span><br><span class="line">	CPF_EditorOnly						= <span class="number">0x0000000800000000</span>,	<span class="comment">///&lt; Property should only be loaded in the editor</span></span><br><span class="line">	CPF_NoDestructor					= <span class="number">0x0000001000000000</span>,	<span class="comment">///&lt; No destructor</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000002000000000,	///&lt;</span></span><br><span class="line">	CPF_AutoWeak						= <span class="number">0x0000004000000000</span>,	<span class="comment">///&lt; Only used for weak pointers, means the export type is autoweak</span></span><br><span class="line">	CPF_ContainsInstancedReference		= <span class="number">0x0000008000000000</span>,	<span class="comment">///&lt; Property contains component references.</span></span><br><span class="line">	CPF_AssetRegistrySearchable			= <span class="number">0x0000010000000000</span>,	<span class="comment">///&lt; asset instances will add properties with this flag to the asset registry automatically</span></span><br><span class="line">	CPF_SimpleDisplay					= <span class="number">0x0000020000000000</span>,	<span class="comment">///&lt; The property is visible by default in the editor details view</span></span><br><span class="line">	CPF_AdvancedDisplay					= <span class="number">0x0000040000000000</span>,	<span class="comment">///&lt; The property is advanced and not visible by default in the editor details view</span></span><br><span class="line">	CPF_Protected						= <span class="number">0x0000080000000000</span>,	<span class="comment">///&lt; property is protected from the perspective of script</span></span><br><span class="line">	CPF_BlueprintCallable				= <span class="number">0x0000100000000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for calling in blueprint code</span></span><br><span class="line">	CPF_BlueprintAuthorityOnly			= <span class="number">0x0000200000000000</span>,	<span class="comment">///&lt; MC Delegates only.  This delegate accepts (only in blueprint) only events with BlueprintAuthorityOnly.</span></span><br><span class="line">	CPF_TextExportTransient				= <span class="number">0x0000400000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be exported to text format (e.g. copy/paste)</span></span><br><span class="line">	CPF_NonPIEDuplicateTransient		= <span class="number">0x0000800000000000</span>,	<span class="comment">///&lt; Property should only be copied in PIE</span></span><br><span class="line">	CPF_ExposeOnSpawn					= <span class="number">0x0001000000000000</span>,	<span class="comment">///&lt; Property is exposed on spawn</span></span><br><span class="line">	CPF_PersistentInstance				= <span class="number">0x0002000000000000</span>,	<span class="comment">///&lt; A object referenced by the property is duplicated like a component. (Each actor should have an own instance.)</span></span><br><span class="line">	CPF_UObjectWrapper					= <span class="number">0x0004000000000000</span>,	<span class="comment">///&lt; Property was parsed as a wrapper class like TSubclassOf&lt;T&gt;, FScriptInterface etc., rather than a USomething*</span></span><br><span class="line">	CPF_HasGetValueTypeHash				= <span class="number">0x0008000000000000</span>,	<span class="comment">///&lt; This property can generate a meaningful hash value.</span></span><br><span class="line">	CPF_NativeAccessSpecifierPublic		= <span class="number">0x0010000000000000</span>,	<span class="comment">///&lt; Public native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierProtected	= <span class="number">0x0020000000000000</span>,	<span class="comment">///&lt; Protected native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierPrivate	= <span class="number">0x0040000000000000</span>,	<span class="comment">///&lt; Private native access specifier</span></span><br><span class="line">	CPF_SkipSerialization				= <span class="number">0x0080000000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be serialized, can still be exported to text</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="StaticClass和GetClass的区别"><a href="#StaticClass和GetClass的区别" class="headerlink" title="StaticClass和GetClass的区别"></a>StaticClass和GetClass的区别</h2><p><code>StaticClass</code>是继承自UObject类的static函数，<code>GetClass</code>是<code>UObjectBase</code>的成员函数。</p>
<p><code>UObjectBase</code>的<code>GetClass</code>获取到的UClass就是在NewObject时传递进来的UClass.（代码在<code>UObject\UObjectGlobal.cpp</code>中）</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-static-class-and-getclass-difference.webp"></p>
<p>用途不一样，<code>StaticClass</code>是在获取具体类型的UClass，而<code>GetClass</code>是获取到当前对象的真实UClass。</p>
<h2 id="UObject的FObjectInitializer构造函数的调用"><a href="#UObject的FObjectInitializer构造函数的调用" class="headerlink" title="UObject的FObjectInitializer构造函数的调用"></a>UObject的FObjectInitializer构造函数的调用</h2><blockquote>
<p>注意：只有GENERATER_UCLASS_BODY才可以实现<code>FObjectInitializer</code>的构造函数。</p>
</blockquote>
<p>在继承自UObject的类中，都可以自己写一个接收<code>const FObjectInitializer&amp;</code>参数的构造函数，在创建对象时会被调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UMyObject::<span class="built_in">UMyObject</span>(<span class="keyword">const</span> FObjectInitializer&amp; Initializer)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在类中的<code>GENERATED_UCLASS_BODY</code>中默认声明这样一个构造函数。并且，在UHT生成的代码中通过宏还定义了一个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL</span>(UMyObject) </span><br></pre></td></tr></table></figure>

<p>这个宏经过展开之后就是这样的:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())<span class="built_in">UMyObject</span>(X); &#125;</span><br></pre></td></tr></table></figure>

<p>为当前的对象类型<code>UMyObject</code>定义了一个<code>__DefaultConstructor</code>函数，作用是在当前<code>FObjectInitializer</code>传入的参数的Object上调用<code>FObjectInitializer</code>的构造函数。</p>
<p><strong>注意</strong>：如果是<code>GENERATED_BODY</code>则不会声明这个构造函数，使用的就是另一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DEFINE_DEFAULT_CONSTRUCTOR_CALL</span>(UMyObject)</span><br></pre></td></tr></table></figure>

<p>展开之后是这样的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.<span class="built_in">GetObj</span>())UMyObject; &#125;</span><br></pre></td></tr></table></figure>

<p>是通过<code>GANERATED_BODY</code>和<code>GENERATED_UCLASS_BODY</code>来定义了两种<code>__DefaultConstructor</code>的实现，一种是调用<code>FObjectInitializer</code>的构造函数，另一种是调用类的默认构造函数。</p>
<blockquote>
<p>所以，默认情况下FObjectInitializer的构造函数和UObject的默认构造函数在调用时只会走一个。</p>
</blockquote>
<p>那么它是如何被调用到的呢？</p>
<p>在<code>NewObject</code>中调用的<code>StaticConstructObject_Internal</code>中有以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> bRecycledSubobject = <span class="literal">false</span>;	</span><br><span class="line">Result = <span class="built_in">StaticAllocateObject</span>(InClass, InOuter, InName, InFlags, InternalSetFlags, bCanRecycleSubobjects, &amp;bRecycledSubobject);</span><br><span class="line"><span class="built_in">check</span>(Result != <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// Don&#x27;t call the constructor on recycled subobjects, they haven&#x27;t been destroyed.</span></span><br><span class="line"><span class="keyword">if</span> (!bRecycledSubobject)</span><br><span class="line">&#123;		</span><br><span class="line">	<span class="built_in">STAT</span>(FScopeCycleCounterUObject <span class="built_in">ConstructorScope</span>(InClass, <span class="built_in">GET_STATID</span>(STAT_ConstructObject)));</span><br><span class="line">	(*InClass-&gt;ClassConstructor)( <span class="built_in">FObjectInitializer</span>(Result, InTemplate, bCopyTransientsFromClassDefaults, <span class="literal">true</span>, InInstanceGraph) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过传入进来的UClass对象获取其中的<code>ClassConstructor</code>函数指针，并构造出一个<code>FObjectInitializer</code>作为参数传递。</p>
<p>在之前的笔记(<a href="https://imzlp.com/notes/ue/#StaticClass%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84">StaticClass是如何定义的</a>)中，写到了，通过<code>GetPrivateStaticClass</code>获取到当前UObject类的UClass实例会实例化出一个当前类的<code>InternalConstructor</code>函数（注意这个模板参数T是UObject的类）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InternalConstructor</span><span class="params">( <span class="keyword">const</span> FObjectInitializer&amp; X )</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就将其转发到了上面讲到的<code>__DefaultConstructor</code>函数上，然后它里面又转发到了所传入<code>FObjectInitializer</code>对象上的<code>const FObjectInitializer&amp;</code>构造函数上（或者默认构造函数上）。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-call-FObjectInitializer-ctor.webp"></p>
<p>创建对象并调用<code>const FObjectInitializer&amp;</code>构造函数的调用流程为：</p>
<ol>
<li>通过调用<code>StaticAllocateObject</code>根据传入的UClass创建出对象</li>
<li>通过传入的UClass对象内的ClassConstructor函数指针调用所创建UObject类的<code>InternalConstructor</code>函数</li>
<li><code>UMyObject::InternalConstructor</code>会转发到<code>UMyObject::__DefaultConstructor</code></li>
<li><code>UMyObject::__DefaultConstructor</code>会从接收到的<code>FObjectInitializer</code>对象上获取到通过<code>StaticAllocateObject</code>创建的对象，然后通过<code>placement-new</code>的方式，在这块内存上调用<code>UMyObject</code>类的<code>const FObjectInitializer&amp;</code>构造函数。</li>
</ol>
<p>通过以上的流程就实现了<code>NewObject</code>时会自动调用到它的<code>FObjectInitializer</code>构造函数。</p>
<blockquote>
<p>注意：在CDO的构造上有点区别，CDO的构造是通过<code>UClass::GetDefaultObject</code>中实现上述流程的。</p>
</blockquote>
<h2 id="StaticClass是如何定义的"><a href="#StaticClass是如何定义的" class="headerlink" title="StaticClass是如何定义的"></a>StaticClass是如何定义的</h2><p>在UE中可以对UObject的类执行<code>UXXX::StaticClass</code>方法来获取到它的UClass对象。</p>
<p>但是它是如何定义的？首先要看我们声明对象的<code>MyActor.generated.h</code>中（以AMyActor类为例）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;<span class="class"><span class="keyword">class</span> <span class="title">AMyActor</span>&gt;</span>();</span><br></pre></td></tr></table></figure>

<p>为AMyActor类特化了<code>StaticClass</code>的版本。再去<code>MyActor.gen.cpp</code>中找以下它的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CLASS</span>(AMyActor, <span class="number">31943282</span>);</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;AMyActor&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里看也就只是转发调用而已，但是关键点隐藏在其他地方。<br>首先<code>AMyActor::StaticClass</code>类的定义是在<code>AMyActor.generated.h</code>的<code>DECLARE_CLASS</code>宏中（该宏定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1524">ObjectMacros.h#L1524</a>），返回的是<code>GetPrivateStaticClass</code>的调用。</p>
<p>而<code>GetPrivateStaticClass</code>则在<code>AMyAcotr.gen.cpp</code>中的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a>实现。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></span><br><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line">	<span class="keyword">static</span> TClassCompiledInDefer&lt;TClass&gt; AutoInitialize##<span class="built_in">TClass</span>(<span class="built_in">TEXT</span>(#TClass), <span class="built_in"><span class="keyword">sizeof</span></span>(TClass), TClassCrc); \</span><br><span class="line">	UClass* TClass::GetPrivateStaticClass() \</span><br><span class="line">	&#123; \</span><br><span class="line">		<span class="keyword">static</span> UClass* PrivateStaticClass = <span class="literal">NULL</span>; \</span><br><span class="line">		<span class="keyword">if</span> (!PrivateStaticClass) \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span><br><span class="line">			<span class="built_in">GetPrivateStaticClassBody</span>( \</span><br><span class="line">				<span class="built_in">StaticPackage</span>(), \</span><br><span class="line">				(TCHAR*)<span class="built_in">TEXT</span>(#TClass) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), \</span><br><span class="line">				PrivateStaticClass, \</span><br><span class="line">				StaticRegisterNatives##TClass, \</span><br><span class="line">				<span class="built_in"><span class="keyword">sizeof</span></span>(TClass), \</span><br><span class="line">				<span class="built_in"><span class="keyword">alignof</span></span>(TClass), \</span><br><span class="line">				(EClassFlags)TClass::StaticClassFlags, \</span><br><span class="line">				TClass::<span class="built_in">StaticClassCastFlags</span>(), \</span><br><span class="line">				TClass::<span class="built_in">StaticConfigName</span>(), \</span><br><span class="line">				(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br><span class="line">				&amp;TClass::AddReferencedObjects, \</span><br><span class="line">				&amp;TClass::Super::StaticClass, \</span><br><span class="line">				&amp;TClass::WithinClass::StaticClass \</span><br><span class="line">			); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="keyword">return</span> PrivateStaticClass; \</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>GetPrivateStaticClass</code>其实就是通过这些元数据构造出UClass的。</p>
<p>如下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IMPLEMENT_CLASS</span>(AMyActor, <span class="number">3240835608</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏展开之后</span></span><br><span class="line"><span class="keyword">static</span> TClassCompiledInDefer &lt; AMyActor &gt; <span class="built_in">AutoInitializeAMyActor</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>), <span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), <span class="number">3240835608</span>);</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) &#123;</span><br><span class="line">    <span class="built_in">GetPrivateStaticClassBody</span>(</span><br><span class="line">    	<span class="built_in">StaticPackage</span>(), </span><br><span class="line">    	(TCHAR*)<span class="built_in">TEXT</span>(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="built_in"><span class="keyword">sizeof</span></span>(AMyActor), </span><br><span class="line">    	<span class="built_in"><span class="keyword">alignof</span></span>(AMyActor), </span><br><span class="line">    	(EClassFlags) AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::<span class="built_in">StaticClassCastFlags</span>(), </span><br><span class="line">    	AMyActor::<span class="built_in">StaticConfigName</span>(), </span><br><span class="line">    	(UClass::ClassConstructorType) InternalConstructor&lt;AMyActor&gt;,</span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;,</span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects,</span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="UClass中的函数指针"><a href="#UClass中的函数指针" class="headerlink" title="UClass中的函数指针"></a>UClass中的函数指针</h3><p>上面代码中比较关键的点为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br></pre></td></tr></table></figure>

<p>这两行是模板实例化出了两个函数并转换成函数指针传递给<code>GetPrivateStaticClassBody</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InternalConstructor</span><span class="params">( <span class="keyword">const</span> FObjectInitializer&amp; X )</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the vtable ctor caller for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function">UObject* <span class="title">InternalVTableHelperCtorCaller</span><span class="params">(FVTableHelper&amp; Helper)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> T::__VTableCtorCaller(Helper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是对<code>__DefaultConstructor</code>这样函数的的转发调用。</p>
<p><code>UClass::ClassConstructorType</code>与<code>UClass::ClassVTableHelperCtorCallerType</code>这两个<code>typedef</code>为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span>		<span class="params">(*ClassConstructorType)</span>				<span class="params">(<span class="keyword">const</span> FObjectInitializer&amp;)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> UObject*	(*ClassVTableHelperCtorCallerType)	(FVTableHelper&amp; Helper);</span><br></pre></td></tr></table></figure>

<h3 id="GetPrivateStaticClassBody"><a href="#GetPrivateStaticClassBody" class="headerlink" title="GetPrivateStaticClassBody"></a>GetPrivateStaticClassBody</h3><p>其中的<code>GetPrivateStaticClassBody</code>函数是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Private/UObject/Class.cpp">Runtime\CoreUObject\Private\UObject\Class.cpp</a>中的。</p>
<p>原型为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetPrivateStaticClassBody</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* PackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* Name,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass*&amp; ReturnClass,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">void</span>(*RegisterNativeFunc)(),</span></span></span><br><span class="line"><span class="function"><span class="params">	uint32 InSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	uint32 InAlignment,</span></span></span><br><span class="line"><span class="function"><span class="params">	EClassFlags InClassFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">	EClassCastFlags InClassCastFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* InConfigName,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassConstructorType InClassConstructor,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassVTableHelperCtorCallerType InClassVTableHelperCtorCaller,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassAddReferencedObjectsType InClassAddReferencedObjects,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::StaticClassFunctionType InSuperClassFn,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::StaticClassFunctionType InWithinClassFn,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">bool</span> bIsDynamic <span class="comment">/*= false*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中第四个参数是传入注册Native函数的函数指针，该函数在<code>MyActor.gen.cpp</code>中生成，也可以通过在UFUNCTION中添加<code>CustomThunk</code>函数来自己实现，UnLua的覆写C++函数就是基于替换thunk函数做的。</p>
<p><code>GetPrivateStaticClassBody</code>中通过<code>(UClass*)GUObjectAllocator.AllocateUObject</code>来分配出UClass的内存，因为所有的UClass结构都一致。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyActor.gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::<span class="built_in">StaticClass</span>();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;ReceiveBytes&quot;</span>, &amp;AMyActor::execReceiveBytes &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;TESTFUNC&quot;</span>, &amp;AMyActor::execTESTFUNC &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::<span class="built_in">RegisterFunctions</span>(Class, Funcs, <span class="built_in">ARRAY_COUNT</span>(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是把Native的函数通过<code>AddNativeFunction</code>添加到UClass中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\CoreUObject\Private\UObject\Class.cpp </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeFunctionRegistrar::RegisterFunctions</span><span class="params">(class UClass* Class, <span class="keyword">const</span> FNameNativePtrPair* InArray, int32 NumFunctions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (; NumFunctions; ++InArray, --NumFunctions)</span><br><span class="line">	&#123;</span><br><span class="line">		Class-&gt;<span class="built_in">AddNativeFunction</span>(<span class="built_in">UTF8_TO_TCHAR</span>(InArray-&gt;NameUTF8), InArray-&gt;Pointer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取UObject的资源路径"><a href="#获取UObject的资源路径" class="headerlink" title="获取UObject的资源路径"></a>获取UObject的资源路径</h2><p>可以通过<code>FSoftObjectPath</code>传入UObject来获得：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">GetObjectResource</span><span class="params">(UObject* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FSoftObjectPath <span class="title">SoftRef</span><span class="params">(Obj)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> SoftRef.<span class="built_in">ToString</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：直接<code>ToString</code>获取到的路径是PackagePath的，形如<code>/Game/XXXX.XXXX</code>这种形式，可以通过<code>GetLongPackageName</code>得到去掉<code>.XXXX</code>的字符串。</p>
<h2 id="BP-to-CPP"><a href="#BP-to-CPP" class="headerlink" title="BP to CPP"></a>BP to CPP</h2><p>在<code>Project Settings</code>-<code>Packaging</code>-<code>Blueprint</code>下添加想要转换的蓝图资源：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-translation-bp-to-cpp.webp"></p>
<p>设置之后执行打包就会在项目的下列路径中产生对应的<code>.h/.cpp</code>以及生成<code>generated.h/gen.cpp</code>：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Plugins\NativizedAssets\Windows\Game\Intermediate\Build\Win64\UE4\Inc\NativizedAssets</span><br></pre></td></tr></table></figure>

<h2 id="监听窗口关闭"><a href="#监听窗口关闭" class="headerlink" title="监听窗口关闭"></a>监听窗口关闭</h2><p>可以通过监听<code>FSlateFontServices</code>里的<code>OnSlateWindowDestroyed</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called on the game thread right before the slate window handle is destroyed.  </span></span><br><span class="line"><span class="comment"> * This gives users a chance to release any viewport specific resources they may have active when the window is destroyed </span></span><br><span class="line"><span class="comment"> * @param Pointer to the API specific backbuffer type</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOnSlateWindowDestroyed, <span class="keyword">void</span>*);</span><br><span class="line"><span class="function">FOnSlateWindowDestroyed&amp; <span class="title">OnSlateWindowDestroyed</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> OnSlateWindowDestroyedDelegate; &#125;</span><br></pre></td></tr></table></figure>

<p>监听方法:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">GetRenderer</span>()-&gt;<span class="built_in">OnSlateWindowDestroyed</span>().<span class="built_in">AddRaw</span>(<span class="keyword">this</span>, &amp;FSceneViewport::OnWindowBackBufferResourceDestroyed);</span><br></pre></td></tr></table></figure>

<h2 id="UnLua的EXPORT-PRIMITIVE-TYPE"><a href="#UnLua的EXPORT-PRIMITIVE-TYPE" class="headerlink" title="UnLua的EXPORT_PRIMITIVE_TYPE"></a>UnLua的EXPORT_PRIMITIVE_TYPE</h2><p>UnLua里使用<code>EXPORT_PRIMITIVE_TYPE</code>宏来导出内置类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">EXPORT_PRIMITIVE_TYPE</span>(uint64, TPrimitiveTypeWrapper&lt;uint64&gt;, uint64)</span><br></pre></td></tr></table></figure>
<p>宏展开之后为:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt; &gt; <span class="class"><span class="keyword">struct</span> <span class="title">UnLua</span>:</span>:TType &lt; TPrimitiveTypeWrapper &lt; uint64 &gt; , <span class="literal">false</span> &gt; &#123;</span><br><span class="line">  <span class="keyword">static</span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">GetName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;uint64&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FExporteduint64Helper</span> &#123;</span></span><br><span class="line">  <span class="keyword">typedef</span> TPrimitiveTypeWrapper &lt; uint64 &gt; ClassType;</span><br><span class="line">  <span class="keyword">static</span> FExporteduint64Helper StaticInstance;</span><br><span class="line">  UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * ExportedClass;</span><br><span class="line">  ~<span class="built_in">FExporteduint64Helper</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> ExportedClass;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FExporteduint64Helper</span>(): <span class="built_in">ExportedClass</span>(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">    UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * Class = (UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * ) UnLua::<span class="built_in">FindExportedClass</span>(<span class="string">&quot;uint64&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Class) &#123;</span><br><span class="line">      ExportedClass = <span class="keyword">new</span> UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; (<span class="string">&quot;uint64&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">      UnLua::<span class="built_in">ExportClass</span>((UnLua::IExportedClass * ) ExportedClass);</span><br><span class="line">      Class = ExportedClass;</span><br><span class="line">    &#125;</span><br><span class="line">    Class - &gt; <span class="built_in">AddProperty</span>(<span class="string">&quot;Value&quot;</span>, &amp; ClassType::Value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">FExporteduint64Helper FExporteduint64Helper::StaticInstance;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FTypeInterfaceuint64</span> &#123;</span></span><br><span class="line">  <span class="built_in">FTypeInterfaceuint64</span>() &#123;</span><br><span class="line">    UnLua::<span class="built_in">AddTypeInterface</span>(<span class="string">&quot;uint64&quot;</span>, UnLua::GetTypeInterface &lt; uint64 &gt; ());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;TypeInterfaceuint64;</span><br></pre></td></tr></table></figure>



<h2 id="4-25-MountPak没有材质"><a href="#4-25-MountPak没有材质" class="headerlink" title="4.25 MountPak没有材质"></a>4.25 MountPak没有材质</h2><p>在项目打包时在<code>Project Settgins</code>-<code>Packaging</code>中开启了<code>Share Material shader code</code>时，后续的热更pak打包，如果没有同步把<code>ushaderbytecode</code>打包进去并自己加载，会产生下列材质丢失的问题：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>经过调试后发现，是因为4.25在mount pak之后不会加载新的Pak中的<code>shaderbytecode</code>，找到了问题，解决办法就手到擒来了，找到引擎中加载<code>shaderbytecode</code>的代码自己调用一遍即可。</p>
<p>在项目打包时默认会生成两个<code>shaderbytecode</code>文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ShaderArchive-Global-PCD3D_SM5.ushaderbytecode</span><br><span class="line">ShaderArchive-HotPatcherExample-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>

<p>并且它们存在于pak中Mount point的路径均为:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../PROJECT_NAME/Content/</span><br></pre></td></tr></table></figure>

<p>而且根据<code>shaderbytecode</code>文件路径的组成规则：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> FString ShaderExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString StableExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString PipelineExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + ShaderExtension;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，只需要传递基础路径和LibraryName即可（OpenLibrary中通过调用<code>GetCodeArchiveFilename</code>来获取要加载的文件）。</p>
<p>即要重新加载global和项目的shaderbytecode，在mount成功之后执行下面两行代码即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(<span class="string">&quot;Global&quot;</span>, FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br></pre></td></tr></table></figure>

<p>通过笔记最前面的一段话，可以总结出两个解决方案：</p>
<ol>
<li>开启了Share Material shader code的情况下，需要把shaderbytecode打包，并自己在Mount时加载；</li>
<li>打Pak时Cook资源不要开启<code>Share Material shader code</code>，这样会把资源的shader都打包在资源内部，从而避免需要单独加载shader的问题；</li>
</ol>
<h2 id="Android上Arrow组件的crash"><a href="#Android上Arrow组件的crash" class="headerlink" title="Android上Arrow组件的crash"></a>Android上Arrow组件的crash</h2><p>在游戏中把一个Actor上的<code>Arrow</code>组件设置为visible，打包Android上运行会Crash：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">06-17 15:23:51.976 26991 27112 F libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x0 in tid 27112 (RenderThread 2), pid 26991 (MainThread-UE4)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #00 pc 062fa090  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FArrowSceneProxy::GetDynamicMeshElements(TArray&lt;FSceneView const*, FDefaultAllocator&gt; const&amp;, FSceneViewFamily const&amp;, unsigned int, FMeshElementCollector&amp;) const+824)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #01 pc 058010f4  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN14FSceneRenderer25GatherDynamicMeshElementsER6TArrayI9FViewInfo17FDefaultAllocatorEPK6FSceneRK16FSceneViewFamilyR25FGlobalDynamicIndexBufferR26FGlobalDynamicVertexBufferR24FGlobalDynamicReadBufferRKS0_Ih18TMemStackAllocatorILj0EEESL_SL_R21FMeshElementCollector+2456)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #02 pc 0580f8a8  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN14FSceneRenderer21ComputeViewVisibilityER24FRHICommandListImmediateN22FExclusiveDepthStencil4TypeER6TArrayI13FViewCommands16TInlineAllocatorILj4E17FDefaultAllocatorEER25FGlobalDynamicIndexBufferR26FGlobalDynamicVertexBufferR24FGlobalDynamicReadBuffer+39716)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #03 pc 054ffb30  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FMobileSceneRenderer::InitViews(FRHICommandListImmediate&amp;)+1076)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #04 pc 05500a98  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FMobileSceneRenderer::Render(FRHICommandListImmediate&amp;)+1228)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #05 pc 057fa970  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZZN15FRendererModule24BeginRenderingViewFamilyEP7FCanvasP16FSceneViewFamilyENK4$_85clER24FRHICommandListImmediate+2316)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #06 pc 057fc944  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN10TGraphTaskI31TEnqueueUniqueRenderCommandTypeIZN15FRendererModule24BeginRenderingViewFamilyEP7FCanvasP16FSceneViewFamilyE21FDrawSceneCommandNameZNS1_24BeginRenderingViewFamilyES3_S5_E4$_85EE11ExecuteTaskER6TArrayIP14FBaseGraphTask17FDefaultAllocatorEN13ENamedThreads4TypeE+712)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #07 pc 040bfa04  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FNamedTaskThread::ProcessTasksNamedThread(int, bool)+2876)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #08 pc 040be518  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FNamedTaskThread::ProcessTasksUntilQuit(int)+108)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #09 pc 0518eaec  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (RenderingThreadMain(FEvent*)+436)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #10 pc 051d93d8  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRenderingThread::Run()+20)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #11 pc 04142c8c  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRunnableThreadPThread::Run()+164)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #12 pc 040b9ef0  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRunnableThreadPThread::_ThreadProc(void*)+80)</span><br><span class="line">06-17 15:23:52.430 26991 27061 D UE4     : Used memory: 361838</span><br><span class="line">06-17 15:27:43.270 13042 13231 I MtpDatabase: Mediaprovider didn&#x27;t delete /storage/emulated/0/UE4Game/GWorld/GWorld/Saved/Paks/1.45_Android_ETC2_001_P.pak</span><br><span class="line">06-17 15:27:45.781 13042 13231 D MtpServer: path: /storage/emulated/0/UE4Game/GWorld/GWorld/Saved/Paks/1.45_Android_ETC2_001_P.pak parent: 68 storageID: 00010001</span><br></pre></td></tr></table></figure>

<p>有时间在来具体分析。</p>
<h2 id="target-build-cs输出Log"><a href="#target-build-cs输出Log" class="headerlink" title="target/build.cs输出Log"></a>target/build.cs输出Log</h2><p>可以使用C#里的以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line">System.Console.WriteLine(<span class="string">&quot;12346&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="TargetRules的BuildSettingsVersion"><a href="#TargetRules的BuildSettingsVersion" class="headerlink" title="TargetRules的BuildSettingsVersion"></a>TargetRules的BuildSettingsVersion</h2><blockquote>
<p>PS:UE4.24之后才有。</p>
</blockquote>
<p>可以在<code>Target.cs</code>中指定：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultBuildSettings = BuildSettingsVersion.V2;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/Configuration/TargetRules.cs#L88">BuildSettingsVersion</a>可以指定构建时使用的默认设置：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines which version of the engine to take default build settings from. This allows for backwards compatibility as new options are enabled by default.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BuildSettingsVersion</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Legacy default build settings for 4.23 and earlier.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	V1,</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> New defaults for 4.24: ModuleRules.PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs, ModuleRules.bLegacyPublicIncludePaths = false.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	V2,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// *** When adding new entries here, be sure to update GameProjectUtils::GetDefaultBuildSettingsVersion() to ensure that new projects are created correctly. ***</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Always use the defaults for the current engine version. Note that this may cause compatibility issues when upgrading.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	Latest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE4.23及之前的引擎版本是<code>V1</code>，用来控制当项目升级引擎版本时使用之前引擎的构建设置，用于解决项目升级之后会有大量错误的问题。</p>
<blockquote>
<p>注意：因为4.25之后的是V2，默认<code>bLegacyPublicIncludePaths=false</code>，这个会导致如果模块中相对于<code>Public</code>的代码路径，如<code>Public/Core/CoreCode.h</code>，如果没有添加Core目录到<code>PublicIncludePaths</code>中，在工程的其他地方不指定相对路径，直接用<code>CoreCode.h</code>，在V1的版本里是可以编译过的，但是在V2中就会有编译错误。</p>
</blockquote>
<h2 id="从TargetRules获取引擎版本"><a href="#从TargetRules获取引擎版本" class="headerlink" title="从TargetRules获取引擎版本"></a>从TargetRules获取引擎版本</h2><p><code>TargetRules</code>中具有**Version (ReadOnlyBuildVersion)**成员，它是<code>BuildVersion</code>的类型，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/System/BuildVersion.cs">Programs\UnrealBuildTool\System\BuildVersion.cs</a>中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildVersion</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The major engine version (4 for UE4)</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> MajorVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The minor engine version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> MinorVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The hotfix/patch version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> PatchVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The changelist that the engine is being built from</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> Changelist;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The changelist that the engine maintains compatibility with</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> CompatibleChangelist;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Whether the changelist numbers are a licensee changelist</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsLicenseeVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Whether the current build is a promoted build, that is, built strictly from a clean sync of the given changelist</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsPromotedBuild;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Name of the current branch, with &#x27;/&#x27; characters escaped as &#x27;+&#x27;</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> BranchName;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The current build id. This will be generated automatically whenever engine binaries change if not set in the default Engine/Build/Build.version.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> BuildId;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The build version string</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> BuildVersionString;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在<code>Target.cs</code>或者<code>Build.cs</code>里通过<code>Target.Version</code>来访问引擎版本，可以根据不同的引擎版本来使用不同的库。</p>
<h2 id="从TargetRules获取Configuration"><a href="#从TargetRules获取Configuration" class="headerlink" title="从TargetRules获取Configuration"></a>从TargetRules获取Configuration</h2><p>从<code>ReadOnlyTargetRules</code>接收到的Target，可以从其中获取<code>Configuration</code>成员，用于检测打包的<code>BuildConfiguration</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Target.Configuration == UnrealTargetConfiguration.Shipping)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举值为<code>Development</code>/<code>Debug</code>/<code>DebugGame</code>/<code>Shipping</code>/<code>Test</code>等。</p>
<h2 id="IOS-CrashLog分析"><a href="#IOS-CrashLog分析" class="headerlink" title="IOS CrashLog分析"></a>IOS CrashLog分析</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2151/_index.html">Understanding and Analyzing Application Crash Reports</a></li>
</ul>
<h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><blockquote>
<p>UE4使用<strong>标记</strong>-<strong>清扫</strong>式的GC方式，它是一种经典的垃圾回收方式。一次垃圾回收分为两个阶段。第一阶段从一个根集合出发，遍历所有可达对象，遍历完成后就能标记出可达对象和不可达对象了，这个阶段会在一帧内完成。第二阶段会渐进式的清理这些不可达对象，因为不可达的对象将永远不能被访问到，所以可以分帧清理它们，避免一下子清理很多UObject，比如map卸载时，发生明显的卡顿。</p>
</blockquote>
<p>UObject之间的引用关系需要用强指针引用加UPROPERTY标记完成。</p>
<p>UPROPERTY标记通过UHT之后会生成UProperty对象，UProperty对象可以控制对属性的访问。也通过UProperty对象保存引用关系。</p>
<p>如果想要给没有添加UPROPERTY标记的对象添加引用可以通过重写<code>UObject</code>的虚函数<code>AddReferencedObjects</code>，比如AActor中的<code>OwnedComponents</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actor.h</span></span><br><span class="line">TSet&lt;UActorComponent*&gt; OwnedComponents;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actor.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::AddReferencedObjects</span><span class="params">(UObject* InThis, FReferenceCollector&amp; Collector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	AActor* This = CastChecked&lt;AActor&gt;(InThis);</span><br><span class="line">	Collector.<span class="built_in">AddReferencedObjects</span>(This-&gt;OwnedComponents);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (This-&gt;CurrentTransactionAnnotation.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		This-&gt;CurrentTransactionAnnotation-&gt;<span class="built_in">AddReferencedObjects</span>(Collector);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	Super::<span class="built_in">AddReferencedObjects</span>(InThis, Collector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SDetailsView监听属性变化"><a href="#SDetailsView监听属性变化" class="headerlink" title="SDetailsView监听属性变化"></a>SDetailsView监听属性变化</h2><p>可以通过监听基类<code>SDetailsViewBase</code>中的<code>OnFinishedChangingPropertiesDelegate</code>代理来实现。</p>
<p>接收参数是<code>FPropertyChangedEvent</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOnFinishedChangingProperties, <span class="keyword">const</span> FPropertyChangedEvent&amp;);</span><br></pre></td></tr></table></figure>

<h2 id="UObject-serializer的调用栈"><a href="#UObject-serializer的调用栈" class="headerlink" title="UObject serializer的调用栈"></a>UObject serializer的调用栈</h2><p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/uobject-data-serialize-callstack.webp"></p>
<p>有时间再来分析具体内容。</p>
<h2 id="FName-FString-FText的区别"><a href="#FName-FString-FText的区别" class="headerlink" title="FName/FString/FText的区别"></a>FName/FString/FText的区别</h2><h3 id="FName"><a href="#FName" class="headerlink" title="FName"></a>FName</h3><p>FName的字符串一般用在为资源命名或者访问资源时（比如命名的骨骼）需要使用。<br>它使用一个轻型系统使用字符串，特定字符串会被重复使用，在数据表中也就只存储一次。</p>
<ol>
<li>只在内存中存储一次</li>
<li>不区分大小写</li>
<li>不能被修改</li>
<li>查找和访问速度比较快</li>
<li>内部有一个HASH值<br>FName在Edior中占12个字节，打包8字节，FName的<code>XXXX_12</code>这样的字符串会被分成string part和number part，估计是为了想不为每个拼接的结果都在NamePool中创建一份吧。</li>
</ol>
<h3 id="FString"><a href="#FString" class="headerlink" title="FString"></a>FString</h3><p>FSting比较类似于标准库的<code>std::string</code>，区分大小写，可修改，每份实例都是单独的内存。</p>
<h3 id="FText"><a href="#FText" class="headerlink" title="FText"></a>FText</h3><p>FText是用于本地化的类，所有需要展示的文本都需要使用FText，它提供了以下功能：</p>
<ol>
<li>创建本地化文本</li>
<li>格式化文本</li>
<li>从数字生成文本</li>
<li>从日期或时间生成文本</li>
<li>转换文本（大小写转换等）</li>
</ol>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/StringHandling/index.html">String Handling</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Gameplay/Localization/Formatting/index.html#textliterals">Text Localization</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144850633">UE4 FName原理分析</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/139711646">UE4底层剖析之命名系统</a></li>
</ul>
<h2 id="Plugin添加其他Plugin的模块"><a href="#Plugin添加其他Plugin的模块" class="headerlink" title="Plugin添加其他Plugin的模块"></a>Plugin添加其他Plugin的模块</h2><p>如果插件A要引用插件B中的模块，那么就需要在插件A的uplugin文件中添加对插件B的依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;Plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<p>然后就可以在插件A中添加插件B中的模块了。</p>
<h2 id="Build-Configurations"><a href="#Build-Configurations" class="headerlink" title="Build Configurations"></a>Build Configurations</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/Development/BuildConfigurations/index.html">Build Configurations Reference</a></li>
</ul>
<table>
<thead>
<tr>
<th>Build Status</th>
<th>Describle</th>
</tr>
</thead>
<tbody><tr>
<td>Debug</td>
<td>引擎和游戏符号都以debug方式编译，需要源码版引擎</td>
</tr>
<tr>
<td>DebugGame</td>
<td>优化引擎代码，只可以调试Game符号</td>
</tr>
<tr>
<td>Development</td>
<td>默认的配置，在DebugGame的模式上进行优化，只可以调试游戏符号</td>
</tr>
<tr>
<td>Shipping</td>
<td>不包含调试符号、Console、stats、profiling工具，用于发行版本</td>
</tr>
<tr>
<td>Test</td>
<td>与Shipping相同，但是要会包含Console、stats、profiling等工具</td>
</tr>
</tbody></table>
<p>如果使用从<code>EpicLauncher</code>安装的引擎，打包Debug时会提示：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Targets cannot be built in the Debug configuration with this engine distribution.</span><br></pre></td></tr></table></figure>
<p>这个报错是在UBT中产生的，具体代码在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25.1-release/Engine/Source/Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs#L719">UnrealBuildTool\Configuration\UEBuildTarget.cs</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/unrealengine/comments/ejz4dg/targets_cannot_be_built_in_the_debug/">“Targets cannot be built in the Debug configuration with this engine distribution.”</a></li>
</ul>
<h2 id="GlobalShaderCache的加载"><a href="#GlobalShaderCache的加载" class="headerlink" title="GlobalShaderCache的加载"></a>GlobalShaderCache的加载</h2><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Private/ShaderCompiler/ShaderCompiler.cpp">Runtime/Engine/Private/ShaderCompiler/ShaderCompiler.cpp</a>中有获取<code>GlobalShaderCache*.bin</code>的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetGlobalShaderCacheFilename</span><span class="params">(EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>)) / <span class="built_in">TEXT</span>(<span class="string">&quot;GlobalShaderCache-&quot;</span>) + <span class="built_in">LegacyShaderPlatformToShaderFormat</span>(Platform).<span class="built_in">ToString</span>() + <span class="built_in">TEXT</span>(<span class="string">&quot;.bin&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在同文件中定义的<code>CompileGlobalShaderMap</code>函数中被读取。<br>调用栈：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Shader/ue-launch-game-CompileGlobalShaderMap-callstack.webp"></p>
<p>完整流程有时间再来分析。</p>
<h2 id="ushaderbytecode的加载"><a href="#ushaderbytecode的加载" class="headerlink" title="ushaderbytecode的加载"></a>ushaderbytecode的加载</h2><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp">Runtime/RenderCore/Private/ShaderCodeLibrary.cpp</a>文件中，可以获取到shaderbytecode相关的文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> uint32 GShaderCodeArchiveVersion = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">static</span> uint32 GShaderPipelineArchiveVersion = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> FString ShaderExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString StableExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString PipelineExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + ShaderExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetStableInfoArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderStableInfo-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + StableExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetPipelinesArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + PipelineExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetShaderCodeFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderCode-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + ShaderExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetShaderDebugFolder</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderDebug-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在同文件的<code>FShaderLibraryInstance::Create</code>来加载。</p>
<p>完整流程有时间再来分析。</p>
<h2 id="默认打包到pak里的资源"><a href="#默认打包到pak里的资源" class="headerlink" title="默认打包到pak里的资源"></a>默认打包到pak里的资源</h2><p>UE在打包的时候会把工程下的<code>Content</code>中的资源进行依赖分析然后打包，但是经过对比之后发现，引擎中还会添加额外的没有引用到的资源，经过分析代码发现引擎的ini中有指定：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;Engine\Config\BaseEngine.ini</span></span><br><span class="line"><span class="section">[Engine.StartupPackages]</span></span><br><span class="line"><span class="attr">bSerializeStartupPackagesFromMemory</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">bFullyCompressStartupPackages</span>=<span class="literal">false</span></span><br><span class="line">+Package=/Engine/EngineMaterials/BlinkingCaret</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultBokeh</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultBloomKernel</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultDeferredDecalMaterial</span><br><span class="line"><span class="comment">;+Package=/Engine/EngineMaterials/DefaultPostProcessMaterial</span></span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultDiffuse</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultLightFunctionMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/WorldGridMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultNormal</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultPhysicalMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultVirtualTextureMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultWhiteGrid</span><br><span class="line">+Package=/Engine/EngineMaterials/EditorBrushMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/EmissiveMeshMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/Good64x64TilingNoiseHighFreq</span><br><span class="line">+Package=/Engine/EngineMaterials/Grid</span><br><span class="line">+Package=/Engine/EngineMaterials/Grid_N</span><br><span class="line">+Package=/Engine/EngineMaterials/LandscapeHolePhysicalMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/MiniFont</span><br><span class="line">+Package=/Engine/EngineMaterials/PaperDiffuse</span><br><span class="line">+Package=/Engine/EngineMaterials/PaperNormal</span><br><span class="line">+Package=/Engine/EngineMaterials/PhysMat_Rubber</span><br><span class="line">+Package=/Engine/EngineMaterials/PreintegratedSkinBRDF</span><br><span class="line">+Package=/Engine/EngineMaterials/RemoveSurfaceMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/WeightMapPlaceholderTexture</span><br><span class="line"></span><br><span class="line"><span class="comment">; Console platforms will remove EngineDebugMaterials from their StartupPackages</span></span><br><span class="line">+Package=/Engine/EngineDebugMaterials/BoneWeightMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/DebugMeshMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/GeomMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/HeatmapGradient</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/LevelColorationLitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/LevelColorationUnlitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/MAT_LevelColorationLitLightmapUV</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/ShadedLevelColorationLitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/ShadedLevelColorationUnlitMateri</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/TangentColorMap</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_AlphaAsColor</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_BlueOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_ColorOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_GreenOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_RedOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/WireframeMaterial</span><br><span class="line"></span><br><span class="line">+Package=/Engine/EngineSounds/WhiteNoise</span><br><span class="line"></span><br><span class="line">+Package=/Engine/EngineFonts/SmallFont</span><br><span class="line">+Package=/Engine/EngineFonts/TinyFont</span><br><span class="line">+Package=/Engine/EngineFonts/Roboto</span><br><span class="line">+Package=/Engine/EngineFonts/RobotoTiny</span><br><span class="line"></span><br><span class="line"><span class="comment">; only needed for TextRender feature (3d Text in world)</span></span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultTextMaterialTranslucent</span><br><span class="line">+Package=/Engine/EngineFonts/RobotoDistanceField</span><br></pre></td></tr></table></figure>

<p>就算是工程中没有任何资源，也会默认把这些资源给打包进来。</p>
<h2 id="创建Commandlet"><a href="#创建Commandlet" class="headerlink" title="创建Commandlet"></a>创建Commandlet</h2><p>在一个Editor的Module下创建下列文件和代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Commandlets/Commandlet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherPatcherCommandlet.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UHotPatcherPatcherCommandlet</span> :</span><span class="keyword">public</span> UCommandlet</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">Main</span><span class="params">(<span class="keyword">const</span> FString&amp; Params)</span><span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherCookerCommandlet.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">UHotPatcherCookerCommandlet::Main</span><span class="params">(<span class="keyword">const</span> FString&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;UHotPatcherCookerCommandlet::Main&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在启动的时候就可以使用下列参数来运行Commandlet，并且可以给它传递参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe PROJECT_NAME.uproject -run=HotPatcherCooker  -aaa=<span class="string">&quot;D:\\AAA.json&quot;</span> -test1</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-run-commandlet.webp"></p>
<h2 id="UnLua如何实现函数覆写"><a href="#UnLua如何实现函数覆写" class="headerlink" title="UnLua如何实现函数覆写"></a>UnLua如何实现函数覆写</h2><blockquote>
<p>概括来说：UnLua绑定了UE创建对象的事件，当创建CDO时会调用到UnLua的<code>NotifyUObjectCreated</code>，在其中拿到了该对象的UClass，对该对象的UClass中的UFUNCTION通过<code>SetNativeFunc</code>修改为<code>CallLua</code>函数，这样就实现了覆写UFUNCTION。</p>
</blockquote>
<p>下面来具体分析一下实现。UnLua实现覆写完整的调用栈：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/ue4-notifyUObjectCreated-call-stack.webp"></p>
<h3 id="替换Thunk函数"><a href="#替换Thunk函数" class="headerlink" title="替换Thunk函数"></a>替换Thunk函数</h3><p>在UnLua的FLuaContext的initialize函数中，将GLuaCxt注册到了<code>GUObjectArray</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaContext.cpp</span></span><br><span class="line"><span class="keyword">if</span> (!bAddUObjectNotify)</span><br><span class="line">&#123;</span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectCreateListener</span>(GLuaCxt);    <span class="comment">// add listener for creating UObject</span></span><br><span class="line">    GUObjectArray.<span class="built_in">AddUObjectDeleteListener</span>(GLuaCxt);    <span class="comment">// add listener for deleting UObject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>FLuaContext</code>继承自<code>FUObjectArray::FUObjectCreateListener</code>和<code>FUObjectArray::FUObjectDeleteListener</code>，所以当UE的对象系统创建对象的时候会把调用到FLuaContext的<code>NotifyUObjectCreated</code>与<code>NotifyUObjectDeleted</code>。</p>
<p>当创建一个UObject的时候会在<code>FObjectArray</code>的<code>AllocateUObjectIndex</code>中对多有注册过的<code>CreateListener</code>调用<code>NotifyUObjectDeleted</code>函数。</p>
<p>而UnLua实现覆写UFUNCTION的逻辑就是写在<code>NotifyUObjectCreated</code>中的<code>TryBindLua</code>调用中，栈如下：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-trybindlua-call-stack.webp"><br>一个一个来说他们的作用：</p>
<h3 id="FLuaContext-TryBindUnlua"><a href="#FLuaContext-TryBindUnlua" class="headerlink" title="FLuaContext::TryBindUnlua"></a>FLuaContext::TryBindUnlua</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Try to bind Lua module for a UObject</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLuaContext::TryToBindLua</span><span class="params">(UObjectBaseUtility *Object)</span></span>;</span><br></pre></td></tr></table></figure>
<p>主要作用是：如果创建的对象继承了<code>UUnLuaInterface</code>，具有<code>GetModuleName</code>函数，则通过传进来的UObject获取到它的UCclass，然后再通过UClass得到<code>GetModuleName</code>函数的<code>UFunction</code>，并通过CDO对象调用该UFunction，得到该CLass绑定的Lua模块名。</p>
<p>若没有静态绑定，则检查是否具有动态绑定。</p>
<h3 id="UUnLuaManager-Bind"><a href="#UUnLuaManager-Bind" class="headerlink" title="UUnLuaManager::Bind"></a>UUnLuaManager::Bind</h3><p>该函数定义在<code>UnLua/pRIVATE/UnLuaManager.cpp</code>文件中。</p>
<p>在<code>TryBindUnlua</code>中得到了当前创建对象的<code>UClass</code>和绑定的模块名，传递到了Bind函数中，它主要做了几件事情：</p>
<ol>
<li>注册Class到lua</li>
<li>require对应的lua模块</li>
<li>调用<code>UnLuaManager::BindInternal</code>函数</li>
<li>为当前对象创建一个lua端对象并push上一个<code>Initialize</code>函数并调用</li>
</ol>
<h3 id="BindInternal"><a href="#BindInternal" class="headerlink" title="BindInternal"></a>BindInternal</h3><p>其中的关键函数为<code>UnLuaManager::BindInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind a Lua module for a UObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UUnLuaManager::BindInternal</span><span class="params">(UObjectBaseUtility *Object, UClass *Class, <span class="keyword">const</span> FString &amp;InModuleName, <span class="keyword">bool</span> bNewCreated)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Object || !Class)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lua_State *L = *GLuaCxt;</span><br><span class="line">    TStringConversion&lt;TStringConvert&lt;TCHAR, ANSICHAR&gt;&gt; <span class="built_in">ModuleName</span>(*InModuleName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bNewCreated)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">BindSurvivalObject</span>(L, Object, Class, ModuleName.<span class="built_in">Get</span>()))    <span class="comment">// try to bind Lua module for survival UObject again...</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FString *ModuleNamePtr = ModuleNames.<span class="built_in">Find</span>(Class);</span><br><span class="line">        <span class="keyword">if</span> (ModuleNamePtr)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ModuleNames.<span class="built_in">Add</span>(Class, InModuleName);</span><br><span class="line">    Classes.<span class="built_in">Add</span>(InModuleName, Class);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">    TSet&lt;FName&gt; *LuaFunctionsPtr = ModuleFunctions.<span class="built_in">Find</span>(InModuleName);</span><br><span class="line">    <span class="built_in">check</span>(!LuaFunctionsPtr);</span><br><span class="line">    TMap&lt;FName, UFunction*&gt; *UEFunctionsPtr = OverridableFunctions.<span class="built_in">Find</span>(Class);</span><br><span class="line">    <span class="built_in">check</span>(!UEFunctionsPtr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    TSet&lt;FName&gt; &amp;LuaFunctions = ModuleFunctions.<span class="built_in">Add</span>(InModuleName);</span><br><span class="line">    <span class="built_in">GetFunctionList</span>(L, ModuleName.<span class="built_in">Get</span>(), LuaFunctions);                         <span class="comment">// get all functions defined in the Lua module</span></span><br><span class="line">    TMap&lt;FName, UFunction*&gt; &amp;UEFunctions = OverridableFunctions.<span class="built_in">Add</span>(Class);</span><br><span class="line">    <span class="built_in">GetOverridableFunctions</span>(Class, UEFunctions);                                <span class="comment">// get all overridable UFunctions</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">OverrideFunctions</span>(LuaFunctions, UEFunctions, Class, bNewCreated);           <span class="comment">// try to override UFunctions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ConditionalUpdateClass</span>(Class, LuaFunctions, UEFunctions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数接受到的参数是创建出来的UObject，以及它的UClass，还有对应的Lua的模块名。</p>
<ol>
<li>把对象的UClass与Lua的模块名对应添加到<code>ModuleNames</code>和<code>Classes</code>中</li>
<li>从Lua端通过L获取所指定模块名中的所有函数</li>
<li>从UClass获取所有的BlueprintEvent、RepNotifyFunc函数</li>
<li>对两边获取的结果调用<code>UUnLuaManager::OverrideFunctions</code>执行替换</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-get-lua-func-and-get-ue-ufuncion.webp"></p>
<h3 id="UUnLuaManager-OverrideFunctions"><a href="#UUnLuaManager-OverrideFunctions" class="headerlink" title="UUnLuaManager::OverrideFunctions"></a>UUnLuaManager::OverrideFunctions</h3><p>对从Lua端获取的函数使用名字在当前类的UFunction中查找，依次对其调用<code>UUnLuaManager::OverrideFunction</code>.</p>
<h3 id="UUnLuaManager-OverrideFunction"><a href="#UUnLuaManager-OverrideFunction" class="headerlink" title="UUnLuaManager::OverrideFunction"></a>UUnLuaManager::OverrideFunction</h3><ol>
<li>判断传入的UFunction是不是属于传入的Outer UClasss</li>
<li>判断是否允许调用被覆写的函数</li>
<li>调用<code>AddFunction</code>函数</li>
</ol>
<h3 id="UUnLuaManager-AddFunction"><a href="#UUnLuaManager-AddFunction" class="headerlink" title="UUnLuaManager::AddFunction"></a>UUnLuaManager::AddFunction</h3><ol>
<li>如果函数为<code>FUNC_Native</code>则将<code>FLuaInvoker::execCallLua</code>和所覆写的函数名通过<code>AddNativeFunction</code>添加至UClass</li>
<li>将<code>UFunction</code>内的函数指针替换为<code>(FNativeFuncPtr)&amp;FLuaInvoker::execCallLua</code></li>
<li>如果开启了允许调用被覆写的函数，则把替换NativeFunc之前的UFunction对象存到<code>GReflectionRegistry</code>中</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-replace-ufunction-native-function-pointer.webp"></p>
<h3 id="Call-lua"><a href="#Call-lua" class="headerlink" title="Call lua"></a>Call lua</h3><p>首先，需要说的一点是，当使用UEC++写的带有<code>UFUNCTION</code>并具有<code>BlueprintNativeEvent</code>或者<code>BlueprintImplementableEvent</code>标记的函数，UHT会给生成对应名字的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintNativeEvent,BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC_Implementation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintImplementableEvent, meta = (DisplayName = <span class="string">&quot;BeginPlay&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTImplEvent</span><span class="params">(AActor* InActor,int32 InIval)</span></span>;</span><br></pre></td></tr></table></figure>

<p>UHT生成的函数和传递的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MicroEnd_423_Source_MicroEnd_423_Public_MyActor_h_13_EVENT_PARMS \</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventReceiveBytes_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		TArray&lt;uint8&gt; InData; \</span><br><span class="line">	&#125;; \</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventTESTFUNC_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue; \</span><br><span class="line"> \</span><br><span class="line">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span><br><span class="line">		<span class="built_in">MyActor_eventTESTFUNC_Parms</span>() \</span><br><span class="line">			: <span class="built_in">ReturnValue</span>(<span class="literal">false</span>) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;; \</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventTESTImplEvent_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		AActor* InActor; \</span><br><span class="line">		int32 InIval; \</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue; \</span><br><span class="line"> \</span><br><span class="line">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span><br><span class="line">		<span class="built_in">MyActor_eventTESTImplEvent_Parms</span>() \</span><br><span class="line">			: <span class="built_in">ReturnValue</span>(<span class="literal">false</span>) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTFUNC = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TESTFUNC&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTFUNC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTFUNC_Parms Parms;</span><br><span class="line">	<span class="built_in">ProcessEvent</span>(<span class="built_in">FindFunctionChecked</span>(NAME_AMyActor_TESTFUNC),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTImplEvent = <span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TESTImplEvent&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTImplEvent</span><span class="params">(AActor* InActor, int32 InIval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTImplEvent_Parms Parms;</span><br><span class="line">	Parms.InActor=InActor;</span><br><span class="line">	Parms.InIval=InIval;</span><br><span class="line">	<span class="built_in">ProcessEvent</span>(<span class="built_in">FindFunctionChecked</span>(NAME_AMyActor_TESTImplEvent),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT帮我们定义了同名函数，并将其转发给<code>ProcessEvent</code>。</p>
<p>注意：这里通过<code>FindFunctionChecked</code>方法是调用的<code>UObject::FindFunctionChecked</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunction</span><span class="params">( FName InName )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetClass</span>()-&gt;<span class="built_in">FindFunctionByName</span>(InName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunctionChecked</span><span class="params">( FName InName )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UFunction* Result = <span class="built_in">FindFunction</span>(InName);</span><br><span class="line">	<span class="keyword">if</span> (Result == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogScriptCore, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to find function %s in %s&quot;</span>), *InName.<span class="built_in">ToString</span>(), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里传递给<code>ProcessEvent</code>的<code>UFunction*</code>就是从当前对象的UClass中得到的。</p>
<p>经过前面分分析可以知道，UnLua实现的函数覆写，就是把UClass中的UFunction中的原生thunk函数指针替换为<code>FLuaInvoker::execCallLua</code>，而且当一个对象的<code>BlueprintNativeEvent</code>和<code>BlueprintImplementableEvent</code>函数被调用的时候会调用到<code>ProcessEvent</code>并传入对应的<code>UFunction*</code>，在<code>ProcessEvent</code>中又调<code>Invork</code>（调用其中的原生指针），也就是实现调用到了unlua中替换绑定的<code>FLuaInvoker::execCallLua</code>，在这个函数中再转发给调用lua端的函数，从而实现了覆写函数的目的。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-process-event-call-stack.webp"></p>
<h2 id="从TargetRules获取引擎版本-1"><a href="#从TargetRules获取引擎版本-1" class="headerlink" title="从TargetRules获取引擎版本"></a>从TargetRules获取引擎版本</h2><p>之前写到过在C++代码里，UE提供了几个宏可以获取引擎版本（<a href="https://imzlp.com/posts/25331/#UE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89">UE版本号的宏定义</a>），那么怎么在build.cs里检测引擎版本？</p>
<p>在UE4.19版本之前从UBT获取引擎版本比较麻烦：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BuildVersion Version;</span><br><span class="line"><span class="keyword">if</span> (BuildVersion.<span class="built_in">TryRead</span>(BuildVersion.<span class="built_in">GetDefaultFileName</span>(), out Version))</span><br><span class="line">&#123;</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.MajorVersion);</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.MinorVersion);</span><br><span class="line">    System.Console.<span class="built_in">WriteLine</span>(Version.PatchVersion);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在UE4.19及以后的引擎版本，可以通过<code>ReadOnlyTargetRules.Version</code>来获得，它是<code>ReadOnlyBuildVersion</code>类型，包裹了一个<code>BuildVersion</code>类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTools/System/BuildVersion.cs</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">UnrealBuildTool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Holds information about the current engine version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	[<span class="meta">Serializable</span>]</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildVersion</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The major engine version (4 for UE4)</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> MajorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The minor engine version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> MinorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The hotfix/patch version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> PatchVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine is being built from</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> Changelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine maintains compatibility with</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> CompatibleChangelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the changelist numbers are a licensee changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">bool</span> IsLicenseeVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the current build is a promoted build, that is, built strictly from a clean sync of the given changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">bool</span> IsPromotedBuild;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Name of the current branch, with &#x27;/&#x27; characters escaped as &#x27;+&#x27;</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BranchName;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The current build id. This will be generated automatically whenever engine binaries change if not set in the default Engine/Build/Build.version.</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BuildId;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The build version string</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> BuildVersionString;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>MajorVersion</code>/<code>MinorVersion</code>/<code>PatchVersion</code>分别对应X.XX.X。</p>
<h2 id="FPaths中Dir函数的对应路径"><a href="#FPaths中Dir函数的对应路径" class="headerlink" title="FPaths中Dir函数的对应路径"></a>FPaths中Dir函数的对应路径</h2><p>FPaths提供了很多<code>EngineDir</code>等之类的函数，我在unlua里导出了这些符号：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineUserDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineContentDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineConfigDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EngineSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EngineSavedDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;EnginePluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">EnginePluginsDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;RootDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">RootDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectUserDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectConfigDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectIntermediateDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectIntermediateDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectPluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectPluginsDir</span>()))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">fmt</span>(<span class="string">&quot;ProjectLogDir: &#123;&#125;&quot;</span>,UE4.FPaths.<span class="built_in">ProjectLogDir</span>()))</span><br></pre></td></tr></table></figure>

<p>他们对应的具体路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">EngineDir: ../../../Engine/</span><br><span class="line">EngineUserDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/</span><br><span class="line">EngineContentDir: ../../../Engine/Content/</span><br><span class="line">EngineConfigDir: ../../../Engine/Config/</span><br><span class="line">EngineSavedDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/Saved/</span><br><span class="line">EnginePluginsDir: ../../../Engine/Plugins/</span><br><span class="line">RootDir: : /Program Files/Epic Games/UE_4.22/</span><br><span class="line">ProjectDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectUserDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectContentDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Content/</span><br><span class="line">ProjectConfigDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Config/</span><br><span class="line">ProjectSavedDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/</span><br><span class="line">ProjectIntermediateDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Intermediate/</span><br><span class="line">ProjectPluginsDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Plugins/</span><br><span class="line">ProjectLogDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/Logs/</span><br></pre></td></tr></table></figure>
<p>这些相对路径都是<strong>相对于引擎的exe</strong>的路径的：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-fpath-relative-engine-binary.webp"></p>
<h2 id="通过Commandline替换加载的ini"><a href="#通过Commandline替换加载的ini" class="headerlink" title="通过Commandline替换加载的ini"></a>通过Commandline替换加载的ini</h2><p>如项目下的<code>DefaultEngine.ini</code>/<code>DefaultGame.ini</code>等。<br>去掉<code>Default</code>和<code>ini</code>后缀之后是它们的baseName，可以通过下列命令行来替换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine</span></span><br><span class="line">-EngineINI=REPLACE_INI_FILE_PAT.ini</span><br><span class="line"><span class="comment"># game</span></span><br><span class="line">-GameINI=REPLACE_INI_FILE_PAT.ini</span><br></pre></td></tr></table></figure>
<p>具体实现是在<code>FConfigCacheIni::GetDestIniFilename</code>中做的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core/Private/Misc/ConfigCacheIni.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">FConfigCacheIni::GetDestIniFilename</span><span class="params">(<span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* PlatformName, <span class="keyword">const</span> TCHAR* GeneratedConfigDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// figure out what to look for on the commandline for an override</span></span><br><span class="line">	FString CommandLineSwitch = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sINI=&quot;</span>), BaseIniName);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// if it&#x27;s not found on the commandline, then generate it</span></span><br><span class="line">	FString IniFilename;</span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(FCommandLine::<span class="built_in">Get</span>(), *CommandLineSwitch, IniFilename) == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FString <span class="title">Name</span><span class="params">(PlatformName ? PlatformName : ANSI_TO_TCHAR(FPlatformProperties::PlatformName()))</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if the BaseIniName doens&#x27;t contain the config dir, put it all together</span></span><br><span class="line">		<span class="keyword">if</span> (FCString::<span class="built_in">Stristr</span>(BaseIniName, GeneratedConfigDir) != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			IniFilename = BaseIniName;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			IniFilename = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s%s/%s.ini&quot;</span>), GeneratedConfigDir, *Name, BaseIniName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// standardize it!</span></span><br><span class="line">	FPaths::<span class="built_in">MakeStandardFilename</span>(IniFilename);</span><br><span class="line">	<span class="keyword">return</span> IniFilename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取当前平台信息"><a href="#获取当前平台信息" class="headerlink" title="获取当前平台信息"></a>获取当前平台信息</h2><p>可以使用<code>FPlatformProperties</code>来获取当前程序的平台信息。<br>同样是使用UE的跨平台库写法，<code>FGenericPlatformProperties</code>是定义在<code>Core/Public/GenericPlatform/GenericPlatformProperties.h</code>中的。</p>
<p>例：可以使用<code>FPlatformProperties::PlatformName()</code>运行时来获取当前平台的名字。</p>
<p>而<code>FPlatformProperties</code>的<code>typedef</code>是定义在<code>Core/Public/HAL/PlatformProperties.h</code>中。</p>
<h2 id="COMPILED-PLATFORM-HEADER"><a href="#COMPILED-PLATFORM-HEADER" class="headerlink" title="COMPILED_PLATFORM_HEADER"></a>COMPILED_PLATFORM_HEADER</h2><p>在UE4.22之前，UE的跨平台库的实现方式都是创建一个泛型平台类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPlatformUtils</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后每个平台实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Windows/WindowsPlatformUtils.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FWindowsPlatformUtils</span>:</span><span class="keyword">public</span> FGenericPlatformUtils</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//doSomething...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> FWindowsPlatformUtils FPlatformUtils;</span><br></pre></td></tr></table></figure>

<p>在UE4.22之前，需要使用下面这种方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PlatformUtils.h</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_IOS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IOS/IOSPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_WINDOWS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/WindowsPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_MAC</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Mac/MacPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>需要手动判断每个平台再进行包含，也是比较麻烦的，在4.23之后，UE引入了一个宏：<code>COMPILED_PLATFORM_HEADER</code>，可以把上面的包含简化为下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> COMPILED_PLATFORM_HEADER(PlatformUtils.h)</span></span><br></pre></td></tr></table></figure>

<p>它是定义在<code>Runtime/Core/Public/HAL/PreprocessorHelpers.h</code>下的宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the platform extension form &quot;PlatformHeader.h&quot;, not like below form</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the form &quot;Platform/PlatformHeader.h&quot;, like &quot;Windows/WindowsPlatformFile.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME/PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>注释已经比较说明作用了。而且它还有兄弟宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformName/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PLATFORM_HEADER_NAME/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>命名有规律是多么重要的一件事…</p>
<h2 id="遍历UCLASS或USTRUCT的反射成员"><a href="#遍历UCLASS或USTRUCT的反射成员" class="headerlink" title="遍历UCLASS或USTRUCT的反射成员"></a>遍历UCLASS或USTRUCT的反射成员</h2><p>可以通过<code>TFieldIterator</code>来遍历：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; <span class="built_in">PropertyIt</span>(ProxyClass); PropertyIt; ++PropertyIt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：4.25之后没有UProperty，变成了FProperty.</p>
</blockquote>
<h2 id="Lua-Metatable"><a href="#Lua-Metatable" class="headerlink" title="Lua:Metatable"></a>Lua:Metatable</h2><ul>
<li><a target="_blank" rel="noopener" href="http://lua-users.org/cgi-bin/wiki.pl?action=search&string=MetatableEvents&body=1">Metatable Events</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jimobuwu/p/8980808.html">Lua中的元表，弱表，面向对象</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/tdp100/a8494a2f922f7b6bbeaa">Lua 的metatable以及支持的metamethod</a></li>
</ul>
<h2 id="控制打包时ini的拷贝"><a href="#控制打包时ini的拷贝" class="headerlink" title="控制打包时ini的拷贝"></a>控制打包时ini的拷贝</h2><p>在<code>DeploymentContext.cs</code>中的<code>DeploymentContext</code>函数中，有以下两行代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the list of files which are whitelisted to be staged</span></span><br><span class="line">ReadConfigFileList(GameConfig, <span class="string">&quot;Staging&quot;</span>, <span class="string">&quot;WhitelistConfigFiles&quot;</span>, WhitelistConfigFiles);</span><br><span class="line">ReadConfigFileList(GameConfig, <span class="string">&quot;Staging&quot;</span>, <span class="string">&quot;BlacklistConfigFiles&quot;</span>, BlacklistConfigFiles);</span><br></pre></td></tr></table></figure>
<p>这两个数组会在<code>CopyBuildToStageingDirectory.Automation.cs</code>中使用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines if an individual config file should be staged</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span>The staging context<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigDir&quot;&gt;</span>Directory containing the config files<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigFile&quot;&gt;</span>The config file to check<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if the file should be staged, false otherwise<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Nullable&lt;<span class="built_in">bool</span>&gt; <span class="title">ShouldStageConfigFile</span>(<span class="params">DeploymentContext SC, DirectoryReference ConfigDir, FileReference ConfigFile</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  StagedFileReference StagedConfigFile = SC.GetStagedFileLocation(ConfigFile);</span><br><span class="line">  <span class="keyword">if</span> (SC.WhitelistConfigFiles.Contains(StagedConfigFile))</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (SC.BlacklistConfigFiles.Contains(StagedConfigFile))</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用途就是指定哪些config会添加到包体中。<br>用法如下(写到<code>DefaultGame.ini</code>中)：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Staging]</span></span><br><span class="line">+BlacklistConfigFiles=GWorldClient/Config/DefaultGameExtensionSettings.ini</span><br></pre></td></tr></table></figure>

<h2 id="CharCast的坑"><a href="#CharCast的坑" class="headerlink" title="CharCast的坑"></a>CharCast的坑</h2><p><code>CharCast</code>是定义在<code>StringConv.h</code>的模板函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Casts one fixed-width char type into another.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to convert.</span></span><br><span class="line"><span class="comment"> * @return The converted character.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> To, <span class="keyword">typename</span> From&gt;</span><br><span class="line"><span class="function">FORCEINLINE To <span class="title">CharCast</span><span class="params">(From Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	To Result;</span><br><span class="line">	FPlatformString::<span class="built_in">Convert</span>(&amp;Result, <span class="number">1</span>, &amp;Ch, <span class="number">1</span>, (To)UNICODE_BOGUS_CHAR_CODEPOINT);</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是对<code>FPlatformString::Convert</code>的转发调用。</p>
<blockquote>
<p>PS：<code>UNICODE_BOGUS_CHAR_CODEPOINT</code> 宏定义为<code>&#39;?&#39;</code>。</p>
</blockquote>
<p><code>FPlatformString::Convert</code>有两个版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Converts the [Src, Src+SrcSize) string range from SourceChar to DestChar and writes it to the [Dest, Dest+DestSize) range.</span></span><br><span class="line"><span class="comment"> * The Src range should contain a null terminator if a null terminator is required in the output.</span></span><br><span class="line"><span class="comment"> * If the Dest range is not big enough to hold the converted output, NULL is returned.  In this case, nothing should be assumed about the contents of Dest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Dest      The start of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param DestSize  The size of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param Src       The start of the string to convert.</span></span><br><span class="line"><span class="comment"> * @param SrcSize   The number of Src elements to convert.</span></span><br><span class="line"><span class="comment"> * @param BogusChar The char to use when the conversion process encounters a character it cannot convert.</span></span><br><span class="line"><span class="comment"> * @return          A pointer to one past the last-written element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> FORCEINLINE <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when SourceEncoding and DestEncoding are &#x27;compatible&#x27;, i.e. they&#x27;re the same type or equivalent (e.g. like UCS2CHAR and WIDECHAR are on Windows).</span></span><br><span class="line">  TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">&gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (DestSize &lt; SrcSize)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (DestEncoding*)<span class="built_in">Memcpy</span>(Dest, Src, SrcSize * <span class="built_in"><span class="keyword">sizeof</span></span>(SourceEncoding)) + SrcSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when the types are not compatible but the source is fixed-width, e.g. ANSICHAR-&gt;WIDECHAR.</span></span><br><span class="line">  !TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value &amp;&amp; TIsFixedWidthEncoding&lt;SourceEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">  &gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> int32 Size = DestSize &lt;= SrcSize ? DestSize : SrcSize;</span><br><span class="line">  <span class="keyword">bool</span> bInvalidChars = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">  &#123;</span><br><span class="line">    SourceEncoding SrcCh = Src[I];</span><br><span class="line">    Dest[I] = (DestEncoding)SrcCh;</span><br><span class="line">    bInvalidChars |= !CanConvertChar&lt;DestEncoding&gt;(SrcCh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bInvalidChars)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (!CanConvertChar&lt;DestEncoding&gt;(Src[I]))</span><br><span class="line">    &#123;</span><br><span class="line">      Dest[I] = BogusChar;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LogBogusChars&lt;DestEncoding&gt;(Src, Size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> DestSize &lt; SrcSize ? <span class="literal">nullptr</span> : Dest + Size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中关键的是第二个实现， 通过判断<code>CanConvertChar</code>来检测是否能够转换字符，如果不能转换就把转换结果设置为<code>BogusChar</code>，默认也就是<code>?</code>，这也是把不同编码的数据转换为FString有些会显示一堆<code>?</code>的原因。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests whether a particular character can be converted to the destination encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to test.</span></span><br><span class="line"><span class="comment"> * @return True if Ch can be encoded as a DestEncoding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DestEncoding, <span class="keyword">typename</span> SourceEncoding&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CanConvertChar</span><span class="params">(SourceEncoding Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">IsValidChar</span>(Ch) &amp;&amp; (SourceEncoding)(DestEncoding)Ch == Ch &amp;&amp; <span class="built_in">IsValidChar</span>((DestEncoding)Ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以：类似<code>LoadFileToString</code>去读文件如果编码不支持，那么读出来的数据和原始文件里是不一样的。</p>
<h2 id="bUsesSlate"><a href="#bUsesSlate" class="headerlink" title="bUsesSlate"></a>bUsesSlate</h2><p>在UE的<code>TargetRules</code>中有一项属性<code>bUsesSlate</code>，可以用来控制是否启用Slate，UE文档里的描述如下：</p>
<blockquote>
<p>Whether the project uses visual Slate UI (as opposed to the low level windowing/messaging, which is always available).</p>
</blockquote>
<p>但是我想知道是否启用对于项目打出的包有什么区别。经过测试发现，以移动端为例，<code>bUsesSlate</code>的值并不会影响<code>libUE4.so</code>的大小。</p>
<p>有影响的地方<strong>只在于</strong>打包时的pak大小，这一点可以从两次分别打包的<code>PakList*.txt</code>中得知，经过对比发现若<code>bUsesSlate=false</code>，则在打包时不会把<code>Engine\Content\Slate</code>下的图片资源打包。我把两个版本的<code>PakList*.txt</code>都放在<a href="index/UE4/Package/TargetRules_bUsesSlate_PackList.7z">这里</a>，有兴趣的可以看都是有哪些资源没有被打包。</p>
<p>下面这幅图是两个分别开启<code>bUsesSlate</code>的图（左侧<code>false</code>右侧<code>true</code>），可以看到只有<code>main.obb.webp</code>的大小不一样。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Package/ue4-package-bUsesSlate-diff.webp"></p>
<p>可以看到默认情况下<code>main.obb.webp</code>减小了大概6-7M，APK的大小也减小的差不多。</p>
<h2 id="Unreal-Plugin-Language"><a href="#Unreal-Plugin-Language" class="headerlink" title="Unreal Plugin Language"></a>Unreal Plugin Language</h2><p>在UE中为移动端添加第三方模块或者修改配置文件时经常会用到<code>AdditionalPropertiesForReceipt</code>，里面创建<code>ReceiptProperty</code>传入的<code>xml</code>文件就是UE的<code>Unreal Plugin Language</code>脚本。</p>
<p><code>ReceiptProperty</code>的平台名称在IOS和Android上是固定的，分别是<code>IOSPlugin</code>和<code>AndroidPlugin</code>，不可以指定其他的名字（详见代码<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs#L1153">UEDeployIOS.cs#L1153</a>和<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/1eb5d965b994b4bd59f31ec4158d42f13137ab1f/Engine/Source/Programs/UnrealBuildTool/Platform/Android/UEDeployAndroid.cs#L4303">UEDeployAndroid.cs#L4303</a>）。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdditionalPropertiesForReceipt.Add(<span class="keyword">new</span> ReceiptProperty(<span class="string">&quot;AndroidPlugin&quot;</span>, Path.Combine(ThirdPartyPath, <span class="string">&quot;Android/PlatformUtils_UPL_Android.xml&quot;</span>)));</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/34374244">虚幻插件语言参考(Android版)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs">Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs</a></li>
</ul>
<h2 id="打包时Paklist文件的生成"><a href="#打包时Paklist文件的生成" class="headerlink" title="打包时Paklist文件的生成"></a>打包时Paklist文件的生成</h2><p>UE打出Pak时，需要一个txt的参数传入，里面记录着要打到pak里的文件信息，直接使用UE的打包改文件会存储在：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\D+UnrealEngine+Epic+UE_4.23\PakList_microend_423-ios.txt</span><br></pre></td></tr></table></figure>

<p>类似的路径下。</p>
<p>这个文件生成的地方为：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\UnrealEngine\Epic\UE_4<span class="number">.24</span>\Engine\Source\Programs\AutomationTool\BuildGraph\Tasks\PakFileTask.cs</span><br></pre></td></tr></table></figure>

<p>在它的<code>Execute</code>函数里，有通过外部传入的<code>PakFileTaskParameters</code>的参数来把文件写入。</p>
<h2 id="ShaderStableInfo-scl-csv"><a href="#ShaderStableInfo-scl-csv" class="headerlink" title="ShaderStableInfo*.scl.csv"></a>ShaderStableInfo*.scl.csv</h2><p>在Cook的时候会在<code>Cooked/PLATFORM/PROJECT_NAME/Metadata/PipelineCaches</code>下生成类似下面这样的文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShaderStableInfo-Global-PCD3D_SM4.scl.csv</span><br><span class="line">ShaderStableInfo-Global-PCD3D_SM5.scl.csv</span><br><span class="line">ShaderStableInfo-GWorld-PCD3D_SM4.scl.csv</span><br><span class="line">ShaderStableInfo-GWorld-PCD3D_SM5.scl.csv</span><br></pre></td></tr></table></figure>

<p>里面记录了<code>FStableShaderKeyAndValue</code>结构的数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RenderCore/Public/ShaderCodeLibrary.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RENDERCORE_API</span> <span class="title">FStableShaderKeyAndValue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FCompactFullName ClassNameAndObjectPath;</span><br><span class="line">	FName ShaderType;</span><br><span class="line">	FName ShaderClass;</span><br><span class="line">	FName MaterialDomain;</span><br><span class="line">	FName FeatureLevel;</span><br><span class="line">	FName QualityLevel;</span><br><span class="line">	FName TargetFrequency;</span><br><span class="line">	FName TargetPlatform;</span><br><span class="line">	FName VFType;</span><br><span class="line">	FName PermutationId;</span><br><span class="line">	FSHAHash PipelineHash;</span><br><span class="line"></span><br><span class="line">	uint32 KeyHash;</span><br><span class="line">	FSHAHash OutputHash;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FStableShaderKeyAndValue</span>()</span><br><span class="line">		: <span class="built_in">KeyHash</span>(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作用有时间再来分析。</p>
<h2 id="PE的DLL为什么需要导入库？"><a href="#PE的DLL为什么需要导入库？" class="headerlink" title="PE的DLL为什么需要导入库？"></a>PE的DLL为什么需要导入库？</h2><p>在ELF中，共享库所有的全局函数和变量在默认情况下都可以被其他模块使用，也就是说ELF默认导出所有的全局符号。但是在DLL中不同，PE环境下需要显式地告诉编译器我们需要导出的符号，否则编译器就默认所有符号都不导出。</p>
<p>在MSVC中可以使用<code>__declspec(dllexport)</code>以及<code>__declspec(dllimport)</code>来分别表示导出本DLL的符号以及从别的DLL中导入符号。除了上面两个属性关键字还可以定义<code>def</code>文件来声明导入导出符号，def文件时连接器的链接脚本文件，可以当作链接器的输入文件，用于控制链接过程。</p>
<p>在我之前的一篇文章（<a href="https://imzlp.com/posts/18949/">动态链接库的使用：加载和链接</a>）中写到过DLL导入库的创建和使用，但是为什么DLL需要导入库而so不需要呢？前面已经回答，因为ELF是默认全导出的，PE是默认不导出的，但是我想知道原因是什么。</p>
<p>其实在有了上面的两个属性关键字之后不使用导入库也可以实现符号的导入和导出。</p>
<ol>
<li>当某个PE文件被加载时。Windows加载器的其中一个任务就是把所有需要导入的函数地址确定并且将导入表中的元素调整到正确的地址，以实现动态链接的过程，导入表中有IAT，其中的每个元素对应一个被导入的符号。</li>
<li>编译器无法知道一个符号是从外部导入的还是本模块中定义的，所以编译器是直接产生调用指令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL XXXXXXXXX</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在<code>__declspec</code>出现之前，微软提供的方法就是使用导入库，在这种情况下，对于导入函数的调用并不区分是导入函数还是导出函数，它统一地产生直接调用的指令，但是链接器在链接时会将导入函数的目标地址导向一小段桩代码(stub)，由这个桩代码再将控制权交给IAT中的真正目标。</li>
<li>所以导入库的作用就是将编译器产生的调用命令转发到导入表的IAT中目标地址。</li>
</ol>
<h2 id="UCLASS的config"><a href="#UCLASS的config" class="headerlink" title="UCLASS的config"></a>UCLASS的config</h2><p>如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implements the settings for the Paper2D plugin.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>(config=Engine, defaultconfig)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PAPER2D_API</span> <span class="title">UPaperRuntimeSettings</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_UCLASS_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables experimental *incomplete and unsupported* texture atlas groups that sprites can be assigned to</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, config, Category=Experimental)</span><br><span class="line">	<span class="keyword">bool</span> bEnableSpriteAtlasGroups;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables experimental *incomplete and unsupported* 2D terrain spline editing. Note: You need to restart the editor when enabling this setting for the change to fully take effect.</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, config, Category=Experimental, meta=(ConfigRestartRequired=<span class="literal">true</span>))</span><br><span class="line">	<span class="keyword">bool</span> bEnableTerrainSplineEditing;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables automatic resizing of various sprite data that is authored in texture space if the source texture gets resized (sockets, the pivot, render and collision geometry, etc...)</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, config, Category=Settings)</span><br><span class="line">	<span class="keyword">bool</span> bResizeSpriteDataToMatchTextures;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个类是个config的类，可以从ini中读取配置，关键的地方就是<code>UCLASS(Config=)</code>的东西，一般情况下是<code>Engine</code>/<code>Game</code>/<code>Editor</code>，它们的ini文件都是<code>Default*.ini</code>，如上面这个类，如果想要自己在ini中来指定它们这些参数的值，则需要写到项目的<code>Config/DefaultEngine.ini</code>中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Paper2D.PaperRuntimeSettings]</span></span><br><span class="line"><span class="attr">bEnableSpriteAtlasGroups</span> = <span class="literal">true</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>其中ini的<code>Section</code>为该配置类的<code>PackagePath</code>。</p>
<h2 id="操作剪贴板Clipboard"><a href="#操作剪贴板Clipboard" class="headerlink" title="操作剪贴板Clipboard"></a>操作剪贴板Clipboard</h2><p>有些需求是要能够访问到用户的粘贴板，来进行复制、和粘贴的功能。</p>
<p>在UE中访问粘贴板的方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FString PasteString;</span><br><span class="line"><span class="comment">// 从剪贴板读取内容</span></span><br><span class="line">FPlatformApplicationMisc::<span class="built_in">ClipboardPaste</span>(PasteString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把123456放入剪贴板</span></span><br><span class="line">FPlatformApplicationMisc::<span class="built_in">ClipboardCopy</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;123465&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>注意：<code>FPlatformApplicationMisc</code>是定义在<code>ApplicationCore</code>下的，使用时要包含该模块。</p>
<h2 id="在场景中Copy-Paste的实现"><a href="#在场景中Copy-Paste的实现" class="headerlink" title="在场景中Copy/Paste的实现"></a>在场景中Copy/Paste的实现</h2><p>在UE的场景编辑器中对一个选中的Actor进行<code>Ctrl+C</code>时把拷贝的内容粘贴到一个文本编辑器里可以看到类似以下的内容：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Begin Map</span><br><span class="line">   Begin Level</span><br><span class="line">      Begin Actor Class=/Script/Engine.Pawn Name=Pawn_1 Archetype=/Script/Engine.Pawn&#x27;/Script/Engine.Default__Pawn&#x27;</span><br><span class="line">         Begin Object Class=/Script/Engine.SceneComponent Name=&quot;DefaultSceneRoot&quot;</span><br><span class="line">         End Object</span><br><span class="line">         Begin Object Name=&quot;DefaultSceneRoot&quot;</span><br><span class="line">            RelativeLocation=(X=600.000000,Y=280.000000,Z=150.000000)</span><br><span class="line">            bVisualizeComponent=True</span><br><span class="line">            CreationMethod=Instance</span><br><span class="line">         End Object</span><br><span class="line">         RootComponent=SceneComponent&#x27;&quot;DefaultSceneRoot&quot;&#x27;</span><br><span class="line">         ActorLabel=&quot;Pawn&quot;</span><br><span class="line">         InstanceComponents(0)=SceneComponent&#x27;&quot;DefaultSceneRoot&quot;&#x27;</span><br><span class="line">      End Actor</span><br><span class="line">   End Level</span><br><span class="line">Begin Surface</span><br><span class="line">End Surface</span><br><span class="line">End Map</span><br></pre></td></tr></table></figure>
<p>它记录了当前拷贝的<code>Actor</code>的类，位置、以及与默认对象(CDO)不一致的属性。<br>拷贝上面的文本，在UE的场景编辑器里粘贴，会在场景里创建出来一个一摸一样的对象。</p>
<h3 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h3><p>在场景编辑器中执行<code>Ctrl+C</code>会把文本拷贝到粘贴板的实现为<code>UEditorEngine::CopySelectedActorsToClipboard</code>函数，其定义在<code>EditorServer.cpp</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copies selected actors to the clipboard.  Supports copying actors from multiple levels.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Doesn&#x27;t support copying prefab instance actors!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param InWorld				World to get the selected actors from</span></span><br><span class="line"><span class="comment"> * @param bShouldCut			If true, deletes the selected actors after copying them to the clipboard</span></span><br><span class="line"><span class="comment"> * @param bIsMove				If true, this cut is part of a move and the actors will be immediately pasted</span></span><br><span class="line"><span class="comment"> * @param bWarnAboutReferences	Whether or not to show a modal warning about referenced actors that may no longer function after being moved</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopySelectedActorsToClipboard</span><span class="params">( UWorld* InWorld, <span class="keyword">const</span> <span class="keyword">bool</span> bShouldCut, <span class="keyword">const</span> <span class="keyword">bool</span> bIsMove = <span class="literal">false</span>, <span class="keyword">bool</span> bWarnAboutReferences = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用栈为：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-editor-copy-selected-actor-impl-call-stack.webp"></p>
<p>之后又会调用<code>UUnrealEngine::edactCopySelected</code>函数（<code>EditorActor.cpp</code>）,在<code>edactCopySelected</code>中通过构造出一个<code>FExportObjectInnerContext</code>的对象收集到所选择的对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">   Actor adding/deleting functions.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSelectedActorExportObjectInnerContext</span> :</span> <span class="keyword">public</span> FExportObjectInnerContext</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">FSelectedActorExportObjectInnerContext</span>()</span><br><span class="line">		<span class="comment">//call the empty version of the base class</span></span><br><span class="line">		: <span class="built_in">FExportObjectInnerContext</span>(<span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// For each object . . .</span></span><br><span class="line">		<span class="keyword">for</span> (UObject* InnerObj : TObjectRange&lt;UObject&gt;(RF_ClassDefaultObject, <span class="comment">/** bIncludeDerivedClasses */</span> <span class="literal">true</span>, <span class="comment">/** IternalExcludeFlags */</span> EInternalObjectFlags::PendingKill))</span><br><span class="line">		&#123;</span><br><span class="line">			UObject* OuterObj = InnerObj-&gt;<span class="built_in">GetOuter</span>();</span><br><span class="line"></span><br><span class="line">			<span class="comment">//assume this is not part of a selected actor</span></span><br><span class="line">			<span class="keyword">bool</span> bIsChildOfSelectedActor = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">			UObject* TestParent = OuterObj;</span><br><span class="line">			<span class="keyword">while</span> (TestParent)</span><br><span class="line">			&#123;</span><br><span class="line">				AActor* TestParentAsActor = Cast&lt;AActor&gt;(TestParent);</span><br><span class="line">				<span class="keyword">if</span> (TestParentAsActor &amp;&amp; TestParentAsActor-&gt;<span class="built_in">IsSelected</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					bIsChildOfSelectedActor = <span class="literal">true</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				TestParent = TestParent-&gt;<span class="built_in">GetOuter</span>();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (bIsChildOfSelectedActor)</span><br><span class="line">			&#123;</span><br><span class="line">				InnerList* Inners = ObjectToInnerMap.<span class="built_in">Find</span>(OuterObj);</span><br><span class="line">				<span class="keyword">if</span> (Inners)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Add object to existing inner list.</span></span><br><span class="line">					Inners-&gt;<span class="built_in">Add</span>( InnerObj );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Create a new inner list for the outer object.</span></span><br><span class="line">					InnerList&amp; InnersForOuterObject = ObjectToInnerMap.<span class="built_in">Add</span>(OuterObj, <span class="built_in">InnerList</span>());</span><br><span class="line">					InnersForOuterObject.<span class="built_in">Add</span>(InnerObj);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>再通过<code>UExporter::ExportToOutputDevice</code>进行序列化操作，就得到了该对象序列化之后的字符串。</p>
<h3 id="Paste"><a href="#Paste" class="headerlink" title="Paste"></a>Paste</h3><p>把文本拷贝之后在场景中粘贴会创建出Actor的核心实现为<code>UEditorEngine::PasteSelectedActorFromClipboard</code>函数，其定义在<code>EditorServer.cpp</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pastes selected actors from the clipboard.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Doesn&#x27;t support pasting prefab instance actors!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param InWorld		World to get the selected actors from</span></span><br><span class="line"><span class="comment"> * @param PasteTo		Where to paste the content too</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PasteSelectedActorsFromClipboard</span><span class="params">( UWorld* InWorld, <span class="keyword">const</span> FText&amp; TransDescription, <span class="keyword">const</span> EPasteTo PasteTo )</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用栈为：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-editor-paste-selected-actor-impl-call-stack.webp"></p>
<h2 id="检测字符数组是UTF8还是GBK编码"><a href="#检测字符数组是UTF8还是GBK编码" class="headerlink" title="检测字符数组是UTF8还是GBK编码"></a>检测字符数组是UTF8还是GBK编码</h2><p>基于上个笔记的需求，所以要能够区分一个字符数组是使用UTF8还是GBK编码的。</p>
<h3 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h3><p>gbk 的第一字节是高位为 1 的，第 2 字节可能高位为 0 。这种情况一定是 gbk ，因为 UTF8 对 &gt;127 的编码一定每个字节高位为 1 。</p>
<h3 id="UTF8"><a href="#UTF8" class="headerlink" title="UTF8"></a>UTF8</h3><p>UTF8 是兼容 ascii 的，所以 0~127 就和 ascii 完全一致了。</p>
<p>UTF8的中文文字一定编码成三个字节：</p>
<p>汉字以及汉字标点（包括日文汉字等），在 UTF8 中一定被编码成：<code>1110**** 10****** 10******</code>。</p>
<p>如上个笔记中的<code>鸡</code>字，其UTF8的编码为<code>11101001 1011100 10100001</code>，符合上面的规则。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>相关资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2010/06/detect_utf-8_gbk.html">区分一个包含汉字的字符串是 UTF-8 还是 GBK</a></li>
</ul>
<p>工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.mytju.com/classcode/tools/encode_utf8.asp">查看字符编码(UTF8)</a></li>
</ul>
<h2 id="UTF8编码的字符数组转FString"><a href="#UTF8编码的字符数组转FString" class="headerlink" title="UTF8编码的字符数组转FString"></a>UTF8编码的字符数组转FString</h2><p>从网络收过来的数据流是以字节形式接收的，但是对于不同使用<code>UTF8</code>或者<code>GBK</code>编码的字符来说，他们是由多个字节组成的，如<code>鸡</code>这个汉字的UTF8编码为<code>0xE9B8A1</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> Chicken[] = &#123; (<span class="keyword">char</span>)<span class="number">0xE9</span>,(<span class="keyword">char</span>)<span class="number">0xB8</span>,(<span class="keyword">char</span>)<span class="number">0xA1</span>,`\<span class="number">0</span>`&#125;;</span><br><span class="line"><span class="function">FString <span class="title">ChickenChnese</span><span class="params">(UTF8_TO_TCHAR(Name))</span></span>;</span><br></pre></td></tr></table></figure>

<p>因为<code>Chicken</code>这个数据有四个字节，前三个字节是<code>鸡</code>这个汉字的UTF8编码，最后一个字节是<code>\0</code>表示结束符。</p>
<p>之前想的是把这个数组再表示为UTF8的字符，但是这里混淆了一个概念：这个数组本身就是UTF8编码的信息了，所以应该是把它从UTF8转换为<code>TCHAR</code>表示的字符，要使用UE的<code>UTF8_TO_CHAR</code>。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/utf8-character-of-array-to-tchar.webp"></p>
<p>因为UTF8兼容ASCII编码，所以可以混用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ANSICHAR TestArray[] = &#123; <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>, (<span class="keyword">char</span>)<span class="number">0xE9</span>,(<span class="keyword">char</span>)<span class="number">0xB8</span>,(<span class="keyword">char</span>)<span class="number">0xA1</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// abc鸡de1</span></span><br><span class="line"><span class="function">FString <span class="title">TestStr</span><span class="params">(UTF8_TO_TCHAR(TestArray))</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="编辑器SpawnActor"><a href="#编辑器SpawnActor" class="headerlink" title="编辑器SpawnActor"></a>编辑器SpawnActor</h2><p>可以使用<code>UEditorEngine</code>中的<code>SpawnActor</code>函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Editor/Private/EditorEngine.cpp</span></span><br><span class="line"><span class="function">AActor* <span class="title">UEditorEngine::AddActor</span><span class="params">(ULevel* InLevel, UClass* Class, <span class="keyword">const</span> FTransform&amp; Transform, <span class="keyword">bool</span> bSilent, EObjectFlags InObjectFlags)</span></span></span><br></pre></td></tr></table></figure>

<p>使用这个方法Spawn出来的会自动选中。</p>
<h2 id="EditCondition支持表达式"><a href="#EditCondition支持表达式" class="headerlink" title="EditCondition支持表达式"></a>EditCondition支持表达式</h2><p>在UPROPERTY里可以对一个属性被设置的条件，比如某个bool开启时才允许编辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">URPOPERTY</span>()</span><br><span class="line"><span class="keyword">bool</span> EnableInput;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(meta=(EditCondition=<span class="string">&quot;EnableInput&quot;</span>))</span><br><span class="line">EInputMode InputMode;</span><br></pre></td></tr></table></figure>
<p>也可以对其使用取反操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">URPOPERTY</span>()</span><br><span class="line"><span class="keyword">bool</span> EnableInput;</span><br><span class="line"><span class="built_in">UPROPERTY</span>(meta=(EditCondition=<span class="string">&quot;!EnableInput&quot;</span>))</span><br><span class="line">EInputMode InputMode;</span><br></pre></td></tr></table></figure>

<p>UE的文档介绍里说<code>EditContion</code>是支持表达式的：</p>
<blockquote>
<p>The EditCondition meta tag is no longer limited to a single boolean property. It is now evaluated using a full-fledged expression parser, meaning you can include a full C++ expression.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Properties/Specifiers/index.html">Property Specifiers</a></li>
</ul>
<h2 id="获取资源依赖关系"><a href="#获取资源依赖关系" class="headerlink" title="获取资源依赖关系"></a>获取资源依赖关系</h2><p>最近有个需求要获取UE里资源的引用关系，类似UE的<code>Reference Viewer</code>的操作，既然知道了Reference Viewer中有想要的那么就去它的模块里面翻代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine\Plugins\Editor\AssetManagerEditor\Source\AssetManagerEditor\Private\ReferenceViewer\EdGraph_ReferenceViewer.cpp</span></span><br><span class="line"><span class="function">UEdGraphNode_Reference* <span class="title">UEdGraph_ReferenceViewer::RecursivelyConstructNodes</span><span class="params">(<span class="keyword">bool</span> bReferencers, UEdGraphNode_Reference* RootNode, <span class="keyword">const</span> TArray&lt;FAssetIdentifier&gt;&amp; Identifiers, <span class="keyword">const</span> FIntPoint&amp; NodeLoc, <span class="keyword">const</span> TMap&lt;FAssetIdentifier, int32&gt;&amp; NodeSizes, <span class="keyword">const</span> TMap&lt;FName, FAssetData&gt;&amp; PackagesToAssetDataMap, <span class="keyword">const</span> TSet&lt;FName&gt;&amp; AllowedPackageNames, int32 CurrentDepth, TSet&lt;FAssetIdentifier&gt;&amp; VisitedNames)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="string">&quot;AssetRegistry&quot;</span>);</span><br><span class="line">  TArray&lt;FAssetIdentifier&gt; ReferenceNames;</span><br><span class="line">  TArray&lt;FAssetIdentifier&gt; HardReferenceNames;</span><br><span class="line">  <span class="keyword">if</span> ( bReferencers )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FAssetIdentifier&amp; AssetId : Identifiers)</span><br><span class="line">    &#123;</span><br><span class="line">      AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetReferencers</span>(AssetId, HardReferenceNames, <span class="built_in">GetReferenceSearchFlags</span>(<span class="literal">true</span>));</span><br><span class="line">      AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetReferencers</span>(AssetId, ReferenceNames, <span class="built_in">GetReferenceSearchFlags</span>(<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FAssetIdentifier&amp; AssetId : Identifiers)</span><br><span class="line">    &#123;</span><br><span class="line">      AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetDependencies</span>(AssetId, HardReferenceNames, <span class="built_in">GetReferenceSearchFlags</span>(<span class="literal">true</span>));</span><br><span class="line">      AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetDependencies</span>(AssetId, ReferenceNames, <span class="built_in">GetReferenceSearchFlags</span>(<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>FAssetRegistryModule</code>模块去拿就可以了，<code>FAssetIdentifier</code>中只需要有<code>PackageName</code>即可，这个PackageName是<code>LongPackageName</code>，不是<code>PackagePath</code>。</p>
<h2 id="地图的存储和加载"><a href="#地图的存储和加载" class="headerlink" title="地图的存储和加载"></a>地图的存储和加载</h2><p>存储栈:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Level/ue4-save-level-call-stack.webp"></p>
<p>加载栈:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Level/ue4-load-level-call-stack.webp"></p>
<h2 id="DataTable"><a href="#DataTable" class="headerlink" title="DataTable"></a>DataTable</h2><p>要创建一个可以用于创建<code>DataTable</code>的结构需要继承于<code>FTableRowBase</code>，如果要在编辑器中可编辑，该结构中的UPROPERTY不要包含<code>Category</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/DataTable.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EnemyProperty.generated.h&quot;</span></span></span><br><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FRoleProperty</span> :</span> <span class="keyword">public</span> FTableRowBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 AttackValue;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 Defense;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 HP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="FCommandLine过滤模式"><a href="#FCommandLine过滤模式" class="headerlink" title="FCommandLine过滤模式"></a>FCommandLine过滤模式</h2><p><code>FCommandLine</code>是UE封装的启动参数的管理类，在<code>Launch</code>模块下的<code>FEngineLoop::PreInit</code>中被初始化(<code>FCommandLine::Set</code>)为程序启动的<code>CmdLine</code>。<br><code>FCommandLine</code>支持<code>Append</code>和<code>Parser</code>这是比较常用的功能，但是今天要说的是另外一个：CommandLine的白名单和黑名单模式。<br>考虑这样的需求：在游戏开发阶段，有很多参数可以在启动时配置，方便测试，但是在发行时需要把启动时从命令行读取配置的功能给去掉，强制使用我们设置的默认参数。</p>
<h3 id="OVERRIDE-COMMANDLINE-WHITELIST"><a href="#OVERRIDE-COMMANDLINE-WHITELIST" class="headerlink" title="OVERRIDE_COMMANDLINE_WHITELIST"></a>OVERRIDE_COMMANDLINE_WHITELIST</h3><p>怎么才是最简单的办法？其实这一点根本不需要自己去处理这部分的内容，因为<code>FCommandLine</code>支持白名单模式。<br>开启的方法为在<code>target.cs</code>中增加<code>WANTS_COMMANDLINE_WHITELIST</code>宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>如果只开启这个，则默认情况下不允许接收任何外部传入的参数，但具有默认的参数<code>-fullscreen /windowed</code>。<br>当然，我们可以自己指定这个<code>WHITLIST</code>，那么就是在<code>target.cs</code>中使用<code>OVERRIDE_COMMANDLINE_WHITELIST</code>宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这样就只有我们指定的这些参数才可以在运行时接收，防止玩家恶意传递参数导致游戏出错。<br>这部分的代码是写在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Private/Misc/CommandLine.cpp">Misc/CommandLine.cpp</a>中的。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// target.cs</span></span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里只指定了<code>-e</code>/<code>-c</code>两个参数，如果程序在启动时被指定了其他的参数，如：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4.21_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>在<code>FCommandLine::Get()</code>只能得到<code>-e</code>和<code>-c</code>，<code>-d</code>和exe路径都被丢弃了，只能用在指定开关，不能用来传递值。</p>
<h3 id="FILTER-COMMANDLINE-LOGGING"><a href="#FILTER-COMMANDLINE-LOGGING" class="headerlink" title="FILTER_COMMANDLINE_LOGGING"></a>FILTER_COMMANDLINE_LOGGING</h3><p>还可以在<code>target.cs</code>中指定<code>FILTER_COMMANDLINE_LOGGING</code>来控制对<code>FCommandLine::LoggingCmdLine</code>的过滤：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>它会在程序从命令行中接收的参数中过滤所指定的参数，类似于参数的黑名单。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.<span class="built_in">Add</span>(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在运行时传入参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>得到的是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -d</span><br></pre></td></tr></table></figure>

<p><code>-e</code>和<code>-c</code>被过滤掉了。</p>
<h2 id="PIE的坑"><a href="#PIE的坑" class="headerlink" title="PIE的坑"></a>PIE的坑</h2><p>UE在PIE中运行是和Standalone模式是不同的，在PIE运行时可以通过监听<code>FEditorDelegates</code>下的<code>PreBeginPIE</code>/<code>BeginPIE</code>以及<code>PrePIEEnded</code>/<code>EndPIE</code>等代理来检测PIE模式下的游戏运行和退出。<br><strong>但是</strong>，PIE的<code>PrePIEEnded</code>和<code>EndPIE</code>都是先于<code>GameInstance</code>的<code>Shutdown</code>函数的，在一些情况下，如果PIEEnd中做了一些清理操作而在GameInstance的Shutdown函数中有使用的话会有问题。<br>解决办法为绑定<code>FGameDelegates</code>的<code>EndPlayMapDelegate</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FGameDelegates::<span class="built_in">Get</span>().<span class="built_in">GetEndPlayMapDelegate</span>().<span class="built_in">AddRaw</span>(GLuaCxt, &amp;FLuaContext::OnEndPlayMap);</span><br></pre></td></tr></table></figure>

<h2 id="UPARAM-ref"><a href="#UPARAM-ref" class="headerlink" title="UPARAM(ref)"></a>UPARAM(ref)</h2><p>UE中使用<code>TArray&lt;bool&gt;&amp;</code>是作为返回值的，在蓝图中就是在节点右侧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ModifySomeArray</span><span class="params">(TArray&lt;<span class="keyword">bool</span>&gt; &amp;BooleanArray)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果想要传入已有的对象，则需要<code>UPARAM(ref)</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ModifySomeArray</span><span class="params">(UPARAM(ref) TArray&lt;<span class="keyword">bool</span>&gt; &amp;BooleanArray)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/UPARAM">UPARAM</a></li>
</ul>
<h2 id="the-file-couldn’t-be-loaded-by-the-OS"><a href="#the-file-couldn’t-be-loaded-by-the-OS" class="headerlink" title="the file couldn’t be loaded by the OS."></a>the file couldn’t be loaded by the OS.</h2><p>启动引擎时如果具有类似的Crash信息：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleManager: Unable to load module &#x27;G:/UE_4.22/Engine/Binaries/Win64/UE4Editor-MeshUtilities.dll&#x27; because the file couldn&#x27;t be loaded by the OS.</span><br></pre></td></tr></table></figure>
<p>把引擎的<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Basics/DerivedDataCache/index.html">DDC</a>删掉之后重启引擎即可。<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Basics/DerivedDataCache/index.html">DDC</a>的目录：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Epic Games\UE_4.22\Engine\DerivedDataCache</span><br><span class="line">C:\Users\imzlp\AppData\Local\UnrealEngine\4.22\DerivedDataCache</span><br></pre></td></tr></table></figure>
<p>把上面两个目录都删掉。<br>如果启动项目时提示的是工程中的模块，则把工程和插件下的<code>Binaries</code>和<code>Intermediate</code>都删了重新编译生成。</p>
<h2 id="PURE-VIRTUAL-macro"><a href="#PURE-VIRTUAL-macro" class="headerlink" title="PURE_VIRTUAL macro"></a>PURE_VIRTUAL macro</h2><p>在UE的代码中看到一些虚函数使用UE的<code>PURE_VIRTUAL</code>宏来指定，类似下面这种代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GameInitialize</span><span class="params">()</span> <span class="title">PURE_VIRTUAL</span><span class="params">(IINetGameInstance::GameInitialize,)</span></span>;</span><br></pre></td></tr></table></figure>
<p>看起来有点奇怪，看一下它的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CHECK_PUREVIRTUALS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PURE_VIRTUAL(func,extra) =0;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PURE_VIRTUAL(func,extra) &#123; LowLevelFatalError(TEXT(<span class="meta-string">&quot;Pure virtual not implemented (%s)&quot;</span>), TEXT(#func)); extra &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>相当于给了纯虚函数一个默认实现，在错误调用时能够看到信息。</p>
<h2 id="成员模板函数特化不要放在class-scope"><a href="#成员模板函数特化不要放在class-scope" class="headerlink" title="成员模板函数特化不要放在class scope"></a>成员模板函数特化不要放在class scope</h2><p>如下面代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span>&lt;&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// do something</span></span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>声明了模板函数<code>operator&gt;&gt;</code>，而且添加了一个bool的特化，这个代码在Windows下编译没有问题，但是在打包Android时会产生错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: explicit specialization of &#x27;operator&gt;&gt;&#x27; in class scope</span><br></pre></td></tr></table></figure>

<p>说时显式特化写在了类作用域内，解决办法是把特化的版本放到类之外：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line">Template&amp; Template::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9487034/how-can-i-use-template-specialization-in-c-classes-and-why-this-doesnt-compi">How can I use template specialization in c++ classes, and why this doesn’t compile?</a></li>
</ul>
<h2 id="Runtime模块包含Editor模块的错误"><a href="#Runtime模块包含Editor模块的错误" class="headerlink" title="Runtime模块包含Editor模块的错误"></a>Runtime模块包含Editor模块的错误</h2><p>如果打包时有下列错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnrealBuildTool.Main: ERROR: Missing precompiled manifest for &#x27;EditorWidgets&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in EditorWidgets.build.cs to override.</span><br><span class="line">UnrealBuildTool.Main: BuildException: Missing precompiled manifest for &#x27;EditorWidgets&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in EditorWidgets.build.cs to override.</span><br></pre></td></tr></table></figure>
<p>我这里的错误提示是<code>EditorWidgets</code>是个预编译模块。<br>这个错误的原因是在<code>Runtime</code>的模块中添加了<code>UnrealEd</code>模块，因为它是属于Editor的，打包时不会把Editor的模块打包进来，所以就会有现在错误。</p>
<blockquote>
<p>注意：一定不要在Runtime的模块中包含Editor或者Developer的模块，这个是Epic的EULA限制，如果需要用到Editor或者Developer的东西，则自己在插件或者工程下新建一个<code>Editor</code>或者<code>Developer</code>才行。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/unrealengine/comments/d7grqb/build_error_missing_precompiled_manifest_for/">BUILD ERROR: Missing precompiled manifest for ‘EditorWidgets’.</a></li>
<li><a href="https://imzlp.com/posts/9050/">分析UBT中EULA的内容分发限制</a></li>
</ul>
<h2 id="获取蓝图添加的所有接口"><a href="#获取蓝图添加的所有接口" class="headerlink" title="获取蓝图添加的所有接口"></a>获取蓝图添加的所有接口</h2><p>拿到<code>UBlueprint</code>之后可以通过获取<code>ImplementedInterfaces</code>来访问：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; InterfaceItem : Blueprint-&gt;ImplementedInterfaces)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (InterfaceItem.Interface.<span class="built_in">Get</span>()-&gt;<span class="built_in">IsChildOf</span>(UUnLuaInterface::<span class="built_in">StaticClass</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		bImplUnLuaInterface = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="UnrealFrontEnd-DeviceLog"><a href="#UnrealFrontEnd-DeviceLog" class="headerlink" title="UnrealFrontEnd DeviceLog"></a>UnrealFrontEnd DeviceLog</h2><p>之前在PC上看移动端的Log的方式是是用Logcat，但是发现UE其实提供了工具，就是UnrealFrontLog中的<code>DeviceLog</code>：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/unreal-front-end-device-log.webp"><br>最下面的那一行也可以执行控制台命令，很方便。</p>
<blockquote>
<p>PS：我测试了在PC上连接Android设备没有问题，但是连上IOS不显示，在Mac上连接IOS没有问题，不过不显示Log，但可以执行命令。</p>
</blockquote>
<h2 id="获取某个类的所有子类"><a href="#获取某个类的所有子类" class="headerlink" title="获取某个类的所有子类"></a>获取某个类的所有子类</h2><p>查找所有继承自某个UClass的类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/UObjectIterator.h&quot;</span></span></span><br><span class="line"><span class="function">TArray&lt;UClass*&gt; <span class="title">UNetGameInstance::GetAllSubsystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;UClass*&gt; result;</span><br><span class="line">	<span class="keyword">for</span> (TObjectIterator&lt;UClass&gt; It; It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (It-&gt;<span class="built_in">IsChildOf</span>(UNetSubsystemBase::<span class="built_in">StaticClass</span>()) &amp;&amp; !It-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_Abstract))</span><br><span class="line">		&#123;</span><br><span class="line">			result.<span class="built_in">Add</span>(*It);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-22-3打包IOS-Crash的问题"><a href="#4-22-3打包IOS-Crash的问题" class="headerlink" title="4.22.3打包IOS Crash的问题"></a>4.22.3打包IOS Crash的问题</h2><p>在下列环境下：</p>
<ol>
<li>macOS Mojave 10.14.5</li>
<li>XCode 11.2.1(11B500)</li>
<li>UE4.22.3</li>
<li>iPhone 7 IOS13.3.1</li>
</ol>
<p>在这个环境下打包出来的IOS在运行时会Crash，但是换到4.23.1就没有这个问题。<br>Crash的Log:<a href="index/UE4/IOS/GWorld_2020_3_12_6_58_PM.crash">GWorld 2020-3-12 6-58-PM.crash</a></p>
<h2 id="IOS贴图非2次幂的显示问题"><a href="#IOS贴图非2次幂的显示问题" class="headerlink" title="IOS贴图非2次幂的显示问题"></a>IOS贴图非2次幂的显示问题</h2><p>默认情况下在iOS里使用非2次幂大小的贴图会有下列问题：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-not-power-of-two.webp"><br>提示的是<em>See Power of Two Settings in Texture Editor</em>。<br>这是因为使用到的贴图的大小不是2的次幂。</p>
<p>解决办法：<br>在编辑器中打开Texture，将<code>Texture</code>-<code>Power Of Two Mode</code>改成<code>Pad to power of two</code>，这样会填充贴图为2次幂大小。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-set-as-power-of-two-mode.webp"></p>
<p>如果不想要使用<code>Power Of Two Mode</code>也可以修改<code>Compression</code>-<code>Compression Settings</code>为<code>USerInterface2D</code>，但是非2次幂的贴图大小会有性能问题（在iPhone6(A7处理器)中只能设置为填充才可以）。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/IOS/texture-set-compression-as-userinterface.webp"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Content/Types/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a></li>
</ul>
<h2 id="ES2-0最多75根骨骼的限制"><a href="#ES2-0最多75根骨骼的限制" class="headerlink" title="ES2.0最多75根骨骼的限制"></a>ES2.0最多75根骨骼的限制</h2><p>因为移动平台缺少32位的索引支持，所以最多支持65k个顶点和75根骨骼。<br>但是可以通过拆分骨骼模型的材质来实现，每个材质支持75根，这是单次drawcall的限制，分成不同的批次就可以了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Platforms/Mobile/Meshes/index.html">Meshes for Mobile Platforms</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/rendering/43185-character-s-skeletal-mesh-disappears-under-mobile-html-5-preview-rendering-level">Character’s skeletal mesh disappears under Mobile/HTML 5 Preview Rendering Level</a></li>
</ul>
<blockquote>
<p>PS:不能用uniform了，换其他方式，比如VTF，也可以实现超过75根骨骼。</p>
</blockquote>
<p>在UE中如果在ES2.0中（目前UE的ES3.0也是75）想要更高的骨骼数量，需要拆分模型使用的材质：</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<p>材质和模型插槽的关系：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blender.stackexchange.com/questions/75816/how-to-distinguish-material-and-material-slot">How to distinguish material and material slot</a></li>
</ul>
<h2 id="使用HTTP请求下载文件的坑和技巧"><a href="#使用HTTP请求下载文件的坑和技巧" class="headerlink" title="使用HTTP请求下载文件的坑和技巧"></a>使用HTTP请求下载文件的坑和技巧</h2><p>使用HTTP可以请求下载文件，response的结果就是文件的内容。<br>在下载一个文件之前可以先使用<code>HEAD</code>请求来只获取头，可以从<code>Content-Length</code>头获取到文件的大小。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// head request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpHeadRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">OnHeaderReceived</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadHeaderReceived);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadComplete);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">SetURL</span>(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;HEAD&quot;</span>));</span><br><span class="line">HttpHeadRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br></pre></td></tr></table></figure>
<p>在UE中需要通过监听HTTP请求的<code>OnHeaderReceived</code>派发来获得想要的头数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDownloadProxy::OnRequestHeadHeaderReceived</span><span class="params">(FHttpRequestPtr RequestPtr, <span class="keyword">const</span> FString&amp; InHeaderName, <span class="keyword">const</span> FString&amp; InNewHeaderValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InHeaderName.<span class="built_in">Equals</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Content-Length&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		InternalDownloadFileInfo.Size = UKismetStringLibrary::<span class="built_in">Conv_StringToInt</span>(InNewHeaderValue);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以用<code>Get</code>方法来请求文件了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnRequestProgress</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadProcess, bIsSlice?EDownloadType::Slice:EDownloadType::Start);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadComplete);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetURL</span>(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GET&quot;</span>));</span><br><span class="line">RangeArgs = <span class="built_in">TEXT</span>(<span class="string">&quot;bytes=0-&quot;</span>)+FString::<span class="built_in">FromInt</span>(FileTotalByte);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">SetHeader</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Range&quot;</span>), RangeArgs);</span><br><span class="line">HttpRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br></pre></td></tr></table></figure>
<p>其中Range头的格式为：<code>Byte=0-</code>指请求整个文件的大小，<code>Byte=0-99</code>则是请求前100byte，<strong>注意请求的范围不要超过文件大小</strong>，不然会有400错误。<br>通过控制HTTP请求的<code>Range</code>头，我们可以指定下载文件的任意部分，可以实现暂停继续/分片下载。</p>
<blockquote>
<p>在UE中使用HTTP请求一个大文件的时候，如果该请求没有结束就去拿response的结果一定要注意一个问题：那就是Response的Content数据<code>Payload</code>是一个<code>TArray</code>动态数组，当Content的内容不断地被写入，会导致容器的<code>Reserve</code>也就是内存重新分配，获取该数组的内存地址是非常危险的。</p>
</blockquote>
<p>所以建议在HTTP请求时先对response的Content的<code>Payload</code>进行<code>Reserve</code>使其能够容纳足够数量的数据，缺点就是会一次性占用整个文件的内存。<br>解决内存占用的办法就是通过<code>Http</code>请求的<code>Range</code>来实现分片下载（也就是把一个大文件分成数个小块，一块一块地下载），从而降低内存占用，</p>
<p>当下载文件后，通常还有进行文件校验的操作，等文件下载完之后再执行校验（如MD5计算）时间会很长，所以要解决校验的时间问题，想过开一个线程去计算，但是开线程只解决了不阻塞主线程，不会加速MD5的计算过程，后来想到<code>MD5</code>是摘要计算，进而联想到可不可以边下边进行MD5计算，根据<strong>没有全新的轮子定理</strong>（我瞎掰的），我查到了OpenSSL中的MD5实现支持使用<code>MD5_Update</code>来增量计算，所以这个问题就迎刃而解了，具体看我前面的笔记<a href="https://imzlp.com/notes/ue/#MD5%E7%9A%84%E5%88%86%E7%89%87%E6%A0%A1%E9%AA%8C">MD5的分片校验</a>。</p>
<p>基于上面这些内容，可以实现一个简陋的下载器功能了，可作为游戏中的下载组件，虽然看似简单，但是设计一个合理的结构和没有bug的版本还是要花点功夫的。<br>我把上面介绍的内容写成了一个插件：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-download-proxy-plugin-ui.webp"></p>
<p>HTTP的分片请求在服务端的Log:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/use-http-request-download-file-server-info.webp"></p>
<p>资料文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests">从服务器端请求特定的范围</a></li>
</ul>
<h2 id="MD5的分片校验"><a href="#MD5的分片校验" class="headerlink" title="MD5的分片校验"></a>MD5的分片校验</h2><p>有一个需求：对下载的文件执行MD5运算。但是当文件比较大的时候如果等文件下载完再执行校验耗时会很长。</p>
<p>所以我想有没有办法边下边进行MD5的计算，因为知道MD5是基于摘要的，所以觉得边下边校验的方法应该可行。我查了一下相关的实现，找到<code>OpenSSL</code>中有相关的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// openssl/md5.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_MD5_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_MD5_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/e_os2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_NO_MD5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> MD5 is disabled.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG has to be at least 32 bits wide. If it&#x27;s wider, then !</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG_LOG2 has to be defined along.			   !</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP32__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OPENSSL_SYS_CRAY) || defined(__ILP64__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG_LOG2 3</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * _CRAY note. I could declare short, but I have no idea what impact</span></span><br><span class="line"><span class="comment"> * does it have on performance on none-T3E machines. I could declare</span></span><br><span class="line"><span class="comment"> * int, but at least on C90 sizeof(int) can be chosen at compile time.</span></span><br><span class="line"><span class="comment"> * So I&#x27;ve chosen long...</span></span><br><span class="line"><span class="comment"> *					&lt;appro@fy.chalmers.se&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_CBLOCK	64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LBLOCK	(MD5_CBLOCK/4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_DIGEST_LENGTH 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MD5state_st</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	MD5_LONG A,B,C,D;</span><br><span class="line">	MD5_LONG Nl,Nh;</span><br><span class="line">	MD5_LONG data[MD5_LBLOCK];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num;</span><br><span class="line">	&#125; MD5_CTX;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_FIPS</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">private_MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">MD5</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *d, <span class="keyword">size_t</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *md)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5_Transform</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>其中提供的MD5计算可以分开操作的有三个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中的<code>MD5_Update</code>就是我们需要的函数。</p>
<p>所以使用的伪代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MD5_CTX Md5CTX;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Request</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MD5_Init</span>(&amp;Md5CTX);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TickRequestProgress</span><span class="params">(<span class="keyword">char</span>* InData,uint32 InLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MD5_Update</span>(&amp;Md5CTX,InData,InLength);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RequestCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="built_in">MD5_Final</span>(digest, &amp;Md5CTX);</span><br><span class="line">	<span class="keyword">char</span> md5string[<span class="number">33</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i)</span><br><span class="line">		std::<span class="built_in">sprintf</span>(&amp;md5string[i * <span class="number">2</span>], <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)digest[i]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// result</span></span><br><span class="line">    <span class="built_in">pritf</span>(<span class="string">&quot;MD5:%s&quot;</span>,md5string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样当文件下载完，MD5计算就完成了。</p>
<blockquote>
<p>注：在UE4中(~4.24)提供的OpenSSL在Win下只支持到VS2015，可以自己把这个限制给去掉(VS2015的链接库在VS2017中使用也没有问题)。</p>
</blockquote>
<h2 id="PlatformMisc的跨平台实现"><a href="#PlatformMisc的跨平台实现" class="headerlink" title="PlatformMisc的跨平台实现"></a>PlatformMisc的跨平台实现</h2><p>当我们使用<code>FPaths::ProjectDir()</code>的是否考虑过它是怎么实现在不同的平台上为不同的路径的呢？<br>首先看一下<code>FPaths::ProjectDir()</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Misc/Paths.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">FPaths::ProjectDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">FString</span>(FPlatformMisc::<span class="built_in">ProjectDir</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到它是<code>FPlatformMisc</code>的一层转发，继续深入代码去找<code>FPlatformMisc::ProjectDir</code>的实现，如果用VS的<code>Go to definition</code>可以看到一堆的文件里都有<code>FPlatformMisc</code>的定义：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-FPlatformMisc-typedef.webp"></p>
<p><code>FPlatformMisc</code>只是一个类型定义(typedef)，通过平台宏来判断，当编译为不同的平台是会把<code>FPlatformMisc</code>通过<code>typedef</code>为目标平台的类。<br>进行平台判断的代码在<code>Runtime/Core/Public/HAL/PlatformMisc.h</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/HAL/PlatformMisc.h</span></span><br><span class="line"><span class="comment">// Copyright 1998-2019 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GenericPlatform/GenericPlatformMisc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/WindowsPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_PS4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;PS4/PS4Misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_XBOXONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;XboxOne/XboxOneMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_MAC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Mac/MacPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_IOS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IOS/IOSPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_LUMIN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Lumin/LuminPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_ANDROID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_HTML5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HTML5/HTML5PlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_QUAIL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quail/QuailPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_LINUX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Linux/LinuxPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_SWITCH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Switch/SwitchPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>其中的每一个平台的<code>*PlatformMisc.h</code>文件中都有<code>FPlatformMisc</code>的类型定义（<code>typedef</code>），各个平台代码文件都是存放在<code>Runtime/Core/Public</code>下，每个平台有自己的目录。<br>而且，所有的<code>*PlatformMisc</code>类都继承自一个<code>FGenericPlatformMisc</code>的类，作为通用平台的接口，如<code>WindowsPlatformMisc</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Windows implementation of the misc OS functions</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CORE_API</span> <span class="title">FWindowsPlatformMisc</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> FGenericPlatformMisc&#123;<span class="comment">/*.....*/</span>&#125;</span><br></pre></td></tr></table></figure>
<p><code>FGenericPlatformMisc</code>中声明了我们常用的<code>ProjectDir</code>函数，供各个平台来独立实现，这样在通过<code>FPlatformMisc</code>来调用的时候就是所编译的目标平台的实现，这是UE实现跨平台代码的思路。</p>
<h2 id="Lua-从内存加载module"><a href="#Lua-从内存加载module" class="headerlink" title="Lua:从内存加载module"></a>Lua:从内存加载module</h2><p>从内存执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FLuaPanda::OpenLuaPanda</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">luaL_dostring</span>(L, (<span class="keyword">const</span> <span class="keyword">char</span>*)LuaPanda_lua_data);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加到PRELOAD中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">luaL_getsubtable</span>(L, LUA_REGISTRYINDEX, LUA_PRELOAD_TABLE);</span><br><span class="line"><span class="built_in">lua_pushcfunction</span>(L, &amp;FLuaPanda::OpenLuaPanda);</span><br><span class="line"><span class="built_in">lua_setfield</span>(L, <span class="number">-2</span>, <span class="string">&quot;LuaPanda&quot;</span>);</span><br><span class="line"><span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>直接添加到LOADED中:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">luaL_requiref</span>(L, <span class="string">&quot;LuaPanda&quot;</span>, &amp;FLuaPanda::OpenLuaPanda,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="gituhb快捷代码搜索"><a href="#gituhb快捷代码搜索" class="headerlink" title="gituhb快捷代码搜索"></a>gituhb快捷代码搜索</h2><p>可以把ue的官方仓库的搜索创建为Chrome的自定义搜索引擎：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/search-ue-source-in-github.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/EpicGames/UnrealEngine/search?q=%s&amp;unscoped_q=%s</span><br></pre></td></tr></table></figure>
<p>这样在chrome的地址栏就可以通过<code>uesource</code>来触发搜索。</p>
<h2 id="控制写入文件FLAG"><a href="#控制写入文件FLAG" class="headerlink" title="控制写入文件FLAG"></a>控制写入文件FLAG</h2><p><code>FFileHelper::SaveStringToFile</code>的最后一个参数可以传入一个Flag，用来控制文件的写入规则：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> SaveStringToFile</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">const</span> FString &amp; String,</span><br><span class="line">    <span class="keyword">const</span> TCHAR * Filename,</span><br><span class="line">    EEncodingOptions EncodingOptions,</span><br><span class="line">    IFileManager * FileManager,</span><br><span class="line">    uint32 WriteFlags</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>其<code>WriteFlags</code>可用值为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enum EFileWrite</span><br><span class="line">&#123;</span><br><span class="line">	FILEWRITE_None				= 0x00,</span><br><span class="line">	FILEWRITE_NoFail            = 0x01,</span><br><span class="line">	FILEWRITE_NoReplaceExisting = 0x02,</span><br><span class="line">	FILEWRITE_EvenIfReadOnly    = 0x04,</span><br><span class="line">	FILEWRITE_Append			= 0x08,</span><br><span class="line">	FILEWRITE_AllowRead			= 0x10,</span><br><span class="line">	FILEWRITE_Silent			= 0x20</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>它们被定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/7d9919ac7bfd80b7483012eab342cb427d60e8c9/Engine/Source/Runtime/Core/Public/HAL/FileManager.h">Engine/Source/Runtime/Core/Public/HAL/FileManager.h</a>，因为它们的值是支持位运算的，所以它们的使用方法为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FileHelper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Paths.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">FString FilePath = FPaths::<span class="built_in">ConvertRelativePathToFull</span>(FPaths::<span class="built_in">GameSavedDir</span>()) + <span class="built_in">TEXT</span>(<span class="string">&quot;/MessageLog.txt&quot;</span>);</span><br><span class="line">FString FileContent = <span class="built_in">TEXT</span>(<span class="string">&quot;This is a line of text to put in the file.\n&quot;</span>);</span><br><span class="line">FFileHelper::<span class="built_in">SaveStringToFile</span>(FileContent, *FilePath, FFileHelper::EEncodingOptions::AutoDetect, &amp;IFileManager::<span class="built_in">Get</span>(), EFileWrite::FILEWRITE_Append | EFileWrite::FILEWRITE_AllowRead | EFileWrite::FILEWRITE_EvenIfReadOnly);</span><br></pre></td></tr></table></figure>

<h2 id="Assertion-failed-Class-gt-Children-0"><a href="#Assertion-failed-Class-gt-Children-0" class="headerlink" title="Assertion failed: Class-&gt;Children == 0"></a>Assertion failed: Class-&gt;Children == 0</h2><p>这是UBT里产生的错误，原因是项目内有两个同名的类。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1&gt;  Running UnrealHeaderTool &quot;C:\Users\Administrator\Documents\Unreal Projects\GWorldSlg\GWorld.uproject&quot; &quot;C:\Users\Administrator\Documents\Unreal Projects\GWorldSlg\Intermediate\Build\Win64\GWorldEditor\Development\GWorldEditor.uhtmanifest&quot; -LogCmds=&quot;loginit warning, logexit warning, logdatabase error&quot; -Unattended -WarningsAsErrors -installed</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error: === Critical error: ===</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error: Assertion failed: Class-&gt;Children == 0 [File:D:\Build\++UE4\Sync\Engine\Source\Programs\UnrealHeaderTool\Private\HeaderParser.cpp] [Line: 5758]</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br></pre></td></tr></table></figure>

<h2 id="打包时添加外部文件"><a href="#打包时添加外部文件" class="headerlink" title="打包时添加外部文件"></a>打包时添加外部文件</h2><p>在<code>Project Settings</code>-<code>Project</code>-<code>Packaging</code>-<code>Addtional Non-Asset Directories to Package</code>：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/project-settings-add-non-asset-to-package.webp"></p>
<blockquote>
<p>注意：添加的目录必须要位于项目的Content下。</p>
</blockquote>
<p>如<code>Mobile422/Content/Script/</code>目录下的文件，在pak中的mount point为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/.vscode/launch.json&quot; offset: 80875520, size: 1173 bytes, sha1: 47DE6617E94EE86597148CCD53FC76E1E1A3EE22, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/Cube_Blueprint_C.lua&quot; offset: 80877568, size: 888 bytes, sha1: 00F529AE4206E38D322E2983478AFBC2999A036E, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/UnLua.lua&quot; offset: 80879616, size: 1977 bytes, sha1: 4015051A6663684CA3FBE1D60003CA62CD27A8AD, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/UnLuaPerformanceTestProxy.lua&quot; offset: 80881664, size: 6087 bytes, sha1: 6662D86BEF54610414C00E43CF2C0F514DDF7434, compression: None.</span><br></pre></td></tr></table></figure>

<h2 id="C-关键字绝对不要作为变量名"><a href="#C-关键字绝对不要作为变量名" class="headerlink" title="C++关键字绝对不要作为变量名"></a>C++关键字绝对不要作为变量名</h2><p>集成了一个库，其中有下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCKSIZE 64</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line"><span class="built_in">xor_key</span>(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;BLOCKSIZE;i+=<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">uint32_t</span>)) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> * k = (<span class="keyword">uint32_t</span> *)&amp;key[i];</span><br><span class="line">		*k ^= <span class="keyword">xor</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时候发现有这样的报错：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">inlineblock.cpp:<span class="number">9</span>:<span class="number">42</span>: error: blocks support disabled - compile with -fblocks <span class="keyword">or</span> pick a deployment target that supports them</span><br><span class="line"><span class="built_in">xor_key</span>(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">                                         ^</span><br><span class="line">inlineblock.cpp:<span class="number">9</span>:<span class="number">45</span>: error: block pointer to non-function type is invalid</span><br><span class="line"><span class="built_in">xor_key</span>(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">                                            ^</span><br><span class="line">inlineblock.cpp:<span class="number">13</span>:<span class="number">12</span>: error: type name <span class="keyword">requires</span> a specifier <span class="keyword">or</span> qualifier</span><br><span class="line">                *k ^= <span class="keyword">xor</span>;</span><br><span class="line">                         ^</span><br><span class="line">inlineblock.cpp:<span class="number">13</span>:<span class="number">12</span>: error: expected expression</span><br><span class="line"><span class="number">4</span> errors generated.</span><br></pre></td></tr></table></figure>
<p>这个错误的原因就是函数参数<code>xor</code>是<code>^</code>的<strong>关键字</strong>。</p>
<h2 id="将BindAction暴露给蓝图"><a href="#将BindAction暴露给蓝图" class="headerlink" title="将BindAction暴露给蓝图"></a>将BindAction暴露给蓝图</h2><p><code>UInputComponent</code>函数中的<code>BindAction</code>是个模板函数，可以在代码中使用，但是在蓝图中就很不方便了。</p>
<p>本来想着直接裹一个函数库的实现将BindAction暴露给蓝图，但是在BindAction需要传入的函数代理那里在蓝图里传递很不方便，看了一下BindAction的代码，写了下面这个函数，可以通过传递函数名来绑定：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">UFlibInputEventHelper</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable,Category = <span class="string">&quot;GWorld|FLib|InputHelper&quot;</span>,meta=(AutoCreateRefTerm=<span class="string">&quot;InActionName,InFuncName&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BindInputAction</span><span class="params">(UInputComponent* InInputComp, <span class="keyword">const</span> FName&amp; InActionName, EInputEvent InKeyEvent, UObject* InCallObject, <span class="keyword">const</span> FName&amp; InFuncName)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibInputEventHelper::BindInputAction</span><span class="params">(UInputComponent* InInputComp, <span class="keyword">const</span> FName&amp; InActionName, EInputEvent InKeyEvent, UObject* InCallObject, <span class="keyword">const</span> FName&amp; InFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FInputActionBinding <span class="title">AB</span><span class="params">(InActionName, InKeyEvent)</span></span>;</span><br><span class="line">	AB.ActionDelegate.<span class="built_in">BindDelegate</span>(InCallObject, InFuncName);</span><br><span class="line">	InInputComp-&gt;<span class="built_in">AddActionBinding</span>(<span class="built_in">MoveTemp</span>(AB));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="APK包中OBB文件"><a href="#APK包中OBB文件" class="headerlink" title="APK包中OBB文件"></a>APK包中OBB文件</h2><p>在选择把data文件打包APK之后，把打包出的APK解包，是可以看到obb文件的，在<code>assets</code>文件夹下有<code>main.obb.webp</code>，其就是<code>Saved/StagedBuilds/</code>目录下的<code>PROJECT_NAME.obb</code>文件，HASH值都是一样的。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/obb-file-hash-diff.webp"></p>
<p>其实OBB文件中存储的就是我们的pak文件以及在项目设置中添加的启动视频的mp4文件，使用7z之类的压缩软件可以打开未加密的obb查看，可以看到它的目录结构就是<code>PROJECT_NAME/Content/Paks/PROJECTNAME-Android_ETC2.pak</code>这样的形式。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\---FGame</span><br><span class="line">    \---Content</span><br><span class="line">        +---Movies</span><br><span class="line">        |       logo.mp4</span><br><span class="line">        |       SparkMore.mp4</span><br><span class="line">        |</span><br><span class="line">        \---Paks</span><br><span class="line">                pakchunk0-Android_ASTC.pak</span><br><span class="line">                pakchunk1-Android_ASTC.pak</span><br><span class="line">                pakchunk2-Android_ASTC.pak</span><br></pre></td></tr></table></figure>

<h2 id="移动端的启动参数"><a href="#移动端的启动参数" class="headerlink" title="移动端的启动参数"></a>移动端的启动参数</h2><p>UE4打出来的包可以使用<code>XXXX.exe -Params</code>等方式来传递给游戏参数，但是移动平台(IOS/Android)打包出来的怎么传递参数呢？</p>
<h3 id="Android启动参数"><a href="#Android启动参数" class="headerlink" title="Android启动参数"></a>Android启动参数</h3><p>看了一下引擎里的代码，在<code>Launch</code>模块下<code>Launch\Private\Android\LaunchAndroid.cpp</code>中有<code>InitCommandLine</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\LaunchAndroid.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> uint32 CMD_LINE_MAX = <span class="number">16384u</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">  FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  AAssetManager* AssetMgr = <span class="built_in">AndroidThunkCpp_GetAssetManager</span>();</span><br><span class="line">  AAsset* asset = <span class="built_in">AAssetManager_open</span>(AssetMgr, <span class="built_in">TCHAR_TO_UTF8</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>)), AASSET_MODE_BUFFER);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> != asset)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>* FileContents = <span class="built_in">AAsset_getBuffer</span>(asset);</span><br><span class="line">    int32 FileLength = <span class="built_in">AAsset_getLength</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    FileLength = (FileLength &lt; CMD_LINE_MAX - <span class="number">1</span>) ? FileLength : CMD_LINE_MAX - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(CommandLine, FileContents, FileLength);</span><br><span class="line">    CommandLine[FileLength] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AAsset_close</span>(asset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;APK Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in the command line text file from the sdcard if it exists</span></span><br><span class="line">  FString CommandLineFilePath = GFilePathBase + <span class="built_in">FString</span>(<span class="string">&quot;/UE4Game/&quot;</span>) + (!FApp::<span class="built_in">IsProjectNameEmpty</span>() ? FApp::<span class="built_in">GetProjectName</span>() : FPlatformProcess::<span class="built_in">ExecutableName</span>()) + <span class="built_in">FString</span>(<span class="string">&quot;/UE4CommandLine.txt&quot;</span>);</span><br><span class="line">  FILE* CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// if that failed, try the lowercase version</span></span><br><span class="line">    CommandLineFilePath = CommandLineFilePath.<span class="built_in">Replace</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UE4CommandLine.txt&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ue4commandline.txt&quot;</span>));</span><br><span class="line">    CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    <span class="built_in">fgets</span>(CommandLine, <span class="built_in">ARRAY_COUNT</span>(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fclose</span>(CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">    FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Override Commandline: %s&quot;</span>), FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="keyword">if</span> (FString* ConfigRulesCmdLineAppend = FAndroidMisc::<span class="built_in">GetConfigRulesVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;cmdline&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    FCommandLine::<span class="built_in">Append</span>(**ConfigRulesCmdLineAppend);</span><br><span class="line">    FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ConfigRules appended: %s&quot;</span>), **ConfigRulesCmdLineAppend);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是在<code>UE4Game/ProjectName/ue4commandline.txt</code>中把启动参数写到里面，引擎启动的时候会从这个文件去读，然后添加到FCommandLine中。</p>
<h3 id="IOS启动参数"><a href="#IOS启动参数" class="headerlink" title="IOS启动参数"></a>IOS启动参数</h3><p>与Android的做法相同，IOS的参数传递是在<code>main</code>函数中调用<code>FIOSCommandLineHelper::InitCommandArgs(FString());</code>，不过路径和Android不一样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandArgs</span><span class="params">(FString AdditionalCommandArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// initialize the commandline</span></span><br><span class="line">	FCommandLine::<span class="built_in">Set</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">	FString CommandLineFilePath = <span class="built_in">FString</span>([[NSBundle mainBundle] bundlePath]) + <span class="built_in">TEXT</span>(<span class="string">&quot;/ue4commandline.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// read in the command line text file (coming from UnrealFrontend) if it exists</span></span><br><span class="line">	FILE* CommandLineFile = <span class="built_in">fopen</span>(<span class="built_in">TCHAR_TO_UTF8</span>(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Found ue4commandline.txt file&quot;</span>) LINE_TERMINATOR);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> CommandLine[CMD_LINE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">char</span>* DataExists = <span class="built_in">fgets</span>(CommandLine, <span class="built_in">ARRAY_COUNT</span>(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line">		<span class="keyword">if</span> (DataExists)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// chop off trailing spaces</span></span><br><span class="line">			<span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">			&#123;</span><br><span class="line">				CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FCommandLine::<span class="built_in">Append</span>(<span class="built_in">UTF8_TO_TCHAR</span>(CommandLine));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;No ue4commandline.txt [%s] found&quot;</span>) LINE_TERMINATOR, *CommandLineFilePath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!AdditionalCommandArgs.<span class="built_in">IsEmpty</span>() &amp;&amp; !FChar::<span class="built_in">IsWhitespace</span>(AdditionalCommandArgs[<span class="number">0</span>]))</span><br><span class="line">	&#123;</span><br><span class="line">		FCommandLine::<span class="built_in">Append</span>(<span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	FCommandLine::<span class="built_in">Append</span>(*AdditionalCommandArgs);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// now merge the GSavedCommandLine with the rest</span></span><br><span class="line">	FCommandLine::<span class="built_in">Append</span>(*GSavedCommandLine);</span><br><span class="line"></span><br><span class="line">	FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Combined iOS Commandline: %s&quot;</span>) LINE_TERMINATOR, FCommandLine::<span class="built_in">Get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键就是<code>[[NSBundle mainBundle] bundlePath]</code>这一句，它获取的是App的包路径，所以把UE4CommandLine.txt放到包路径下就可以了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaodao/archive/2012/07/03/2574703.html">NSBundle</a></li>
</ul>
<h2 id="UE编译环境的VS安装配置"><a href="#UE编译环境的VS安装配置" class="headerlink" title="UE编译环境的VS安装配置"></a>UE编译环境的VS安装配置</h2><p>保存为<code>.vsconfig</code>然后使用Visual Studio Installer导入配置安装即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;components&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeDesktop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.Python&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.Node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeGame&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeCrossPlat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.debugger.justintime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.6.2.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.6.2.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.1.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.1.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.2.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.2.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.diagnostictools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.cmake.project&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.atl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforboosttest&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforgoogletest&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.winxp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.cli.support&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.modules.x86.x64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.incredibuild&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.netfx.core.runtime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.cookiecuttertools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.pythontools.web&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.classdesigner&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.3.5.developertools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.unreal.android&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.linux.cmake&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.helpviewer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.clangc2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.tools.14.14&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载地址：<a href="index/UE4/vs_installer.vsconfig">vs_installer.vsconfig</a></p>
<h2 id="扫描资源引用时需注意Redirector"><a href="#扫描资源引用时需注意Redirector" class="headerlink" title="扫描资源引用时需注意Redirector"></a>扫描资源引用时需注意Redirector</h2><p>当我们在UE的资源管理器中进行<code>rename</code>/<code>move</code>等操作时，会产生一个与更名之前名字一样的<code>Redirector</code>：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-scanf-asset-ref-redirector.webp"></p>
<p>在使用<code>UAssetManager::GetAssets</code>进行资源的扫描时也会查询到这些<code>redirector</code>，但是他们不是真正的资源，在处理时需要过滤掉它们。<br><code>FAssetData</code>中有一个成员函数<code>IsRedirector</code>可以用来判断扫描到的<code>FAssetData</code>是不是重定向器。</p>
<p>但是良好的项目规范是每进行<code>delete</code>/<code>rename</code>/<code>move</code>之后都手动在编辑器中执行<code>Fix up Redirector In Folder</code>，就会清理掉这些Redirector了，保持项目的干净。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-fix-up-redirectors-in-folder.webp"></p>
<h2 id="Cook执行代码"><a href="#Cook执行代码" class="headerlink" title="Cook执行代码"></a>Cook执行代码</h2><p>UE中执行Cook 的代码位于<code>UnrealEd</code>模块下，源码位于：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Editor/UnrealEd/Private/Commandlets/CookCommandlet.cpp</span><br></pre></td></tr></table></figure>

<p>其中有<code>int32 UCookCommandlet::Main(const FString&amp; CmdLineParams)</code>是起始逻辑。</p>
<h2 id="No-world-was-found-for-object"><a href="#No-world-was-found-for-object" class="headerlink" title="No world was found for object"></a>No world was found for object</h2><p>在写代码的时候在UObject里调用了一些需要传递<code>WorldContentObject</code>的函数，但是却把UObject的<code>this</code>传递了进去，因为这个东西不在场景中，无法通过它获取的World，所以会产生下列警告：</p>
<blockquote>
<p>LogScript: Warning: Script Msg: No world was found for object (/Engine/Transient.SubsysTouchControllerTrace_1) passed in to UEngine::GetWorldFromContextObject().</p>
</blockquote>
<p>解决办法就是传递一个能够获取到<code>World</code>的对象进去。</p>
<h2 id="移动设备的渲染预览"><a href="#移动设备的渲染预览" class="headerlink" title="移动设备的渲染预览"></a>移动设备的渲染预览</h2><p><code>ToolBar</code>-<code>Settings</code>-<code>PreviewRenderingLevel</code>-<code>Android ES3.1</code>/<code>Android ES2</code>/<code>IOS</code>：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/PreviewRenderingLevel.webp"></p>
<h2 id="Android项目设置"><a href="#Android项目设置" class="headerlink" title="Android项目设置"></a>Android项目设置</h2><ul>
<li><code>EnableGradleInsteadOfAnt</code>：使用Gradle替代Ant用来编译和生成APK。</li>
<li><code>EnableFullScreenImmersiveOnKitKatAndAboveDevices</code>：全屏模式下隐藏虚拟按键；</li>
<li><code>EnableImprovedVirtualKeyboard</code>：启用虚拟键盘；</li>
</ul>
<h2 id="在构造函数中用SetupAttachmen替代AttachToComponent"><a href="#在构造函数中用SetupAttachmen替代AttachToComponent" class="headerlink" title="在构造函数中用SetupAttachmen替代AttachToComponent"></a>在构造函数中用SetupAttachmen替代AttachToComponent</h2><p>在构造函数中使用<code>AttachToComponent</code>在打包时会有这样的错误：</p>
<blockquote>
<p>Error: AttachToComponent when called from a constructor is only setting up attachment and will always be treated as KeepRelative. Consider calling SetupAttachment directly instead.</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: begin: stack <span class="keyword">for</span> UAT</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: === Handled ensure: ===</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: Ensure condition failed: AttachmentRules.LocationRule == EAttachmentRule::KeepRelative &amp;&amp; AttachmentRules.RotationRule == EAttachmentRule::KeepRelative &amp;&amp; AttachmentRules.ScaleRule == EAttachmentRule::KeepRelative [File:D:\Build\++UE4\Sync\Engine\Source\Runtime\Engine\Privat</span><br><span class="line">e\Components\SceneComponent.cpp] [Line: <span class="number">1786</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: AttachToComponent when called from a constructor is only setting up attachment <span class="keyword">and</span> will always be treated as KeepRelative. Consider calling SetupAttachment directly instead.</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: Stack:</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe36fccd89</span> UE4Editor-Engine.dll!DispatchCheckVerify&lt;<span class="keyword">bool</span>,&lt;lambda_2fa4c8014e6e2d59bee8e8ac7e5934f3&gt; &gt;() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\misc\assertionmacros.h:<span class="number">161</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe35e04fa1</span> UE4Editor-Engine.dll!USceneComponent::<span class="built_in">AttachToComponent</span>() [d:\build\++ue4\sync\engine\source\runtime\engine\<span class="keyword">private</span>\components\scenecomponent.cpp:<span class="number">1786</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe215db1b3</span> UE4Editor-GWorld<span class="number">-0001.</span>dll!ABasePlayerPawn::<span class="built_in">ABasePlayerPawn</span>() [c:\users\imzlp\documents\unreal projects\gworldclient\source\gworld\<span class="keyword">private</span>\modules\coreentity\instance\baseplayerpawn.cpp:<span class="number">21</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe215fdf57</span> UE4Editor-GWorld<span class="number">-0001.</span>dll!InternalConstructor&lt;ABasePlayerPawn&gt;() [c:\program files\epic games\ue_4<span class="number">.22</span>\engine\source\runtime\coreuobject\<span class="keyword">public</span>\uobject\class.h:<span class="number">2841</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe382a610f</span> UE4Editor-CoreUObject.dll!UClass::<span class="built_in">CreateDefaultObject</span>() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\class.cpp:<span class="number">3076</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe384e1056</span> UE4Editor-CoreUObject.dll!<span class="built_in">UObjectLoadAllCompiledInDefaultProperties</span>() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\uobjectbase.cpp:<span class="number">793</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe384cedef</span> UE4Editor-CoreUObject.dll!<span class="built_in">ProcessNewlyLoadedUObjects</span>() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\uobjectbase.cpp:<span class="number">869</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe382aa727</span> UE4Editor-CoreUObject.dll!TBaseStaticDelegateInstance&lt;<span class="keyword">void</span> __cdecl(<span class="keyword">void</span>)&gt;::<span class="built_in">ExecuteIfSafe</span>() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\delegates\delegateinstancesimpl.h:<span class="number">813</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe38874a2b</span> UE4Editor-Core.dll!TBaseMulticastDelegate&lt;<span class="keyword">void</span>&gt;::<span class="built_in">Broadcast</span>() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\delegates\delegatesignatureimpl.inl:<span class="number">977</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe38a45cb5</span> UE4Editor-Core.dll!FModuleManager::<span class="built_in">LoadModuleWithFailureReason</span>() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">private</span>\modules\modulemanager.cpp:<span class="number">530</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe5fb58d67</span> UE4Editor-Projects.dll!FModuleDescriptor::<span class="built_in">LoadModulesForPhase</span>() [d:\build\++ue4\sync\engine\source\runtime\projects\<span class="keyword">private</span>\moduledescriptor.cpp:<span class="number">596</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe5fb58ff7</span> UE4Editor-Projects.dll!FProjectManager::<span class="built_in">LoadModulesForProject</span>() [d:\build\++ue4\sync\engine\source\runtime\projects\<span class="keyword">private</span>\projectmanager.cpp:<span class="number">63</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dabd260</span> UE4Editor-Cmd.exe!FEngineLoop::<span class="built_in">PreInit</span>() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\launchengineloop.cpp:<span class="number">2425</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dab5377</span> UE4Editor-Cmd.exe!<span class="built_in">GuardedMain</span>() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\launch.cpp:<span class="number">129</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dab55ca</span> UE4Editor-Cmd.exe!<span class="built_in">GuardedMainWrapper</span>() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\windows\launchwindows.cpp:<span class="number">145</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dac316c</span> UE4Editor-Cmd.exe!<span class="built_in">WinMain</span>() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\windows\launchwindows.cpp:<span class="number">275</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dac4cb6</span> UE4Editor-Cmd.exe!__scrt_common_main_seh() [d:\agent\_work\<span class="number">3</span>\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:<span class="number">288</span>]</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe7b247974</span> KERNEL32.DLL!UnknownFunction []</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe7c62a271</span> ntdll.dll!UnknownFunction []</span><br><span class="line">UATHelper: <span class="built_in">Packaging</span> (<span class="built_in">Windows</span> (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: end: stack <span class="keyword">for</span> UAT</span><br></pre></td></tr></table></figure>

<p>解决的办法就是提示中的那样，用<code>SetupAttachment</code>替换<code>AttachToComponent</code>。</p>
<h2 id="在其他的线程运行程序并获取程序输出"><a href="#在其他的线程运行程序并获取程序输出" class="headerlink" title="在其他的线程运行程序并获取程序输出"></a>在其他的线程运行程序并获取程序输出</h2><p>在写避编辑器功能的时候经常会启动外部的程序来执行任务，如果要求程序执行完成才走其他逻辑则会阻塞，这样的体验很不好，所以一般是开一个额外的线程来执行程序启动。废话不多说直接看代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span>  once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FThreadUtils.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GenericPlatform/GenericPlatformProcess.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOutputMsgDelegate, <span class="keyword">const</span> FString&amp;);</span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE</span>(FProcStatusDelegate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FProcWorkerThread</span> :</span> <span class="keyword">public</span> FThread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">FProcWorkerThread</span><span class="params">(<span class="keyword">const</span> TCHAR *InThreadName,<span class="keyword">const</span> FString&amp; InProgramPath,<span class="keyword">const</span> FString&amp; InParams)</span></span></span><br><span class="line"><span class="function">    : FThread(InThreadName, []() &#123;</span>&#125;), <span class="built_in">mProgramPath</span>(InProgramPath), <span class="built_in">mPragramParams</span>(InParams)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> uint32 <span class="title">Run</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(mProgramPath))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformProcess::<span class="built_in">CreatePipe</span>(mReadPipe, mWritePipe);</span><br><span class="line">      <span class="comment">// std::cout &lt;&lt; TCHAR_TO_ANSI(*mProgramPath) &lt;&lt; &quot; &quot; &lt;&lt; TCHAR_TO_ANSI(*mPragramParams) &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">      mProcessHandle = FPlatformProcess::<span class="built_in">CreateProc</span>(*mProgramPath, *mPragramParams, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, &amp;mProcessID, <span class="number">0</span>, <span class="literal">NULL</span>, mWritePipe,mReadPipe);</span><br><span class="line">      <span class="keyword">if</span> (mProcessHandle.<span class="built_in">IsValid</span>() &amp;&amp; FPlatformProcess::<span class="built_in">IsApplicationRunning</span>(mProcessID))</span><br><span class="line">      &#123;</span><br><span class="line">        ProcBeginDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FString Line;</span><br><span class="line">      <span class="keyword">while</span> (mProcessHandle.<span class="built_in">IsValid</span>() &amp;&amp; FPlatformProcess::<span class="built_in">IsApplicationRunning</span>(mProcessID))</span><br><span class="line">      &#123;</span><br><span class="line">        FPlatformProcess::<span class="built_in">Sleep</span>(<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">        FString NewLine = FPlatformProcess::<span class="built_in">ReadPipe</span>(mReadPipe);</span><br><span class="line">        <span class="keyword">if</span> (NewLine.<span class="built_in">Len</span>() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// process the string to break it up in to lines</span></span><br><span class="line">          Line += NewLine;</span><br><span class="line">          TArray&lt;FString&gt; StringArray;</span><br><span class="line">          int32 count = Line.<span class="built_in">ParseIntoArray</span>(StringArray, <span class="built_in">TEXT</span>(<span class="string">&quot;\n&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (count &gt; <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; count - <span class="number">1</span>; ++Index)</span><br><span class="line">            &#123;</span><br><span class="line">              StringArray[Index].<span class="built_in">TrimEndInline</span>();</span><br><span class="line">              ProcOutputMsgDelegate.<span class="built_in">Broadcast</span>(StringArray[Index]);</span><br><span class="line">            &#125;</span><br><span class="line">            Line = StringArray[count - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (NewLine.<span class="built_in">EndsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;\n&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">              Line += <span class="built_in">TEXT</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      int32 ProcReturnCode;</span><br><span class="line">      <span class="keyword">if</span> (FPlatformProcess::<span class="built_in">GetProcReturnCode</span>(mProcessHandle,&amp;ProcReturnCode))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (ProcReturnCode == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          ProcSuccessedDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          ProcFaildDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    mThreadStatus = EThreadStatus::Completed;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Exit</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mProcessHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Cancel</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetThreadStatus</span>() != EThreadStatus::Busy)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    mThreadStatus = EThreadStatus::Canceling;</span><br><span class="line">    <span class="keyword">if</span> (mProcessHandle.<span class="built_in">IsValid</span>() &amp;&amp; FPlatformProcess::<span class="built_in">IsApplicationRunning</span>(mProcessID))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformProcess::<span class="built_in">TerminateProc</span>(mProcessHandle, <span class="literal">true</span>);</span><br><span class="line">      ProcFaildDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line">      mProcessHandle.<span class="built_in">Reset</span>();</span><br><span class="line">      mProcessID = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mThreadStatus = EThreadStatus::Canceled;</span><br><span class="line">    CancelDelegate.<span class="built_in">Broadcast</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetProcesId</span><span class="params">()</span><span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mProcessID; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FProcHandle <span class="title">GetProcessHandle</span><span class="params">()</span><span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mProcessHandle; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  FProcStatusDelegate ProcBeginDelegate;</span><br><span class="line">  FProcStatusDelegate ProcSuccessedDelegate;</span><br><span class="line">  FProcStatusDelegate ProcFaildDelegate;</span><br><span class="line">  FOutputMsgDelegate ProcOutputMsgDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  FRunnableThread* mThread;</span><br><span class="line">  FString mProgramPath;</span><br><span class="line">  FString mPragramParams;</span><br><span class="line">  <span class="keyword">void</span>* mReadPipe;</span><br><span class="line">  <span class="keyword">void</span>* mWritePipe;</span><br><span class="line">  uint32 mProcessID;</span><br><span class="line">  FProcHandle mProcessHandle;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以通过监听<code>ProcOutputMsgDelegate</code>来接收程序的打印输出。</p>
<h2 id="绑定FTicker"><a href="#绑定FTicker" class="headerlink" title="绑定FTicker"></a>绑定FTicker</h2><p>在非Actor的对象上如果想要使用Tick，可以使用下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FDelegateHandle TickHandle = FTicker::<span class="built_in">GetCoreTicker</span>().<span class="built_in">AddTicker</span>(FTickerDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>,&amp;UGameExtensionSettings::Tick);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS:<code>FCoreDelegates</code>和<code>FCoreUObjectDelegates</code>中有很多有用的代理。</p>
</blockquote>
<h2 id="地图加载的Delegate"><a href="#地图加载的Delegate" class="headerlink" title="地图加载的Delegate"></a>地图加载的Delegate</h2><p><code>FCoreUObjectDelegates</code>中的这两个代理在地图加载时和地图加载完成时会调用，可以用来显示加载地图时的过场：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FCoreUObjectDelegates::PreLoadMap.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;UMarinGameInstance::BeginLoadingScreen);</span><br><span class="line">FCoreUObjectDelegates::PostLoadMapWithWorld.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;UMarinGameInstance::EndL</span><br></pre></td></tr></table></figure>

<h2 id="StaticLoadClass"><a href="#StaticLoadClass" class="headerlink" title="StaticLoadClass"></a>StaticLoadClass</h2><p>可以从通过一个字符串来加载UClass:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UClass* UserWidgetClass = <span class="built_in">StaticLoadClass</span>(UUserWidget::<span class="built_in">StaticClass</span>(), <span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;WidgetBlueprintGeneratedClass&#x27;/Game/TEST/BP_UserWidget.BP_UserWidget_C&#x27;&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>同理也有<code>StaticLoadObject</code>。</p>
<h2 id="ConstructorHelpers-FClassFinder"><a href="#ConstructorHelpers-FClassFinder" class="headerlink" title="ConstructorHelpers::FClassFinder"></a>ConstructorHelpers::FClassFinder</h2><p>只能在构造函数中调用，否则引擎会崩溃，在外部使用可以使用<code>StaticLoadClass</code>。</p>
<h2 id="CMD的sudo"><a href="#CMD的sudo" class="headerlink" title="CMD的sudo"></a>CMD的sudo</h2><p>在Windows上时长会遇到要使用管理员权限执行的命令，而Win的cmd又不如Linux那样可以直接sudo来获取管理员权限，还要手动敲<code>cmd</code>然后右键管理员权限运行 十分麻烦，下面这个脚本可以实现类似bash的<code>sudo</code>操作：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">powershell -Command &quot;(($arg=&#x27;/k <span class="built_in">cd</span> /d &#x27;+$pwd+&#x27; &amp;&amp; %*&#x27;) -and (<span class="built_in">Start</span>-Process <span class="built_in">cmd</span> -Verb RunAs -ArgumentList $arg))| Out-Null&quot;</span><br><span class="line">@<span class="built_in">echo</span> on</span><br></pre></td></tr></table></figure>
<p>将其保存为<code>sudo.bat</code>然后放入<code>C:\Windows</code>下即可，随便打开一个cmd可以输入sudo来执行命令了。</p>
<h2 id="在游戏项目中添加编辑器模块"><a href="#在游戏项目中添加编辑器模块" class="headerlink" title="在游戏项目中添加编辑器模块"></a>在游戏项目中添加编辑器模块</h2><p>首先创建一个空的C++项目，其目录结构为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\GWorld\Source&gt;&gt;tree /a /f</span><br><span class="line">|   GWorld.Target.cs</span><br><span class="line">|   GWorldEditor.Target.cs</span><br><span class="line">|</span><br><span class="line">\---GWorld</span><br><span class="line">      GWorld.Build.cs</span><br><span class="line">      GWorld.cpp</span><br><span class="line">      GWorld.h</span><br><span class="line">      GWorldGameModeBase.cpp</span><br><span class="line">      GWorldGameModeBase.h</span><br></pre></td></tr></table></figure>

<ol>
<li><p>我们在Source目录下添加一个<code>GWorldEditor</code>的文件夹，在其中新建<code>GWorldEditor.Build.cs</code>/<code>GWorldEditor.cpp</code>/<code>GWorldEditor.h</code>三个文件，并仿照<code>GWorld</code>模块下的文件内容修改；</p>
</li>
<li><p>在<code>GWorldEditor.Build.cs</code>中添加<code>GWorld</code>的模块依赖；</p>
</li>
<li><p>修改<code>GWorldEditor.Target.cs</code>文件将<code>ExtraModuleNames.AddRange( new string[] &#123; &quot;GWorld&quot; &#125; );</code>其中的<code>GWorld</code>修改为<code>GWorldEditor</code>；</p>
</li>
<li><p>修改项目的<code>uproject</code>文件，在<code>Modules</code>下添加<code>GWorldEditor</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;FileVersion&quot;</span>: <span class="number">3</span>,</span><br><span class="line">	<span class="string">&quot;EngineAssociation&quot;</span>: <span class="string">&quot;4.22&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Category&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Modules&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;GWorld&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Type&quot;</span>: <span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">			<span class="string">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;Default&quot;</span>,</span><br><span class="line">			<span class="string">&quot;AdditionalDependencies&quot;</span>: [</span><br><span class="line">				<span class="string">&quot;Engine&quot;</span>,</span><br><span class="line">				<span class="string">&quot;CoreUObject&quot;</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">    	&#123;</span><br><span class="line">    	  <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;GWorldEditor&quot;</span>,</span><br><span class="line">    	  <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;Editor&quot;</span>,</span><br><span class="line">    	  <span class="string">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;PostEngineInit&quot;</span></span><br><span class="line">    	&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后重新生成VS的解决方案，编译即可。</p>
</li>
</ol>
<p><strong>可能遇到的错误</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogInit: Warning: Still incompatible or missing module: GWorld</span><br></pre></td></tr></table></figure>
<p>如果遇到上面的错误是因为没在<code>GWorldEditor.Build.cs</code>中添加<code>GWorld</code>的模块依赖。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/Creating_an_Editor_Module">Creating an Editor Module</a></p>
<h2 id="does-not-match-the-necessary-signature"><a href="#does-not-match-the-necessary-signature" class="headerlink" title="does not match the necessary signature"></a>does not match the necessary signature</h2><p>在蓝图事件绑定C++的Dispatcher时会有这样的提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXXEvent Signature Error: The <span class="keyword">function</span>/event `XXXXEvent` does not match the necessary signature - the delegate or <span class="keyword">function</span>/event changed?</span><br></pre></td></tr></table></figure>

<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/dispatcher-bind-error-not-match-signature.webp"></p>
<p>这是因为C++里的Dispather的传入参数不是<code>const&amp;</code>的（上面图里是<code>TArray&lt;Type&gt;</code>），在代码里把Delegate的声明参数改为<code>const TArray&lt;Type&gt;&amp;</code>然后重新编译即可。</p>
<h2 id="数据成员初始化顺序必须要与声明顺序一致"><a href="#数据成员初始化顺序必须要与声明顺序一致" class="headerlink" title="数据成员初始化顺序必须要与声明顺序一致"></a>数据成员初始化顺序必须要与声明顺序一致</h2><p>如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// error in UE4,ill in c++</span></span><br><span class="line">    <span class="built_in">A</span>():<span class="built_in">dval</span>(<span class="number">0.0f</span>),<span class="built_in">ival</span>(<span class="number">0</span>)&#123;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> ival;</span><br><span class="line">    <span class="keyword">double</span> dval;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会有下列错误：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C5038: data member &#x27;UTcpNetPeer::RecvMessageDataRemaining&#x27; will be initialized after data member &#x27;UTcpNetPeer::ConnectionRetryTimes&#x27;</span><br></pre></td></tr></table></figure>


<h2 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a>Delegate</h2><p>UE的<code>Delegate</code>分了几个不同的种类，普通的代理是模板类，<code>Dynamic Delegate</code>是通过宏展开生成类，<code>Dynamic Mulitcast Delegate</code>需要UHT参与生成代码，所以动态多播代理只能写到包含<code>generated.h</code>的文件中。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/index.html#DeclaringDelegates">Delegates</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Multicast/index.html">Multi-cast Delegates</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Dynamic/index.html">Dynamic Delegates</a></li>
</ul>
<h3 id="Delegate-1"><a href="#Delegate-1" class="headerlink" title="Delegate"></a>Delegate</h3><ul>
<li><code>DECLARE_DELEGATE</code>：普通代理，可以被值传递，本质实现是<code>TBaseDelegare&lt;__VA_ARGS__&gt;</code>的对象，可以使用<code>BindUObject</code>等函数。</li>
</ul>
<p><code>TBaseDelegate</code>里定义了很多的辅助函数，如<code>BindSP</code>/<code>BindRaw</code>/<code>BindStatic</code>/<code>CreateSP</code>等。</p>
<h3 id="Dynamic-Delegate"><a href="#Dynamic-Delegate" class="headerlink" title="Dynamic Delegate"></a>Dynamic Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_DELEGATE</code>：动态代理可以序列化，其函数可按命名查找，执行速度比常规代理慢。</li>
</ul>
<p>动态代理本质上是继承自<code>TBaseDynamicDelegate</code>的类，<code>TBaseDynamicDelegate</code>又继承自<code>TScriptDelegate</code>，所以动态代理可以绑定UObject和绑定UFUNCTION。</p>
<p>其中<code>BindUFunction</code>是<code>TScriptInterface</code>的函数，而<code>BindUbject</code>是个宏，定义在<code>Delegate.h</code>中。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_DELEGATE_OneParam</span>(FOnTestDynamicDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_DYNAMIC_DELEGATE_OneParam</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_DELEGATE_OneParam( DelegateName, Param1Type, Param1Name ) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_DELEGATE) FUNC_DECLARE_DYNAMIC_DELEGATE( FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, FUNC_CONCAT( Param1Type InParam1 ), FUNC_CONCAT( *this, InParam1 ), void, Param1Type )</span></span><br></pre></td></tr></table></figure>

<p><code>BODY_MACRO_COMBINE</code>宏其经过UHT之后生成的代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms</span> \</span></span><br><span class="line"><span class="class">&#123;</span> \</span><br><span class="line">	FString InStr; \</span><br><span class="line">&#125;; \</span><br><span class="line">static inline void FOnTestDynamicDelegate_DelegateWrapper(const FScriptDelegate&amp; OnTestDynamicDelegate, const FString&amp; InStr) \</span><br><span class="line">&#123; \</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms; \</span><br><span class="line">	Parms.InStr=InStr; \</span><br><span class="line">	OnTestDynamicDelegate.ProcessDelegate&lt;UObject&gt;(&amp;Parms); \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行展开之后，可以看到使用<code>DECLARE_DYNAMIC_DELEGATE_OneParam</code>声明的代理实际上是就被定义了一个static函数。</p>
<p><code>FUNC_DECLARE_DYNAMIC_DELEGATE</code>宏是裹了一个<code>TBaseDynamicDelegate</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_DELEGATE( TWeakPtr, DynamicDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ... ) \</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">DynamicDelegateName</span> :</span> <span class="keyword">public</span> TBaseDynamicDelegate&lt;TWeakPtr, __VA_ARGS__&gt; \</span><br><span class="line">	&#123; \</span><br><span class="line">	<span class="keyword">public</span>: \</span><br><span class="line">		<span class="comment">/** Default constructor */</span> \</span><br><span class="line">		<span class="built_in">DynamicDelegateName</span>() \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Construction from an FScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span><br><span class="line">		explicit DynamicDelegateName( const TScriptDelegate&lt;&gt;&amp; InScriptDelegate ) \</span><br><span class="line">			: TBaseDynamicDelegate&lt;TWeakPtr, __VA_ARGS__&gt;( InScriptDelegate ) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Execute the delegate.  If the function pointer is not valid, an error will occur. */</span> \</span><br><span class="line">		inline void Execute( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* Verify that the user object is still valid.  We only have a weak reference to it. */</span> \</span><br><span class="line">			<span class="built_in">checkSlow</span>( <span class="built_in">IsBound</span>() ); \</span><br><span class="line">			<span class="built_in">ExecFunction</span>( FuncParamPassThru ); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="comment">/** Execute the delegate, but only if the function pointer is still valid */</span> \</span><br><span class="line">		inline bool ExecuteIfBound( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="keyword">if</span>( <span class="built_in">IsBound</span>() ) \</span><br><span class="line">			&#123; \</span><br><span class="line">				<span class="built_in">ExecFunction</span>( FuncParamPassThru ); \</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>; \</span><br><span class="line">			&#125; \</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<p>所有的宏都被展开之后：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FScriptDelegate&amp; OnTestDynamicDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicDelegate.ProcessDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">FOnTestDynamicDelegate</span>() &#123; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FOnTestDynamicDelegate</span><span class="params">( <span class="keyword">const</span> TScriptDelegate&lt;&gt;&amp; InScriptDelegate )</span> : TBaseDynamicDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;( InScriptDelegate ) &#123;</span> &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">checkSlow</span>( <span class="built_in">IsBound</span>() ); <span class="built_in">FOnTestDynamicDelegate_DelegateWrapper</span>( *<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ExecuteIfBound</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line">		<span class="keyword">if</span>( <span class="built_in">IsBound</span>() ) </span><br><span class="line">		&#123; </span><br><span class="line">			<span class="built_in">FOnTestDynamicDelegate_DelegateWrapper</span>( *<span class="keyword">this</span>, InStr ); </span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在使用的时候可以通过<code>BindUFunction</code>来绑定函数，通过<code>Execute</code>或者<code>ExecuteIfBound</code>来调用。</p>
<p>在当作回调函数传递的时候比较方便，因为它继承自<code>FScriptDelegate</code>，可以当作通用的方式传递。</p>
<h3 id="Multicast-Delegate"><a href="#Multicast-Delegate" class="headerlink" title="Multicast Delegate"></a>Multicast Delegate</h3><ul>
<li><strong>多播代理</strong>：与普通代理的大部分功能相同，它们只拥有对象的弱引用，可以和结构体一起使用，可以复制。其本质是<code>TMulticastDelegate&lt;__VA_ARGS__&gt;</code>的对象。多播代理可以被加载/保存和远程触发，但多播代理不能使用返回值。</li>
</ul>
<p>多播代理可以具有多个绑定，当<code>Broadcast</code>触发时，所有的绑定都会被调用。</p>
<p>多播代理可以使用<code>Add</code>/<code>AddStatic</code>/<code>AddRaw</code>/<code>AddSP</code>/<code>AddUObject</code>/<code>Remove</code>/<code>RemoveAll</code>等函数。</p>
<blockquote>
<p>注意：RemoveAll会删除所有绑定时提供指针的代理，未绑定到对象的<code>Raw</code>代理不会被该函数删除。</p>
</blockquote>
<h3 id="Dynamic-Multicast-Delegate"><a href="#Dynamic-Multicast-Delegate" class="headerlink" title="Dynamic Multicast Delegate"></a>Dynamic Multicast Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_MULITCAST_DELEGATE</code>：动态多播代理。</li>
</ul>
<p>动态多播代理必须要绑定到UFUNCTION的函数，使用宏<code>AddDynamic</code>或者<code>AddUnique</code>来添加绑定。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FOnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>
<p><code>DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</code>其宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam( DelegateName, Param1Type, Param1Name )\</span></span><br><span class="line"> <span class="built_in">BODY_MACRO_COMBINE</span>(CURRENT_FILE_ID,_,__LINE__,_DELEGATE)\</span><br><span class="line"> <span class="built_in">FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE</span>( FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, <span class="built_in">FUNC_CONCAT</span>( Param1Type InParam1 ), <span class="built_in">FUNC_CONCAT</span>( *<span class="keyword">this</span>, InParam1 ), <span class="keyword">void</span>, Param1Type )</span><br></pre></td></tr></table></figure>
<p>其中<code>BODY_MACRO_COMBINE</code>经过UHT之后生成下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms</span> \</span></span><br><span class="line"><span class="class">&#123;</span> \</span><br><span class="line">	FString InStr; \</span><br><span class="line">&#125;; \</span><br><span class="line">static inline void FOnTestDynamicMultiDelegate_DelegateWrapper(const FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, const FString&amp; InStr) \</span><br><span class="line">&#123; \</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms; \</span><br><span class="line">	Parms.InStr=InStr; \</span><br><span class="line">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate&lt;UObject&gt;(&amp;Parms); \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE</code>则创建了一个继承自<code>TBaseDynamicMulticastDelegate</code>类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic multi-cast delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE(TWeakPtr, DynamicMulticastDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ...) \</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicMulticastDelegateName</span> :</span> <span class="keyword">public</span> TBaseDynamicMulticastDelegate&lt;TWeakPtr, __VA_ARGS__&gt; \</span><br><span class="line">	&#123; \</span><br><span class="line">	<span class="keyword">public</span>: \</span><br><span class="line">		<span class="comment">/** Default constructor */</span> \</span><br><span class="line">		<span class="built_in">DynamicMulticastDelegateName</span>() \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Construction from an FMulticastScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span><br><span class="line">		explicit DynamicMulticastDelegateName( const TMulticastScriptDelegate&lt;&gt;&amp; InMulticastScriptDelegate ) \</span><br><span class="line">			: TBaseDynamicMulticastDelegate&lt;TWeakPtr, __VA_ARGS__&gt;( InMulticastScriptDelegate ) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Broadcasts this delegate to all bound objects, except to those that may have expired */</span> \</span><br><span class="line">		void Broadcast( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="built_in">ExecFunction</span>( FuncParamPassThru ); \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<p><code>FUNC_CONCT</code>宏只是简单的拼接：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Helper macro that enables passing comma-separated arguments as a single macro parameter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_CONCAT( ... ) __VA_ARGS__</span></span><br></pre></td></tr></table></figure>
<p>展开所有宏之后的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicMultiDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicMultiDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	<span class="built_in">FOnTestDynamicMultiDelegate</span>() &#123; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FOnTestDynamicMultiDelegate</span><span class="params">( <span class="keyword">const</span> TMulticastScriptDelegate&lt;&gt;&amp; InMulticastScriptDelegate )</span> : TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;( InMulticastScriptDelegate ) &#123;</span> &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Broadcast</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">FOnTestDynamicMultiDelegate_DelegateWrapper</span>( *<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注，由上面的代码可知，只有普通代理（<code>DECLARE_DELEGATE</code>）声明的代理才可以使用<code>TBaseDelegate</code>的<code>BindUObject</code>等函数，动态代理和多播代理都不可以。</p>
</blockquote>
<h2 id="Pak所包含的文件"><a href="#Pak所包含的文件" class="headerlink" title="Pak所包含的文件"></a>Pak所包含的文件</h2><p>默认情况下（未设置忽略文件）UE4的Package时会把游戏的资源打包到一个Pak文件中，具体有以下内容：</p>
<p>以下描述中有几个关键字：<code>PROJECT_NAME</code>项目名，<code>PLATFORN_NAME</code>打包的平台名。</p>
<ul>
<li>Package时不会检测资源是否有引用，工程内的所有资源都会被Cook然后打包到Pak里；</li>
<li>引擎Slate的资源文件<code>Engine\Content\Slate\</code>，字体/图片等等</li>
<li>引擎的<code>Content\Internationalization</code>下相关语言的文件</li>
<li>引擎和启用插件目录下的<code>Content\Localization</code>的<code>locmeta</code>/<code>locres</code>文件</li>
<li>项目的<code>uproject</code>文件，挂载点为<code>../../../PROJECT_NAME/PROJECT_NAME.uproject</code>；</li>
<li>项目启用的所有插件的<code>uplugin</code>文件，挂载点为插件的相对与<code>../../../Engine/</code>或者<code>../../../PROJECT_NAME/Plugins/</code>的路径；</li>
<li>项目目录下<code>Intermediate\Staging\PROJECT_NAME.upluginmanifest</code>文件，挂载点为<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></li>
<li>引擎的ini文件，在引擎的<code>Engine/Config</code>下除了<code>Editor</code>的ini和<code>BaseLightmass.ini</code>/<code>BasePakFileRules.ini</code>之外都包含；</li>
<li>引擎下平台的ini，在<code>Engine/Config/PLATFORM_NAME</code>内的所有ini文件；</li>
<li>项目启用的插件的ini，在插件的目录的config下；</li>
<li>Cook出来的<code>AssetRegistry.bin</code>；</li>
<li>Cook出的<code>PLATFORN_NAME\Engine\GlobalShaderCache*.bin</code>；</li>
<li>Cook出来的<code>PLATFORM_NAME\PROJECT_NAME\Content\ShaderArchive-*.ushaderbytecode</code>文件</li>
</ul>
<h2 id="Mount-Pak时的一个问题"><a href="#Mount-Pak时的一个问题" class="headerlink" title="Mount Pak时的一个问题"></a>Mount Pak时的一个问题</h2><p>UE在Mount时调用的是<code>FPakPlatformFile::Mount</code>，对于要Mount的Pak创建了一个<code>FPakFile</code>的对象，该对象会存储到<code>FPakPlatformFile::PakFiles</code>中。</p>
<p>问题就出在这个<code>PakFiles</code>上，其声明为<code>TArray&lt;FPakListEntry&gt;</code>，而<code>FPakListEntry</code>这个struct是定义在类<code>FPakPlatformFile</code>中的类，而且还是个私有的类定义，在外部无法访问，虽然<code>FPakPlatformFile</code>中有<code>GetMountedPaks</code>这个函数，但是传入的参数外部无法定义（因为是私有的）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformPak.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PAKFILE_API</span> <span class="title">FPakPlatformFile</span> :</span> <span class="keyword">public</span> IPlatformFile</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FPakListEntry</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="built_in">FPakListEntry</span>()</span><br><span class="line">			: <span class="built_in">ReadOrder</span>(<span class="number">0</span>)</span><br><span class="line">			, <span class="built_in">PakFile</span>(<span class="literal">nullptr</span>)</span><br><span class="line">		&#123;&#125;</span><br><span class="line"></span><br><span class="line">		uint32		ReadOrder;</span><br><span class="line">		FPakFile*	PakFile;</span><br><span class="line"></span><br><span class="line">		FORCEINLINE <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> FPakListEntry&amp; RHS) <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ReadOrder &gt; RHS.ReadOrder;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets mounted pak files</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">GetMountedPaks</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">		Paks.<span class="built_in">Append</span>(PakFiles);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以在不改动引擎源码的情况下无法直接得到已经Mount的Pak列表，有点坑。</p>
<p>绕一圈可以使用的方法为<code>FPakPlatformFile::GetMountedPakFilenames</code>用来获取当前已经Mount的Pak列表：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get a list of all pak files which have been successfully mounted</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">GetMountedPakFilenames</span><span class="params">(TArray&lt;FString&gt;&amp; PakFilenames)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">	PakFilenames.<span class="built_in">Empty</span>(PakFiles.<span class="built_in">Num</span>());</span><br><span class="line">	<span class="keyword">for</span> (FPakListEntry&amp; Entry : PakFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		PakFilenames.<span class="built_in">Add</span>(Entry.PakFile-&gt;<span class="built_in">GetFilename</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再通过<code>IPlatformFilePak::FindFileInPakFiles</code>可以获取到已经Mount的某个Pak的<code>FPakFile</code>实例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds a file in all available pak files.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment"> * @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment"> * @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, FPakFile** OutPakFile = <span class="literal">nullptr</span>, FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FPakListEntry&gt; Paks;</span><br><span class="line">	<span class="built_in">GetMountedPaks</span>(Paks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">FindFileInPakFiles</span>(Paks, Filename, OutPakFile, OutEntry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过传入Pak的路径信息来得到FPakFile。</p>
<h2 id="FScopeSlowTask"><a href="#FScopeSlowTask" class="headerlink" title="FScopeSlowTask"></a>FScopeSlowTask</h2><p>执行一些任务的时候可以显示进度。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Editor-SlowTask-progress.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> AmountOfWorkProgress = <span class="number">2.0f</span>;</span><br><span class="line"><span class="function">FScopeSlowTask <span class="title">SlowTask</span><span class="params">(AmountOfWorkProgress)</span></span>;</span><br><span class="line">SlowTask.<span class="built_in">MakeDialog</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// something</span></span><br><span class="line"><span class="comment">// Update SlowTask Progress</span></span><br><span class="line">&#123;</span><br><span class="line">	FText Dialog = FText::<span class="built_in">Format</span>(<span class="built_in">NSLOCTEXT</span>(<span class="string">&quot;ExportPatch&quot;</span>, <span class="string">&quot;GeneratedPak&quot;</span>, <span class="string">&quot;Generating Pak list of &#123;0&#125; Platform.&quot;</span>), FText::<span class="built_in">FromString</span>(PlatformName));</span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">1.0</span>, Dialog);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// something</span></span><br></pre></td></tr></table></figure>
<p>需要注意两点：</p>
<ol>
<li><code>EnterProgressFrame</code>传入的参数每次为<code>1.0f</code>即可，里面是累增的。</li>
<li>不要在一个函数里创建多个<code>FScopeSlowTask</code>的<code>Dialog</code>，会有窗口消不掉的问题（UE_4.22.3）。</li>
</ol>
<h2 id="MD5Hash"><a href="#MD5Hash" class="headerlink" title="MD5Hash"></a>MD5Hash</h2><p>在UE中计算文件的MD5Hash值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FMD5Hash FileHash = FMD5Hash::<span class="built_in">HashFile</span>(*InFile);</span><br><span class="line">FString HashValue = <span class="built_in">LexToString</span>(FileHash);</span><br></pre></td></tr></table></figure>

<h2 id="运行时在Pak中访问非资源文件"><a href="#运行时在Pak中访问非资源文件" class="headerlink" title="运行时在Pak中访问非资源文件"></a>运行时在Pak中访问非资源文件</h2><p>可以把一些非UE资源文件（比如txt，视频）等文件打包到Pak中，在游戏运行中访问，可以使用我上面写的HotPatcher工具来打包，这里写一下在运行时访问的方法。</p>
<p>首先将文件打包到Pak：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/package-outside-file-to-pak.webp"></p>
<p>这里我是将文件<code>AAAAA.json</code>打包到了Pak中，其挂载路径为<code>../../../PROJECT_NAME/AAAAA.json</code>.</p>
<p>在游戏中访问一定要使用挂载路径，可以使用<code>FPaths::ProjectDir</code>在打包后获取到的是相对路径，在PIE下是项目的相对路径。</p>
<p>使用方法：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/load-extern-file-form-pak-in-runtime.webp"></p>
<p>其中的<code>PeojectDir</code>是<code>FPaths::ProjectDir</code>，<code>LoadFileToString</code>则是<code>IFileManager::LoadFileToString</code>的封装。</p>
<p>运行结果：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-pak-not-asset-file-in-package-game.webp"></p>
<p>如果想要访问打包出的项目文件和挂载的Pak中的文件，可以使用下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPakVisitorHelper::VisitorProjectDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"></span><br><span class="line">	FFillArrayDirectoryVisitor Visitor;</span><br><span class="line">	PlatformFile.<span class="built_in">IterateDirectory</span>(*FPaths::<span class="built_in">ProjectDir</span>(), Visitor);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogTemp,Log,<span class="built_in">TEXT</span>(<span class="string">&quot;Found Files:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; File : Visitor.Files)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *File);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Found Directorys:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Dir : Visitor.Directories)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *Dir);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>IPlatformFile::IterateDirectory</code>这个函数有两个原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory, FDirectoryVisitor Visitor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory,FDirectoryVisitorFunc Visitor)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以传入一个继承自<code>FDirectoryVisitor</code>的对象，或者传入一个下列签名的函数对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> TFunctionRef &lt; <span class="built_in"><span class="keyword">bool</span></span>(<span class="keyword">const</span> TCHAR *, <span class="keyword">bool</span>)&gt; FDirectoryVisitorFunc</span><br></pre></td></tr></table></figure>

<p>支持传入一个Lambda也是可以的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;FString&gt; Files;</span><br><span class="line">TArray&lt;FString&gt; Dirs;</span><br><span class="line"></span><br><span class="line">IPlatformFile&amp; PlatformFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>();</span><br><span class="line"><span class="keyword">auto</span> FallArrayDirVisitor = [&amp;Files,&amp;Dirs](<span class="keyword">const</span> TCHAR* InItem,<span class="keyword">bool</span> bInDir)-&gt;<span class="keyword">bool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (bInDir)</span><br><span class="line">	&#123;</span><br><span class="line">		Dirs.<span class="built_in">AddUnique</span>(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Files.<span class="built_in">AddUnique</span>(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line">PlatformFile.<span class="built_in">IterateDirectory</span>(*InRelativePath, FallArrayDirVisitor);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Paks/visitor-projectdir.webp"></p>
<p><code>AssetRegistry.bin</code>/<code>*.uproject</code>等文件都是在打包的时候打包进pak里的，<code>AAAAA.json</code>则是上面手动打到Patch的Pak里的。</p>
<h2 id="枚举的反射信息"><a href="#枚举的反射信息" class="headerlink" title="枚举的反射信息"></a>枚举的反射信息</h2><p>下列枚举类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ETargetPlatform.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UENUM</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	AllDesktop,</span><br><span class="line">	MacClient,</span><br><span class="line">	MacNoEditor,</span><br><span class="line">	MacServer,</span><br><span class="line">	Mac,</span><br><span class="line">	WindowsClient,</span><br><span class="line">	WindowsNoEditor,</span><br><span class="line">	WindowsServer,</span><br><span class="line">	Windows,</span><br><span class="line">	Android,</span><br><span class="line">	Android_ASTC,</span><br><span class="line">	Android_ATC,</span><br><span class="line">	Android_DXT,</span><br><span class="line">	Android_ETC1,</span><br><span class="line">	Android_ETC1a,</span><br><span class="line">	Android_ETC2,</span><br><span class="line">	Android_PVRTC,</span><br><span class="line">	AndroidClient,</span><br><span class="line">	Android_ASTCClient,</span><br><span class="line">	Android_ATCClient,</span><br><span class="line">	Android_DXTClient,</span><br><span class="line">	Android_ETC1Client,</span><br><span class="line">	Android_ETC1aClient,</span><br><span class="line">	Android_ETC2Client,</span><br><span class="line">	Android_PVRTCClient,</span><br><span class="line">	Android_Multi,</span><br><span class="line">	Android_MultiClient,</span><br><span class="line">	HTML5,</span><br><span class="line">	IOSClient,</span><br><span class="line">	IOS,</span><br><span class="line">	TVOSClient,</span><br><span class="line">	TVOS,</span><br><span class="line">	LinuxClient,</span><br><span class="line">	LinuxNoEditor,</span><br><span class="line">	LinuxServer,</span><br><span class="line">	Linux,</span><br><span class="line">	Lumin,</span><br><span class="line">	LuminClient</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过UHT之后的反射代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ObjectMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ScriptMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;ETargetPlatform.generated.h already included, missing &#x27;#pragma once&#x27; in ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CURRENT_FILE_ID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURRENT_FILE_ID HotThirdPerson_Plugins_ue4_HotPackage_HotPatcher_Source_HotPatcherRuntime_Public_ETargetPlatform_h</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETARGETPLATFORM(op) \</span></span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::AllDesktop) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::MacClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::MacNoEditor) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::MacServer) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Mac) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::WindowsClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::WindowsNoEditor) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::WindowsServer) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Windows) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ASTC) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ATC) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_DXT) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC1) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC1a) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC2) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_PVRTC) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::AndroidClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ASTCClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ATCClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_DXTClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC1Client) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC1aClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_ETC2Client) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_PVRTCClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_Multi) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Android_MultiClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::HTML5) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::IOSClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::IOS) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::TVOSClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::TVOS) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::LinuxClient) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::LinuxNoEditor) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::LinuxServer) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Linux) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::Lumin) \</span><br><span class="line">	<span class="built_in">op</span>(ETargetPlatform::LuminClient) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;();</span><br><span class="line"></span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br></pre></td></tr></table></figure>

<p>产生的<code>gen.cpp</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/GeneratedCppIncludes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherRuntime/Public/ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (disable : 4883)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeETargetPlatform</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// Cross Module References</span></span><br><span class="line">	<span class="function">HOTPATCHERRUNTIME_API UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_HotPatcherRuntime</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETargetPlatform_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = <span class="built_in">GetStaticEnum</span>(Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform, <span class="built_in">Z_Construct_UPackage__Script_HotPatcherRuntime</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">ETargetPlatform_StaticEnum</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETargetPlatform</span><span class="params">(ETargetPlatform_StaticEnum, TEXT(<span class="string">&quot;/Script/HotPatcherRuntime&quot;</span>), TEXT(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2902485356U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = <span class="built_in">Z_Construct_UPackage__Script_HotPatcherRuntime</span>();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="built_in">FindExistingEnumIfHotReloadOrDynamic</span>(Outer, <span class="built_in">TEXT</span>(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="number">0</span>, <span class="built_in">Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash</span>(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AllDesktop&quot;</span>, (int64)ETargetPlatform::AllDesktop &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacClient&quot;</span>, (int64)ETargetPlatform::MacClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacNoEditor&quot;</span>, (int64)ETargetPlatform::MacNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacServer&quot;</span>, (int64)ETargetPlatform::MacServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Mac&quot;</span>, (int64)ETargetPlatform::Mac &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsClient&quot;</span>, (int64)ETargetPlatform::WindowsClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsNoEditor&quot;</span>, (int64)ETargetPlatform::WindowsNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsServer&quot;</span>, (int64)ETargetPlatform::WindowsServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Windows&quot;</span>, (int64)ETargetPlatform::Windows &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android&quot;</span>, (int64)ETargetPlatform::Android &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTC&quot;</span>, (int64)ETargetPlatform::Android_ASTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATC&quot;</span>, (int64)ETargetPlatform::Android_ATC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXT&quot;</span>, (int64)ETargetPlatform::Android_DXT &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1&quot;</span>, (int64)ETargetPlatform::Android_ETC1 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1a&quot;</span>, (int64)ETargetPlatform::Android_ETC1a &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2&quot;</span>, (int64)ETargetPlatform::Android_ETC2 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTC&quot;</span>, (int64)ETargetPlatform::Android_PVRTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AndroidClient&quot;</span>, (int64)ETargetPlatform::AndroidClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTCClient&quot;</span>, (int64)ETargetPlatform::Android_ASTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATCClient&quot;</span>, (int64)ETargetPlatform::Android_ATCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXTClient&quot;</span>, (int64)ETargetPlatform::Android_DXTClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1Client&quot;</span>, (int64)ETargetPlatform::Android_ETC1Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1aClient&quot;</span>, (int64)ETargetPlatform::Android_ETC1aClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2Client&quot;</span>, (int64)ETargetPlatform::Android_ETC2Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTCClient&quot;</span>, (int64)ETargetPlatform::Android_PVRTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_Multi&quot;</span>, (int64)ETargetPlatform::Android_Multi &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_MultiClient&quot;</span>, (int64)ETargetPlatform::Android_MultiClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::HTML5&quot;</span>, (int64)ETargetPlatform::HTML5 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOSClient&quot;</span>, (int64)ETargetPlatform::IOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOS&quot;</span>, (int64)ETargetPlatform::IOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOSClient&quot;</span>, (int64)ETargetPlatform::TVOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOS&quot;</span>, (int64)ETargetPlatform::TVOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxClient&quot;</span>, (int64)ETargetPlatform::LinuxClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxNoEditor&quot;</span>, (int64)ETargetPlatform::LinuxNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxServer&quot;</span>, (int64)ETargetPlatform::LinuxServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Linux&quot;</span>, (int64)ETargetPlatform::Linux &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Lumin&quot;</span>, (int64)ETargetPlatform::Lumin &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LuminClient&quot;</span>, (int64)ETargetPlatform::LuminClient &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/ETargetPlatform.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_HotPatcherRuntime,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				<span class="built_in">ARRAY_COUNT</span>(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				<span class="built_in">METADATA_PARAMS</span>(Enum_MetaDataParams, <span class="built_in">ARRAY_COUNT</span>(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::<span class="built_in">ConstructUEnum</span>(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (pop)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>枚举值的名字可以通过下列方法获得：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString PlatformName = StaticEnum&lt;ETargetPlatform&gt;()-&gt;<span class="built_in">GetNameByValue</span>((int64)Platform).<span class="built_in">ToString</span>();</span><br></pre></td></tr></table></figure>
<p>其得到的值是具有namespace的，如<code>ETargetPlatform::WindowsNoEditor</code>.</p>
<p>如果不想要namespace可以使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FString PlatformName;</span><br><span class="line">&#123;</span><br><span class="line">	FString EnumName;</span><br><span class="line">	StaticEnum&lt;ETargetPlatform&gt;()-&gt;<span class="built_in">GetNameByValue</span>((int64)Platform).<span class="built_in">ToString</span>().<span class="built_in">Split</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;::&quot;</span>), &amp;EnumName, &amp;PlatformName,ESearchCase::CaseSensitive,ESearchDir::FromEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建存储文件的提示"><a href="#创建存储文件的提示" class="headerlink" title="创建存储文件的提示"></a>创建存储文件的提示</h2><p>如下图这种效果：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4_SaveFile_Notifications.webp"></p>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">FString SaveToFile = FPaths::<span class="built_in">Combine</span>(ExportReleaseSettings-&gt;<span class="built_in">GetSavePath</span>(), ExportReleaseSettings-&gt;<span class="built_in">GetVersionId</span>() + <span class="built_in">TEXT</span>(<span class="string">&quot;.json&quot;</span>));</span><br><span class="line"><span class="keyword">bool</span> runState = UFLibAssetManageHelperEx::<span class="built_in">SaveStringToFile</span>(SaveToFile,SaveToJson);</span><br><span class="line"><span class="keyword">if</span> (runState)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> Message = <span class="built_in">LOCTEXT</span>(<span class="string">&quot;ExportReleaseSuccessNotification&quot;</span>, <span class="string">&quot;Succeed to export HotPatcher Release Version.&quot;</span>);</span><br><span class="line">	<span class="function">FNotificationInfo <span class="title">Info</span><span class="params">(Message)</span></span>;</span><br><span class="line">	Info.bFireAndForget = <span class="literal">true</span>;</span><br><span class="line">	Info.ExpireDuration = <span class="number">5.0f</span>;</span><br><span class="line">	Info.bUseSuccessFailIcons = <span class="literal">false</span>;</span><br><span class="line">	Info.bUseLargeFont = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> FString HyperLinkText = SaveToFile;</span><br><span class="line">	Info.Hyperlink = FSimpleDelegate::<span class="built_in">CreateStatic</span>(</span><br><span class="line">		[](FString SourceFilePath)</span><br><span class="line">		&#123;</span><br><span class="line">			FPlatformProcess::<span class="built_in">ExploreFolder</span>(*SourceFilePath);</span><br><span class="line">		&#125;,</span><br><span class="line">		HyperLinkText</span><br><span class="line">	);</span><br><span class="line">	Info.HyperlinkText = FText::<span class="built_in">FromString</span>(HyperLinkText);</span><br><span class="line"></span><br><span class="line">	FSlateNotificationManager::<span class="built_in">Get</span>().<span class="built_in">AddNotification</span>(Info)-&gt;<span class="built_in">SetCompletionState</span>(SNotificationItem::CS_Success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="获取工程所有的Map"><a href="#获取工程所有的Map" class="headerlink" title="获取工程所有的Map"></a>获取工程所有的Map</h2><p>从<code>Developer/LauncherService/GameProjectHelper.h</code>中抽出来的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TArray&lt;FString&gt; <span class="title">UFlibPatchParserHelper::GetAvailableMaps</span><span class="params">(FString GameName, <span class="keyword">bool</span> IncludeEngineMaps, <span class="keyword">bool</span> Sorted)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FString&gt; Result;</span><br><span class="line">	TArray&lt;FString&gt; EnginemapNames;</span><br><span class="line">	TArray&lt;FString&gt; ProjectMapNames;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> FString WildCard = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;*%s&quot;</span>), *FPackageName::<span class="built_in">GetMapPackageExtension</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Scan all Content folder, because not all projects follow Content/Maps convention</span></span><br><span class="line">	IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ProjectMapNames, *FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">RootDir</span>(), *GameName, <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// didn&#x27;t find any, let&#x27;s check the base GameName just in case it is a full path</span></span><br><span class="line">	<span class="keyword">if</span> (ProjectMapNames.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(ProjectMapNames, *FPaths::<span class="built_in">Combine</span>(*GameName, <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; ProjectMapNames.<span class="built_in">Num</span>(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.<span class="built_in">Add</span>(FPaths::<span class="built_in">GetBaseFilename</span>(ProjectMapNames[i]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IncludeEngineMaps)</span><br><span class="line">	&#123;</span><br><span class="line">		IFileManager::<span class="built_in">Get</span>().<span class="built_in">FindFilesRecursive</span>(EnginemapNames, *FPaths::<span class="built_in">Combine</span>(*FPaths::<span class="built_in">RootDir</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;Maps&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; EnginemapNames.<span class="built_in">Num</span>(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			Result.<span class="built_in">Add</span>(FPaths::<span class="built_in">GetBaseFilename</span>(EnginemapNames[i]));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Sorted)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.<span class="built_in">Sort</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AssetRegistry的Asset概念"><a href="#AssetRegistry的Asset概念" class="headerlink" title="AssetRegistry的Asset概念"></a>AssetRegistry的Asset概念</h2><p>UE中的Asset在使用时有以下三个概念：</p>
<ul>
<li>PackagePath：<code>/Game/TEST/BP_Actor.BP_Actor</code></li>
<li>LongPackageName：<code>/Game/TEST/BP_Actor</code></li>
<li>AssetName： <code>BP_Actor</code></li>
</ul>
<h2 id="获取所有支持的平台"><a href="#获取所有支持的平台" class="headerlink" title="获取所有支持的平台"></a>获取所有支持的平台</h2><p>在Module<code>TargetPlatform</code>中可以获取：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;ITargetPlatform*&gt; Platforms = <span class="built_in">GetTargetPlatformManager</span>()-&gt;<span class="built_in">GetTargetPlatforms</span>();</span><br></pre></td></tr></table></figure>

<p>但是注意，<code>TargetPlatform</code>是属于<code>Developer</code>的模块，不要在<code>Runtime</code>的模块中使用，否则会打包失败。</p>
<p>所以用宏简单裹了一下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TArray&lt;FString&gt; <span class="title">UFlibAssetManageHelper::GetAllTargetPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __DEVELOPER_MODE__</span></span><br><span class="line">	TArray&lt;ITargetPlatform*&gt; Platforms = <span class="built_in">GetTargetPlatformManager</span>()-&gt;<span class="built_in">GetTargetPlatforms</span>();</span><br><span class="line">	TArray&lt;FString&gt; result;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; PlatformItem : Platforms)</span><br><span class="line">	&#123;</span><br><span class="line">		result.<span class="built_in">Add</span>(PlatformItem-&gt;<span class="built_in">PlatformName</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	TArray&lt;FString&gt; result = &#123;</span><br><span class="line">		<span class="string">&quot;AllDesktop&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Mac&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Windows&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ASTC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ATC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_DXT&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1a&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC2&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_PVRTC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;AndroidClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ASTCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ATCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_DXTClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1Client&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1aClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC2Client&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_PVRTCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_Multi&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_MultiClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;HTML5&quot;</span>,</span><br><span class="line">		<span class="string">&quot;IOSClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;IOS&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TVOSClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TVOS&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Lumin&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LuminClient&quot;</span> </span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="递归扫描目录"><a href="#递归扫描目录" class="headerlink" title="递归扫描目录"></a>递归扫描目录</h2><p>与直接使用<code>IFileManager::Get().FindFiles</code>不同，<code>IFileManager::Get().FindFiles</code>只能由获取指定目录下的所有文件而无法递归扫描，可以使用<code>IFileManager::Get().IterateDirectoryRecursively</code>来解决。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FFillArrayDirectoryVisitor</span> :</span> <span class="keyword">public</span> IPlatformFile::FDirectoryVisitor</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Visit</span><span class="params">(<span class="keyword">const</span> TCHAR* FilenameOrDirectory, <span class="keyword">bool</span> bIsDirectory)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (bIsDirectory)</span><br><span class="line">		&#123;</span><br><span class="line">			Directories.<span class="built_in">Add</span>(FilenameOrDirectory);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Files.<span class="built_in">Add</span>(FilenameOrDirectory);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TArray&lt;FString&gt; Directories;</span><br><span class="line">	TArray&lt;FString&gt; Files;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">FFillArrayDirectoryVisitor FileVisitor;</span><br><span class="line">IFileManager::<span class="built_in">Get</span>().<span class="built_in">IterateDirectoryRecursively</span>(*InStartDir, FileVisitor);</span><br></pre></td></tr></table></figure>

<p>其实就是要创建一个继承自<code>IPlatformFile::FDirectoryVisitor</code>的筛选类。</p>
<h2 id="获取系统环境变量"><a href="#获取系统环境变量" class="headerlink" title="获取系统环境变量"></a>获取系统环境变量</h2><p>可以使用<code>FPlatformMisc::GetEnvironmentVariable</code>来拿：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString FindEnvGitPath = FPlatformMisc::<span class="built_in">GetEnvironmentVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GIT_PATH&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="运行时获取git-diff的内容"><a href="#运行时获取git-diff的内容" class="headerlink" title="运行时获取git diff的内容"></a>运行时获取git diff的内容</h2><p>做热更新有用到：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/git-diff-in-ue4-no-runtime.webp"></p>
<h2 id="获取Asset的依赖关系"><a href="#获取Asset的依赖关系" class="headerlink" title="获取Asset的依赖关系"></a>获取Asset的依赖关系</h2><p>在UE中想要获取一个资源对其他资源的依赖关系可以通过<code>AsserRegistryModule</code>来拿:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">FStringAssetReference InAssetRef = <span class="built_in">TEXT</span>(<span class="string">&quot;/Game/Pak/Cube.Cube&quot;</span>);</span><br><span class="line">FString InTargetLongPackageName = InAssetRef.<span class="built_in">GetLongPackageName</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> bSuccessed = AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetDependencies</span>(<span class="built_in">FName</span>(*InTargetLongPackageName), local_Dependencies, EAssetRegistryDependencyType::Packages);</span><br></pre></td></tr></table></figure>
<p>完整的函数如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibAssetManageHelper::GetAssetDependencies</span><span class="params">(<span class="keyword">const</span> FString&amp; InAsset, FAssetDependenciesInfo&amp; OutDependInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (InAsset.<span class="built_in">IsEmpty</span>())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  FStringAssetReference AssetRef = <span class="built_in">FStringAssetReference</span>(InAsset);</span><br><span class="line">  <span class="keyword">if</span> (!AssetRef.<span class="built_in">IsValid</span>())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FStringAssetReference InAssetRef = InAsset;</span><br><span class="line">  FString TargetLongPackageName = InAssetRef.<span class="built_in">GetLongPackageName</span>();</span><br><span class="line">  <span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;TargetLongPackageName is %s.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">  <span class="keyword">if</span> (FPackageName::<span class="built_in">DoesPackageExist</span>(TargetLongPackageName))</span><br><span class="line">  &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      TArray&lt;FAssetData&gt; AssetDataList;</span><br><span class="line">      <span class="keyword">bool</span> bResault = AssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetAssetsByPackageName</span>(<span class="built_in">FName</span>(*TargetLongPackageName), AssetDataList);</span><br><span class="line">      <span class="keyword">if</span> (!bResault || !AssetDataList.<span class="built_in">Num</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Faild to Parser AssetData of %s, please check.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (AssetDataList.<span class="built_in">Num</span>() &gt; <span class="number">1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogTemp, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Got mulitple AssetData of %s,please check.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    UFlibAssetManageHelper::<span class="built_in">GatherAssetDependicesInfoRecursively</span>(AssetRegistryModule, TargetLongPackageName, OutDependInfo.InContent, OutDependInfo.InOther);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以写个递归获取的函数:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibAssetManageHelper::GatherAssetDependicesInfoRecursively</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  FAssetRegistryModule&amp; InAssetRegistryModule,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> FString&amp; InTargetLongPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">  TArray&lt;FString&gt;&amp; OutDependInContent,</span></span></span><br><span class="line"><span class="function"><span class="params">  TArray&lt;FString&gt;&amp; OutDependInOther</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TArray&lt;FName&gt; local_Dependencies;</span><br><span class="line">  <span class="keyword">bool</span> bGetDependenciesSuccess = InAssetRegistryModule.<span class="built_in">Get</span>().<span class="built_in">GetDependencies</span>(<span class="built_in">FName</span>(*InTargetLongPackageName), local_Dependencies, EAssetRegistryDependencyType::Packages);</span><br><span class="line">  <span class="keyword">if</span> (bGetDependenciesSuccess)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;DependItem : local_Dependencies)</span><br><span class="line">    &#123;</span><br><span class="line">      FString LongDependentPackageName = DependItem.<span class="built_in">ToString</span>();</span><br><span class="line">      <span class="keyword">if</span> (LongDependentPackageName.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Game&quot;</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (OutDependInContent.<span class="built_in">Find</span>(LongDependentPackageName) == INDEX_NONE)</span><br><span class="line">        &#123;</span><br><span class="line">          OutDependInContent.<span class="built_in">Add</span>(LongDependentPackageName);</span><br><span class="line">          <span class="built_in">GatherAssetDependicesInfoRecursively</span>(InAssetRegistryModule, LongDependentPackageName, OutDependInContent, OutDependInOther);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (OutDependInOther.<span class="built_in">Find</span>(LongDependentPackageName) == INDEX_NONE)</span><br><span class="line">        &#123;</span><br><span class="line">          OutDependInOther.<span class="built_in">Add</span>(LongDependentPackageName);</span><br><span class="line">          <span class="built_in">GatherAssetDependicesInfoRecursively</span>(InAssetRegistryModule, LongDependentPackageName, OutDependInContent, OutDependInOther);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方法:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp.webp"></p>
<p>运行结果:</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp-print.webp"></p>
<h2 id="Android屏幕方向"><a href="#Android屏幕方向" class="headerlink" title="Android屏幕方向"></a>Android屏幕方向</h2><p>在<code>Project Setting</code>-<code>Platforms</code>-<code>Android</code>-<code>APK Packageing</code>-<code>Orientation</code>：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-android-screen-rotate.webp"></p>
<h2 id="SoftClassReference"><a href="#SoftClassReference" class="headerlink" title="SoftClassReference"></a>SoftClassReference</h2><p>在UE中可以使用<code>SoftClassReference</code>保持资源的相对引用，其存储的是资源的<strong>路径</strong>而不是直接对类的引用，如果直接使用<code>UClass</code>是硬引用，如果需要动态加载某些资源，如果之前使用的是硬引用则会Crash。</p>
<ul>
<li><code>/Game</code>代表工程文件夹的Content目录</li>
<li><code>/Engine</code>代表引擎目录下的<code>Content</code>目录</li>
<li>C++类的资源路径是<code>/Script/MODULE_NAME.CLASS_NAME</code></li>
</ul>
<p>如</p>
<ol>
<li><code>AActor</code>的SoftrClassReference的路径是:<code>/Script/Engine.Actor</code></li>
<li><code>AActorController</code>的SoftClassReference的路径是<code>/Script/AIModule.AIController</code></li>
</ol>
<ul>
<li>BP类的资源路径和C++不同，是资源相对于Content的路径+<code>BP_CLASS_NAME_C</code></li>
</ul>
<p>如：有一个蓝图<code>Content/Pak/Cube.uasset</code>，其的SoftClassReference路径为<code>/Game/Pak/Cube.Cube_C</code>。</p>
<h2 id="Http下载文件"><a href="#Http下载文件" class="headerlink" title="Http下载文件"></a>Http下载文件</h2><p>可以使用UE4的HTTP模块使用GET方法来从网络获取文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlibHttpHeler.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/BlueprintFunctionLibrary.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FlibHttpHelper.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_DELEGATE_OneParam</span>(FOnRequestSuccessed,<span class="keyword">const</span> TArray&lt;uint8&gt;&amp;,ResponseContent);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_DELEGATE_TwoParams</span>(FOnRequestFailed, FString, ErrorText, int32, ErrorCode);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">UFlibHttpHelper</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">HttpDownloadRequest</span><span class="params">(<span class="keyword">const</span> FString&amp; URL, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnRequestContentReady</span><span class="params">(FHttpRequestPtr Request,FHttpResponsePtr Response,<span class="keyword">bool</span> Successed,FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlibHttpHelper.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FlibHttpHelper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HttpModule.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpResponse.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibHttpHelper::HttpDownloadRequest</span><span class="params">(<span class="keyword">const</span> FString&amp; URL, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TSharedRef&lt;<span class="class"><span class="keyword">class</span> <span class="title">IHttpRequest</span>&gt;</span> HttpRequest = FHttpModule::<span class="built_in">Get</span>().<span class="built_in">CreateRequest</span>();</span><br><span class="line">	HttpRequest-&gt;<span class="built_in">OnProcessRequestComplete</span>().<span class="built_in">BindStatic</span>(UFlibHttpHelper::OnRequestContentReady, OnSuccessed, OnFaild);</span><br><span class="line">	HttpRequest-&gt;<span class="built_in">SetURL</span>(*URL);</span><br><span class="line">	HttpRequest-&gt;<span class="built_in">SetVerb</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Get&quot;</span>));</span><br><span class="line">	HttpRequest-&gt;<span class="built_in">ProcessRequest</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibHttpHelper::OnRequestContentReady</span><span class="params">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class="keyword">bool</span> Successed, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Successed || !Response.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		OnFaild.<span class="built_in">ExecuteIfBound</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Faild&quot;</span>), <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	int32 ResponseCode = Response-&gt;<span class="built_in">GetResponseCode</span>();</span><br><span class="line">	<span class="keyword">if</span> (!EHttpResponseCodes::<span class="built_in">IsOk</span>(ResponseCode))</span><br><span class="line">	&#123;</span><br><span class="line">		OnFaild.<span class="built_in">ExecuteIfBound</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;HttpDownloadRequest faild, Respose Code is %d.&quot;</span>),ResponseCode), ResponseCode);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	TArray&lt;uint8&gt; ResponseContent = Response-&gt;<span class="built_in">GetContent</span>();</span><br><span class="line">	OnSuccessed.<span class="built_in">ExecuteIfBound</span>(ResponseContent);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mount-pak-in-Runtime"><a href="#Mount-pak-in-Runtime" class="headerlink" title="Mount pak in Runtime"></a>Mount pak in Runtime</h2><p>前面的笔记中提到，UE的项目打包后会自动加载三个路径下的<code>Paks/</code>下的所有Pak文件，为了热更新的需求，需要在运行时自己指定加载Pak，翻了一下代码，可以写了个挂载的函数。</p>
<blockquote>
<p>注意！注意！注意！在编辑器模式下运行无作用，没有任何逻辑，因为编辑器模式也不需要加载Pak，引擎里部分逻辑在编辑器模式下不执行，如果非要在编辑器下Mount引擎会Crash，以Standalone模式运行也一样，都属于编辑器模式。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MountPak</span><span class="params">(<span class="keyword">const</span> FString&amp; PakPath, int32 PakOrder, <span class="keyword">const</span> FString&amp; InMountPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bMounted = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	FPakPlatformFile* PakFileMgr=(FPakPlatformFile*)FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>());</span><br><span class="line">	<span class="keyword">if</span> (!PakFileMgr)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;GetPlatformFile(TEXT(\&quot;PakFile\&quot;) is NULL&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	PakOrder = FMath::<span class="built_in">Max</span>(<span class="number">0</span>, PakOrder);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(PakPath) &amp;&amp; FPaths::<span class="built_in">GetExtension</span>(PakPath) == <span class="built_in">TEXT</span>(<span class="string">&quot;pak&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> TCHAR* MountPount = InMountPoint.<span class="built_in">GetCharArray</span>().<span class="built_in">GetData</span>();</span><br><span class="line">		<span class="keyword">if</span> (PakFileMgr-&gt;<span class="built_in">Mount</span>(*PakPath, PakOrder,MountPount))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Mounted = %s, Order = %d, MountPoint = %s&quot;</span>), *PakPath, PakOrder, !MountPount ? <span class="built_in">TEXT</span>(<span class="string">&quot;(NULL)&quot;</span>) : MountPount);</span><br><span class="line">			bMounted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogTemp, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Faild to mount pak = %s&quot;</span>), *PakPath);</span><br><span class="line">			bMounted = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> bMounted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Patch的挂载和资源加载"><a href="#Patch的挂载和资源加载" class="headerlink" title="Patch的挂载和资源加载"></a>Patch的挂载和资源加载</h2><p>这两天在看UE打包Patch作为热更的方案，UE打包Patch的逻辑是这样的：</p>
<ol>
<li>如果在版本1.0中，场景<code>Scene01</code>中对资源A有直接引用（放在场景中），在修改了A资源之后，打包Patch0.1，想要让场景<code>Scene01</code>中资源A的改动也生效，则需要把<code>Scene01</code>也需要打到Patch中，因为是直接放置在场景中的，场景记录了该资源A的引用信息，这个不会随着资源A的更新而更新，加载时会产生<code>AsyncLoading.cpp</code>中的报错。</li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/unreal-load-patch-asset.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[2019.11.13-06.03.27:766][ 68]LogLinker: Warning: The file &#x27;../../../GWorld/Content/PAK/Cube.uasset&#x27; contains unrecognizable data, check that it is of the expected type.</span><br><span class="line">[2019.11.13-06.03.27:770][ 68]LogStreaming: Error: ****DumpDependencies [Dependencies]:</span><br><span class="line">[2019.11.13-06.03.27:771][ 68]LogStreaming: Error:     Export 8 /Game/Map2.Map2:PersistentLevel.Cube_2</span><br><span class="line">[2019.11.13-06.03.27:772][ 68]LogStreaming: Error:     Linker is ../../../GWorld/Content/Map2.umap</span><br><span class="line">[2019.11.13-06.03.27:774][ 68]LogStreaming: Error:         Dep C_BEFORE_S Export    38    /Game/Map2.Map2:PersistentLevel.Cube_2.Cube     (class StaticMeshComponent)</span><br><span class="line">[2019.11.13-06.03.27:774][ 68]LogStreaming: Error:         Dep C_BEFORE_S Export    29    /Game/Map2.Map2:PersistentLevel.Cube_2.DefaultSceneRoot     (class SceneComponent)</span><br><span class="line">[2019.11.13-06.03.27:775][ 68]LogStreaming: Error:         Dep S_BEFORE_C Import     3   /Game/PAK/Cube.Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][ 68]LogStreaming: Error:         Dep S_BEFORE_C Import    42   /Game/PAK/Cube.Default__Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][ 68]LogStreaming: Error:         Dep C_BEFORE_C Export    23    /Game/Map2.Map2:PersistentLevel     (class Level)</span><br><span class="line">[2019.11.13-06.03.27:777][ 68]LogStreaming: Error: Missing Dependency, request for /Game/PAK/Cube.Cube_C but it hasn&#x27;t been created yet.</span><br><span class="line">[2019.11.13-06.03.27:778][ 68]LogStreaming: Error: Could not find class Cube_C to create Cube_2</span><br><span class="line">[2019.11.13-06.03.27:778][ 68]LogStreaming: Error: Could not find outer Cube_2 to create DefaultSceneRoot</span><br><span class="line">[2019.11.13-06.03.27:779][ 68]LogStreaming: Error: Could not find outer Cube_2 to create Cube</span><br></pre></td></tr></table></figure>

<p>解决这个问题的办法是通过<code>SoftClassReference</code>动态加载资源，比如直接<code>SpawnActorFromClass</code>直接指定Class为具体的类也是会产生上面的错误，但是用<code>SoftClassReference</code>可以避免这个错误（因为<code>SoftClassReference</code>本质就是存了个路径）：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Patch/ue4-dynamic-load-asset.webp"></p>
<ol start="2">
<li>如果在版本1.0中，资源A引用了其他资源B，在Patch1.0中将资源A中引用的B换为了资源C，则该Patch的pak中会有资源A/B/C三个，因为资源的引用关系变了，但是如果不改动引用关系只是改动B中的信息，然后只Patch资源B是可以的。</li>
</ol>
<p>直接使用<code>Unreal.pak</code>将<code>Cooked</code>的资源打包为<code>pak</code>文件需要注意一点：修改Mount的路径。<br>如果说直接使用下列命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ UnrealPak.exe New_0_P.pak -create=D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>则打出来的pak的Mount路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>而查看使用引擎打包的Pak和patch的pak都是相对路径的，这个性格对路径就是UE的工程里资源的路径：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">D:\GWorldPackage\WindowsNoEditor\GWorld\Content\Paks&gt;UnrealPak.exe GWorld-WindowsNoEditor.pak -list</span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed in the game configuration.</span><br><span class="line">LogPakFile: Display: Using command line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added <span class="number">0</span> entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/BasicShapes/BasicShapeMaterial.uasset&quot;</span> offset: <span class="number">0</span>, size: <span class="number">749</span> bytes, sha1: E028879C8856192DC648EA4C422C145E38951DA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/EditorMaterials/PreviewShadowIndicator.uasset&quot;</span> offset: <span class="number">819</span>, size: <span class="number">496</span> bytes, sha1: <span class="number">80B</span>CDD2FF2674FED35763CD6A8C93C5A0EC27442, compression: Zlib.</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/AssetRegistry.bin&quot;</span> offset: <span class="number">16928768</span>, size: <span class="number">2759</span> bytes, sha1: <span class="number">35E6</span>A5C7667C23FDDFD1F3BDC5535FA4E3BFF24F, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultEngine.ini&quot;</span> offset: <span class="number">16932864</span>, size: <span class="number">2378</span> bytes, sha1: <span class="number">7E33</span>CA6CC805CC1A6E2FF84EF3010CEACBF99E04, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultGame.ini&quot;</span> offset: <span class="number">16935312</span>, size: <span class="number">523</span> bytes, sha1: DDD788C5E2C9446AB11E2C8BC7D83EA24CB85AA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultInput.ini&quot;</span> offset: <span class="number">16935905</span>, size: <span class="number">753</span> bytes, sha1: <span class="number">6</span>C03DCDAE9605BEB9CB2EB250631D6AA2C2A4336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.uexp&quot;</span> offset: <span class="number">16936960</span>, size: <span class="number">339962</span> bytes, sha1: <span class="number">6605</span>D83E8355CC2B4D20DE31C3D6182324BA556C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.umap&quot;</span> offset: <span class="number">17278976</span>, size: <span class="number">5541</span> bytes, sha1: A400A39FD85529E832750CB481D9F845E4C4A74B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uasset&quot;</span> offset: <span class="number">17285120</span>, size: <span class="number">795</span> bytes, sha1: <span class="number">1388</span>AE2CCFA55587DD0A3120CA9679AAF8FC9336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.ubulk&quot;</span> offset: <span class="number">17287168</span>, size: <span class="number">8637</span> bytes, sha1: <span class="number">7</span>D8E7AE0D100415553DF6F222B9C35EBACF4BE28, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uexp&quot;</span> offset: <span class="number">17297408</span>, size: <span class="number">586603</span> bytes, sha1: <span class="number">3B</span>776E46005F6A4BEECA505674ED7FB0B8C432D6, compression: Zlib.</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/ShaderArchive-GWorld-PCD3D_SM5.ushaderbytecode&quot;</span> offset: <span class="number">23377920</span>, size: <span class="number">1207165</span> bytes, sha1: <span class="number">44474138</span>CD033FEF89EDFA86A480E569615A8850, compression: None.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/GWorld.uproject&quot;</span> offset: <span class="number">24585135</span>, size: <span class="number">323</span> bytes, sha1: D2E183A541A10DEEC5C87533400FFC0E89CA3B83, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/GWorld.upluginmanifest&quot;</span> offset: <span class="number">24586240</span>, size: <span class="number">5022</span> bytes, sha1: CFDB721323DABBA1C7C7ABE6CB967852EA2AC23B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/LowEntryExtStdLib/LowEntryExtStdLib.uplugin&quot;</span> offset: <span class="number">24591332</span>, size: <span class="number">434</span> bytes, sha1: <span class="number">5</span>CD75BB5212731BEA8E0A552C99B69B259FA489C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/UIFramework/UIFramework.uplugin&quot;</span> offset: <span class="number">24591836</span>, size: <span class="number">236</span> bytes, sha1: C9426AD575AA6ADECEF5C1AE79CF4A49304C3350, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/VaRestPlugin/VaRestPlugin.uplugin&quot;</span> offset: <span class="number">24592384</span>, size: <span class="number">393</span> bytes, sha1: <span class="number">28B</span>9C2F3CEB767F4A8D5D466CB8C6EEF772CDA43, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="number">1257</span> <span class="built_in">files</span> (<span class="number">24050765</span> bytes), (<span class="number">0</span> filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed in <span class="number">1.746391</span> seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>是可以通过<code>UnrealPak.exe</code>的<code>-create</code>来指定一个txt文件来指定某个资源的绝对路径换算为相对路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uasset&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uasset&quot; -compress</span><br><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uexp&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uexp&quot; -compress</span><br></pre></td></tr></table></figure>

<p>可以看作有数列的表，第一列是资源的<strong>绝对路径</strong>，第二列是<strong>该绝对路径资源对应的相对路径</strong>，后面是<strong>参数</strong>（可以是<code>-compress</code>/<code>-encrypt</code>），生成的代码在<code>Source/Programs/AutomationTool/Script/CopyBuildToStagingDirectory.Automation.cs</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe D:\NEW_6_P.pak -create=<span class="string">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt&quot;</span></span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Loading response file D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt</span><br><span class="line">LogPakFile: Display: Added 2 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Collecting files to add to pak file...</span><br><span class="line">LogPakFile: Display: Collected 2 files <span class="keyword">in</span> 0.00s.</span><br><span class="line">LogPakFile: Display: Encrypting using embedded key</span><br><span class="line">LogPakFile: Display: Added 2 files, 8549 bytes total, time 0.00s.</span><br><span class="line">LogPakFile: Display: Compression summary: 13.27% of original size. Compressed Size 7981 bytes, Original Size 60159 bytes.</span><br><span class="line">LogPakFile: Display: Encryption - DISABLED</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.010672 seconds</span><br></pre></td></tr></table></figure>

<p>检查打包出来的<code>New_6_P.pak</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe NEW_6_P.pak -list</span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added 0 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../GWorld/Content/PAK/</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uasset&quot;</span> offset: 0, size: 753 bytes, sha1: 63E00757694E91070403390CFB808829E13D01FF, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uexp&quot;</span> offset: 823, size: 7228 bytes, sha1: BD3C0B302FC49790327CF804F2B644F01A14EFCD, compression: Zlib.</span><br><span class="line">LogPakFile: Display: 2 files (7981 bytes), (0 filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.001987 seconds</span><br></pre></td></tr></table></figure>

<p>可以看到变成了相对路径了。</p>
<h2 id="引擎启动时Pak的加载"><a href="#引擎启动时Pak的加载" class="headerlink" title="引擎启动时Pak的加载"></a>引擎启动时Pak的加载</h2><p>当在UE的<code>Project Setting</code>里<code>Project</code>-<code>Packaging</code>-<code>UsePakFile</code>启用时，会打包出来<code>pak</code>文件，以<code>Windows</code>平台为例，打包出来的<code>pak</code>路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WindowsNoEditor/PROJECT_NAME/Content/Paks</span><br></pre></td></tr></table></figure>
<p>该目录下的<code>pak</code>文件在游戏启动时会自动加载，在引擎的<code>FEngineLoop::PreInit</code>中调用<code>LaunchCheckForFileOverride</code>(<code>LaunchEngineLoop.cpp</code>)又调用<code>ConditionallyCreateFileWrapper</code>来加载<code>PakFile</code>的<code>PlatformFile</code>，但是在<code>ConditionallyCreateFileWrapper</code>的代码中做了一层<code>WrapperFile-&gt;ShouldBeUsed</code>判断：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Launch/Private/LaunchEngineLoop.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> IPlatformFile* <span class="title">ConditionallyCreateFileWrapper</span><span class="params">(<span class="keyword">const</span> TCHAR* Name, IPlatformFile* CurrentPlatformFile, <span class="keyword">const</span> TCHAR* CommandLine, <span class="keyword">bool</span>* OutFailedToInitialize = <span class="literal">nullptr</span>, <span class="keyword">bool</span>* bOutShouldBeUsed = <span class="literal">nullptr</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">	&#123;</span><br><span class="line">		*OutFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( bOutShouldBeUsed )</span><br><span class="line">	&#123;</span><br><span class="line">		*bOutShouldBeUsed = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	IPlatformFile* WrapperFile = FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">GetPlatformFile</span>(Name);</span><br><span class="line">	<span class="keyword">if</span> (WrapperFile != <span class="literal">nullptr</span> &amp;&amp; WrapperFile-&gt;<span class="built_in">ShouldBeUsed</span>(CurrentPlatformFile, CommandLine))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ( bOutShouldBeUsed )</span><br><span class="line">		&#123;</span><br><span class="line">			*bOutShouldBeUsed = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (WrapperFile-&gt;<span class="built_in">Initialize</span>(CurrentPlatformFile, CommandLine) == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutFailedToInitialize = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Don&#x27;t delete the platform file. It will be automatically deleted by its module.</span></span><br><span class="line">			WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Make sure it won&#x27;t be used.</span></span><br><span class="line">		WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> WrapperFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果为<code>false</code>不会对该<code>PlatformFile</code>调用<code>Initialize</code>，而<code>FPakPlatformFile</code>的一些成员就是在这里被设置的。<code>FPakPlatformFile::ShoubleBeUsed</code>的定义如下(UE_4.22.3)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::ShouldBeUsed</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> Result = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (!FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;NoPak&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		TArray&lt;FString&gt; PakFolders;</span><br><span class="line">		<span class="built_in">GetPakFolders</span>(CmdLine, PakFolders);</span><br><span class="line">		Result = <span class="built_in">CheckIfPakFilesExist</span>(Inner, PakFolders);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑器模式下直接就是false，即编辑器模式下不可以使用pak的<code>mount</code>操作，因为<code>mount</code>中需要用到<code>LowerLevel</code>成员，而该成员在<code>FPakPlatformFile::Initialize</code>中被设置，所以不可以调用mount，否则必Crash。</p>
<p>Mount所有pak的相关代码在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Initialize</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">LLM_SCOPE</span>(ELLMTag::FileSystem);</span><br><span class="line">  <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FPakPlatformFile::Initialize&quot;</span>);</span><br><span class="line">  <span class="comment">// Inner is required.</span></span><br><span class="line">  <span class="built_in">check</span>(Inner != <span class="literal">NULL</span>);</span><br><span class="line">  LowerLevel = Inner;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> EXCLUDE_NONPAK_UE_EXTENSIONS</span></span><br><span class="line">  <span class="comment">// Extensions for file types that should only ever be in a pak file. Used to stop unnecessary access to the lower level platform file</span></span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;uasset&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;umap&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ubulk&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.<span class="built_in">Add</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;uexp&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISABLE_NONUFS_INI_WHEN_COOKED</span></span><br><span class="line">  IniFileExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">  GameUserSettingsIniFilename = <span class="built_in">TEXT</span>(<span class="string">&quot;GameUserSettings.ini&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// signed if we have keys, and are not running with fileopenlog (currently results in a deadlock).</span></span><br><span class="line">  bSigned = <span class="built_in">GetPakSigningKey</span>().<span class="built_in">IsValid</span>() &amp;&amp; !FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;fileopenlog&quot;</span>));;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find and mount pak files from the specified directories.</span></span><br><span class="line">  TArray&lt;FString&gt; PakFolders;</span><br><span class="line">  <span class="built_in">GetPakFolders</span>(FCommandLine::<span class="built_in">Get</span>(), PakFolders);</span><br><span class="line">  <span class="built_in">MountAllPakFiles</span>(PakFolders);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  GPakExec = MakeUnique&lt;FPakExec&gt;(*<span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  FCoreDelegates::OnMountAllPakFiles.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::MountAllPakFiles);</span><br><span class="line">  FCoreDelegates::OnMountPak.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleMountPakDelegate);</span><br><span class="line">  FCoreDelegates::OnUnmountPak.<span class="built_in">BindRaw</span>(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleUnmountPakDelegate);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(IS_PROGRAM || WITH_EDITOR)</span></span><br><span class="line">  FCoreDelegates::OnFEngineLoopInitComplete.<span class="built_in">AddLambda</span>([<span class="keyword">this</span>] &#123;</span><br><span class="line">      FPlatformMisc::<span class="built_in">LowLevelOutputDebugStringf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Checking Pak Config&quot;</span>));</span><br><span class="line">      <span class="keyword">bool</span> bUnloadPakEntryFilenamesIfPossible = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnloadPakEntryFilenamesIfPossible&quot;</span>), bUnloadPakEntryFilenamesIfPossible, GEngineIni);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bUnloadPakEntryFilenamesIfPossible)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// With [Pak] UnloadPakEntryFilenamesIfPossible enabled, [Pak] DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span></span><br><span class="line">        <span class="comment">// can contain pak entry directory wildcards of which the entire recursive directory structure of filenames underneath a</span></span><br><span class="line">        <span class="comment">// matching wildcard will be kept.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Example:</span></span><br><span class="line">        <span class="comment">//   [Pak]</span></span><br><span class="line">        <span class="comment">//   DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Config/Tags/&quot;</span></span><br><span class="line">        <span class="comment">//   +DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Content/Localization/*&quot;</span></span><br><span class="line">        TArray&lt;FString&gt; DirectoryRootsToKeep;</span><br><span class="line">        GConfig-&gt;<span class="built_in">GetArray</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames&quot;</span>), DirectoryRootsToKeep, GEngineIni);</span><br><span class="line"></span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">        PakPlatformFile-&gt;<span class="built_in">UnloadPakEntryFilenames</span>(&amp;DirectoryRootsToKeep);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">bool</span> bShrinkPakEntriesMemoryUsage = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;<span class="built_in">GetBool</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Pak&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;ShrinkPakEntriesMemoryUsage&quot;</span>), bShrinkPakEntriesMemoryUsage, GEngineIni);</span><br><span class="line">      <span class="keyword">if</span> (bShrinkPakEntriesMemoryUsage)</span><br><span class="line">      &#123;</span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">FindPlatformFile</span>(FPakPlatformFile::<span class="built_in">GetTypeName</span>()));</span><br><span class="line">        PakPlatformFile-&gt;<span class="built_in">ShrinkPakEntriesMemoryUsage</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> !!LowerLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UE自动加载的pak路径：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakPlatformFile::GetPakFolders</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, TArray&lt;FString&gt;&amp; OutPakFolders)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Command line folders</span></span><br><span class="line">  FString PakDirs;</span><br><span class="line">  <span class="keyword">if</span> (FParse::<span class="built_in">Value</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;-pakdir=&quot;</span>), PakDirs))</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; CmdLineFolders;</span><br><span class="line">    PakDirs.<span class="built_in">ParseIntoArray</span>(CmdLineFolders, <span class="built_in">TEXT</span>(<span class="string">&quot;*&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    OutPakFolders.<span class="built_in">Append</span>(CmdLineFolders);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// @todo plugin urgent: Needs to handle plugin Pak directories, too</span></span><br><span class="line">  <span class="comment">// Hardcoded locations</span></span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">ProjectSavedDir</span>()));</span><br><span class="line">  OutPakFolders.<span class="built_in">Add</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::<span class="built_in">EngineContentDir</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在非<code>Shipping</code>打包的时候可以通过才命令行加启动参数<code>-pakdir</code>来添加额外的pak路径。</p>
<p>引擎默认添加的路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># relative to Project Path</span><br><span class="line">Content/Paks/</span><br><span class="line">Saved/Paks/</span><br><span class="line"># relative to Engine Path</span><br><span class="line">Content/Paks</span><br></pre></td></tr></table></figure>
<p>之后又调用了<code>FPakPlatformFile::MountAllPakFiles</code>来把挂载所有pak（默认对pak的名字进行了个降序排序，但是这里的排序没用），在该函数中<code>mount</code>的时候会给不同的路径加载的<code>pak</code>设置不同的<code>Order</code>，其函数在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">int32 <span class="title">FPakPlatformFile::GetPakOrderFromPakFilePath</span><span class="params">(<span class="keyword">const</span> FString&amp; PakFilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%sPaks/%s-&quot;</span>), *FPaths::<span class="built_in">ProjectContentDir</span>(), FApp::<span class="built_in">GetProjectName</span>())))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectContentDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">EngineContentDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.<span class="built_in">StartsWith</span>(FPaths::<span class="built_in">ProjectSavedDir</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>概括来说：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># relative to project path</span><br><span class="line">4 Content/Paks/PROJECT_NAME-*.pak</span><br><span class="line">3 Content/Paks/</span><br><span class="line">1 Saved/Paks</span><br><span class="line"></span><br><span class="line"># relative to engine path</span><br><span class="line">2 Content/Paks/</span><br></pre></td></tr></table></figure>
<p>可以看到<code>Saved/Paks</code>下的<code>pak</code>文件加载的优先级是最低的。</p>
<p>在<code>Mount</code>的时候如果上述路径中有打出来Patch包，以<code>_Num_P.pak</code>结尾的文件，其中<code>Num</code>是数字，Patch包的优先级高于普通的pak，在<code>IPlatformFilePak.cpp</code>中默认给<code>_P.pak</code>的<code>PakOrder</code>加了100，<code>_P.pak</code>前面的数字越大，其加载的优先级就越高。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath <span class="comment">/*= NULL*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bSuccess = <span class="literal">false</span>;</span><br><span class="line">  TSharedPtr&lt;IFileHandle&gt; PakHandle = <span class="built_in">MakeShareable</span>(LowerLevel-&gt;<span class="built_in">OpenRead</span>(InPakFilename));</span><br><span class="line">  <span class="keyword">if</span> (PakHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    FPakFile* Pak = <span class="keyword">new</span> <span class="built_in">FPakFile</span>(LowerLevel, InPakFilename, bSigned);</span><br><span class="line">    <span class="keyword">if</span> (Pak-&gt;<span class="built_in">IsValid</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        Pak-&gt;<span class="built_in">SetMountPoint</span>(InPath);</span><br><span class="line">      &#125;</span><br><span class="line">      FString PakFilename = InPakFilename;</span><br><span class="line">      <span class="keyword">if</span> (PakFilename.<span class="built_in">EndsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;_P.pak&quot;</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Prioritize based on the chunk version number</span></span><br><span class="line">        <span class="comment">// Default to version 1 for single patch system</span></span><br><span class="line">        uint32 ChunkVersionNumber = <span class="number">1</span>;</span><br><span class="line">        FString StrippedPakFilename = PakFilename.<span class="built_in">LeftChop</span>(<span class="number">6</span>);</span><br><span class="line">        int32 VersionEndIndex = PakFilename.<span class="built_in">Find</span>(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (VersionEndIndex != INDEX_NONE &amp;&amp; VersionEndIndex &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          int32 VersionStartIndex = PakFilename.<span class="built_in">Find</span>(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd, VersionEndIndex - <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> (VersionStartIndex != INDEX_NONE)</span><br><span class="line">          &#123;</span><br><span class="line">            VersionStartIndex++;</span><br><span class="line">            FString VersionString = PakFilename.<span class="built_in">Mid</span>(VersionStartIndex, VersionEndIndex - VersionStartIndex);</span><br><span class="line">            <span class="keyword">if</span> (VersionString.<span class="built_in">IsNumeric</span>())</span><br><span class="line">            &#123;</span><br><span class="line">              int32 ChunkVersionSigned = FCString::<span class="built_in">Atoi</span>(*VersionString);</span><br><span class="line">              <span class="keyword">if</span> (ChunkVersionSigned &gt;= <span class="number">1</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="comment">// Increment by one so that the first patch file still gets more priority than the base pak file</span></span><br><span class="line">                ChunkVersionNumber = (uint32)ChunkVersionSigned + <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        PakOrder += <span class="number">100</span> * ChunkVersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Add new pak file</span></span><br><span class="line">        <span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">        FPakListEntry Entry;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.PakFile = Pak;</span><br><span class="line">        PakFiles.<span class="built_in">Add</span>(Entry);</span><br><span class="line">        PakFiles.<span class="built_in">StableSort</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      bSuccess = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid.<span class="built_in">IsValid</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Deferring mount of pak \&quot;%s\&quot; until encryption key &#x27;%s&#x27; becomes available&quot;</span>), InPakFilename, *Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid.<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">check</span>(!<span class="built_in">GetRegisteredEncryptionKeys</span>().<span class="built_in">HasKey</span>(Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid));</span><br><span class="line">        FPakListDeferredEntry&amp; Entry = PendingEncryptedPakFiles[PendingEncryptedPakFiles.<span class="built_in">Add</span>(<span class="built_in">FPakListDeferredEntry</span>())];</span><br><span class="line">        Entry.Filename = InPakFilename;</span><br><span class="line">        Entry.Path = InPath;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.EncryptionKeyGuid = Pak-&gt;<span class="built_in">GetInfo</span>().EncryptionKeyGuid;</span><br><span class="line">        Entry.ChunkID = Pak-&gt;ChunkID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span> Pak;</span><br><span class="line">        PakHandle.<span class="built_in">Reset</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to mount pak \&quot;%s\&quot;, pak is invalid.&quot;</span>), InPakFilename);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogPakFile, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Pak \&quot;%s\&quot; does not exist!&quot;</span>), InPakFilename);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，腾讯的和平精英的热更新的pak就是放在<code>Saved/Paks</code>里面。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-game-shadowtrackerextra-pak.webp"></p>
<p>而且，和平精英的apk的大小是1.6G，我下载完之后又热更新了1.2G左右的内容，总共占了3个多G…这样的apk里面obb的数据估计和外部的<code>pak</code>中的内容都是覆盖的，但是apk内容又没办法改，只能越更新越多了（但是可以在用户更新APK之后删除多余的pak）。</p>
<p>注：腾讯的吃鸡用sluaunreal，脚本的热更也是通过pak方式来加载的，这点在sluaunreal中有写：<a target="_blank" rel="noopener" href="https://github.com/Tencent/sluaunreal/issues/238">sluaunreal增量打包问题</a></p>
<p>如果从省空间的角度考虑，最好的方式就是基础apk+更新的方式修改游戏内容，但是玩家下载完apk之后还需要再更新可能会造成用户流失，这是个要考虑的问题。</p>
<h2 id="自定义蓝图节点"><a href="#自定义蓝图节点" class="headerlink" title="自定义蓝图节点"></a>自定义蓝图节点</h2><p>在蓝图中类似于<code>SpawnActor</code>或者<code>GetClassDefaults</code>之类的函数，可以根据参数的变化来改变节点的信息(如增加引脚，修改返回值类型等等)。</p>
<p>其实在蓝图中这样的节点都是继承自<code>UK2Node</code>的类，每一个节点是一个类，如<code>SpawnActor</code>它就是定义在<code>Editor/BlueprintEditor</code>下的<code>K2Node_SpawnActor</code>类。<br><code>UK2Node</code>提供了很多的方法供继承类重写，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 鼠标指到节点上的提示信息</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetTooltipText</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 节点在蓝图中显示的名字</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetNodeTitle</span><span class="params">(ENodeTitleType::Type TitleType)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 将节点添加至上下文菜单</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetMenuActions</span><span class="params">(FBlueprintActionDatabaseRegistrar&amp; ActionRegister)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 设置节点在编辑器中右键菜单的分类</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetMenuCategory</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 在编译时扩展节点，可以添加或移除节点的Pin</span></span><br><span class="line"><span class="comment">// 在这个函数中需要绑定真正需要执行的函数，注意绑定的函数要是BlueprintCallable的</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ExpandNode</span><span class="params">(FKismetCompilerContext &amp; CompilerContext, UEdGraph * SourceGraph)</span></span>;</span><br><span class="line"><span class="comment">// 当节点中的Pin信息被改变</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PinDefaultValueChanged</span><span class="params">(UEdGraphPin* ChangedPin)</span></span>;</span><br><span class="line"><span class="comment">// 给节点分配默认的Pin，如初始添加InExec和OutExec，声明在UEdGraphNode中</span></span><br><span class="line"><span class="comment">// 默认在ReallocatePinsDuringReconstruction中调用，也可以自己在ExpandNode中调用</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AllocateDefaultPins</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>上面列出的就是创建一个自定义的蓝图节点需要实现的最重要的几个函数。</p>
<p>当在蓝图中点击节点右键刷新的时候会调用到<code>ExpandNode</code>函数，如果在其中调用了<code>AllocateDefaultPins</code>要考虑从序列化中读取已有配置的问题。</p>
<p>一个例子，实现的效果为根据枚举值修改节点的参数类型：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/Show_CustomK2Node.gif"></p>
<p>代码放在了Gist：<a target="_blank" rel="noopener" href="https://gist.github.com/hxhb/d431c18592b1385574aac50eb00f8209">CustomK2Node.cpp</a></p>
<h2 id="Plugin加载时机太晚在蓝图中的错误"><a href="#Plugin加载时机太晚在蓝图中的错误" class="headerlink" title="Plugin加载时机太晚在蓝图中的错误"></a>Plugin加载时机太晚在蓝图中的错误</h2><p>如果一个<code>Runtime</code>的模块具有在蓝图中可用的函数，加载时机一定要先于<code>Default</code>，可以是<code>PreDefault</code>，不然每次打开是都会有该模块的蓝图节点找不到的错误。</p>
<h2 id="NavigationSystem获取NavData"><a href="#NavigationSystem获取NavData" class="headerlink" title="NavigationSystem获取NavData"></a>NavigationSystem获取NavData</h2><p>前面笔记中写到，UE4的寻路也是使用Recast来创建寻路网格的。所以如果要从<code>ANavigationSystemV1</code>获取到<code>Recast</code>的<code>dtNavMesh</code>可以通过下列方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先获取NavigationSystem</span></span><br><span class="line">UNavigationSystemV1 NavSys=FNavigationSystem::GetCurrent&lt;UNavigationSystemV1&gt;(<span class="built_in">GetWorld</span>());</span><br><span class="line"><span class="comment">// 通过NavigationSytstemV1可以获取到UE封装的管理NavData的类对象ANavigationData</span></span><br><span class="line">ANavigationData NavData=NavSys-&gt;<span class="built_in">GetDefaultNavDataInstance</span>(FNavigationSystem::DontCreate);</span><br><span class="line">ARecastNavMesh* NavMesh=Cast&lt;ARecastNavMesh&gt;(NavData);</span><br><span class="line">dtNavMesh* RecastNavMesh = NavMesh-&gt;<span class="built_in">GetRecastMesh</span>();</span><br></pre></td></tr></table></figure>

<p>注意：在<code>UNavigationSystemV1</code>中，通过<code>GetMainNavData</code>获取的对象与<code>GetDefaultNavDataInstance</code>是同一个。</p>
<p>然后<code>ARecastNavMesh</code>是继承自<code>ANavigationData</code>的，最后可以通过<code>ARecastNavMesh::GetRecastMesh()</code>获取到引擎中真正使用的<code>dtNavMesh</code>对象。</p>
<h2 id="编译RecastNavigation"><a href="#编译RecastNavigation" class="headerlink" title="编译RecastNavigation"></a>编译RecastNavigation</h2><p>UE使用的是Recast创建的导航网格实现AI的寻路，相关的模块为<code>Navmesh</code>(修改之后的recastnavigation，RecaseDemo等也在此模块下)/<code>NavigationSystem</code>。<br>如果想要在非UE的服务端使用，也可以自己编译recastnavigation，Github上的源码地址为：<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">recastnavigation</a>.</p>
<p>里面写了各个平台的编译流程，我在这里简单概述一下Windows下编译流程。</p>
<ol>
<li>首先下载<a target="_blank" rel="noopener" href="https://premake.github.io/download.html">premake5</a>，并将其添加到系统PATH路径</li>
<li>clone RecastNavigation的代码</li>
<li>下载<a target="_blank" rel="noopener" href="https://www.libsdl.org/download-2.0.php">SDL2</a>（选择Development Libraries），并将其解压到<code>recastnavigation\RecastDemo\Contrib</code>目录下，将文件夹改名为<code>SDL</code>，目录结构为：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\recastnavigation\RecastDemo\Contrib\SDL&gt;tree /a</span><br><span class="line">+---docs</span><br><span class="line">+---include</span><br><span class="line">\---lib</span><br><span class="line">    +---x64</span><br><span class="line">    \---x86</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>在<code>recastnavigation\RecastDemo</code>目录下执行命令<code>premake5 vs2017</code>(vs201x取决于你当前系统中安装的版本)，它会在<code>RecastDemo</code>目录下创建<code>build/vs2017</code>目录，里面是VS项目的解决方案。<br> <img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-premake-generate-vs-solution.webp"></p>
</li>
<li><p>打开<code>RecastDemo\Build\vs2017\recastnavigation.sln</code>，编译即可。<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/build-recastnavigation.webp"></p>
</li>
<li><p>编译出来<code>RecastDemo.exe</code>位置在<code>RecastDemo\Bin</code>。</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\<span class="built_in">source</span>\repos\recastnavigation\RecastDemo\Bin&gt;tree /a /f</span><br><span class="line">文件夹 PATH 列表</span><br><span class="line">卷序列号为 000002D0 ECDB:6872</span><br><span class="line">C:.</span><br><span class="line">|   .gitignore</span><br><span class="line">|   DroidSans.ttf</span><br><span class="line">|   RecastDemo.exe</span><br><span class="line">|   RecastDemo.pdb</span><br><span class="line">|   SDL2.dll</span><br><span class="line">|   Tests.exe</span><br><span class="line">|   Tests.pdb</span><br><span class="line">|</span><br><span class="line">+---Meshes</span><br><span class="line">|       dungeon.obj</span><br><span class="line">|       nav_test.obj</span><br><span class="line">|       undulating.obj</span><br><span class="line">|</span><br><span class="line">\---TestCases</span><br><span class="line">        movement_test.txt</span><br><span class="line">        nav_mesh_test.txt</span><br><span class="line">        raycast_test.txt</span><br></pre></td></tr></table></figure>

<p>其中关键的几个文件：<code>DroidSans.ttf</code>/<code>RecastDemo.exe</code>/<code>SDL2.dll</code>/<code>Meshs/</code>。</p>
<blockquote>
<p>注意：必须把obj文件放到<code>Meshs/</code>目录下才可以被<code>RecastDemo</code>识别。</p>
</blockquote>
<p> 之后就可以打开<code>RecastDemo.exe</code>在默认提供的三个<code>obj</code>的模型上进行导航数据生成的测试了，通过<code>Build</code>生成，然后Save保存会在<code>RecastDemo.exe</code>所在的目录产生一个<code>.bin</code>文件，即使用recast生成的导航数据。 </p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/20203/recast-navigation-RecastDemo.webp"></p>
<h2 id="UE4-Plugin-ExportNav"><a href="#UE4-Plugin-ExportNav" class="headerlink" title="UE4 Plugin:ExportNav"></a>UE4 Plugin:ExportNav</h2><p>最近有个需求需要导出UE里的寻路数据，研究了一下代码，写了一个插件:<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a></p>
<p>UE4使用的是<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">Recast</a>游戏寻路引擎，所以UE的寻路数据数据是<code>RecastNavMesh</code>的数据格式。</p>
<p>可以使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">Recast Navigation</a>提供的RecastDemo来打开本插件导出的Obj文件(需要clone Recast的仓库自己编译)，并构建出寻路的导航网格(使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation/tree/master/Recast">Recast</a>)，之后可以使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation/tree/master/Detour">Detour</a>利用前面生成的导航网格做寻路操作。</p>
<p>附上我编译好的<a href="index/UE4/Plugins/export-nav-data/RecastDemo.7z">RecastDemo</a>。</p>
<h3 id="What-is-this"><a href="#What-is-this" class="headerlink" title="What is this?"></a>What is this?</h3><p>This is a Unreal Engine 4 Plugin that export ue4 navigation mesh data(recast mesh) to outside.</p>
<h3 id="How-do-use"><a href="#How-do-use" class="headerlink" title="How do use?"></a>How do use?</h3><ol>
<li>add the plugin to the project and enable it. </li>
<li>Launch the Project in Editor, Click the <code>ExportNav</code> button. </li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-0.webp"></p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-1.webp"></p>
<ol start="3">
<li>Open The Plugin <code>Source/ExportNav/ThirdParty/RecastDemoBin</code></li>
<li>copy <code>.obj</code> to <code>RecastDemoBin/Meshes</code></li>
<li>run <code>RecastDemo.exe</code></li>
</ol>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/Plugins/export-nav-data/Recast-Demo-bin.webp"></p>
<h2 id="解决模块间的名字冲突"><a href="#解决模块间的名字冲突" class="headerlink" title="解决模块间的名字冲突"></a>解决模块间的名字冲突</h2><p>在写<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-jwt">hxhb/ue4-jwt</a>插件的时候发现，在包含<code>ThridParty/OpenSSL</code>模块时，会有与<code>Core</code>模块下的名字冲突错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CompilerResultsLog:Error: Error \Engine\Source\ThirdParty\OpenSSL\1.0.2g\include\Win64\VS2015\openssl/ossl_typ.h(172) : error C2365: <span class="string">&#x27;UI&#x27;</span>: redefinition; previous definition was <span class="string">&#x27;namespace&#x27;</span> CompilerResultsLog:Error: Error \engine\<span class="built_in">source</span>\runtime\coreuobject\public\UObject/ObjectMacros.h(752) : note: see declaration of <span class="string">&#x27;UI&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这是因为其他的模块定义了<code>UI</code>这个标识符，而在<code>OpenSSL</code>中也定义了一个同名的描述符的不同定于，这里一个是<code>namespace</code>一个是<code>typedef</code>，在加载外部的库的时候经常会有这样的问题。可以通过下列办法解决：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UI UI_ST</span></span><br><span class="line">THIRD_PARTY_INCLUDES_START</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/hmac.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/pem.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/ec.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line">THIRD_PARTY_INCLUDES_END</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> UI</span></span><br></pre></td></tr></table></figure>
<p>将具有标识符冲突的使用宏定义为其他的，然后将第三方库包含，最后在把宏给<code>undef</code>掉，确保不被其他的代码造成影响。</p>
<h2 id="CreateProc阻塞执行"><a href="#CreateProc阻塞执行" class="headerlink" title="CreateProc阻塞执行"></a>CreateProc阻塞执行</h2><p>在使用<code>FPlatformProcess::CreateProc</code>创建进程时是异步的，创建出来的进程和当前进程执行时没有顺序关系，有时我们需要等待进程执行完毕之后再执行后续逻辑，也就是阻塞行为。</p>
<p>因为<code>FPlatformProcess::CreateProc</code>本质也是使用<code>Windows API</code>中的<code>CreateProcess</code>创建的，所以使用<code>WaitForSingleObject</code>也可以在UE中使用，需要包含<code>synchapi.h</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FProcHandle ProtocProcIns=FPlatformProcess::<span class="built_in">CreateProc</span>(*pProtocExe, *CommandParams, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">WaitForSingleObject</span>(ProtocProcIns.<span class="built_in">Get</span>(), INFINITE);</span><br><span class="line"><span class="built_in">CloseHandle</span>(ProtocProcIns.<span class="built_in">Get</span>());</span><br></pre></td></tr></table></figure>

<p><code>WaitForSingleObject</code>第一个参数需要接收<code>PROCESS_INFORMATION </code>中的<code>hProcess</code>参数，在UE中<code>FProcHandle</code>对<code>ProcInfo.hProcess </code>做了一层封装，通过<code>FProcHandle</code>对象上调用<code>Get()</code>即可获得。<br><code>WaitForSingleObject</code>第二个参数是一个时间，为等待的时间，单位为毫秒，如果参数为0，则函数立即返回，如果为<code>INFINITE</code>则为无限等待下去直到程序退出。<br>如果等待超时，该函数返回<code>WAIT_TIMEOUT</code>。如果该函数失败，返回<code>WAIT_FAILED</code>。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2554447/how-to-use-waitforsingleobject">How to use WaitForSingleObject</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/247091/">WaitForMultipleObject与MsgWaitForMultipleObjects用法</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/18508131">解决CreateProcess()的等待时间问题</a></li>
</ul>
<h2 id="网络质量测试"><a href="#网络质量测试" class="headerlink" title="网络质量测试"></a>网络质量测试</h2><p>可以使用几个命令参数模拟比较差的网络环境，从而测试UE联机的网络质量和bug检测。</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PktLag</strong></td>
<td>Delays the sending of a packet by the amount of time specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLagVariance</strong></td>
<td>Provides some randomness to the amount of time a packet is delayed, +/- the amount specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLoss</strong></td>
<td>Specifies a percentage chance of an outbound packet being discarded to simulate packet loss</td>
</tr>
<tr>
<td><strong>PktDup</strong></td>
<td>Specifies a percentage chance to send a duplicate packet</td>
</tr>
<tr>
<td><strong>PktOrder</strong></td>
<td>Sends packets out of order when enabled (1 = enabled, 0 = disabled)</td>
</tr>
</tbody></table>
<p>可以通过三种不同的方式来控制：命令行参数、控制台命令以及引擎ini配置。</p>
<p>在命令行启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SettingName=Value</span><br></pre></td></tr></table></figure>

<p>在控制台设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Net SettingName=Value</span><br></pre></td></tr></table></figure>

<p>以及在引擎配置(<code>DefaultEngine.ini</code>)中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[PacketSimulationSettings]</span></span><br><span class="line"><span class="attr">PktLag</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLagVariance</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLoss</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktOrder</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktDup</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/blog/finding-network-based-exploits?sessionInvalidated=true">Finding Network-based Exploits</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Gameplay/Tools/NetworkProfiler/index.html">Network Profiler</a></li>
</ul>
<h2 id="UE4集成Protobuf"><a href="#UE4集成Protobuf" class="headerlink" title="UE4集成Protobuf"></a>UE4集成Protobuf</h2><p>我之前的文章<a href="https://imzlp.com/posts/9903/">Build protobuf with MSVC on Windows</a>中介绍了在Windows上使用MSVC编译Protobuf，最近的项目中有用到Protobuf，就把Protobuf集成UE4做了一个插件，无需在系统和项目设置中添加任何环境变量以及文件包含，也不需要考虑<code>protobuf</code>的<code>lib</code>的链接，方便在项目中使用，并且对UE不兼容cc格式写了编辑器插件，<code>.pb.cc</code>都会被转换为<code>pb.cpp</code>。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/protobuf-protoc-toolbar.webp"></p>
<p>代码我放在了github上：<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-protobuf">hxhb/ue4-protobuf</a></p>
<p>下面是简单的使用介绍：</p>
<h3 id="What-is-this-1"><a href="#What-is-this-1" class="headerlink" title="What is this?"></a>What is this?</h3><p>This is an Unreal Engine 4 plugin that integrates <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">Protobuf</a> into the project without requiring you to add system PATH or anything else.</p>
<h3 id="How-do-use-1"><a href="#How-do-use-1" class="headerlink" title="How do use?"></a>How do use?</h3><ol>
<li>add the plugin to the project and enable it.</li>
<li>add the following property to <code>build.cs</code> of the project :</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PublicDependencyModuleNames.Add(<span class="string">&quot;Protobuf&quot;</span>);</span><br><span class="line">bEnableUndefinedIdentifierWarnings = <span class="literal">false</span>;</span><br><span class="line">bUseRTTI = <span class="literal">true</span>;</span><br><span class="line">bEnableExceptions = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Create <code>.proto</code> file into project source code folder </li>
<li>Launch the Project in Editor, Click the <code>Protoc</code> button.</li>
</ol>
<h3 id="Protobuf-Version"><a href="#Protobuf-Version" class="headerlink" title="Protobuf Version"></a>Protobuf Version</h3><ul>
<li>Protobuf v3.9.1 build with MSVC 15 64bit (Visual Studio 2017).</li>
</ul>
<h2 id="protoc处理目录中的-proto文件"><a href="#protoc处理目录中的-proto文件" class="headerlink" title="protoc处理目录中的.proto文件"></a>protoc处理目录中的.proto文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --proto_path=PROTO_FILE_PATH PROTO_FILE --cpp_out=OUT_FILE_PATH PROTO_FILE_PATH\*.proto</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --proto_path=<span class="string">&quot;d:\protoc&quot;</span> MyName.proto --cpp_out=<span class="string">&quot;d:\&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Was-only-expecting-C-files-to-have-CachedCPPEnvironments"><a href="#Was-only-expecting-C-files-to-have-CachedCPPEnvironments" class="headerlink" title="Was only expecting C++ files to have CachedCPPEnvironments!"></a>Was only expecting C++ files to have CachedCPPEnvironments!</h2><p>写了个插件在UE中使用protobuf，在从<code>proto</code>文件生成<code>.cc</code>/<code>.h</code>之后编译报这个错误，分析了一下是UBT的代码文件类型不支持<code>.cc</code>。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1&gt;------ Build started: Project: GWorld, Configuration: Development x64 ------</span><br><span class="line">1&gt;Using &#x27;git status&#x27; to determine working set for adaptive non-unity build (C:\Users\imzlp\Documents\Unreal Projects\GWorld).</span><br><span class="line">1&gt;UnrealBuildTool : error : Was only expecting C++ files to have CachedCPPEnvironments!</span><br><span class="line">1&gt;(see ../Programs/UnrealBuildTool/Log.txt for full exception trace)</span><br></pre></td></tr></table></figure>

<p>在引擎中搜索代码，发现这个错误是在<code>UnrealBuildTools\System\ActionGraph.cs</code>中<code>IsActionOutdated</code>里的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsActionOutdated</span>(<span class="params">BuildConfiguration BuildConfiguration, UEBuildTarget Target, CPPHeaders Headers, Action RootAction, <span class="built_in">bool</span> bIsAssemblingBuild, <span class="built_in">bool</span> bNeedsFullCPPIncludeRescan, Dictionary&lt;Action, <span class="built_in">bool</span>&gt; OutdatedActionDictionary, ActionHistory ActionHistory, Dictionary&lt;UEBuildTarget, List&lt;FileItem&gt;&gt; TargetToOutdatedPrerequisitesMap</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// @todo ubtmake: we may be scanning more files than we need to here -- indirectly outdated files are bIsOutdated=true by this point (for example basemost includes when deeper includes are dirty)</span></span><br><span class="line">	<span class="keyword">if</span> (bIsOutdated &amp;&amp; RootAction.ActionType == ActionType.Compile)<span class="comment">// @todo ubtmake: Does this work with RC files?  See above too.</span></span><br><span class="line">	&#123;</span><br><span class="line">	  Log.TraceVerbose(<span class="string">&quot;Outdated action: &#123;0&#125;&quot;</span>, RootAction.StatusDescription);</span><br><span class="line">	  <span class="keyword">foreach</span> (FileItem PrerequisiteItem <span class="keyword">in</span> RootAction.PrerequisiteItems)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="keyword">if</span> (PrerequisiteItem.CachedIncludePaths != <span class="literal">null</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (!IsCPPFile(PrerequisiteItem))</span><br><span class="line">	      &#123;</span><br><span class="line">	        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Was only expecting C++ files to have CachedCPPEnvironments!&quot;</span>);</span><br><span class="line">	      &#125;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; DEEP include scan: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line"></span><br><span class="line">	      List&lt;FileItem&gt; OutdatedPrerequisites;</span><br><span class="line">	      <span class="keyword">if</span> (!TargetToOutdatedPrerequisitesMap.TryGetValue(Target, <span class="keyword">out</span> OutdatedPrerequisites))</span><br><span class="line">	      &#123;</span><br><span class="line">	        OutdatedPrerequisites = <span class="keyword">new</span> List&lt;FileItem&gt;();</span><br><span class="line">	        TargetToOutdatedPrerequisitesMap.Add(Target, OutdatedPrerequisites);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	      OutdatedPrerequisites.Add(PrerequisiteItem);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">else</span> <span class="keyword">if</span> (IsCPPImplementationFile(PrerequisiteItem) || IsCPPResourceFile(PrerequisiteItem))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; WARNING: No CachedCPPEnvironment: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;    </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是<code>IsCPPFile</code>这个函数，报这个错误是因为UBT检测到了项目中不能识别的文件。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source file</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">IsCPPImplementationFile</span>(FileItem) || <span class="built_in">IsCPPIncludeFile</span>(FileItem) || <span class="built_in">IsCPPResourceFile</span>(FileItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source implementation file (e.g., .cpp)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPImplementationFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.cpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.c&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.mm&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source header file (e.g., .h or .inl)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPIncludeFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.h&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.hpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.inl&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ resource file (e.g., .rc)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPResourceFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.<span class="built_in">EndsWith</span>(<span class="string">&quot;.rc&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UBT只认下列几种文件：</p>
<ul>
<li><strong>IsCPPImplementationFile</strong>：<code>.cpp</code>/<code>.c</code>/<code>.m</code></li>
<li><strong>IsCPPIncludeFile</strong>：<code>.h</code>/<code>.hpp</code>/<code>.inl</code></li>
<li><strong>IsCPPResourceFile</strong>：<code>.rc</code></li>
</ul>
<p>因为Protobuf产生的是<code>.cc</code>文件，所以就会报开头的错误。</p>
<p>既然问题找到了。那么解决办法有两个：</p>
<ol>
<li>改UBT的代码，让其支持<code>.cc</code></li>
<li>改protobuf产生的<code>.cc</code>为<code>.cpp</code></li>
</ol>
<h2 id="在蓝图中使用参数确定返回类型"><a href="#在蓝图中使用参数确定返回类型" class="headerlink" title="在蓝图中使用参数确定返回类型"></a>在蓝图中使用参数确定返回类型</h2><p>在使用诸如<code>SpawnActor</code>的时候，传进来的UClass是什么就会直接返回具体的类型，避免<code>Cast</code>的操作。</p>
<p>使用代码实现的话需要在<code>UFUNCTION</code>的<code>meta</code>参数中添加<code>DeterminesOutputType</code>，根据传入的参数确定返回的类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable, meta = (DeterminesOutputType = <span class="string">&quot;ObjectClass&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> class UObject* <span class="title">CreateObject</span><span class="params">(class TSubclassOf&lt;class UObject&gt; ObjectClass)</span></span>;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/use-different-return-type.webp"></p>
<h2 id="SetMasterPoseComponent"><a href="#SetMasterPoseComponent" class="headerlink" title="SetMasterPoseComponent"></a>SetMasterPoseComponent</h2><p>当创建模块化角色的时候，需要将拆开的身体的各个部分跟随着一个主Pose运动。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Animation/WorkingwithModularCharacters/index.html">Working with Modular Characters</a></li>
</ul>
<p>但是当对一个<code>USkeletonMeshComponent</code>调用该方法时会关闭掉当前Mesh的物理资产（与物理相关的都会关闭）<br>可以看<code>Runtime/Engine/Private/Components/SkinnedMeshComponent.cpp</code>中的<code>SetMasterPoseComponent</code>实现，其中调用了<code>RecreatePhysicsState();</code></p>
<p>这个问题再4.1x时代就有人给<a target="_blank" rel="noopener" href="https://unreal-engine-issues.herokuapp.com/">Unreal Engine Issus</a>提过bug，但是官方表示不是bug不会修复。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://unreal-engine-issues.herokuapp.com/issue/UE-27081">Collision is not updated on Slave Meshes when using “Set Master Pose Component”</a></li>
</ul>
<h2 id="UE4：变量已被优化，因而不可用"><a href="#UE4：变量已被优化，因而不可用" class="headerlink" title="UE4：变量已被优化，因而不可用"></a>UE4：变量已被优化，因而不可用</h2><p>上面写到了在VS中遇到这样的情况怎么在VS中设置解决，但是在UE的项目里不能在VS里设置优化选项，有两种解决办法，一种是直接使用宏的，在普通的项目中也可以用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> optimize(<span class="meta-string">&quot;&quot;</span>,off) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>或者直接使用UE封装的宏(本质上面的方法)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/Misc/CoreMiscDefines.h</span></span><br><span class="line">PRAGMA_DISABLE_OPTIMIZATION</span><br></pre></td></tr></table></figure>
<p>还有一种方法是使用UE的Module来控制：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">OptimizeCode = CodeOptimization.Never;</span><br></pre></td></tr></table></figure>
<p><code>CodeOptimization</code>支持几种值，默认是<code>Default</code>，开启优化：</p>
<ul>
<li>Never</li>
<li>Default</li>
<li>InNonDebugBuilds</li>
<li>InShippingBuildsOnly</li>
</ul>
<p>相关的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configutation/UEBuildModuleCPP.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ShouldEnableOptimization</span><span class="params">(ModuleRules.CodeOptimization Setting, UnrealTargetConfiguration Configuration, <span class="keyword">bool</span> bIsEngineModule)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">switch</span></span>(Setting)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Never:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Default:</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Debug)? <span class="literal">false</span> : (Configuration != UnrealTargetConfiguration.DebugGame || bIsEngineModule);</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Shipping);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数在<code>UEBuildModuleCPP.cs</code>的<code>CreateModuleCompileEnvironment</code>中调用，将结果赋值给了<code>CppCompileEnvironment.bOptimizeCode</code>，进而又在<code>VCToolChain.cs</code>中被使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">UnrealBuildTool\Platform\Windows\VCToolChain.cs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Debug</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.Configuration == CppConfiguration.Debug)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Favor code size (especially useful for embedded platforms).</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Os&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion unless E&amp;C support is requested</span></span><br><span class="line">	  <span class="keyword">if</span> (!CompileEnvironment.bSupportEditAndContinue &amp;&amp; CompileEnvironment.bUseInlining)</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	    (CompileEnvironment.Platform == CppPlatform.Win64))</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/RTCs&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Development and LTCG</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span>(!CompileEnvironment.bOptimizeCode)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Maximum optimizations.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ox&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Favor code speed.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ot&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Coalesce duplicate strings</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GF&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Only omit frame pointers on the PC (which is implied by /Ox) if wanted.</span></span><br><span class="line">	    <span class="keyword">if</span> (CompileEnvironment.bOmitFramePointers == <span class="literal">false</span></span><br><span class="line">	    &amp;&amp; ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	      (CompileEnvironment.Platform == CppPlatform.Win64)))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Oy-&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion</span></span><br><span class="line">	  Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="comment">// LTCG</span></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="keyword">if</span> (CompileEnvironment.bAllowLTCG)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Enable link-time code generation.</span></span><br><span class="line">	    Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/GL&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>Debug</code>的环境下，是默认关闭优化的。在非<code>Debug</code>时根据<code>CompileEnvironment.bOptimizeCode</code>的值来决定是否开启优化。</p>
<p>调试效果：<br>当使用默认时（<code>OptimizeCode = CodeOptimization.Default;</code>）:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-default.webp"></p>
<p>当关闭代码优化时(OptimizeCode = CodeOptimization.Never;)：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/UE-codeoptimize-never.webp"></p>
<p>建议使用<code>OptimizeCode = CodeOptimization.InShippingBuildsOnly;</code>。</p>
<blockquote>
<p>注意：这个选项和普通的C++项目在VS中的<code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Optimization</code>-<code>Optimization</code>的设置时一样的。</p>
</blockquote>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/16643/vs-disable-optimization.webp"></p>
<h2 id="二元操作符的AddPin"><a href="#二元操作符的AddPin" class="headerlink" title="二元操作符的AddPin"></a>二元操作符的AddPin</h2><p>在UE中有很多这样的节点：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-bp-pure-node-binary-operator.webp"></p>
<p>这个AddPin，可以在蓝图中很方便地进行拼接，其本质就从前往后的项依次两两结合，组成新的项，再与后续的项两两结合。</p>
<p>其在代码里的写法为(以<code>Append</code>为例)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Concatenates two strings together to make a new string</span></span><br><span class="line"><span class="comment"> * @param A - The original string</span></span><br><span class="line"><span class="comment"> * @param B - The string to append to A</span></span><br><span class="line"><span class="comment"> * @returns A new string which is the concatenation of A+B</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintPure, meta=(DisplayName = <span class="string">&quot;Append&quot;</span>, CommutativeAssociativeBinaryOperator = <span class="string">&quot;true&quot;</span>), Category=<span class="string">&quot;Utilities|String&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">Concat_StrStr</span><span class="params">(<span class="keyword">const</span> FString&amp; A, <span class="keyword">const</span> FString&amp; B)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其重点就是<code>static</code>函数+<code>BlueprintPure</code>标记+<code>CommutativeAssociativeBinaryOperator = &quot;true&quot;</code>元标记。</p>
<h2 id="图像质量级别"><a href="#图像质量级别" class="headerlink" title="图像质量级别"></a>图像质量级别</h2><p>大多数游戏都提供了游戏画面参数的自定义设置，UE自己内置了五个不同的渲染级别：</p>
<ul>
<li>Low（0）</li>
<li>Medium（1）</li>
<li>Hight（1）</li>
<li>Epic（3）</li>
<li>Cinematic（4）</li>
</ul>
<p>这个五个级别可以通过在<code>UGameUserSettings</code>中调用<code>FQualityLevels::SetFromSingleQualityLevel</code>来设置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScalabilityQuality.<span class="built_in">SetFromSingleQualityLevel</span>(GraphicsLevel);</span><br></pre></td></tr></table></figure>
<p>因为在<code>UGameUserSettings</code>中，它也可以被定义为<code>UPROPERTY(config)</code>，实现存储设置的目的。</p>
<p>在UGameUserSettings中，使用LoadSettings函数会加载默认的Quality设置：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Engine\Private\GameUserSettings.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameUserSettings::LoadSettings</span><span class="params">(<span class="keyword">bool</span> bForceReload<span class="comment">/*=false*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(GameUserSettings_LoadSettings);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( bForceReload )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LoadConfigIni</span>( bForceReload );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LoadConfig</span>(<span class="built_in">GetClass</span>(), *GGameUserSettingsIni);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Scalability::LoadState() should not be needed as we already loaded the settings earlier (needed so the engine can startup with that before the game is initialized)</span></span><br><span class="line">  ScalabilityQuality = Scalability::<span class="built_in">GetQualityLevels</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allow override using command-line settings</span></span><br><span class="line">  <span class="keyword">bool</span> bDetectingResolution = ResolutionSizeX == <span class="number">0</span> || ResolutionSizeY == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bDetectingResolution)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">ConfirmVideoMode</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update r.FullScreenMode CVar</span></span><br><span class="line">  <span class="built_in">SetPreferredFullscreenMode</span>(PreferredFullscreenMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>Scalability::GetQualityLevels</code>获取了控制台变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FQualityLevels <span class="title">GetQualityLevels</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FQualityLevels Ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only suggested way to get the current state - don&#x27;t get CVars directly</span></span><br><span class="line">  <span class="keyword">if</span> (!GScalabilityUsingTemporaryQualityLevels)</span><br><span class="line">  &#123;</span><br><span class="line">    Ret.ResolutionQuality = CVarResolutionQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.ViewDistanceQuality = CVarViewDistanceQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.AntiAliasingQuality = CVarAntiAliasingQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.ShadowQuality = CVarShadowQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.PostProcessQuality = CVarPostProcessQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.TextureQuality = CVarTextureQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.EffectsQuality = CVarEffectsQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.FoliageQuality = CVarFoliageQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">    Ret.ShadingQuality = CVarShadingQuality.<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Ret = GScalabilityBackupQualityLevels;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些控制台变量，都是定义在<code>Runtime\Engine\Private\Scalability.cpp</code>文件中的：</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Engine\Private\Scalability.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;<span class="keyword">float</span>&gt; <span class="title">CVarResolutionQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ResolutionQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">100.0f</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 10..100, default: 100&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarViewDistanceQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ViewDistanceQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarAntiAliasingQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.AntiAliasingQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarShadowQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ShadowQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarPostProcessQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.PostProcessQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarTextureQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.TextureQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarEffectsQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.EffectsQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarFoliageQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.FoliageQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">3</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarShadingQuality</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ShadingQuality&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  Scalability::DefaultQualityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Scalability quality state (internally used by scalability system, ini load/save or using SCALABILITY console command)\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; 0:low, 1:med, 2:high, 3:epic, 4:cinematic, default: 3&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ScalabilityGroup)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarViewDistanceQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ViewDistanceQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.ViewDistanceQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarAntiAliasingQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.AntiAliasingQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.AntiAliasingQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarShadowQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ShadowQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.ShadowQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarPostProcessQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.PostProcessQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.PostProcessQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarTextureQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.TextureQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.TextureQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarEffectsQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.EffectsQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.EffectsQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarFoliageQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.FoliageQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.FoliageQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> TAutoConsoleVariable&lt;int32&gt; <span class="title">CVarShadingQuality_NumLevels</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;sg.ShadingQuality.NumLevels&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot;Number of settings quality levels in sg.ShadingQuality\n&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  TEXT(<span class="string">&quot; default: 5 (0..4)&quot;</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">  ECVF_ReadOnly)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以把它们加到项目的<code>Config/DefaultGameUserSettings.ini</code>文件的<code>[ScalabilityGroups]</code>下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ScalabilityGroups]</span></span><br><span class="line"><span class="attr">sg.ViewDistanceQuality</span>=<span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>引擎在启动时去调用了：</p>
<figure class="highlight cpp"><figcaption><span>LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitScalabilitySystem&quot;</span>);</span><br><span class="line">      <span class="comment">// Init scalability system and defaults</span></span><br><span class="line">      Scalability::<span class="built_in">InitScalabilitySystem</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitializeCVarsForActiveDeviceProfile&quot;</span>);</span><br><span class="line">      <span class="comment">// Set all CVars which have been setup in the device profiles.</span></span><br><span class="line">      <span class="comment">// This may include scalability group settings which will override</span></span><br><span class="line">      <span class="comment">// the defaults set above which can then be replaced below when</span></span><br><span class="line">      <span class="comment">// the game user settings are loaded and applied.</span></span><br><span class="line">      UDeviceProfileManager::<span class="built_in">InitializeCVarsForActiveDeviceProfile</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Scalability::LoadState&quot;</span>);</span><br><span class="line">      <span class="comment">// As early as possible to avoid expensive re-init of subsystems,</span></span><br><span class="line">      <span class="comment">// after SystemSettings.ini file loading so we get the right state,</span></span><br><span class="line">      <span class="comment">// before ConsoleVariables.ini so the local developer can always override.</span></span><br><span class="line">      <span class="comment">// after InitializeCVarsForActiveDeviceProfile() so the user can override platform defaults</span></span><br><span class="line">      Scalability::<span class="built_in">LoadState</span>((bHasEditorToken &amp;&amp; !GEditorSettingsIni.<span class="built_in">IsEmpty</span>()) ? GEditorSettingsIni : GGameUserSettingsIni);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FPlatformMisc::<span class="built_in">UseRenderThread</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      GUseThreadedRendering = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Scalability::LoadState</code>在非Editor模式下传递的是<code>GGameUserSettingsIni</code>，加载代码如下:</p>
<figure class="highlight cpp"><figcaption><span>Runtime\Engine\Private\Scalability.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LoadState</span><span class="params">(<span class="keyword">const</span> FString&amp; IniName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(!IniName.<span class="built_in">IsEmpty</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// todo: could be done earlier</span></span><br><span class="line">  <span class="built_in">InitScalabilitySystem</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use existing quality levels - Defaults with device profile customization</span></span><br><span class="line">  FQualityLevels State = <span class="built_in">GetQualityLevels</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> TCHAR* Section = <span class="built_in">TEXT</span>(<span class="string">&quot;ScalabilityGroups&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// looks like cvars but here we just use the name for the ini</span></span><br><span class="line">  GConfig-&gt;<span class="built_in">GetFloat</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.ResolutionQuality&quot;</span>), State.ResolutionQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.ViewDistanceQuality&quot;</span>), State.ViewDistanceQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.AntiAliasingQuality&quot;</span>), State.AntiAliasingQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.ShadowQuality&quot;</span>), State.ShadowQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.PostProcessQuality&quot;</span>), State.PostProcessQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.TextureQuality&quot;</span>), State.TextureQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.EffectsQuality&quot;</span>), State.EffectsQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.FoliageQuality&quot;</span>), State.FoliageQuality, IniName);</span><br><span class="line">  GConfig-&gt;<span class="built_in">GetInt</span>(Section, <span class="built_in">TEXT</span>(<span class="string">&quot;sg.ShadingQuality&quot;</span>), State.ShadingQuality, IniName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If possible apply immediately, else store in backup so we can re-apply later</span></span><br><span class="line">  <span class="keyword">if</span> (!GScalabilityUsingTemporaryQualityLevels)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetQualityLevels</span>(State);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    GScalabilityBackupQualityLevels = State;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用物理资产优化动态阴影消耗"><a href="#使用物理资产优化动态阴影消耗" class="headerlink" title="使用物理资产优化动态阴影消耗"></a>使用物理资产优化动态阴影消耗</h2><p>在UE中打开<code>SkeletalMesh</code>，在<code>AssetDetails</code>中找到<code>Lighting</code>-<code>Shadow Physics Asset</code>，将其指定为物理资产<code>PhysicsAsset</code>：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/optimize-dynamic-shadow-use-phy-asset.webp"></p>
<p>然后打开使用这个<code>SkeletalMesh</code>的<code>SkeletalMesh Component</code>，将其<code>Lithing</code>-<code>Capsule Direct Shadow</code>选项打勾，这个<code>Skeletal Mesh</code>就会被使用<code>Physics Asset</code>的框来计算阴影了，会降低消耗。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/optimize-dynamic-shadow-use-capsule-direct-shadow.webp"></p>
<h2 id="GameUserSettings"><a href="#GameUserSettings" class="headerlink" title="GameUserSettings"></a>GameUserSettings</h2><p>在UE中，当我们需要保存玩家的一些数据时，比如玩家的游戏设置：分辨率、画面质量、按键等等。这些与游戏无关的数据可以使用<code>GameUserSettings</code>来存储，游戏的数据还是使用<code>SaveGame</code>来存储。</p>
<p>UE默认使用的<code>GameUserSettings</code>类是<code>UGameUserSettings</code>，我们可以在<code>Config/DefaultEngine.ini</code>中的<code>/Script/Engine.Engine</code>这个<code>Section</code>下通过<code>GameUserSettingsClassName</code>指定：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.Engine]</span></span><br><span class="line"><span class="attr">GameUserSettingsClassName</span>=/Script/MODULE_NAME.GAME_USER_SETTING_CLASS</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MODULE_NAME</code>指的是所要指定的类是定义在什么<code>Module</code>下的。</li>
<li><code>GAME_USER_SETTING_CLASS</code>：指所指定的类的名字，忽略<code>U</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.Engine]</span></span><br><span class="line"><span class="attr">GameUserSettingsClassName</span>=/Script/GWorld.SGGameUserSettings</span><br></pre></td></tr></table></figure>

<p><code>GameUserSettingsClassName</code>在<code>UGameUserSettings::PreloadResolutionSettings</code>这个<code>static</code>成员函数中中被加载和读取，而它又在<code>FEngineLoop::PreInit</code>中被调用。真正的类对象是在<code>UEngine::InitializeObjectReferences</code>(UnrealEngine.cpp)中被加载。</p>
<p>我们指定的类必须是继承自<code>UGameUserSettings</code>的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(BlueprintType,Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">USGGameUserSettings</span> :</span> <span class="keyword">public</span> UGameUserSettings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">GENERATED_UCLASS_BODY</span>()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要重写其中的几个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ApplySettings</span><span class="params">(<span class="keyword">bool</span> bCheckForCommandLineOverrides)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetToDefaults</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>

<p>在这两个函数中，根据所有的用户可配置信息做事情。</p>
<p>在我们自己的<code>GameUserSetting</code>类中，可以使用<code>UPROPERTY(config)</code>声明变量，标识其可以被存储到配置文件中。</p>
<p>当在游戏中选项设置完毕，调用<code>ApplySettings</code>应用设置之后，可以调用<code>SaveSettings</code>将我们的<code>GameUserSetting</code>中所有的标记为<code>UPROPERTY(Config)</code>的成员都存储到<code>GameUserSettings.ini</code>中。</p>
<p>注意：在项目和非shipping模式打包的项目，<code>GameUserSettings.ini</code>文件的路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROJECT_DIR/Saved/Config/Windows/GameUserSettings.ini</span><br></pre></td></tr></table></figure>

<p>而<code>Shipping</code>模式打包的项目，<code>Saved</code>文件夹不在打包的目录下，而是在：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\USER_NAME\AppData\Local\PROJECT_NAME</span><br></pre></td></tr></table></figure>

<h2 id="TAutoConsoleVariable"><a href="#TAutoConsoleVariable" class="headerlink" title="TAutoConsoleVariable"></a>TAutoConsoleVariable</h2><p><code>TAutoConsoleVariable</code>可以让我们往UE的项目中添加<code>Console</code>命令：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue-addtional-console-command.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Pulic/HAL/IConsoleManager.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TAutoConsoleVariable</span> :</span> <span class="keyword">public</span> FAutoConsoleObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a float, int or string console variable</span></span><br><span class="line"><span class="comment">	 * @param Name must not be 0</span></span><br><span class="line"><span class="comment">	 * @param Help must not be 0</span></span><br><span class="line"><span class="comment">	 * @param Flags bitmask combined from EConsoleVariableFlags</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">TAutoConsoleVariable</span>(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> T&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags = ECVF_Default);</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnGameThread</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;<span class="built_in">GetValueOnGameThread</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnRenderThread</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;<span class="built_in">GetValueOnRenderThread</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnAnyThread</span><span class="params">(<span class="keyword">bool</span> bForceGameThread = <span class="literal">false</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;<span class="built_in">GetValueOnAnyThread</span>(bForceGameThread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Dereference back to a variable**/</span></span><br><span class="line">	FORCEINLINE IConsoleVariable&amp; <span class="keyword">operator</span>*()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="built_in">AsVariable</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	FORCEINLINE <span class="keyword">const</span> IConsoleVariable&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="built_in">AsVariable</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Dereference back to a variable**/</span></span><br><span class="line">	FORCEINLINE IConsoleVariable* <span class="keyword">operator</span>-&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">AsVariable</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	FORCEINLINE <span class="keyword">const</span> IConsoleVariable* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">AsVariable</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	TConsoleVariableData&lt;T&gt;* Ref;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;int32&gt;::<span class="built_in">TAutoConsoleVariable</span>(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> int32&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: <span class="built_in">FAutoConsoleObject</span>(IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">RegisterConsoleVariable</span>(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = <span class="built_in">AsVariable</span>()-&gt;<span class="built_in">AsVariableInt</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;<span class="keyword">float</span>&gt;::<span class="built_in">TAutoConsoleVariable</span>(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> <span class="keyword">float</span>&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: <span class="built_in">FAutoConsoleObject</span>(IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">RegisterConsoleVariable</span>(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = <span class="built_in">AsVariable</span>()-&gt;<span class="built_in">AsVariableFloat</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;FString&gt;::<span class="built_in">TAutoConsoleVariable</span>(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> FString&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: <span class="built_in">FAutoConsoleObject</span>(IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">RegisterConsoleVariable</span>(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = <span class="built_in">AsVariable</span>()-&gt;<span class="built_in">AsVariableString</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TAutoConsoleVariable</code>是一个模板类，特化了三个类型：</p>
<ul>
<li>int32</li>
<li>float</li>
<li>FString</li>
</ul>
<p>如果你在使用<code>TAutoConsoleVariable</code>的时候遇到<code>TAutoConsoleVariable</code>的构造函数的链接错误，那么一定是用了未特化的类型，使用<code>FString</code>的特化裹一下吧。</p>
<h2 id="cmake-could-not-find-any-instance-of-Visual-Studio"><a href="#cmake-could-not-find-any-instance-of-Visual-Studio" class="headerlink" title="cmake:could not find any instance of Visual Studio."></a>cmake:could not find any instance of Visual Studio.</h2><p>在使用cmske生成时如果产生下列错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CMake Error at CMakeLists.txt:51 (project):</span><br><span class="line">Generator</span><br><span class="line">Visual Studio 15 2017 Win64</span><br><span class="line">could not find any instance of Visual Studio.</span><br><span class="line"></span><br><span class="line">Configuring incomplete, errors occurred!</span><br><span class="line">See also <span class="string">&quot;E:/protobuf/cmake/CMakeFiles/CMakeOutput.log“</span></span><br></pre></td></tr></table></figure>
<p>检查VS安装的时候有没有安装<strong>编译器、生成工具和运行时</strong>分类下的<strong>适用于桌面的VC++2015.3 v14.00(v140)工具集</strong>。</p>
<h2 id="编译目标的RuntimeLibrary类型"><a href="#编译目标的RuntimeLibrary类型" class="headerlink" title="编译目标的RuntimeLibrary类型"></a>编译目标的RuntimeLibrary类型</h2><p>与普通的c++项目不一样，UE的Game工程是不能在项目属性中设置<code>RuntimeLibrary</code>的，这部分有UBT代劳替我们处理。<br>其相关的代码在<code>UnrealBuildTool\Windows\VCToolchain.cs</code>(UE_4.22)中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;string&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Specify the appropriate runtime library based on the platform and config.</span></span><br><span class="line"><span class="keyword">if</span> (CompileEnvironment.bUseStaticCRT)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MTd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MT&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MDd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.<span class="built_in">Add</span>(<span class="string">&quot;/MD&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>*.target.cs</code>中使用了<code>bUseStaticCRT=true</code>后（默认为false），编译Debug版本是<code>/MTd</code>，其他版本是<code>MT</code>。<br>在<code>*.target.cs</code>中不能直接控制<code>bUseDebugCRT</code>,但是可以控制<code>bDebugBuildsActuallyUseDebugCRT</code>（默认为false）,它由我们在<code>VS</code>选的<code>Configuration</code>和<code>bDebugBuildsActuallyUseDebugCRT</code>的值来控制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; UEBuildTarget.cs</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; GetCppConfiguration</span><br><span class="line">static CppConfiguration GetCppConfiguration(UnrealTargetConfiguration Configuration)</span><br><span class="line">&#123;</span><br><span class="line">  switch (Configuration)</span><br><span class="line">  &#123;</span><br><span class="line">    case UnrealTargetConfiguration.Debug:</span><br><span class="line">      return CppConfiguration.Debug;</span><br><span class="line">    case UnrealTargetConfiguration.DebugGame:</span><br><span class="line">    case UnrealTargetConfiguration.Development:</span><br><span class="line">      return CppConfiguration.Development;</span><br><span class="line">    case UnrealTargetConfiguration.Shipping:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    case UnrealTargetConfiguration.Test:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    default:</span><br><span class="line">      throw new BuildException(&quot;Unhandled target configuration&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; CreateCompileEnvironmentForProjectFiles</span><br><span class="line">public CppCompileEnvironment CreateCompileEnvironmentForProjectFiles()</span><br><span class="line">&#123;</span><br><span class="line">  CppPlatform CppPlatform &#x3D; UEBuildPlatform.GetBuildPlatform(Platform).DefaultCppPlatform;</span><br><span class="line">  CppConfiguration CppConfiguration &#x3D; GetCppConfiguration(Configuration);</span><br><span class="line"></span><br><span class="line">  SourceFileMetadataCache MetadataCache &#x3D; SourceFileMetadataCache.CreateHierarchy(ProjectFile);</span><br><span class="line"></span><br><span class="line">  CppCompileEnvironment GlobalCompileEnvironment &#x3D; new CppCompileEnvironment(CppPlatform, CppConfiguration, Architecture, MetadataCache);</span><br><span class="line">  LinkEnvironment GlobalLinkEnvironment &#x3D; new LinkEnvironment(GlobalCompileEnvironment.Platform, GlobalCompileEnvironment.Configuration, GlobalCompileEnvironment.Architecture);</span><br><span class="line"></span><br><span class="line">  UEToolChain TargetToolChain &#x3D; CreateToolchain(CppPlatform);</span><br><span class="line">  SetupGlobalEnvironment(TargetToolChain, GlobalCompileEnvironment, GlobalLinkEnvironment);</span><br><span class="line"></span><br><span class="line">  return GlobalCompileEnvironment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; SetupGlobalEnvironment</span><br><span class="line">private void SetupGlobalEnvironment(UEToolChain ToolChain, CppCompileEnvironment GlobalCompileEnvironment, LinkEnvironment GlobalLinkEnvironment)</span><br><span class="line">&#123;</span><br><span class="line">	&#x2F;&#x2F; ...</span><br><span class="line">	GlobalCompileEnvironment.bUseDebugCRT &#x3D; GlobalCompileEnvironment.Configuration &#x3D;&#x3D; CppConfiguration.Debug &amp;&amp; Rules.bDebugBuildsActuallyUseDebugCRT;</span><br><span class="line">	&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，总结上面的代码，只有当VS的编译选项选的是<code>Debug</code>，并且在<code>*.Target.cs</code>中<code>bDebugBuildsActuallyUseDebugCRT=true</code>的时候，<code>bUseDebugCRT</code>才为<code>true</code>。</p>
<h3 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h3><ul>
<li>当<code>bUseStaticCRT=true;</code></li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及VS中的Configuration为<code>Debug</code></li>
</ul>
<p>以上三个条件全部满足的时候，编译的Runtime Library为<code>/MTd</code>。</p>
<h3 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h3><ul>
<li>当<code>bUseStaticCRT=false;</code>(默认)</li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及VS中的Configuration为<code>Debug</code></li>
</ul>
<p>这三个条件，编译的Runtime Library为<code>/MDd</code>。</p>
<h3 id="情况三"><a href="#情况三" class="headerlink" title="情况三"></a>情况三</h3><p>在<strong>情况二</strong>基础上把下列条件改为：</p>
<ul>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=false;</code>(默认)</li>
</ul>
<p>或者：</p>
<ul>
<li>以及VS中的Configuration不是<code>Debug</code></li>
</ul>
<p>则这种情况下，编译的Runtime Library都是<code>/MD</code>.</p>
<h2 id="What-is-Cook"><a href="#What-is-Cook" class="headerlink" title="What is Cook?"></a>What is Cook?</h2><p>虚幻引擎内部使用特定的格式存储游戏内的资产(uasset)，但是在游戏发行的时候需要将这个虚幻的资产转换为各种平台的不同格式，因为各个平台使用自己的专有格式或者各个平台上具有性能更好的存储格式。<strong>将虚幻内部格式转换为平台特定格式的过程被称作Cook。</strong><br>对于Windows而言，可以在编辑器中执行<code>Cook Content for Windows </code>，或者使用<code>UnrealFrontEnd</code>进行Cook或者Package。<br>也可以使用下列命令进行cook：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe &lt;GameName or uproject&gt; -run&#x3D;cook -targetplatform&#x3D;&lt;Plat1&gt;+&lt;Plat2&gt; [-cookonthefly] [-iterate] [-map&#x3D;&lt;Map1&gt;+&lt;Map2&gt;]</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Deployment/Cooking/index.html">Content Cooking</a></li>
</ul>
<h2 id="添加宏定义"><a href="#添加宏定义" class="headerlink" title="添加宏定义"></a>添加宏定义</h2><p>不同于普通的C++项目，可以在VS项目(<code>Project</code>-<code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Preprocessor</code>-<code>Preprocessor Definitions</code>)中或者直接在文件中使用<code>#define</code>(这样的方法在UE的项目中也可以用)，但是UE的项目有自己的在项目中添加宏的方法。</p>
<p>方法就是在<code>*.build.cs</code>中添加：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Definitions.<span class="built_in">Add</span>(<span class="string">&quot;GW_WITH_DEBUG=1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>然后在代码中就可以使用这个宏了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for example</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AVRPlayer::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">BeginPlay</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GW_WITH_DEBUG</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> GW_WITH_DEBUG</span></span><br><span class="line">		UKismetSystemLibrary::<span class="built_in">PrintString</span>(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;GW_WITH_DEBUG is defined&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		UKismetSystemLibrary::<span class="built_in">PrintString</span>(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;GW_WITH_DEBUG is not defined&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-add-code-macro-in-build-cs.webp"></p>
<h2 id="编译DLL时报错LNK1561-entry-point-must-be-defined"><a href="#编译DLL时报错LNK1561-entry-point-must-be-defined" class="headerlink" title="编译DLL时报错LNK1561: entry point must be defined"></a>编译DLL时报错LNK1561: entry point must be defined</h2><p>编译DLL时报下列错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LINK : fatal error LNK1561: entry point must be defined</span><br></pre></td></tr></table></figure>

<p>在VS中项目右键<code>Properties</code>，在当前的编译配置下检查，配置类型是不是DLL：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/DLL-Compile-Error-Link1561-ConfigurationType.webp"></p>
<p>以及<code>Configuration Porperties</code>-<code>Linker</code>-<code>System</code>-<code>SubSystem</code>项：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/DLL-Compile-Error-Link1561-Linker-System.webp"></p>
<p>改完之后重新编译即可。</p>
<h2 id="cpp中包含的第一个-h必须是自身类的"><a href="#cpp中包含的第一个-h必须是自身类的" class="headerlink" title="cpp中包含的第一个.h必须是自身类的"></a>cpp中包含的第一个.h必须是自身类的</h2><p>不然会有下列的错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\Documents\Unreal Projects\GWorld\Source\GWorld\Private\GWorldGameEngine.cpp(1): error : Expected GWorldGameEngine.h to be first header included.</span><br></pre></td></tr></table></figure>


<h2 id="修改游戏打包的进程名和Icon"><a href="#修改游戏打包的进程名和Icon" class="headerlink" title="修改游戏打包的进程名和Icon"></a>修改游戏打包的进程名和Icon</h2><p>打开项目设置(Project Settings)找到<code>Project</code>-<code>Description</code>下的<code>ProjectName</code>，修改这个参数为你想要的运行时创建的进程名(默认为<code>UEGame</code>)。</p>
<p>修改各个平台的Icon则在项目设置中找到<code>Platforms</code>下的各个平台，以<code>Windows</code>为例：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4-Change-Project-Package-Icon.webp"></p>
<p>设置完之后会在项目目录下创建一个<code>Build/Windows/Application.ico</code>的文件。</p>
<h2 id="SetActorHiddenInGame与SetVisibility的同步"><a href="#SetActorHiddenInGame与SetVisibility的同步" class="headerlink" title="SetActorHiddenInGame与SetVisibility的同步"></a>SetActorHiddenInGame与SetVisibility的同步</h2><p>对于所有逻辑都在服务器上跑的内容（不考虑本地先做效果以及延迟补偿）的情况下，使用UE的网络架构很方便，但是如果考虑到这些情况再直接用UE的同步(尤其是显示效果的同步)时会出现一些问题。</p>
<h3 id="AActor-SetActorHiddenInGame"><a href="#AActor-SetActorHiddenInGame" class="headerlink" title="AActor::SetActorHiddenInGame"></a>AActor::SetActorHiddenInGame</h3><p>当对一个同步的Actor在服务器上调用<code>SetActorHiddenInGame</code>的时，该操作会同步到客户端。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::SetActorHiddenInGame</span><span class="params">( <span class="keyword">bool</span> bNewHidden )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bHidden != bNewHidden)</span><br><span class="line">  &#123;</span><br><span class="line">    bHidden = bNewHidden;</span><br><span class="line">    <span class="built_in">MarkComponentsRenderStateDirty</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Actor::bHidden</code>的这个状态是同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(Interp, EditAnywhere, Category=Rendering, BlueprintReadOnly, replicated, meta=(DisplayName = <span class="string">&quot;Actor Hidden In Game&quot;</span>, SequencerTrackClass = <span class="string">&quot;MovieSceneVisibilityTrack&quot;</span>))</span><br><span class="line">  uint8 bHidden:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>其他的非服务器客户端在接收到变量同步的事件后会调用<code>AActor::PostNetReceive</code>函数：</p>
<blockquote>
<p>Always called immediately after properties are received from the remote.</p>
</blockquote>
<p>可以看到，在客户端接收<code>bHidden</code>更改的变量之后，会调用本地的<code>AActor::SetActorHiddenInGame</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::PostNetReceive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!bNetCheckedInitialPhysicsState)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Initially we need to sync the state regardless of whether bRepPhysics has &quot;changed&quot; since it may not currently match IsSimulatingPhysics().</span></span><br><span class="line">    <span class="built_in">SyncReplicatedPhysicsSimulation</span>();</span><br><span class="line">    ActorReplication::SavedbRepPhysics = ReplicatedMovement.bRepPhysics;</span><br><span class="line">    bNetCheckedInitialPhysicsState = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ExchangeB</span>( bHidden, ActorReplication::SavedbHidden );</span><br><span class="line">  <span class="built_in">Exchange</span> ( Owner, ActorReplication::SavedOwner );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bHidden != ActorReplication::SavedbHidden)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetActorHiddenInGame</span>(ActorReplication::SavedbHidden);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Owner != ActorReplication::SavedOwner)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetOwner</span>(ActorReplication::SavedOwner);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Role != ActorReplication::SavedRole)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">PostNetReceiveRole</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>AActor::SetActorHiddenInGame</code>中做了<code>MarkComponentsRenderStateDirty()</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::MarkComponentsRenderStateDirty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (UActorComponent* ActorComp : <span class="built_in">GetComponents</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (ActorComp &amp;&amp; ActorComp-&gt;<span class="built_in">IsRegistered</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      ActorComp-&gt;<span class="built_in">MarkRenderStateDirty</span>();</span><br><span class="line">      <span class="keyword">if</span> (UChildActorComponent* ChildActorComponent = Cast&lt;UChildActorComponent&gt;(ActorComp))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (ChildActorComponent-&gt;<span class="built_in">GetChildActor</span>())</span><br><span class="line">        &#123;</span><br><span class="line">          ChildActorComponent-&gt;<span class="built_in">GetChildActor</span>()-&gt;<span class="built_in">MarkComponentsRenderStateDirty</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会把Actor上所有注册过的组件标记为不渲染，从而实现了服务器调用<code>SetActorHiddenInGame</code>会同步到其他客户端的目的。</p>
<h3 id="USceneComponent-SetVisibility"><a href="#USceneComponent-SetVisibility" class="headerlink" title="USceneComponent::SetVisibility"></a>USceneComponent::SetVisibility</h3><p>当UE的<code>USceneComponent</code>被设置为<code>Component Replications</code>时，在服务器上调用<code>SetVisibility</code>会同步到客户端，内部的机制也是变量同步(相同的状态不会传递给其他的客户端)。</p>
<p><code>USceneComponent::SetVisibility</code>的代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::SetVisibility</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> bNewVisibility, <span class="keyword">const</span> USceneComponent::EVisibilityPropagation PropagateToChildren)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRecurseChildren = (PropagateToChildren == EVisibilityPropagation::Propagate);</span><br><span class="line">  <span class="keyword">if</span> ( bNewVisibility != bVisible )</span><br><span class="line">  &#123;</span><br><span class="line">    bRecurseChildren = bRecurseChildren || (PropagateToChildren == EVisibilityPropagation::DirtyOnly);</span><br><span class="line">    bVisible = bNewVisibility;</span><br><span class="line">    <span class="built_in">OnVisibilityChanged</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> TArray&lt;USceneComponent*&gt;&amp; AttachedChildren = <span class="built_in">GetAttachChildren</span>();</span><br><span class="line">  <span class="keyword">if</span> (bRecurseChildren &amp;&amp; AttachedChildren.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// fully traverse down the attachment tree</span></span><br><span class="line">    <span class="comment">// we do it entirely inline here instead of recursing in case a primitivecomponent is a child of a non-primitivecomponent</span></span><br><span class="line">    TInlineComponentArray&lt;USceneComponent*, NumInlinedActorComponents&gt; ComponentStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prime the pump</span></span><br><span class="line">    ComponentStack.<span class="built_in">Append</span>(AttachedChildren);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ComponentStack.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      USceneComponent* <span class="keyword">const</span> CurrentComp = ComponentStack.<span class="built_in">Pop</span>(<span class="comment">/*bAllowShrinking=*/</span> <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (CurrentComp)</span><br><span class="line">      &#123;</span><br><span class="line">        ComponentStack.<span class="built_in">Append</span>(CurrentComp-&gt;<span class="built_in">GetAttachChildren</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PropagateToChildren == EVisibilityPropagation::Propagate)</span><br><span class="line">        &#123;</span><br><span class="line">          CurrentComp-&gt;<span class="built_in">SetVisibility</span>(bNewVisibility, EVisibilityPropagation::NoPropagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Render state must be dirtied if any parent component&#x27;s visibility has changed. Since we can&#x27;t easily track whether </span></span><br><span class="line">        <span class="comment">// any parent in the hierarchy was dirtied, we have to mark dirty always.</span></span><br><span class="line">        CurrentComp-&gt;<span class="built_in">MarkRenderStateDirty</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过检测之后它会将变量<code>bVisible</code>设置为新的状态，这个变量是设置为同步的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Whether to completely draw the primitive; if false, the primitive is not drawn, does not cast a shadow. */</span></span><br><span class="line"><span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadOnly, ReplicatedUsing=OnRep_Visibility,  Category = Rendering)</span><br><span class="line">  uint8 bVisible:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::OnRep_Visibility</span><span class="params">(<span class="keyword">bool</span> OldValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> ReppedValue = bVisible;</span><br><span class="line">  bVisible = OldValue;</span><br><span class="line">  <span class="built_in">SetVisibility</span>(ReppedValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以对于标记为<code>Component Replications</code>的组件在服务器上调用<code>SetVisibility</code>时会同步让客户端的也显示。<br>因为这一点性质在做网络同步时，同步状态的组件和显示效果的组件一定要分割开。</p>
<h3 id="USceneComponent-SetHiddenInGame"><a href="#USceneComponent-SetHiddenInGame" class="headerlink" title="USceneComponent::SetHiddenInGame"></a>USceneComponent::SetHiddenInGame</h3><p><code>USceneComponent::SetHiddenInGame</code>是不同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Engine/Private/Components/SceneComponent.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::SetHiddenInGame</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> bNewHiddenGame, <span class="keyword">const</span> USceneComponent::EVisibilityPropagation PropagateToChildren)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRecurseChildren = (PropagateToChildren == EVisibilityPropagation::Propagate);</span><br><span class="line">  <span class="keyword">if</span> ( bNewHiddenGame != bHiddenInGame )</span><br><span class="line">  &#123;</span><br><span class="line">    bRecurseChildren = bRecurseChildren || (PropagateToChildren == EVisibilityPropagation::DirtyOnly);</span><br><span class="line">    bHiddenInGame = bNewHiddenGame;</span><br><span class="line">    <span class="built_in">OnHiddenInGameChanged</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> TArray&lt;USceneComponent*&gt;&amp; AttachedChildren = <span class="built_in">GetAttachChildren</span>();</span><br><span class="line">  <span class="keyword">if</span> (bRecurseChildren &amp;&amp; AttachedChildren.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// fully traverse down the attachment tree</span></span><br><span class="line">    <span class="comment">// we do it entirely inline here instead of recursing in case a primitivecomponent is a child of a non-primitivecomponent</span></span><br><span class="line">    TInlineComponentArray&lt;USceneComponent*, NumInlinedActorComponents&gt; ComponentStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prime the pump</span></span><br><span class="line">    ComponentStack.<span class="built_in">Append</span>(AttachedChildren);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ComponentStack.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      USceneComponent* <span class="keyword">const</span> CurrentComp = ComponentStack.<span class="built_in">Pop</span>(<span class="comment">/*bAllowShrinking=*/</span> <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (CurrentComp)</span><br><span class="line">      &#123;</span><br><span class="line">        ComponentStack.<span class="built_in">Append</span>(CurrentComp-&gt;<span class="built_in">GetAttachChildren</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PropagateToChildren == EVisibilityPropagation::Propagate)</span><br><span class="line">        &#123;</span><br><span class="line">          CurrentComp-&gt;<span class="built_in">SetHiddenInGame</span>(bNewHiddenGame, EVisibilityPropagation::NoPropagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Render state must be dirtied if any parent component&#x27;s visibility has changed. Since we can&#x27;t easily track whether </span></span><br><span class="line">        <span class="comment">// any parent in the hierarchy was dirtied, we have to mark dirty always.</span></span><br><span class="line">        CurrentComp-&gt;<span class="built_in">MarkRenderStateDirty</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与<code>AActoe::SetHiddenInGame</code>类似的写法，不过区别在于<code>USceneComponent::SetHiddenInGame</code>设置的变量<code>bHiddenInGame</code>是不同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(Interp, EditAnywhere, BlueprintReadOnly, Category=Rendering, meta=(SequencerTrackClass = <span class="string">&quot;MovieSceneVisibilityTrack&quot;</span>))</span><br><span class="line">  uint8 bHiddenInGame:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="行为树Task的ReceiveTickAI与ReceiveTick的区别"><a href="#行为树Task的ReceiveTickAI与ReceiveTick的区别" class="headerlink" title="行为树Task的ReceiveTickAI与ReceiveTick的区别"></a>行为树Task的ReceiveTickAI与ReceiveTick的区别</h2><p>调用代码在<code>UBTTask_BlueprintBase::ExecuteTask</code>里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">EBTNodeResult::Type UBTTask_BlueprintBase::ExecuteTask(UBehaviorTreeComponent&amp; OwnerComp, uint8* NodeMemory)</span><br><span class="line">&#123;</span><br><span class="line">  &#x2F;&#x2F; fail when task doesn&#39;t react to execution (start or tick)</span><br><span class="line">  CurrentCallResult &#x3D; (ReceiveExecuteImplementations !&#x3D; 0 || ReceiveTickImplementations !&#x3D; 0) ? EBTNodeResult::InProgress : EBTNodeResult::Failed;</span><br><span class="line">  bIsAborting &#x3D; false;</span><br><span class="line"></span><br><span class="line">  if (ReceiveExecuteImplementations !&#x3D; FBTNodeBPImplementationHelper::NoImplementation)</span><br><span class="line">  &#123;</span><br><span class="line">    bStoreFinishResult &#x3D; true;</span><br><span class="line"></span><br><span class="line">    if (AIOwner !&#x3D; nullptr &amp;&amp; (ReceiveExecuteImplementations &amp; FBTNodeBPImplementationHelper::AISpecific))</span><br><span class="line">    &#123;</span><br><span class="line">      ReceiveExecuteAI(AIOwner, AIOwner-&gt;GetPawn());</span><br><span class="line">    &#125;</span><br><span class="line">    else if (ReceiveExecuteImplementations &amp; FBTNodeBPImplementationHelper::Generic)</span><br><span class="line">    &#123;</span><br><span class="line">      ReceiveExecute(ActorOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bStoreFinishResult &#x3D; false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return CurrentCallResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到<code>ReceiveTickAI</code>与<code>ReceiveTick</code>的区别是判断了<code>AIOwner</code>(<code>AAIController*</code>)是否存在，正常来说，运行了行为树<code>AAIController::RunBehaviorTask</code>，其Controller是肯定会存在的，可能只是为了区分参数吧。</p>
<h2 id="Actor的Connection"><a href="#Actor的Connection" class="headerlink" title="Actor的Connection"></a>Actor的Connection</h2><p><code>AActor::GetNetConnection</code>获取的是当前Actor的Owner的Connection(递归获取)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNetConnection* <span class="title">AActor::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Owner ? Owner-&gt;<span class="built_in">GetNetConnection</span>() : <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>APawn::GetNetConnection</code>重写了这个函数，获取的是当前Pawn的Controller的Connection：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class UNetConnection* <span class="title">APawn::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// if have a controller, it has the net connection</span></span><br><span class="line">  <span class="keyword">if</span> ( Controller )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> Controller-&gt;<span class="built_in">GetNetConnection</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Super::<span class="built_in">GetNetConnection</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>AController</code>也是继承于Actor的，<code>APlayerController</code>中重写了这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNetConnection* <span class="title">APlayerController::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// A controller without a player has no &quot;owner&quot;</span></span><br><span class="line">  <span class="keyword">return</span> (Player != <span class="literal">NULL</span>) ? NetConnection : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取的是<code>APlayerController</code>的<code>NetConnection</code>成员，该成员是在<code>APlayerController::SetPlayer</code>中被赋值为参数<code>InPlayer</code>的，<code>UNetConnection</code>继承自<code>UPlayer</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">APlayerController::SetPlayer</span><span class="params">( UPlayer* InPlayer )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(InPlayer!=<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bIsSameLevel = InPlayer-&gt;PlayerController &amp;&amp; (InPlayer-&gt;PlayerController-&gt;<span class="built_in">GetLevel</span>() == <span class="built_in">GetLevel</span>());</span><br><span class="line">  <span class="comment">// Detach old player if it&#x27;s in the same level.</span></span><br><span class="line">  <span class="keyword">if</span> (bIsSameLevel)</span><br><span class="line">  &#123;</span><br><span class="line">    InPlayer-&gt;PlayerController-&gt;Player = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the viewport.</span></span><br><span class="line">  Player = InPlayer;</span><br><span class="line">  InPlayer-&gt;PlayerController = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cap outgoing rate to max set by server</span></span><br><span class="line">  UNetDriver* Driver = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetNetDriver</span>();</span><br><span class="line">  <span class="keyword">if</span>( (ClientCap&gt;=<span class="number">2600</span>) &amp;&amp; Driver &amp;&amp; Driver-&gt;ServerConnection )</span><br><span class="line">  &#123;</span><br><span class="line">    Player-&gt;CurrentNetSpeed = Driver-&gt;ServerConnection-&gt;CurrentNetSpeed = FMath::<span class="built_in">Clamp</span>( ClientCap, <span class="number">1800</span>, Driver-&gt;MaxClientRate );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initializations only for local players</span></span><br><span class="line">  ULocalPlayer *LP = Cast&lt;ULocalPlayer&gt;(InPlayer);</span><br><span class="line">  <span class="keyword">if</span> (LP != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Clients need this marked as local (server already knew at construction time)</span></span><br><span class="line">    <span class="built_in">SetAsLocalPlayerController</span>();</span><br><span class="line">    LP-&gt;<span class="built_in">InitOnlineSession</span>();</span><br><span class="line">    <span class="built_in">InitInputSystem</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    NetConnection = Cast&lt;UNetConnection&gt;(InPlayer);</span><br><span class="line">    <span class="keyword">if</span> (NetConnection)</span><br><span class="line">    &#123;</span><br><span class="line">      NetConnection-&gt;OwningActor = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">UpdateStateInputComponents</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_VISUAL_LOG</span></span><br><span class="line">  <span class="keyword">if</span> (Role == ROLE_Authority &amp;&amp; FVisualLogger::<span class="built_in">Get</span>().<span class="built_in">IsRecordingOnServer</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">OnServerStartedVisualLogger</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// notify script that we&#x27;ve been assigned a valid player</span></span><br><span class="line">  <span class="built_in">ReceivedPlayer</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="uasset-format"><a href="#uasset-format" class="headerlink" title="uasset format"></a>uasset format</h2><h3 id="FPackageFileSummary"><a href="#FPackageFileSummary" class="headerlink" title="FPackageFileSummary"></a>FPackageFileSummary</h3><p><strong>Tag</strong></p>
<ul>
<li><code>PACKAGE_FILE_TAG</code>/<code>PACKAGE_FILE_TAG_SWAPPED</code>:定义在<code>Runtime/Core/Public/UObject/ObjectVersion.h</code>中</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE_FILE_TAG      0x9E2A83C1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE_FILE_TAG_SWAPPED  0xC1832A9E</span></span><br></pre></td></tr></table></figure>
<p>这个MigicNumber可以打开<code>uasset</code>文件，文件头的前四个字节即是。</p>
<p><strong>FileVersionUE4</strong>与<strong>FileVersionLicenseeUE4</strong><br><code>Engine/Source/Runtime/Core/Private/UObject/ObjectVersion.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @see ObjectVersion.h for the list of changes/defines</span></span><br><span class="line"><span class="keyword">const</span> int32 GPackageFileUE4Version = VER_LATEST_ENGINE_UE4;</span><br><span class="line"><span class="keyword">const</span> int32 GPackageFileLicenseeUE4Version = VER_LATEST_ENGINE_LICENSEEUE4;</span><br></pre></td></tr></table></figure>

<p>uasset的存储是写在<code>FLinkerSave</code>的构造函数中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Private/LinkerSave.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** A mapping of package name to generated script SHA keys */</span></span><br><span class="line">TMap&lt;FString, TArray&lt;uint8&gt; &gt; FLinkerSave::PackagesToScriptSHAMap;</span><br><span class="line"></span><br><span class="line">FLinkerSave::<span class="built_in">FLinkerSave</span>(UPackage* InParent, <span class="keyword">const</span> TCHAR* InFilename, <span class="keyword">bool</span> bForceByteSwapping, <span class="keyword">bool</span> bInSaveUnversioned)</span><br><span class="line">:  <span class="built_in">FLinker</span>(ELinkerType::Save, InParent, InFilename )</span><br><span class="line">,  <span class="built_in">Saver</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">HasEditorOnlyData</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create file saver.</span></span><br><span class="line">    Saver = IFileManager::<span class="built_in">Get</span>().<span class="built_in">CreateFileWriter</span>( InFilename, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( !Saver )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">UE_LOG</span>(LogLinker, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *FString::<span class="built_in">Printf</span>( <span class="built_in">TEXT</span>(<span class="string">&quot;Error opening file &#x27;%s&#x27;.&quot;</span>), InFilename ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UPackage* Package = <span class="keyword">dynamic_cast</span>&lt;UPackage*&gt;(LinkerRoot);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set main summary info.</span></span><br><span class="line">    Summary.Tag           = PACKAGE_FILE_TAG;</span><br><span class="line">    Summary.<span class="built_in">SetFileVersions</span>( GPackageFileUE4Version, GPackageFileLicenseeUE4Version, bInSaveUnversioned );</span><br><span class="line">    Summary.SavedByEngineVersion = FEngineVersion::<span class="built_in">Current</span>();</span><br><span class="line">    Summary.CompatibleWithEngineVersion = FEngineVersion::<span class="built_in">CompatibleWith</span>();</span><br><span class="line">    Summary.PackageFlags = Package ? (Package-&gt;<span class="built_in">GetPackageFlags</span>() &amp; ~PKG_NewlyCreated) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_STABLE_LOCALIZATION_KEYS</span></span><br><span class="line">    <span class="keyword">if</span> (GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      Summary.LocalizationId = TextNamespaceUtil::<span class="built_in">GetPackageNamespace</span>(LinkerRoot);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USE_STABLE_LOCALIZATION_KEYS</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Package)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">      Summary.FolderName = Package-&gt;<span class="built_in">GetFolderName</span>().<span class="built_in">ToString</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      Summary.ChunkIDs = Package-&gt;<span class="built_in">GetChunkIDs</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set status info.</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">SetIsSaving</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">SetIsPersistent</span>(<span class="literal">true</span>);</span><br><span class="line">    ArForceByteSwapping    = bForceByteSwapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_STABLE_LOCALIZATION_KEYS</span></span><br><span class="line">    <span class="keyword">if</span> (GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">SetLocalizationNamespace</span>(Summary.LocalizationId);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USE_STABLE_LOCALIZATION_KEYS</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9fea500aaa4d">UE4对象序列化和uaset格式</a></li>
</ul>
<h2 id="DECLARE-CLASS与Super"><a href="#DECLARE-CLASS与Super" class="headerlink" title="DECLARE_CLASS与Super"></a>DECLARE_CLASS与Super</h2><p>UE中的实现中使用了大量的宏，比如<code>UObject::StaticClass</code>的定义并没有直接写在<code>Object.h</code>中，而是使用<code>DECLARE_CLASS</code>宏来实现的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">  Class declaration macros.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_CLASS( TClass, TSuperClass, TStaticFlags, TStaticCastFlags, TPackage, TRequiredAPI  ) \</span></span><br><span class="line"><span class="keyword">private</span>: \</span><br><span class="line">    TClass&amp; <span class="keyword">operator</span>=(TClass&amp;&amp;);   \</span><br><span class="line">    TClass&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> TClass&amp;);   \</span><br><span class="line">  <span class="function">TRequiredAPI <span class="keyword">static</span> UClass* <span class="title">GetPrivateStaticClass</span><span class="params">()</span></span>; \</span><br><span class="line"><span class="keyword">public</span>: \</span><br><span class="line">  <span class="comment">/** Bitwise union of #EClassFlags pertaining to this class.*/</span> \</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> &#123;</span>StaticClassFlags=TStaticFlags&#125;; \</span><br><span class="line">  <span class="comment">/** Typedef for the base class (&#123;&#123; typedef-type &#125;&#125;) */</span> \</span><br><span class="line">  <span class="keyword">typedef</span> TSuperClass Super;\</span><br><span class="line">  <span class="comment">/** Typedef for &#123;&#123; typedef-type &#125;&#125;. */</span> \</span><br><span class="line">  <span class="keyword">typedef</span> TClass ThisClass;\</span><br><span class="line">  <span class="comment">/** Returns a UClass object representing this class at runtime */</span> \</span><br><span class="line">  inline static UClass* StaticClass() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GetPrivateStaticClass</span>(); \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** Returns the package this class belongs in */</span> \</span><br><span class="line">  inline static const TCHAR* StaticPackage() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> TPackage; \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** Returns the static cast flags for this class */</span> \</span><br><span class="line">  inline static EClassCastFlags StaticClassCastFlags() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> TStaticCastFlags; \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span> \</span><br><span class="line">  inline void* operator new(const size_t InSize, EInternal InInternalOnly, UObject* InOuter = (UObject*)GetTransientPackage(), FName InName = NAME_None, EObjectFlags InSetFlags = RF_NoFlags) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">StaticAllocateObject</span>(<span class="built_in">StaticClass</span>(), InOuter, InName, InSetFlags); \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span> \</span><br><span class="line">  inline void* operator new( const size_t InSize, EInternal* InMem ) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)InMem; \</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>该宏在UObject的声明中使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COREUOBJECT_API</span> <span class="title">UObject</span> :</span> <span class="keyword">public</span> UObjectBaseUtility</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Declarations, normally created by UnrealHeaderTool boilerplate code</span></span><br><span class="line">  <span class="built_in">DECLARE_CLASS</span>(UObject,UObject,CLASS_Abstract|CLASS_NoExport|CLASS_Intrinsic|CLASS_MatchedSerializers,CASTCLASS_None,<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/CoreUObject&quot;</span>),NO_API)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意：这个宏在UHT生成的<code>xxxx.generated.h</code>中被使用，本质就是在继承后的类中也使用了<code>DECLARE_CLass</code>宏，并且把其中所有的<code>typedef</code>和函数都定义了一遍，由于name hidden，在当前类的namespace下使用typedef或者调用其中的函数，都是当前类定义的。<br>比如，<code>ABaseActor</code>继承自<code>AActor</code>，那么我在<code>ABaseActor</code>中使用<code>Super</code>，使用的是<code>AAcotr::Super</code>，而不是更深的继承层次的<code>Super</code>。</p>
<h2 id="GenerateProjectFiles-bat运行错误2"><a href="#GenerateProjectFiles-bat运行错误2" class="headerlink" title="GenerateProjectFiles.bat运行错误2"></a>GenerateProjectFiles.bat运行错误2</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Setting up Unreal Engine <span class="number">4</span> project files...</span><br><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">Studio</span>\2017\<span class="title">Enterprise</span>\<span class="title">MSBuild</span>\15.0\<span class="title">Bin</span></span></span><br><span class="line"><span class="function">\<span class="title">Microsoft.Common.CurrentVersion.targets</span>(1179,5): <span class="title">error</span> <span class="title">MSB3644</span>: 未找到框架“.<span class="title">NETFram</span></span></span><br><span class="line"><span class="function"><span class="title">ework</span>,<span class="title">Version</span>=<span class="title">v4</span>.6.2”的引用程序集。若要解决此问题，请安装此框架版本的 <span class="title">SDK</span> 或 <span class="title">Targeting</span> <span class="title">Pack</span>，或将应用程序的目标重新指</span></span><br><span class="line"><span class="function">向已装有 <span class="title">SDK</span> 或 <span class="title">Targeting</span> <span class="title">Pack</span> 的框架版本。请注意，将从全局程序集缓存(<span class="title">GAC</span>)解析程序集，并将使用这些程序集替换引用程序集。因此，程序集</span></span><br><span class="line"><span class="function">的目标可能未正确指向您所预期的框架。 [<span class="title">D</span>:\<span class="title">UnrealEngine</span>\<span class="title">Offical_Source</span>\4.22\<span class="title">Engine</span>\<span class="title">Source</span>\<span class="title">Programs</span>\</span></span><br><span class="line"><span class="function"><span class="title">UnrealBuildTool</span>\<span class="title">UnrealBuildTool.csproj</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GenerateProjectFiles</span> <span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">failed</span> <span class="title">to</span> <span class="title">compile</span>.</span></span><br></pre></td></tr></table></figure>
<p>这是因为<code>Engine\Source\Programs\ UnrealBuildTool\UnrealBuildTool.csproj</code>中指定的.NetFramework版本与本地已经安装的不匹配。</p>
<p>首先，先查看本机安装的.NetFramework版本，可以打开注册表：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/dotNetFrameWorkVersionNumberInRegister.webp"></p>
<p>我的是<code>528040</code>，可以通过微软的网站查到不同的数字对应的版本号：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed">如何：确定已安装的 .NET Framework 版本</a>.</p>
<p>可以看到.NetFramework的版本号对照：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full</span><br></pre></td></tr></table></figure>
<p>找到<code>Release</code>项，其是一个<code>REG_DWORD</code>值。</p>
<table>
<thead>
<tr>
<th align="center">.NET Framework 版本</th>
<th align="left">Release DWORD 的值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">.NET Framework 4.5</td>
<td align="left">所有 Windows 操作系统：378389</td>
</tr>
<tr>
<td align="center">.NET Framework 4.5.1</td>
<td align="left">在 Windows 8.1 和 Windows Server 2012 R2 上：378675<br/>在所有其他 Windows 操作系统上：378758</td>
</tr>
<tr>
<td align="center">.NET Framework 4.5.2</td>
<td align="left">所有 Windows 操作系统：379893</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6</td>
<td align="left">在 Windows 10 上：393295<br/>在所有其他 Windows 操作系统上：393297</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6.1</td>
<td align="left">在 Windows 10 11 月更新系统上：394254<br/>在所有其他 Windows 操作系统（包括 Windows 10）上：394271</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6.2</td>
<td align="left">在 Windows 10 周年更新和 Windows Server 2016 上：394802<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：394806</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7</td>
<td align="left">在 Windows 10 创意者更新上：460798<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：460805</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7.1</td>
<td align="left">在 Windows 10 Fall Creators Update 和 Windows Server 版本 1709 上：461308<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：461310</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7.2</td>
<td align="left">在 Windows 10 2018 年 4 月更新和 Windows Server 版本 1803 上：461808<br/>在除 Windows 10 2018 年 4 月更新和 Windows Server 版本 1803 之外的所有 Windows 操作系统上：461814</td>
</tr>
<tr>
<td align="center">.NET Framework 4.8</td>
<td align="left">在 Windows 10 2019 年 5 月更新上：528040<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：528049</td>
</tr>
</tbody></table>
<p>通过这个对照表可以看到，我电脑上装的是.NET Framework 4.8，但是UBT的<code>csproj</code>文件里指定的是4.6.2，找不到对应的版本就产生了错误。<br>一个最简单的解决办法是打开visual studio install勾选上想要安装的.NetFramework版本安装即可。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44548780/the-reference-assemblies-for-framework-netframework-version-v4-6-2-were-not-f">The reference assemblies for framework “.NETFramework,Version=v4.6.2” were not found</a></li>
</ul>
<h2 id="GenerateProjectFiles-bat运行错误1"><a href="#GenerateProjectFiles-bat运行错误1" class="headerlink" title="GenerateProjectFiles.bat运行错误1"></a>GenerateProjectFiles.bat运行错误1</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Setting up Unreal Engine <span class="number">4</span> project files...</span><br><span class="line">While compiling E:\UnrealEngine\EngineSource\UE_4.<span class="number">21</span>_Source\Engine\Intermediate\Build\BuildRules\UE4Rules.dll:</span><br><span class="line"><span class="function">e:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Experimental</span>\<span class="title">GeometryCache</span>\<span class="title">Source</span>\<span class="title">GeometryCache</span>\<span class="title">GeometryCache.Build.cs</span>(5,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">GeometryCache</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Experimental</span>\<span class="title">GeometryCache</span>\<span class="title">Source</span>\<span class="title">GeometryCacheEd</span>\<span class="title">GeometryCacheEd.Build.cs</span>(5,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">GeometryCacheEd</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">HTNPlanner</span>\<span class="title">Source</span>\<span class="title">HTNPlanner</span>\<span class="title">HTNPlanner.Build.cs</span>(5,18) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“<span class="title">UnrealBuildTool.Rules</span>”已经包含了“<span class="title">HTNPlanner</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">HTNPlanner</span>\<span class="title">Source</span>\<span class="title">HTNTestSuite</span>\<span class="title">HTNTestSuite.Build.cs</span>(7,18) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“<span class="title">UnrealBuildTool.Rules</span>”已经包含了“<span class="title">HTNTestSuite</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">MixedRealityFramework</span>\<span class="title">Source</span>\<span class="title">ThirdParty</span>\<span class="title">OpenCV</span>\<span class="title">OpenCV.Build.cs</span>(6,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">OpenCV</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">Exception</span>: <span class="title">Unable</span> <span class="title">to</span> <span class="title">compile</span> <span class="title">source</span> <span class="title">files</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GenerateProjectFiles</span> <span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">was</span> <span class="title">unable</span> <span class="title">to</span> <span class="title">generate</span> <span class="title">project</span> <span class="title">files</span>.</span></span><br></pre></td></tr></table></figure>
<p>这是因为所提示的文件已经存在，将报错提示的文件删除之后再重新运行<code>GenerateProjectFiles.bat</code>即可。</p>
<p>相关问题：<a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/414620/build-error-on-generateprojectfiles.html">Build Error on GenerateProjectFiles</a></p>
<h2 id="UE添加Profiling统计信息：代码块的CPU计数周期"><a href="#UE添加Profiling统计信息：代码块的CPU计数周期" class="headerlink" title="UE添加Profiling统计信息：代码块的CPU计数周期"></a>UE添加Profiling统计信息：代码块的CPU计数周期</h2><p>在使用UnrealForntEnd来来抓取Profiling数据的时候，可以看到函数调用的开销信息，如果自己创建一个新的函数，则需要自己添加标记。可以使用<code>DECLARE_CYCLE_STAT</code>宏来声明(写在.cpp中)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_CYCLE_STAT</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfilingDeclare&quot;</span>), STAT_ProfilingDeclare, STATGROUP_Profiling)</span><br></pre></td></tr></table></figure>
<p>使用的方法为用<code>SCOPE_CYCLE_COUNTER</code>宏，并传入前面声明中的第二个参数<code>ProfilingDeclare</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AExample::Func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SOCPE_CYCLE_COUNTER</span>(STAT_ProfilingDeclare);</span><br><span class="line">    <span class="comment">// Something</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/Profiling,_How_To_Count_CPU_Cycles_Of_Specific_Blocks_Of_Your_Game_Code">Profiling, How To Count CPU Cycles Of Specific Blocks Of Your Game Code</a></li>
</ul>
<h2 id="ON-SCOPE-EXIT"><a href="#ON-SCOPE-EXIT" class="headerlink" title="ON_SCOPE_EXIT"></a>ON_SCOPE_EXIT</h2><p>UE中有一个宏<code>ON_SCOPE_EXIT</code>，它的用法为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make sure module info is added to known modules and proper delegates are fired on exit.</span></span><br><span class="line">ON_SCOPE_EXIT</span><br><span class="line">&#123;</span><br><span class="line">  FModuleManager::<span class="built_in">Get</span>().<span class="built_in">AddModuleToModulesList</span>(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<a href="https://imzlp.com/posts/31203/">UE4 Modules:Find the DLL and load it</a>里曾提到过这种用法：</p>
<blockquote>
<p>这段代码的意思是在退出当前的作用域(Scope)时执行<code>&#123;&#125;</code>中的逻辑，简单地来说，它定义了一个当前作用域的对象并托管了一个Lambda，在离开当前作用域的时候通过C++的RAII机制来调用托管的Lambda.</p>
</blockquote>
<p>今天来简单分析一下它的实现。</p>
<p>首先，<code>ON_SCOPE_EXIT</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON_SCOPE_EXIT const auto ANONYMOUS_VARIABLE(ScopeGuard_) = ::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()</span></span><br></pre></td></tr></table></figure>

<p>由此展开，最开始的那个使用的宏就等价替换为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">auto</span> <span class="title">ANONYMOUS_VARIABLE</span><span class="params">(ScopeGuard_)</span> </span>= ::ScopeExitSupport::<span class="built_in">FScopeGuardSyntaxSupport</span>() + [&amp;]()&#123;</span><br><span class="line">    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">AddModuleToModulesList</span>(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通常lambda用在谓词和调用的时候还好理解，但是这个搞了个<code>+</code>有点不走寻常路，由此可以推断类型<code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code>必然重载了<code>operator+</code>操作符，并且是个模板函数。</p>
<p>查看<code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Misc\ScopeExit.h</span></span><br><span class="line"><span class="keyword">namespace</span> ScopeExitSupport</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Not meant for direct consumption : use ON_SCOPE_EXIT instead.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * RAII class that calls a lambda when it is destroyed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TScopeGuard</span> :</span> <span class="keyword">public</span> FNoncopyable</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Given a lambda, constructs an RAII scope guard.</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">TScopeGuard</span><span class="params">(FuncType&amp;&amp; InFunc)</span></span></span><br><span class="line"><span class="function">      : Func(MoveTemp(InFunc))&#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This constructor needs to be available for the code to compile.</span></span><br><span class="line">    <span class="comment">// It will be almost definitely be RVOed out (even in DEBUG).</span></span><br><span class="line">    <span class="built_in">TScopeGuard</span>(TScopeGuard&amp;&amp; Other)</span><br><span class="line">      : <span class="built_in">Func</span>(<span class="built_in">MoveTemp</span>(Other.Func))</span><br><span class="line">    &#123;</span><br><span class="line">      Other.Func.<span class="built_in">Reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Causes</span></span><br><span class="line">    ~<span class="built_in">TScopeGuard</span>()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Func.<span class="built_in">IsSet</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        Func.<span class="built_in">GetValue</span>()();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// The lambda to be executed when this guard goes out of scope.</span></span><br><span class="line">    TOptional&lt;FuncType&gt; Func;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">FScopeGuardSyntaxSupport</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">    TScopeGuard&lt;FuncType&gt; <span class="keyword">operator</span>+(FuncType&amp;&amp; InFunc)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> TScopeGuard&lt;FuncType&gt;(Forward&lt;FuncType&gt;(InFunc));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然！类型<code>FScopeGuardSyntaxSupport</code>通过模板重载了<code>operator+</code>，它要求接收一个重载了<code>operator()</code>的泛型**函数对象(functional object)**类型，据此产生一个<code>TScopeGuard</code>的类型，并将传递进来的函数对象托管，在这个<code>TScopeGuard</code>的对象的析构函数中(destructor)调用了托管的函数对象。</p>
<p>其中隐藏的关键是通过<code>::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()&#123;&#125;</code>得到的<code>TScopeGuard</code>的对象是个**局部对象(automattic storage duration)**，只存在于当前的作用域(Scope)中，在离开当前作用域时会自动销毁(调用析构函数)，离开作用域时局部变量的销毁顺序为按定义的逆序执行。</p>
<blockquote>
<p>[ISO/IEC 14882:2014 § 6.6]On exit from a scope (however accomplished), objects with automatic storage duration (3.7.3) that have been constructed in that scope are destroyed in the reverse order of their construction.</p>
</blockquote>
<h2 id="Spawn特效被遮挡时在摄像机中不显示"><a href="#Spawn特效被遮挡时在摄像机中不显示" class="headerlink" title="Spawn特效被遮挡时在摄像机中不显示"></a>Spawn特效被遮挡时在摄像机中不显示</h2><p>遇到一个问题，当<code>SpawnEmitterAttached</code>一个特效时，如果该特效有被其他东西遮挡(但不是完全遮挡)，在摄像机中会看不到，转到另一面就能看到，这个问题需要检查一下特效的<code>Bounds</code>的大小，应该是Bounds太小了被其他的东西完全挡着了，有时间再来详细分析一下这个问题。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/ue4-spawn-emitter-isnt-visibility-in-camera.webp"></p>
<h2 id="MODULE-NAME-API"><a href="#MODULE-NAME-API" class="headerlink" title="MODULE_NAME_API"></a>MODULE_NAME_API</h2><p>UE中的模块，如果定义的符号允许被外部模块访问，则需要在class前加<code>MODULE_NAME_API</code>，这个宏是什么意思呢？<br>打开<code>Definitions.MODULE_NAME.h</code>这个文件可以知道，<code>MODULE_NAME_API</code>这个宏的定义是<code>DLLEXPORT</code>，看名字就知道是导出符号的，但是针对不同的平台是不一样的，<code>DLLEXPORT</code>和<code>DLLIMPORT</code>的宏是定义在<code>Runtime\Core\Public\$&#123;PLATFROM&#125;\$&#123;PLATFROM&#125;Platfrom.h</code>下的(Android与Linux 的相同)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Android\AndroidPlatform.h</span></span><br><span class="line"><span class="comment">// Runtime\Core\Public\Linux\LinuxPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br></pre></td></tr></table></figure>
<p>MacOS则是一个空的宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Mac\MacPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT</span></span><br></pre></td></tr></table></figure>

<p>Windows的为<code>__declspec</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Windows\WIndowsPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT __declspec(dllimport)</span></span><br></pre></td></tr></table></figure>

<h2 id="模块的宏定义"><a href="#模块的宏定义" class="headerlink" title="模块的宏定义"></a>模块的宏定义</h2><p>UE中模块的宏定义会汇总在这个文件下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\NetExampleDemo\Definitions.MODULE_NAME.h</span><br></pre></td></tr></table></figure>
<p>其中定义了<code>MODULE_NAME_API</code>为<code>DLLEXPORT</code>，导出自己模块内的符号，还有引用的其他模块的<code>MODULE_NAME_API</code>为<code>DLLIMPORT</code>，导入引用模块内的符号，在编译时链接可用，还有一些宏开关。<br>类似于这样：<a href="index/UE4/Macro/Definitions.MODULENAME.h">Definations.WebBrowserEx.h</a></p>
<h2 id="Windows与MacOS双系统时间不一致的解决方案"><a href="#Windows与MacOS双系统时间不一致的解决方案" class="headerlink" title="Windows与MacOS双系统时间不一致的解决方案"></a>Windows与MacOS双系统时间不一致的解决方案</h2><p>因为MacOS读取时间为UTC时间，Windows直接读取BIOS时间为本地时间，所以在双系统时时间上会有8个小时的误差。<br>解决办法为，管理员权限打开CMD，执行下列命令：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reg add HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation /v RealTimeIsUniversal /t REG_DWORD /d <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="Listen-Server模式下的SkipOwner"><a href="#Listen-Server模式下的SkipOwner" class="headerlink" title="Listen Server模式下的SkipOwner"></a>Listen Server模式下的SkipOwner</h2><p>如果在监听服务器(<code>Listen Server</code>)的模式下，作为服务端的玩家设置同步的变量，如果该变量的<code>Replication Conditional</code>为<code>SkipOwner</code>（此时监听服务器为该Actor的Owner），则该监听客户端的<code>Rep_</code>方法也会执行(因为它既是服务器也是客户端)。<br>即如果在使用<code>SkipOwner</code>用来处理类似本地模拟的事件时，<code>LocallyControlled</code>Player触发的事件先看到效果，其他客户端走变量同步触发<code>Rep_</code>的逻辑，但在这种机制下作为监听服务器的处理逻辑会走两遍。</p>
<h2 id="SpawnSoundAtLocation失败的情况"><a href="#SpawnSoundAtLocation失败的情况" class="headerlink" title="SpawnSoundAtLocation失败的情况"></a>SpawnSoundAtLocation失败的情况</h2><p>UE中创建一个声音使用的是<code>UGameplatStatic::SpawnSoundAtLocation</code>，但是在项目中发现有时候它会被创建失败，看了一下代码，发现确实会存在创建失败的情况。<br>其调用栈如下：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/spawn-sound-at-location-call-stack.webp"><br>在<code>FAudioDevice::LocationIsAudible</code>中做了检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAudioDevice::LocationIsAudible</span><span class="params">(<span class="keyword">const</span> FVector&amp; Location, <span class="keyword">const</span> <span class="keyword">float</span> MaxDistance)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (MaxDistance &gt;= WORLD_MAX)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bInAudioThread = <span class="built_in">IsInAudioThread</span>();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bInGameThread = <span class="built_in">IsInGameThread</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(bInAudioThread || bInGameThread);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bInAudioThread)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FListener&amp; Listener : Listeners)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">LocationIsAudible</span>(Location, Listener.Transform, MaxDistance))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="comment">//if (bInGameThread)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FTransform&amp; ListenerTransform : ListenerTransforms)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">LocationIsAudible</span>(Location, ListenerTransform, MaxDistance))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAudioDevice::LocationIsAudible</span><span class="params">(<span class="keyword">const</span> FVector&amp; Location, <span class="keyword">const</span> FTransform&amp; ListenerTransform, <span class="keyword">float</span> MaxDistance)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (MaxDistance &gt;= WORLD_MAX)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">float</span> MaxDistanceSquared = MaxDistance * MaxDistance;</span><br><span class="line">  <span class="keyword">return</span> (ListenerTransform.<span class="built_in">GetTranslation</span>() - Location).<span class="built_in">SizeSquared</span>() &lt; MaxDistanceSquared;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过检测Spawn的位置和声音的距离来判断这个创建的声音能不能被任何Listener听到，如果不能则不会创建。<br><code>Listener</code>在<code>UGameViewportClient::Draw</code>中被设置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update the listener.</span></span><br><span class="line"><span class="keyword">if</span> (AudioDevice != <span class="literal">NULL</span> &amp;&amp; PlayerController != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">bool</span> bUpdateListenerPosition = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the main audio device is used for multiple PIE viewport clients, we only</span></span><br><span class="line">  <span class="comment">// want to update the main audio device listener position if it is in focus</span></span><br><span class="line">  <span class="keyword">if</span> (GEngine)</span><br><span class="line">  &#123;</span><br><span class="line">    FAudioDeviceManager* AudioDeviceManager = GEngine-&gt;<span class="built_in">GetAudioDeviceManager</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is more than one world referencing the main audio device</span></span><br><span class="line">    <span class="keyword">if</span> (AudioDeviceManager-&gt;<span class="built_in">GetNumMainAudioDeviceWorlds</span>() &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      uint32 MainAudioDeviceHandle = GEngine-&gt;<span class="built_in">GetAudioDeviceHandle</span>();</span><br><span class="line">      <span class="keyword">if</span> (AudioDevice-&gt;DeviceHandle == MainAudioDeviceHandle &amp;&amp; !bHasAudioFocus)</span><br><span class="line">      &#123;</span><br><span class="line">        bUpdateListenerPosition = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bUpdateListenerPosition)</span><br><span class="line">  &#123;</span><br><span class="line">    FVector Location;</span><br><span class="line">    FVector ProjFront;</span><br><span class="line">    FVector ProjRight;</span><br><span class="line">    PlayerController-&gt;<span class="built_in">GetAudioListenerPosition</span>(<span class="comment">/*out*/</span> Location, <span class="comment">/*out*/</span> ProjFront, <span class="comment">/*out*/</span> ProjRight);</span><br><span class="line"></span><br><span class="line">    <span class="function">FTransform <span class="title">ListenerTransform</span><span class="params">(FRotationMatrix::MakeFromXY(ProjFront, ProjRight))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow the HMD to adjust based on the head position of the player, as opposed to the view location</span></span><br><span class="line">    <span class="keyword">if</span> (GEngine-&gt;XRSystem.<span class="built_in">IsValid</span>() &amp;&amp; GEngine-&gt;StereoRenderingDevice.<span class="built_in">IsValid</span>() &amp;&amp; GEngine-&gt;StereoRenderingDevice-&gt;<span class="built_in">IsStereoEnabled</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FVector Offset = GEngine-&gt;XRSystem-&gt;<span class="built_in">GetAudioListenerOffset</span>();</span><br><span class="line">      Location += ListenerTransform.<span class="built_in">TransformPositionNoScale</span>(Offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ListenerTransform.<span class="built_in">SetTranslation</span>(Location);</span><br><span class="line">    ListenerTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line"></span><br><span class="line">    uint32 ViewportIndex = PlayerViewMap.<span class="built_in">Num</span>() - <span class="number">1</span>;</span><br><span class="line">    AudioDevice-&gt;<span class="built_in">SetListener</span>(MyWorld, ViewportIndex, ListenerTransform, (View-&gt;bCameraCut ? <span class="number">0.f</span> : MyWorld-&gt;<span class="built_in">GetDeltaSeconds</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Listener的位置是通过<code>PlayerController::GetAudioListenerPosition</code>来获取的，而该函数获取的是<code>AudioListenerComponent</code>的位置和旋转，可以通过<code>PlayerController::SetAudioListenerOverride</code>来设置使用的组件。</p>
<p>PS:只有在当前的<code>AudioDevice</code>为<code>MainAudioDevice</code>并且不在焦点的时候才不会更新Listener的位置。</p>
<p>或许这个限制是由于性能优化的考虑，但是也十分坑爹，因为如果在最开始的时候(组件的BeginPlay)创建一个声音，可能挂载的Actor的位置是在原点的，不在任何Listener的范围内，则就会创建失败。</p>
<h2 id="注意RPC的调用不是严格顺序的"><a href="#注意RPC的调用不是严格顺序的" class="headerlink" title="注意RPC的调用不是严格顺序的"></a>注意RPC的调用不是严格顺序的</h2><p>在UE中如果有两个连续调用的RPC事件A和B，其调用顺序到对端之后也不是完全保证就是一致的。<br>哪怕使用了<code>Reliable</code>来标记，只是标记其一定会到达，如果A先调用，然后调用B，但是A丢失了，重新发送A之后，顺序就是B先到达然后重新发送的A再到达。</p>
<h2 id="项目跨大版本升级"><a href="#项目跨大版本升级" class="headerlink" title="项目跨大版本升级"></a>项目跨大版本升级</h2><p>尽量不要直接跨数个大版本升级项目，可能会存在资源的兼容性问题，最安全的做法是挨个大版本升级。</p>
<h2 id="GC-Config-of-BaseEngine-ini"><a href="#GC-Config-of-BaseEngine-ini" class="headerlink" title="GC Config of BaseEngine.ini"></a>GC Config of BaseEngine.ini</h2><p>可以打开<code>ProjectSettings</code>-<code>Engine</code>-<code>GarbageCollection</code>查看设置:<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/UE4-Engine-Garbage-Collection-GlobalSetting.webp"><br>它们是在配置文件<code>Engine\Config\BaseEngine.ini</code>中的。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Engine\Config\BaseEngine.ini</span></span><br><span class="line"><span class="section">[/Script/Engine.GarbageCollectionSettings]</span></span><br><span class="line"><span class="attr">gc.MaxObjectsNotConsideredByGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.SizeOfPermanentObjectPool</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.FlushStreamingOnGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.NumRetriesBeforeForcingGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.AllowParallelGC</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.TimeBetweenPurgingPendingKillObjects</span>=<span class="number">60</span></span><br><span class="line"><span class="attr">gc.MaxObjectsInEditor</span>=<span class="number">8388607</span></span><br><span class="line"><span class="attr">gc.CreateGCClusters</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.MergeGCClusters</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.ActorClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.BlueprintClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.UseDisregardForGCOnDedicatedServers</span>=<span class="literal">False</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>AllowParallelGC</code>：允许多线程执行GC</p>
</li>
<li><p><code>TimeBetweenPurgingPendingKillObjects</code>：GC的清理周期默认为60s，可以通过调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetWorld</span>()-&gt;<span class="built_in">ForceGarbageCollection</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>来强制GC。但是如果不想然一个UObject被GC回收，可以使用<code>AddToRoot</code>。</p>
</li>
<li><p><code>CreateGCClusters</code>：开启可以防止对很多子物体进行GC遍历。</p>
</li>
</ul>

      </div>
      
      
      
    </div>
    
  <ul class="breadcrumb">
          
            <li><a href="/notes/">NOTES</a></li>
          <li>UE</li>
        
  </ul>

    
    
    


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GIST-NOTES"><span class="nav-number">1.</span> <span class="nav-text">GIST NOTES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook-World%E6%A0%88"><span class="nav-number">2.</span> <span class="nav-text">Cook World栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LongPackageNameToFileName"><span class="nav-number">3.</span> <span class="nav-text">LongPackageNameToFileName</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticMesh%E6%B2%A1%E6%9C%89%E7%A2%B0%E6%92%9E%E5%AF%BC%E8%87%B4%E7%9A%84Cook%E5%A4%B1%E8%B4%A5"><span class="nav-number">4.</span> <span class="nav-text">StaticMesh没有碰撞导致的Cook失败</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%90%AF%E5%8A%A8UE-APP"><span class="nav-number">5.</span> <span class="nav-text">Android命令行启动UE APP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#android%E6%8C%87%E5%AE%9A%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">6.</span> <span class="nav-text">android指定启动参数的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%A4%96%E9%83%A8%E5%8F%AF%E7%94%A8%E7%9A%84%E5%85%A8%E5%B1%80%E7%AC%A6%E5%8F%B7"><span class="nav-number">7.</span> <span class="nav-text">定义外部可用的全局符号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9StaticMesh%E7%9A%84CollisionPreset"><span class="nav-number">8.</span> <span class="nav-text">修改StaticMesh的CollisionPreset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Commandlet%E5%90%AF%E5%8A%A8%E6%97%B6%E4%B8%8D%E7%BC%96%E8%AF%91shader"><span class="nav-number">9.</span> <span class="nav-text">Commandlet启动时不编译shader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BF%AE%E6%94%B9Icon"><span class="nav-number">10.</span> <span class="nav-text">Android运行时修改Icon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-27-Xcode13%E7%BC%96%E8%AF%91%E9%94%99%E8%AF%AF"><span class="nav-number">11.</span> <span class="nav-text">4.27- Xcode13编译错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85Windows%E7%AA%97%E5%8F%A3%E5%8C%96"><span class="nav-number">12.</span> <span class="nav-text">打包Windows窗口化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE-Docker"><span class="nav-number">13.</span> <span class="nav-text">UE-Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Primary-Asset-Types%E6%A0%87%E8%AE%B0%E7%9A%84%E8%B5%84%E4%BA%A7%E6%89%AB%E6%8F%8F"><span class="nav-number">14.</span> <span class="nav-text">Primary Asset Types标记的资产扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rider-%E9%85%8D%E7%BD%AE"><span class="nav-number">15.</span> <span class="nav-text">Rider 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9Rider%E7%9A%84JVM%E9%85%8D%E7%BD%AE"><span class="nav-number">15.1.</span> <span class="nav-text">修改Rider的JVM配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BC%93%E5%AD%98%E8%B7%AF%E5%BE%84"><span class="nav-number">15.2.</span> <span class="nav-text">项目缓存路径</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Editor-Preferences%E9%85%8D%E7%BD%AE"><span class="nav-number">16.</span> <span class="nav-text">Editor Preferences配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E4%B8%8E%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="nav-number">17.</span> <span class="nav-text">UE游戏安全与逆向分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlobalShaderCache-bin"><span class="nav-number">18.</span> <span class="nav-text">GlobalShaderCache*.bin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Primary-Asset-Types-to-Scan"><span class="nav-number">19.</span> <span class="nav-text">Primary Asset Types to Scan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E7%BC%96%E8%AF%91Metal-Shader%E7%9A%84%E6%A0%88"><span class="nav-number">20.</span> <span class="nav-text">Windows编译Metal Shader的栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E6%97%B6%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%80%A7%E8%83%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">21.</span> <span class="nav-text">Cook时进程的性能配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Commandlet%E7%A6%81%E7%94%A8%E6%B8%B2%E6%9F%93%E7%BA%BF%E7%A8%8B"><span class="nav-number">22.</span> <span class="nav-text">Commandlet禁用渲染线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shader%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE"><span class="nav-number">23.</span> <span class="nav-text">Shader编译配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnrealPak%E7%9A%84%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0"><span class="nav-number">24.</span> <span class="nav-text">UnrealPak的加密参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%A7%81%E6%9C%89UObject%E7%B1%BB%E5%B1%9E%E6%80%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">25.</span> <span class="nav-text">获取私有UObject类属性的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%86%85%E7%9A%84%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90"><span class="nav-number">26.</span> <span class="nav-text">引擎内的图片资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%8F%92%E4%BB%B6"><span class="nav-number">27.</span> <span class="nav-text">构建插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%88%B0%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%A0%88"><span class="nav-number">28.</span> <span class="nav-text">加载资源到磁盘文件读取栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%97%ADRider%E6%89%AB%E6%8F%8Fuasset"><span class="nav-number">29.</span> <span class="nav-text">关闭Rider扫描uasset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%89%93%E5%8C%85UI%E7%9B%AE%E5%BD%95"><span class="nav-number">30.</span> <span class="nav-text">默认打包UI目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LongPackageNameToFilename"><span class="nav-number">31.</span> <span class="nav-text">LongPackageNameToFilename</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8BCook"><span class="nav-number">32.</span> <span class="nav-text">多进程Cook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E6%97%B6%E7%9A%84%E8%B5%84%E6%BA%90%E6%94%B6%E9%9B%86"><span class="nav-number">33.</span> <span class="nav-text">Cook时的资源收集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91UBlueprint"><span class="nav-number">34.</span> <span class="nav-text">编译UBlueprint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-Metal-Shader-or-HLSL-Shader"><span class="nav-number">35.</span> <span class="nav-text">IOS Metal Shader or HLSL Shader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-27%E5%AE%98%E6%96%B9%E6%94%AF%E6%8C%81Docker"><span class="nav-number">36.</span> <span class="nav-text">UE4.27官方支持Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NVIDIA%E7%9A%84UE%E4%BB%93%E5%BA%93"><span class="nav-number">37.</span> <span class="nav-text">NVIDIA的UE仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE-Xcode13%E6%94%AF%E6%8C%81"><span class="nav-number">38.</span> <span class="nav-text">UE Xcode13支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E4%B8%8D%E6%94%AF%E6%8C%81ApexDestruction"><span class="nav-number">39.</span> <span class="nav-text">Android不支持ApexDestruction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UDataTable%E9%99%90%E5%AE%9A%E7%BB%93%E6%9E%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">40.</span> <span class="nav-text">UDataTable限定结构类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8EDataTable%E4%B8%AD%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><span class="nav-number">41.</span> <span class="nav-text">从DataTable中加载数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E5%85%B3%E5%8D%A1%E7%9A%84UObject%E8%8E%B7%E5%8F%96AWorldsettings"><span class="nav-number">42.</span> <span class="nav-text">从关卡的UObject获取AWorldsettings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#adb%E6%89%A7%E8%A1%8Cconsole-command"><span class="nav-number">43.</span> <span class="nav-text">adb执行console command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E8%BF%90%E8%A1%8C%E7%9A%84Ini%E5%B9%B3%E5%8F%B0%E5%90%8D"><span class="nav-number">44.</span> <span class="nav-text">获取当前运行的Ini平台名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ImportText"><span class="nav-number">45.</span> <span class="nav-text">ImportText</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E6%88%AA%E5%9B%BEGraph%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">46.</span> <span class="nav-text">UE截图Graph的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SwarmAgent-alway-busy"><span class="nav-number">47.</span> <span class="nav-text">SwarmAgent alway busy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAssetData%E6%95%B0%E6%8D%AE%E9%A2%84%E8%A7%88"><span class="nav-number">48.</span> <span class="nav-text">FAssetData数据预览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90UMG%E7%9A%84Widget-Tree"><span class="nav-number">49.</span> <span class="nav-text">分析UMG的Widget Tree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Share-Shader-library"><span class="nav-number">50.</span> <span class="nav-text">Share Shader library</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LOL-Binaries-Patch"><span class="nav-number">51.</span> <span class="nav-text">LOL Binaries Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Config%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9B%B4%E6%96%B0"><span class="nav-number">52.</span> <span class="nav-text">Config的运行时更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E6%94%AF%E6%8C%81Program"><span class="nav-number">53.</span> <span class="nav-text">插件支持Program</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PackageNativeShaderLibrary"><span class="nav-number">54.</span> <span class="nav-text">PackageNativeShaderLibrary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pak%E7%9A%84%E6%8B%86%E5%88%86%E7%94%9F%E6%88%90%E5%AE%9E%E7%8E%B0"><span class="nav-number">55.</span> <span class="nav-text">Pak的拆分生成实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AllChunksInfo-csv"><span class="nav-number">56.</span> <span class="nav-text">AllChunksInfo.csv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AES%E5%8A%A0%E5%AF%86"><span class="nav-number">57.</span> <span class="nav-text">AES加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PakFileRules%E6%89%93%E5%8C%85%E6%97%B6%E7%9A%84%E6%96%87%E4%BB%B6%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="nav-number">58.</span> <span class="nav-text">PakFileRules打包时的文件过滤规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pak%E7%9A%84%E5%8A%A0%E5%AF%86"><span class="nav-number">59.</span> <span class="nav-text">Pak的加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E7%9A%84%E5%AE%B9%E5%99%A8%E5%8C%96%E6%94%AF%E6%8C%81"><span class="nav-number">60.</span> <span class="nav-text">UE的容器化支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E7%9A%84%E7%BC%96%E8%BE%91%E5%99%A8%E8%AE%BE%E7%BD%AE%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84"><span class="nav-number">61.</span> <span class="nav-text">引擎的编辑器设置存储路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9UDP%E7%9A%84%E9%BB%98%E8%AE%A4%E5%A4%9A%E6%92%AD%E7%AB%AF%E5%8F%A3"><span class="nav-number">62.</span> <span class="nav-text">修改UDP的默认多播端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E9%94%99%E8%AF%AFEnsure-condition-failed-GetSuperClass"><span class="nav-number">63.</span> <span class="nav-text">Cook错误Ensure condition failed: GetSuperClass()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PakCache%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">64.</span> <span class="nav-text">PakCache的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnreakPak%E8%A7%A3%E5%8E%8B%E6%8C%87%E5%AE%9A%E6%96%87%E4%BB%B6"><span class="nav-number">65.</span> <span class="nav-text">UnreakPak解压指定文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2PakFile%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">66.</span> <span class="nav-text">替换PakFile的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8EPak%E5%8A%A0%E8%BD%BDuasset%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">67.</span> <span class="nav-text">从Pak加载uasset的调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HDiff-%E4%BA%8C%E8%BF%9B%E5%88%B6Patch"><span class="nav-number">68.</span> <span class="nav-text">HDiff 二进制Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%99%E8%B5%84%E6%BA%90%E6%B7%BB%E5%8A%A0%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E5%A4%84%E7%90%86%E9%80%89%E9%A1%B9"><span class="nav-number">69.</span> <span class="nav-text">给资源添加右键菜单处理选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PSO-Cache"><span class="nav-number">70.</span> <span class="nav-text">PSO Cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC"><span class="nav-number">71.</span> <span class="nav-text">C++获取引擎版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#diff-uasset"><span class="nav-number">72.</span> <span class="nav-text">diff uasset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E5%9B%BE%E9%9B%86"><span class="nav-number">73.</span> <span class="nav-text">Cook图集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STAT-GROUP"><span class="nav-number">74.</span> <span class="nav-text">STAT GROUP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E6%B8%B2%E6%9F%93Sequence%E5%91%BD%E4%BB%A4"><span class="nav-number">75.</span> <span class="nav-text">离线渲染Sequence命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FDebugText"><span class="nav-number">76.</span> <span class="nav-text">FDebugText</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Game-Map-Map-PersistentLevel-None"><span class="nav-number">77.</span> <span class="nav-text">&#x2F;Game&#x2F;Map.Map:PersistentLevel.None</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%ACActor%E5%88%9B%E5%BB%BA%E4%BA%8B%E4%BB%B6"><span class="nav-number">78.</span> <span class="nav-text">监听Actor创建事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-25%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2bug"><span class="nav-number">79.</span> <span class="nav-text">UE4.25字符转换bug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AFADDRESS-SANITIZER"><span class="nav-number">80.</span> <span class="nav-text">开启ADDRESS SANITIZER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%ACCook%E5%AE%8C%E6%88%90%E4%BA%8B%E4%BB%B6"><span class="nav-number">81.</span> <span class="nav-text">监听Cook完成事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E7%9A%84%E6%9C%80%E5%A4%A7%E5%B0%BA%E5%AF%B8"><span class="nav-number">82.</span> <span class="nav-text">地图的最大尺寸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UProperty%E5%88%B0FProperty%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">83.</span> <span class="nav-text">UProperty到FProperty的优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETarget%E8%8E%B7%E5%8F%96%E7%BC%96%E8%AF%91%E5%99%A8%E7%89%88%E6%9C%AC"><span class="nav-number">84.</span> <span class="nav-text">从Target获取编译器版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Insight-Profile-Tag-in-UnLua"><span class="nav-number">85.</span> <span class="nav-text">Insight Profile Tag in UnLua</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Insight-Profiler-Tag"><span class="nav-number">86.</span> <span class="nav-text">Insight Profiler Tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Localization-Error"><span class="nav-number">87.</span> <span class="nav-text">Localization Error</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-IPA-0xE8008029-Error"><span class="nav-number">88.</span> <span class="nav-text">Install IPA 0xE8008029 Error</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BC%95%E7%94%A8%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="nav-number">89.</span> <span class="nav-text">获取引用的对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AutomationTool-Project"><span class="nav-number">90.</span> <span class="nav-text">AutomationTool Project</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPL%E4%BF%AE%E6%94%B9gradle-properties"><span class="nav-number">91.</span> <span class="nav-text">UPL修改gradle.properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Timer%E7%9A%84%E5%9B%9E%E8%B0%83%E4%B8%AD%E4%B8%8D%E8%83%BD%E6%9E%90%E6%9E%84handle"><span class="nav-number">92.</span> <span class="nav-text">Timer的回调中不能析构handle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E6%A3%80%E6%B5%8B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">93.</span> <span class="nav-text">C#检测命令行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IniPlatformName"><span class="nav-number">94.</span> <span class="nav-text">IniPlatformName</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E5%86%85%E5%AD%98%E9%98%88%E5%80%BC"><span class="nav-number">95.</span> <span class="nav-text">IOS内存阈值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ensure"><span class="nav-number">96.</span> <span class="nav-text">ensure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%A1%E5%9E%92%E4%B9%8B%E5%A4%9C%E4%B8%BA%E5%A4%9A%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%86%85%E5%AE%B9%E4%BC%98%E5%8C%96"><span class="nav-number">97.</span> <span class="nav-text">堡垒之夜为多平台的内容优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6"><span class="nav-number">98.</span> <span class="nav-text">自动化测试框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E3%80%8A%E5%A0%A1%E5%9E%92%E4%B9%8B%E5%A4%9C%E3%80%8B%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%BC%80%E5%8F%91%E8%BF%AD%E4%BB%A3%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB"><span class="nav-number">99.</span> <span class="nav-text">《堡垒之夜》跨平台开发迭代经验分享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cooker%E4%BC%98%E5%8C%96"><span class="nav-number">99.1.</span> <span class="nav-text">Cooker优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-Profile"><span class="nav-number">99.2.</span> <span class="nav-text">Device Profile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E8%BF%AD%E4%BB%A3"><span class="nav-number">99.3.</span> <span class="nav-text">在线迭代</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RootComponent%E8%AD%A6%E5%91%8A"><span class="nav-number">100.</span> <span class="nav-text">RootComponent警告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConfigLayer"><span class="nav-number">101.</span> <span class="nav-text">ConfigLayer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac%E7%94%9F%E6%88%90%E7%9A%84xocde%E5%B7%A5%E7%A8%8B"><span class="nav-number">102.</span> <span class="nav-text">Mac生成的xocde工程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Insight%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3"><span class="nav-number">103.</span> <span class="nav-text">Unreal Insight默认端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Navmesh-bounds-are-too-large"><span class="nav-number">104.</span> <span class="nav-text">Navmesh bounds are too large</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%AF%86PakIndex%E9%80%A0%E6%88%90%E7%9A%84%E6%97%A0%E6%B3%95%E6%8C%82%E8%BD%BDshaderbytecode"><span class="nav-number">105.</span> <span class="nav-text">加密PakIndex造成的无法挂载shaderbytecode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%BB%99Enum%E6%B7%BB%E5%8A%A0%E5%80%BC"><span class="nav-number">106.</span> <span class="nav-text">运行时给Enum添加值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%8D%E5%8E%86Enum%E7%9A%84%E6%89%80%E6%9C%89%E5%80%BC"><span class="nav-number">107.</span> <span class="nav-text">遍历Enum的所有值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IoStore%E7%9A%84%E7%94%9F%E6%88%90%E5%88%86%E6%9E%90"><span class="nav-number">108.</span> <span class="nav-text">IoStore的生成分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-25-2-Mac%E6%89%93%E5%8C%85%E7%9A%84metal-ar%E9%94%99%E8%AF%AF"><span class="nav-number">109.</span> <span class="nav-text">4.25.2- Mac打包的metal-ar错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%97%ADUnityBuild"><span class="nav-number">110.</span> <span class="nav-text">关闭UnityBuild</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TextureStreaming"><span class="nav-number">111.</span> <span class="nav-text">TextureStreaming</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PackagePath%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E7%A3%81%E7%9B%98%E8%B7%AF%E5%BE%84"><span class="nav-number">112.</span> <span class="nav-text">PackagePath获取资源磁盘路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%97%ADPCH"><span class="nav-number">113.</span> <span class="nav-text">关闭PCH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E7%89%88%E4%B8%8E%E5%AE%89%E8%A3%85%E7%89%88IOS%E6%95%B0%E6%8D%AE%E8%B7%AF%E5%BE%84%E5%B7%AE%E5%BC%82"><span class="nav-number">114.</span> <span class="nav-text">源码版与安装版IOS数据路径差异</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Viveport%E9%80%89%E4%B8%ADActor%E6%8C%89F%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">115.</span> <span class="nav-text">Viveport选中Actor按F调用函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Searchable-Names"><span class="nav-number">116.</span> <span class="nav-text">Searchable Names</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%8C%85%E8%BF%87%E6%BB%A4config%E4%B8%AD%E7%9A%84ini%E6%96%87%E4%BB%B6"><span class="nav-number">117.</span> <span class="nav-text">基础包过滤config中的ini文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#t-MaxFPS%E5%90%AF%E5%8A%A8%E6%97%B6%E6%97%A0%E6%95%88"><span class="nav-number">118.</span> <span class="nav-text">t.MaxFPS启动时无效</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E6%89%A7%E8%A1%8Cpy%E7%9A%84Commandlet"><span class="nav-number">119.</span> <span class="nav-text">UE执行py的Commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEConsoleVariables%E5%80%BC%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">120.</span> <span class="nav-text">设置ConsoleVariables值的几种方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#debug-shader-compile"><span class="nav-number">121.</span> <span class="nav-text">debug shader compile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E5%B9%B3%E5%8F%B0%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9%E6%A0%BC%E5%BC%8F"><span class="nav-number">122.</span> <span class="nav-text">移动平台纹理压缩格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E6%89%93%E5%8C%85%E7%9A%84log-level"><span class="nav-number">123.</span> <span class="nav-text">控制打包的log level</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9PCH-Buffer-size"><span class="nav-number">124.</span> <span class="nav-text">修改PCH Buffer size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PSO-Caching%E9%85%8D%E7%BD%AE"><span class="nav-number">125.</span> <span class="nav-text">PSO Caching配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MacSDK%E4%B8%8B%E8%BD%BD"><span class="nav-number">126.</span> <span class="nav-text">MacSDK下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%85%E7%90%86Mac-DDC"><span class="nav-number">127.</span> <span class="nav-text">清理Mac DDC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%B9%B3%E5%8F%B0%E4%BD%BF%E7%94%A8%E7%9A%84RHI"><span class="nav-number">128.</span> <span class="nav-text">修改平台使用的RHI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9DDC%E7%9A%84%E8%B7%AF%E5%BE%84"><span class="nav-number">129.</span> <span class="nav-text">修改DDC的路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#App%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="nav-number">130.</span> <span class="nav-text">App版本号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IOS"><span class="nav-number">130.1.</span> <span class="nav-text">IOS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android"><span class="nav-number">130.2.</span> <span class="nav-text">Android</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Standalone%E6%A8%A1%E5%BC%8F%E7%9A%84ES3%E9%A2%84%E8%A7%88"><span class="nav-number">131.</span> <span class="nav-text">Standalone模式的ES3预览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%BC%95%E6%93%8E%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%E5%8F%82%E6%95%B0"><span class="nav-number">132.</span> <span class="nav-text">修改引擎的编译器参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8B%AC%E7%AB%8B%E5%8D%8A%E9%80%8F%E6%98%8E"><span class="nav-number">133.</span> <span class="nav-text">独立半透明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Slate%E5%9B%BE%E7%89%87"><span class="nav-number">134.</span> <span class="nav-text">Slate图片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E8%AE%BE%E7%BD%AE%E4%B8%AD%E7%9A%84%E9%80%89%E9%A1%B9"><span class="nav-number">135.</span> <span class="nav-text">创建项目设置中的选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPL%E8%AF%BB%E5%8F%96ini"><span class="nav-number">136.</span> <span class="nav-text">UPL读取ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">137.</span> <span class="nav-text">访问系统环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Xcode-stdc-%E9%94%99%E8%AF%AF"><span class="nav-number">138.</span> <span class="nav-text">Xcode stdc++错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%AF%E5%B1%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">139.</span> <span class="nav-text">息屏控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Android-1"><span class="nav-number">139.1.</span> <span class="nav-text">Android</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IOS-1"><span class="nav-number">139.2.</span> <span class="nav-text">IOS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Swarm"><span class="nav-number">140.</span> <span class="nav-text">Unreal Swarm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AsyncTask"><span class="nav-number">141.</span> <span class="nav-text">AsyncTask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MSVC%E7%9A%84%E8%AD%A6%E5%91%8A-%E9%94%99%E8%AF%AF%E7%BC%96%E5%8F%B7"><span class="nav-number">142.</span> <span class="nav-text">MSVC的警告&#x2F;错误编号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MSVC%E6%88%90%E5%91%98%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F%E4%B8%8D%E4%B8%80%E8%87%B4%E8%AD%A6%E5%91%8A"><span class="nav-number">143.</span> <span class="nav-text">MSVC成员初始化顺序不一致警告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%89%E7%85%A7%E5%90%8D%E5%AD%97%E8%A7%84%E5%88%99%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">144.</span> <span class="nav-text">按照名字规则加载模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%9A%E8%AE%BE%E5%A4%87%E5%88%86%E7%BA%A7"><span class="nav-number">145.</span> <span class="nav-text">性能优化：设备分级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">146.</span> <span class="nav-text">打印调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-Metal-Shader-Compiler-for-IOS"><span class="nav-number">147.</span> <span class="nav-text">Windows Metal Shader Compiler for IOS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loaded-a-text-shader-will-be-slower-to-load"><span class="nav-number">148.</span> <span class="nav-text">Loaded a text shader (will be slower to load)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rust-in-unreal"><span class="nav-number">149.</span> <span class="nav-text">rust in unreal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uhtmanifest"><span class="nav-number">150.</span> <span class="nav-text">uhtmanifest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%87%E5%8A%A8%E5%8F%8D%E9%A6%88"><span class="nav-number">151.</span> <span class="nav-text">震动反馈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Incredibuild%E5%AF%B9FASTBuild%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">152.</span> <span class="nav-text">Incredibuild对FASTBuild的影响</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E9%93%BE"><span class="nav-number">153.</span> <span class="nav-text">交叉编译工具链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E7%AD%BE%E5%90%8D%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="nav-number">154.</span> <span class="nav-text">IOS签名错误排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#No-certificate-for-team-xxxx-matching"><span class="nav-number">154.1.</span> <span class="nav-text">No certificate for team xxxx matching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#errSecInternalComponent%E9%94%99%E8%AF%AF"><span class="nav-number">154.2.</span> <span class="nav-text">errSecInternalComponent错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Invalid-trust-settings"><span class="nav-number">154.3.</span> <span class="nav-text">Invalid trust settings.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-MobileProvision%E8%B7%AF%E5%BE%84"><span class="nav-number">155.</span> <span class="nav-text">IOS MobileProvision路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%8E%89PRAGMA-ENABLE-OPTIMIZATION%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BC%96%E8%AF%91%E9%94%99%E8%AF%AF"><span class="nav-number">156.</span> <span class="nav-text">漏掉PRAGMA_ENABLE_OPTIMIZATION导致的编译错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86"><span class="nav-number">157.</span> <span class="nav-text">读取文件的一部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PakBlackList"><span class="nav-number">158.</span> <span class="nav-text">PakBlackList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-BuildSettings-BuildSettings"><span class="nav-number">159.</span> <span class="nav-text">[&#x2F;Script&#x2F;BuildSettings.BuildSettings]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Insights%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">160.</span> <span class="nav-text">Unreal Insights的初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPackage-Save"><span class="nav-number">161.</span> <span class="nav-text">UPackage::Save</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E5%86%85%E7%BD%AE%E7%9A%84Release-Patch"><span class="nav-number">162.</span> <span class="nav-text">UE内置的Release Patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEConsoleVariable%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">163.</span> <span class="nav-text">配置ConsoleVariable默认值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPROPERTY%E7%9A%84ConsoleVariable"><span class="nav-number">164.</span> <span class="nav-text">UPROPERTY的ConsoleVariable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91%E6%97%B6%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="nav-number">165.</span> <span class="nav-text">代码编译时执行脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CopyDirectory"><span class="nav-number">166.</span> <span class="nav-text">CopyDirectory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="nav-number">167.</span> <span class="nav-text">UE4快捷键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-h%E9%80%A0%E6%88%90%E7%9A%84%E5%90%8D%E5%AD%97%E5%86%B2%E7%AA%81"><span class="nav-number">168.</span> <span class="nav-text">Windows.h造成的名字冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Redirects"><span class="nav-number">169.</span> <span class="nav-text">Core Redirects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6Shader%E7%9A%84%E7%BC%96%E8%AF%91"><span class="nav-number">170.</span> <span class="nav-text">打包时Shader的编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDC%E5%85%B1%E4%BA%AB"><span class="nav-number">171.</span> <span class="nav-text">DDC共享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target%E6%96%87%E4%BB%B6"><span class="nav-number">172.</span> <span class="nav-text">.target文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-Crash%E5%88%86%E6%9E%90%E6%96%87%E6%A1%A3"><span class="nav-number">173.</span> <span class="nav-text">IOS Crash分析文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%90%E8%B4%A8Sampler%E8%B6%85%E9%99%90%E5%88%B6Crash"><span class="nav-number">174.</span> <span class="nav-text">材质Sampler超限制Crash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DoesPackageExists%E5%88%86%E6%9E%90"><span class="nav-number">175.</span> <span class="nav-text">DoesPackageExists分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LoadObject%E5%8A%A0%E8%BD%BD%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E6%A0%88"><span class="nav-number">176.</span> <span class="nav-text">LoadObject加载磁盘文件栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebuild-metadata"><span class="nav-number">177.</span> <span class="nav-text">rebuild metadata</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPA%E5%8C%85%E6%9C%80%E5%A4%A7%E4%B8%BA4GB"><span class="nav-number">178.</span> <span class="nav-text">IPA包最大为4GB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96Editor%E7%9A%84Crash%E4%B8%8A%E6%8A%A5"><span class="nav-number">179.</span> <span class="nav-text">自动化Editor的Crash上报</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E5%88%9B%E5%BB%BA"><span class="nav-number">180.</span> <span class="nav-text">监听资源创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-lighting-from-commandlet"><span class="nav-number">181.</span> <span class="nav-text">Build lighting from commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AutomationTool%E7%9A%84ErrorCode"><span class="nav-number">182.</span> <span class="nav-text">AutomationTool的ErrorCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8AssetRegistry%E6%A3%80%E6%B5%8B%E8%B5%84%E6%BA%90%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">183.</span> <span class="nav-text">使用AssetRegistry检测资源是否存在</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%89%93%E5%8C%85%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">184.</span> <span class="nav-text">分析打包的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E4%B8%ADES3-1%E7%9A%8475%E6%A0%B9%E9%AA%A8%E9%AA%BC%E9%99%90%E5%88%B6"><span class="nav-number">185.</span> <span class="nav-text">UE4中ES3.1的75根骨骼限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#upluginmanifest"><span class="nav-number">186.</span> <span class="nav-text">upluginmanifest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%9D%9EContent%E8%B7%AF%E5%BE%84%E7%9A%84Non-Asset%E7%9B%AE%E5%BD%95%E5%88%B0%E5%9F%BA%E7%A1%80%E5%8C%85"><span class="nav-number">187.</span> <span class="nav-text">添加非Content路径的Non-Asset目录到基础包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FDataTime-UtcNow"><span class="nav-number">188.</span> <span class="nav-text">FDataTime::UtcNow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uexp%E5%92%8Cubulk%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">189.</span> <span class="nav-text">uexp和ubulk的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4"><span class="nav-number">190.</span> <span class="nav-text">资源调试命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E5%9F%BA%E7%A1%80%E5%8C%85%E6%8B%86%E5%88%86"><span class="nav-number">191.</span> <span class="nav-text">IOS基础包拆分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%9F%BA%E7%A1%80%E5%8C%85%E6%8B%86%E5%88%86"><span class="nav-number">192.</span> <span class="nav-text">Android基础包拆分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG-OnTouchStarted%E4%B8%8D%E8%A7%A6%E5%8F%91"><span class="nav-number">193.</span> <span class="nav-text">UMG OnTouchStarted不触发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E6%93%8D%E4%BD%9C%E4%BA%8B%E4%BB%B6"><span class="nav-number">194.</span> <span class="nav-text">监听资源操作事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-not-found-uproject"><span class="nav-number">195.</span> <span class="nav-text">Android not found uproject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E5%8F%96chunk%E7%9A%84paklist%E6%96%87%E4%BB%B6"><span class="nav-number">196.</span> <span class="nav-text">提取chunk的paklist文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8D%E8%83%BD%E8%B6%85%E8%BF%872G"><span class="nav-number">197.</span> <span class="nav-text">IOS远程构建最大文件不能超过2G</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DS%E4%BA%A7%E7%94%9Fcorefile"><span class="nav-number">198.</span> <span class="nav-text">DS产生corefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9ASkeletalMesh%E7%9A%84LOD%E7%BA%A7%E5%88%AB"><span class="nav-number">199.</span> <span class="nav-text">指定SkeletalMesh的LOD级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HotPatcher%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BC%E5%87%BARelease%E8%84%9A%E6%9C%AC"><span class="nav-number">200.</span> <span class="nav-text">HotPatcher的自动化导出Release脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Texture%E7%9A%84%E5%8E%8B%E7%BC%A9"><span class="nav-number">201.</span> <span class="nav-text">Texture的压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#listtextures"><span class="nav-number">202.</span> <span class="nav-text">listtextures</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Insights%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90Android"><span class="nav-number">203.</span> <span class="nav-text">Unreal Insights实时分析Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SessionFrontEnd%E5%AE%9E%E6%97%B6Profile-Android"><span class="nav-number">204.</span> <span class="nav-text">SessionFrontEnd实时Profile Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%9A%84%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">205.</span> <span class="nav-text">C++中获取引擎的版本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%88%E7%9A%84%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%8C%BA%E5%88%AB"><span class="nav-number">206.</span> <span class="nav-text">判断对象是否有效的方式与区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M1-Mac%E7%9A%84UE4-26%E5%85%BC%E5%AE%B9%E6%80%A7%E6%8A%A5%E5%91%8A"><span class="nav-number">207.</span> <span class="nav-text">M1 Mac的UE4.26兼容性报告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG-CanvasPanel%E5%90%88%E6%89%B9"><span class="nav-number">208.</span> <span class="nav-text">UMG CanvasPanel合批</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E5%9B%BE%E8%8A%82%E7%82%B9%E5%8F%B3%E4%B8%8A%E8%A7%92%E6%A0%87%E8%AF%86%E7%9A%84%E5%90%AB%E4%B9%89"><span class="nav-number">209.</span> <span class="nav-text">蓝图节点右上角标识的含义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OptimizeCode%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-number">210.</span> <span class="nav-text">OptimizeCode代码优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASTC-Compression-Quality-By-Size"><span class="nav-number">211.</span> <span class="nav-text">ASTC Compression Quality By Size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E4%BF%AE%E6%94%B9%E8%AF%AD%E8%A8%80%E7%9A%84%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8"><span class="nav-number">212.</span> <span class="nav-text">引擎修改语言的配置存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E8%B5%8B%E5%80%BC%E7%BB%99FString"><span class="nav-number">213.</span> <span class="nav-text">中文赋值给FString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E7%9B%B8%E5%AF%B9%E5%88%B0%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E8%BD%AC%E6%8D%A2"><span class="nav-number">214.</span> <span class="nav-text">IOS相对到绝对路径转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E8%BD%AC%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="nav-number">215.</span> <span class="nav-text">Android相对路径转绝对路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8UClass"><span class="nav-number">216.</span> <span class="nav-text">强引用UClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="nav-number">217.</span> <span class="nav-text">UE4编译代码的真正命令参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#build-cs%E6%B7%BB%E5%8A%A0%E5%AE%8F%E5%AE%9A%E4%B9%89%E7%9A%84%E5%80%BC"><span class="nav-number">218.</span> <span class="nav-text">build.cs添加宏定义的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="nav-number">219.</span> <span class="nav-text">编译引擎的命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8%E6%A3%80%E6%B5%8BActor%E7%A7%BB%E5%8A%A8"><span class="nav-number">220.</span> <span class="nav-text">编辑器检测Actor移动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor-Tick-in-Editor"><span class="nav-number">221.</span> <span class="nav-text">Actor Tick in Editor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-ERROR-Missing-object-file"><span class="nav-number">222.</span> <span class="nav-text">UE4 ERROR: Missing object file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%9A%94String%E4%B8%BA%E6%95%B0%E7%BB%84"><span class="nav-number">223.</span> <span class="nav-text">分隔String为数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-25%E4%B8%ADShaderPatch%E9%97%AE%E9%A2%98"><span class="nav-number">224.</span> <span class="nav-text">UE4.25中ShaderPatch问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Win%E5%92%8CMac%E5%87%BAIOS%E5%8C%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">225.</span> <span class="nav-text">Win和Mac出IOS包的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E6%96%B0%E5%9C%B0%E5%9B%BE%E7%9A%84Package%E9%97%AE%E9%A2%98"><span class="nav-number">226.</span> <span class="nav-text">UE4新地图的Package问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%8A%A0%E8%BD%BDBP%E7%9A%84Enum"><span class="nav-number">227.</span> <span class="nav-text">C++加载BP的Enum</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DS%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="nav-number">228.</span> <span class="nav-text">DS设置超时时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDC%E7%9A%84%E8%B5%84%E6%96%99"><span class="nav-number">229.</span> <span class="nav-text">DDC的资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E8%BF%87%E9%95%BF%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E5%A4%B1%E8%B4%A5"><span class="nav-number">230.</span> <span class="nav-text">路径过长导致远程构建失败</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-Point%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">231.</span> <span class="nav-text">Mount Point的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E7%9A%84Splash%E8%BF%87%E7%A8%8B"><span class="nav-number">232.</span> <span class="nav-text">引擎的Splash过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-25-1%E7%9A%84Assembly%E8%B7%AF%E5%BE%84%E9%94%99%E8%AF%AF"><span class="nav-number">233.</span> <span class="nav-text">UE4.25.1的Assembly路径错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8Level%E9%80%89%E6%8B%A9Actor"><span class="nav-number">234.</span> <span class="nav-text">跨Level选择Actor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">235.</span> <span class="nav-text">添加外部库的注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Outer"><span class="nav-number">236.</span> <span class="nav-text">Outer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96ContentBrowser%E4%B8%AD%E9%80%89%E6%8B%A9%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">237.</span> <span class="nav-text">获取ContentBrowser中选择的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%AA%E9%95%BF%E6%97%A0%E6%B3%95%E9%80%82%E5%BA%94%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95"><span class="nav-number">238.</span> <span class="nav-text">命令行太长无法适应调试记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E6%8C%89%E9%92%AE"><span class="nav-number">239.</span> <span class="nav-text">添加资源右键菜单按钮</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles%E6%8C%87%E5%AE%9AVS%E7%89%88%E6%9C%AC"><span class="nav-number">240.</span> <span class="nav-text">GenerateProjectFiles指定VS版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module%E7%9A%84WhitelistPlatforms"><span class="nav-number">241.</span> <span class="nav-text">Module的WhitelistPlatforms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDetailCustomization"><span class="nav-number">242.</span> <span class="nav-text">IDetailCustomization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E5%8F%96PakList%E6%96%87%E4%BB%B6"><span class="nav-number">243.</span> <span class="nav-text">提取PakList文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9ADetailsView%E7%9A%84%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96%E4%BA%8B%E4%BB%B6"><span class="nav-number">244.</span> <span class="nav-text">绑定DetailsView的属性变化事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E6%8C%87%E5%AE%9APak%E5%8A%A0%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">245.</span> <span class="nav-text">从指定Pak加载文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WITH-EDITOR%E5%8C%85%E8%A3%B9%E5%8F%8D%E5%B0%84%E5%B1%9E%E6%80%A7%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">246.</span> <span class="nav-text">WITH_EDITOR包裹反射属性的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E8%B5%84%E6%BA%90"><span class="nav-number">247.</span> <span class="nav-text">Cook资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compile%E5%AF%B9Instanced%E7%9A%84%E6%9B%BF%E6%8D%A2%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">248.</span> <span class="nav-text">Compile对Instanced的替换调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B5%84%E6%BA%90%E7%82%B9%E5%87%BBCompile%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">249.</span> <span class="nav-text">对资源点击Compile的调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG%E7%9A%84%E5%AD%90%E6%8E%A7%E4%BB%B6%E5%BC%95%E7%94%A8%E7%83%AD%E6%9B%B4%E9%97%AE%E9%A2%98"><span class="nav-number">250.</span> <span class="nav-text">UMG的子控件引用热更问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%8E%AF%E5%BD%A2%E5%BC%95%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E5%AE%8F%E6%9C%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF"><span class="nav-number">251.</span> <span class="nav-text">注意环形引用导致的宏未定义错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%ACSlate%E7%9A%84%E8%BE%93%E5%85%A5%E4%BA%8B%E4%BB%B6"><span class="nav-number">252.</span> <span class="nav-text">监听Slate的输入事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9LaunchScreen%E8%A7%86%E9%A2%91%E6%AF%94%E4%BE%8B"><span class="nav-number">253.</span> <span class="nav-text">修改LaunchScreen视频比例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rider%E4%BC%A0%E9%80%92%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">254.</span> <span class="nav-text">Rider传递命令行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BC%E5%85%A5Certificate%E5%92%8CProvision"><span class="nav-number">255.</span> <span class="nav-text">IOS自动化导入Certificate和Provision</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac%E6%89%93%E5%8C%85iOS%E7%9A%84codesign%E9%94%99%E8%AF%AF"><span class="nav-number">256.</span> <span class="nav-text">Mac打包iOS的codesign错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VirtualCamera"><span class="nav-number">257.</span> <span class="nav-text">VirtualCamera</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E5%9C%A84-26%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">258.</span> <span class="nav-text">远程构建在4.26的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Log"><span class="nav-number">259.</span> <span class="nav-text">Log</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-EXTERN"><span class="nav-number">259.1.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_EXTERN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-CLASS"><span class="nav-number">259.2.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_CLASS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-EXTERN-HELPER"><span class="nav-number">259.3.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_EXTERN_HELPER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">259.4.</span> <span class="nav-text">后记</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3Target"><span class="nav-number">260.</span> <span class="nav-text">平台相关Target</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TargetRule%E8%8E%B7%E5%8F%96%E9%A1%B9%E7%9B%AE%E8%B7%AF%E5%BE%84"><span class="nav-number">261.</span> <span class="nav-text">TargetRule获取项目路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84"><span class="nav-number">262.</span> <span class="nav-text">UObject获取资源路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85iOS%E5%AF%BC%E5%87%BAdSYM"><span class="nav-number">263.</span> <span class="nav-text">打包iOS导出dSYM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91%E7%82%B9"><span class="nav-number">263.1.</span> <span class="nav-text">坑点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E6%94%AF%E6%8C%81Android%E5%92%8CiOS"><span class="nav-number">264.</span> <span class="nav-text">编译引擎支持Android和iOS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPARAM"><span class="nav-number">265.</span> <span class="nav-text">UPARAM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A0%E8%BE%B9%E6%A1%86%E6%A8%A1%E5%BC%8F"><span class="nav-number">266.</span> <span class="nav-text">无边框模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AF%BC%E5%85%A5iOS%E8%AF%81%E4%B9%A6%E5%92%8CProvision"><span class="nav-number">267.</span> <span class="nav-text">命令行导入iOS证书和Provision</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Certificate"><span class="nav-number">267.1.</span> <span class="nav-text">Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provision"><span class="nav-number">267.2.</span> <span class="nav-text">Provision</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">268.</span> <span class="nav-text">C#获取命令行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6%E7%BB%99%E4%B8%8D%E5%90%8C%E7%9A%84%E5%B9%B3%E5%8F%B0%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90"><span class="nav-number">269.</span> <span class="nav-text">打包时给不同的平台添加资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E4%BF%9D%E5%AD%98%E7%9A%84%E4%BA%8B%E4%BB%B6"><span class="nav-number">270.</span> <span class="nav-text">监听资源保存的事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UStruct%E7%9A%84json%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">271.</span> <span class="nav-text">UStruct的json序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redirector"><span class="nav-number">272.</span> <span class="nav-text">Redirector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E5%BC%95%E6%93%8E%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E5%9C%A8Commandlet"><span class="nav-number">273.</span> <span class="nav-text">检查引擎是否运行在Commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FSoftObjectPath%E9%99%90%E5%AE%9A%E7%B1%BB%E5%9E%8B"><span class="nav-number">274.</span> <span class="nav-text">FSoftObjectPath限定类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8viewport%E6%98%BE%E7%A4%BA%E6%96%87%E5%AD%97"><span class="nav-number">275.</span> <span class="nav-text">编辑器viewport显示文字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E5%A4%9A%E6%A0%B8%E5%BF%83%E7%BC%96%E8%AF%91"><span class="nav-number">276.</span> <span class="nav-text">开启多核心编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URL-Encode-Decode"><span class="nav-number">277.</span> <span class="nav-text">URL Encode&#x2F;Decode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BAPK%E7%9A%84%E7%AD%BE%E5%90%8D%E4%BF%A1%E6%81%AF"><span class="nav-number">278.</span> <span class="nav-text">查看APK的签名信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASTC%E8%AE%BE%E7%BD%AE%E5%8E%8B%E7%BC%A9%E7%8E%87"><span class="nav-number">279.</span> <span class="nav-text">ASTC设置压缩率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85Windows%E4%BB%A5%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">280.</span> <span class="nav-text">打包Windows以窗口模式启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9B%BECook%E5%8F%8A%E6%89%93%E5%8C%85"><span class="nav-number">281.</span> <span class="nav-text">指定地图Cook及打包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%AE%BF%E9%97%AECollision-Chanel"><span class="nav-number">282.</span> <span class="nav-text">C++访问Collision Chanel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor%E7%9A%84%E5%BB%B6%E8%BF%9FSpawn"><span class="nav-number">283.</span> <span class="nav-text">Actor的延迟Spawn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E7%9A%84WindowsDebugTools%E9%94%99%E8%AF%AF"><span class="nav-number">284.</span> <span class="nav-text">编译引擎的WindowsDebugTools错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BuildGraph%E6%9E%84%E5%BB%BA%E5%BC%95%E6%93%8E"><span class="nav-number">285.</span> <span class="nav-text">BuildGraph构建引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Game-module-could-not-be-loaded"><span class="nav-number">286.</span> <span class="nav-text">Game module could not be loaded</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E8%8A%82%E7%82%B9%E5%B1%9E%E6%80%A7%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">287.</span> <span class="nav-text">蓝图编辑器中节点属性的修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UMG%E8%B5%84%E6%96%99%E6%96%87%E6%A1%A3"><span class="nav-number">287.1.</span> <span class="nav-text">UMG资料文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Enum%E5%8F%8D%E5%B0%84"><span class="nav-number">288.</span> <span class="nav-text">Enum反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E4%B8%BAEnum%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="nav-number">288.1.</span> <span class="nav-text">UHT为Enum生成的代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AE%BF%E9%97%AEUEnum"><span class="nav-number">288.2.</span> <span class="nav-text">运行时访问UEnum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%9E%9A%E4%B8%BE%E5%90%8D%E5%AD%97%E8%8E%B7%E5%8F%96%E6%9E%9A%E4%B8%BE%E5%80%BC"><span class="nav-number">288.3.</span> <span class="nav-text">根据枚举名字获取枚举值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E5%80%BC%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2"><span class="nav-number">288.4.</span> <span class="nav-text">枚举值与字符串的互相转换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Struct%E5%8F%8D%E5%B0%84"><span class="nav-number">289.</span> <span class="nav-text">Struct反射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%8F%8D%E5%B0%84"><span class="nav-number">290.</span> <span class="nav-text">类反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E4%B8%BA%E7%B1%BB%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">290.1.</span> <span class="nav-text">UHT为类产生的反射信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9EUCLASS%E7%9A%84%E5%8F%8D%E5%B0%84"><span class="nav-number">290.2.</span> <span class="nav-text">非UCLASS的反射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UClass%E7%9A%84%E6%9E%84%E9%80%A0%E6%80%9D%E8%B7%AF"><span class="nav-number">290.3.</span> <span class="nav-text">UClass的构造思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%94%9F%E6%88%90%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">290.3.1.</span> <span class="nav-text">引擎如何使用生成的反射信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%8F%8D%E5%B0%84"><span class="nav-number">291.</span> <span class="nav-text">函数反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E7%94%9F%E6%88%90%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">291.1.</span> <span class="nav-text">UHT生成的反射信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thunk%E5%87%BD%E6%95%B0"><span class="nav-number">291.2.</span> <span class="nav-text">Thunk函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Thunk"><span class="nav-number">291.3.</span> <span class="nav-text">Custom Thunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AE%BF%E9%97%AE%E5%8F%8D%E5%B0%84%E5%87%BD%E6%95%B0"><span class="nav-number">291.4.</span> <span class="nav-text">运行时访问反射函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91%E7%82%B9-1"><span class="nav-number">291.5.</span> <span class="nav-text">坑点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%8F%8D%E5%B0%84"><span class="nav-number">292.</span> <span class="nav-text">属性反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#F-PropertyParams"><span class="nav-number">292.1.</span> <span class="nav-text">F*PropertyParams</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NameUTF8"><span class="nav-number">292.1.1.</span> <span class="nav-text">NameUTF8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RepNotifyFuncUTF8"><span class="nav-number">292.1.2.</span> <span class="nav-text">RepNotifyFuncUTF8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PropertyFlags"><span class="nav-number">292.1.3.</span> <span class="nav-text">PropertyFlags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flags"><span class="nav-number">292.1.4.</span> <span class="nav-text">Flags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObjectFlags"><span class="nav-number">292.1.5.</span> <span class="nav-text">ObjectFlags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ArrayDim"><span class="nav-number">292.1.6.</span> <span class="nav-text">ArrayDim</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Offset"><span class="nav-number">292.1.7.</span> <span class="nav-text">Offset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Z-Construct-UClass-%E5%92%8CNumMetaData"><span class="nav-number">292.1.8.</span> <span class="nav-text">Z_Construct_UClass_和NumMetaData</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84Property"><span class="nav-number">292.2.</span> <span class="nav-text">运行时的Property</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FBoolPropertyParams%E7%89%B9%E4%BE%8B"><span class="nav-number">292.3.</span> <span class="nav-text">FBoolPropertyParams特例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87UProperty%E8%8E%B7%E5%8F%96%E5%80%BC"><span class="nav-number">292.4.</span> <span class="nav-text">通过UProperty获取值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Property%E7%9A%84Flag"><span class="nav-number">292.5.</span> <span class="nav-text">Property的Flag</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticClass%E5%92%8CGetClass%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">293.</span> <span class="nav-text">StaticClass和GetClass的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject%E7%9A%84FObjectInitializer%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8"><span class="nav-number">294.</span> <span class="nav-text">UObject的FObjectInitializer构造函数的调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticClass%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84"><span class="nav-number">295.</span> <span class="nav-text">StaticClass是如何定义的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UClass%E4%B8%AD%E7%9A%84%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="nav-number">295.1.</span> <span class="nav-text">UClass中的函数指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetPrivateStaticClassBody"><span class="nav-number">295.2.</span> <span class="nav-text">GetPrivateStaticClassBody</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96UObject%E7%9A%84%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84"><span class="nav-number">296.</span> <span class="nav-text">获取UObject的资源路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BP-to-CPP"><span class="nav-number">297.</span> <span class="nav-text">BP to CPP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E7%AA%97%E5%8F%A3%E5%85%B3%E9%97%AD"><span class="nav-number">298.</span> <span class="nav-text">监听窗口关闭</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnLua%E7%9A%84EXPORT-PRIMITIVE-TYPE"><span class="nav-number">299.</span> <span class="nav-text">UnLua的EXPORT_PRIMITIVE_TYPE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-25-MountPak%E6%B2%A1%E6%9C%89%E6%9D%90%E8%B4%A8"><span class="nav-number">300.</span> <span class="nav-text">4.25 MountPak没有材质</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E4%B8%8AArrow%E7%BB%84%E4%BB%B6%E7%9A%84crash"><span class="nav-number">301.</span> <span class="nav-text">Android上Arrow组件的crash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target-build-cs%E8%BE%93%E5%87%BALog"><span class="nav-number">302.</span> <span class="nav-text">target&#x2F;build.cs输出Log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TargetRules%E7%9A%84BuildSettingsVersion"><span class="nav-number">303.</span> <span class="nav-text">TargetRules的BuildSettingsVersion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC"><span class="nav-number">304.</span> <span class="nav-text">从TargetRules获取引擎版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96Configuration"><span class="nav-number">305.</span> <span class="nav-text">从TargetRules获取Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-CrashLog%E5%88%86%E6%9E%90"><span class="nav-number">306.</span> <span class="nav-text">IOS CrashLog分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC"><span class="nav-number">307.</span> <span class="nav-text">GC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SDetailsView%E7%9B%91%E5%90%AC%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96"><span class="nav-number">308.</span> <span class="nav-text">SDetailsView监听属性变化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject-serializer%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">309.</span> <span class="nav-text">UObject serializer的调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FName-FString-FText%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">310.</span> <span class="nav-text">FName&#x2F;FString&#x2F;FText的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FName"><span class="nav-number">310.1.</span> <span class="nav-text">FName</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FString"><span class="nav-number">310.2.</span> <span class="nav-text">FString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FText"><span class="nav-number">310.3.</span> <span class="nav-text">FText</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-number">310.4.</span> <span class="nav-text">文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96Plugin%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="nav-number">311.</span> <span class="nav-text">Plugin添加其他Plugin的模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-Configurations"><span class="nav-number">312.</span> <span class="nav-text">Build Configurations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlobalShaderCache%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">313.</span> <span class="nav-text">GlobalShaderCache的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ushaderbytecode%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">314.</span> <span class="nav-text">ushaderbytecode的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%89%93%E5%8C%85%E5%88%B0pak%E9%87%8C%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">315.</span> <span class="nav-text">默认打包到pak里的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACommandlet"><span class="nav-number">316.</span> <span class="nav-text">创建Commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnLua%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E8%A6%86%E5%86%99"><span class="nav-number">317.</span> <span class="nav-text">UnLua如何实现函数覆写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2Thunk%E5%87%BD%E6%95%B0"><span class="nav-number">317.1.</span> <span class="nav-text">替换Thunk函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FLuaContext-TryBindUnlua"><span class="nav-number">317.2.</span> <span class="nav-text">FLuaContext::TryBindUnlua</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-Bind"><span class="nav-number">317.3.</span> <span class="nav-text">UUnLuaManager::Bind</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BindInternal"><span class="nav-number">317.4.</span> <span class="nav-text">BindInternal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-OverrideFunctions"><span class="nav-number">317.5.</span> <span class="nav-text">UUnLuaManager::OverrideFunctions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-OverrideFunction"><span class="nav-number">317.6.</span> <span class="nav-text">UUnLuaManager::OverrideFunction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-AddFunction"><span class="nav-number">317.7.</span> <span class="nav-text">UUnLuaManager::AddFunction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Call-lua"><span class="nav-number">317.8.</span> <span class="nav-text">Call lua</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC-1"><span class="nav-number">318.</span> <span class="nav-text">从TargetRules获取引擎版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FPaths%E4%B8%ADDir%E5%87%BD%E6%95%B0%E7%9A%84%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84"><span class="nav-number">319.</span> <span class="nav-text">FPaths中Dir函数的对应路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87Commandline%E6%9B%BF%E6%8D%A2%E5%8A%A0%E8%BD%BD%E7%9A%84ini"><span class="nav-number">320.</span> <span class="nav-text">通过Commandline替换加载的ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%B9%B3%E5%8F%B0%E4%BF%A1%E6%81%AF"><span class="nav-number">321.</span> <span class="nav-text">获取当前平台信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COMPILED-PLATFORM-HEADER"><span class="nav-number">322.</span> <span class="nav-text">COMPILED_PLATFORM_HEADER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%8D%E5%8E%86UCLASS%E6%88%96USTRUCT%E7%9A%84%E5%8F%8D%E5%B0%84%E6%88%90%E5%91%98"><span class="nav-number">323.</span> <span class="nav-text">遍历UCLASS或USTRUCT的反射成员</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua-Metatable"><span class="nav-number">324.</span> <span class="nav-text">Lua:Metatable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E6%89%93%E5%8C%85%E6%97%B6ini%E7%9A%84%E6%8B%B7%E8%B4%9D"><span class="nav-number">325.</span> <span class="nav-text">控制打包时ini的拷贝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CharCast%E7%9A%84%E5%9D%91"><span class="nav-number">326.</span> <span class="nav-text">CharCast的坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bUsesSlate"><span class="nav-number">327.</span> <span class="nav-text">bUsesSlate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Plugin-Language"><span class="nav-number">328.</span> <span class="nav-text">Unreal Plugin Language</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6Paklist%E6%96%87%E4%BB%B6%E7%9A%84%E7%94%9F%E6%88%90"><span class="nav-number">329.</span> <span class="nav-text">打包时Paklist文件的生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShaderStableInfo-scl-csv"><span class="nav-number">330.</span> <span class="nav-text">ShaderStableInfo*.scl.csv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PE%E7%9A%84DLL%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AF%BC%E5%85%A5%E5%BA%93%EF%BC%9F"><span class="nav-number">331.</span> <span class="nav-text">PE的DLL为什么需要导入库？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UCLASS%E7%9A%84config"><span class="nav-number">332.</span> <span class="nav-text">UCLASS的config</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E5%89%AA%E8%B4%B4%E6%9D%BFClipboard"><span class="nav-number">333.</span> <span class="nav-text">操作剪贴板Clipboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%9C%BA%E6%99%AF%E4%B8%ADCopy-Paste%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">334.</span> <span class="nav-text">在场景中Copy&#x2F;Paste的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Copy"><span class="nav-number">334.1.</span> <span class="nav-text">Copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Paste"><span class="nav-number">334.2.</span> <span class="nav-text">Paste</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E6%98%AFUTF8%E8%BF%98%E6%98%AFGBK%E7%BC%96%E7%A0%81"><span class="nav-number">335.</span> <span class="nav-text">检测字符数组是UTF8还是GBK编码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GBK"><span class="nav-number">335.1.</span> <span class="nav-text">GBK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UTF8"><span class="nav-number">335.2.</span> <span class="nav-text">UTF8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">335.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UTF8%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E8%BD%ACFString"><span class="nav-number">336.</span> <span class="nav-text">UTF8编码的字符数组转FString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8SpawnActor"><span class="nav-number">337.</span> <span class="nav-text">编辑器SpawnActor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EditCondition%E6%94%AF%E6%8C%81%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">338.</span> <span class="nav-text">EditCondition支持表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-number">339.</span> <span class="nav-text">获取资源依赖关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E5%8A%A0%E8%BD%BD"><span class="nav-number">340.</span> <span class="nav-text">地图的存储和加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DataTable"><span class="nav-number">341.</span> <span class="nav-text">DataTable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FCommandLine%E8%BF%87%E6%BB%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">342.</span> <span class="nav-text">FCommandLine过滤模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OVERRIDE-COMMANDLINE-WHITELIST"><span class="nav-number">342.1.</span> <span class="nav-text">OVERRIDE_COMMANDLINE_WHITELIST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FILTER-COMMANDLINE-LOGGING"><span class="nav-number">342.2.</span> <span class="nav-text">FILTER_COMMANDLINE_LOGGING</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PIE%E7%9A%84%E5%9D%91"><span class="nav-number">343.</span> <span class="nav-text">PIE的坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPARAM-ref"><span class="nav-number">344.</span> <span class="nav-text">UPARAM(ref)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-file-couldn%E2%80%99t-be-loaded-by-the-OS"><span class="nav-number">345.</span> <span class="nav-text">the file couldn’t be loaded by the OS.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PURE-VIRTUAL-macro"><span class="nav-number">346.</span> <span class="nav-text">PURE_VIRTUAL macro</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E5%91%98%E6%A8%A1%E6%9D%BF%E5%87%BD%E6%95%B0%E7%89%B9%E5%8C%96%E4%B8%8D%E8%A6%81%E6%94%BE%E5%9C%A8class-scope"><span class="nav-number">347.</span> <span class="nav-text">成员模板函数特化不要放在class scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Runtime%E6%A8%A1%E5%9D%97%E5%8C%85%E5%90%ABEditor%E6%A8%A1%E5%9D%97%E7%9A%84%E9%94%99%E8%AF%AF"><span class="nav-number">348.</span> <span class="nav-text">Runtime模块包含Editor模块的错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%93%9D%E5%9B%BE%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3"><span class="nav-number">349.</span> <span class="nav-text">获取蓝图添加的所有接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnrealFrontEnd-DeviceLog"><span class="nav-number">350.</span> <span class="nav-text">UnrealFrontEnd DeviceLog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E7%B1%BB%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%90%E7%B1%BB"><span class="nav-number">351.</span> <span class="nav-text">获取某个类的所有子类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-22-3%E6%89%93%E5%8C%85IOS-Crash%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">352.</span> <span class="nav-text">4.22.3打包IOS Crash的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%B4%B4%E5%9B%BE%E9%9D%9E2%E6%AC%A1%E5%B9%82%E7%9A%84%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98"><span class="nav-number">353.</span> <span class="nav-text">IOS贴图非2次幂的显示问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES2-0%E6%9C%80%E5%A4%9A75%E6%A0%B9%E9%AA%A8%E9%AA%BC%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">354.</span> <span class="nav-text">ES2.0最多75根骨骼的限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8HTTP%E8%AF%B7%E6%B1%82%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E7%9A%84%E5%9D%91%E5%92%8C%E6%8A%80%E5%B7%A7"><span class="nav-number">355.</span> <span class="nav-text">使用HTTP请求下载文件的坑和技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5%E7%9A%84%E5%88%86%E7%89%87%E6%A0%A1%E9%AA%8C"><span class="nav-number">356.</span> <span class="nav-text">MD5的分片校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PlatformMisc%E7%9A%84%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="nav-number">357.</span> <span class="nav-text">PlatformMisc的跨平台实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua-%E4%BB%8E%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BDmodule"><span class="nav-number">358.</span> <span class="nav-text">Lua:从内存加载module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gituhb%E5%BF%AB%E6%8D%B7%E4%BB%A3%E7%A0%81%E6%90%9C%E7%B4%A2"><span class="nav-number">359.</span> <span class="nav-text">gituhb快捷代码搜索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6FLAG"><span class="nav-number">360.</span> <span class="nav-text">控制写入文件FLAG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Assertion-failed-Class-gt-Children-0"><span class="nav-number">361.</span> <span class="nav-text">Assertion failed: Class-&gt;Children &#x3D;&#x3D; 0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E6%96%87%E4%BB%B6"><span class="nav-number">362.</span> <span class="nav-text">打包时添加外部文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%85%B3%E9%94%AE%E5%AD%97%E7%BB%9D%E5%AF%B9%E4%B8%8D%E8%A6%81%E4%BD%9C%E4%B8%BA%E5%8F%98%E9%87%8F%E5%90%8D"><span class="nav-number">363.</span> <span class="nav-text">C++关键字绝对不要作为变量名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86BindAction%E6%9A%B4%E9%9C%B2%E7%BB%99%E8%93%9D%E5%9B%BE"><span class="nav-number">364.</span> <span class="nav-text">将BindAction暴露给蓝图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APK%E5%8C%85%E4%B8%ADOBB%E6%96%87%E4%BB%B6"><span class="nav-number">365.</span> <span class="nav-text">APK包中OBB文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%9A%84%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">366.</span> <span class="nav-text">移动端的启动参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">366.1.</span> <span class="nav-text">Android启动参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IOS%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">366.2.</span> <span class="nav-text">IOS启动参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E7%9A%84VS%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-number">367.</span> <span class="nav-text">UE编译环境的VS安装配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E8%B5%84%E6%BA%90%E5%BC%95%E7%94%A8%E6%97%B6%E9%9C%80%E6%B3%A8%E6%84%8FRedirector"><span class="nav-number">368.</span> <span class="nav-text">扫描资源引用时需注意Redirector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="nav-number">369.</span> <span class="nav-text">Cook执行代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#No-world-was-found-for-object"><span class="nav-number">370.</span> <span class="nav-text">No world was found for object</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E8%AE%BE%E5%A4%87%E7%9A%84%E6%B8%B2%E6%9F%93%E9%A2%84%E8%A7%88"><span class="nav-number">371.</span> <span class="nav-text">移动设备的渲染预览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E9%A1%B9%E7%9B%AE%E8%AE%BE%E7%BD%AE"><span class="nav-number">372.</span> <span class="nav-text">Android项目设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E7%94%A8SetupAttachmen%E6%9B%BF%E4%BB%A3AttachToComponent"><span class="nav-number">373.</span> <span class="nav-text">在构造函数中用SetupAttachmen替代AttachToComponent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%85%B6%E4%BB%96%E7%9A%84%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%B9%B6%E8%8E%B7%E5%8F%96%E7%A8%8B%E5%BA%8F%E8%BE%93%E5%87%BA"><span class="nav-number">374.</span> <span class="nav-text">在其他的线程运行程序并获取程序输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9AFTicker"><span class="nav-number">375.</span> <span class="nav-text">绑定FTicker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E5%8A%A0%E8%BD%BD%E7%9A%84Delegate"><span class="nav-number">376.</span> <span class="nav-text">地图加载的Delegate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticLoadClass"><span class="nav-number">377.</span> <span class="nav-text">StaticLoadClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConstructorHelpers-FClassFinder"><span class="nav-number">378.</span> <span class="nav-text">ConstructorHelpers::FClassFinder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMD%E7%9A%84sudo"><span class="nav-number">379.</span> <span class="nav-text">CMD的sudo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%B8%B8%E6%88%8F%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%BC%96%E8%BE%91%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">380.</span> <span class="nav-text">在游戏项目中添加编辑器模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#does-not-match-the-necessary-signature"><span class="nav-number">381.</span> <span class="nav-text">does not match the necessary signature</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%88%90%E5%91%98%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F%E5%BF%85%E9%A1%BB%E8%A6%81%E4%B8%8E%E5%A3%B0%E6%98%8E%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4"><span class="nav-number">382.</span> <span class="nav-text">数据成员初始化顺序必须要与声明顺序一致</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delegate"><span class="nav-number">383.</span> <span class="nav-text">Delegate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Delegate-1"><span class="nav-number">383.1.</span> <span class="nav-text">Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Delegate"><span class="nav-number">383.2.</span> <span class="nav-text">Dynamic Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multicast-Delegate"><span class="nav-number">383.3.</span> <span class="nav-text">Multicast Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Multicast-Delegate"><span class="nav-number">383.4.</span> <span class="nav-text">Dynamic Multicast Delegate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pak%E6%89%80%E5%8C%85%E5%90%AB%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">384.</span> <span class="nav-text">Pak所包含的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-Pak%E6%97%B6%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-number">385.</span> <span class="nav-text">Mount Pak时的一个问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FScopeSlowTask"><span class="nav-number">386.</span> <span class="nav-text">FScopeSlowTask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5Hash"><span class="nav-number">387.</span> <span class="nav-text">MD5Hash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%9C%A8Pak%E4%B8%AD%E8%AE%BF%E9%97%AE%E9%9D%9E%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">388.</span> <span class="nav-text">运行时在Pak中访问非资源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">389.</span> <span class="nav-text">枚举的反射信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E7%9A%84%E6%8F%90%E7%A4%BA"><span class="nav-number">390.</span> <span class="nav-text">创建存储文件的提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%B7%A5%E7%A8%8B%E6%89%80%E6%9C%89%E7%9A%84Map"><span class="nav-number">391.</span> <span class="nav-text">获取工程所有的Map</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AssetRegistry%E7%9A%84Asset%E6%A6%82%E5%BF%B5"><span class="nav-number">392.</span> <span class="nav-text">AssetRegistry的Asset概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%94%AF%E6%8C%81%E7%9A%84%E5%B9%B3%E5%8F%B0"><span class="nav-number">393.</span> <span class="nav-text">获取所有支持的平台</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%92%E5%BD%92%E6%89%AB%E6%8F%8F%E7%9B%AE%E5%BD%95"><span class="nav-number">394.</span> <span class="nav-text">递归扫描目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">395.</span> <span class="nav-text">获取系统环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%8E%B7%E5%8F%96git-diff%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">396.</span> <span class="nav-text">运行时获取git diff的内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Asset%E7%9A%84%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-number">397.</span> <span class="nav-text">获取Asset的依赖关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%B1%8F%E5%B9%95%E6%96%B9%E5%90%91"><span class="nav-number">398.</span> <span class="nav-text">Android屏幕方向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SoftClassReference"><span class="nav-number">399.</span> <span class="nav-text">SoftClassReference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">400.</span> <span class="nav-text">Http下载文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-pak-in-Runtime"><span class="nav-number">401.</span> <span class="nav-text">Mount pak in Runtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Patch%E7%9A%84%E6%8C%82%E8%BD%BD%E5%92%8C%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD"><span class="nav-number">402.</span> <span class="nav-text">Patch的挂载和资源加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%97%B6Pak%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">403.</span> <span class="nav-text">引擎启动时Pak的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%93%9D%E5%9B%BE%E8%8A%82%E7%82%B9"><span class="nav-number">404.</span> <span class="nav-text">自定义蓝图节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E5%8A%A0%E8%BD%BD%E6%97%B6%E6%9C%BA%E5%A4%AA%E6%99%9A%E5%9C%A8%E8%93%9D%E5%9B%BE%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF"><span class="nav-number">405.</span> <span class="nav-text">Plugin加载时机太晚在蓝图中的错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NavigationSystem%E8%8E%B7%E5%8F%96NavData"><span class="nav-number">406.</span> <span class="nav-text">NavigationSystem获取NavData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91RecastNavigation"><span class="nav-number">407.</span> <span class="nav-text">编译RecastNavigation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-Plugin-ExportNav"><span class="nav-number">408.</span> <span class="nav-text">UE4 Plugin:ExportNav</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-this"><span class="nav-number">408.1.</span> <span class="nav-text">What is this?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-do-use"><span class="nav-number">408.2.</span> <span class="nav-text">How do use?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%A8%A1%E5%9D%97%E9%97%B4%E7%9A%84%E5%90%8D%E5%AD%97%E5%86%B2%E7%AA%81"><span class="nav-number">409.</span> <span class="nav-text">解决模块间的名字冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CreateProc%E9%98%BB%E5%A1%9E%E6%89%A7%E8%A1%8C"><span class="nav-number">410.</span> <span class="nav-text">CreateProc阻塞执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%B4%A8%E9%87%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">411.</span> <span class="nav-text">网络质量测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E9%9B%86%E6%88%90Protobuf"><span class="nav-number">412.</span> <span class="nav-text">UE4集成Protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-this-1"><span class="nav-number">412.1.</span> <span class="nav-text">What is this?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-do-use-1"><span class="nav-number">412.2.</span> <span class="nav-text">How do use?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protobuf-Version"><span class="nav-number">412.3.</span> <span class="nav-text">Protobuf Version</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protoc%E5%A4%84%E7%90%86%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84-proto%E6%96%87%E4%BB%B6"><span class="nav-number">413.</span> <span class="nav-text">protoc处理目录中的.proto文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Was-only-expecting-C-files-to-have-CachedCPPEnvironments"><span class="nav-number">414.</span> <span class="nav-text">Was only expecting C++ files to have CachedCPPEnvironments!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E8%93%9D%E5%9B%BE%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0%E7%A1%AE%E5%AE%9A%E8%BF%94%E5%9B%9E%E7%B1%BB%E5%9E%8B"><span class="nav-number">415.</span> <span class="nav-text">在蓝图中使用参数确定返回类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetMasterPoseComponent"><span class="nav-number">416.</span> <span class="nav-text">SetMasterPoseComponent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%EF%BC%9A%E5%8F%98%E9%87%8F%E5%B7%B2%E8%A2%AB%E4%BC%98%E5%8C%96%EF%BC%8C%E5%9B%A0%E8%80%8C%E4%B8%8D%E5%8F%AF%E7%94%A8"><span class="nav-number">417.</span> <span class="nav-text">UE4：变量已被优化，因而不可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%85%83%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84AddPin"><span class="nav-number">418.</span> <span class="nav-text">二元操作符的AddPin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E5%83%8F%E8%B4%A8%E9%87%8F%E7%BA%A7%E5%88%AB"><span class="nav-number">419.</span> <span class="nav-text">图像质量级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%89%A9%E7%90%86%E8%B5%84%E4%BA%A7%E4%BC%98%E5%8C%96%E5%8A%A8%E6%80%81%E9%98%B4%E5%BD%B1%E6%B6%88%E8%80%97"><span class="nav-number">420.</span> <span class="nav-text">使用物理资产优化动态阴影消耗</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GameUserSettings"><span class="nav-number">421.</span> <span class="nav-text">GameUserSettings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TAutoConsoleVariable"><span class="nav-number">422.</span> <span class="nav-text">TAutoConsoleVariable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cmake-could-not-find-any-instance-of-Visual-Studio"><span class="nav-number">423.</span> <span class="nav-text">cmake:could not find any instance of Visual Studio.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%9B%AE%E6%A0%87%E7%9A%84RuntimeLibrary%E7%B1%BB%E5%9E%8B"><span class="nav-number">424.</span> <span class="nav-text">编译目标的RuntimeLibrary类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%80"><span class="nav-number">424.1.</span> <span class="nav-text">情况一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%BA%8C"><span class="nav-number">424.2.</span> <span class="nav-text">情况二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%89"><span class="nav-number">424.3.</span> <span class="nav-text">情况三</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Cook"><span class="nav-number">425.</span> <span class="nav-text">What is Cook?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">426.</span> <span class="nav-text">添加宏定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91DLL%E6%97%B6%E6%8A%A5%E9%94%99LNK1561-entry-point-must-be-defined"><span class="nav-number">427.</span> <span class="nav-text">编译DLL时报错LNK1561: entry point must be defined</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cpp%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-h%E5%BF%85%E9%A1%BB%E6%98%AF%E8%87%AA%E8%BA%AB%E7%B1%BB%E7%9A%84"><span class="nav-number">428.</span> <span class="nav-text">cpp中包含的第一个.h必须是自身类的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%B8%B8%E6%88%8F%E6%89%93%E5%8C%85%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%90%8D%E5%92%8CIcon"><span class="nav-number">429.</span> <span class="nav-text">修改游戏打包的进程名和Icon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetActorHiddenInGame%E4%B8%8ESetVisibility%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="nav-number">430.</span> <span class="nav-text">SetActorHiddenInGame与SetVisibility的同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AActor-SetActorHiddenInGame"><span class="nav-number">430.1.</span> <span class="nav-text">AActor::SetActorHiddenInGame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USceneComponent-SetVisibility"><span class="nav-number">430.2.</span> <span class="nav-text">USceneComponent::SetVisibility</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USceneComponent-SetHiddenInGame"><span class="nav-number">430.3.</span> <span class="nav-text">USceneComponent::SetHiddenInGame</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91Task%E7%9A%84ReceiveTickAI%E4%B8%8EReceiveTick%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">431.</span> <span class="nav-text">行为树Task的ReceiveTickAI与ReceiveTick的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor%E7%9A%84Connection"><span class="nav-number">432.</span> <span class="nav-text">Actor的Connection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uasset-format"><span class="nav-number">433.</span> <span class="nav-text">uasset format</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FPackageFileSummary"><span class="nav-number">433.1.</span> <span class="nav-text">FPackageFileSummary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DECLARE-CLASS%E4%B8%8ESuper"><span class="nav-number">434.</span> <span class="nav-text">DECLARE_CLASS与Super</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles-bat%E8%BF%90%E8%A1%8C%E9%94%99%E8%AF%AF2"><span class="nav-number">435.</span> <span class="nav-text">GenerateProjectFiles.bat运行错误2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles-bat%E8%BF%90%E8%A1%8C%E9%94%99%E8%AF%AF1"><span class="nav-number">436.</span> <span class="nav-text">GenerateProjectFiles.bat运行错误1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E6%B7%BB%E5%8A%A0Profiling%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%EF%BC%9A%E4%BB%A3%E7%A0%81%E5%9D%97%E7%9A%84CPU%E8%AE%A1%E6%95%B0%E5%91%A8%E6%9C%9F"><span class="nav-number">437.</span> <span class="nav-text">UE添加Profiling统计信息：代码块的CPU计数周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ON-SCOPE-EXIT"><span class="nav-number">438.</span> <span class="nav-text">ON_SCOPE_EXIT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spawn%E7%89%B9%E6%95%88%E8%A2%AB%E9%81%AE%E6%8C%A1%E6%97%B6%E5%9C%A8%E6%91%84%E5%83%8F%E6%9C%BA%E4%B8%AD%E4%B8%8D%E6%98%BE%E7%A4%BA"><span class="nav-number">439.</span> <span class="nav-text">Spawn特效被遮挡时在摄像机中不显示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODULE-NAME-API"><span class="nav-number">440.</span> <span class="nav-text">MODULE_NAME_API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">441.</span> <span class="nav-text">模块的宏定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E4%B8%8EMacOS%E5%8F%8C%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">442.</span> <span class="nav-text">Windows与MacOS双系统时间不一致的解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Listen-Server%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84SkipOwner"><span class="nav-number">443.</span> <span class="nav-text">Listen Server模式下的SkipOwner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpawnSoundAtLocation%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">444.</span> <span class="nav-text">SpawnSoundAtLocation失败的情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8FRPC%E7%9A%84%E8%B0%83%E7%94%A8%E4%B8%8D%E6%98%AF%E4%B8%A5%E6%A0%BC%E9%A1%BA%E5%BA%8F%E7%9A%84"><span class="nav-number">445.</span> <span class="nav-text">注意RPC的调用不是严格顺序的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%B7%A8%E5%A4%A7%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7"><span class="nav-number">446.</span> <span class="nav-text">项目跨大版本升级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-Config-of-BaseEngine-ini"><span class="nav-number">447.</span> <span class="nav-text">GC Config of BaseEngine.ini</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="查利鹏"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">查利鹏</p>
  <div class="site-description" itemprop="description">每一篇文章都是一个成长的过程。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">161</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://docs.imzlp.com/" title="https:&#x2F;&#x2F;docs.imzlp.com&#x2F;" rel="noopener" target="_blank">TechDocuments</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE4 Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue4wiki.imzlp.com/" title="https:&#x2F;&#x2F;ue4wiki.imzlp.com&#x2F;" rel="noopener" target="_blank">UE4 Wiki</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5lab.com/" title="https:&#x2F;&#x2F;ue5lab.com&#x2F;" rel="noopener" target="_blank">UE5 Lab</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/21696/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;21696&#x2F;">Open Source Tookits</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;">UE4 Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021027036号 </a>
      <img src="/images/beian_logo.webp" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030502007298" rel="noopener" target="_blank">粤公网安备44030502007298号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">查利鹏</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">634k</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://imzlp.com/notes/ue/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "留下点什么吧~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

<!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?hxhb";
            var git_color =['#e2e5e5', '#ccffda', '#98ffaf', '#bef5cb', '#85e89d', '#34d058', '#28a745', '#22863a', '#176f2c', '#165c26', '#144620'];
            var git_user ="hxhb";
            var parent_div_git = document.getElementsByClassName('post-block')[0];
            var git_div_html = '<div class="post-block animated fadeIn" style="width:auto;height:auto;background:0;padding-top:0px;padding-bottom:10px;"><div id="github_loading" style="height:100%;display: flex;align-items: center;justify-content: center;"><svg style="height:50px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div><footer class="post-footer"><div class="post-eof"></div></footer>';
            if(parent_div_git && location.pathname =='/opensource/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementsByClassName('post-block')[0]){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body>
</html>
